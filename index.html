<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT & WHT & PAYE (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary, .wht-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(720px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    pre.small { font-size:0.85rem; white-space:pre-wrap; }
    .nowrap { white-space:nowrap; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT, WHT, PAYE & PIT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>
        <button class="small" id="btnAddAccountInline">+ Account</button>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="whtInlineLabel" style="display:none;">
          <input type="checkbox" id="txnWhtEnabled" /> Withhold WHT
        </label>
        <label id="whtRateInlineLabel" style="display:none;">
          WHT rate (%): <input type="number" id="txnWhtRate" min="0" step="0.01" value="5" style="width:70px;" />
        </label>

        <label>Contact:
          <select id="txnContact"></select>
        </label>
        <button class="small" id="btnAddContactInline">+ Contact</button>

        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved at the business level. WHT (Withholding Tax) is applicable for Expense transactions. Default WHT rate is 5% per transaction. PAYE is calculated monthly for Employee contacts using business PIT rules.</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/description/amount/author/contact/account" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable" aria-live="polite">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Account</th>
            <th>Amount (₦)</th>
            <th>WHT (₦)</th>
            <th>Contact</th>
            <th>Author</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="wht-summary" id="whtSummary"></div>
      <div class="paye-summary totals" id="payeSummary" style="margin-top:10px;"></div>
      <div class="pit-summary totals" id="pitSummary" style="margin-top:10px;"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section" id="contactsAccountsPanel" style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:280px;">
        <h3>Contacts</h3>
        <div class="form-inline" style="margin-bottom:8px;">
          <button class="small" id="btnOpenContacts">Manage Contacts</button>
          <button class="small" id="btnExportContacts">Export Contacts</button>
        </div>
        <div id="contactsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
      </div>
      <div style="flex:1;min-width:280px;">
        <h3>Chart of Accounts</h3>
        <div class="form-inline" style="margin-bottom:8px;">
          <button class="small" id="btnOpenAccounts">Manage Accounts</button>
          <button class="small" id="btnExportAccounts">Export Accounts</button>
        </div>
        <div id="accountsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="userNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
    </div>
    <div class="row">
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Members: <select id="bizMembers" multiple size="5" style="min-width:180px"></select></label>
      <small class="note">Hold Ctrl/Cmd to select multiple members. Owner will be included automatically on save.</small>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (tax)</label>
      <label><input type="checkbox" id="bizVatInclusive" /> VAT amounts are inclusive</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizWhtEnabled" /> Auto-create WHT Payable account</label>
      <label>WHT account code: <input type="text" id="bizWhtCode" value="2300" style="width:90px" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
    <small class="note">VAT & PIT toggles control whether VAT and personal income tax are computed for this business. WHT Payable account will be created if enabled and not present.</small>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>

    <label>Account:
      <select id="editTxnAccount"></select>
    </label><br/>

    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>

    <label id="editWhtLabel" style="display:none;">
      <input type="checkbox" id="editTxnWhtEnabled" /> Withhold WHT
    </label><br/>
    <label id="editWhtRateLabel" style="display:none;">
      WHT rate (%): <input type="number" id="editTxnWhtRate" min="0" step="0.01" value="5" style="width:70px;" />
    </label><br/>

    <label>Contact:
      <select id="editTxnContact"></select>
    </label><br/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="editCancel">Cancel</button>
      <button class="primary" id="editSave">Save</button>
    </div>
  </div>

  <div id="contactModal" class="modal" aria-hidden="true">
    <h3 id="contactModalTitle">Add Contact</h3>
    <div class="row">
      <label>Name: <input type="text" id="contactName" /></label>
      <label>Type:
        <select id="contactType">
          <option value="Customer">Customer</option>
          <option value="Vendor">Vendor</option>
          <option value="Employee">Employee</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Phone/Email: <input type="text" id="contactInfo" placeholder="Phone or email" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="contactNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="contactCancel">Cancel</button>
      <button class="primary" id="contactSave">Save</button>
    </div>
  </div>

  <div id="accountModal" class="modal" aria-hidden="true">
    <h3 id="accountModalTitle">Add Account</h3>
    <div class="row">
      <label>Code: <input type="text" id="accountCode" placeholder="e.g. 4000" /></label>
      <label>Name: <input type="text" id="accountName" placeholder="Account name" /></label>
    </div>
    <div class="row">
      <label>Type:
        <select id="accountType">
          <option>Asset</option>
          <option>Liability</option>
          <option>Equity</option>
          <option>Revenue</option>
          <option>Expense</option>
        </select>
      </label>
      <label>Notes: <input type="text" id="accountNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="accountCancel">Cancel</button>
      <button class="primary" id="accountSave">Save</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant — complete index.html script with monthly PAYE & PIT
    const STORAGE_KEY = 'ntc_data_v2';
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    // state
    let data = { users: [], businesses: [], transactions: {} };
    let selectedUserId = null;
    let selectedBusinessId = null;
    let editTxnId = null;

    // pagination
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';

    function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function formatMoney(v){
      const n = Number(v) || 0;
      return n.toLocaleString('en-NG', {maximumFractionDigits:2, minimumFractionDigits:0});
    }
    function escapeHtml(s){
      if (s === undefined || s === null) return '';
      return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function saveData(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) { console.error('Save failed', e); alert('Saving failed: ' + (e && e.message)); } }

    function ensureBizWhtAccount(b){
      if (!b) return;
      if (!Array.isArray(b.accounts)) b.accounts = [];
      if (!b.whtAccountId && !!b.whtAutoCreate) {
        const exists = b.accounts.find(a => (a.code && String(a.code) === String(b.whtCode || '2300')) && a.name === 'WHT Payable');
        if (exists) b.whtAccountId = exists.id;
        else {
          const acc = { id: uid('a'), code: (b.whtCode || '2300'), name: 'WHT Payable', type: 'Liability', notes: 'Auto-created for withheld tax' };
          b.accounts.push(acc);
          b.whtAccountId = acc.id;
        }
      }
    }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object'){
            data.users = parsed.users || [];
            data.businesses = parsed.businesses || [];
            data.transactions = parsed.transactions || {};
            data.businesses = data.businesses.map(b=>{
              if (!Array.isArray(b.members)) b.members = [];
              if (!Array.isArray(b.contacts)) b.contacts = [];
              if (!Array.isArray(b.accounts)) b.accounts = [];
              if (typeof b.vatRate !== 'number') b.vatRate = 7.5;
              if (typeof b.vatEnabled === 'undefined') b.vatEnabled = true;
              if (typeof b.pitEnabled === 'undefined') b.pitEnabled = true;
              if (!b.pit) b.pit = DEFAULT_PIT;
              if (typeof b.whtAutoCreate === 'undefined') b.whtAutoCreate = true;
              if (!b.whtCode) b.whtCode = '2300';
              if (typeof b.vatInclusive === 'undefined') b.vatInclusive = false;
              ensureBizWhtAccount(b);
              return b;
            });
            return;
          }
        } catch(e){ console.error('Invalid saved data', e); }
      }

      // default demo
      const userId = uid('user');
      const bizId = uid('biz');
      const whtAccountId = uid('a_wht');
      const contact1 = { id: uid('c'), name: 'ACME Co', type: 'Customer', info: 'acme@example.com', notes: '' };
      const contact2 = { id: uid('c'), name: 'Office Supplies Ltd', type: 'Vendor', info: '0803-xxx', notes: '' };
      const contact3 = { id: uid('c'), name: 'John Employee', type: 'Employee', info: 'john@demo', notes: '' };
      const accounts = [
        { id: uid('a'), code: '1000', name: 'Cash', type: 'Asset', notes: '' },
        { id: uid('a2'), code: '2000', name: 'Accounts Payable', type: 'Liability', notes: '' },
        { id: uid('a3'), code: '4000', name: 'Sales Revenue', type: 'Revenue', notes: '' },
        { id: uid('a4'), code: '5000', name: 'Rent Expense', type: 'Expense', notes: '' },
      ];
      accounts.push({ id: whtAccountId, code: '2300', name: 'WHT Payable', type: 'Liability', notes: 'Auto-created' });

      data = {
        users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{
          id: bizId,
          name: 'Demo Business',
          ownerId: userId,
          members: [userId],
          vatRate: 7.5,
          currency: '₦',
          threshold: 800000,
          notes: 'Sample business',
          vatEnabled: true,
          pitEnabled: true,
          vatInclusive: false,
          whtAutoCreate: true,
          whtCode: '2300',
          whtAccountId: whtAccountId,
          contacts: [contact1, contact2, contact3],
          accounts: accounts,
          pit: DEFAULT_PIT
        }],
        transactions: {}
      };
      const now = new Date().toISOString().slice(0,10);
      data.transactions[bizId] = [
        { id: uid('txn'), date: now, desc: 'Demo sale to ACME', amount: 1500000, authorUserId: userId, contactId: contact1.id, accountId: accounts.find(a=>a.type==='Revenue').id, whtEnabled: false, whtRate: 0 },
        { id: uid('txn'), date: now, desc: 'Office rent', amount: 200000, authorUserId: userId, contactId: contact2.id, accountId: accounts.find(a=>a.type==='Expense').id, whtEnabled: true, whtRate: 5 },
        { id: uid('txn'), date: now, desc: 'Salary - John Employee', amount: 180000, authorUserId: userId, contactId: contact3.id, accountId: accounts.find(a=>a.type==='Expense').id, whtEnabled: false, whtRate: 0 }
      ];
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id) || null; }
    function findBiz(id){ return data.businesses.find(b=>b.id===id) || null; }
    function findContact(bizId, contactId){
      const b = findBiz(bizId); if (!b || !Array.isArray(b.contacts)) return null;
      return b.contacts.find(c=>c.id===contactId) || null;
    }
    function findAccount(bizId, accountId){
      const b = findBiz(bizId); if (!b || !Array.isArray(b.accounts)) return null;
      return b.accounts.find(a=>a.id===accountId) || null;
    }

    // UI references
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const whtSummaryDiv = document.getElementById('whtSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');
    const payeSummaryDiv = document.getElementById('payeSummary');
    const pitSummaryDiv = document.getElementById('pitSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    // User modal
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userNotes = document.getElementById('userNotes');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    // Business modal
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwner = document.getElementById('bizOwner');
    const bizMembers = document.getElementById('bizMembers');
    const bizVat = document.getElementById('bizVat');
    const bizCurrency = document.getElementById('bizCurrency');
    const bizThreshold = document.getElementById('bizThreshold');
    const bizNotes = document.getElementById('bizNotes');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizVatInclusive = document.getElementById('bizVatInclusive');
    const bizWhtEnabled = document.getElementById('bizWhtEnabled');
    const bizWhtCode = document.getElementById('bizWhtCode');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');

    // Contact & account modals
    const contactModal = document.getElementById('contactModal');
    const contactModalTitle = document.getElementById('contactModalTitle');
    const contactName = document.getElementById('contactName');
    const contactType = document.getElementById('contactType');
    const contactInfo = document.getElementById('contactInfo');
    const contactNotes = document.getElementById('contactNotes');
    const contactSave = document.getElementById('contactSave');
    const contactCancel = document.getElementById('contactCancel');

    const accountModal = document.getElementById('accountModal');
    const accountModalTitle = document.getElementById('accountModalTitle');
    const accountCode = document.getElementById('accountCode');
    const accountName = document.getElementById('accountName');
    const accountType = document.getElementById('accountType');
    const accountNotes = document.getElementById('accountNotes');
    const accountSave = document.getElementById('accountSave');
    const accountCancel = document.getElementById('accountCancel');

    // Edit modal
    const editModal = document.getElementById('editModal');
    const editTxnDate = document.getElementById('editTxnDate');
    const editTxnDesc = document.getElementById('editTxnDesc');
    const editTxnAmount = document.getElementById('editTxnAmount');
    const editTxnContact = document.getElementById('editTxnContact');
    const editTxnAccount = document.getElementById('editTxnAccount');
    const editTxnWhtEnabled = document.getElementById('editTxnWhtEnabled');
    const editTxnWhtRate = document.getElementById('editTxnWhtRate');
    const editWhtLabel = document.getElementById('editWhtLabel');
    const editWhtRateLabel = document.getElementById('editWhtRateLabel');
    const editCancel = document.getElementById('editCancel');
    const editSave = document.getElementById('editSave');

    // Add txn inline controls
    const txnDate = document.getElementById('txnDate');
    const txnDesc = document.getElementById('txnDesc');
    const txnAmount = document.getElementById('txnAmount');
    const txnContact = document.getElementById('txnContact');
    const txnAccount = document.getElementById('txnAccount');
    const txnWhtEnabled = document.getElementById('txnWhtEnabled');
    const txnWhtRate = document.getElementById('txnWhtRate');
    const whtInlineLabel = document.getElementById('whtInlineLabel');
    const whtRateInlineLabel = document.getElementById('whtRateInlineLabel');

    const btnAddContactInline = document.getElementById('btnAddContactInline');
    const btnAddAccountInline = document.getElementById('btnAddAccountInline');
    const btnOpenContacts = document.getElementById('btnOpenContacts');
    const contactsListDiv = document.getElementById('contactsList');
    const btnExportContacts = document.getElementById('btnExportContacts');

    const btnOpenAccounts = document.getElementById('btnOpenAccounts');
    const accountsListDiv = document.getElementById('accountsList');
    const btnExportAccounts = document.getElementById('btnExportAccounts');

    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // temp editing ids
    let userEditingId = null;
    let bizEditingId = null;
    let contactEditingId = null;
    let accountEditingId = null;

    // initialize
    loadData();
    refreshUserBusinessSelectors();
    ensureSelection();
    currentPage = 1;
    refreshContactsAccountsUI();
    renderLedger();
    calculateSummary();
    renderMonthlyPayePitSummaries();

    // modal helpers
    function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; modal.setAttribute('aria-hidden','false'); }
    function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; modal.setAttribute('aria-hidden','true'); userEditingId=null; bizEditingId=null; contactEditingId=null; accountEditingId=null; editTxnId=null; }
    modalOverlay.addEventListener('click', () => {
      const modals = [userModal, businessModal, editModal, contactModal, accountModal];
      modals.forEach(m=>{ if (m && m.style.display === 'block') closeModal(m); });
    });

    // User & Business selectors
    function refreshUserBusinessSelectors(){
      userSelect.innerHTML = '';
      data.users.forEach(u=>{
        const opt = document.createElement('option'); opt.value = u.id; opt.textContent = (u.display||u.username) + ' (' + u.username + ')'; userSelect.appendChild(opt);
      });

      businessSelect.innerHTML = '';
      const bizList = [];
      if (selectedUserId) {
        for (const b of data.businesses) {
          if (Array.isArray(b.members) && b.members.includes(selectedUserId)) bizList.push(b);
        }
      }
      if (bizList.length === 0) bizList.push(...data.businesses);

      bizList.forEach(b=>{
        const owner = findUser(b.ownerId);
        const enabledParts = [];
        if (b.vatEnabled) enabledParts.push('VAT');
        if (b.pitEnabled) enabledParts.push('PIT');
        if (b.whtAutoCreate) enabledParts.push('WHT');
        const status = enabledParts.length ? ' — ' + enabledParts.join('/') : '';
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name} ${owner ? ' — ' + (owner.display || owner.username) : ''} (${b.vatRate}% VAT${b.vatInclusive ? ' incl' : ''})${status}`;
        businessSelect.appendChild(opt);
      });

      bizOwner.innerHTML = '';
      bizMembers.innerHTML = '';
      data.users.forEach(u=>{
        const o = document.createElement('option'); o.value = u.id; o.textContent = (u.display||u.username); bizOwner.appendChild(o);
        const m = document.createElement('option'); m.value = u.id; m.textContent = (u.display||u.username) + ' (' + u.username + ')'; bizMembers.appendChild(m);
      });

      if (!data.users.find(u=>u.id===selectedUserId)) selectedUserId = data.users.length ? data.users[0].id : null;
      if (!data.businesses.find(b=>b.id===selectedBusinessId)) {
        const pick = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
        selectedBusinessId = pick ? pick.id : (data.businesses.length ? data.businesses[0].id : null);
      }

      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;

      populateContactSelects();
      populateAccountSelects();
    }

    function ensureSelection(){
      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length){
        const pick = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
        selectedBusinessId = pick ? pick.id : data.businesses[0].id;
      }
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    // User actions
    btnAddUser.addEventListener('click', ()=>{
      userModalTitle.textContent = 'Add User';
      userName.value=''; userDisplay.value=''; userNotes.value='';
      userEditingId = null;
      openModal(userModal);
    });

    btnEditUser.addEventListener('click', ()=>{
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId); if (!u) return;
      userModalTitle.textContent = 'Edit User';
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userNotes.value = u.notes || '';
      userEditingId = u.id;
      openModal(userModal);
    });

    btnDeleteUser.addEventListener('click', ()=>{
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId); if (!u) return;
      if (!confirm(`Delete user "${u.display || u.username}" and remove their authored transactions? This action cannot be undone.`)) return;
      const ownedBizIds = data.businesses.filter(b=>b.ownerId===u.id).map(b=>b.id);
      data.businesses = data.businesses.filter(b=>b.ownerId !== u.id);
      for (const bid of ownedBizIds){ if (data.transactions[bid]) delete data.transactions[bid]; }
      for (const b of data.businesses){ if (Array.isArray(b.members)) b.members = b.members.filter(mid=>mid!==u.id); const txs = data.transactions[b.id]||[]; data.transactions[b.id] = txs.filter(t=>t.authorUserId !== u.id); }
      data.users = data.users.filter(x=>x.id !== u.id);
      if (!data.users.length) { data = { users: [], businesses: [], transactions: {} }; }
      saveData();
      selectedUserId = data.users.length ? data.users[0].id : null;
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
      renderMonthlyPayePitSummaries();
    });

    userSave.addEventListener('click', ()=>{
      const username = (userName.value||'').trim();
      if (!username) { alert('Username required'); return; }
      if (userEditingId){
        const u = findUser(userEditingId); if (!u) return;
        u.username = username; u.display = (userDisplay.value||'').trim(); u.notes = (userNotes.value||'').trim();
      } else {
        const exists = data.users.find(x=>x.username === username);
        if (exists && !confirm('Username already exists. Add anyway?')) return;
        const id = uid('user'); data.users.push({ id, username, display: (userDisplay.value||'').trim(), notes: (userNotes.value||'').trim() });
      }
      saveData(); closeModal(userModal); refreshUserBusinessSelectors(); ensureSelection();
    });

    userCancel.addEventListener('click', ()=> closeModal(userModal));

    userSelect.addEventListener('change', (e)=>{
      selectedUserId = e.target.value;
      const owned = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
      if (owned) selectedBusinessId = owned.id;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      currentPage = 1; refreshUserBusinessSelectors(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    });

    // Business actions
    btnAddBusiness.addEventListener('click', ()=>{
      if (!selectedUserId) { alert('Create/select a user first'); return; }
      businessModalTitle.textContent = 'Add Business';
      bizName.value=''; bizVat.value=7.5; bizCurrency.value='₦'; bizThreshold.value=800000; bizNotes.value='';
      bizOwner.value = selectedUserId || (data.users[0] && data.users[0].id) || '';
      for (const opt of bizMembers.options) opt.selected = false;
      const ownerVal = bizOwner.value;
      for (const opt of bizMembers.options) if (opt.value === ownerVal) opt.selected = true;
      bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizVatInclusive.checked = false; bizWhtEnabled.checked = true; bizWhtCode.value = '2300';
      bizEditingId = null;
      openModal(businessModal);
    });

    btnEditBusiness.addEventListener('click', ()=>{
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId); if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizVat.value = (typeof b.vatRate === 'number') ? b.vatRate : 7.5;
      bizCurrency.value = b.currency || '₦';
      bizThreshold.value = (typeof b.threshold === 'number') ? b.threshold : 800000;
      bizNotes.value = b.notes || '';
      bizOwner.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
      for (const opt of bizMembers.options){ opt.selected = Array.isArray(b.members) && b.members.includes(opt.value); }
      bizVatEnabled.checked = !!b.vatEnabled;
      bizPitEnabled.checked = (typeof b.pitEnabled === 'undefined') ? true : !!b.pitEnabled;
      bizVatInclusive.checked = !!b.vatInclusive;
      bizWhtEnabled.checked = (typeof b.whtAutoCreate === 'undefined') ? true : !!b.whtAutoCreate;
      bizWhtCode.value = b.whtCode || '2300';
      bizEditingId = b.id;
      openModal(businessModal);
    });

    btnDeleteBusiness.addEventListener('click', ()=>{
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId); if (!b) return;
      if (!confirm(`Delete business "${b.name}" and all its transactions? This action cannot be undone.`)) return;
      data.businesses = data.businesses.filter(x=>x.id!==b.id);
      if (data.transactions[b.id]) delete data.transactions[b.id];
      saveData();
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderMonthlyPayePitSummaries();
    });

    bizSave.addEventListener('click', ()=>{
      const name = (bizName.value||'').trim();
      const ownerIdVal = bizOwner.value;
      const vat = parseFloat(bizVat.value);
      const currency = (bizCurrency.value||'₦').trim();
      const threshold = Number(bizThreshold.value) || 800000;
      const vatEnabledVal = !!bizVatEnabled.checked;
      const pitEnabledVal = !!bizPitEnabled.checked;
      const vatInclusiveVal = !!bizVatInclusive.checked;
      const whtAuto = !!bizWhtEnabled.checked;
      const whtCodeVal = (bizWhtCode.value||'2300').trim() || '2300';
      if (!name) { alert('Business name required'); return; }
      if (!ownerIdVal) { alert('Select owner'); return; }
      const members = [];
      for (const opt of bizMembers.options) if (opt.selected) members.push(opt.value);
      if (!members.includes(ownerIdVal)) members.push(ownerIdVal);

      if (bizEditingId){
        const b = findBiz(bizEditingId); if (!b) return;
        b.name = name; b.ownerId = ownerIdVal; b.members = members;
        b.vatRate = isNaN(vat) ? 7.5 : vat; b.currency = currency; b.threshold = threshold; b.notes = (bizNotes.value||'').trim();
        b.vatEnabled = vatEnabledVal; b.pitEnabled = pitEnabledVal; b.vatInclusive = vatInclusiveVal; b.whtAutoCreate = whtAuto; b.whtCode = whtCodeVal;
        ensureBizWhtAccount(b);
      } else {
        const id = uid('biz');
        const newBiz = {
          id, name, ownerId: ownerIdVal, members,
          vatRate: isNaN(vat) ? 7.5 : vat,
          currency,
          threshold,
          notes: (bizNotes.value||'').trim(),
          vatEnabled: vatEnabledVal,
          pitEnabled: pitEnabledVal,
          vatInclusive: vatInclusiveVal,
          whtAutoCreate: whtAuto,
          whtCode: whtCodeVal,
          contacts: [],
          accounts: [],
          pit: DEFAULT_PIT
        };
        if (whtAuto) ensureBizWhtAccount(newBiz);
        data.businesses.push(newBiz);
        if (!data.transactions[newBiz.id]) data.transactions[newBiz.id] = [];
      }
      saveData(); closeModal(businessModal); refreshUserBusinessSelectors(); ensureSelection(); currentPage=1; renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    });

    bizCancel.addEventListener('click', ()=> closeModal(businessModal));

    businessSelect.addEventListener('change', (e)=>{
      selectedBusinessId = e.target.value; currentPage = 1; refreshUserBusinessSelectors(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries(); refreshContactsAccountsUI();
    });

    // Contacts & Accounts UI
    function refreshContactsAccountsUI(){
      contactsListDiv.innerHTML = ''; accountsListDiv.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b){ contactsListDiv.textContent='No business selected.'; accountsListDiv.textContent='No business selected.'; populateContactSelects(); populateAccountSelects(); return; }
      if (!Array.isArray(b.contacts)) b.contacts = [];
      if (!Array.isArray(b.accounts)) b.accounts = [];

      if (b.contacts.length === 0) contactsListDiv.innerHTML = '<div class="muted">No contacts for this business.</div>';
      else {
        b.contacts.forEach(c=>{
          const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
          d.innerHTML = `<div><strong>${escapeHtml(c.name)}</strong> <span class="muted">(${escapeHtml(c.type)})</span><br/><small class="muted">${escapeHtml(c.info||'')}</small></div>
            <div style="display:flex;gap:6px"><button class="small" onclick="window.editContact('${c.id}')">Edit</button><button class="small danger" onclick="window.deleteContact('${c.id}')">Delete</button></div>`;
          contactsListDiv.appendChild(d);
        });
      }

      if (b.accounts.length === 0) accountsListDiv.innerHTML = '<div class="muted">No accounts for this business.</div>';
      else {
        b.accounts.forEach(a=>{
          const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
          const isWht = (b.whtAccountId && a.id === b.whtAccountId);
          d.innerHTML = `<div><strong>${escapeHtml(a.code)} - ${escapeHtml(a.name)}</strong> ${isWht?'<span class="muted"> (WHT Payable)</span>':''} <span class="muted">(${escapeHtml(a.type)})</span><br/><small class="muted">${escapeHtml(a.notes||'')}</small></div>
            <div style="display:flex;gap:6px"><button class="small" onclick="window.editAccount('${a.id}')">Edit</button><button class="small danger" onclick="window.deleteAccount('${a.id}')">Delete</button></div>`;
          accountsListDiv.appendChild(d);
        });
      }
      populateContactSelects();
      populateAccountSelects();
    }

    // Expose edit/delete contact/account for inline onclick (simple approach)
    window.editContact = function(id){
      const b = findBiz(selectedBusinessId); if (!b) return;
      const c = b.contacts.find(x=>x.id===id); if (!c) return;
      contactModalTitle.textContent = 'Edit Contact'; contactName.value = c.name||''; contactType.value = c.type||'Customer'; contactInfo.value = c.info||''; contactNotes.value = c.notes||''; contactEditingId = c.id;
      openModal(contactModal);
    };
    window.deleteContact = function(id){
      const b = findBiz(selectedBusinessId); if (!b) return;
      if (!confirm('Delete contact?')) return;
      b.contacts = b.contacts.filter(x=>x.id!==id);
      const txs = data.transactions[b.id] || [];
      for (const t of txs) if (t.contactId === id) t.contactId = null;
      saveData(); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    };

    window.editAccount = function(id){
      const b = findBiz(selectedBusinessId); if (!b) return;
      const a = b.accounts.find(x=>x.id===id); if (!a) return;
      accountModalTitle.textContent = 'Edit Account'; accountCode.value = a.code||''; accountName.value = a.name||''; accountType.value = a.type||'Asset'; accountNotes.value = a.notes||''; accountEditingId = a.id;
      openModal(accountModal);
    };
    window.deleteAccount = function(id){
      const b = findBiz(selectedBusinessId); if (!b) return;
      if (b.whtAccountId === id) { if (!confirm('This is the WHT Payable account. Deleting will unset the WHT account. Continue?')) return; b.whtAccountId = null; }
      b.accounts = b.accounts.filter(x=>x.id!==id);
      const txs = data.transactions[b.id] || [];
      for (const t of txs) if (t.accountId === id) t.accountId = null;
      saveData(); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    };

    btnOpenContacts.addEventListener('click', ()=>{
      contactModalTitle.textContent = 'Add Contact'; contactName.value=''; contactType.value='Customer'; contactInfo.value=''; contactNotes.value=''; contactEditingId = null; openModal(contactModal);
    });
    btnAddContactInline.addEventListener('click', ()=>{
      contactModalTitle.textContent = 'Add Contact'; contactName.value=''; contactType.value='Vendor'; contactInfo.value=''; contactNotes.value=''; contactEditingId = null; openModal(contactModal);
    });

    contactSave.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) { alert('Select a business first'); return; }
      const name = (contactName.value||'').trim(); if (!name) { alert('Contact name required'); return; }
      const info = (contactInfo.value||'').trim(); const notes = (contactNotes.value||'').trim(); const type = contactType.value || 'Customer';
      if (contactEditingId){
        const c = b.contacts.find(x=>x.id===contactEditingId); if (!c) return;
        c.name = name; c.type = type; c.info = info; c.notes = notes;
      } else {
        const id = uid('c'); b.contacts.push({ id, name, type, info, notes });
      }
      saveData(); closeModal(contactModal); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    });
    contactCancel.addEventListener('click', ()=> closeModal(contactModal));

    btnOpenAccounts.addEventListener('click', ()=>{
      accountModalTitle.textContent = 'Add Account'; accountCode.value=''; accountName.value=''; accountType.value='Asset'; accountNotes.value=''; accountEditingId = null; openModal(accountModal);
    });
    btnAddAccountInline.addEventListener('click', ()=>{
      accountModalTitle.textContent = 'Add Account'; accountCode.value=''; accountName.value=''; accountType.value='Expense'; accountNotes.value=''; accountEditingId = null; openModal(accountModal);
    });

    accountSave.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) { alert('Select a business first'); return; }
      const code = (accountCode.value||'').trim(); const name = (accountName.value||'').trim(); const type = accountType.value || 'Asset'; const notes = (accountNotes.value||'').trim();
      if (!name) { alert('Account name required'); return; }
      if (accountEditingId){
        const a = b.accounts.find(x=>x.id===accountEditingId); if (!a) return;
        a.code = code; a.name = name; a.type = type; a.notes = notes;
      } else {
        const id = uid('a'); b.accounts.push({ id, code, name, type, notes });
      }
      saveData(); closeModal(accountModal); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    });
    accountCancel.addEventListener('click', ()=> closeModal(accountModal));

    // populate selects
    function populateContactSelects(){
      [txnContact, editTxnContact].forEach(sel=>{
        if (!sel) return;
        const prev = sel.value;
        sel.innerHTML = '<option value="">(none)</option>';
        const b = findBiz(selectedBusinessId);
        if (!b || !Array.isArray(b.contacts)) return;
        b.contacts.forEach(c=>{ const o = document.createElement('option'); o.value = c.id; o.textContent = c.name + ' (' + c.type + ')'; sel.appendChild(o); });
        if (prev) sel.value = prev;
      });
    }

    function populateAccountSelects(){
      [txnAccount, editTxnAccount].forEach(sel=>{
        if (!sel) return;
        const prev = sel.value;
        sel.innerHTML = '<option value="">(none)</option>';
        const b = findBiz(selectedBusinessId);
        if (!b || !Array.isArray(b.accounts)) return;
        b.accounts.forEach(a=>{ const o = document.createElement('option'); o.value = a.id; o.textContent = (a.code ? a.code + ' - ' : '') + a.name + ' (' + a.type + ')'; sel.appendChild(o); });
        if (prev) sel.value = prev;
      });
      // ensure WHT inline visibility updates when add/account select changes
      updateWhtInlineVisibility();
    }

    // derive transaction type from account type
    function deriveTypeFromAccount(account){
      if (!account) return 'Income';
      if (account.type === 'Revenue') return 'Income';
      if (account.type === 'Expense') return 'Expense';
      return 'Income';
    }

    // update WHT inline visibility (shown when selected account is Expense)
    function updateWhtInlineVisibility(){
      const acc = findAccount(selectedBusinessId, txnAccount.value);
      const isExpense = acc && acc.type === 'Expense';
      whtInlineLabel.style.display = isExpense ? 'inline-block' : 'none';
      whtRateInlineLabel.style.display = isExpense ? 'inline-block' : 'none';
      if (!isExpense) { txnWhtEnabled.checked = false; txnWhtRate.value = 5; }
    }
    txnAccount.addEventListener('change', updateWhtInlineVisibility);

    // update edit modal WHT visibility when account changes
    function updateEditWhtVisibility(){
      const acc = findAccount(selectedBusinessId, editTxnAccount.value);
      const isExpense = acc && acc.type === 'Expense';
      editWhtLabel.style.display = isExpense ? 'inline-block' : 'none';
      editWhtRateLabel.style.display = isExpense ? 'inline-block' : 'none';
      if (!isExpense) { editTxnWhtEnabled.checked = false; editTxnWhtRate.value = 5; }
    }
    editTxnAccount.addEventListener('change', updateEditWhtVisibility);

    // Add transaction
    btnAddTxn.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) { alert('Select a business first'); return; }
      const date = txnDate.value || new Date().toISOString().slice(0,10);
      const desc = (txnDesc.value||'').trim();
      const amount = Number(txnAmount.value) || 0;
      const accountId = txnAccount.value || null;
      const contactId = txnContact.value || null;
      const whtEnabledVal = !!txnWhtEnabled.checked;
      const whtRateVal = parseFloat(txnWhtRate.value) || 0;
      if (!accountId){ if (!confirm('No account selected. Add transaction without account?')) return; }
      if (!amount || amount <= 0){ alert('Amount must be > 0'); return; }
      const id = uid('txn'); const t = { id, date, desc, amount, authorUserId: selectedUserId, contactId: contactId || null, accountId: accountId || null, whtEnabled: whtEnabledVal, whtRate: whtRateVal };
      if (!data.transactions[b.id]) data.transactions[b.id] = [];
      data.transactions[b.id].unshift(t);
      saveData(); txnDesc.value=''; txnAmount.value=''; txnDate.value=''; txnAccount.value=''; txnContact.value=''; txnWhtEnabled.checked=false; txnWhtRate.value=5; currentPage=1; renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    });

    // render ledger with pagination and search
    function getFilteredTransactions(){ const all = data.transactions[selectedBusinessId] || []; if (!ledgerFilterText) return all; const q = ledgerFilterText.toLowerCase(); return all.filter(t=>{ const acc = findAccount(selectedBusinessId, t.accountId); const accText = acc ? ((acc.code?acc.code+' - ':'') + acc.name + ' ('+acc.type+')') : ''; const contact = findContact(selectedBusinessId, t.contactId); const contactText = contact ? contact.name : ''; const author = findUser(t.authorUserId); const authorText = author ? (author.display||author.username) : ''; return ((t.date||'').toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q) || String(t.amount||'').toLowerCase().includes(q) || accText.toLowerCase().includes(q) || contactText.toLowerCase().includes(q) || authorText.toLowerCase().includes(q)); }); }

    function renderLedger(){ ledgerTbody.innerHTML=''; const b = findBiz(selectedBusinessId); if (!b){ ledgerTbody.innerHTML = '<tr><td colspan="8" class="muted">No business selected.</td></tr>'; pageIndicator.textContent = 'Page 0 / 0'; return; }
      const all = getFilteredTransactions();
      const totalPages = Math.max(1, Math.ceil(all.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage-1)*PAGE_SIZE;
      const pageTx = all.slice(start, start+PAGE_SIZE);
      if (pageTx.length === 0) ledgerTbody.innerHTML = '<tr><td colspan="8" class="muted">No transactions.</td></tr>';
      pageTx.forEach(t=>{
        const tr=document.createElement('tr');
        const acc = findAccount(selectedBusinessId, t.accountId);
        const accText = acc ? ((acc.code?acc.code+' - ':'') + acc.name + ' ('+acc.type+')') : '(no account)';
        const contact = findContact(selectedBusinessId, t.contactId);
        const contactText = contact ? contact.name : '';
        const author = findUser(t.authorUserId);
        const authorText = author ? (author.display||author.username) : '';
        const whtAmt = t.whtEnabled ? Math.round((Number(t.amount||0) * (Number(t.whtRate||0)/100)) * 100) / 100 : 0;
        tr.innerHTML = `<td class="nowrap">${escapeHtml(t.date)}</td>
          <td>${escapeHtml(t.desc)}</td>
          <td>${escapeHtml(accText)}</td>
          <td class="nowrap">₦ ${formatMoney(t.amount)}</td>
          <td class="nowrap">₦ ${formatMoney(whtAmt)}</td>
          <td>${escapeHtml(contactText)}</td>
          <td>${escapeHtml(authorText)}</td>
          <td class="actions"><button class="small" onclick="window.openEditTxn('${t.id}')">Edit</button><button class="small danger" onclick="window.deleteTxn('${t.id}')">Delete</button></td>`;
        ledgerTbody.appendChild(tr);
      });
      pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
    }

    window.openEditTxn = function(id){
      const b=findBiz(selectedBusinessId); if (!b) return;
      const txs = data.transactions[b.id]||[]; const t = txs.find(x=>x.id===id); if (!t) return;
      editTxnId = t.id;
      editTxnDate.value = t.date || '';
      editTxnDesc.value = t.desc || '';
      editTxnAmount.value = t.amount || 0;
      editTxnContact.value = t.contactId || '';
      editTxnAccount.value = t.accountId || '';
      editTxnWhtEnabled.checked = !!t.whtEnabled;
      editTxnWhtRate.value = t.whtRate || 5;
      updateEditWhtVisibility();
      openModal(editModal);
    };

    window.deleteTxn = function(id){
      const b = findBiz(selectedBusinessId); if (!b) return;
      if (!confirm('Delete transaction?')) return;
      const txs = data.transactions[b.id] || [];
      data.transactions[b.id] = txs.filter(x=>x.id!==id);
      saveData(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    };

    editCancel.addEventListener('click', ()=> closeModal(editModal));

    editSave.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) return;
      if (!editTxnId) { closeModal(editModal); return; }
      const txs = data.transactions[b.id] || [];
      const t = txs.find(x=>x.id===editTxnId); if (!t) return;
      t.date = editTxnDate.value || t.date;
      t.desc = (editTxnDesc.value||'').trim();
      t.amount = Number(editTxnAmount.value) || 0;
      t.contactId = editTxnContact.value || null;
      t.accountId = editTxnAccount.value || null;
      t.whtEnabled = !!editTxnWhtEnabled.checked;
      t.whtRate = parseFloat(editTxnWhtRate.value) || 0;
      saveData(); closeModal(editModal); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    });

    // search & pagination
    btnSearch.addEventListener('click', ()=> { ledgerFilterText = ledgerSearch.value || ''; currentPage = 1; renderLedger(); });
    btnClearSearch.addEventListener('click', ()=> { ledgerSearch.value=''; ledgerFilterText=''; currentPage=1; renderLedger(); });
    btnPrevPage.addEventListener('click', ()=> { if (currentPage>1) { currentPage--; renderLedger(); }});
    btnNextPage.addEventListener('click', ()=> { currentPage++; renderLedger(); });

    // export/import/clear
    btnExport.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc-export.json'; a.click(); URL.revokeObjectURL(url);
    });
    btnImport.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        try {
          const parsed = JSON.parse(ev.target.result);
          if (parsed && typeof parsed === 'object'){ data = parsed; saveData(); refreshUserBusinessSelectors(); ensureSelection(); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries(); alert('Import successful'); }
        } catch(err){ alert('Invalid JSON file'); }
      };
      reader.readAsText(f);
      fileInput.value = '';
    });
    btnClearAll.addEventListener('click', ()=>{
      if (!confirm('Clear all data? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      data = { users: [], businesses: [], transactions: {} };
      loadData(); refreshUserBusinessSelectors(); ensureSelection(); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
    });

    btnExportContacts.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) return alert('Select business');
      const blob = new Blob([JSON.stringify(b.contacts || [], null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'contacts-' + (b.name||'biz') + '.json'; a.click(); URL.revokeObjectURL(url);
    });
    btnExportAccounts.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) return alert('Select business');
      const blob = new Blob([JSON.stringify(b.accounts || [], null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'accounts-' + (b.name||'biz') + '.json'; a.click(); URL.revokeObjectURL(url);
    });

    // --- VAT / WHT / Totals summary calculation ---
    function calculateSummary(){
      const b = findBiz(selectedBusinessId);
      if (!b) {
        vatSummaryDiv.innerHTML = '<div class="muted">No business selected.</div>';
        whtSummaryDiv.innerHTML = '<div class="muted">No business selected.</div>';
        totalsSummaryDiv.innerHTML = '<div class="muted">No business selected.</div>';
        taxSummaryDiv.innerHTML = '';
        return;
      }
      const txs = data.transactions[b.id] || [];
      let totalVat = 0;
      let totalWht = 0;
      let totalIncome = 0;
      let totalExpense = 0;
      for (const t of txs){
        const acc = findAccount(b.id, t.accountId);
        const type = deriveTypeFromAccount(acc);
        if (type === 'Income') totalIncome += Number(t.amount||0);
        else totalExpense += Number(t.amount||0);

        // VAT
        if (b.vatEnabled && acc && acc.type === 'Revenue'){
          if (b.vatInclusive){
            // amount includes VAT -> extract VAT portion
            const rate = (Number(b.vatRate)||0)/100;
            const vatPart = Number(t.amount) - (Number(t.amount) / (1 + rate));
            totalVat += vatPart;
          } else {
            // VAT added on top
            totalVat += (Number(t.amount||0) * ((Number(b.vatRate)||0)/100));
          }
        }

        // WHT - apply only to expense transactions where whtEnabled true
        if (acc && acc.type === 'Expense' && t.whtEnabled){
          const w = Number(t.amount||0) * ((Number(t.whtRate)||0)/100);
          totalWht += w;
        }
      }
      totalVat = Math.round(totalVat * 100) / 100;
      totalWht = Math.round(totalWht * 100) / 100;

      vatSummaryDiv.innerHTML = `<strong>VAT Summary</strong><div style="margin-top:8px;">${b.vatEnabled ? `VAT rate: ${b.vatRate}% — Calculated VAT: ₦ ${formatMoney(totalVat)}` : '<span class="muted">VAT disabled for this business.</span>'}</div>`;
      whtSummaryDiv.innerHTML = `<strong>WHT Summary</strong><div style="margin-top:8px;">Total WHT withheld (from expenses): ₦ ${formatMoney(totalWht)}</div>`;

      totalsSummaryDiv.innerHTML = `<strong>Totals</strong><div style="margin-top:8px;">Total Income: ₦ ${formatMoney(totalIncome)} | Total Expense: ₦ ${formatMoney(totalExpense)} | Net: ₦ ${formatMoney(totalIncome - totalExpense)}</div>`;

      taxSummaryDiv.innerHTML = `<div class="muted">Threshold (PIT): ₦ ${formatMoney(b.pit && b.pit.threshold ? b.pit.threshold : DEFAULT_PIT.threshold)}</div>`;
      // after VAT/WHT/totals, render monthly PAYE/PIT summaries
      renderMonthlyPayePitSummaries();
    }

    // --- Monthly PAYE & PIT (pay-as-you-go) helpers & rendering ---
    function _round2(v){ return Math.round((Number(v)||0) * 100) / 100; }

    /**
     * Compute progressive tax on an annual amount using business PIT config.
     * pit.threshold and pit.slices are expected to be annual.
     */
    function computeProgressiveAnnualTax(amountAnnual, pit){
      amountAnnual = Number(amountAnnual) || 0;
      if (!pit || !Array.isArray(pit.slices)) return 0;
      const threshold = Number(pit.threshold) || 0;
      const taxable = Math.max(0, amountAnnual - threshold);
      if (taxable <= 0) return 0;
      let prev = 0;
      let tax = 0;
      for (const s of pit.slices){
        const sliceTopRaw = (s.upTo === Infinity) ? Infinity : Number(s.upTo || 0);
        // Convert slice top to taxable-space by subtracting threshold
        const sliceTop = (sliceTopRaw === Infinity) ? Infinity : Math.max(0, sliceTopRaw - threshold);
        const upper = (sliceTop === Infinity) ? taxable : Math.min(taxable, sliceTop);
        const taxableInSlice = Math.max(0, upper - prev);
        if (taxableInSlice > 0){
          tax += taxableInSlice * (Number(s.rate) || 0);
          prev += taxableInSlice;
        }
        if (prev >= taxable) break;
      }
      return _round2(tax);
    }

    /**
     * Build monthly summaries for a business.
     * - Groups transactions by employee contact (contact.type === 'Employee') and by month (YYYY-MM).
     * - For each employee-month: monthlyGross, annualizedGross = monthlyGross*12, annualTax = progressive(annualizedGross), monthlyTax = annualTax/12.
     * Returns structures for rendering.
     */
    function computeMonthlyPayePitSummariesForBusiness(bizId){
      const b = findBiz(bizId);
      if (!b) return { perEmployee: {}, payeTotal: 0, pitAnnualTotal: 0 };

      const txs = data.transactions[bizId] || [];
      // map employeeId -> monthKey -> { gross }
      const empMonthMap = {};
      for (const t of txs){
        if (!t) continue;
        const contact = t.contactId ? findContact(bizId, t.contactId) : null;
        if (!contact || contact.type !== 'Employee') continue;
        const contactId = contact.id;
        const dateStr = (t.date || '').slice(0,7) || 'unknown'; // YYYY-MM
        if (!empMonthMap[contactId]) empMonthMap[contactId] = {};
        if (!empMonthMap[contactId][dateStr]) empMonthMap[contactId][dateStr] = { gross: 0 };
        empMonthMap[contactId][dateStr].gross += Number(t.amount) || 0;
      }

      const perEmployee = {};
      let payeTotal = 0;
      let pitAnnualTotal = 0;

      for (const contactId of Object.keys(empMonthMap)){
        const contact = findContact(bizId, contactId) || { name: '(unknown)' };
        const monthsObj = empMonthMap[contactId];
        const months = Object.keys(monthsObj).sort();
        let totalGross = 0;
        let totalMonthlyWithheld = 0;
        for (const m of months){
          const mgross = Number(monthsObj[m].gross) || 0;
          totalGross += mgross;
          const annualized = mgross * 12;
          const annualTax = computeProgressiveAnnualTax(annualized, b.pit || DEFAULT_PIT);
          const monthlyTax = _round2(annualTax / 12);
          monthsObj[m].monthlyTax = monthlyTax;
          monthsObj[m].annualized = annualized;
          monthsObj[m].annualTax = annualTax;
          totalMonthlyWithheld += monthlyTax;
        }
        const monthsCount = months.length || 0;
        const avgMonthlyGross = monthsCount ? (totalGross / monthsCount) : 0;
        const estAnnualized = avgMonthlyGross * 12;
        const estAnnualTax = computeProgressiveAnnualTax(estAnnualized, b.pit || DEFAULT_PIT);
        perEmployee[contactId] = {
          name: contact.name || '(unknown)',
          months: monthsObj,
          monthsCount,
          totalGross: _round2(totalGross),
          totalMonthlyWithheld: _round2(totalMonthlyWithheld),
          estimatedAnnualGross: _round2(estAnnualized),
          estimatedAnnualTax: _round2(estAnnualTax),
          estimatedMonthlyTax: _round2(estAnnualTax / 12)
        };
        payeTotal += totalMonthlyWithheld;
        pitAnnualTotal += perEmployee[contactId].estimatedAnnualTax;
      }

      payeTotal = _round2(payeTotal);
      pitAnnualTotal = _round2(pitAnnualTotal);

      return { perEmployee, payeTotal, pitAnnualTotal };
    }

    /**
     * Render monthly PAYE & PIT UI.
     * Call this at the end of calculateSummary() and after transactions change.
     */
    function renderMonthlyPayePitSummaries(){
      const b = findBiz(selectedBusinessId);
      if (!b){
        payeSummaryDiv.innerHTML = '<div class="muted">No business selected.</div>';
        pitSummaryDiv.innerHTML = '<div class="muted">No business selected.</div>';
        return;
      }

      if (!b.pit) b.pit = DEFAULT_PIT;
      const { perEmployee, payeTotal, pitAnnualTotal } = computeMonthlyPayePitSummariesForBusiness(b.id);
      const empKeys = Object.keys(perEmployee);

      // PAYE summary (monthly withholdings)
      if (empKeys.length === 0){
        payeSummaryDiv.innerHTML = '<div class="muted">No PAYE (no Employee transactions).</div>';
      } else {
        let out = '<strong>PAYE withheld (monthly, per employee)</strong>';
        out += '<table style="width:100%;margin-top:8px;border-collapse:collapse"><thead><tr style="background:#f2f6fa"><th style="padding:6px;border:1px solid #eee;text-align:left">Employee</th><th style="padding:6px;border:1px solid #eee;text-align:right">Months</th><th style="padding:6px;border:1px solid #eee;text-align:right">Total Gross (₦)</th><th style="padding:6px;border:1px solid #eee;text-align:right">Total PAYE Withheld (₦)</th></tr></thead><tbody>';
        for (const k of empKeys){
          const r = perEmployee[k];
          out += `<tr><td style="padding:6px;border:1px solid #eee">${escapeHtml(r.name)}</td><td style="padding:6px;border:1px solid #eee;text-align:right">${r.monthsCount}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(r.totalGross)}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(r.totalMonthlyWithheld)}</td></tr>`;
          // per-month detail
          const monthKeys = Object.keys(r.months).sort();
          if (monthKeys.length){
            out += '<tr><td colspan="4" style="padding:0;border:0"><table style="width:100%;border-collapse:collapse"><thead><tr><th style="padding:6px;border:1px solid #eee;background:#fafafa">Month</th><th style="padding:6px;border:1px solid #eee;background:#fafafa;text-align:right">Gross (₦)</th><th style="padding:6px;border:1px solid #eee;background:#fafafa;text-align:right">Monthly PAYE (₦)</th></tr></thead><tbody>';
            for (const m of monthKeys){
              const mm = r.months[m];
              out += `<tr><td style="padding:6px;border:1px solid #eee">${escapeHtml(m)}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(mm.gross)}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(mm.monthlyTax)}</td></tr>`;
            }
            out += '</tbody></table></td></tr>';
          }
        }
        out += `<tr style="font-weight:bold"><td style="padding:6px;border:1px solid #eee">Totals</td><td style="padding:6px;border:1px solid #eee"></td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(Object.values(perEmployee).reduce((s,x)=>s+(x.totalGross||0),0))}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(payeTotal)}</td></tr>`;
        out += '</tbody></table>';
        payeSummaryDiv.innerHTML = out;
      }

      // PIT summary (estimated annual liability based on observed months)
      if (empKeys.length === 0){
        pitSummaryDiv.innerHTML = '<div class="muted">No PIT liabilities (no Employee transactions).</div>';
      } else {
        let out = '<strong>PIT estimate (annual, based on observed months)</strong>';
        out += '<table style="width:100%;margin-top:8px;border-collapse:collapse"><thead><tr style="background:#f2f6fa"><th style="padding:6px;border:1px solid #eee;text-align:left">Employee</th><th style="padding:6px;border:1px solid #eee;text-align:right">Months Observed</th><th style="padding:6px;border:1px solid #eee;text-align:right">Estimated Annual Gross (₦)</th><th style="padding:6px;border:1px solid #eee;text-align:right">Estimated Annual PIT (₦)</th><th style="padding:6px;border:1px solid #eee;text-align:right">Estimated Monthly PIT (₦)</th></tr></thead><tbody>';
        for (const k of empKeys){
          const r = perEmployee[k];
          out += `<tr><td style="padding:6px;border:1px solid #eee">${escapeHtml(r.name)}</td><td style="padding:6px;border:1px solid #eee;text-align:right">${r.monthsCount}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(r.estimatedAnnualGross)}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(r.estimatedAnnualTax)}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(r.estimatedMonthlyTax)}</td></tr>`;
        }
        out += `<tr style="font-weight:bold"><td style="padding:6px;border:1px solid #eee">Totals</td><td style="padding:6px;border:1px solid #eee"></td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(Object.values(perEmployee).reduce((s,x)=>s+(x.estimatedAnnualGross||0),0))}</td><td style="padding:6px;border:1px solid #eee;text-align:right">₦ ${formatMoney(pitAnnualTotal)}</td><td style="padding:6px;border:1px solid #eee"></td></tr>`;
        out += '</tbody></table>';
        pitSummaryDiv.innerHTML = out;
      }
    }

    // Make available for debugging/testing if needed
    window.calculateSummary = calculateSummary;
    window.renderMonthlyPayePitSummaries = renderMonthlyPayePitSummaries;

    // finalize initial UI population
    populateAccountSelects();
    populateContactSelects();
    refreshContactsAccountsUI();
    renderLedger();
    calculateSummary();
    renderMonthlyPayePitSummaries();
  </script>
</body>
       </html>
