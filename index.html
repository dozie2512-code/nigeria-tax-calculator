<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Accounting & Tax Engine — Updated (WHT / PAYE / PIT)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,96vw); max-height:80vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted-pill { background:#f2f4f7; padding:4px 8px; border-radius:6px; font-size:0.9rem; color:#333; }
    .disabled { opacity:0.45; pointer-events:none; }
    .code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f3f5f7; padding:4px 6px; border-radius:4px; }
    .report-toolbar { display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    .summary-line { display:flex; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed #eee; }
    .small-table { width:100%; border-collapse:collapse; }
    .small-table th, .small-table td { padding:6px; border:1px solid #e9eef5; text-align:left; font-size:0.9rem; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax Engine — Updated</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
      </div>
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="OpeningBalance">Opening Balance</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="Salary">Salary (PAYE)</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
            <option value="BankPayment">Bank Payment</option>
            <option value="BankReceipt">Bank Receipt</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div style="margin-top:10px;">
        <div class="notice">
          Notes:
          <ul>
            <li>WHT payable = WHT withheld on your payments to suppliers (outgoing).</li>
            <li>WHT receivable = WHT withheld on amounts you received (incoming) and may be credited.</li>
            <li>PAYE computed for Salary transactions only and only for contacts typed "Employee" in Contacts (Business settings).</li>
            <li>PIT for Sole Proprietor businesses is computed using PAYE bands (same bands) on business taxable profit.</li>
          </ul>
        </div>
      </div>

      <div style="margin-top:10px;">
        <h3 style="margin:4px 0;">Opening and simple ledger controls</h3>
        <div class="form-inline">
          <button id="btnExportLedger" class="small">Export Ledger JSON</button>
          <button id="btnClearLedger" class="small danger">Clear Ledger</button>
        </div>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active reportTabButton" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab reportTabButton" data-report="vatReport">VAT Report</button>
        <button class="small tab reportTabButton" data-report="whtPayable">WHT Payable/Receivable</button>
        <button class="small tab reportTabButton" data-report="payeReport">PAYE Report</button>
        <button class="small tab reportTabButton" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab reportTabButton" data-report="assetsReport">Fixed Assets Report</button>
        <button class="small tab reportTabButton" data-report="auditTrail">Audit Trail</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (Employee / SoleTrader), that will override these values for PAYE / PIT.</small>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add contacts and set statutory deductions per contact if needed.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">
    Stored in browser (localStorage) and exportable to file (Export / Import JSON).
  </footer>

  <script>
  /************************************************************************
   * Updated single-file frontend implementing:
   * - WHT payable and receivable calculation and report
   * - PAYE per-contact (annual & monthly) using PAYE_BANDS applied to salary transactions only (employees)
   * - PIT for Sole Proprietor businesses using PAYE_BANDS
   * - Reports tab: WHT report and PAYE report (per-contact table)
   * - Tax Summary displays WHT totals and PAYE totals
   *
   * Notes:
   * - Transactions are stored per user->business. Reports aggregate across users for the selected business.
   * - WHT categorised by action: outgoing actions -> WHT payable, incoming actions -> WHT receivable.
   * - Contact-level statutory deductions override business defaults for PAYE calculation.
   ************************************************************************/

  const STORAGE_KEY = 'ntc_full_accounting_v2';
  const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, caRateDefault:20.0, depRateDefault:20.0 };
  const PAYE_BANDS = [
    { upTo: 300000, rate: 0.07 },
    { upTo: 600000, rate: 0.11 },
    { upTo: 1100000, rate: 0.15 },
    { upTo: 1600000, rate: 0.19 },
    { upTo: 3200000, rate: 0.21 },
    { upTo: Infinity, rate: 0.24 }
  ];

  // outgoing actions considered payments to suppliers (WHT payable)
  const OUTGOING_ACTIONS = ['Expense','BankPayment','InventoryPurchase','FixedAssetPurchase'];
  // incoming actions considered receipts from customers (WHT receivable)
  const INCOMING_ACTIONS = ['Revenue','BankReceipt','InventorySale'];

  // state
  let state = { users: [], businesses: [], transactions: {}, attachments: {}, audit: [], auth: { currentUserId: null } };
  let selectedUserId = null;
  let selectedBizId = null;
  let activeTab = 'ledger';
  let activeReport = 'taxReconciliation';

  // DOM refs
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const btnAddTxn = document.getElementById('btnAddTxn');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const ledgerSection = document.getElementById('ledgerSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');

  const modalOverlay = document.getElementById('modalOverlay');
  const businessModal = document.getElementById('businessModal');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizCapitalBF = document.getElementById('bizCapitalBF');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnReportsTab = document.getElementById('btnReportsTab');
  const reportTabButtons = document.querySelectorAll('.reportTabButton');

  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const fileInput = document.getElementById('fileInput');
  const btnClearAll = document.getElementById('btnClearAll');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
  function toISO(date){ if(!date) return null; return new Date(date).toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }

  // persistence
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }
  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || { currentUserId: null };
    state.businesses.forEach(b => {
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
      b.accounts = b.accounts || [];
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
      b.caRateDefault = Number(b.caRateDefault || DEFAULTS.caRateDefault);
      b.depRateDefault = Number(b.depRateDefault || DEFAULTS.depRateDefault);
      ensureGainLossAccounts(b);
    });
    for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; for(const b of state.businesses){ state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || []; } }
    saveState();
  }

  function ensureGainLossAccounts(biz){
    biz.accounts = biz.accounts || [];
    if(!biz.accounts.find(a=>a.name==='Gain on Disposal')) biz.accounts.push({ id: uid('acct'), name:'Gain on Disposal', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
    if(!biz.accounts.find(a=>a.name==='Loss on Disposal')) biz.accounts.push({ id: uid('acct'), name:'Loss on Disposal', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
    if(!biz.accounts.find(a=>a.name==='PAYE Expense')) biz.accounts.push({ id: uid('acct'), name:'PAYE Expense', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
    if(!biz.accounts.find(a=>a.name==='PAYE Liability')) biz.accounts.push({ id: uid('acct'), name:'PAYE Liability', category:'Liability', disallowableDefault:false, nonTaxableDefault:false });
  }

  // seed demo
  function seedDemo(){
    const u = uid('user'), b = uid('biz');
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false };
    state = {
      users: [{ id: u, username: 'admin', display:'Admin', role:'Admin', permissions:{ view:true, edit:true, delete:true } }],
      businesses: [{
        id: b, name: 'Demo Business', ownerId: u, entity:'Company',
        vatRate: DEFAULTS.vatRate, whtRate: DEFAULTS.whtRate, citRate: DEFAULTS.citRate,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS.depRateDefault,
        accounts: [sales, cogs, salaries, bank],
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [],
        contacts: [
          { id: uid('c'), name:'Alice Employee', type:'Employee', statutory:{ pension:12000, rent:60000, life:0, mortgage:0, nhf:0 }, taxSettings:{ } },
          { id: uid('c2'), name:'Acme Supplies', type:'Vendor', statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings:{} },
          { id: uid('c3'), name:'Bob Sole', type:'SoleTrader', statutory:{ pension:20000, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings:{} }
        ],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: u }
    };
    ensureGainLossAccounts(state.businesses[0]);
    state.transactions[u] = {}; state.transactions[u][b] = [];
    // seed a few transactions for demo
    const txns = state.transactions[u][b];
    txns.push({ id: uid('txn'), date: today(), action:'Revenue', accountId: sales.id, desc:'Sales invoice #1', amount: 500000, vatType:'exclusive', wht:false, whtRate:0, contact:'Acme Supplies' });
    txns.push({ id: uid('txn'), date: today(), action:'Expense', accountId: cogs.id, desc:'Purchase goods', amount: 200000, vatType:'inclusive', wht:true, whtRate:5, whtBasis:'gross', contact:'Acme Supplies' });
    // salary for Alice
    txns.push({ id: uid('txn'), date: today(), action:'Salary', accountId: salaries.id, desc:'Payroll - Alice', amount: 600000, vatType:'none', paye:true, contact:'Alice Employee' });
    // salary for Bob (sole trader) — treat as drawing; included for demonstration
    txns.push({ id: uid('txn'), date: today(), action:'Salary', accountId: salaries.id, desc:'Payment to Bob Sole', amount: 1200000, vatType:'none', paye:true, contact:'Bob Sole' });
    addAudit('seed','system','',`Seeded demo data`);
    saveState();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    renderAll();
  }

  // audit
  function addAudit(type, entityType, entityId, details){
    state.audit = state.audit || [];
    state.audit.push({ id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details });
    saveState();
  }

  // modal helpers
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }

  modalOverlay.addEventListener('click', ()=> {
    [businessModal].forEach(m => { if(m.style.display==='block') closeModal(m); });
  });

  // init
  loadState();
  initUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  function initUI(){
    btnAddBusiness.addEventListener('click', ()=> {
      businessModal.querySelector('h3').textContent = 'Add Business';
      bizName.value='New Business'; bizOwnerSelect.value = state.users[0] ? state.users[0].id : '';
      bizEntity.value='Company'; bizVat.value=DEFAULTS.vatRate; bizWht.value=DEFAULTS.whtRate; bizCit.value=DEFAULTS.citRate;
      bizVatEnabled.checked = true; bizPitEnabled.checked = false; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
      bizSave.dataset.edit = '';
      bizContactsList.innerHTML = '';
      openModal(businessModal);
    });
    btnEditBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const b = findBiz(selectedBizId); if(!b) return alert('Business not found');
      businessModal.querySelector('h3').textContent = 'Edit Business';
      bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (state.users[0] && state.users[0].id) || '';
      bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
      bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled;
      bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0; bizCapitalBF.value = b.capitalBroughtForward || 0;
      bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
      bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0;
      bizSave.dataset.edit = b.id;
      renderBizContacts(b);
      openModal(businessModal);
    });
    btnDeleteBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      if(!confirm('Delete business and all its transactions?')) return;
      deleteBusiness(selectedBizId);
    });

    bizSave.addEventListener('click', ()=> {
      const name = (bizName.value||'').trim(); if(!name) return alert('Business name required');
      const editId = bizSave.dataset.edit;
      if(editId){
        const b = findBiz(editId);
        b.name = name; b.ownerId = bizOwnerSelect.value; b.entity = bizEntity.value;
        b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
        b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked;
        b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0); b.capitalBroughtForward = Number(bizCapitalBF.value || 0);
        b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) };
        ensureGainLossAccounts(b);
        addAudit('business.edit','business', b.id, 'Edited business');
      } else {
        const newBiz = {
          id: uid('biz'), name, ownerId: bizOwnerSelect.value || (state.users[0] && state.users[0].id),
          entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate),
          vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
          accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
          lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS.depRateDefault
        };
        newBiz.accounts.push({ id: uid('acct'), name:'Sales', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Bank', category:'Asset', disallowableDefault:false, nonTaxableDefault:false });
        ensureGainLossAccounts(newBiz);
        state.businesses.push(newBiz);
        for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][newBiz.id] = []; }
        addAudit('business.add','business', newBiz.id, 'Added business');
      }
      saveState(); closeModal(businessModal); refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll();
    });
    bizCancel.addEventListener('click', ()=> closeModal(businessModal));
    btnAddContact.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business first');
      const b = findBiz(selectedBizId);
      const name = (newContactName.value||'').trim(); if(!name) return alert('Contact name required');
      b.contacts = b.contacts || [];
      b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } });
      saveState(); renderBizContacts(b);
    });

    txnWht.addEventListener('change', ()=> {
      const show = txnWht.checked;
      txnWhtRateLabel.style.display = show ? 'inline-flex' : 'none';
      txnWhtBasisLabel.style.display = show ? 'inline-flex' : 'none';
    });

    btnAddTxn.addEventListener('click', addTransaction);
    document.getElementById('btnSearch').addEventListener('click', renderLedger);
    document.getElementById('btnClearSearch').addEventListener('click', ()=> { document.getElementById('ledgerSearch').value=''; renderLedger(); });

    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; btnLedgerTab.classList.add('active'); btnReportsTab.classList.remove('active'); ledgerSection.style.display='block'; reportsSection.style.display='none'; });
    btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; btnReportsTab.classList.add('active'); btnLedgerTab.classList.remove('active'); ledgerSection.style.display='none'; reportsSection.style.display='block'; renderReport(activeReport); });

    reportTabButtons.forEach(but => { but.addEventListener('click',(e)=> { reportTabButtons.forEach(bb=>bb.classList.remove('active')); but.classList.add('active'); activeReport = but.dataset.report; renderReport(activeReport); }); });

    btnExport.addEventListener('click', ()=> {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc-export.json'; a.click();
      URL.revokeObjectURL(url);
    });
    btnImport.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){ try { state = JSON.parse(ev.target.result); migrateState(); renderAll(); alert('Import successful'); } catch(err){ alert('Import failed: '+err.message); } };
      reader.readAsText(f);
    });
    btnClearAll.addEventListener('click', ()=> { if(!confirm('Clear all data?')) return; localStorage.removeItem(STORAGE_KEY); location.reload(); });
    document.getElementById('btnExportLedger').addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const payload = gatherAllTransactionsForBiz(selectedBizId);
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ledger-'+selectedBizId+'.json'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('btnClearLedger').addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      if(!confirm('Clear all transactions for selected business?')) return;
      for(const u of state.users){ if(state.transactions[u.id]) state.transactions[u.id][selectedBizId] = []; }
      saveState(); renderAll();
    });

    userSelect.addEventListener('change', ()=> { selectedUserId = userSelect.value; state.auth.currentUserId = selectedUserId; saveState(); refreshSelectors(); renderAll(); });
    businessSelect.addEventListener('change', ()=> { selectedBizId = businessSelect.value; saveState(); populateAccountSelect(); renderAll(); });
  }

  function deleteBusiness(id){
    state.businesses = state.businesses.filter(b=>b.id!==id);
    for(const u of state.users) if(state.transactions[u.id]) delete state.transactions[u.id][id];
    if(selectedBizId === id) selectedBizId = state.businesses[0] ? state.businesses[0].id : null;
    saveState(); refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll();
  }

  function refreshSelectors(){
    // users
    userSelect.innerHTML=''; state.users.forEach(u=> { const opt = document.createElement('option'); opt.value=u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); });
    if(!state.auth.currentUserId && state.users[0]) state.auth.currentUserId = state.users[0].id;
    selectedUserId = state.auth.currentUserId;
    userSelect.value = selectedUserId || '';
    // businesses
    businessSelect.innerHTML=''; state.businesses.forEach(b=> { const opt = document.createElement('option'); opt.value=b.id; opt.textContent = b.name; businessSelect.appendChild(opt); });
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    businessSelect.value = selectedBizId || '';
    // biz owner select
    bizOwnerSelect.innerHTML=''; state.users.forEach(u=> { const opt = document.createElement('option'); opt.value=u.id; opt.textContent = u.display || u.username; bizOwnerSelect.appendChild(opt); });
    // auth info
    document.getElementById('authInfo').textContent = (state.users.find(u=>u.id===state.auth.currentUserId)||{}).display || '';
  }

  function ensureSelection(){
    if(!selectedUserId && state.users[0]) selectedUserId = state.users[0].id;
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    if(!state.transactions[selectedUserId]) state.transactions[selectedUserId] = {};
    for(const b of state.businesses){ for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || []; } }
  }

  function populateAccountSelect(){
    txnAccount.innerHTML = '';
    assetListDiv.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of b.accounts){ const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name; txnAccount.appendChild(opt); }
    renderBizContacts(b);
  }

  function renderBizContacts(b){
    bizContactsList.innerHTML = '';
    if(!b) return;
    b.contacts = b.contacts || [];
    for(const c of b.contacts){
      const div = document.createElement('div'); div.className='account-row';
      div.innerHTML = `<div><strong>${c.name}</strong> — <span class="small-muted">${c.type}</span><div class="small-muted">Pension:${fmt(c.statutory?.pension||0)} Rent:${fmt(c.statutory?.rent||0)}</div></div>
        <div><button class="small" data-id="${c.id}">Edit</button></div>`;
      bizContactsList.appendChild(div);
    }
  }

  function findBiz(id){ return state.businesses.find(b=>b.id===id); }

  function gatherAllTransactionsForBiz(bizId){
    const out = [];
    for(const u of state.users){
      const arr = state.transactions[u.id] && state.transactions[u.id][bizId];
      if(arr && arr.length) for(const t of arr) out.push(clone(t));
    }
    return out;
  }

  function resetForms(){
    txnDate.value = today();
    txnAction.value = '';
    txnAccount.innerHTML = '';
    txnDesc.value=''; txnAmount.value=''; txnVatType.value='none'; txnWht.checked=false; txnWhtRate.value=''; txnWhtBasis.value='gross'; txnSalary.checked=false; txnContact.value='';
  }

  // core add transaction (keeps simple for this feature set)
  function addTransaction(){
    if(!selectedBizId) return alert('Select a business');
    if(!selectedUserId) return alert('Select a user');
    const b = findBiz(selectedBizId);
    const action = txnAction.value || 'Expense';
    const accountId = txnAccount.value || (b.accounts[0] && b.accounts[0].id);
    const date = txnDate.value || today();
    const amount = Number(txnAmount.value || 0);
    if(!amount) return alert('Amount required');
    const desc = txnDesc.value || '';
    const vatType = txnVatType.value || 'none';
    const whtApplied = !!txnWht.checked;
    const whtRate = whtApplied ? (Number(txnWhtRate.value) || b.whtRate || DEFAULTS.whtRate) : 0;
    const whtBasis = txnWhtBasis.value || 'gross';
    const paye = !!txnSalary.checked && action === 'Salary';
    const contact = (txnContact.value||'').trim();

    // compute VAT amount (approx)
    let vatAmount = 0;
    if(vatType === 'inclusive'){ vatAmount = amount * (b.vatRate / (100 + b.vatRate)); }
    else if(vatType === 'exclusive'){ vatAmount = amount * (b.vatRate/100); }

    // compute WHT amount if applied
    let whtAmount = 0;
    if(whtApplied){
      const base = (whtBasis === 'net') ? Math.max(0, amount - vatAmount) : amount;
      whtAmount = base * (whtRate/100);
    }

    // compute PAYE withheld for salary txn (we do not change ledger accounts automatically here, just store computed withheld amount)
    let payeWithheld = 0;
    if(paye){
      // find statutory annual deductions for contact if exists, else business defaults
      const contactObj = (b.contacts || []).find(c => c.name === contact);
      const statutory = contactObj ? (contactObj.statutory || {}) : b.statutoryDeductions || {};
      // Note: the user requested that annual PAYE be computed using PAYE_BANDS applied to taxable annual income.
      // When a salary transaction is recorded we assume the amount is an annual salary if large; however common case is monthly payments.
      // He requested PAYE per contact using annual salary = sum of salary txns for the year. For a single txn we store payeWithheld=0 for now,
      // and the PAYE report will compute annual and monthly values based on aggregated salary transactions.
      payeWithheld = 0;
    }

    const txn = {
      id: uid('txn'),
      date, action, accountId, desc, amount, vatType, vatAmount, whtApplied, whtRate, whtBasis, whtAmount, paye, payeWithheld,
      contact, createdBy: selectedUserId, createdAt: new Date().toISOString()
    };

    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(txn);
    addAudit('txn.add','transaction',txn.id, `Added txn ${txn.id} (${action})`);
    saveState();
    resetForms();
    renderAll();
  }

  // calculation utilities
  function computeWHTTotalsForBiz(bizId){
    const txns = gatherAllTransactionsForBiz(bizId);
    let payable = 0, receivable = 0;
    const details = [];
    for(const t of txns){
      if(!t.whtApplied) continue;
      // classify outgoing vs incoming by action
      if(OUTGOING_ACTIONS.includes(t.action)){
        payable += Number(t.whtAmount || 0);
      } else if(INCOMING_ACTIONS.includes(t.action)){
        receivable += Number(t.whtAmount || 0);
      } else {
        // For other actions, try to infer: Expense/BankPayment are outgoing, Revenue/BankReceipt incoming.
        if(t.action === 'Expense' || t.action === 'BankPayment') payable += Number(t.whtAmount || 0);
        else if(t.action === 'Revenue' || t.action === 'BankReceipt') receivable += Number(t.whtAmount || 0);
        else {
          // store as detail but don't include in totals
        }
      }
      details.push(t);
    }
    return { payable, receivable, details };
  }

  // compute tax using PAYE_BANDS (progressive marginal)
  function computeTaxFromBands(income, bands = PAYE_BANDS){
    if(!isFinite(Number(income)) || income <= 0) return 0;
    let remaining = Number(income);
    let tax = 0;
    let lower = 0;
    for(const b of bands){
      const upper = b.upTo;
      const taxableAtBand = Math.min(remaining, upper - lower);
      if(taxableAtBand > 0){
        tax += taxableAtBand * b.rate;
        remaining -= taxableAtBand;
      }
      lower = upper;
      if(remaining <= 0) break;
    }
    return tax;
  }

  // compute PAYE per contact for selected business
  // returns array of { contactName, contactType, grossAnnual, statutoryDeductionsAnnual, taxableAnnual, annualPAYE, monthlyPAYE, ytdWithheld }
  function computePAYEForBiz(bizId, year=null){
    const b = findBiz(bizId);
    if(!b) return [];
    const txns = gatherAllTransactionsForBiz(bizId);
    year = year || new Date().getFullYear();
    // group salaries per contact: sum amounts within the calendar year
    const salaries = {};
    for(const t of txns){
      if(t.action === 'Salary' && t.paye){
        const tYear = new Date(t.date).getFullYear();
        if(tYear !== Number(year)) continue;
        const cname = (t.contact || ''); // match by name
        salaries[cname] = salaries[cname] || { grossAnnual:0, txns:[] };
        salaries[cname].grossAnnual += Number(t.amount || 0);
        salaries[cname].txns.push(t);
      }
    }

    const results = [];
    for(const name of Object.keys(salaries)){
      const grossAnnual = salaries[name].grossAnnual;
      // find contact object
      const contactObj = (b.contacts || []).find(c => c.name === name);
      // only compute for Employee contacts as requested
      const cType = contactObj ? contactObj.type : 'Unknown';
      if(cType !== 'Employee' && cType !== 'SoleTrader') {
        // skip non-employees for PAYE; but include employees only
        if(cType !== 'Employee') continue;
      }
      // statutory deductions: contact override else business defaults
      const statutory = contactObj ? (contactObj.statutory || {}) : b.statutoryDeductions || {};
      const statutoryTotal = Number(statutory.pension||0) + Number(statutory.rent||0) + Number(statutory.life||0) + Number(statutory.mortgage||0) + Number(statutory.nhf||0);
      const taxableAnnual = Math.max(0, grossAnnual - statutoryTotal);
      const annualPAYE = computeTaxFromBands(taxableAnnual, PAYE_BANDS);
      const monthlyPAYE = annualPAYE / 12;
      // cumulative YTD: sum of withheld amounts (if payeWithheld present) else approximate by counting salary txns and summing monthlyPAYE * number of distinct months present
      let ytdWithheld = 0;
      const monthsSeen = new Set();
      for(const tx of salaries[name].txns){
        if(Number(tx.payeWithheld) && tx.payeWithheld>0) ytdWithheld += Number(tx.payeWithheld);
        else {
          const mm = new Date(tx.date).getMonth() + 1;
          const yyyy = new Date(tx.date).getFullYear();
          monthsSeen.add(`${yyyy}-${mm}`);
        }
      }
      // for months without explicit withheld amounts, approximate by monthlyPAYE per distinct month
      ytdWithheld += monthsSeen.size * monthlyPAYE;
      results.push({ contactName: name, contactType: cType, grossAnnual, statutoryDeductionsAnnual: statutoryTotal, taxableAnnual, annualPAYE, monthlyPAYE, ytdWithheld: Number(ytdWithheld) });
    }
    // sort by contact name
    results.sort((a,b2)=> a.contactName.localeCompare(b2.contactName));
    return results;
  }

  // compute PIT for sole proprietors: taxable profit for business then apply PAYE_BANDS (requested reuse)
  function computePITForSoleProprietor(bizId, year=null){
    const b = findBiz(bizId);
    if(!b) return null;
    if(b.entity !== 'SoleProprietor') return null;
    year = year || new Date().getFullYear();
    // crude taxable profit calculation: revenue - allowable expenses (exclude disallowable or non-taxable handling for simplicity)
    const txns = gatherAllTransactionsForBiz(bizId);
    let revenue = 0, expenses = 0;
    for(const t of txns){
      const tYear = new Date(t.date).getFullYear();
      if(tYear !== Number(year)) continue;
      if(INCOMING_ACTIONS.includes(t.action) || t.action === 'Revenue') revenue += Number(t.amount || 0);
      if(OUTGOING_ACTIONS.includes(t.action) || t.action === 'Expense') expenses += Number(t.amount || 0);
    }
    // approximate taxable profit
    const taxableProfit = Math.max(0, revenue - expenses);
    const pitAnnual = computeTaxFromBands(taxableProfit, PAYE_BANDS);
    const monthly = pitAnnual / 12;
    return { revenue, expenses, taxableProfit, pitAnnual, monthly };
  }

  // rendering
  function renderLedger(){
    ledgerTableBody.innerHTML = '';
    if(!selectedBizId) return;
    const search = (document.getElementById('ledgerSearch').value||'').toLowerCase();
    const txns = gatherAllTransactionsForBiz(selectedBizId);
    const b = findBiz(selectedBizId);
    for(const t of txns){
      if(search){
        const hay = `${t.date} ${t.action} ${t.desc || ''} ${t.amount} ${t.contact || ''}`.toLowerCase();
        if(!hay.includes(search)) continue;
      }
      const acctName = (b.accounts.find(a=>a.id===t.accountId)||{}).name || '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.date}</td><td>${t.action}</td><td>${acctName}</td><td>${t.desc||''}</td>
        <td>₦${fmt(t.amount)}</td><td>${t.vatAmount?('₦'+fmt(t.vatAmount)):'-'}</td>
        <td>${t.whtApplied?('₦'+fmt(t.whtAmount)):'-'}</td><td>${t.paye?('computed'):'-'}</td><td>${t.contact||''}</td><td></td>`;
      ledgerTableBody.appendChild(tr);
    }
    renderTaxSummary();
  }

  function renderTaxSummary(){
    taxSummaryDiv.innerHTML = '';
    if(!selectedBizId) return;
    const b = findBiz(selectedBizId);
    const wht = computeWHTTotalsForBiz(selectedBizId);
    const payeArr = computePAYEForBiz(selectedBizId);
    const totalAnnualPAYE = payeArr.reduce((s,r)=>s + (Number(r.annualPAYE)||0),0);
    const totalMonthlyPAYE = totalAnnualPAYE/12;
    // PIT (if sole proprietor)
    const pit = computePITForSoleProprietor(selectedBizId);

    let html = `<h4 style="margin:2px 0">Tax Summary — ${b.name}</h4>`;
    html += `<div class="summary-line"><div>WHT payable (on your payments)</div><div><strong>₦${fmt(wht.payable)}</strong></div></div>`;
    html += `<div class="summary-line"><div>WHT receivable (on amounts you received)</div><div><strong>₦${fmt(wht.receivable)}</strong></div></div>`;
    html += `<div class="summary-line"><div>Total annual PAYE (computed from salary txns)</div><div><strong>₦${fmt(totalAnnualPAYE)}</strong></div></div>`;
    html += `<div class="summary-line"><div>Estimated monthly PAYE (annual / 12)</div><div><strong>₦${fmt(totalMonthlyPAYE)}</strong></div></div>`;
    if(pit){
      html += `<div class="summary-line" style="margin-top:6px;"><div>PIT (Sole Proprietor) — Taxable profit</div><div><strong>₦${fmt(pit.pitAnnual)}</strong></div></div>`;
      html += `<div class="small-muted" style="margin-top:6px;">Revenue: ₦${fmt(pit.revenue)} • Expenses: ₦${fmt(pit.expenses)} • Taxable profit: ₦${fmt(pit.taxableProfit)}</div>`;
    }
    taxSummaryDiv.innerHTML = html;
  }

  function renderAll(){
    refreshSelectors();
    populateAccountSelect();
    renderLedger();
    renderBizQuickSnapshots();
    if(activeTab === 'reports') renderReport(activeReport);
  }

  function renderBizQuickSnapshots(){
    // quick P&L snapshot and lists
    plSnapshotQuick.innerHTML = '';
    inventoryListDiv.innerHTML = '';
    assetListDiv.innerHTML = '';
    if(!selectedBizId) return;
    const b = findBiz(selectedBizId);
    // inventory
    if(b.inventory && b.inventory.length){
      let out = '<table class="small-table"><thead><tr><th>Item</th><th>Qty</th><th>Avg cost</th></tr></thead><tbody>';
      for(const it of b.inventory) out += `<tr><td>${it.name}</td><td>${it.qty}</td><td>₦${fmt(it.avgCost)}</td></tr>`;
      out += '</tbody></table>';
      inventoryListDiv.innerHTML = out;
    } else inventoryListDiv.innerHTML = '<div class="small-muted">No inventory</div>';
    // assets
    assetListDiv.innerHTML = (b.assets && b.assets.length) ? b.assets.map(a=>`<div><strong>${a.name}</strong> — Cost: ₦${fmt(a.cost)}</div>`).join('') : '<div class="small-muted">No fixed assets</div>';

    // P&L snapshot (simple)
    const txns = gatherAllTransactionsForBiz(selectedBizId);
    let revenue=0, expenses=0;
    for(const t of txns){
      if(INCOMING_ACTIONS.includes(t.action) || t.action === 'Revenue') revenue += Number(t.amount||0);
      if(OUTGOING_ACTIONS.includes(t.action) || t.action === 'Expense') expenses += Number(t.amount||0);
    }
    plSnapshotQuick.innerHTML = `<div><strong>Revenue:</strong> ₦${fmt(revenue)}</div><div><strong>Expenses:</strong> ₦${fmt(expenses)}</div><div style="margin-top:6px;"><strong>Net:</strong> ₦${fmt(revenue - expenses)}</div>`;
  }

  // REPORTS
  function renderReport(reportKey){
    reportContent.innerHTML = '';
    if(!selectedBizId) return reportContent.innerHTML = '<div class="small-muted">Select a business to view reports</div>';
    if(reportKey === 'whtPayable'){
      renderWHTReport();
    } else if(reportKey === 'payeReport'){
      renderPAYEReport();
    } else if(reportKey === 'taxReconciliation'){
      renderTaxReconciliation();
    } else if(reportKey === 'vatReport'){
      renderVATReport();
    } else if(reportKey === 'auditTrail'){
      renderAuditTrail();
    } else {
      reportContent.innerHTML = `<div class="small-muted">Report "${reportKey}" not implemented in this view.</div>`;
    }
  }

  function renderWHTReport(){
    const b = findBiz(selectedBizId);
    const w = computeWHTTotalsForBiz(selectedBizId);
    let html = `<h3>WHT Report — ${b.name}</h3>`;
    html += `<div class="summary-line"><div>WHT payable (on your payments)</div><div><strong>₦${fmt(w.payable)}</strong></div></div>`;
    html += `<div class="summary-line"><div>WHT receivable (on what you received)</div><div><strong>₦${fmt(w.receivable)}</strong></div></div>`;
    html += `<div style="margin-top:8px;"><h4>WHT transaction details</h4>`;
    if(w.details.length === 0) html += '<div class="small-muted">No WHT transactions recorded for this business.</div>';
    else {
      html += '<table class="small-table"><thead><tr><th>Date</th><th>Action</th><th>Contact</th><th>Amount</th><th>WHT Rate</th><th>WHT Amount</th></tr></thead><tbody>';
      for(const t of w.details){
        html += `<tr><td>${t.date}</td><td>${t.action}</td><td>${t.contact||''}</td><td>₦${fmt(t.amount)}</td><td>${fmt(t.whtRate)}%</td><td>₦${fmt(t.whtAmount)}</td></tr>`;
      }
      html += '</tbody></table>';
    }
    html += '</div>';
    reportContent.innerHTML = html;
  }

  function renderPAYEReport(){
    const b = findBiz(selectedBizId);
    const year = new Date().getFullYear();
    const paye = computePAYEForBiz(selectedBizId, year);
    let html = `<h3>PAYE Report — ${b.name} (Year ${year})</h3>`;
    if(paye.length === 0) html += '<div class="small-muted">No PAYE-applicable salary transactions for employees found.</div>';
    else {
      html += `<table class="small-table"><thead><tr><th>Contact</th><th>Type</th><th>Gross annual salary</th><th>Statutory deductions (annual)</th><th>Taxable annual</th><th>Annual PAYE</th><th>Monthly PAYE</th><th>YTD withheld (approx)</th></tr></thead><tbody>`;
      for(const r of paye){
        html += `<tr>
          <td>${r.contactName}</td>
          <td>${r.contactType}</td>
          <td>₦${fmt(r.grossAnnual)}</td>
          <td>₦${fmt(r.statutoryDeductionsAnnual)}</td>
          <td>₦${fmt(r.taxableAnnual)}</td>
          <td>₦${fmt(r.annualPAYE)}</td>
          <td>₦${fmt(r.monthlyPAYE)}</td>
          <td>₦${fmt(r.ytdWithheld)}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      const totalAnnual = paye.reduce((s,r)=>s + (Number(r.annualPAYE)||0),0);
      const totalMonthly = totalAnnual / 12;
      html += `<div style="margin-top:8px;" class="summary-line"><div><strong>Totals</strong></div><div><strong>Annual PAYE: ₦${fmt(totalAnnual)} • Monthly est: ₦${fmt(totalMonthly)}</strong></div></div>`;
    }
    reportContent.innerHTML = html;
  }

  function renderTaxReconciliation(){
    const b = findBiz(selectedBizId);
    let html = `<h3>Taxable Income Reconciliation — ${b.name}</h3>`;
    // For simplicity show revenue, expenses, taxable profit (basic)
    const txns = gatherAllTransactionsForBiz(selectedBizId);
    let revenue=0, expenses=0;
    for(const t of txns){
      if(INCOMING_ACTIONS.includes(t.action) || t.action === 'Revenue') revenue += Number(t.amount||0);
      if(OUTGOING_ACTIONS.includes(t.action) || t.action === 'Expense') expenses += Number(t.amount||0);
    }
    const taxableProfit = Math.max(0, revenue - expenses);
    html += `<div class="summary-line"><div>Revenue</div><div>₦${fmt(revenue)}</div></div>`;
    html += `<div class="summary-line"><div>Expenses (allowed)</div><div>₦${fmt(expenses)}</div></div>`;
    html += `<div class="summary-line"><div>Taxable profit</div><div><strong>₦${fmt(taxableProfit)}</strong></div></div>`;
    // PIT if sole proprietor
    const pit = computePITForSoleProprietor(selectedBizId);
    if(pit){
      html += `<div style="margin-top:8px;" class="summary-line"><div>PIT computed using PAYE bands</div><div><strong>₦${fmt(pit.pitAnnual)}</strong></div></div>`;
    }
    reportContent.innerHTML = html;
  }

  function renderVATReport(){
    const b = findBiz(selectedBizId);
    const txns = gatherAllTransactionsForBiz(selectedBizId);
    let collected=0, paid=0;
    const details = [];
    for(const t of txns){
      if(t.vatType && t.vatType !== 'none' && t.vatAmount){
        if(INCOMING_ACTIONS.includes(t.action) || t.action === 'Revenue') collected += Number(t.vatAmount||0);
        if(OUTGOING_ACTIONS.includes(t.action) || t.action === 'Expense') paid += Number(t.vatAmount||0);
        details.push(t);
      }
    }
    let html = `<h3>VAT Report — ${b.name}</h3>`;
    html += `<div class="summary-line"><div>VAT collected on sales</div><div>₦${fmt(collected)}</div></div>`;
    html += `<div class="summary-line"><div>VAT paid on purchases</div><div>₦${fmt(paid)}</div></div>`;
    html += `<div class="summary-line"><div>Net VAT (collected - paid)</div><div><strong>₦${fmt(collected - paid)}</strong></div></div>`;
    reportContent.innerHTML = html;
  }

  function renderAuditTrail(){
    let html = `<h3>Audit Trail</h3>`;
    html += '<div style="max-height:320px; overflow:auto;"><table class="small-table"><thead><tr><th>Time</th><th>User</th><th>Type</th><th>Details</th></tr></thead><tbody>';
    for(const a of (state.audit||[]).slice().reverse()){
      const user = state.users.find(u=>u.id===a.userId) || {};
      html += `<tr><td>${a.timestamp}</td><td>${user.display||user.username||''}</td><td>${a.type}</td><td>${a.details}</td></tr>`;
    }
    html += '</tbody></table></div>';
    reportContent.innerHTML = html;
  }

  // initial helpers
  function populateAccountSelectOnLoad(){
    populateAccountSelect();
  }

  // initial calls
  function populateAccountSelect(){ populateAccountSelectOnLoad(); }

  // render ledger at start
  renderAll();

  // expose small helpers to console for debugging
  window.__ntc = { state, computeWHTTotalsForBiz, computePAYEForBiz, computePITForSoleProprietor, gatherAllTransactionsForBiz };

  </script>
</body>
  </html>
