<!-- GitHub Copilot Chat Assistant -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Accounting & Tax — Full Index (VAT, WHT, PAYE, PIT & CIT)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; --panel:#fff; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.15rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.95rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary, .wht-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(720px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} .grid-2{grid-template-columns:1fr} }
    pre.small { font-size:0.85rem; white-space:pre-wrap; }
    .nowrap { white-space:nowrap; }
    table.paye-table { width:100%; border-collapse:collapse; margin-top:8px; }
    table.paye-table th, table.paye-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; background:#fff; }
    table.paye-table th { background:#f5f8fb; }
    .muted-inline { color:var(--muted); font-size:0.9rem; margin-left:8px; }
    .inline-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:start; }
    .field { display:flex; flex-direction:column; gap:4px; }
    .result-box { background:#fff; padding:10px; border:1px solid #eef2f6; border-radius:6px; margin-top:8px; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .small-note{font-size:0.88rem;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax — Full</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>
        <button class="small" id="btnAddAccountInline">+ Account</button>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="whtInlineLabel" style="display:none;">
          <input type="checkbox" id="txnWhtEnabled" /> Withhold WHT
        </label>
        <label id="whtRateInlineLabel" style="display:none;">
          WHT rate (%): <input type="number" id="txnWhtRate" min="0" step="0.01" value="5" style="width:70px;" />
        </label>
        <label id="whtInclusiveLabel" style="display:none;">
          <input type="checkbox" id="txnWhtInclusive" /> Amount includes WHT
        </label>

        <label>Contact:
          <select id="txnContact"></select>
        </label>
        <button class="small" id="btnAddContactInline">+ Contact</button>

        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved at the business level. VAT is calculated for sales (Revenue) and for purchases only (not all expenses). WHT (Withholding Tax) applies for qualifying expenses.</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/description/amount/author/contact/account" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable" aria-live="polite">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Account</th>
            <th>Amount (₦)</th>
            <th>VAT (₦)</th>
            <th>WHT (₦)</th>
            <th>Contact</th>
            <th>Author</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="wht-summary" id="whtSummary"></div>
      <div class="paye-summary totals" id="payeSummary" style="margin-top:10px;"></div>
      <div class="pit-summary totals" id="pitSummary" style="margin-top:10px;"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section" id="contactsAccountsPanel" style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:280px;">
        <h3>Contacts</h3>
        <div class="form-inline" style="margin-bottom:8px;">
          <button class="small" id="btnOpenContacts">Manage Contacts</button>
        </div>
        <div id="contactsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
      </div>
      <div style="flex:1;min-width:280px;">
        <h3>Chart of Accounts</h3>
        <div class="form-inline" style="margin-bottom:8px;">
          <button class="small" id="btnOpenAccounts">Manage Accounts</button>
        </div>
        <div id="accountsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
      </div>
    </section>

    <!-- Tax calculators and taxable-from-netprofit -->
    <section class="panel section" id="taxPanels">
      <div class="grid-2">
        <div>
          <h2 style="margin:0 0 8px 0;">Taxable Income — From Net profit A</h2>
          <div class="inline-grid">
            <div class="field">
              <label>Net profit A (₦): <input type="number" id="netProfitA" step="0.01" /></label>
              <small class="muted small-note">Accounting net profit (profit after operating items)</small>
            </div>
            <div class="field">
              <label>Disallowable expenses to add back (₦): <input type="number" id="disallowable" step="0.01" /></label>
              <small class="muted small-note">Non-deductible expenses for tax purposes</small>
            </div>

            <div class="field">
              <label>Non-taxable income (₦): <input type="number" id="nonTaxableIncome" step="0.01" /></label>
              <small class="muted small-note">Tax-exempt income to remove</small>
            </div>
            <div class="field">
              <label>Capital allowances (₦): <input type="number" id="capitalAllowances" step="0.01" /></label>
              <small class="muted small-note">Tax depreciation allowances</small>
            </div>

            <div class="field">
              <label>Prior unrelieved losses (₦): <input type="number" id="priorLosses" step="0.01" /></label>
              <small class="muted small-note">Losses carried forward</small>
            </div>
            <div class="field">
              <label>Other adjustments (₦): <input type="number" id="otherAdjustments" step="0.01" /></label>
              <small class="muted small-note">Any other tax adjustments (positive reduces tax base when negative increases)</small>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
            <button class="primary" id="btnComputeTaxable">Compute Taxable Income</button>
            <button id="btnClearTaxAdj" class="small">Clear</button>
          </div>

          <div id="taxableResult" class="result-box" aria-live="polite" style="display:none;">
            <div><strong>Taxable income:</strong> ₦<span id="taxableResultValue">0</span></div>
            <div style="margin-top:8px;" id="taxableBreakdown"></div>
          </div>
          <small class="muted">Formula: Taxable income = Net profit A + Disallowable expenses - Non-taxable income - Capital allowances - Prior losses + Other adjustments</small>
        </div>

        <div>
          <h2 style="margin:0 0 8px 0;">PIT & CIT Calculators</h2>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap;">
            <label for="taxableInput">Taxable income for tax calculations (₦):</label>
            <input type="number" id="taxableInput" step="0.01" value="50000000" style="width:220px" />
            <button class="primary" id="btnCompute">Compute Taxes</button>
            <button id="btnExample" class="small">Sample: ₦50,000,000</button>
            <button id="btnClear" class="small">Clear</button>
          </div>

          <div class="result-box">
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <div style="flex:1;min-width:260px;">
                <h3 style="margin:6px 0">Personal Income Tax (PIT)</h3>
                <div class="muted small-note">PIT uses tax-free threshold and progressive bands (default threshold ₦800,000).</div>
                <div style="margin-top:8px;">
                  <div><strong>Annual PIT:</strong> ₦<span id="pitAnnual">0</span></div>
                  <div><strong>Monthly PAYE (approx):</strong> ₦<span id="pitMonthly">0</span></div>
                  <div style="margin-top:8px;"><strong>Breakdown by band</strong></div>
                  <div id="pitBands" style="margin-top:6px;font-family:monospace"></div>
                </div>
              </div>

              <div style="flex:1;min-width:260px;">
                <h3 style="margin:6px 0">Company Income Tax (CIT)</h3>
                <div class="muted small-note">CIT rule implemented: 0% on first ₦50,000,000; 25% on amounts above ₦50,000,000.</div>
                <div style="margin-top:8px;">
                  <div><strong>Taxable base for CIT:</strong> ₦<span id="citBase">0</span></div>
                  <div style="margin-top:6px"><strong>0% portion (₦0 - ₦50,000,000):</strong> ₦<span id="citZeroPortion">0</span></div>
                  <div><strong>25% portion (excess over ₦50,000,000):</strong> ₦<span id="citExcessPortion">0</span></div>
                  <div style="margin-top:8px"><strong>Annual CIT due:</strong> ₦<span id="citAnnual">0</span></div>
                  <div><strong>Effective CIT rate:</strong> <span id="citEffective">0%</span></div>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top:10px" class="muted small-note">You can paste taxable income from the "Taxable income — From Net profit A" panel above into the taxable input box and compute.</div>
        </div>
      </div>
    </section>

  </main>

  <!-- Modals (users/business/contacts/accounts/edit) -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" value="7.5" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" checked /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" checked /> Enable PIT (tax)</label>
      <label><input type="checkbox" id="bizVatInclusive" /> VAT amounts are inclusive</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizWhtEnabled" checked /> Auto-create WHT Payable account</label>
      <label>WHT account code: <input type="text" id="bizWhtCode" value="2300" style="width:90px" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <div id="contactModal" class="modal" aria-hidden="true">
    <h3 id="contactModalTitle">Add Contact</h3>
    <div class="row">
      <label>Name: <input type="text" id="contactName" /></label>
      <label>Type:
        <select id="contactType">
          <option value="Customer">Customer</option>
          <option value="Vendor">Vendor</option>
          <option value="Employee">Employee</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Phone/Email: <input type="text" id="contactInfo" placeholder="Phone or email" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="contactCancel">Cancel</button>
      <button class="primary" id="contactSave">Save</button>
    </div>
  </div>

  <div id="accountModal" class="modal" aria-hidden="true">
    <h3 id="accountModalTitle">Add Account</h3>
    <div class="row">
      <label>Code: <input type="text" id="accountCode" placeholder="e.g. 4000" /></label>
      <label>Name: <input type="text" id="accountName" placeholder="Account name" /></label>
    </div>
    <div class="row">
      <label>Type:
        <select id="accountType">
          <option value="Asset">Asset</option>
          <option value="Liability">Liability</option>
          <option value="Equity">Equity</option>
          <option value="Revenue">Revenue</option>
          <option value="Expense">Expense/Deductions</option>
        </select>
      </label>
      <label>Notes: <input type="text" id="accountNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="accountIsSalary" /> Salary/Payroll account (include in gross)</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="accountCancel">Cancel</button>
      <button class="primary" id="accountSave">Save</button>
    </div>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>

    <label>Account:
      <select id="editTxnAccount"></select>
    </label><br/>

    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>

    <label id="editWhtLabel" style="display:none;">
      <input type="checkbox" id="editTxnWhtEnabled" /> Withhold WHT
    </label><br/>
    <label id="editWhtRateLabel" style="display:none;">
      WHT rate (%): <input type="number" id="editTxnWhtRate" min="0" step="0.01" value="5" style="width:70px;" />
    </label><br/>
    <label id="editWhtInclusiveLabel" style="display:none;">
      <input type="checkbox" id="editTxnWhtInclusive" /> Amount includes WHT
    </label><br/>

    <label>Contact:
      <select id="editTxnContact"></select>
    </label><br/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="editCancel">Cancel</button>
      <button class="primary" id="editSave">Save</button>
    </div>
  </div>

  <script>
    // Full single-file implementation combining ledger, VAT, WHT, PAYE, PIT and CIT calculators
    (function(){
      const STORAGE_KEY = 'ntc_full_data_v1';
      const DEFAULT_PIT = {
        threshold: 800000,
        slices: [
          { upTo: 3000000, rate: 0.15 },
          { upTo: 12000000, rate: 0.18 },
          { upTo: 25000000, rate: 0.21 },
          { upTo: 50000000, rate: 0.23 },
          { upTo: Infinity, rate: 0.25 }
        ]
      };

      const DEFAULT_DEDUCTION_KEYWORDS = ['rent','pension','nhf','nhis','life assurance','interest on loan for owner occupied house','interest','owner occupied'];

      // CIT rule (user requested): 0% up to 50,000,000; 25% on excess
      const CIT_ZERO_THRESHOLD = 50000000;
      const CIT_EXCESS_RATE = 0.25;

      let data = { users: [], businesses: [], transactions: {} };
      let selectedUserId = null, selectedBusinessId = null;
      let editTxnId = null, editTxnBizId = null;

      const PAGE_SIZE = 20;
      let currentPage = 1;
      let ledgerFilterText = '';

      function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
      function formatMoney(v){
        const n = Number(v) || 0;
        const opts = { maximumFractionDigits:2, minimumFractionDigits: Number(n) % 1 === 0 ? 0 : 2 };
        return n.toLocaleString('en-NG', opts);
      }
      function escapeHtml(s){ if (s === undefined || s === null) return ''; return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
      function saveData(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){ console.error('Save failed', e); } }

      function ensureBizWhtAccount(b){
        if (!b) return;
        if (!Array.isArray(b.accounts)) b.accounts = [];
        if (!b.whtAccountId && !!b.whtAutoCreate) {
          const exists = b.accounts.find(a => (a.code && String(a.code) === String(b.whtCode || '2300')) && a.name === 'WHT Payable');
          if (exists) b.whtAccountId = exists.id;
          else {
            const acc = { id: uid('a'), code: (b.whtCode || '2300'), name: 'WHT Payable', type: 'Liability', notes: 'Auto-created for withheld tax', isSalary: false };
            b.accounts.push(acc);
            b.whtAccountId = acc.id;
          }
        }
      }

      function loadData(){
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw){
          try {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object'){
              data = parsed;
              data.businesses = (data.businesses || []).map(b=>{
                if (!Array.isArray(b.members)) b.members = [];
                if (!Array.isArray(b.contacts)) b.contacts = [];
                if (!Array.isArray(b.accounts)) b.accounts = [];
                b.accounts = b.accounts.map(a => ({ ...a, isSalary: !!a.isSalary }));
                if (typeof b.vatRate !== 'number') b.vatRate = 7.5;
                if (typeof b.vatEnabled === 'undefined') b.vatEnabled = true;
                if (typeof b.pitEnabled === 'undefined') b.pitEnabled = true;
                if (!b.pit) b.pit = DEFAULT_PIT;
                if (typeof b.whtAutoCreate === 'undefined') b.whtAutoCreate = true;
                if (!b.whtCode) b.whtCode = '2300';
                if (typeof b.vatInclusive === 'undefined') b.vatInclusive = false;
                ensureBizWhtAccount(b);
                return b;
              });
              if (!data.transactions) data.transactions = {};
              return;
            }
          } catch(e){ console.error('Invalid saved data', e); }
        }

        // seed demo data
        const userId = uid('user');
        const bizId = uid('biz');
        const whtAccountId = uid('a_wht');
        const contact1 = { id: uid('c'), name: 'ACME Co', type: 'Customer', info: 'acme@example.com', notes: '' };
        const contact2 = { id: uid('c'), name: 'Office Supplies Ltd', type: 'Vendor', info: '0803-xxx', notes: '' };
        const contact3 = { id: uid('c'), name: 'John Employee', type: 'Employee', info: 'john@demo', notes: '' };
        const accounts = [
          { id: uid('a'), code: '1000', name: 'Cash', type: 'Asset', notes: '', isSalary: false },
          { id: uid('a2'), code: '2000', name: 'Accounts Payable', type: 'Liability', notes: '', isSalary: false },
          { id: uid('a3'), code: '4000', name: 'Sales Revenue', type: 'Revenue', notes: '', isSalary: false },
          { id: uid('a4'), code: '5000', name: 'Rent Expense', type: 'Expense', notes: '', isSalary: false },
        ];
        accounts.push({ id: whtAccountId, code: '2300', name: 'WHT Payable', type: 'Liability', notes: 'Auto-created', isSalary: false });
        accounts.push({ id: uid('a_p'), code: '5100', name: 'Purchases', type: 'Expense', notes: 'Goods purchased for resale', isSalary: false });

        data = {
          users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
          businesses: [{
            id: bizId,
            name: 'Demo Business',
            ownerId: userId,
            members: [userId],
            vatRate: 7.5,
            currency: '₦',
            threshold: 800000,
            notes: 'Sample business',
            vatEnabled: true,
            pitEnabled: true,
            vatInclusive: false,
            whtAutoCreate: true,
            whtCode: '2300',
            whtAccountId: whtAccountId,
            contacts: [contact1, contact2, contact3],
            accounts: accounts,
            pit: DEFAULT_PIT,
            taxAdjustments: {
              netProfitA: 1500000,
              disallowable: 0,
              nonTaxableIncome: 0,
              capitalAllowances: 0,
              priorLosses: 0,
              otherAdjustments: 0
            }
          }],
          transactions: {}
        };
        const now = new Date().toISOString().slice(0,10);
        data.transactions[bizId] = [
          { id: uid('txn'), date: now, desc: 'Demo sale to ACME', amount: 1500000, authorUserId: userId, contactId: contact1.id, accountId: accounts.find(a=>a.type==='Revenue').id, whtEnabled: false, whtRate: 0, vatInclusive: false },
          { id: uid('txn'), date: now, desc: 'Office rent', amount: 200000, authorUserId: userId, contactId: contact2.id, accountId: accounts.find(a=>a.code==='5000').id, whtEnabled: false, whtRate: 0, vatInclusive: false },
          { id: uid('txn'), date: now, desc: 'Purchase inventory', amount: 300000, authorUserId: userId, contactId: contact2.id, accountId: accounts.find(a=>a.name==='Purchases').id, whtEnabled: false, whtRate: 0, vatInclusive: false },
        ];
        saveData();
      }

      function findUser(id){ return data.users.find(u=>u.id===id) || null; }
      function findBiz(id){ return data.businesses.find(b=>b.id===id) || null; }
      function findContact(bizId, contactId){ const b = findBiz(bizId); if (!b || !Array.isArray(b.contacts)) return null; return b.contacts.find(c=>c.id===contactId) || null; }
      function findAccount(bizId, accountId){ const b = findBiz(bizId); if (!b || !Array.isArray(b.accounts)) return null; return b.accounts.find(a=>a.id===accountId) || null; }

      // UI refs
      const userSelect = document.getElementById('userSelect');
      const businessSelect = document.getElementById('businessSelect');
      const btnAddUser = document.getElementById('btnAddUser');
      const btnEditUser = document.getElementById('btnEditUser');
      const btnAddBusiness = document.getElementById('btnAddBusiness');
      const btnEditBusiness = document.getElementById('btnEditBusiness');

      const btnAddTxn = document.getElementById('btnAddTxn');
      const ledgerTbody = document.querySelector('#ledgerTable tbody');

      const vatSummaryDiv = document.getElementById('vatSummary');
      const whtSummaryDiv = document.getElementById('whtSummary');
      const totalsSummaryDiv = document.getElementById('totalsSummary');
      const taxSummaryDiv = document.getElementById('taxSummary');
      const payeSummaryDiv = document.getElementById('payeSummary');
      const pitSummaryDiv = document.getElementById('pitSummary');

      const modalOverlay = document.getElementById('modalOverlay');

      // modals elements
      const userModal = document.getElementById('userModal');
      const userName = document.getElementById('userName');
      const userDisplay = document.getElementById('userDisplay');
      const userSave = document.getElementById('userSave');
      const userCancel = document.getElementById('userCancel');

      const businessModal = document.getElementById('businessModal');
      const bizName = document.getElementById('bizName');
      const bizOwner = document.getElementById('bizOwner');
      const bizVat = document.getElementById('bizVat');
      const bizCurrency = document.getElementById('bizCurrency');
      const bizThreshold = document.getElementById('bizThreshold');
      const bizNotes = document.getElementById('bizNotes');
      const bizVatEnabled = document.getElementById('bizVatEnabled');
      const bizPitEnabled = document.getElementById('bizPitEnabled');
      const bizVatInclusive = document.getElementById('bizVatInclusive');
      const bizWhtEnabled = document.getElementById('bizWhtEnabled');
      const bizWhtCode = document.getElementById('bizWhtCode');
      const bizSave = document.getElementById('bizSave');
      const bizCancel = document.getElementById('bizCancel');

      const contactModal = document.getElementById('contactModal');
      const contactModalTitle = document.getElementById('contactModalTitle');
      const contactName = document.getElementById('contactName');
      const contactType = document.getElementById('contactType');
      const contactInfo = document.getElementById('contactInfo');
      const contactSave = document.getElementById('contactSave');
      const contactCancel = document.getElementById('contactCancel');

      const accountModal = document.getElementById('accountModal');
      const accountCode = document.getElementById('accountCode');
      const accountName = document.getElementById('accountName');
      const accountType = document.getElementById('accountType');
      const accountNotes = document.getElementById('accountNotes');
      const accountIsSalary = document.getElementById('accountIsSalary');
      const accountSave = document.getElementById('accountSave');
      const accountCancel = document.getElementById('accountCancel');

      const editModal = document.getElementById('editModal');
      const editTxnDate = document.getElementById('editTxnDate');
      const editTxnDesc = document.getElementById('editTxnDesc');
      const editTxnAmount = document.getElementById('editTxnAmount');
      const editTxnContact = document.getElementById('editTxnContact');
      const editTxnAccount = document.getElementById('editTxnAccount');
      const editTxnWhtEnabled = document.getElementById('editTxnWhtEnabled');
      const editTxnWhtRate = document.getElementById('editTxnWhtRate');
      const editTxnWhtInclusive = document.getElementById('editTxnWhtInclusive');
      const editWhtLabel = document.getElementById('editWhtLabel');
      const editWhtRateLabel = document.getElementById('editWhtRateLabel');
      const editWhtInclusiveLabel = document.getElementById('editWhtInclusiveLabel');
      const editCancel = document.getElementById('editCancel');
      const editSave = document.getElementById('editSave');

      // inline add txn controls
      const txnDate = document.getElementById('txnDate');
      const txnDesc = document.getElementById('txnDesc');
      const txnAmount = document.getElementById('txnAmount');
      const txnContact = document.getElementById('txnContact');
      const txnAccount = document.getElementById('txnAccount');
      const txnWhtEnabled = document.getElementById('txnWhtEnabled');
      const txnWhtRate = document.getElementById('txnWhtRate');
      const txnWhtInclusive = document.getElementById('txnWhtInclusive');
      const whtInlineLabel = document.getElementById('whtInlineLabel');
      const whtRateInlineLabel = document.getElementById('whtRateInlineLabel');
      const whtInclusiveLabel = document.getElementById('whtInclusiveLabel');

      const btnAddContactInline = document.getElementById('btnAddContactInline');
      const btnAddAccountInline = document.getElementById('btnAddAccountInline');
      const btnOpenContacts = document.getElementById('btnOpenContacts');
      const contactsListDiv = document.getElementById('contactsList');

      const btnOpenAccounts = document.getElementById('btnOpenAccounts');
      const accountsListDiv = document.getElementById('accountsList');

      const ledgerSearch = document.getElementById('ledgerSearch');
      const btnSearch = document.getElementById('btnSearch');
      const btnClearSearch = document.getElementById('btnClearSearch');
      const btnPrevPage = document.getElementById('btnPrevPage');
      const btnNextPage = document.getElementById('btnNextPage');
      const pageIndicator = document.getElementById('pageIndicator');

      const btnExport = document.getElementById('btnExport');
      const btnImport = document.getElementById('btnImport');
      const fileInput = document.getElementById('fileInput');
      const btnClearAll = document.getElementById('btnClearAll');

      // taxable income elements
      const netProfitAInput = document.getElementById('netProfitA');
      const disallowableInput = document.getElementById('disallowable');
      const nonTaxableInput = document.getElementById('nonTaxableIncome');
      const capitalAllowancesInput = document.getElementById('capitalAllowances');
      const priorLossesInput = document.getElementById('priorLosses');
      const otherAdjustmentsInput = document.getElementById('otherAdjustments');
      const btnComputeTaxable = document.getElementById('btnComputeTaxable');
      const taxableResultDiv = document.getElementById('taxableResult');
      const taxableResultValue = document.getElementById('taxableResultValue');
      const taxableBreakdownDiv = document.getElementById('taxableBreakdown');
      const btnClearTaxAdj = document.getElementById('btnClearTaxAdj');

      // PIT & CIT elements
      const taxableInput = document.getElementById('taxableInput');
      const btnCompute = document.getElementById('btnCompute');
      const btnExample = document.getElementById('btnExample');
      const btnClear = document.getElementById('btnClear');

      const pitAnnualEl = document.getElementById('pitAnnual');
      const pitMonthlyEl = document.getElementById('pitMonthly');
      const pitBandsEl = document.getElementById('pitBands');

      const citBaseEl = document.getElementById('citBase');
      const citZeroPortionEl = document.getElementById('citZeroPortion');
      const citExcessPortionEl = document.getElementById('citExcessPortion');
      const citAnnualEl = document.getElementById('citAnnual');
      const citEffectiveEl = document.getElementById('citEffective');

      // helpers
      function normalizeForMatch(s){ if (!s) return ''; return String(s).toLowerCase().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim(); }
      function isDeductionAccount(account, extraKeywords){
        if (!account) return false;
        const name = normalizeForMatch(account.name || '');
        const keywords = (extraKeywords && extraKeywords.length) ? extraKeywords : DEFAULT_DEDUCTION_KEYWORDS;
        for (const kw of keywords){ const k = normalizeForMatch(kw); if (!k) continue; if (name.includes(k)) return true; }
        return false;
      }
      function isPurchaseAccount(biz, account){
        if (!account) return false;
        const name = (account.name || '').toLowerCase();
        const code = String(account.code || '');
        const notes = (account.notes || '').toLowerCase();
        if (name.includes('purchase') || name.includes('purchases') || name.includes('inventory')) return true;
        if (/^51\d{0,}/.test(code)) return true;
        if (notes.includes('purchase') || notes.includes('inventory')) return true;
        return false;
      }

      // Tax computations
      function computeAnnualTax(taxableIncome, pitRules){
        if (!pitRules) pitRules = DEFAULT_PIT;
        const threshold = typeof pitRules.threshold === 'number' ? pitRules.threshold : DEFAULT_PIT.threshold;
        let remaining = Math.max(0, Number(taxableIncome) - threshold);
        if (remaining <= 0) return 0;
        let tax = 0;
        let lower = threshold;
        for (const slice of (pitRules.slices || DEFAULT_PIT.slices)){
          const sliceUpTo = (slice.upTo === Infinity) ? Infinity : slice.upTo;
          const sliceRange = sliceUpTo === Infinity ? Infinity : Math.max(0, sliceUpTo - lower);
          const take = Math.min(remaining, sliceRange);
          if (take > 0){ tax += take * (Number(slice.rate) || 0); remaining -= take; }
          lower = sliceUpTo;
          if (remaining <= 0) break;
        }
        return Math.max(0, tax);
      }

      function computeAnnualPitDetailed(taxable, pitRules){
        pitRules = pitRules || DEFAULT_PIT;
        taxable = Number(taxable) || 0;
        const threshold = Number(pitRules.threshold || DEFAULT_PIT.threshold);
        let remaining = Math.max(0, taxable - threshold);
        if (remaining <= 0) return { tax: 0, breakdown: [] };
        let tax = 0;
        let lower = threshold;
        const breakdown = [];
        for (const slice of (pitRules.slices || DEFAULT_PIT.slices)){
          const sliceUpTo = (slice.upTo === Infinity) ? Infinity : Number(slice.upTo);
          const sliceRange = sliceUpTo === Infinity ? Infinity : Math.max(0, sliceUpTo - lower);
          const take = Math.min(remaining, sliceRange);
          if (take > 0){
            const partTax = take * Number(slice.rate || 0);
            tax += partTax;
            breakdown.push({
              from: lower,
              to: sliceUpTo,
              amountTaxableInSlice: take,
              rate: Number(slice.rate || 0),
              taxForSlice: partTax
            });
            remaining -= take;
          }
          lower = sliceUpTo;
          if (remaining <= 0) break;
        }
        return { tax: Math.max(0, tax), breakdown };
      }

      function computeCit(taxable){
        taxable = Math.max(0, Number(taxable) || 0);
        const zeroPortion = Math.min(taxable, CIT_ZERO_THRESHOLD);
        const excess = Math.max(0, taxable - CIT_ZERO_THRESHOLD);
        const taxOnExcess = excess * CIT_EXCESS_RATE;
        const total = taxOnExcess;
        const effectiveRate = taxable <= 0 ? 0 : (total / taxable);
        return { base: taxable, zeroPortion, excess, taxOnExcess, total, effectiveRate };
      }

      // PAYE calculations per employee (uses transaction data)
      function getEmployeesForBusiness(b){ if (!b || !Array.isArray(b.contacts)) return []; return b.contacts.filter(c => (c.type || '').toLowerCase() === 'employee'); }

      function computeEmployeePayeSummaries(biz){
        if (!biz) return [];
        const year = new Date().getFullYear();
        const txs = data.transactions[biz.id] || [];
        const pitRules = biz.pit || DEFAULT_PIT;
        const employees = getEmployeesForBusiness(biz);
        const keywords = DEFAULT_DEDUCTION_KEYWORDS.slice();
        const results = [];

        function classifyDeductionByAccountName(accName){
          if (!accName) return null;
          const n = normalizeForMatch(accName);
          if (n.includes('pension')) return 'pension';
          if (n.includes('nhf')) return 'nhf';
          if (n.includes('nhis')) return 'nhis';
          if (n.includes('life') && n.includes('assurance')) return 'life';
          if (n.includes('interest') && (n.includes('owner') || n.includes('house'))) return 'interest_owner_occupied';
          if (n.includes('rent')) return 'rent';
          return null;
        }

        for (const emp of employees){
          let gross = 0;
          let pensionTotal = 0, nhfTotal = 0, nhisTotal = 0, lifeTotal = 0, interestTotal = 0, rentTotal = 0, otherDeductionTotal = 0;

          for (const t of txs){
            if (!t.contactId || t.contactId !== emp.id) continue;
            if (!t.date) continue;
            if (t.date.slice(0,4) !== String(year)) continue;
            const acc = findAccount(biz.id, t.accountId);
            if (!acc) continue;
            const isDeduction = isDeductionAccount(acc, keywords);
            const treatAsSalary = !!acc.isSalary || acc.type === 'Revenue' || (acc.type === 'Expense' && !isDeduction);
            const amt = Number(t.amount || 0);

            if (treatAsSalary){ gross += amt; }

            const cls = classifyDeductionByAccountName(acc.name || '');
            if (cls === 'pension') pensionTotal += amt;
            else if (cls === 'nhf') nhfTotal += amt;
            else if (cls === 'nhis') nhisTotal += amt;
            else if (cls === 'life') lifeTotal += amt;
            else if (cls === 'interest_owner_occupied') interestTotal += amt;
            else if (cls === 'rent') rentTotal += amt;
            else { if (isDeduction) otherDeductionTotal += amt; }
          }

          const rentDeduction = Math.min(rentTotal * 0.20, 500000);
          const deductions = pensionTotal + nhfTotal + nhisTotal + lifeTotal + interestTotal + rentDeduction + otherDeductionTotal;
          const taxable = Math.max(0, gross - deductions);
          const annualPaye = computeAnnualTax(taxable, pitRules);
          const monthlyPaye = annualPaye / 12;

          results.push({
            contactId: emp.id,
            name: emp.name || '(no name)',
            gross,
            deductions,
            breakdown: {
              pension: pensionTotal, nhf: nhfTotal, nhis: nhisTotal, lifeAssurance: lifeTotal, interestOnOwnerOccupied: interestTotal, rentTotal, rentDeduction, otherStatutory: otherDeductionTotal
            },
            taxable,
            annualPaye,
            monthlyPaye
          });
        }
        return results;
      }

      function renderPayeSummary(biz){
        payeSummaryDiv.innerHTML = '';
        if (!biz) { payeSummaryDiv.innerHTML = '<div class="muted">No business selected.</div>'; return; }
        if (!biz.pitEnabled) { payeSummaryDiv.innerHTML = '<div class="muted">PIT disabled for this business.</div>'; return; }
        const rows = computeEmployeePayeSummaries(biz);
        if (!rows.length) { payeSummaryDiv.innerHTML = '<div class="muted">No employees found for this business (contacts with type "Employee").</div>'; return; }

        let html = `<strong>PAYE Summary (calendar year ${new Date().getFullYear()})</strong>`;
        html += `<table class="paye-table" role="table" aria-label="PAYE summary">
          <thead><tr><th>Employee</th><th>Gross Salary (₦)</th><th>Statutory Deductions (₦)</th><th>Taxable Income (₦)</th><th>Annual PAYE (₦)</th><th>Monthly PAYE (₦)</th></tr></thead><tbody>`;
        let totalGross=0, totalDeductions=0, totalTaxable=0, totalAnnual=0, totalMonthly=0;
        for (const r of rows){
          html += `<tr>
            <td>${escapeHtml(r.name)}</td>
            <td class="nowrap">${formatMoney(r.gross)}</td>
            <td class="nowrap">${formatMoney(r.deductions)}</td>
            <td class="nowrap">${formatMoney(r.taxable)}</td>
            <td class="nowrap">${formatMoney(r.annualPaye)}</td>
            <td class="nowrap">${formatMoney(r.monthlyPaye)}</td>
          </tr>`;
          totalGross += r.gross;
          totalDeductions += r.deductions;
          totalTaxable += r.taxable;
          totalAnnual += r.annualPaye;
          totalMonthly += r.monthlyPaye;
        }
        html += `</tbody><tfoot><tr style="font-weight:600;">
          <td>Total</td>
          <td class="nowrap">${formatMoney(totalGross)}</td>
          <td class="nowrap">${formatMoney(totalDeductions)}</td>
          <td class="nowrap">${formatMoney(totalTaxable)}</td>
          <td class="nowrap">${formatMoney(totalAnnual)}</td>
          <td class="nowrap">${formatMoney(totalMonthly)}</td>
        </tr></tfoot></table>`;
        payeSummaryDiv.innerHTML = html;
      }

      function renderMonthlyPayePitSummaries(){
        const b = findBiz(selectedBusinessId);
        renderPayeSummary(b);
        pitSummaryDiv.innerHTML = '';
        if (b && b.pit) {
          const bands = (b.pit.slices || DEFAULT_PIT.slices).map(s => {
            const upTo = s.upTo === Infinity ? 'and above' : `up to ₦${formatMoney(s.upTo)}`;
            return `<div>${upTo}: ${(Number(s.rate || 0)*100).toFixed(0)}%</div>`;
          }).join('');
          pitSummaryDiv.innerHTML = `<div class="muted">Tax-free threshold: ₦${formatMoney((b.pit && b.pit.threshold) ? b.pit.threshold : DEFAULT_PIT.threshold)} — Rate bands:</div><div style="margin-top:6px">${bands}</div>`;
        }
      }

      // UI population and rendering functions
      function populateUserBusinessSelects(){
        userSelect.innerHTML = '';
        businessSelect.innerHTML = '';
        if (!data.users.length) {
          const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no users --'; userSelect.appendChild(opt);
        } else {
          data.users.forEach(u=>{ const opt = document.createElement('option'); opt.value=u.id; opt.textContent = (u.display||u.username); userSelect.appendChild(opt); });
        }
        if (!data.businesses.length) {
          const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no businesses --'; businessSelect.appendChild(opt);
        } else {
          data.businesses.forEach(b=>{ const opt = document.createElement('option'); opt.value=b.id; opt.textContent = b.name; businessSelect.appendChild(opt); });
        }

        if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
        if (!selectedBusinessId && data.businesses.length) selectedBusinessId = data.businesses[0].id;
        if (selectedUserId) userSelect.value = selectedUserId;
        if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      }

      function populateBizOwnerOptions(){
        bizOwner.innerHTML = '';
        if (!data.users.length) {
          const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no users --'; bizOwner.appendChild(opt);
        } else {
          data.users.forEach(u=>{ const opt = document.createElement('option'); opt.value=u.id; opt.textContent = (u.display||u.username); bizOwner.appendChild(opt); });
        }
      }

      function populateContactSelects(){
        const b = findBiz(selectedBusinessId);
        const lists = [txnContact, editTxnContact];
        lists.forEach(select => {
          if (!select) return;
          select.innerHTML = '';
          if (!b || !Array.isArray(b.contacts) || b.contacts.length === 0){
            const opt = document.createElement('option'); opt.value=''; opt.textContent = '-- no contacts --'; select.appendChild(opt);
          } else {
            const empty = document.createElement('option'); empty.value=''; empty.textContent='-- select contact --'; select.appendChild(empty);
            b.contacts.forEach(c=>{
              const opt = document.createElement('option'); opt.value = c.id; opt.textContent = (c.name || c.info || '(no name)') + ' (' + (c.type||'') + ')';
              select.appendChild(opt);
            });
          }
        });
      }

      function populateAccountSelects(){
        const b = findBiz(selectedBusinessId);
        const lists = [txnAccount, editTxnAccount];
        lists.forEach(select => {
          if (!select) return;
          select.innerHTML = '';
          if (!b || !Array.isArray(b.accounts) || b.accounts.length === 0){
            const opt = document.createElement('option'); opt.value=''; opt.textContent = '-- no accounts --'; select.appendChild(opt);
          } else {
            const empty = document.createElement('option'); empty.value=''; empty.textContent='-- select account --'; select.appendChild(empty);
            b.accounts.forEach(a=>{
              const opt = document.createElement('option'); opt.value = a.id; opt.textContent = `${a.code || ''} - ${a.name} (${a.type || ''})${a.isSalary ? ' [Salary]' : ''}`;
              select.appendChild(opt);
            });
          }
        });
      }

      function refreshContactsAccountsUI(){
        contactsListDiv.innerHTML = ''; accountsListDiv.innerHTML = '';
        const b = findBiz(selectedBusinessId);
        if (!b){ contactsListDiv.textContent='No business selected.'; accountsListDiv.textContent='No business selected.'; populateContactSelects(); populateAccountSelects(); return; }
        if (!Array.isArray(b.contacts)) b.contacts = [];
        if (!Array.isArray(b.accounts)) b.accounts = [];

        if (b.contacts.length === 0) contactsListDiv.innerHTML = '<div class="muted">No contacts for this business.</div>';
        else {
          b.contacts.forEach(c=>{
            const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
            d.innerHTML = `<div><strong>${escapeHtml(c.name)}</strong> <span class="muted">(${escapeHtml(c.type)})</span><br/><small class="muted">${escapeHtml(c.info||'')}</small></div>`;
            contactsListDiv.appendChild(d);
          });
        }

        if (b.accounts.length === 0) accountsListDiv.innerHTML = '<div class="muted">No accounts for this business.</div>';
        else {
          b.accounts.forEach(a=>{
            const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
            const isWht = (b.whtAccountId && a.id === b.whtAccountId);
            const salaryTag = a.isSalary ? '<span class="muted"> (Salary)</span>' : '';
            d.innerHTML = `<div><strong>${escapeHtml(a.code)} - ${escapeHtml(a.name)}</strong> ${isWht?'<span class="muted"> (WHT Payable)</span>':''}${salaryTag} <span class="muted">(${escapeHtml(a.type)})</span></div>`;
            accountsListDiv.appendChild(d);
          });
        }
        populateContactSelects();
        populateAccountSelects();
      }

      function renderLedger(){
        ledgerTbody.innerHTML = '';
        const b = findBiz(selectedBusinessId);
        if (!b) return;
        const txs = (data.transactions[b.id] || []).slice().sort((a,b2)=> (b2.date || '').localeCompare(a.date || '')); // desc by date
        let filtered = txs;
        const q = (ledgerFilterText || '').trim().toLowerCase();
        if (q){
          filtered = txs.filter(t=>{
            const acc = findAccount(b.id, t.accountId);
            const contact = findContact(b.id, t.contactId);
            const author = findUser(t.authorUserId);
            return (t.date||'').toLowerCase().includes(q) ||
                   (t.desc||'').toLowerCase().includes(q) ||
                   String(t.amount||'').toLowerCase().includes(q) ||
                   (acc && ((acc.name||'').toLowerCase().includes(q) || (acc.code||'').toLowerCase().includes(q))) ||
                   (contact && (contact.name||'').toLowerCase().includes(q)) ||
                   (author && ((author.display||'').toLowerCase().includes(q) || (author.username||'').toLowerCase().includes(q)));
          });
        }
        const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * PAGE_SIZE;
        const pageItems = filtered.slice(start, start + PAGE_SIZE);
        for (const t of pageItems){
          const tr = document.createElement('tr');
          const acc = findAccount(b.id, t.accountId);
          const contact = findContact(b.id, t.contactId);
          const author = findUser(t.authorUserId);

          // compute VAT for sales (Revenue) and purchases only (not all expenses)
          let vatAmt = 0;
          if (b.vatEnabled && b.vatRate && acc && (acc.type === 'Revenue' || isPurchaseAccount(b, acc))){
            if (b.vatInclusive || t.vatInclusive){
              vatAmt = Number(t.amount || 0) * Number(b.vatRate || 0) / (100 + Number(b.vatRate || 0));
            } else {
              vatAmt = Number(t.amount || 0) * Number(b.vatRate || 0) / 100;
            }
          }

          let whtAmt = 0;
          if (t.whtEnabled && t.whtRate){
            if (t.whtInclusive){
              whtAmt = Number(t.amount || 0) * Number(t.whtRate || 0) / (100 + Number(t.whtRate || 0));
            } else {
              whtAmt = Number(t.amount || 0) * Number(t.whtRate || 0) / 100;
            }
          }

          const accText = acc ? `${acc.code || ''} - ${acc.name}` : '(no account)';
          tr.innerHTML = `<td>${escapeHtml(t.date || '')}</td>
            <td>${escapeHtml(t.desc || '')}</td>
            <td>${escapeHtml(accText)}</td>
            <td class="nowrap">${formatMoney(t.amount)}</td>
            <td class="nowrap">${formatMoney(vatAmt)}</td>
            <td class="nowrap">${formatMoney(whtAmt)}</td>
            <td>${escapeHtml(contact ? contact.name : '')}</td>
            <td>${escapeHtml(author ? (author.display || author.username) : '')}</td>
            <td style="white-space:nowrap">
              <button class="small" data-bid="${b.id}" data-tid="${t.id}" onclick="window.editTxnHandler('${b.id}','${t.id}')">Edit</button>
              <button class="small danger" onclick="window.deleteTxnHandler('${b.id}','${t.id}')">Delete</button>
            </td>`;
          ledgerTbody.appendChild(tr);
        }
        pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
      }

      function calculateSummary(){
        const b = findBiz(selectedBusinessId);
        if (!b) return;
        const txs = data.transactions[b.id] || [];

        let totalVatOutput = 0, totalVatInput = 0, totalWhtWithheld = 0, totalAmount = 0;
        for (const t of txs){
          const acc = findAccount(b.id, t.accountId);
          if (!acc) continue;
          const amt = Number(t.amount || 0);
          totalAmount += amt;

          let vatAmt = 0;
          if (b.vatEnabled && b.vatRate && acc && (acc.type === 'Revenue' || isPurchaseAccount(b, acc))){
            if (b.vatInclusive || t.vatInclusive){ vatAmt = amt * b.vatRate / (100 + b.vatRate); }
            else { vatAmt = amt * b.vatRate / 100; }
          }
          if (acc.type === 'Revenue') totalVatOutput += vatAmt;
          else if (isPurchaseAccount(b, acc)) totalVatInput += vatAmt;

          if (t.whtEnabled && t.whtRate){
            let w = 0;
            if (t.whtInclusive){ w = amt * t.whtRate / (100 + t.whtRate); }
            else { w = amt * t.whtRate / 100; }
            totalWhtWithheld += w;
          }
        }

        vatSummaryDiv.innerHTML = `<strong>VAT summary</strong><div>Output VAT: ₦${formatMoney(totalVatOutput)}</div><div>Input VAT: ₦${formatMoney(totalVatInput)}</div><div>Net VAT payable (output - input): ₦${formatMoney(totalVatOutput - totalVatInput)}</div>`;
        whtSummaryDiv.innerHTML = `<strong>WHT summary</strong><div>Total WHT withheld: ₦${formatMoney(totalWhtWithheld)}</div>`;
        totalsSummaryDiv.innerHTML = `<strong>Totals</strong><div>Total transactions amount: ₦${formatMoney(totalAmount)}</div>`;
      }

      // Manage users/businesses/contacts/accounts and transactions (simple CRUD)
      function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; modal.setAttribute('aria-hidden','false'); }
      function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }

      btnAddUser.addEventListener('click', function(){ userModalTitle.textContent='Add User'; userName.value=''; userDisplay.value=''; userEditingId = null; openModal(userModal); });
      userCancel.addEventListener('click', function(){ closeModal(userModal); });
      userSave.addEventListener('click', function(){
        const username = (userName.value || '').trim();
        if (!username){ alert('Username required'); return; }
        if (userEditingId){
          const u = data.users.find(x=>x.id===userEditingId); if (u){ u.username = username; u.display = userDisplay.value || username; saveData(); }
        } else {
          const u = { id: uid('user'), username, display: userDisplay.value || username };
          data.users.push(u); saveData();
        }
        closeModal(userModal); populateUserBusinessSelects(); populateBizOwnerOptions();
      });

      btnAddBusiness.addEventListener('click', function(){ bizName.value=''; bizVat.value=7.5; bizCurrency.value='₦'; bizThreshold.value=''; bizNotes.value=''; bizVatEnabled.checked=true; bizPitEnabled.checked=true; bizVatInclusive.checked=false; bizWhtEnabled.checked=true; bizWhtCode.value='2300'; populateBizOwnerOptions(); openModal(businessModal); });
      bizCancel.addEventListener('click', function(){ closeModal(businessModal); });
      bizSave.addEventListener('click', function(){
        const name = (bizName.value || '').trim();
        if (!name){ alert('Business name required'); return; }
        const ownerId = bizOwner.value || null;
        const b = {
          id: uid('biz'),
          name,
          ownerId,
          members: ownerId ? [ownerId] : [],
          vatRate: Number(bizVat.value || 7.5),
          currency: bizCurrency.value || '₦',
          threshold: Number(bizThreshold.value || 0),
          notes: bizNotes.value || '',
          vatEnabled: !!bizVatEnabled.checked,
          pitEnabled: !!bizPitEnabled.checked,
          vatInclusive: !!bizVatInclusive.checked,
          whtAutoCreate: !!bizWhtEnabled.checked,
          whtCode: bizWhtCode.value || '2300',
          contacts: [],
          accounts: [],
          pit: DEFAULT_PIT,
          taxAdjustments: { netProfitA:0, disallowable:0, nonTaxableIncome:0, capitalAllowances:0, priorLosses:0, otherAdjustments:0 }
        };
        ensureBizWhtAccount(b);
        data.businesses.push(b);
        data.transactions[b.id] = [];
        saveData();
        closeModal(businessModal);
        populateUserBusinessSelects();
        populateContactSelects();
        populateAccountSelects();
        refreshContactsAccountsUI();
      });

      // Contacts and accounts management (simple)
      btnAddContactInline.addEventListener('click', function(){
        contactModalTitle.textContent='Add Contact'; contactName.value=''; contactType.value='Customer'; contactInfo.value=''; contactEditingId = null; openModal(contactModal);
      });
      contactCancel.addEventListener('click', function(){ closeModal(contactModal); });
      contactSave.addEventListener('click', function(){
        const b = findBiz(selectedBusinessId); if (!b) { alert('Select a business first'); closeModal(contactModal); return; }
        const name = (contactName.value || '').trim(); if (!name){ alert('Contact name required'); return; }
        const contact = { id: contactEditingId || uid('c'), name, type: contactType.value || 'Customer', info: contactInfo.value || '' };
        if (contactEditingId){
          const idx = b.contacts.findIndex(c=>c.id===contactEditingId); if (idx >= 0) b.contacts[idx] = contact;
        } else b.contacts.push(contact);
        saveData(); closeModal(contactModal); refreshContactsAccountsUI();
      });

      btnAddAccountInline.addEventListener('click', function(){
        accountModal.style.display='block'; openModal(accountModal); accountCode.value=''; accountName.value=''; accountType.value='Expense'; accountNotes.value=''; accountIsSalary.checked=false; accountEditingId = null;
      });
      accountCancel.addEventListener('click', function(){ closeModal(accountModal); });
      accountSave.addEventListener('click', function(){
        const b = findBiz(selectedBusinessId); if (!b) { alert('Select a business first'); closeModal(accountModal); return; }
        const code = (accountCode.value || '').trim(); const name = (accountName.value || '').trim();
        if (!name){ alert('Account name required'); return; }
        const acc = { id: accountEditingId || uid('a'), code, name, type: accountType.value || 'Expense', notes: accountNotes.value || '', isSalary: !!accountIsSalary.checked };
        if (accountEditingId){
          const idx = b.accounts.findIndex(a=>a.id===accountEditingId); if (idx >= 0) b.accounts[idx] = acc;
        } else b.accounts.push(acc);
        ensureBizWhtAccount(b);
        saveData(); closeModal(accountModal); refreshContactsAccountsUI();
      });

      // Add transaction inline
      btnAddTxn.addEventListener('click', function(){
        const b = findBiz(selectedBusinessId); if (!b){ alert('Select a business first'); return; }
        if (!txnDate.value){ alert('Date required'); return; }
        const accId = txnAccount.value; const contactId = txnContact.value || null;
        const amount = Number(txnAmount.value || 0); if (!accId){ alert('Select an account'); return; }
        if (amount <= 0){ alert('Amount must be > 0'); return; }
        const tx = {
          id: uid('txn'),
          date: txnDate.value,
          desc: txnDesc.value || '',
          amount,
          authorUserId: selectedUserId,
          contactId: contactId || null,
          accountId: accId,
          whtEnabled: txnWhtEnabled ? !!txnWhtEnabled.checked : false,
          whtRate: txnWhtRate ? Number(txnWhtRate.value || 0) : 0,
          whtInclusive: txnWhtInclusive ? !!txnWhtInclusive.checked : false,
          vatInclusive: false
        };
        data.transactions[b.id] = data.transactions[b.id] || [];
        data.transactions[b.id].push(tx);
        saveData();
        txnDate.value=''; txnDesc.value=''; txnAmount.value=''; txnContact.value=''; txnAccount.value='';
        renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
      });

      // Ledger editing / deletion exposed on window for button handlers
      window.editTxnHandler = function(bid, tid){
        const b = findBiz(bid); if (!b) return;
        const txs = data.transactions[bid] || []; const t = txs.find(x=>x.id===tid); if (!t) return;
        editTxnId = tid; editTxnBizId = bid;
        editTxnDate.value = t.date || ''; editTxnDesc.value = t.desc || ''; editTxnAmount.value = t.amount || 0;
        populateAccountSelects(); populateContactSelects();
        editTxnContact.value = t.contactId || '';
        editTxnAccount.value = t.accountId || '';
        if (t.whtEnabled !== undefined){ editWhtLabel.style.display='block'; editWhtRateLabel.style.display='block'; editWhtInclusiveLabel.style.display='block'; editTxnWhtEnabled.checked = !!t.whtEnabled; editTxnWhtRate.value = Number(t.whtRate || 0); editTxnWhtInclusive.checked = !!t.whtInclusive; } else { editWhtLabel.style.display='none'; editWhtRateLabel.style.display='none'; editWhtInclusiveLabel.style.display='none'; }
        openModal(editModal);
      };

      window.deleteTxnHandler = function(bid, tid){
        if (!confirm('Delete this transaction?')) return;
        const arr = data.transactions[bid] || []; const idx = arr.findIndex(x=>x.id===tid); if (idx>=0){ arr.splice(idx,1); saveData(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries(); }
      };

      editCancel.addEventListener('click', function(){ closeModal(editModal); editTxnId = editTxnBizId = null; });
      editSave.addEventListener('click', function(){
        if (!editTxnId || !editTxnBizId) { closeModal(editModal); return; }
        const arr = data.transactions[editTxnBizId] || []; const idx = arr.findIndex(x=>x.id===editTxnId);
        if (idx < 0){ closeModal(editModal); return; }
        const t = arr[idx];
        t.date = editTxnDate.value || t.date;
        t.desc = editTxnDesc.value || t.desc;
        t.amount = Number(editTxnAmount.value || 0);
        t.contactId = editTxnContact.value || null;
        t.accountId = editTxnAccount.value || null;
        t.whtEnabled = !!editTxnWhtEnabled.checked;
        t.whtRate = Number(editTxnWhtRate.value || 0);
        t.whtInclusive = !!editTxnWhtInclusive.checked;
        saveData(); closeModal(editModal); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries();
      });

      // Search & pagination
      btnSearch.addEventListener('click', function(){ ledgerFilterText = ledgerSearch.value || ''; currentPage = 1; renderLedger(); });
      btnClearSearch.addEventListener('click', function(){ ledgerSearch.value=''; ledgerFilterText=''; currentPage=1; renderLedger(); });
      btnPrevPage.addEventListener('click', function(){ if (currentPage > 1) { currentPage--; renderLedger(); } });
      btnNextPage.addEventListener('click', function(){ currentPage++; renderLedger(); });

      // Export / import / clear
      btnExport.addEventListener('click', function(){
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'ntc-data.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
      btnImport.addEventListener('click', function(){ fileInput.click(); });
      fileInput.addEventListener('change', function(e){
        const f = e.target.files && e.target.files[0]; if (!f) return;
        const reader = new FileReader(); reader.onload = function(){ try { const parsed = JSON.parse(reader.result); if (parsed){ data = parsed; saveData(); populateUserBusinessSelects(); populateBizOwnerOptions(); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries(); alert('Import successful'); } } catch(err){ alert('Invalid JSON file'); console.error(err); } }; reader.readAsText(f);
      });
      btnClearAll.addEventListener('click', function(){ if (!confirm('Clear all stored data? This will reset the app.')) return; localStorage.removeItem(STORAGE_KEY); data = {users:[],businesses:[],transactions:{}}; selectedUserId = selectedBusinessId = null; loadData(); initUI(); });

      // Taxable-from-net-profit handlers
      btnComputeTaxable.addEventListener('click', function(){ computeTaxableFromNetProfit(); });
      btnClearTaxAdj.addEventListener('click', function(){
        netProfitAInput.value = ''; disallowableInput.value = ''; nonTaxableInput.value = ''; capitalAllowancesInput.value = ''; priorLossesInput.value = ''; otherAdjustmentsInput.value = '';
        taxableResultDiv.style.display = 'none';
      });

      function computeTaxableFromNetProfit(){
        const netProfitA = Number(netProfitAInput.value) || 0;
        const disallowable = Number(disallowableInput.value) || 0;
        const nonTaxable = Number(nonTaxableInput.value) || 0;
        const capitalAllowances = Number(capitalAllowancesInput.value) || 0;
        const priorLosses = Number(priorLossesInput.value) || 0;
        const other = Number(otherAdjustmentsInput.value) || 0;
        const taxable = netProfitA + disallowable - nonTaxable - capitalAllowances - priorLosses + other;
        const taxableClean = taxable < 0 ? 0 : taxable;
        const lines = [
          `Net profit A: ₦${formatMoney(netProfitA)}`,
          `+ Disallowable expenses: ₦${formatMoney(disallowable)}`,
          `- Non-taxable income: ₦${formatMoney(nonTaxable)}`,
          `- Capital allowances: ₦${formatMoney(capitalAllowances)}`,
          `- Prior unrelieved losses: ₦${formatMoney(priorLosses)}`,
          `${other >= 0 ? '+ Other adjustments' : '- Other adjustments'}: ₦${formatMoney(other)}`,
          '------------------------------------',
          `Taxable income (before flooring at 0): ₦${formatMoney(taxable)}`
        ];
        taxableResultValue.textContent = formatMoney(taxableClean);
        taxableBreakdownDiv.innerHTML = '<pre>' + lines.join('\n') + '</pre>';
        taxableResultDiv.style.display = 'block';
        // also prefill taxableInput so user can compute PIT/CIT directly
        taxableInput.value = taxableClean;
      }

      // PIT & CIT compute/render functions and UI events
      function renderPitDetailed(result){
        pitAnnualEl.textContent = formatMoney(result.tax);
        pitMonthlyEl.textContent = formatMoney(result.tax / 12);
        if (!result.breakdown || result.breakdown.length === 0){
          pitBandsEl.innerHTML = 'No tax due (taxable income is at or below the tax-free threshold).';
          return;
        }
        const lines = result.breakdown.map(b=>{
          const toLabel = b.to === Infinity ? 'and above' : `₦${formatMoney(b.to)}`;
          return `Taxable in band (₦${formatMoney(b.from + 0.01)} – ${toLabel}): ₦${formatMoney(b.amountTaxableInSlice)} @ ${(b.rate*100).toFixed(0)}% → ₦${formatMoney(b.taxForSlice)}`;
        });
        pitBandsEl.innerHTML = '<pre>' + lines.join('\n') + '</pre>';
      }

      function renderCitResults(res){
        citBaseEl.textContent = formatMoney(res.base);
        citZeroPortionEl.textContent = formatMoney(res.zeroPortion);
        citExcessPortionEl.textContent = formatMoney(res.excess);
        citAnnualEl.textContent = formatMoney(res.total);
        citEffectiveEl.textContent = (res.effectiveRate * 100).toFixed(2) + '%';
      }

      btnCompute.addEventListener('click', function(){ computeAndRender(); });
      btnExample.addEventListener('click', function(){ taxableInput.value = 50000000; computeAndRender(); });
      btnClear.addEventListener('click', function(){ taxableInput.value = ''; computeAndRender(); });

      function computeAndRender(){
        const taxable = Number(taxableInput.value) || 0;
        const pitRes = computeAnnualPitDetailed(taxable, DEFAULT_PIT);
        renderPitDetailed(pitRes);
        const citRes = computeCit(taxable);
        renderCitResults(citRes);
      }

      // Initialization
      function initUI(){
        loadData();
        populateUserBusinessSelects();
        populateBizOwnerOptions();
        populateContactSelects();
        populateAccountSelects();
        refreshContactsAccountsUI();
        renderLedger();
        calculateSummary();
        renderMonthlyPayePitSummaries();
        computeAndRender();
      }

      // react to user/business selection change
      userSelect.addEventListener('change', function(){ selectedUserId = userSelect.value || null; saveData(); renderLedger(); });
      businessSelect.addEventListener('change', function(){ selectedBusinessId = businessSelect.value || null; populateContactSelects(); populateAccountSelects(); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries(); });

      // expose simple debug functions
      window._ntc = { data, saveData, loadData, computeAnnualTax, computeCit, computeTaxableFromNetProfit };

      // start
      initUI();
    })();
  </script>
</body>
          </html>
