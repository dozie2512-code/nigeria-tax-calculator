I've updated index.html to implement Option A: PAYE is calculated per salary transaction by annualising the transaction amount (×12), applying statutory deductions (contact-level overrides business defaults), computing annual PAYE using the progressive PAYE_BANDS, then dividing back to a monthly (per-transaction) PAYE and storing the values on the transaction. The code leaves existing logic unchanged and adds the PAYE computation and summary rendering. Paste the content below to replace your current index.html.

Note: I placed the new PAYE logic and hooks near the end of the existing script so it runs after initialisation and after adding transactions.

----- begin updated index.html -----
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Multi-User Accounting & Tax — Full Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,96vw)[...]
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted-pill { background:#f2f4f7; padding:4px 8px; border-radius:6px; font-size:0.9rem; color:#333; }
    .disabled { opacity:0.45; pointer-events:none; }
    .code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f3f5f7; padding:4px 6px; border-radius:4px; }
  </style>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax Engine — Prototype</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
      </div>
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
            <option value="BankPayment">Bank Payment</option>
            <option value="BankReceipt">Bank Receipt</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small primary">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>

          <label>Classification:
            <select id="assetClassification">
              <option value="Fixed">Fixed</option>
              <option value="Chargeable">Chargeable</option>
            </select>
          </label>

          <label>Depreciation rate % (annual): <input type="number" id="assetDepRate" class="smallInput" min="0" step="0.01" /></label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small primary">Record Asset Purchase</button>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days. Capital allowance applied monthly from purchase.</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable/Receivable</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Fixed Assets Report</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
        <button id="btnExportXlsx" class="small">Export XLSX (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <!-- User modal -->
  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <!-- Business modal -->
  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (SoleTrader), that will override these values for PIT.</small>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add a contact with type "SoleTrader" (or name "Sole trader") and set statutory deductions there if you want PIT to use per-sole-trader deductions.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <!-- Accounts modal -->
  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="max-height:360px; overflow:auto;"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountDisallowable" /> Disallowable</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountNonTax" /> Non-taxable</label>
      <select id="newAccountRentFreq">
        <option value="">Rent freq</option>
        <option value="monthly">Monthly rent</option>
        <option value="yearly">Yearly rent</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">GitHub Copilot Chat Assistant — prototype stores data in localStorage (ntc_full_accounting_v1)</footer>

  <script>
  /************************************************************************
   * Nigeria Multi-User Multi-Business Accounting & Tax Engine (Prototype)
   * Single-file SPA
   * Storage key: ntc_full_accounting_v1
   *
   * Features implemented:
   * - Multi-user, multi-business, per-user permissions
   * - Chart of accounts with disallowable/non-taxable flags and rent freq
   * - Transactions: revenue, expense, inventory (weighted avg COGS), fixed assets (Fixed vs Chargeable)
   * - Receipts attached and viewable (base64 stored)
   * - Fixed asset depreciation (straight-line monthly prorated), capital allowance monthly
   * - Tax engine: VAT (inclusive/exclusive), WHT (gross/net), PAYE, PIT, CIT, with rules described by user
   * - Chargeable gains/losses: classification, carry-forward logic
   * - Reports: P&L snapshot, tax summary, VAT, WHT, PAYE breakdown, assets schedule, inventory
   * - Exports: JSON import/export, CSV, PDF, XLSX (SheetJS)
   *
   * Note: This is a frontend-local prototype. Attachments are stored in localStorage as base64 strings.
   ************************************************************************/

  // Constants & defaults
  const STORAGE_KEY = 'ntc_full_accounting_v1';
  const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, caRateDefault:20.0, depRateDefault:20.0 };
  const PAYE_BANDS = [
    { upTo: 800000, rate: 0.00 },
    { upTo: 3000000, rate: 0.15 },   // 800k..3,000,000 => next 2.2m @15%
    { upTo: 12000000, rate: 0.18 },
    { upTo: 25000000, rate: 0.21 },
    { upTo: 50000000, rate: 0.23 },
    { upTo: Infinity, rate: 0.25 }
  ];
  const CIT_TURNOVER_THRESHOLD = 50000000; // 50,000,000

  // App state
  let state = {
    users: [], businesses: [], transactions: {}, attachments: {}, audit: [], auth: { currentUserId: null },
  };
  let selectedUserId = null;
  let selectedBizId = null;
  let activeTab = 'ledger';
  let inventoryHistory = [];
  let assetHistory = [];

  // DOM refs
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const txnReceipt = document.getElementById('txnReceipt');
  const btnAddTxn = document.getElementById('btnAddTxn');
  const mainTxnForm = document.getElementById('mainTxnForm');

  const inventorySubform = document.getElementById('inventorySubform');
  const invItemSelect = document.getElementById('invItemSelect');
  const invNewName = document.getElementById('invNewName');
  const invAccountSelect = document.getElementById('invAccountSelect');
  const invQty = document.getElementById('invQty');
  const invUnitPrice = document.getElementById('invUnitPrice');
  const invVatType = document.getElementById('invVatType');
  const invContact = document.getElementById('invContact');
  const invReceipt = document.getElementById('invReceipt');
  const btnAddInv = document.getElementById('btnAddInv');
  const btnInvCancel = document.getElementById('btnInvCancel');
  const btnInvUndo = document.getElementById('btnInvUndo');

  const assetSubform = document.getElementById('assetSubform');
  const assetName = document.getElementById('assetName');
  const assetCost = document.getElementById('assetCost');
  const assetPurchaseDate = document.getElementById('assetPurchaseDate');
  const assetLife = document.getElementById('assetLife');
  const assetCA = document.getElementById('assetCA');
  const assetDisposalDate = document.getElementById('assetDisposalDate');
  const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
  const btnAddAsset = document.getElementById('btnAddAsset');
  const btnDisposeAsset = document.getElementById('btnDisposeAsset');
  const btnAssetCancel = document.getElementById('btnAssetCancel');
  const btnAssetUndo = document.getElementById('btnAssetUndo');
  const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
  const assetDisposalAccount = document.getElementById('assetDisposalAccount');
  const assetClassification = document.getElementById('assetClassification');
  const assetDepRate = document.getElementById('assetDepRate');
  const assetContact = document.getElementById('assetContact');
  const assetReceipt = document.getElementById('assetReceipt');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const ledgerSection = document.getElementById('ledgerSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');

  const modalOverlay = document.getElementById('modalOverlay');
  const userModal = document.getElementById('userModal');
  const userModalTitle = document.getElementById('userModalTitle');
  const userName = document.getElementById('userName');
  const userDisplay = document.getElementById('userDisplay');
  const userRole = document.getElementById('userRole');
  const permView = document.getElementById('permView');
  const permEdit = document.getElementById('permEdit');
  const permDelete = document.getElementById('permDelete');
  const userSave = document.getElementById('userSave');
  const userCancel = document.getElementById('userCancel');

  const businessModal = document.getElementById('businessModal');
  const businessModalTitle = document.getElementById('businessModalTitle');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
  const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizCapitalBF = document.getElementById('bizCapitalBF');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');

  const accountsModal = document.getElementById('accountsModal');
  const accountsList = document.getElementById('accountsList');
  const newAccountName = document.getElementById('newAccountName');
  const newAccountCategory = document.getElementById('newAccountCategory');
  const newAccountDisallowable = document.getElementById('newAccountDisallowable');
  const newAccountNonTax = document.getElementById('newAccountNonTax');
  const newAccountRentFreq = document.getElementById('newAccountRentFreq');
  const addAccountBtn = document.getElementById('addAccountBtn');
  const closeAccountsBtn = document.getElementById('closeAccountsBtn');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnReportsTab = document.getElementById('btnReportsTab');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
  function toISO(date){ if(!date) return null; return new Date(date).toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }

  // load/save
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }
  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || { currentUserId: null };
    state.businesses.forEach(b => {
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
      b.accounts = b.accounts || [];
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
    });
    // ensure transactions map for each user and business
    for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; for(const b of state.businesses){ state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || []; } }
    saveState();
  }

  function seedDemo(){
    const u = uid('user'), b = uid('biz');
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const rent = { id: uid('acct'), name: 'Rent', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false, rentFreq:'monthly' };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false };
    const chargeInc = { id: uid('acct'), name: 'Chargeable asset income', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const chargeCost = { id: uid('acct'), name: 'Chargeable asset cost', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };

    state = {
      users: [{ id: u, username: 'admin', display:'Admin User', role:'Admin', isAdmin:true, permissions:{ view:true, edit:true, delete:true } }],
      businesses: [{
        id: b,
        name: 'Demo Business',
        ownerId: u,
        entity: 'Company',
        vatRate: DEFAULTS.vatRate,
        whtRate: DEFAULTS.whtRate,
        citRate: DEFAULTS.citRate,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault,
        depRateDefault: DEFAULTS.depRateDefault,
        accounts: [sales, cogs, salaries, rent, bank, chargeInc, chargeCost],
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [
          // Fixed asset
          { id: uid('asset'), name: 'Office PC', cost: 150000, purchaseDate: today(), lifeYears: 5, caPercent: 20, depRate: 20, classification: 'Fixed', accumulatedDep:0, disposed:false, disposal:{}, [...]
          // Chargeable asset sample (disposed with loss)
          { id: uid('asset'), name: 'Land Plot', cost: 2000000, purchaseDate: '2020-01-01', lifeYears: 20, caPercent: 5, depRate: 0, classification: 'Chargeable', accumulatedDep:0, disposed:false, dis[...]
        ],
        contacts: [{ id: uid('c'), name:'John Employee', type:'Employee', statutory:{ pension: 20000, rent: 120000, life: 5000, mortgage: 100000, nhf: 5000 }, taxSettings: { vat:true, wht:true, paye:t[...]
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward: 150000, caCarryForward: 50000, capitalBroughtForward: 0,
        defaultExpenseDisallowable:false, defaultRevenueNonTax:false,
        firsLabel: ''
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: u }
    };
    // initialize transactions map
    state.transactions[u] = {};
    state.transactions[u][b] = [
      // sample revenue (with VAT exclusive)
      { id: uid('txn'), date: today(), action: 'Revenue', accountId: sales.id, accountName: sales.name, accountCategory: sales.category, description: 'Demo sale', amount: 150000, vatType:'exclusive', [...]
      // sample salary (PAYE)
      { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, accountCategory: salaries.category, description: 'Demo salary', amount: 50000, vatType:'none', wht:false, salary:true, contactName:'John Employee' },
      // inventory purchase
      { id: uid('txn'), date: today(), action: 'InventoryPurchase', accountId: cogs.id, accountName: cogs.name, accountCategory: cogs.category, description: 'Purchase widgets', qty:50, unitPrice:520, [...] }
    ];
    addAudit('seed','system','',`Seeded demo data`);
    saveState();
  }

  // audit
  function addAudit(type, entityType, entityId, details){
    const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details };
    state.audit = state.audit || [];
    state.audit.push(entry);
    saveState();
  }

  // modal helpers
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
  modalOverlay.addEventListener('click', ()=> { [userModal, businessModal, accountsModal].forEach(m => { if(m.style.display==='block') closeModal(m); }); });

  // initialization
  loadState();
  initUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  function initUI(){
    // Users
    btnAddUser.addEventListener('click', ()=> openUserModal());
    btnEditUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); openUserModal(selectedUserId); });
    btnDeleteUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); if(!confirm('Delete user? This cannot be undone')) return; deleteUser(selectedUserId); });
    userSave.addEventListener('click', ()=> {
      const username = (userName.value||'').trim();
      if(!username) return alert('Username required');
      const editId = userSave.dataset.edit;
      if(editId){
        const u = state.users.find(x=>x.id===editId);
        u.username = username; u.display = userDisplay.value || username; u.role = userRole.value;
        u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked };
        addAudit('user.edit','user',u.id,'Edited user');
      } else {
        const newUser = { id: uid('user'), username, display: userDisplay.value || username, role: userRole.value, isAdmin: userRole.value==='Admin', permissions: { view: !!permView.checked, edit: !!p[...]
        state.users.push(newUser);
        // ensure transactions map
        state.transactions[newUser.id] = state.transactions[newUser.id] || {};
        for(const b of state.businesses) state.transactions[newUser.id][b.id] = state.transactions[newUser.id][b.id] || [];
        addAudit('user.add','user',newUser.id,'Added user');
      }
      saveState();
      closeModal(userModal);
      refreshSelectors();
      ensureSelection();
      renderAll();
    });
    userCancel.addEventListener('click', ()=> closeModal(userModal));

    // Business
    btnAddBusiness.addEventListener('click', ()=> {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = ''; bizOwnerSelect.value = state.users[0] ? state.users[0].id : '';
      bizEntity.value = 'Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate;
      bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
      bizSave.dataset.edit = '';
      bizContactsList.innerHTML = '';
      openModal(businessModal);
    });
    btnEditBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const b = findBiz(selectedBizId); if(!b) return alert('Business not found');
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (state.users[0] && state.users[0].id) || '';
      bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
      bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEna[...]
      bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0; bizCapitalBF.value = b.capitalBroughtForward || 0;
      bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax;
      bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
      bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0;
      bizCapitalBF.value = b.capitalBroughtForward || 0;
      renderBizContacts(b);
      bizSave.dataset.edit = b.id;
      openModal(businessModal);
    });
    btnDeleteBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      if(!confirm('Delete business and all its transactions/attachments?')) return;
      deleteBusiness(selectedBizId);
    });
    bizSave.addEventListener('click', ()=> {
      const name = (bizName.value||'').trim();
      if(!name) return alert('Business name required');
      const editId = bizSave.dataset.edit;
      if(editId){
        const b = findBiz(editId);
        if(!b) return alert('Business not found');
        b.name = name; b.ownerId = bizOwnerSelect.value; b.entity = bizEntity.value;
        b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
        b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.c[...]
        b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0); b.capitalBroughtForward = Number(bizCapitalBF.value || 0);
        b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked;
        b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDe[...]
        addAudit('business.edit','business', b.id, 'Edited business');
      } else {
        const newBiz = {
          id: uid('biz'), name, ownerId: bizOwnerSelect.value || (state.users[0] && state.users[0].id),
          entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate),
          vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
          accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
          lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS[...]
        };
        // default accounts
        newBiz.accounts.push({ id: uid('acct'), name:'Sales', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Bank', category:'Asset', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Chargeable asset income', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Chargeable asset cost', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        state.businesses.push(newBiz);
        for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][newBiz.id] = []; }
        addAudit('business.add','business', newBiz.id, 'Added business');
      }
      saveState();
      closeModal(businessModal);
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      renderAll();
    });
    bizCancel.addEventListener('click', ()=>closeModal(businessModal));
    btnAddContact.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business first');
      const b = findBiz(selectedBizId);
      const name = (newContactName.value||'').trim();
      if(!name) return alert('Contact name required');
      b.contacts = b.contacts || [];
      b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true, wh[...]
      saveState();
      renderBizContacts(b);
    });

    // accounts modal
    btnManageAccounts.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      renderAccounts();
      openModal(accountsModal);
    });
    addAccountBtn.addEventListener('click', ()=> {
      const name = (newAccountName.value||'').trim();
      const cat = newAccountCategory.value;
      const dis = !!newAccountDisallowable.checked;
      const nt = !!newAccountNonTax.checked;
      const rentFreq = newAccountRentFreq.value || '';
      if(!name) return alert('Account name required');
      const b = findBiz(selectedBizId);
      b.accounts = b.accounts || [];
      b.accounts.push({ id: uid('acct'), name, category: cat, disallowableDefault:dis, nonTaxableDefault:nt, rentFreq:rentFreq });
      saveState();
      renderAccounts();
      populateAccountSelect();
    });
    closeAccountsBtn.addEventListener('click', ()=> closeModal(accountsModal));

    // transaction form behavior
    txnAction.addEventListener('change', ()=> {
      const val = txnAction.value;
      if(val === 'InventoryPurchase' || val === 'InventorySale'){
        mainTxnForm.style.display = 'none';
        inventorySubform.style.display = 'block';
        assetSubform.style.display = 'none';
        populateAccountSelect();
      } else if(val === 'FixedAssetPurchase' || val === 'FixedAssetDisposal'){
        mainTxnForm.style.display = 'none';
        assetSubform.style.display = 'block';
        inventorySubform.style.display = 'none';
        populateAccountSelect();
      } else {
        mainTxnForm.style.display = 'flex';
        inventorySubform.style.display = 'none';
        assetSubform.style.display = 'none';
      }
      renderFeatureVisibility();
    });
    txnWht.addEventListener('change', ()=> {
      const show = txnWht.checked;
      txnWhtRateLabel.style.display = show ? 'inline-flex' : 'none';
      txnWhtBasisLabel.style.display = show ? 'inline-flex' : 'none';
      if(show && !txnWhtRate.value){ txnWhtRate.value = findBiz(selectedBizId)?.whtRate || DEFAULTS.whtRate; }
    } );
    btnAddTxn.addEventListener('click', handleAddTransaction);

    // inventory
    btnAddInv.addEventListener('click', handleInventoryAction);
    btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnInvUndo.addEventListener('click', handleUndoInventory);

    // assets
    btnAddAsset.addEventListener('click', handleAddAsset);
    btnDisposeAsset.addEventListener('click', handleDisposeAsset);
    btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnAssetUndo.addEventListener('click', handleUndoAsset);

    // ledger search
    document.getElementById('btnSearch').addEventListener('click', renderLedger);
    document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

    // export/import/clear
    document.getElementById('btnExport').addEventListener('click', ()=> {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc_full_data.json'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const incoming = JSON.parse(r.result);
          if(!confirm('Import will replace current data. Continue?')) return;
          state = incoming;
          migrateState();
          refreshSelectors();
          ensureSelection();
          populateAccountSelect();
          resetForms();
          renderAll();
          saveState();
          alert('Import complete');
        } catch(err){ alert('Invalid JSON'); }
      };
      r.readAsText(f);
    });
    document.getElementById('btnClearAll').addEventListener('click', ()=> {
      if(!confirm('Clear all stored data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      state = { users:[], businesses:[], transactions:{}, attachments:{}, audit:[], auth:{ currentUserId:null } };
      seedDemo();
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      resetForms();
      renderAll();
    });

    // tabs
    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; renderTab(); });
    btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; renderTab(); });

    // Report tab handlers
    document.querySelectorAll('#reportsSection .tab').forEach(tb => {
      tb.addEventListener('click', (e) => {
        document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
        tb.classList.add('active');
        renderReport(tb.dataset.report);
      });
    });

    // exports from reports
    document.getElementById('btnExportCsv').addEventListener('click', ()=> exportCurrentReport('csv'));
    document.getElementById('btnExportPdf').addEventListener('click', ()=> exportCurrentReport('pdf'));
    document.getElementById('btnExportXlsx').addEventListener('click', ()=> exportCurrentReport('xlsx'));
  }

  // Helper finders
  function findUser(id){ return state.users.find(u=>u.id===id); }
  function findBiz(id){ return state.businesses.find(b=>b.id===id); }
  function findAccount(biz, acctId){ return (biz.accounts||[]).find(a=>a.id===acctId); }

  // UI: selection and refresh
  function refreshSelectors(){
    userSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); }
    businessSelect.innerHTML = '';
    for(const b of state.businesses){ const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name; businessSelect.appendChild(opt); }
    bizOwnerSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; bizOwnerSelect.appendChild(opt); }
  }
  function ensureSelection(){
    if(!selectedUserId && state.users[0]) selectedUserId = state.users[0].id;
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    userSelect.value = selectedUserId || (state.users[0] && state.users[0].id) || '';
    businessSelect.value = selectedBizId || (state.businesses[0] && state.businesses[0].id) || '';
    userSelect.addEventListener('change', ()=> { selectedUserId = userSelect.value; renderAll(); });
    businessSelect.addEventListener('change', ()=> { selectedBizId = businessSelect.value; populateAccountSelect(); renderAll(); renderFeatureVisibility(); });
    // set auth current user
    if(state.auth.currentUserId) selectedUserId = state.auth.currentUserId;
    userSelect.value = selectedUserId;
  }

  function populateAccountSelect(){
    txnAccount.innerHTML = '';
    invAccountSelect.innerHTML = '';
    assetPurchaseAccount.innerHTML = '';
    assetDisposalAccount.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of b.accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' ('+a.category+')';
      txnAccount.appendChild(opt);
      const opt2 = opt.cloneNode(true);
[...]

  /* -----------------------------------------------------------------------
     PAYE: per-contact PAYE calculations using PAYE_BANDS (Option A)
     - Annualises monthly transaction (assumes each salary txn is a monthly pay)
     - Applies statutory deductions (contact statutory overrides business defaults)
     - Computes annual PAYE using progressive bands, then divides back by 12
     - Stores computed fields on the transaction:
         txn.payeMonthly, txn.payeAnnual, txn.payeTaxableAnnual, txn.payeDeductionsAnnual
     - Aggregates and renders PAYE summary per contact in #taxSummary
     ----------------------------------------------------------------------- */

  // Compute progressive PAYE on an annual taxable amount using PAYE_BANDS
  function computeAnnualPAYEFromBands(annualTaxable) {
    let remaining = Math.max(0, Number(annualTaxable || 0));
    let prevCap = 0;
    let tax = 0;
    for (const band of PAYE_BANDS) {
      const bandLimit = band.upTo;
      const bandSize = bandLimit - prevCap;
      if (bandSize <= 0) { prevCap = bandLimit; continue; }
      const taxableInBand = Math.max(0, Math.min(remaining, bandSize));
      if (taxableInBand > 0) {
        tax += taxableInBand * (band.rate || 0);
        remaining -= taxableInBand;
      }
      prevCap = bandLimit;
      if (remaining <= 0) break;
    }
    return tax;
  }

  // Find contact object by name (case-insensitive) in a business; returns null if not found
  function findContactByName(biz, name) {
    if (!biz || !biz.contacts) return null;
    if (!name) return null;
    const n = String(name).trim().toLowerCase();
    return biz.contacts.find(c => (c.name && c.name.toLowerCase() === n) || (c.display && c.display.toLowerCase() === n) || (c.id && c.id === name)) || null;
  }

  // Determine if a transaction should be treated as salary for PAYE calculation
  function isSalaryTransaction(txn) {
    if (!txn) return false;
    if (txn.salary === true || txn.isSalary === true || txn.paye === true) return true;
    if (txn.salary === undefined && txn.accountName) {
      if (String(txn.accountName).toLowerCase().includes('salary') || String(txn.accountName).toLowerCase().includes('salar')) return true;
    }
    if (txn.description && String(txn.description).toLowerCase().includes('salary')) return true;
    // also allow explicit flag stored as txn.salaryFlag or txn.isPayroll
    if (txn.salaryFlag || txn.isPayroll) return true;
    return false;
  }

  // Given a single transaction and business, compute PAYE fields and attach them to txn
  // Assumes transaction amount is monthly gross pay (Option A)
  function computePAYEForTransaction(txn, biz) {
    if (!txn || !biz) return;
    if (!biz.payeEnabled) {
      // remove any previously computed if PAYE disabled
      delete txn.payeMonthly; delete txn.payeAnnual; delete txn.payeTaxableAnnual; delete txn.payeDeductionsAnnual; return;
    }
    if (!isSalaryTransaction(txn)) {
      delete txn.payeMonthly; delete txn.payeAnnual; delete txn.payeTaxableAnnual; delete txn.payeDeductionsAnnual; return;
    }

    const grossMonthly = Number(txn.amount || 0);
    // Annualise
    const annualGross = grossMonthly * 12;

    // statutory deductions: contact overrides business defaults
    let deductions = { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
    if (txn.contactName || txn.contact || txn.contactName === 0) {
      const contactName = txn.contactName || txn.contact || txn.contactName;
      const contact = findContactByName(biz, contactName);
      if (contact && contact.statutory) {
        deductions = Object.assign({}, deductions, {
          pension: Number(contact.statutory.pension || 0),
          rent: Number(contact.statutory.rent || 0),
          life: Number(contact.statutory.life || 0),
          mortgage: Number(contact.statutory.mortgage || 0),
          nhf: Number(contact.statutory.nhf || 0)
        });
      } else {
        // fallback to biz-level statutory
        const s = biz.statutoryDeductions || {};
        deductions = Object.assign({}, deductions, {
          pension: Number(s.pension || 0),
          rent: Number(s.rent || 0),
          life: Number(s.life || 0),
          mortgage: Number(s.mortgage || 0),
          nhf: Number(s.nhf || 0)
        });
      }
    } else {
      const s = biz.statutoryDeductions || {};
      deductions = Object.assign({}, deductions, {
        pension: Number(s.pension || 0),
        rent: Number(s.rent || 0),
        life: Number(s.life || 0),
        mortgage: Number(s.mortgage || 0),
        nhf: Number(s.nhf || 0)
      });
    }

    const totalAnnualDeductions = Object.values(deductions).reduce((a,b)=>a+Number(b||0),0);
    const taxableAnnual = Math.max(0, annualGross - totalAnnualDeductions);
    const annualPAYE = computeAnnualPAYEFromBands(taxableAnnual);
    const monthlyPAYE = annualPAYE / 12;

    // Attach computed values to transaction (do not disturb other fields)
    txn.payeMonthly = Number(monthlyPAYE);
    txn.payeAnnual = Number(annualPAYE);
    txn.payeTaxableAnnual = Number(taxableAnnual);
    txn.payeDeductionsAnnual = Number(totalAnnualDeductions);
    // also store which contact was used (normalized)
    txn.payeContactName = txn.contactName || txn.contact || txn.contactName || (txn.contact && txn.contact.name) || txn.contactName;
  }

  // Compute PAYE for all transactions in selected user/business (or optionally across all)
  function computePayeForSelected() {
    if (!selectedUserId || !selectedBizId) return;
    const txns = (state.transactions || {})[selectedUserId] && (state.transactions || {})[selectedUserId][selectedBizId];
    const biz = findBiz(selectedBizId);
    if (!txns || !Array.isArray(txns) || !biz) return;
    for (const t of txns) {
      // ensure contactName standard field exists for many transaction shapes
      if (!t.contactName && t.contact) t.contactName = t.contact;
      computePAYEForTransaction(t, biz);
    }
    saveState();
  }

  // Render PAYE summary into taxSummaryDiv (aggregated per contact)
  function renderPayeSummary() {
    if (!selectedUserId || !selectedBizId) { taxSummaryDiv.innerHTML = ''; return; }
    const txns = (state.transactions || {})[selectedUserId] && (state.transactions || {})[selectedUserId][selectedBizId];
    const biz = findBiz(selectedBizId);
    if (!txns || !Array.isArray(txns) || !biz) { taxSummaryDiv.innerHTML = ''; return; }

    // aggregate
    const perContact = {};
    let totalPayeMonthly = 0;
    let totalPayeAnnual = 0;
    for (const t of txns) {
      if (t.payeMonthly && Number(t.payeMonthly) > 0) {
        const contactKey = (t.payeContactName || t.contactName || t.contact || 'Unknown').toString();
        perContact[contactKey] = perContact[contactKey] || { monthly:0, annual:0, count:0, deductionsAnnual:0, taxableAnnual:0 };
        perContact[contactKey].monthly += Number(t.payeMonthly || 0);
        perContact[contactKey].annual += Number(t.payeAnnual || 0);
        perContact[contactKey].deductionsAnnual += Number(t.payeDeductionsAnnual || 0);
        perContact[contactKey].taxableAnnual += Number(t.payeTaxableAnnual || 0);
        perContact[contactKey].count += 1;
        totalPayeMonthly += Number(t.payeMonthly || 0);
        totalPayeAnnual += Number(t.payeAnnual || 0);
      }
    }

    // Build HTML
    let html = '<h4 style="margin:4px 0;">PAYE Summary (per contact)</h4>';
    if (Object.keys(perContact).length === 0) {
      html += '<div class="small-muted">No PAYE salary transactions found for this business.</div>';
      // fall back to existing taxSummary if present (do not remove)
      taxSummaryDiv.innerHTML = html;
      return;
    }
    html += '<table style="width:100%;border-collapse:collapse;">';
    html += '<thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e6e6e6;">Contact</th><th style="padding:6px;border-bottom:1px solid #e6e6e6;">Monthly PAYE (₦)</th><th style="padding:6px;border-bottom:1px solid #e6e6e6;">Annual PAYE (₦)</th><th style="padding:6px;border-bottom:1px solid #e6e6e6;">Taxable (annual) (₦)</th><th style="padding:6px;border-bottom:1px solid #e6e6e6;">Deductions (annual) (₦)</th><th style="padding:6px;border-bottom:1px solid #e6e6e6;">Records</th></tr></thead>';
    html += '<tbody>';
    for (const [cName, data] of Object.entries(perContact)) {
      html += `<tr><td style="padding:6px;border-bottom:1px solid #f0f0f0;">${escapeHtml(cName)}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0;">${fmt(data.monthly)}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0;">${fmt(data.annual)}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0;">${fmt(data.taxableAnnual)}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0;">${fmt(data.deductionsAnnual)}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0;">${data.count}</td></tr>`;
    }
    html += '</tbody>';
    html += '<tfoot><tr><td style="padding:6px;border-top:1px solid #e6e6e6;font-weight:bold;">Total</td><td style="padding:6px;border-top:1px solid #e6e6e6;font-weight:bold;">' + fmt(totalPayeMonthly) + '</td><td style="padding:6px;border-top:1px solid #e6e6e6;font-weight:bold;">' + fmt(totalPayeAnnual) + '</td><td colspan="3" style="padding:6px;border-top:1px solid #e6e6e6;"></td></tr></tfoot>';
    html += '</table>';
    taxSummaryDiv.innerHTML = html;
  }

  // Simple HTML escape for contact names
  function escapeHtml(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str).replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }

  // Hook into app lifecycle:
  // - compute PAYE for selected business on load
  // - recompute and render PAYE after transactions added/modified
  // Add a small delay when called from event handlers to allow other handlers (saving txns) to complete.
  function debounceComputeAndRender(delay = 80) {
    if (debounceComputeAndRender._t) clearTimeout(debounceComputeAndRender._t);
    debounceComputeAndRender._t = setTimeout(() => {
      computePayeForSelected();
      renderPayeSummary();
    }, delay);
  }

  // call on initial load to compute based on demo data or imported state
  debounceComputeAndRender(120);

  // Recompute after adding a transaction (btnAddTxn handler runs first then this)
  btnAddTxn.addEventListener('click', () => debounceComputeAndRender(120));

  // Recompute when selection changes
  userSelect.addEventListener('change', () => debounceComputeAndRender(80));
  businessSelect.addEventListener('change', () => debounceComputeAndRender(80));

  // For safety, call compute/render periodically when the ledger is rendered elsewhere:
  // Wrap the original renderAll if present (preserve original behavior)
  if (typeof renderAll === 'function') {
    const originalRenderAll = renderAll;
    renderAll = function() {
      const res = originalRenderAll.apply(this, arguments);
      // ensure PAYE computed and summary rendered after main render
      debounceComputeAndRender(40);
      return res;
    };
  }

  // Also expose a manual recalculation function for debugging
  window.recomputePAYEForSelected = function() { computePayeForSelected(); renderPayeSummary(); };

  /* End PAYE additions */
  </script>
</body>
</html>
----- end updated index.html -----

Notes and assumptions:
- I used Option A: each salary transaction is considered a monthly pay. If your transactions represent weekly, fortnightly, or annual amounts you'll need to change the annualisation factor (currently ×12).
- The code applies a contact-level statutory object (contact.statutory) when present, otherwise falls back to biz.statutoryDeductions.
- Computed values are stored on transactions as:
  - txn.payeMonthly (monthly PAYE)
  - txn.payeAnnual (annual PAYE)
  - txn.payeTaxableAnnual (annual taxable pay after deductions)
  - txn.payeDeductionsAnnual (sum of annual statutory deductions used)
  - txn.payeContactName (normalized contact name used)
- The PAYE summary is shown in the existing #taxSummary area; if there were existing tax summary code also writing to that div you may see the PAYE summary replace it. If you want it displayed alongside existing tax summary lines, we can merge them instead — tell me and I will adjust.
- I intentionally did not alter your existing transaction-saving flows; instead I compute PAYE after transactions are added and when selections change.

If you'd like any of these adjustments (different pay period assumption, show PAYE details in the ledger rows, include PAYE in payroll reports, or keeping the original taxSummary output and appending PAYE), tell me which and I'll update the file.
