<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Multi-User Accounting & Tax — Full Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,96vw); max-height:84vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted-pill { background:#f2f4f7; padding:4px 8px; border-radius:6px; font-size:0.9rem; color:#333; }
    .disabled { opacity:0.45; pointer-events:none; }
    .code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f3f5f7; padding:4px 6px; border-radius:4px; }
  </style>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax Engine — Prototype</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
      </div>
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
            <option value="BankPayment">Bank Payment</option>
            <option value="BankReceipt">Bank Receipt</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small primary">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>

          <label>Classification:
            <select id="assetClassification">
              <option value="Fixed">Fixed</option>
              <option value="Chargeable">Chargeable</option>
            </select>
          </label>

          <label>Depreciation rate % (annual): <input type="number" id="assetDepRate" class="smallInput" min="0" step="0.01" /></label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small primary">Record Asset Purchase</button>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days. Capital allowance applied monthly from purchase.</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable/Receivable</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Fixed Assets Report</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
        <button id="btnExportXlsx" class="small">Export XLSX (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <!-- User modal -->
  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <!-- Business modal -->
  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (SoleTrader), that will override these values for PIT.</small>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add a contact with type "SoleTrader" (or name "Sole trader") and set statutory deductions there if you want PIT to use per-sole-trader deductions.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <!-- Accounts modal -->
  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="max-height:360px; overflow:auto;"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountDisallowable" /> Disallowable</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountNonTax" /> Non-taxable</label>
      <select id="newAccountRentFreq">
        <option value="">Rent freq</option>
        <option value="monthly">Monthly rent</option>
        <option value="yearly">Yearly rent</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">GitHub Copilot Chat Assistant — prototype stores data in localStorage (ntc_full_accounting_v1)</footer>

  <script>
  /************************************************************************
   * Nigeria Multi-User Multi-Business Accounting & Tax Engine (Prototype)
   * Single-file SPA
   * Storage key: ntc_full_accounting_v1
   *
   * Features implemented:
   * - Multi-user, multi-business, per-user permissions
   * - Chart of accounts with disallowable/non-taxable flags and rent freq
   * - Transactions: revenue, expense, inventory (weighted avg COGS), fixed assets (Fixed vs Chargeable)
   * - Receipts attached and viewable (base64 stored)
   * - Fixed asset depreciation (straight-line monthly prorated), capital allowance monthly
   * - Tax engine: VAT (inclusive/exclusive), WHT (gross/net), PAYE, PIT, CIT, with rules described by user
   * - Chargeable gains/losses: classification, carry-forward logic
   * - Reports: P&L snapshot, tax summary, VAT, WHT, PAYE breakdown, assets schedule, inventory
   * - Exports: JSON import/export, CSV, PDF, XLSX (SheetJS)
   *
   * Note: This is a frontend-local prototype. Attachments are stored in localStorage as base64 strings.
   ************************************************************************/

  // Constants & defaults
  const STORAGE_KEY = 'ntc_full_accounting_v1';
  const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, caRateDefault:20.0, depRateDefault:20.0 };
  const PAYE_BANDS = [
    { upTo: 800000, rate: 0.00 },
    { upTo: 3000000, rate: 0.15 },   // 800k..3,000,000 => next 2.2m @15%
    { upTo: 12000000, rate: 0.18 },
    { upTo: 25000000, rate: 0.21 },
    { upTo: 50000000, rate: 0.23 },
    { upTo: Infinity, rate: 0.25 }
  ];
  const CIT_TURNOVER_THRESHOLD = 50000000; // 50,000,000

  // App state
  let state = {
    users: [], businesses: [], transactions: {}, attachments: {}, audit: [], auth: { currentUserId: null },
  };
  let selectedUserId = null;
  let selectedBizId = null;
  let activeTab = 'ledger';
  let inventoryHistory = [];
  let assetHistory = [];

  // DOM refs
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const txnReceipt = document.getElementById('txnReceipt');
  const btnAddTxn = document.getElementById('btnAddTxn');
  const mainTxnForm = document.getElementById('mainTxnForm');

  const inventorySubform = document.getElementById('inventorySubform');
  const invItemSelect = document.getElementById('invItemSelect');
  const invNewName = document.getElementById('invNewName');
  const invAccountSelect = document.getElementById('invAccountSelect');
  const invQty = document.getElementById('invQty');
  const invUnitPrice = document.getElementById('invUnitPrice');
  const invVatType = document.getElementById('invVatType');
  const invContact = document.getElementById('invContact');
  const invReceipt = document.getElementById('invReceipt');
  const btnAddInv = document.getElementById('btnAddInv');
  const btnInvCancel = document.getElementById('btnInvCancel');
  const btnInvUndo = document.getElementById('btnInvUndo');

  const assetSubform = document.getElementById('assetSubform');
  const assetName = document.getElementById('assetName');
  const assetCost = document.getElementById('assetCost');
  const assetPurchaseDate = document.getElementById('assetPurchaseDate');
  const assetLife = document.getElementById('assetLife');
  const assetCA = document.getElementById('assetCA');
  const assetDisposalDate = document.getElementById('assetDisposalDate');
  const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
  const btnAddAsset = document.getElementById('btnAddAsset');
  const btnDisposeAsset = document.getElementById('btnDisposeAsset');
  const btnAssetCancel = document.getElementById('btnAssetCancel');
  const btnAssetUndo = document.getElementById('btnAssetUndo');
  const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
  const assetDisposalAccount = document.getElementById('assetDisposalAccount');
  const assetClassification = document.getElementById('assetClassification');
  const assetDepRate = document.getElementById('assetDepRate');
  const assetContact = document.getElementById('assetContact');
  const assetReceipt = document.getElementById('assetReceipt');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const ledgerSection = document.getElementById('ledgerSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');

  const modalOverlay = document.getElementById('modalOverlay');
  const userModal = document.getElementById('userModal');
  const userModalTitle = document.getElementById('userModalTitle');
  const userName = document.getElementById('userName');
  const userDisplay = document.getElementById('userDisplay');
  const userRole = document.getElementById('userRole');
  const permView = document.getElementById('permView');
  const permEdit = document.getElementById('permEdit');
  const permDelete = document.getElementById('permDelete');
  const userSave = document.getElementById('userSave');
  const userCancel = document.getElementById('userCancel');

  const businessModal = document.getElementById('businessModal');
  const businessModalTitle = document.getElementById('businessModalTitle');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
  const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizCapitalBF = document.getElementById('bizCapitalBF');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');

  const accountsModal = document.getElementById('accountsModal');
  const accountsList = document.getElementById('accountsList');
  const newAccountName = document.getElementById('newAccountName');
  const newAccountCategory = document.getElementById('newAccountCategory');
  const newAccountDisallowable = document.getElementById('newAccountDisallowable');
  const newAccountNonTax = document.getElementById('newAccountNonTax');
  const newAccountRentFreq = document.getElementById('newAccountRentFreq');
  const addAccountBtn = document.getElementById('addAccountBtn');
  const closeAccountsBtn = document.getElementById('closeAccountsBtn');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnReportsTab = document.getElementById('btnReportsTab');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
  function toISO(date){ if(!date) return null; return new Date(date).toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }

  function calcPAYEForSalary(biz, contactNameOrId, grossAmount, period = 'monthly'){
    // determine gross annual
    const gross = Number(grossAmount || 0);
    const grossAnnual = (period === 'yearly') ? gross : gross * 12;

    // find contact by id or name (case-insensitive)
    let contact = null;
    if(!biz || !biz.contacts) contact = null;
    else {
      contact = biz.contacts.find(c => c.id === contactNameOrId) || biz.contacts.find(c => (c.name||'').toLowerCase() === (contactNameOrId||'').toLowerCase());
    }
    const sd = (contact && contact.statutory) ? contact.statutory : (biz && biz.statutoryDeductions) ? biz.statutoryDeductions : { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
    const pensionAnnual = Number(sd.pension || 0);
    const rentAnnual = Number(sd.rent || 0);
    const lifeAnnual = Number(sd.life || 0);
    const mortgageAnnual = Number(sd.mortgage || 0);
    const nhfAnnual = Number(sd.nhf || 0);

    const totalDeductions = pensionAnnual + rentAnnual + lifeAnnual + mortgageAnnual + nhfAnnual;
    const taxableAnnual = Math.max(0, grossAnnual - totalDeductions);

    // apply progressive PAYE_BANDS
    let remaining = taxableAnnual;
    let lower = 0;
    let taxAnnual = 0;
    for(const band of PAYE_BANDS){
      const upper = band.upTo;
      const rate = Number(band.rate || 0);
      const bandWidth = (upper === Infinity) ? Infinity : Math.max(0, upper - lower);
      const portion = Math.min(remaining, bandWidth);
      if(portion <= 0) break;
      taxAnnual += portion * rate;
      remaining -= portion;
      lower = upper;
      if(remaining <= 0) break;
    }

    return {
      grossAnnual, taxableAnnual, taxAnnual,
      taxMonthly: taxAnnual / 12,
      deductions: { pensionAnnual, rentAnnual, lifeAnnual, mortgageAnnual, nhfAnnual },
      contactId: contact ? contact.id : null
    };
  }

  // load/save
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }
  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || { currentUserId: null };
    state.businesses.forEach(b => {
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
      b.accounts = b.accounts || [];
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
    });
    // ensure transactions map for each user and business
    for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; for(const b of state.businesses){ state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || []; } }
    saveState();
  }

  function seedDemo(){
    const u = uid('user'), b = uid('biz');
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const rent = { id: uid('acct'), name: 'Rent', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false, rentFreq:'monthly' };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false };
    const chargeInc = { id: uid('acct'), name: 'Chargeable asset income', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const chargeCost = { id: uid('acct'), name: 'Chargeable asset cost', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };

    state = {
      users: [{ id: u, username: 'admin', display:'Admin User', role:'Admin', isAdmin:true, permissions:{ view:true, edit:true, delete:true } }],
      businesses: [{
        id: b,
        name: 'Demo Business',
        ownerId: u,
        entity: 'Company',
        vatRate: DEFAULTS.vatRate,
        whtRate: DEFAULTS.whtRate,
        citRate: DEFAULTS.citRate,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault,
        depRateDefault: DEFAULTS.depRateDefault,
        accounts: [sales, cogs, salaries, rent, bank, chargeInc, chargeCost],
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [
          // Fixed asset
          { id: uid('asset'), name: 'Office PC', cost: 150000, purchaseDate: today(), lifeYears: 5, caPercent: 20, depRate: 20, classification: 'Fixed', accumulatedDep:0, disposed:false, disposal:{}, notes:'' },
          // Chargeable asset sample (disposed with loss)
          { id: uid('asset'), name: 'Land Plot', cost: 2000000, purchaseDate: '2020-01-01', lifeYears: 20, caPercent: 5, depRate: 0, classification: 'Chargeable', accumulatedDep:0, disposed:false, disposal:{}, notes:'Chargeable asset example' }
        ],
        contacts: [{ id: uid('c'), name:'John Employee', type:'Employee', statutory:{ pension: 20000, rent: 120000, life: 5000, mortgage: 100000, nhf: 5000 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:false, whtRate:5 } }],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward: 150000, caCarryForward: 50000, capitalBroughtForward: 0,
        defaultExpenseDisallowable:false, defaultRevenueNonTax:false,
        firsLabel: ''
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: u }
    };
    // initialize transactions map
    state.transactions[u] = {};
    state.transactions[u][b] = [
      // sample revenue (with VAT exclusive)
      { id: uid('txn'), date: today(), action: 'Revenue', accountId: sales.id, accountName: sales.name, accountCategory: sales.category, description: 'Demo sale', amount: 150000, vatType:'exclusive', vatAmount: (150000 * DEFAULTS.vatRate/100), whtApplied:false, whtAmount:0, paye:false, contactName:'Customer A', receiptId:null, createdBy:u, createdAt:new Date().toISOString() },
      // sample salary (PAYE)
      { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, accountCategory: salaries.category, description: 'Demo salary', amount: 50000, vatType:'none', vatAmount:0, whtApplied:false, whtAmount:0, paye:true, contactName:'John Employee', receiptId:null, createdBy:u, createdAt:new Date().toISOString() },
      // inventory purchase
      { id: uid('txn'), date: today(), action: 'InventoryPurchase', accountId: cogs.id, accountName: cogs.name, accountCategory: cogs.category, description: 'Purchase widgets', qty:50, unitPrice:520, amount: 50*520, vatType:'exclusive', vatAmount: (50*520*DEFAULTS.vatRate/100), whtApplied:false, whtAmount:0, paye:false, contactName:'Vendor X', receiptId:null, createdBy:u, createdAt:new Date().toISOString() }
    ];
    addAudit('seed','system','',`Seeded demo data`);
    saveState();
  }

  // audit
  function addAudit(type, entityType, entityId, details){
    const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details };
    state.audit = state.audit || [];
    state.audit.push(entry);
    saveState();
  }

  // modal helpers
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
  modalOverlay.addEventListener('click', ()=> { [userModal, businessModal, accountsModal].forEach(m => { if(m.style.display==='block') closeModal(m); }); });

  // initialization
  loadState();
  initUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  function initUI(){
    // Users
    btnAddUser.addEventListener('click', ()=> openUserModal());
    btnEditUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); openUserModal(selectedUserId); });
    btnDeleteUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); if(!confirm('Delete user? This cannot be undone')) return; deleteUser(selectedUserId); });
    userSave.addEventListener('click', ()=> {
      const username = (userName.value||'').trim();
      if(!username) return alert('Username required');
      const editId = userSave.dataset.edit;
      if(editId){
        const u = state.users.find(x=>x.id===editId);
        u.username = username; u.display = userDisplay.value || username; u.role = userRole.value;
        u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked };
        addAudit('user.edit','user',u.id,'Edited user');
      } else {
        const newUser = { id: uid('user'), username, display: userDisplay.value || username, role: userRole.value, isAdmin: userRole.value==='Admin', permissions: { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked } };
        state.users.push(newUser);
        // ensure transactions map
        state.transactions[newUser.id] = state.transactions[newUser.id] || {};
        for(const b of state.businesses) state.transactions[newUser.id][b.id] = state.transactions[newUser.id][b.id] || [];
        addAudit('user.add','user',newUser.id,'Added user');
      }
      saveState();
      closeModal(userModal);
      refreshSelectors();
      ensureSelection();
      renderAll();
    });
    userCancel.addEventListener('click', ()=> closeModal(userModal));

    // Business
    btnAddBusiness.addEventListener('click', ()=> {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = ''; bizOwnerSelect.value = state.users[0] ? state.users[0].id : '';
      bizEntity.value = 'Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate;
      bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
      bizSave.dataset.edit = '';
      bizContactsList.innerHTML = '';
      openModal(businessModal);
    });
    btnEditBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const b = findBiz(selectedBizId); if(!b) return alert('Business not found');
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (state.users[0] && state.users[0].id) || '';
      bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
      bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled;
      bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0; bizCapitalBF.value = b.capitalBroughtForward || 0;
      bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax;
      bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
      bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0;
      bizCapitalBF.value = b.capitalBroughtForward || 0;
      renderBizContacts(b);
      bizSave.dataset.edit = b.id;
      openModal(businessModal);
    });
    btnDeleteBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      if(!confirm('Delete business and all its transactions/attachments?')) return;
      deleteBusiness(selectedBizId);
    });
    bizSave.addEventListener('click', ()=> {
      const name = (bizName.value||'').trim();
      if(!name) return alert('Business name required');
      const editId = bizSave.dataset.edit;
      if(editId){
        const b = findBiz(editId);
        if(!b) return alert('Business not found');
        b.name = name; b.ownerId = bizOwnerSelect.value; b.entity = bizEntity.value;
        b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
        b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked;
        b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0); b.capitalBroughtForward = Number(bizCapitalBF.value || 0);
        b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked;
        b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) };
        addAudit('business.edit','business', b.id, 'Edited business');
      } else {
        const newBiz = {
          id: uid('biz'), name, ownerId: bizOwnerSelect.value || (state.users[0] && state.users[0].id),
          entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate),
          vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
          accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
          lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS.depRateDefault
        };
        // default accounts
        newBiz.accounts.push({ id: uid('acct'), name:'Sales', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Bank', category:'Asset', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Chargeable asset income', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Chargeable asset cost', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        state.businesses.push(newBiz);
        for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][newBiz.id] = []; }
        addAudit('business.add','business', newBiz.id, 'Added business');
      }
      saveState();
      closeModal(businessModal);
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      renderAll();
    });
    bizCancel.addEventListener('click', ()=>closeModal(businessModal));
    btnAddContact.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business first');
      const b = findBiz(selectedBizId);
      const name = (newContactName.value||'').trim();
      if(!name) return alert('Contact name required');
      b.contacts = b.contacts || [];
      b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true, whtRate: b.whtRate } });
      saveState();
      renderBizContacts(b);
    });

    // accounts modal
    btnManageAccounts.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      renderAccounts();
      openModal(accountsModal);
    });
    addAccountBtn.addEventListener('click', ()=> {
      const name = (newAccountName.value||'').trim();
      const cat = newAccountCategory.value;
      const dis = !!newAccountDisallowable.checked;
      const nt = !!newAccountNonTax.checked;
      const rentFreq = newAccountRentFreq.value || '';
      if(!name) return alert('Account name required');
      const b = findBiz(selectedBizId);
      b.accounts = b.accounts || [];
      b.accounts.push({ id: uid('acct'), name, category: cat, disallowableDefault:dis, nonTaxableDefault:nt, rentFreq:rentFreq });
      saveState();
      renderAccounts();
      populateAccountSelect();
    });
    closeAccountsBtn.addEventListener('click', ()=> closeModal(accountsModal));

    // transaction form behavior
    txnAction.addEventListener('change', ()=> {
      const val = txnAction.value;
      if(val === 'InventoryPurchase' || val === 'InventorySale'){
        mainTxnForm.style.display = 'none';
        inventorySubform.style.display = 'block';
        assetSubform.style.display = 'none';
        populateAccountSelect();
      } else if(val === 'FixedAssetPurchase' || val === 'FixedAssetDisposal'){
        mainTxnForm.style.display = 'none';
        assetSubform.style.display = 'block';
        inventorySubform.style.display = 'none';
        populateAccountSelect();
      } else {
        mainTxnForm.style.display = 'flex';
        inventorySubform.style.display = 'none';
        assetSubform.style.display = 'none';
      }
      renderFeatureVisibility();
    });
    txnWht.addEventListener('change', ()=> {
      const show = txnWht.checked;
      txnWhtRateLabel.style.display = show ? 'inline-flex' : 'none';
      txnWhtBasisLabel.style.display = show ? 'inline-flex' : 'none';
      if(show && !txnWhtRate.value){ txnWhtRate.value = findBiz(selectedBizId)?.whtRate || DEFAULTS.whtRate; }
    } );
    btnAddTxn.addEventListener('click', handleAddTransaction);

    // inventory
    btnAddInv.addEventListener('click', handleInventoryAction);
    btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnInvUndo.addEventListener('click', handleUndoInventory);

    // assets
    btnAddAsset.addEventListener('click', handleAddAsset);
    btnDisposeAsset.addEventListener('click', handleDisposeAsset);
    btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnAssetUndo.addEventListener('click', handleUndoAsset);

    // ledger search
    document.getElementById('btnSearch').addEventListener('click', renderLedger);
    document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

    // export/import/clear
    document.getElementById('btnExport').addEventListener('click', ()=> {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc_full_data.json'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const incoming = JSON.parse(r.result);
          if(!confirm('Import will replace current data. Continue?')) return;
          state = incoming;
          migrateState();
          refreshSelectors();
          ensureSelection();
          populateAccountSelect();
          resetForms();
          renderAll();
          saveState();
          alert('Import complete');
        } catch(err){ alert('Invalid JSON'); }
      };
      r.readAsText(f);
    });
    document.getElementById('btnClearAll').addEventListener('click', ()=> {
      if(!confirm('Clear all stored data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      state = { users:[], businesses:[], transactions:{}, attachments:{}, audit:[], auth:{ currentUserId:null } };
      seedDemo();
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      resetForms();
      renderAll();
    });

    // tabs
    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; renderTab(); });
    btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; renderTab(); });

    // Report tab handlers
    document.querySelectorAll('#reportsSection .tab').forEach(tb => {
      tb.addEventListener('click', (e) => {
        document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
        tb.classList.add('active');
        renderReport(tb.dataset.report);
      });
    });

    // exports from reports
    document.getElementById('btnExportCsv').addEventListener('click', ()=> exportCurrentReport('csv'));
    document.getElementById('btnExportPdf').addEventListener('click', ()=> exportCurrentReport('pdf'));
    document.getElementById('btnExportXlsx').addEventListener('click', ()=> exportCurrentReport('xlsx'));
  }

  // Helper finders
  function findUser(id){ return state.users.find(u=>u.id===id); }
  function findBiz(id){ return state.businesses.find(b=>b.id===id); }
  function findAccount(biz, acctId){ return (biz.accounts||[]).find(a=>a.id===acctId); }

  // UI: selection and refresh
  function refreshSelectors(){
    userSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); }
    businessSelect.innerHTML = '';
    for(const b of state.businesses){ const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name; businessSelect.appendChild(opt); }
    bizOwnerSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; bizOwnerSelect.appendChild(opt); }
  }
  function ensureSelection(){
    if(!selectedUserId && state.users[0]) selectedUserId = state.users[0].id;
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    userSelect.value = selectedUserId || (state.users[0] && state.users[0].id) || '';
    businessSelect.value = selectedBizId || (state.businesses[0] && state.businesses[0].id) || '';
    userSelect.addEventListener('change', ()=> { selectedUserId = userSelect.value; renderAll(); });
    businessSelect.addEventListener('change', ()=> { selectedBizId = businessSelect.value; populateAccountSelect(); renderAll(); renderFeatureVisibility(); });
    // set auth current user
    if(state.auth.currentUserId) selectedUserId = state.auth.currentUserId;
    userSelect.value = selectedUserId;
  }

  function populateAccountSelect(){
    txnAccount.innerHTML = '';
    invAccountSelect.innerHTML = '';
    assetPurchaseAccount.innerHTML = '';
    assetDisposalAccount.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of b.accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' ('+a.category+')';
      txnAccount.appendChild(opt);
      const opt2 = opt.cloneNode(true);
      invAccountSelect.appendChild(opt2);
      assetPurchaseAccount.appendChild(opt.cloneNode(true));
      assetDisposalAccount.appendChild(opt.cloneNode(true));
    }
    // populate inventory items
    invItemSelect.innerHTML = '';
    for(const it of (b.inventory||[])){ const o = document.createElement('option'); o.value = it.id; o.textContent = it.name + ' (qty:'+it.qty+', avg:'+fmt(it.avgCost)+')'; invItemSelect.appendChild(o); }
    // populate assets contacts
    assetPurchaseAccount.value = (b.accounts[0] && b.accounts[0].id) || '';
    assetDisposalAccount.value = (b.accounts[0] && b.accounts[0].id) || '';
  }

  function resetForms(){
    txnDate.value = today();
    txnAction.value = '';
    txnAccount.value = txnAccount.options[0] ? txnAccount.options[0].value : '';
    txnDesc.value = '';
    txnAmount.value = '';
    txnVatType.value = 'none';
    txnWht.checked = false;
    txnWhtRate.value = '';
    txnWhtBasis.value = 'gross';
    txnSalary.checked = false;
    txnContact.value = '';
    txnReceipt.value = '';
    invNewName.value=''; invQty.value=''; invUnitPrice.value=''; invContact.value=''; invReceipt.value='';
    assetName.value=''; assetCost.value=''; assetPurchaseDate.value=''; assetLife.value=''; assetCA.value=''; assetDisposalDate.value=''; assetDisposalProceeds.value=''; assetContact.value=''; assetReceipt.value='';
    assetClassification.value = 'Fixed';
    assetDepRate.value = '';
  }

  function openUserModal(editId){
    userModalTitle.textContent = editId ? 'Edit User' : 'Add User';
    if(editId){
      const u = findUser(editId);
      if(!u) return alert('User not found');
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userRole.value = u.role || 'User';
      permView.checked = !!u.permissions?.view; permEdit.checked = !!u.permissions?.edit; permDelete.checked = !!u.permissions?.delete;
      userSave.dataset.edit = u.id;
    } else {
      userName.value = ''; userDisplay.value=''; userRole.value='User'; permView.checked=true; permEdit.checked=true; permDelete.checked=false;
      userSave.dataset.edit = '';
    }
    openModal(userModal);
  }

  function deleteUser(id){
    if(!confirm('Delete user and all their transaction references?')) return;
    state.users = state.users.filter(u=>u.id!==id);
    delete state.transactions[id];
    saveState();
    refreshSelectors();
    ensureSelection();
    renderAll();
  }

  function deleteBusiness(id){
    state.businesses = state.businesses.filter(b=>b.id!==id);
    for(const uid of Object.keys(state.transactions)){ if(state.transactions[uid]) delete state.transactions[uid][id]; }
    saveState();
    refreshSelectors();
    ensureSelection();
    renderAll();
  }

  function renderBizContacts(b){
    bizContactsList.innerHTML = '';
    if(!b) return;
    for(const c of b.contacts || []){
      const div = document.createElement('div'); div.className='account-row';
      div.innerHTML = `<div><strong>${c.name}</strong> <span class="small-muted">(${c.type})</span></div>
        <div style="display:flex;gap:6px;align-items:center;">
          <button class="small" data-id="${c.id}" data-action="edit">Edit</button>
          <button class="small danger" data-id="${c.id}" data-action="del">Delete</button>
        </div>`;
      bizContactsList.appendChild(div);
      div.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
        const name = prompt('Contact name', c.name);
        if(name===null) return;
        c.name = name;
        saveState(); renderBizContacts(b);
      });
      div.querySelector('[data-action="del"]').addEventListener('click', ()=>{
        if(!confirm('Delete contact?')) return;
        b.contacts = b.contacts.filter(x=>x.id!==c.id);
        saveState(); renderBizContacts(b);
      });
    }
  }

  function renderAccounts(){
    accountsList.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of b.accounts){
      const div = document.createElement('div'); div.className='account-row';
      div.innerHTML = `<div><strong>${a.name}</strong> <span class="small-muted">(${a.category})</span> ${a.disallowableDefault?'<span class="flag">Disallowable</span>':''} ${a.nonTaxableDefault?'<span class="flag">Non-taxable</span>':''} ${a.rentFreq?'<span class="small-muted">/'+a.rentFreq+'</span>':''}</div>
        <div style="display:flex;gap:6px;"><button class="small" data-id="${a.id}" data-action="edit">Edit</button><button class="small danger" data-id="${a.id}" data-action="del">Delete</button></div>`;
      accountsList.appendChild(div);
      div.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
        const name = prompt('Account name', a.name); if(name===null) return;
        a.name = name; saveState(); renderAccounts(); populateAccountSelect();
      });
      div.querySelector('[data-action="del"]').addEventListener('click', ()=> {
        if(!confirm('Delete account?')) return;
        b.accounts = b.accounts.filter(x=>x.id!==a.id);
        saveState(); renderAccounts(); populateAccountSelect();
      });
    }
  }

  // TRANSACTIONS handling
  function handleAddTransaction(){
    if(!selectedUserId || !selectedBizId) return alert('Select user and business first');
    const b = findBiz(selectedBizId);
    if(!b) return alert('Business not found');
    const action = txnAction.value || 'Revenue';
    const acctId = txnAccount.value;
    const account = findAccount(b, acctId);
    const amount = Number(txnAmount.value || 0);
    if(!account && action!=='InventoryPurchase' && action!=='InventorySale') return alert('Select an account');
    const date = txnDate.value || today();
    const desc = txnDesc.value || '';
    const contactName = txnContact.value || '';
    const paye = !!txnSalary.checked;
    let vatType = txnVatType.value || 'none';
    let vatAmount = 0;
    if(vatType === 'exclusive'){ vatAmount = amount * (b.vatRate/100); }
    else if(vatType === 'inclusive'){ vatAmount = amount - (amount / (1 + (b.vatRate/100))); }
    // WHT
    let whtApplied = !!txnWht.checked;
    let whtRate = Number(txnWhtRate.value || b.whtRate || DEFAULTS.whtRate);
    let whtBasis = txnWhtBasis.value || 'gross';
    let whtAmount = 0;
    if(whtApplied){
      if(whtBasis === 'gross'){ whtAmount = amount * (whtRate/100); }
      else { // net basis: net amount provided, formula -> withheld portion = (net/(1-rate))*rate
        const r = whtRate/100;
        whtAmount = ((amount / (1 - r)) * r);
      }
    }
    // receipt
    let receiptId = null;
    const fileInput = txnReceipt;
    if(fileInput && fileInput.files && fileInput.files[0]){
      const f = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e){
        const base = e.target.result;
        receiptId = uid('att');
        state.attachments[receiptId] = { id: receiptId, name: f.name, data: base, uploadedAt: new Date().toISOString() };
        saveState();
        // continue after saving attachment (for UX we will store transaction after attachment read)
        addTxnRecord();
      };
      reader.readAsDataURL(f);
    } else {
      addTxnRecord();
    }

    function addTxnRecord(){
      const tx = { id: uid('txn'), date, action, accountId: acctId, accountName: account ? account.name : '', accountCategory: account ? account.category : '', description: desc, amount, vatType, vatAmount, whtApplied, whtAmount, whtRate, whtBasis, paye, contactName, receiptId, createdBy:selectedUserId, createdAt:new Date().toISOString() };
      
      // If this is a salary / PAYE transaction, compute PAYE using contact statutory deductions
      if(txnSalary && txnSalary.checked){
        const b = findBiz(selectedBizId);
        const gross = Number(tx.amount || 0); // amount entered is treated as monthly salary
        const payroll = calcPAYEForSalary(b, txnContact.value || '', gross, 'monthly');
        tx.paye = Number((payroll.taxMonthly || 0).toFixed(2));
        tx.payeAnnual = Number((payroll.taxAnnual || 0).toFixed(2));
        tx.payeTaxableAnnual = Number((payroll.taxableAnnual || 0).toFixed(2));
        tx.payeContactId = payroll.contactId;
      }
      
      state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
      state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
      state.transactions[selectedUserId][selectedBizId].push(tx);
      addAudit('txn.add','transaction', tx.id, `Added transaction ${tx.action} ${fmt(tx.amount)}`);
      saveState();
      resetForms();
      renderAll();
    }
  }

  // INVENTORY handling: weighted average
  function handleInventoryAction(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const isNew = (invNewName.value||'').trim();
    let item;
    if(isNew){
      item = { id: uid('item'), name: isNew, qty:0, avgCost: Number(invUnitPrice.value || 0) };
      b.inventory = b.inventory || [];
      b.inventory.push(item);
    } else {
      item = b.inventory.find(x=>x.id === invItemSelect.value);
      if(!item) return alert('Select an item or enter a new item name');
    }
    const qty = Number(invQty.value || 0);
    const unitPrice = Number(invUnitPrice.value || 0);
    const total = qty * unitPrice;
    const date = today();
    const contact = invContact.value || '';
    // decide action (inventorySubform invoked only when txnAction is InventoryPurchase or InventorySale)
    const action = txnAction.value || 'InventoryPurchase';
    if(action === 'InventoryPurchase'){
      // update weighted average: newAvg = (oldQty*oldAvg + qty*unitPrice)/(oldQty+qty)
      const oldQty = item.qty || 0;
      const oldAvg = item.avgCost || 0;
      const newQty = oldQty + qty;
      const newAvg = newQty > 0 ? ((oldQty*oldAvg) + (qty*unitPrice)) / newQty : 0;
      item.qty = newQty;
      item.avgCost = Number(newAvg || 0);
      // record transaction (COGS account or selected account)
      const acct = findAccount(b, invAccountSelect.value);
      const tx = { id: uid('txn'), date, action:'InventoryPurchase', accountId: acct ? acct.id : null, accountName: acct ? acct.name : 'Inventory', accountCategory: acct ? acct.category : 'Expense', description: `Inventory purchase: ${item.name}`, qty, unitPrice, amount: total, vatType: invVatType.value||'none', vatAmount: (invVatType.value==='exclusive'? total*(b.vatRate/100) : invVatType.value==='inclusive'? total - (total/(1+(b.vatRate/100))) : 0), contactName: contact, createdBy:selectedUserId, createdAt:new Date().toISOString() };
      state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
      state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
      state.transactions[selectedUserId][selectedBizId].push(tx);
      inventoryHistory.push({ type:'purchase', itemId:item.id, qty, unitPrice, txId:tx.id });
      addAudit('inv.purchase','inventory', item.id, `Purchased ${qty} @ ${fmt(unitPrice)} for item ${item.name}`);
      saveState();
      resetForms(); renderAll();
    } else { // sale
      if(qty > (item.qty||0)) return alert('Insufficient quantity');
      const cogsPerUnit = item.avgCost || 0;
      item.qty = item.qty - qty;
      const revenue = qty * unitPrice;
      const cogs = qty * cogsPerUnit;
      // create sale transaction (Revenue)
      const acct = findAccount(b, invAccountSelect.value);
      const saleTx = { id: uid('txn'), date, action:'InventorySale', accountId: acct ? acct.id : null, accountName: acct ? acct.name : 'Sales', accountCategory: acct ? acct.category : 'Revenue', description: `Inventory sale: ${item.name}`, qty, unitPrice, amount: revenue, vatType: invVatType.value||'none', vatAmount: (invVatType.value==='exclusive'? revenue*(b.vatRate/100) : invVatType.value==='inclusive'? revenue - (revenue/(1+(b.vatRate/100))) : 0), contactName: contact, createdBy:selectedUserId, createdAt:new Date().toISOString() };
      // create COGS transaction
      const cogsAcct = b.accounts.find(a=>a.category==='Expense') || b.accounts[0];
      const cogsTx = { id: uid('txn'), date, action:'COGS', accountId: cogsAcct.id, accountName: cogsAcct.name, accountCategory: cogsAcct.category, description: `COGS for ${item.name}`, amount: cogs, createdBy:selectedUserId, createdAt:new Date().toISOString() };
      state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
      state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
      state.transactions[selectedUserId][selectedBizId].push(saleTx);
      state.transactions[selectedUserId][selectedBizId].push(cogsTx);
      inventoryHistory.push({ type:'sale', itemId:item.id, qty, unitPrice, cogsPerUnit, txId: saleTx.id });
      addAudit('inv.sale','inventory', item.id, `Sold ${qty} @ ${fmt(unitPrice)} for item ${item.name}`);
      saveState();
      resetForms(); renderAll();
    }
  }

  function handleUndoInventory(){
    if(inventoryHistory.length===0) return alert('No inventory actions to undo');
    const last = inventoryHistory.pop();
    const b = findBiz(selectedBizId);
    if(!b) return alert('Business not found');
    const item = b.inventory.find(x=>x.id===last.itemId);
    if(last.type === 'purchase'){
      // reverse purchase
      item.qty = item.qty - last.qty;
      // cannot easily recompute avgCost to previous without stored snapshot; for prototype, leave avgCost unchanged but warn
      alert('Purchase undone. Note: avgCost may not be restored to previous value in prototype.');
      // remove transaction
      removeTxnById(last.txId);
      addAudit('inv.undo','inventory', item.id, `Undid purchase for ${item.name}`);
    } else {
      // reverse sale
      item.qty = item.qty + last.qty;
      // remove sale and cogs tx
      removeTxnById(last.txId);
      // also remove subsequent cogs tx with similar description
      // simplistic cleanup: remove last COGS tx
      const txs = state.transactions[selectedUserId][selectedBizId];
      for(let i=txs.length-1;i>=0;i--){
        if(txs[i].action==='COGS' && txs[i].description && txs[i].description.includes(item.name)){ txs.splice(i,1); break; }
      }
      addAudit('inv.undo','inventory', item.id, `Undid sale for ${item.name}`);
    }
    saveState(); renderAll();
  }

  function removeTxnById(txId){
    for(const uid of Object.keys(state.transactions)){
      for(const bid of Object.keys(state.transactions[uid])){
        const arr = state.transactions[uid][bid];
        const idx = arr.findIndex(x=>x.id===txId);
        if(idx>=0){ arr.splice(idx,1); saveState(); return true; }
      }
    }
    return false;
  }

  // ASSETS handling
  function handleAddAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const name = (assetName.value||'').trim();
    if(!name) return alert('Asset name required');
    const cost = Number(assetCost.value || 0);
    const purchaseDate = assetPurchaseDate.value || today();
    const life = Number(assetLife.value || 0) || 5;
    const caPercent = Number(assetCA.value || b.caRateDefault || DEFAULTS.caRateDefault);
    const depRate = Number(assetDepRate.value || b.depRateDefault || DEFAULTS.depRateDefault);
    const classification = assetClassification.value || 'Fixed';
    const rec = { id: uid('asset'), name, cost, purchaseDate, lifeYears: life, caPercent, depRate, classification, accumulatedDep:0, disposed:false, disposal:{}, notes:'' };
    b.assets = b.assets || [];
    b.assets.push(rec);
    // record purchase transaction
    const acct = findAccount(b, assetPurchaseAccount.value) || b.accounts[0];
    const tx = { id: uid('txn'), date: purchaseDate, action:'FixedAssetPurchase', accountId: acct.id, accountName: acct.name, accountCategory: acct.category, description: `Asset purchase: ${name}`, amount: cost, createdBy:selectedUserId, createdAt:new Date().toISOString(), assetId: rec.id };
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {}; state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(tx);
    assetHistory.push({ type:'add', assetId: rec.id, txId: tx.id });
    addAudit('asset.add','asset', rec.id, `Added asset ${name}`);
    saveState(); resetForms(); renderAll();
  }

  function handleDisposeAsset(){
    const b = findBiz(selectedBizId);
    const assetId = findDisposingAssetIdPrompt(b);
    if(!assetId) return;
    const asset = b.assets.find(a=>a.id===assetId);
    if(!asset) return alert('Asset not found');
    const proceeds = Number(assetDisposalProceeds.value || 0);
    const disposalDate = assetDisposalDate.value || today();
    // compute accumulated depreciation up to disposalDate
    const accDep = computeAccumulatedDepreciation(asset, disposalDate);
    asset.accumulatedDep = accDep;
    const bookValue = (asset.cost || 0) - (accDep || 0);
    const gainLoss = proceeds - bookValue;
    // record disposal transaction
    const acct = findAccount(b, assetDisposalAccount.value) || b.accounts[0];
    const tx = { id: uid('txn'), date: disposalDate, action:'FixedAssetDisposal', accountId: acct.id, accountName: acct.name, accountCategory: acct.category, description: `Asset disposal: ${asset.name}`, amount: proceeds, disposal: { proceeds, date: disposalDate, gainLoss }, assetId: asset.id, createdBy:selectedUserId, createdAt:new Date().toISOString() };
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {}; state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(tx);
    // mark asset disposed
    asset.disposed = true;
    asset.disposal = { date: disposalDate, proceeds, gainLoss };
    assetHistory.push({ type:'dispose', assetId: asset.id, txId: tx.id });
    addAudit('asset.dispose','asset', asset.id, `Disposed asset ${asset.name} proceeds:${fmt(proceeds)} gain/loss:${fmt(gainLoss)}`);
    saveState(); resetForms(); renderAll();
  }

  function findDisposingAssetIdPrompt(b){
    // If assetDisposalAccount is provided, we require user to pick asset to dispose from assets list
    const assetNamePrompt = prompt('Enter asset id or name to dispose (see assets list). You may paste asset id shown in assets report:', '');
    if(!assetNamePrompt) return null;
    // try find by id
    let a = b.assets.find(x=>x.id===assetNamePrompt);
    if(a) return a.id;
    // find by name first match
    a = b.assets.find(x=>x.name.toLowerCase().includes(assetNamePrompt.toLowerCase()));
    if(a) return a.id;
    alert('Asset not found by id or name');
    return null;
  }

  function handleUndoAsset(){
    if(assetHistory.length===0) return alert('No asset actions to undo');
    const last = assetHistory.pop();
    const b = findBiz(selectedBizId);
    if(!b) return alert('Business not found');
    if(last.type === 'add'){
      // remove asset
      b.assets = b.assets.filter(x=>x.id!==last.assetId);
      removeTxnById(last.txId);
      addAudit('asset.undo','asset', last.assetId, 'Undid asset add');
    } else if(last.type === 'dispose'){
      // mark asset as not disposed and remove disposal txn
      const a = b.assets.find(x=>x.id===last.assetId);
      if(a){ a.disposed = false; a.disposal = {}; }
      removeTxnById(last.txId);
      addAudit('asset.undo','asset', last.assetId, 'Undid asset disposal');
    }
    saveState(); renderAll();
  }

  // TAX COMPUTATIONS core functions

  // compute accumulated depreciation up to a date (straight-line monthly prorated)
  function computeAccumulatedDepreciation(asset, asOfDate){
    if(!asset) return 0;
    const start = new Date(asset.purchaseDate || asset.purchaseDate || today());
    const end = new Date(asOfDate || today());
    if(end < start) return 0;
    // monthly straight-line: annual depreciation = (depRate% of cost) OR cost/lifeYears if depRate missing, but user expects straight-line monthly by life
    let annualDep;
    if(asset.depRate && asset.depRate > 0){
      annualDep = (asset.depRate/100) * asset.cost;
    } else if(asset.lifeYears && asset.lifeYears > 0){
      annualDep = asset.cost / asset.lifeYears;
    } else {
      // fallback to 0
      annualDep = 0;
    }
    // compute months between start and end (count partial months prorated by days)
    const months = monthFractionBetween(start,end);
    const acc = (annualDep / 12) * months;
    return Math.min(acc, asset.cost); // cannot exceed cost
  }

  function monthFractionBetween(startDate, endDate){
    // returns fractional months between two dates (e.g., 1.5 months)
    const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
    if(end <= start) return 0;
    // count full months then prorate days in first/last month
    let months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
    // compute day fraction from start day to end day across month boundaries
    const startDay = start.getDate();
    const endDay = end.getDate();
    const daysInStartMonth = new Date(start.getFullYear(), start.getMonth()+1, 0).getDate();
    const daysFraction = (daysInStartMonth - startDay + 1 + endDay) / daysInStartMonth;
    return months + daysFraction;
  }

  // compute monthly capital allowance for an asset up to a date (simple monthly fraction of annual CA%)
  function computeCapitalAllowanceForAsset(asset, asOfDate){
    if(!asset) return 0;
    const start = new Date(asset.purchaseDate || today());
    const end = new Date(asOfDate || today());
    if(end < start) return 0;
    const months = monthFractionBetween(start,end);
    const annualCA = (asset.caPercent/100) * asset.cost;
    const ca = (annualCA/12) * months;
    return Math.min(ca, asset.cost);
  }

  // compute accounting profit for a business over a period (for prototype, compute for all transactions in dataset)
  function computeAccountingProfit(bizId){
    const b = findBiz(bizId);
    if(!b) return 0;
    // Sum revenue, COGS, expenses (exclude chargeable asset disposals from accounting profit)
    let revenue = 0, cogs = 0, expenses = 0;
    const txs = getAllTxsForBusiness(bizId);
    for(const tx of txs){
      if(tx.accountCategory === 'Revenue') revenue += Number(tx.amount || 0);
      else if(tx.action === 'COGS') cogs += Number(tx.amount || 0);
      else if(tx.accountCategory === 'Expense') expenses += Number(tx.amount || 0);
      // include profit/loss from disposal if asset classification is Fixed and tx.action == FixedAssetDisposal
      if(tx.action === 'FixedAssetDisposal'){
        const asset = b.assets.find(a=>a.id === tx.assetId);
        if(asset && asset.classification === 'Fixed'){
          // gainLoss stored in tx.disposal.gainLoss
          const gl = tx.disposal && typeof tx.disposal.gainLoss !== 'undefined' ? Number(tx.disposal.gainLoss) : 0;
          revenue += gl; // include as profit/loss line (adds to revenue in simple P&L)
        }
      }
    }
    const accountingProfit = revenue - cogs - expenses;
    return { revenue, cogs, expenses, accountingProfit };
  }

  // gather all transactions for the business across users (prototype ignores per-user scoping for reporting)
  function getAllTxsForBusiness(bizId){
    const arr = [];
    for(const uid of Object.keys(state.transactions || {})){
      const m = state.transactions[uid];
      if(m && m[bizId]) arr.push(...m[bizId]);
    }
    // sort by date asc
    arr.sort((a,b)=> new Date(a.date) - new Date(b.date));
    return arr;
  }

  // compute taxable profit per rules:
  // Taxable profit = Accounting profit
  //   + Depreciation
  //   + Disallowable expenses
  //   + Chargeable gains
  //   - Non-taxable income
  //   - Loss relief b/f
  //   - Allowed capital allowance
  //
  // Allowed capital allowance rule implemented as specified
  function computeTaxableProfit(bizId){
    const b = findBiz(bizId);
    if(!b) return { taxableProfit:0, breakdown:{} };
    const txs = getAllTxsForBusiness(bizId);
    // Accounting profit
    const ap = computeAccountingProfit(bizId);
    let accountingProfit = ap.accountingProfit;
    // compute Depreciation = sum accumulated depreciation for non-disposed fixed assets up to today
    let totalDepreciation = 0;
    for(const a of (b.assets||[])){
      // depreciation for fixed assets should be included
      const acc = computeAccumulatedDepreciation(a, today());
      totalDepreciation += acc;
    }
    // Disallowable expenses: sum of txs where account.disallowableDefault true or account marked
    let disallowableExpenses = 0;
    let nonTaxableIncome = 0;
    let chargeableGains = 0;
    let chargeableLosses = 0;
    for(const tx of txs){
      // chargeable gain/loss detection
      if(tx.action === 'FixedAssetDisposal' && tx.assetId){
        const asset = b.assets.find(a=>a.id === tx.assetId);
        if(asset){
          const gl = tx.disposal && typeof tx.disposal.gainLoss !== 'undefined' ? Number(tx.disposal.gainLoss) : 0;
          if(asset.classification === 'Chargeable'){
            if(gl >= 0) chargeableGains += gl;
            else chargeableLosses += Math.abs(gl);
          } else { // Fixed assets: profit/loss already included in accountingProfit (we treat it as normal)
            // nothing additional
          }
        }
      }
      // disallowable expenses handling
      const acct = b.accounts.find(a=>a.name === tx.accountName || a.id === tx.accountId);
      const isExpense = tx.accountCategory === 'Expense' || tx.action === 'COGS';
      const isRevenue = tx.accountCategory === 'Revenue';
      const acctDis = acct ? acct.disallowableDefault : false;
      const acctNonTax = acct ? acct.nonTaxableDefault : false;
      if(isExpense){
        if(acctDis || b.defaultExpenseDisallowable) disallowableExpenses += Number(tx.amount||0);
      }
      if(isRevenue){
        if(acctNonTax || b.defaultRevenueNonTax) nonTaxableIncome += Number(tx.amount||0);
      }
    }
    // Loss relief b/f
    const lossBF = Number(b.lossBroughtForward || 0);

    // Capital allowance
    // total CA = CA carryforward (b.caCarryForward) + CA for the year (sum of capital allowance for assets for current period)
    // For prototype CA for the year computed as sum of CA from Jan 1 to today for assets (simplified)
    const caCarryForward = Number(b.caCarryForward || 0);
    let caForYear = 0;
    for(const a of (b.assets||[])){
      caForYear += computeCapitalAllowanceForAsset(a, today());
    }
    const totalCA = caCarryForward + caForYear;
    const totalRevenue = ap.revenue || 0;
    const nonTaxablePct = totalRevenue > 0 ? (nonTaxableIncome / totalRevenue) : 0;
    let allowedCA;
    let unrelievedCAForYearCarry = 0;
    if(nonTaxablePct < 0.10){
      allowedCA = totalCA; // 100%
      unrelievedCAForYearCarry = 0;
    } else {
      allowedCA = (2/3) * totalCA;
      // 1/3 of CA for year should be carried forward into next period
      const unrelieved = (1/3) * caForYear;
      unrelievedCAForYearCarry = unrelieved;
    }

    // Important: Chargeable gains are added to taxable profit. Chargeable losses are NOT included in taxable profit and carried forward to offset future chargeable gains.
    // For this period, we will add chargeableGains to taxable items and ignore chargeableLosses (but store them in carryforward)
    // Update business loss/CA carryforwards
    // Do NOT modify b.caCarryForward and b.lossBroughtForward permanently here; we'll surface suggested adjustments and allow saving routines separately.
    const taxableProfit = accountingProfit + totalDepreciation + disallowableExpenses + chargeableGains - nonTaxableIncome - lossBF - allowedCA;

    const breakdown = { accountingProfit, totalDepreciation, disallowableExpenses, chargeableGains, nonTaxableIncome, lossBF, caCarryForward, caForYear, totalCA, allowedCA, unrelievedCAForYearCarry, chargeableLosses };

    return { taxableProfit, breakdown };
  }

  // PAYE computation on gross salary (per-contact); apply statutory deductions (rent relief = 20% of rent paid)
  function computePAYEForContact(contactName, bizId){
    const b = findBiz(bizId);
    if(!b) return { annualTax:0, monthlyTax:0, breakdown:{} };
    // collect all salary transactions for contact
    const txs = getAllTxsForBusiness(bizId).filter(t => t.paye && t.contactName === contactName);
    // sum gross salary annual
    let grossAnnual = 0;
    for(const t of txs) grossAnnual += Number(t.amount || 0);
    // statutory deductions: pension, mortgage interest, life assurance, nhf, rent relief (20% of rent paid)
    // rent paid: find transactions marked as Rent paid for this contact or accounts with rentFreq
    let pension = 0, mortgage=0, life=0, nhf=0, rentRelief = 0;
    // try find contact statutory if exists
    let contact = null;
    const bContacts = (b.contacts||[]);
    contact = bContacts.find(c=>c.name === contactName) || null;
    if(contact && contact.statutory){
      pension = Number(contact.statutory.pension || 0);
      mortgage = Number(contact.statutory.mortgage || 0);
      life = Number(contact.statutory.life || 0);
      nhf = Number(contact.statutory.nhf || 0);
      rentRelief = Number(contact.statutory.rent || 0); // if provided assume already calculated
    } else {
      // fallback to business-level default
      pension = Number(b.statutoryDeductions?.pension || 0);
      mortgage = Number(b.statutoryDeductions?.mortgage || 0);
      life = Number(b.statutoryDeductions?.life || 0);
      nhf = Number(b.statutoryDeductions?.nhf || 0);
      // compute rent paid in transactions for the contact (accounts with rentFreq)
      let rentPaid = 0;
      for(const t of getAllTxsForBusiness(bizId)){
        if(t.contactName === contactName){
          const acct = b.accounts.find(a=>a.id === t.accountId);
          if(acct && acct.rentFreq){ rentPaid += Number(t.amount || 0); }
        }
      }
      rentRelief = 0.20 * rentPaid;
    }
    const totalDeductions = pension + mortgage + life + nhf + rentRelief;
    const taxableIncome = Math.max(0, grossAnnual - totalDeductions);
    // apply PAYE bands on taxableIncome
    let remaining = taxableIncome;
    let tax = 0;
    const bandBreakdown = [];
    let lower = 0;
    for(const band of PAYE_BANDS){
      const up = band.upTo;
      const rate = band.rate;
      const bandAmount = Math.max(0, Math.min(remaining, up - lower));
      tax += bandAmount * rate;
      bandBreakdown.push({ upTo: up, rate, amount: bandAmount, tax: bandAmount * rate });
      remaining -= bandAmount;
      lower = up;
      if(remaining <= 0) break;
    }
    const monthly = tax / 12;
    return { annualTax: tax, monthlyTax: monthly, grossAnnual, totalDeductions, taxableIncome, bandBreakdown };
  }

  // PIT computed by applying PAYE bands to business taxable profit less statutory deductions for the business
  function computePIT(bizId){
    const b = findBiz(bizId);
    if(!b) return { pit:0, breakdown:{} };
    const taxRes = computeTaxableProfit(bizId);
    let taxableProfit = Number(taxRes.taxableProfit || 0);
    // apply statutory deductions for business
    const totalStatutory = (b.statutoryDeductions?.pension || 0) + (b.statutoryDeductions?.mortgage || 0) + (b.statutoryDeductions?.life || 0) + (b.statutoryDeductions?.nhf || 0) + (b.statutoryDeductions?.rent || 0);
    taxableProfit = Math.max(0, taxableProfit - totalStatutory);
    // apply PAYE bands to taxableProfit
    let remaining = taxableProfit;
    let tax = 0;
    let lower = 0;
    for(const band of PAYE_BANDS){
      const up = band.upTo;
      const rate = band.rate;
      const bandAmount = Math.max(0, Math.min(remaining, up - lower));
      tax += bandAmount * rate;
      remaining -= bandAmount;
      lower = up;
      if(remaining <= 0) break;
    }
    return { pit: tax, taxableProfit, totalStatutory };
  }

  // CIT computed at 0% for turnover <= threshold else at b.citRate, and WHT receivable deduction rule
  function computeCIT(bizId){
    const b = findBiz(bizId);
    if(!b) return { cit:0, breakdown:{} };
    const txs = getAllTxsForBusiness(bizId);
    let turnover = 0;
    for(const t of txs){ if(t.accountCategory === 'Revenue') turnover += Number(t.amount || 0); }
    let citRate = Number(b.citRate || DEFAULTS.citRate);
    let cit = 0;
    if(turnover <= CIT_TURNOVER_THRESHOLD) cit = 0;
    else {
      const taxRes = computeTaxableProfit(bizId);
      let taxableProfit = Math.max(0, Number(taxRes.taxableProfit || 0));
      // apply citRate
      cit = taxableProfit * (citRate/100);
      // WHT receivable deduction only when CIT computed
      const whtSummary = computeWHTSummary(bizId);
      const whtReceivable = whtSummary.receivable || 0;
      cit = Math.max(0, cit - whtReceivable);
    }
    return { cit, turnover };
  }

  // VAT summary (collected, paid, net)
  function computeVATSummary(bizId){
    const b = findBiz(bizId);
    if(!b) return { collected:0, paid:0, net:0, details:[] };
    const txs = getAllTxsForBusiness(bizId);
    let collected = 0, paid = 0;
    const details = [];
    for(const t of txs){
      if(!t.vatAmount || t.vatAmount === 0) continue;
      const isSale = t.accountCategory === 'Revenue' || t.action === 'InventorySale';
      if(isSale) { collected += Number(t.vatAmount || 0); details.push({ id:t.id, date:t.date, type:'collected', amount:t.vatAmount, desc:t.description }); }
      else { paid += Number(t.vatAmount || 0); details.push({ id:t.id, date:t.date, type:'paid', amount:t.vatAmount, desc:t.description }); }
    }
    return { collected, paid, net: collected - paid, details };
  }

  // WHT summary: receivable (wht withheld on payables) and payable (wht to remit)
  function computeWHTSummary(bizId){
    const b = findBiz(bizId);
    if(!b) return { receivable:0, payable:0, details:[] };
    const txs = getAllTxsForBusiness(bizId);
    let receivable = 0, payable = 0;
    const details = [];
    for(const t of txs){
      if(!t.whtApplied) continue;
      // treat whtApplied true as either receivable or payable depending on transaction (simplify: revenue transactions -> receivable, expense -> payable)
      const isRevenue = t.accountCategory === 'Revenue';
      if(isRevenue){ receivable += Number(t.whtAmount || 0); details.push({ id:t.id, date:t.date, type:'receivable', amount:t.whtAmount, desc:t.description }); }
      else { payable += Number(t.whtAmount || 0); details.push({ id:t.id, date:t.date, type:'payable', amount:t.whtAmount, desc:t.description }); }
    }
    return { receivable, payable, details };
  }

  // render functions
  function renderAll(){
    refreshSelectors();
    populateAccountSelect();
    renderLedger();
    renderQuickPanels();
    renderTaxSummary();
    renderReportsPlaceholder();
  }

  function renderLedger(){
    ledgerTableBody.innerHTML = '';
    if(!selectedBizId) return;
    const q = (document.getElementById('ledgerSearch').value||'').toLowerCase();
    const txs = getAllTxsForBusiness(selectedBizId).filter(tx => {
      if(!q) return true;
      return (tx.date||'').toLowerCase().includes(q) || (tx.accountName||'').toLowerCase().includes(q) || (tx.description||'').toLowerCase().includes(q) || (''+tx.amount).includes(q) || (tx.contactName||'').toLowerCase().includes(q);
    });
    for(const tx of txs){
      const tr = document.createElement('tr');
      const receiptThumb = tx.receiptId && state.attachments[tx.receiptId] ? `<img class="receipt-thumb" src="${state.attachments[tx.receiptId].data}" alt="${state.attachments[tx.receiptId].name}" />` : '';
      const whtText = tx.whtApplied ? fmt(tx.whtAmount||0) : '';
      const payeText = tx.paye ? fmt(tx.paye) : '';
      const canEdit = userHasPermission(selectedUserId,'edit');
      const canDelete = userHasPermission(selectedUserId,'delete');
      tr.innerHTML = `<td>${tx.date || ''}</td><td>${tx.action||''}</td><td>${tx.accountName||''}</td><td>${tx.description||''}</td><td style="text-align:right;">${fmt(tx.amount||0)}</td><td style="text-align:right;">${fmt(tx.vatAmount||0)}</td><td style="text-align:right;">${whtText}</td><td>${payeText}</td><td>${tx.contactName||''}</td><td>${receiptThumb}</td><td style="white-space:nowrap;">
        <button class="small" data-id="${tx.id}" data-action="view">View</button>
        <button class="small" data-id="${tx.id}" data-action="del" ${!canDelete? 'disabled':''}>Delete</button>
      </td>`;
      ledgerTableBody.appendChild(tr);
      tr.querySelector('[data-action="view"]').addEventListener('click', ()=> { alert(JSON.stringify(tx, null, 2)); });
      tr.querySelector('[data-action="del"]').addEventListener('click', ()=> {
        if(!confirm('Delete transaction?')) return;
        removeTxnById(tx.id);
        addAudit('txn.del','transaction', tx.id, 'Deleted transaction');
        saveState(); renderAll();
      });
    }
  }

  function userHasPermission(userId, perm){
    const u = findUser(userId);
    if(!u) return false;
    if(u.isAdmin) return true;
    return !!u.permissions && !!u.permissions[perm];
  }

  function renderQuickPanels(){
    // Inventory list
    inventoryListDiv.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    const inv = b.inventory || [];
    if(inv.length===0) inventoryListDiv.innerHTML = '<div class="small-muted">No inventory items</div>';
    else {
      for(const it of inv){
        const div = document.createElement('div');
        div.className = 'account-row';
        div.innerHTML = `<div><strong>${it.name}</strong> <div class="small-muted">Qty: ${it.qty} | Avg cost: ${fmt(it.avgCost)}</div></div>`;
        inventoryListDiv.appendChild(div);
      }
    }
    // Assets list
    assetListDiv.innerHTML = '';
    const assets = b.assets || [];
    if(assets.length===0) assetListDiv.innerHTML = '<div class="small-muted">No assets</div>';
    else {
      for(const a of assets){
        const accDep = computeAccumulatedDepreciation(a, today());
        const bv = (a.cost || 0) - accDep;
        const div = document.createElement('div');
        div.className='account-row';
        div.innerHTML = `<div><strong>${a.name}</strong> <span class="small-muted">(${a.classification})</span><div class="small-muted">Cost: ${fmt(a.cost)} | AccDep: ${fmt(accDep)} | Book value: ${fmt(bv)}</div></div>
          <div style="display:flex;gap:6px;"><button class="small" data-id="${a.id}" data-action="view">View</button></div>`;
        assetListDiv.appendChild(div);
        div.querySelector('[data-action="view"]').addEventListener('click', ()=> { alert(JSON.stringify(a, null, 2)); });
      }
    }
    // P&L snapshot
    const ap = computeAccountingProfit(selectedBizId);
    plSnapshotQuick.innerHTML = `<div><strong>Revenue:</strong> ${fmt(ap.revenue)}</div><div><strong>COGS:</strong> ${fmt(ap.cogs)}</div><div><strong>Expenses:</strong> ${fmt(ap.expenses)}</div><div style="margin-top:6px;"><strong>Accounting profit:</strong> ${fmt(ap.accountingProfit)}</div>`;
  }

  function renderTaxSummary(){
    const b = findBiz(selectedBizId);
    if(!b) return;
    const ap = computeAccountingProfit(selectedBizId);
    const taxRes = computeTaxableProfit(selectedBizId);
    const vat = computeVATSummary(selectedBizId);
    const wht = computeWHTSummary(selectedBizId);
    const pit = computePIT(selectedBizId);
    const cit = computeCIT(selectedBizId);
    taxSummaryDiv.innerHTML = `<h3 style="margin:0 0 8px 0;">Tax Summary</h3>
      <div><strong>Accounting profit:</strong> ${fmt(ap.accountingProfit)}</div>
      <div><strong>Taxable profit:</strong> ${fmt(taxRes.taxableProfit)}</div>
      <div style="margin-top:8px;"><strong>VAT</strong> Collected: ${fmt(vat.collected)} | Paid: ${fmt(vat.paid)} | Net: ${fmt(vat.net)}</div>
      <div style="margin-top:4px;"><strong>WHT</strong> Receivable: ${fmt(wht.receivable)} | Payable: ${fmt(wht.payable)}</div>
      <div style="margin-top:4px;"><strong>PAYE / PIT</strong> PIT: ${fmt(pit.pit)}</div>
      <div style="margin-top:4px;"><strong>CIT</strong> CIT: ${fmt(cit.cit)} | Turnover: ${fmt(cit.turnover)}</div>
      <div style="margin-top:8px;" class="small-muted">Details: Depreciation ${fmt(taxRes.breakdown.totalDepreciation)} | Disallowable ${fmt(taxRes.breakdown.disallowableExpenses)} | Chargeable gains ${fmt(taxRes.breakdown.chargeableGains)} | Non-taxable income ${fmt(taxRes.breakdown.nonTaxableIncome)}</div>
    `;
  }

  function renderReportsPlaceholder(){
    // initial report content
    reportContent.innerHTML = '<div class="small-muted">Select a report tab to view details</div>';
  }

  function renderReport(name){
    if(!selectedBizId) return alert('Select a business');
    reportContent.innerHTML = '';
    if(name === 'taxReconciliation'){
      const taxRes = computeTaxableProfit(selectedBizId);
      const b = findBiz(selectedBizId);
      reportContent.innerHTML = `<h3>Taxable Income Reconciliation</h3>
        <pre class="code">${JSON.stringify(taxRes.breakdown, null, 2)}</pre>
        <div><strong>Taxable profit:</strong> ${fmt(taxRes.taxableProfit)}</div>
        <div style="margin-top:8px;"><button class="small" id="btnSaveCA">Apply CA carryforward adjustments</button></div>`;
      document.getElementById('btnSaveCA').addEventListener('click', ()=>{
        if(!confirm('Apply unrelieved capital allowance for year to CA carryforward?')) return;
        const b = findBiz(selectedBizId);
        b.caCarryForward = (b.caCarryForward||0) + (taxRes.breakdown.unrelievedCAForYearCarry || 0);
        saveState(); renderAll(); alert('Applied CA carryforward.');
      });
    } else if(name === 'vatReport'){
      const vat = computeVATSummary(selectedBizId);
      const rows = vat.details.map(d=> `<tr><td>${d.date}</td><td>${d.type}</td><td>${fmt(d.amount)}</td><td>${d.desc}</td></tr>`).join('');
      reportContent.innerHTML = `<h3>VAT Report</h3><div>Collected: ${fmt(vat.collected)} | Paid: ${fmt(vat.paid)} | Net: ${fmt(vat.net)}</div>
        <table class="ledger-table" style="margin-top:8px;"><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Description</th></tr></thead><tbody>${rows}</tbody></table>`;
    } else if(name === 'whtPayable'){
      const wht = computeWHTSummary(selectedBizId);
      const rows = wht.details.map(d=> `<tr><td>${d.date}</td><td>${d.type}</td><td>${fmt(d.amount)}</td><td>${d.desc}</td></tr>`).join('');
      reportContent.innerHTML = `<h3>WHT Payable / Receivable</h3><div>Receivable: ${fmt(wht.receivable)} | Payable: ${fmt(wht.payable)}</div>
        <table class="ledger-table" style="margin-top:8px;"><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Description</th></tr></thead><tbody>${rows}</tbody></table>`;
    } else if(name === 'payeReport'){
      // breakdown per contact
      const b = findBiz(selectedBizId);
      const contacts = b.contacts || [];
      let html = '<h3>PAYE Report</h3>';
      for(const c of contacts.filter(x=>x.type==='Employee' || x.type==='SoleTrader')){
        const res = computePAYEForContact(c.name, selectedBizId);
        html += `<div style="margin-top:8px;"><strong>${c.name}</strong> Gross: ${fmt(res.grossAnnual)} Deductions: ${fmt(res.totalDeductions)} Taxable: ${fmt(res.taxableIncome)} Annual PAYE: ${fmt(res.annualTax)} Monthly: ${fmt(res.monthlyTax)}
          <details><summary>Band breakdown</summary><pre class="code">${JSON.stringify(res.bandBreakdown, null, 2)}</pre></details></div>`;
      }
      reportContent.innerHTML = html;
    } else if(name === 'inventoryReport'){
      const b = findBiz(selectedBizId);
      const rows = (b.inventory||[]).map(it=> `<tr><td>${it.name}</td><td>${it.qty}</td><td>${fmt(it.avgCost)}</td><td>${fmt(it.qty*it.avgCost)}</td></tr>`).join('');
      reportContent.innerHTML = `<h3>Inventory Report</h3><table class="ledger-table"><thead><tr><th>Item</th><th>Qty</th><th>Avg Cost</th><th>Total Value</th></tr></thead><tbody>${rows}</tbody></table>`;
    } else if(name === 'assetsReport'){
      const b = findBiz(selectedBizId);
      const rows = (b.assets||[]).map(a=>{
        const acc = computeAccumulatedDepreciation(a, today());
        const bv = a.cost - acc;
        return `<tr><td>${a.id}</td><td>${a.name}</td><td>${a.classification}</td><td>${fmt(a.cost)}</td><td>${fmt(acc)}</td><td>${fmt(bv)}</td></tr>`;
      }).join('');
      reportContent.innerHTML = `<h3>Fixed Assets Schedule</h3><table class="ledger-table"><thead><tr><th>ID</th><th>Name</th><th>Class</th><th>Cost</th><th>Acc Dep</th><th>Book Value</th></tr></thead><tbody>${rows}</tbody></table>`;
    } else if(name === 'auditTrail'){
      const rows = (state.audit||[]).map(a=> `<tr><td>${a.timestamp}</td><td>${a.userId||''}</td><td>${a.type}</td><td>${a.entityType}</td><td>${a.details}</td></tr>`).join('');
      reportContent.innerHTML = `<h3>Audit Trail</h3><table class="ledger-table"><thead><tr><th>Time</th><th>User</th><th>Type</th><th>Entity</th><th>Details</th></tr></thead><tbody>${rows}</tbody></table>`;
    } else if(name === 'receiptsFolder'){
      const atts = state.attachments || {};
      const rows = Object.values(atts).map(a=> `<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;"><img class="receipt-thumb" src="${a.data}"/><div>${a.name}<div class="small-muted">${a.uploadedAt}</div></div></div>`).join('');
      reportContent.innerHTML = `<h3>Receipts Folder</h3>${rows}`;
    }
  }

  let currentReportName = 'taxReconciliation';
  function exportCurrentReport(type){
    const active = document.querySelector('#reportsSection .tab.active');
    if(!active) return alert('Select a report first');
    currentReportName = active.dataset.report;
    if(type === 'csv'){
      const csv = generateCsvForReport(currentReportName);
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${currentReportName}.csv`; a.click(); URL.revokeObjectURL(url);
    } else if(type === 'pdf'){
      const doc = new jspdf.jsPDF();
      doc.setFontSize(12);
      doc.text(`Report: ${currentReportName}`, 10, 10);
      const txt = reportContent.innerText || '';
      const lines = doc.splitTextToSize(txt, 180);
      doc.text(lines, 10, 20);
      doc.save(`${currentReportName}.pdf`);
    } else if(type === 'xlsx'){
      const wb = XLSX.utils.book_new();
      const sheetData = generateSheetDataForReport(currentReportName);
      for(const s of Object.keys(sheetData)){
        const ws = XLSX.utils.aoa_to_sheet(sheetData[s]);
        XLSX.utils.book_append_sheet(wb, ws, s);
      }
      XLSX.writeFile(wb, `${currentReportName}.xlsx`);
    }
  }

  function generateCsvForReport(name){
    if(name === 'vatReport'){
      const vat = computeVATSummary(selectedBizId);
      let rows = ['Date,Type,Amount,Description'];
      vat.details.forEach(d => rows.push(`${d.date},${d.type},${d.amount},"${d.desc.replace(/"/g,'""')}"`));
      return rows.join('\n');
    }
    // fallback: export reportContent text
    return reportContent.innerText || '';
  }
  function generateSheetDataForReport(name){
    const out = {};
    if(name === 'vatReport'){
      const vat = computeVATSummary(selectedBizId);
      const rows = [['Date','Type','Amount','Description']];
      vat.details.forEach(d => rows.push([d.date,d.type,d.amount,d.desc]));
      out['VAT'] = rows;
      return out;
    }
    // fallback
    out['Report'] = [[reportContent.innerText || '']];
    return out;
  }

  // small helpers
  function renderFeatureVisibility(){
    const b = findBiz(selectedBizId);
    if(!b) return;
    // VAT fields visible only if VAT enabled
    document.getElementById('txnVatLabel').style.display = b.vatEnabled ? 'inline-flex' : 'none';
    document.getElementById('invVatLabel').style.display = b.vatEnabled ? 'inline-flex' : 'none';
  }

  // Load initial UI state
  function renderReportsPlaceholderAndTabs(){
    document.querySelectorAll('#reportsSection .tab').forEach((t,i)=> { if(i===0) t.classList.add('active'); else t.classList.remove('active'); });
    renderReport('taxReconciliation');
  }

  // Kick off
  renderFeatureVisibility();
  renderReportsPlaceholderAndTabs();

  </script>
</body>
                                                                                  </html>
