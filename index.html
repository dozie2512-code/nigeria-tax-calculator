<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Tax & Accounting ‚Äî Full Accounting Rewrite</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* CSS Variables */
    :root {
      --gap: 12px;
      --muted: #666;
      --danger: #b00;
      --accent: #0b76d1;
      --bg: #f8f9fb;
      --success: #0a7d3e;
    }
    
    /* Base Styles */
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 18px;
      color: #222;
      background: #fff;
    }
    
    /* Header */
    header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 1.2rem; }
    h2 { margin: 10px 0; font-size: 1.05rem; }
    h3 { margin: 8px 0; font-size: 0.95rem; }
    
    /* Panels and Layout */
    .panel {
      border: 1px solid #e1e4e8;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .section { margin-top: 14px; }
    .spacer { flex: 1 1 auto; }
    
    /* Form Elements */
    label { font-size: 0.9rem; color: var(--muted); }
    select, input[type="text"], input[type="number"], input[type="date"],
    textarea, input[type="password"], input[type="email"] {
      padding: 6px;
      border: 1px solid #cfcfcf;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    textarea { width: 100%; min-height: 80px; }
    input[type="checkbox"] { cursor: pointer; }
    
    /* Buttons */
    button {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #fff;
      cursor: pointer;
      font-size: 0.95rem;
    }
    button:hover { background: #f5f5f5; }
    button.primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    button.primary:hover { background: #0960a8; }
    button.success {
      background: var(--success);
      color: #fff;
      border-color: var(--success);
    }
    button.danger {
      color: var(--danger);
      border-color: var(--danger);
      background: #fff5f5;
    }
    button.small { padding: 6px 8px; font-size: 0.9rem; }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Tables */
    .ledger-table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .ledger-table th, .ledger-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    .ledger-table th { background: #f2f6fa; font-weight: 600; }
    .ledger-table tr:hover { background: #f9fbfd; }
    
    /* Summary Panels */
    .totals, .tax-summary, .inventory-panel, .assets-panel, .report-panel {
      background: #f7f9fc;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #eef2f6;
    }
    
    /* Utilities */
    .muted { color: var(--muted); font-size: 0.9rem; }
    .small-muted { font-size: 0.85rem; color: var(--muted); }
    .actions { display: flex; gap: 6px; }
    .form-inline {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .grid {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    
    /* Modals */
    .modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      z-index: 50;
    }
    .modalOverlay.show { display: block; }
    .modal {
      display: none;
      position: fixed;
      left: 50%;
      top: 5%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #cfcfcf;
      padding: 16px;
      z-index: 51;
      border-radius: 8px;
      max-width: 960px;
      width: 96vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }
    .modal.show { display: block; }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .modal-header h2 { margin: 0; }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted);
    }
    
    /* Tabs */
    .tabbar { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #e6e6e6;
      background: #fff;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .tab.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    
    /* Badges and Flags */
    .flag {
      background: #eef6ff;
      padding: 3px 6px;
      border-radius: 4px;
      color: #05507a;
      font-size: 0.85rem;
      border: 1px solid #dbeffb;
      display: inline-block;
    }
    .badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85rem;
      display: inline-block;
    }
    .badge-success {
      background: #d4f4dd;
      color: #0a7d3e;
      border: 1px solid #b7e4c7;
    }
    .badge-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .badge-danger {
      background: #f8d7da;
      color: #842029;
      border: 1px solid #f1aeb5;
    }
    
    /* Notices */
    .notice {
      background: #fff9e6;
      border: 1px solid #ffe6a8;
      padding: 10px;
      border-radius: 6px;
      color: #6a4e00;
      margin: 10px 0;
    }
    .notice.info {
      background: #e7f5ff;
      border-color: #74c0fc;
      color: #0c5ca8;
    }
    
    /* Receipts */
    .receipt-thumb {
      max-width: 64px;
      max-height: 64px;
      display: inline-block;
      border: 1px solid #eee;
      padding: 2px;
      border-radius: 4px;
      cursor: pointer;
    }
    .receipt-preview {
      max-width: 100%;
      max-height: 500px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    /* Form sections */
    .form-section {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      border: 1px dashed #e6e6e6;
      background: #fcfcfd;
    }
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
    }
    
    /* Hidden elements */
    .hidden { display: none !important; }
    
    /* Responsive */
    @media (max-width: 760px) {
      .form-inline, .controls {
        flex-direction: column;
        align-items: stretch;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .modal {
        width: 98vw;
        top: 2%;
      }
    }
    
    /* Print styles */
    @media print {
      .no-print { display: none !important; }
      .panel, .modal {
        border: none;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>üá≥üá¨ Nigeria Tax & Accounting System</h1>
    
    <div class="spacer"></div>
    
    <div class="form-inline">
      <label>User:</label>
      <select id="userSelect" style="min-width: 150px;"></select>
      <button class="small no-print" id="btnAddUser">+ User</button>
      <button class="small no-print" id="btnEditUser">Edit User</button>
    </div>
    
    <div style="width: 2px; height: 24px; background: #ddd;"></div>
    
    <div class="form-inline">
      <label>Business:</label>
      <select id="businessSelect" style="min-width: 150px;"></select>
      <button class="small no-print" id="btnAddBusiness">+ Business</button>
      <button class="small no-print" id="btnEditBusiness">Edit Business</button>
    </div>
  </header>
  
  <!-- Main Navigation -->
  <div class="panel no-print" style="margin-bottom: 12px;">
    <div class="tabbar">
      <button class="tab active" data-tab="ledger">üìä Ledger</button>
      <button class="tab" data-tab="inventory">üì¶ Inventory</button>
      <button class="tab" data-tab="assets">üè¢ Fixed Assets</button>
      <button class="tab" data-tab="reports">üìÑ Reports</button>
      <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
    </div>
    
    <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
      <button class="small" id="btnExportJSON">Export JSON</button>
      <button class="small" id="btnImportJSON">Import JSON</button>
      <input type="file" id="fileImportJSON" accept="application/json" style="display: none;" />
      <div class="spacer"></div>
      <button class="small danger" id="btnClearAll">Clear All Data</button>
    </div>
  </div>
  
  <!-- Tab Content: Ledger -->
  <div id="tabLedger" class="tab-content">
    <div class="panel">
      <h2>Transaction Ledger</h2>
      
      <!-- Add Transaction Form -->
      <div class="form-section">
        <h3>Add Transaction</h3>
        <div class="grid">
          <div class="form-group">
            <label>Type *</label>
            <select id="txType">
              <option value="revenue">Revenue</option>
              <option value="expense">Expense</option>
              <option value="inventory_purchase">Inventory Purchase</option>
              <option value="inventory_sale">Inventory Sale</option>
              <option value="asset_purchase">Fixed Asset Purchase</option>
              <option value="asset_disposal">Fixed Asset Disposal</option>
              <option value="bank_payment">Bank Payment</option>
              <option value="bank_receipt">Bank Receipt</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Date *</label>
            <input type="date" id="txDate" />
          </div>
          
          <div class="form-group">
            <label>Account *</label>
            <select id="txAccount"></select>
          </div>
          
          <div class="form-group">
            <label>Amount *</label>
            <input type="number" id="txAmount" step="0.01" min="0" />
          </div>
          
          <div class="form-group">
            <label>Contact</label>
            <input type="text" id="txContact" placeholder="Contact name" />
          </div>
          
          <div class="form-group">
            <label>Description</label>
            <input type="text" id="txDescription" placeholder="Description" />
          </div>
        </div>
        
        <!-- VAT & WHT Section -->
        <div class="row" style="margin-top: 10px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="txVATEnabled" />
            VAT
          </label>
          
          <select id="txVATMode" style="width: 120px;">
            <option value="exclusive">Exclusive</option>
            <option value="inclusive">Inclusive</option>
          </select>
          
          <input type="number" id="txVATRate" step="0.01" min="0" max="100" 
                 placeholder="Rate %" style="width: 100px;" />
          
          <div style="width: 2px; height: 24px; background: #ddd; margin: 0 8px;"></div>
          
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="txWHTEnabled" />
            WHT
          </label>
          
          <select id="txWHTBasis" style="width: 100px;">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
          
          <input type="number" id="txWHTRate" step="0.01" min="0" max="100" 
                 placeholder="Rate %" style="width: 100px;" />
          
          <div style="width: 2px; height: 24px; background: #ddd; margin: 0 8px;"></div>
          
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="txPAYE" />
            PAYE (Salary)
          </label>
        </div>
        
        <!-- Receipt Upload -->
        <div class="row" style="margin-top: 10px;">
          <label>Receipt:</label>
          <input type="file" id="txReceipt" accept="image/*,application/pdf" />
          <span class="small-muted" id="receiptPreview"></span>
        </div>
        
        <!-- Inventory/Asset Selection (conditional) -->
        <div id="inventorySelection" class="hidden" style="margin-top: 10px;">
          <label>Inventory Item:</label>
          <select id="txInventoryItem"></select>
          <input type="number" id="txInventoryQty" placeholder="Quantity" step="0.01" min="0" style="width: 120px;" />
        </div>
        
        <div id="assetSelection" class="hidden" style="margin-top: 10px;">
          <label>Fixed Asset:</label>
          <select id="txAssetItem"></select>
          <input type="number" id="txAssetProceeds" placeholder="Proceeds" step="0.01" min="0" style="width: 150px;" />
        </div>
        
        <div style="margin-top: 12px;">
          <button class="primary" id="btnAddTransaction">Add Transaction</button>
          <button id="btnCancelTransaction">Cancel</button>
          <button class="small" id="btnUndoLast">‚Ü∂ Undo Last</button>
        </div>
      </div>
      
      <!-- Transactions Table -->
      <div style="margin-top: 16px;">
        <h3>Transactions</h3>
        <div style="overflow-x: auto;">
          <table class="ledger-table" id="transactionsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Account</th>
                <th>Description</th>
                <th>Contact</th>
                <th>Amount</th>
                <th>VAT</th>
                <th>WHT</th>
                <th>Receipt</th>
                <th class="no-print">Actions</th>
              </tr>
            </thead>
            <tbody id="transactionsBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Summary Panels -->
    <div class="row" style="margin-top: 12px;">
      <div class="tax-summary" style="flex: 1;">
        <h3>Tax Summary</h3>
        <div id="taxSummaryContent"></div>
      </div>
      
      <div class="totals" style="flex: 1;">
        <h3>Profit & Loss</h3>
        <div id="profitLossContent"></div>
      </div>
    </div>
  </div>
  
  <!-- Tab Content: Inventory -->
  <div id="tabInventory" class="tab-content hidden">
    <div class="panel">
      <h2>Inventory Management</h2>
      
      <div class="form-section">
        <h3>Add Inventory Item</h3>
        <div class="row">
          <input type="text" id="invName" placeholder="Item name" style="flex: 1;" />
          <input type="number" id="invInitialQty" placeholder="Initial quantity" step="0.01" style="width: 150px;" />
          <input type="number" id="invInitialCost" placeholder="Initial cost" step="0.01" style="width: 150px;" />
          <button class="primary" id="btnAddInventory">Add Item</button>
        </div>
      </div>
      
      <div style="margin-top: 16px;">
        <table class="ledger-table" id="inventoryTable">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Avg Cost</th>
              <th>Total Value</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody id="inventoryBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Tab Content: Fixed Assets -->
  <div id="tabAssets" class="tab-content hidden">
    <div class="panel">
      <h2>Fixed Assets</h2>
      
      <div class="form-section">
        <h3>Add Fixed Asset</h3>
        <div class="grid">
          <div class="form-group">
            <label>Asset Name *</label>
            <input type="text" id="assetName" />
          </div>
          
          <div class="form-group">
            <label>Cost *</label>
            <input type="number" id="assetCost" step="0.01" min="0" />
          </div>
          
          <div class="form-group">
            <label>Purchase Date *</label>
            <input type="date" id="assetPurchaseDate" />
          </div>
          
          <div class="form-group">
            <label>Useful Life (years) *</label>
            <input type="number" id="assetUsefulLife" step="1" min="1" />
          </div>
          
          <div class="form-group">
            <label>Capital Allowance % *</label>
            <input type="number" id="assetCARate" step="0.01" min="0" max="100" />
          </div>
          
          <div class="form-group">
            <label>Depreciation Rate % *</label>
            <input type="number" id="assetDepRate" step="0.01" min="0" max="100" />
          </div>
          
          <div class="form-group">
            <label>Classification *</label>
            <select id="assetClassification">
              <option value="fixed">Fixed (Normal P&L)</option>
              <option value="chargeable">Chargeable (Capital Gains)</option>
            </select>
          </div>
        </div>
        
        <div style="margin-top: 12px;">
          <button class="primary" id="btnAddAsset">Add Asset</button>
        </div>
        
        <small class="note">
          ‚Ä¢ <strong>Fixed assets:</strong> Disposal gains/losses included in accounting profit and taxable profit<br/>
          ‚Ä¢ <strong>Chargeable assets:</strong> Disposal gains/losses treated as chargeable gains (subject to capital gains tax rules, excluded from accounting profit, losses carry forward)
        </small>
      </div>
      
      <div style="margin-top: 16px;">
        <h3>Assets Schedule</h3>
        <div style="overflow-x: auto;">
          <table class="ledger-table" id="assetsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Class</th>
                <th>Cost</th>
                <th>Purchase Date</th>
                <th>Acc. Depreciation</th>
                <th>Book Value</th>
                <th>CA for Year</th>
                <th>Status</th>
                <th class="no-print">Actions</th>
              </tr>
            </thead>
            <tbody id="assetsBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Content: Reports -->
  <div id="tabReports" class="tab-content hidden">
    <div class="panel">
      <h2>Reports & Exports</h2>
      
      <div class="tabbar" style="margin-bottom: 12px;">
        <button class="tab active" data-report="accounting">Accounting Profit</button>
        <button class="tab" data-report="taxable">Taxable Profit</button>
        <button class="tab" data-report="vat">VAT Report</button>
        <button class="tab" data-report="wht">WHT Report</button>
        <button class="tab" data-report="paye">PAYE Report</button>
        <button class="tab" data-report="pit">PIT Report</button>
        <button class="tab" data-report="cit">CIT Report</button>
        <button class="tab" data-report="inventory">Inventory Report</button>
        <button class="tab" data-report="assets">Assets Schedule</button>
        <button class="tab" data-report="audit">Audit Trail</button>
      </div>
      
      <div class="report-panel" id="reportContent">
        <div class="notice info">Select a report from the tabs above</div>
      </div>
      
      <div style="margin-top: 12px; display: flex; gap: 8px;">
        <button class="small" id="btnExportCSV">Export CSV</button>
        <button class="small" id="btnExportPDF">Export PDF</button>
        <button class="small" id="btnExportXLSX">Export XLSX</button>
      </div>
    </div>
  </div>
  
  <!-- Tab Content: Settings -->
  <div id="tabSettings" class="tab-content hidden">
    <div class="panel">
      <h2>Settings</h2>
      
      <div class="tabbar" style="margin-bottom: 12px;">
        <button class="tab active" data-setting="business">Business Settings</button>
        <button class="tab" data-setting="accounts">Chart of Accounts</button>
        <button class="tab" data-setting="users">User Management</button>
      </div>
      
      <div id="settingsContent">
        <!-- Dynamic content loaded here -->
      </div>
    </div>
  </div>
  
  <!-- Modals -->
  <div class="modalOverlay" id="modalOverlay"></div>
  
  <!-- User Modal -->
  <div class="modal" id="userModal">
    <div class="modal-header">
      <h2 id="userModalTitle">Add User</h2>
      <button class="close-btn" onclick="closeModal('userModal')">&times;</button>
    </div>
    <div class="form-group">
      <label>Username *</label>
      <input type="text" id="userName" style="width: 100%;" />
    </div>
    <div class="form-group">
      <label>Role *</label>
      <select id="userRole" style="width: 100%;">
        <option value="Admin">Admin</option>
        <option value="User">User</option>
      </select>
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="userEmail" style="width: 100%;" />
    </div>
    <div class="form-group">
      <h3>Permissions</h3>
      <label style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="userPermView" checked />
        View
      </label>
      <label style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="userPermEdit" checked />
        Edit
      </label>
      <label style="display: flex; align-items: center; gap: 6px;">
        <input type="checkbox" id="userPermDelete" />
        Delete
      </label>
    </div>
    <div style="margin-top: 12px;">
      <button class="primary" id="btnSaveUser">Save</button>
      <button onclick="closeModal('userModal')">Cancel</button>
    </div>
  </div>
  
  <!-- Business Modal -->
  <div class="modal" id="businessModal">
    <div class="modal-header">
      <h2 id="businessModalTitle">Add Business</h2>
      <button class="close-btn" onclick="closeModal('businessModal')">&times;</button>
    </div>
    <div class="grid">
      <div class="form-group">
        <label>Business Name *</label>
        <input type="text" id="businessName" />
      </div>
      <div class="form-group">
        <label>Entity Type *</label>
        <select id="businessEntityType">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole Proprietor</option>
        </select>
      </div>
    </div>
    
    <h3>Tax Settings</h3>
    <div class="grid">
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="businessVATEnabled" checked />
          Enable VAT
        </label>
        <input type="number" id="businessVATRate" placeholder="VAT Rate %" step="0.01" style="width: 100%;" />
      </div>
      
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="businessWHTEnabled" checked />
          Enable WHT
        </label>
        <input type="number" id="businessWHTRate" placeholder="WHT Rate %" step="0.01" style="width: 100%;" />
      </div>
      
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="businessPAYEEnabled" checked />
          Enable PAYE
        </label>
      </div>
      
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="businessPITEnabled" checked />
          Enable PIT
        </label>
      </div>
      
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="businessCITEnabled" checked />
          Enable CIT
        </label>
        <input type="number" id="businessCITRate" placeholder="CIT Rate %" step="0.01" style="width: 100%;" />
      </div>
      
      <div class="form-group">
        <label>Default CA Rate %</label>
        <input type="number" id="businessCARate" step="0.01" style="width: 100%;" />
      </div>
    </div>
    
    <h3>Carry Forwards</h3>
    <div class="grid">
      <div class="form-group">
        <label>Loss Brought Forward</label>
        <input type="number" id="businessLossBF" step="0.01" style="width: 100%;" />
      </div>
      <div class="form-group">
        <label>CA Carryforward</label>
        <input type="number" id="businessCABF" step="0.01" style="width: 100%;" />
      </div>
      <div class="form-group">
        <label>Capital Brought Forward</label>
        <input type="number" id="businessCapitalBF" step="0.01" style="width: 100%;" />
      </div>
      <div class="form-group">
        <label>Chargeable Loss B/F</label>
        <input type="number" id="businessChargeableLossBF" step="0.01" style="width: 100%;" />
      </div>
      <div class="form-group">
        <label>WHT Receivable B/F</label>
        <input type="number" id="businessWHTReceivableBF" step="0.01" style="width: 100%;" />
      </div>
    </div>
    
    <h3>Statutory Deductions Defaults</h3>
    <div class="grid">
      <div class="form-group">
        <label>Pension Default %</label>
        <input type="number" id="businessPensionRate" step="0.01" style="width: 100%;" />
      </div>
      <div class="form-group">
        <label>Rent Relief %</label>
        <input type="number" id="businessRentReliefRate" step="0.01" style="width: 100%;" />
      </div>
      <div class="form-group">
        <label>NHF Default %</label>
        <input type="number" id="businessNHFRate" step="0.01" style="width: 100%;" />
      </div>
    </div>
    
    <div style="margin-top: 12px;">
      <button class="primary" id="btnSaveBusiness">Save</button>
      <button onclick="closeModal('businessModal')">Cancel</button>
    </div>
  </div>
  
  <!-- Accounts Modal -->
  <div class="modal" id="accountsModal">
    <div class="modal-header">
      <h2>Manage Chart of Accounts</h2>
      <button class="close-btn" onclick="closeModal('accountsModal')">&times;</button>
    </div>
    
    <div class="form-section">
      <h3>Add Account</h3>
      <div class="grid">
        <input type="text" id="accountName" placeholder="Account name" />
        <select id="accountCategory">
          <option value="Revenue">Revenue</option>
          <option value="Expense">Expense</option>
          <option value="Asset">Asset</option>
          <option value="Liability">Liability</option>
          <option value="Capital">Capital</option>
        </select>
        <button class="primary" id="btnAddAccount">Add Account</button>
      </div>
      
      <div class="row" style="margin-top: 8px;">
        <label style="display: flex; align-items: center; gap: 4px;">
          <input type="checkbox" id="accountDisallowable" />
          Disallowable (tax)
        </label>
        <label style="display: flex; align-items: center; gap: 4px;">
          <input type="checkbox" id="accountNonTaxable" />
          Non-taxable
        </label>
        <select id="accountRentFrequency" style="width: 120px;">
          <option value="">No rent</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
        </select>
      </div>
    </div>
    
    <div style="margin-top: 16px;">
      <h3>Current Accounts</h3>
      <div id="accountsList"></div>
    </div>
    
    <div style="margin-top: 12px;">
      <button onclick="closeModal('accountsModal')">Close</button>
    </div>
  </div>
  
  <!-- Receipt Preview Modal -->
  <div class="modal" id="receiptModal">
    <div class="modal-header">
      <h2>Receipt Preview</h2>
      <button class="close-btn" onclick="closeModal('receiptModal')">&times;</button>
    </div>
    <div id="receiptModalContent"></div>
    <div style="margin-top: 12px;">
      <button onclick="closeModal('receiptModal')">Close</button>
    </div>
  </div>

  <script>
    // ============================================================================
    // NIGERIA TAX & ACCOUNTING SYSTEM - FULL IMPLEMENTATION
    // ============================================================================
    
    'use strict';
    
    // Storage key
    const STORAGE_KEY = 'ntc_full_accounting_v1';
    
    // Global state
    let appState = {
      users: [],
      businesses: [],
      activeUserId: null,
      activeBusinessId: null,
      lastOperation: null // For undo functionality
    };
    
    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    function init() {
      loadData();
      initializeUI();
      renderUsers();
      renderBusinesses();
      switchTab('ledger');
      
      // Set active user/business
      if (appState.users.length > 0 && !appState.activeUserId) {
        appState.activeUserId = appState.users[0].id;
      }
      if (appState.businesses.length > 0 && !appState.activeBusinessId) {
        appState.activeBusinessId = appState.businesses[0].id;
      }
      
      updateActiveSelections();
      renderAll();
    }
    
    function initializeUI() {
      // Tab switching
      document.querySelectorAll('.tab[data-tab]').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // User actions
      document.getElementById('btnAddUser').addEventListener('click', () => openUserModal());
      document.getElementById('btnEditUser').addEventListener('click', () => editCurrentUser());
      document.getElementById('btnSaveUser').addEventListener('click', () => saveUser());
      document.getElementById('userSelect').addEventListener('change', (e) => {
        appState.activeUserId = e.target.value;
        saveData();
        renderAll();
      });
      
      // Business actions
      document.getElementById('btnAddBusiness').addEventListener('click', () => openBusinessModal());
      document.getElementById('btnEditBusiness').addEventListener('click', () => editCurrentBusiness());
      document.getElementById('btnSaveBusiness').addEventListener('click', () => saveBusiness());
      document.getElementById('businessSelect').addEventListener('change', (e) => {
        appState.activeBusinessId = e.target.value;
        saveData();
        renderAll();
      });
      
      // Transaction actions
      document.getElementById('btnAddTransaction').addEventListener('click', () => addTransaction());
      document.getElementById('btnCancelTransaction').addEventListener('click', () => clearTransactionForm());
      document.getElementById('btnUndoLast').addEventListener('click', () => undoLastOperation());
      document.getElementById('txType').addEventListener('change', () => updateTransactionFormVisibility());
      document.getElementById('txReceipt').addEventListener('change', handleReceiptUpload);
      
      // Inventory actions
      document.getElementById('btnAddInventory').addEventListener('click', () => addInventoryItem());
      
      // Asset actions
      document.getElementById('btnAddAsset').addEventListener('click', () => addFixedAsset());
      
      // Export/Import
      document.getElementById('btnExportJSON').addEventListener('click', () => exportJSON());
      document.getElementById('btnImportJSON').addEventListener('click', () => document.getElementById('fileImportJSON').click());
      document.getElementById('fileImportJSON').addEventListener('change', handleImportJSON);
      document.getElementById('btnClearAll').addEventListener('click', () => clearAllData());
      
      // Reports
      document.querySelectorAll('.tab[data-report]').forEach(tab => {
        tab.addEventListener('click', () => {
          const reportType = tab.getAttribute('data-report');
          showReport(reportType);
          document.querySelectorAll('.tab[data-report]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
        });
      });
      
      document.getElementById('btnExportCSV').addEventListener('click', () => exportReport('csv'));
      document.getElementById('btnExportPDF').addEventListener('click', () => exportReport('pdf'));
      document.getElementById('btnExportXLSX').addEventListener('click', () => exportReport('xlsx'));
      
      // Settings
      document.querySelectorAll('.tab[data-setting]').forEach(tab => {
        tab.addEventListener('click', () => {
          const settingType = tab.getAttribute('data-setting');
          showSettings(settingType);
          document.querySelectorAll('.tab[data-setting]').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
        });
      });
      
      // Accounts management
      document.getElementById('btnManageAccounts')?.addEventListener('click', () => openAccountsModal());
      document.getElementById('btnAddAccount')?.addEventListener('click', () => addAccount());
      
      // Set default date to today
      document.getElementById('txDate').valueAsDate = new Date();
    }
    
    // ============================================================================
    // DATA MANAGEMENT
    // ============================================================================
    
    function loadData() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          appState = JSON.parse(stored);
          console.log('Data loaded from localStorage');
        } catch (e) {
          console.error('Error loading data:', e);
          seedData();
        }
      } else {
        seedData();
      }
    }
    
    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        console.log('Data saved to localStorage');
      } catch (e) {
        console.error('Error saving data:', e);
        alert('Error saving data. Storage may be full.');
      }
    }
    
    function seedData() {
      console.log('Seeding initial data...');
      
      // Create Admin user
      const adminUser = {
        id: generateId(),
        username: 'Admin',
        role: 'Admin',
        email: 'admin@example.com',
        permissions: { view: true, edit: true, delete: true }
      };
      
      // Create demo business
      const demoBusiness = {
        id: generateId(),
        name: 'Demo Business Ltd',
        entityType: 'Company',
        settings: {
          vatEnabled: true,
          vatRate: 7.5,
          whtEnabled: true,
          whtRate: 5.0,
          payeEnabled: true,
          pitEnabled: true,
          citEnabled: true,
          citRate: 25.0,
          caRate: 20.0,
          lossBF: 50000,
          caBF: 10000,
          capitalBF: 500000,
          chargeableLossBF: 0,
          whtReceivableBF: 5000,
          pensionRate: 8.0,
          rentReliefRate: 20.0,
          nhfRate: 2.5
        },
        accounts: [
          { id: generateId(), name: 'Sales Revenue', category: 'Revenue', disallowable: false, nonTaxable: false },
          { id: generateId(), name: 'Service Income', category: 'Revenue', disallowable: false, nonTaxable: false },
          { id: generateId(), name: 'Cost of Goods Sold', category: 'Expense', disallowable: false, nonTaxable: false },
          { id: generateId(), name: 'Salaries', category: 'Expense', disallowable: false, nonTaxable: false },
          { id: generateId(), name: 'Rent Expense', category: 'Expense', disallowable: false, nonTaxable: false, rentFrequency: 'monthly' },
          { id: generateId(), name: 'Utilities', category: 'Expense', disallowable: false, nonTaxable: false },
          { id: generateId(), name: 'Entertainment', category: 'Expense', disallowable: true, nonTaxable: false },
          { id: generateId(), name: 'Bank Account', category: 'Asset', disallowable: false, nonTaxable: false },
          { id: generateId(), name: 'Accounts Payable', category: 'Liability', disallowable: false, nonTaxable: false },
          { id: generateId(), name: 'Share Capital', category: 'Capital', disallowable: false, nonTaxable: false }
        ],
        transactions: [],
        inventory: [
          {
            id: generateId(),
            name: 'Product A',
            quantity: 100,
            avgCost: 1000,
            totalValue: 100000
          }
        ],
        assets: [
          {
            id: generateId(),
            name: 'Office Equipment',
            cost: 500000,
            purchaseDate: '2024-01-15',
            usefulLife: 5,
            caRate: 20,
            depRate: 20,
            classification: 'fixed',
            accumulatedDepreciation: 0,
            accumulatedCA: 0,
            disposed: false
          },
          {
            id: generateId(),
            name: 'Investment Property',
            cost: 2000000,
            purchaseDate: '2024-03-01',
            usefulLife: 20,
            caRate: 10,
            depRate: 5,
            classification: 'chargeable',
            accumulatedDepreciation: 0,
            accumulatedCA: 0,
            disposed: false
          }
        ]
      };
      
      // Add sample transactions
      const salesAccountId = demoBusiness.accounts.find(a => a.name === 'Sales Revenue').id;
      const salariesAccountId = demoBusiness.accounts.find(a => a.name === 'Salaries').id;
      const rentAccountId = demoBusiness.accounts.find(a => a.name === 'Rent Expense').id;
      const entertainmentAccountId = demoBusiness.accounts.find(a => a.name === 'Entertainment').id;
      
      demoBusiness.transactions = [
        {
          id: generateId(),
          date: '2024-10-01',
          type: 'revenue',
          account: salesAccountId,
          amount: 500000,
          description: 'Sales for October',
          contact: 'Customer A',
          vat: { enabled: true, mode: 'exclusive', rate: 7.5, amount: 37500 },
          wht: { enabled: false },
          paye: false,
          receipt: null
        },
        {
          id: generateId(),
          date: '2024-10-05',
          type: 'expense',
          account: salariesAccountId,
          amount: 200000,
          description: 'Monthly salaries',
          contact: 'Employee Team',
          vat: { enabled: false },
          wht: { enabled: false },
          paye: true,
          receipt: null
        },
        {
          id: generateId(),
          date: '2024-10-10',
          type: 'expense',
          account: rentAccountId,
          amount: 50000,
          description: 'Office rent',
          contact: 'Landlord',
          vat: { enabled: false },
          wht: { enabled: true, basis: 'gross', rate: 10, amount: 5000 },
          paye: false,
          receipt: null
        },
        {
          id: generateId(),
          date: '2024-10-15',
          type: 'expense',
          account: entertainmentAccountId,
          amount: 30000,
          description: 'Client entertainment',
          contact: 'Various',
          vat: { enabled: false },
          wht: { enabled: false },
          paye: false,
          receipt: null
        }
      ];
      
      appState.users = [adminUser];
      appState.businesses = [demoBusiness];
      appState.activeUserId = adminUser.id;
      appState.activeBusinessId = demoBusiness.id;
      
      saveData();
      console.log('Seed data created successfully');
    }
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    function generateId() {
      return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function formatCurrency(amount) {
      return '‚Ç¶' + parseFloat(amount || 0).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function formatNumber(num) {
      return parseFloat(num || 0).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function getActiveBusiness() {
      return appState.businesses.find(b => b.id === appState.activeBusinessId);
    }
    
    function getActiveUser() {
      return appState.users.find(u => u.id === appState.activeUserId);
    }
    
    function hasPermission(permission) {
      const user = getActiveUser();
      if (!user) return false;
      if (user.role === 'Admin') return true;
      return user.permissions[permission] || false;
    }
    
    // ============================================================================
    // UI RENDERING
    // ============================================================================
    
    function renderAll() {
      renderTransactions();
      renderInventory();
      renderAssets();
      renderTaxSummary();
      renderProfitLoss();
      updateTransactionFormAccounts();
      updateInventorySelects();
      updateAssetSelects();
    }
    
    function updateActiveSelections() {
      const userSelect = document.getElementById('userSelect');
      const businessSelect = document.getElementById('businessSelect');
      
      if (userSelect.value !== appState.activeUserId) {
        userSelect.value = appState.activeUserId;
      }
      if (businessSelect.value !== appState.activeBusinessId) {
        businessSelect.value = appState.activeBusinessId;
      }
    }
    
    function renderUsers() {
      const select = document.getElementById('userSelect');
      select.innerHTML = appState.users.map(user => 
        `<option value="${user.id}">${user.username} (${user.role})</option>`
      ).join('');
      select.value = appState.activeUserId;
    }
    
    function renderBusinesses() {
      const select = document.getElementById('businessSelect');
      select.innerHTML = appState.businesses.map(biz => 
        `<option value="${biz.id}">${biz.name}</option>`
      ).join('');
      select.value = appState.activeBusinessId;
    }
    
    function renderTransactions() {
      const business = getActiveBusiness();
      if (!business) return;
      
      const tbody = document.getElementById('transactionsBody');
      const canEdit = hasPermission('edit');
      const canDelete = hasPermission('delete');
      
      tbody.innerHTML = business.transactions.map(tx => {
        const account = business.accounts.find(a => a.id === tx.account);
        const vatInfo = tx.vat?.enabled ? formatCurrency(tx.vat.amount) : '-';
        const whtInfo = tx.wht?.enabled ? formatCurrency(tx.wht.amount) : '-';
        const receiptIcon = tx.receipt ? 
          `<span class="link-like" onclick="viewReceipt('${tx.id}')">üìé</span>` : '-';
        
        return `
          <tr>
            <td>${tx.date}</td>
            <td><span class="badge badge-${tx.type === 'revenue' ? 'success' : 'warning'}">${tx.type}</span></td>
            <td>${account?.name || 'Unknown'}</td>
            <td>${tx.description || '-'}</td>
            <td>${tx.contact || '-'}</td>
            <td>${formatCurrency(tx.amount)}</td>
            <td>${vatInfo}</td>
            <td>${whtInfo}</td>
            <td>${receiptIcon}</td>
            <td class="no-print actions">
              <button class="small" onclick="editTransaction('${tx.id}')" ${!canEdit ? 'disabled' : ''}>Edit</button>
              <button class="small danger" onclick="deleteTransaction('${tx.id}')" ${!canDelete ? 'disabled' : ''}>Del</button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function renderInventory() {
      const business = getActiveBusiness();
      if (!business) return;
      
      const tbody = document.getElementById('inventoryBody');
      tbody.innerHTML = business.inventory.map(item => `
        <tr>
          <td>${item.name}</td>
          <td>${formatNumber(item.quantity)}</td>
          <td>${formatCurrency(item.avgCost)}</td>
          <td>${formatCurrency(item.totalValue)}</td>
          <td class="no-print actions">
            <button class="small danger" onclick="deleteInventoryItem('${item.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }
    
    function renderAssets() {
      const business = getActiveBusiness();
      if (!business) return;
      
      const tbody = document.getElementById('assetsBody');
      tbody.innerHTML = business.assets.map(asset => {
        // Calculate depreciation and CA for current asset
        const dep = calculateDepreciation(asset);
        const ca = calculateCapitalAllowance(asset);
        const bookValue = asset.cost - dep.accumulated;
        const status = asset.disposed ? 
          `<span class="badge badge-danger">Disposed</span>` :
          `<span class="badge badge-success">Active</span>`;
        
        return `
          <tr>
            <td>${asset.name}</td>
            <td><span class="badge">${asset.classification}</span></td>
            <td>${formatCurrency(asset.cost)}</td>
            <td>${asset.purchaseDate}</td>
            <td>${formatCurrency(dep.accumulated)}</td>
            <td>${formatCurrency(bookValue)}</td>
            <td>${formatCurrency(ca.forYear)}</td>
            <td>${status}</td>
            <td class="no-print actions">
              ${!asset.disposed ? `<button class="small danger" onclick="disposeAsset('${asset.id}')">Dispose</button>` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function renderTaxSummary() {
      const business = getActiveBusiness();
      if (!business) {
        document.getElementById('taxSummaryContent').innerHTML = '<p class="muted">No business selected</p>';
        return;
      }
      
      const taxCalcs = calculateAllTaxes(business);
      
      const html = `
        <div style="display: grid; gap: 8px;">
          <div><strong>VAT Collected:</strong> ${formatCurrency(taxCalcs.vat.collected)}</div>
          <div><strong>VAT Paid:</strong> ${formatCurrency(taxCalcs.vat.paid)}</div>
          <div><strong>VAT Net:</strong> <strong>${formatCurrency(taxCalcs.vat.net)}</strong></div>
          <hr style="margin: 6px 0;" />
          <div><strong>WHT Receivable:</strong> ${formatCurrency(taxCalcs.wht.receivable)}</div>
          <div><strong>WHT Payable:</strong> ${formatCurrency(taxCalcs.wht.payable)}</div>
          <hr style="margin: 6px 0;" />
          <div><strong>PAYE (Total):</strong> ${formatCurrency(taxCalcs.paye.total)}</div>
          <div><strong>PIT:</strong> ${formatCurrency(taxCalcs.pit.amount)}</div>
          <div><strong>CIT:</strong> ${formatCurrency(taxCalcs.cit.amount)}</div>
        </div>
      `;
      
      document.getElementById('taxSummaryContent').innerHTML = html;
    }
    
    function renderProfitLoss() {
      const business = getActiveBusiness();
      if (!business) {
        document.getElementById('profitLossContent').innerHTML = '<p class="muted">No business selected</p>';
        return;
      }
      
      const profitCalcs = calculateProfitAndLoss(business);
      
      const html = `
        <div style="display: grid; gap: 8px;">
          <div><strong>Total Revenue:</strong> ${formatCurrency(profitCalcs.revenue)}</div>
          <div><strong>COGS:</strong> ${formatCurrency(profitCalcs.cogs)}</div>
          <div><strong>Gross Profit:</strong> ${formatCurrency(profitCalcs.grossProfit)}</div>
          <div><strong>Total Expenses:</strong> ${formatCurrency(profitCalcs.expenses)}</div>
          <div><strong>Depreciation:</strong> ${formatCurrency(profitCalcs.depreciation)}</div>
          <hr style="margin: 6px 0;" />
          <div><strong>Accounting Profit:</strong> <strong>${formatCurrency(profitCalcs.accountingProfit)}</strong></div>
          <hr style="margin: 6px 0;" />
          <div><strong>Taxable Profit:</strong> <strong>${formatCurrency(profitCalcs.taxableProfit)}</strong></div>
        </div>
      `;
      
      document.getElementById('profitLossContent').innerHTML = html;
    }
    
    // ============================================================================
    // MODAL MANAGEMENT
    // ============================================================================
    
    function openModal(modalId) {
      document.getElementById('modalOverlay').classList.add('show');
      document.getElementById(modalId).classList.add('show');
    }
    
    function closeModal(modalId) {
      document.getElementById('modalOverlay').classList.remove('show');
      document.getElementById(modalId).classList.remove('show');
    }
    
    function openUserModal(userId = null) {
      const modal = document.getElementById('userModal');
      const title = document.getElementById('userModalTitle');
      
      if (userId) {
        const user = appState.users.find(u => u.id === userId);
        if (user) {
          title.textContent = 'Edit User';
          document.getElementById('userName').value = user.username;
          document.getElementById('userRole').value = user.role;
          document.getElementById('userEmail').value = user.email || '';
          document.getElementById('userPermView').checked = user.permissions.view;
          document.getElementById('userPermEdit').checked = user.permissions.edit;
          document.getElementById('userPermDelete').checked = user.permissions.delete;
          modal.dataset.userId = userId;
        }
      } else {
        title.textContent = 'Add User';
        document.getElementById('userName').value = '';
        document.getElementById('userRole').value = 'User';
        document.getElementById('userEmail').value = '';
        document.getElementById('userPermView').checked = true;
        document.getElementById('userPermEdit').checked = true;
        document.getElementById('userPermDelete').checked = false;
        delete modal.dataset.userId;
      }
      
      openModal('userModal');
    }
    
    function saveUser() {
      const modal = document.getElementById('userModal');
      const userId = modal.dataset.userId;
      
      const username = document.getElementById('userName').value.trim();
      if (!username) {
        alert('Username is required');
        return;
      }
      
      const userData = {
        username,
        role: document.getElementById('userRole').value,
        email: document.getElementById('userEmail').value.trim(),
        permissions: {
          view: document.getElementById('userPermView').checked,
          edit: document.getElementById('userPermEdit').checked,
          delete: document.getElementById('userPermDelete').checked
        }
      };
      
      if (userId) {
        // Edit existing user
        const user = appState.users.find(u => u.id === userId);
        if (user) {
          Object.assign(user, userData);
        }
      } else {
        // Add new user
        appState.users.push({
          id: generateId(),
          ...userData
        });
      }
      
      saveData();
      renderUsers();
      closeModal('userModal');
    }
    
    function editCurrentUser() {
      if (appState.activeUserId) {
        openUserModal(appState.activeUserId);
      }
    }
    
    function openBusinessModal(businessId = null) {
      const modal = document.getElementById('businessModal');
      const title = document.getElementById('businessModalTitle');
      
      if (businessId) {
        const biz = appState.businesses.find(b => b.id === businessId);
        if (biz) {
          title.textContent = 'Edit Business';
          document.getElementById('businessName').value = biz.name;
          document.getElementById('businessEntityType').value = biz.entityType;
          
          const s = biz.settings || {};
          document.getElementById('businessVATEnabled').checked = s.vatEnabled !== false;
          document.getElementById('businessVATRate').value = s.vatRate || 7.5;
          document.getElementById('businessWHTEnabled').checked = s.whtEnabled !== false;
          document.getElementById('businessWHTRate').value = s.whtRate || 5.0;
          document.getElementById('businessPAYEEnabled').checked = s.payeEnabled !== false;
          document.getElementById('businessPITEnabled').checked = s.pitEnabled !== false;
          document.getElementById('businessCITEnabled').checked = s.citEnabled !== false;
          document.getElementById('businessCITRate').value = s.citRate || 25.0;
          document.getElementById('businessCARate').value = s.caRate || 20.0;
          document.getElementById('businessLossBF').value = s.lossBF || 0;
          document.getElementById('businessCABF').value = s.caBF || 0;
          document.getElementById('businessCapitalBF').value = s.capitalBF || 0;
          document.getElementById('businessChargeableLossBF').value = s.chargeableLossBF || 0;
          document.getElementById('businessWHTReceivableBF').value = s.whtReceivableBF || 0;
          document.getElementById('businessPensionRate').value = s.pensionRate || 8.0;
          document.getElementById('businessRentReliefRate').value = s.rentReliefRate || 20.0;
          document.getElementById('businessNHFRate').value = s.nhfRate || 2.5;
          
          modal.dataset.businessId = businessId;
        }
      } else {
        title.textContent = 'Add Business';
        document.getElementById('businessName').value = '';
        document.getElementById('businessEntityType').value = 'Company';
        document.getElementById('businessVATEnabled').checked = true;
        document.getElementById('businessVATRate').value = 7.5;
        document.getElementById('businessWHTEnabled').checked = true;
        document.getElementById('businessWHTRate').value = 5.0;
        document.getElementById('businessPAYEEnabled').checked = true;
        document.getElementById('businessPITEnabled').checked = true;
        document.getElementById('businessCITEnabled').checked = true;
        document.getElementById('businessCITRate').value = 25.0;
        document.getElementById('businessCARate').value = 20.0;
        document.getElementById('businessLossBF').value = 0;
        document.getElementById('businessCABF').value = 0;
        document.getElementById('businessCapitalBF').value = 0;
        document.getElementById('businessChargeableLossBF').value = 0;
        document.getElementById('businessWHTReceivableBF').value = 0;
        document.getElementById('businessPensionRate').value = 8.0;
        document.getElementById('businessRentReliefRate').value = 20.0;
        document.getElementById('businessNHFRate').value = 2.5;
        delete modal.dataset.businessId;
      }
      
      openModal('businessModal');
    }
    
    function saveBusiness() {
      const modal = document.getElementById('businessModal');
      const businessId = modal.dataset.businessId;
      
      const name = document.getElementById('businessName').value.trim();
      if (!name) {
        alert('Business name is required');
        return;
      }
      
      const businessData = {
        name,
        entityType: document.getElementById('businessEntityType').value,
        settings: {
          vatEnabled: document.getElementById('businessVATEnabled').checked,
          vatRate: parseFloat(document.getElementById('businessVATRate').value) || 7.5,
          whtEnabled: document.getElementById('businessWHTEnabled').checked,
          whtRate: parseFloat(document.getElementById('businessWHTRate').value) || 5.0,
          payeEnabled: document.getElementById('businessPAYEEnabled').checked,
          pitEnabled: document.getElementById('businessPITEnabled').checked,
          citEnabled: document.getElementById('businessCITEnabled').checked,
          citRate: parseFloat(document.getElementById('businessCITRate').value) || 25.0,
          caRate: parseFloat(document.getElementById('businessCARate').value) || 20.0,
          lossBF: parseFloat(document.getElementById('businessLossBF').value) || 0,
          caBF: parseFloat(document.getElementById('businessCABF').value) || 0,
          capitalBF: parseFloat(document.getElementById('businessCapitalBF').value) || 0,
          chargeableLossBF: parseFloat(document.getElementById('businessChargeableLossBF').value) || 0,
          whtReceivableBF: parseFloat(document.getElementById('businessWHTReceivableBF').value) || 0,
          pensionRate: parseFloat(document.getElementById('businessPensionRate').value) || 8.0,
          rentReliefRate: parseFloat(document.getElementById('businessRentReliefRate').value) || 20.0,
          nhfRate: parseFloat(document.getElementById('businessNHFRate').value) || 2.5
        }
      };
      
      if (businessId) {
        // Edit existing business
        const biz = appState.businesses.find(b => b.id === businessId);
        if (biz) {
          Object.assign(biz, businessData);
        }
      } else {
        // Add new business
        appState.businesses.push({
          id: generateId(),
          ...businessData,
          accounts: [],
          transactions: [],
          inventory: [],
          assets: []
        });
      }
      
      saveData();
      renderBusinesses();
      closeModal('businessModal');
      renderAll();
    }
    
    function editCurrentBusiness() {
      if (appState.activeBusinessId) {
        openBusinessModal(appState.activeBusinessId);
      }
    }
    
    function openAccountsModal() {
      const business = getActiveBusiness();
      if (!business) {
        alert('Please select a business first');
        return;
      }
      
      renderAccountsList();
      openModal('accountsModal');
    }
    
    function renderAccountsList() {
      const business = getActiveBusiness();
      if (!business) return;
      
      const container = document.getElementById('accountsList');
      container.innerHTML = business.accounts.map(acc => `
        <div class="account-row">
          <div>
            <strong>${acc.name}</strong>
            <span class="badge">${acc.category}</span>
            ${acc.disallowable ? '<span class="flag">Disallowable</span>' : ''}
            ${acc.nonTaxable ? '<span class="flag">Non-taxable</span>' : ''}
            ${acc.rentFrequency ? `<span class="flag">${acc.rentFrequency}</span>` : ''}
          </div>
          <button class="small danger" onclick="deleteAccount('${acc.id}')">Delete</button>
        </div>
      `).join('');
    }
    
    function addAccount() {
      const business = getActiveBusiness();
      if (!business) return;
      
      const name = document.getElementById('accountName').value.trim();
      const category = document.getElementById('accountCategory').value;
      
      if (!name) {
        alert('Account name is required');
        return;
      }
      
      business.accounts.push({
        id: generateId(),
        name,
        category,
        disallowable: document.getElementById('accountDisallowable').checked,
        nonTaxable: document.getElementById('accountNonTaxable').checked,
        rentFrequency: document.getElementById('accountRentFrequency').value
      });
      
      document.getElementById('accountName').value = '';
      document.getElementById('accountDisallowable').checked = false;
      document.getElementById('accountNonTaxable').checked = false;
      document.getElementById('accountRentFrequency').value = '';
      
      saveData();
      renderAccountsList();
      updateTransactionFormAccounts();
    }
    
    function deleteAccount(accountId) {
      if (!confirm('Delete this account?')) return;
      
      const business = getActiveBusiness();
      if (!business) return;
      
      business.accounts = business.accounts.filter(a => a.id !== accountId);
      saveData();
      renderAccountsList();
      updateTransactionFormAccounts();
    }
    
    // ============================================================================
    // TRANSACTION MANAGEMENT
    // ============================================================================
    
    function updateTransactionFormAccounts() {
      const business = getActiveBusiness();
      if (!business) return;
      
      const select = document.getElementById('txAccount');
      select.innerHTML = '<option value="">-- Select Account --</option>' +
        business.accounts.map(acc => 
          `<option value="${acc.id}">${acc.name} (${acc.category})</option>`
        ).join('');
    }
    
    function updateTransactionFormVisibility() {
      const txType = document.getElementById('txType').value;
      const invSelection = document.getElementById('inventorySelection');
      const assetSelection = document.getElementById('assetSelection');
      
      invSelection.classList.add('hidden');
      assetSelection.classList.add('hidden');
      
      if (txType === 'inventory_purchase' || txType === 'inventory_sale') {
        invSelection.classList.remove('hidden');
        updateInventorySelects();
      } else if (txType === 'asset_disposal') {
        assetSelection.classList.remove('hidden');
        updateAssetSelects();
      }
    }
    
    function updateInventorySelects() {
      const business = getActiveBusiness();
      if (!business) return;
      
      const select = document.getElementById('txInventoryItem');
      select.innerHTML = '<option value="">-- Select Item --</option>' +
        business.inventory.map(item => 
          `<option value="${item.id}">${item.name} (Qty: ${item.quantity})</option>`
        ).join('');
    }
    
    function updateAssetSelects() {
      const business = getActiveBusiness();
      if (!business) return;
      
      const select = document.getElementById('txAssetItem');
      const activeAssets = business.assets.filter(a => !a.disposed);
      select.innerHTML = '<option value="">-- Select Asset --</option>' +
        activeAssets.map(asset => 
          `<option value="${asset.id}">${asset.name}</option>`
        ).join('');
    }
    
    function handleReceiptUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('File too large. Maximum 5MB.');
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('receiptPreview').textContent = '‚úì ' + file.name;
      };
      reader.readAsDataURL(file);
    }
    
    function addTransaction() {
      const business = getActiveBusiness();
      if (!business || !hasPermission('edit')) {
        alert('You do not have permission to add transactions');
        return;
      }
      
      const txType = document.getElementById('txType').value;
      const date = document.getElementById('txDate').value;
      const account = document.getElementById('txAccount').value;
      const amount = parseFloat(document.getElementById('txAmount').value);
      const contact = document.getElementById('txContact').value.trim();
      const description = document.getElementById('txDescription').value.trim();
      
      if (!date || !account || !amount || amount <= 0) {
        alert('Please fill in all required fields');
        return;
      }
      
      // VAT calculation
      const vatEnabled = document.getElementById('txVATEnabled').checked;
      const vatMode = document.getElementById('txVATMode').value;
      const vatRate = parseFloat(document.getElementById('txVATRate').value) || business.settings.vatRate || 7.5;
      
      let vatAmount = 0;
      if (vatEnabled) {
        if (vatMode === 'exclusive') {
          vatAmount = amount * (vatRate / 100);
        } else {
          // Inclusive: VAT = amount * rate / (100 + rate)
          vatAmount = amount * vatRate / (100 + vatRate);
        }
      }
      
      // WHT calculation
      const whtEnabled = document.getElementById('txWHTEnabled').checked;
      const whtBasis = document.getElementById('txWHTBasis').value;
      const whtRate = parseFloat(document.getElementById('txWHTRate').value) || business.settings.whtRate || 5.0;
      
      let whtAmount = 0;
      if (whtEnabled) {
        if (whtBasis === 'gross') {
          whtAmount = amount * (whtRate / 100);
        } else {
          // Net basis: WHT = (net / (1 - rate)) * rate
          whtAmount = (amount / (1 - whtRate / 100)) * (whtRate / 100);
        }
      }
      
      const transaction = {
        id: generateId(),
        date,
        type: txType,
        account,
        amount,
        description,
        contact,
        vat: {
          enabled: vatEnabled,
          mode: vatMode,
          rate: vatRate,
          amount: vatAmount
        },
        wht: {
          enabled: whtEnabled,
          basis: whtBasis,
          rate: whtRate,
          amount: whtAmount
        },
        paye: document.getElementById('txPAYE').checked,
        receipt: null
      };
      
      // Handle receipt upload
      const receiptFile = document.getElementById('txReceipt').files[0];
      if (receiptFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
          transaction.receipt = {
            name: receiptFile.name,
            type: receiptFile.type,
            data: e.target.result
          };
          finalizeTransaction(transaction, txType);
        };
        reader.readAsDataURL(receiptFile);
      } else {
        finalizeTransaction(transaction, txType);
      }
    }
    
    function finalizeTransaction(transaction, txType) {
      const business = getActiveBusiness();
      
      // Handle inventory transactions
      if (txType === 'inventory_purchase') {
        const itemId = document.getElementById('txInventoryItem').value;
        const qty = parseFloat(document.getElementById('txInventoryQty').value);
        
        if (!itemId || !qty || qty <= 0) {
          alert('Please select inventory item and quantity');
          return;
        }
        
        const item = business.inventory.find(i => i.id === itemId);
        if (item) {
          // Weighted average cost
          const newTotalValue = item.totalValue + transaction.amount;
          const newQuantity = item.quantity + qty;
          item.avgCost = newTotalValue / newQuantity;
          item.quantity = newQuantity;
          item.totalValue = newTotalValue;
          
          transaction.inventoryItem = itemId;
          transaction.inventoryQty = qty;
        }
      } else if (txType === 'inventory_sale') {
        const itemId = document.getElementById('txInventoryItem').value;
        const qty = parseFloat(document.getElementById('txInventoryQty').value);
        
        if (!itemId || !qty || qty <= 0) {
          alert('Please select inventory item and quantity');
          return;
        }
        
        const item = business.inventory.find(i => i.id === itemId);
        if (item) {
          if (item.quantity < qty) {
            alert('Insufficient inventory quantity');
            return;
          }
          
          // Calculate COGS
          const cogs = item.avgCost * qty;
          item.quantity -= qty;
          item.totalValue = item.quantity * item.avgCost;
          
          transaction.inventoryItem = itemId;
          transaction.inventoryQty = qty;
          transaction.cogs = cogs;
          
          // Create COGS entry
          const cogsAccount = business.accounts.find(a => a.name === 'Cost of Goods Sold');
          if (cogsAccount) {
            business.transactions.push({
              id: generateId(),
              date: transaction.date,
              type: 'expense',
              account: cogsAccount.id,
              amount: cogs,
              description: `COGS for ${item.name} sale`,
              contact: '',
              vat: { enabled: false },
              wht: { enabled: false },
              paye: false,
              receipt: null
            });
          }
        }
      } else if (txType === 'asset_disposal') {
        const assetId = document.getElementById('txAssetItem').value;
        const proceeds = parseFloat(document.getElementById('txAssetProceeds').value);
        
        if (!assetId || proceeds < 0) {
          alert('Please select asset and enter proceeds');
          return;
        }
        
        const asset = business.assets.find(a => a.id === assetId);
        if (asset && !asset.disposed) {
          asset.disposed = true;
          asset.disposalDate = transaction.date;
          asset.disposalProceeds = proceeds;
          
          // Calculate gain/loss
          const dep = calculateDepreciation(asset);
          const bookValue = asset.cost - dep.accumulated;
          const gainLoss = proceeds - bookValue;
          
          transaction.assetId = assetId;
          transaction.assetProceeds = proceeds;
          transaction.assetGainLoss = gainLoss;
          transaction.assetClassification = asset.classification;
        }
      }
      
      // Store last operation for undo
      appState.lastOperation = {
        type: 'addTransaction',
        transaction: JSON.parse(JSON.stringify(transaction)),
        businessId: business.id
      };
      
      business.transactions.push(transaction);
      saveData();
      clearTransactionForm();
      renderAll();
    }
    
    function clearTransactionForm() {
      document.getElementById('txType').value = 'revenue';
      document.getElementById('txDate').valueAsDate = new Date();
      document.getElementById('txAccount').value = '';
      document.getElementById('txAmount').value = '';
      document.getElementById('txContact').value = '';
      document.getElementById('txDescription').value = '';
      document.getElementById('txVATEnabled').checked = false;
      document.getElementById('txWHTEnabled').checked = false;
      document.getElementById('txPAYE').checked = false;
      document.getElementById('txReceipt').value = '';
      document.getElementById('receiptPreview').textContent = '';
      updateTransactionFormVisibility();
    }
    
    function editTransaction(txId) {
      // Simplified: show alert for now
      alert('Edit functionality: Delete and re-add the transaction');
    }
    
    function deleteTransaction(txId) {
      if (!hasPermission('delete')) {
        alert('You do not have permission to delete transactions');
        return;
      }
      
      if (!confirm('Delete this transaction?')) return;
      
      const business = getActiveBusiness();
      if (!business) return;
      
      business.transactions = business.transactions.filter(t => t.id !== txId);
      saveData();
      renderAll();
    }
    
    function undoLastOperation() {
      if (!appState.lastOperation) {
        alert('No operation to undo');
        return;
      }
      
      const op = appState.lastOperation;
      const business = appState.businesses.find(b => b.id === op.businessId);
      if (!business) return;
      
      if (op.type === 'addTransaction') {
        const txIndex = business.transactions.findIndex(t => t.id === op.transaction.id);
        if (txIndex !== -1) {
          business.transactions.splice(txIndex, 1);
        }
      } else if (op.type === 'addInventory') {
        const itemIndex = business.inventory.findIndex(i => i.id === op.item.id);
        if (itemIndex !== -1) {
          business.inventory.splice(itemIndex, 1);
        }
      } else if (op.type === 'addAsset') {
        const assetIndex = business.assets.findIndex(a => a.id === op.asset.id);
        if (assetIndex !== -1) {
          business.assets.splice(assetIndex, 1);
        }
      }
      
      appState.lastOperation = null;
      saveData();
      renderAll();
      alert('Last operation undone');
    }
    
    function viewReceipt(txId) {
      const business = getActiveBusiness();
      if (!business) return;
      
      const tx = business.transactions.find(t => t.id === txId);
      if (!tx || !tx.receipt) return;
      
      const content = document.getElementById('receiptModalContent');
      if (tx.receipt.type.startsWith('image/')) {
        content.innerHTML = `<img src="${tx.receipt.data}" class="receipt-preview" alt="${tx.receipt.name}" />`;
      } else if (tx.receipt.type === 'application/pdf') {
        content.innerHTML = `<embed src="${tx.receipt.data}" type="application/pdf" width="100%" height="500px" />`;
      } else {
        content.innerHTML = `<p>Receipt: ${tx.receipt.name}</p><p class="muted">File type not previewable</p>`;
      }
      
      openModal('receiptModal');
    }
    
    // ============================================================================
    // INVENTORY MANAGEMENT
    // ============================================================================
    
    function addInventoryItem() {
      const business = getActiveBusiness();
      if (!business || !hasPermission('edit')) {
        alert('You do not have permission to add inventory');
        return;
      }
      
      const name = document.getElementById('invName').value.trim();
      const qty = parseFloat(document.getElementById('invInitialQty').value);
      const cost = parseFloat(document.getElementById('invInitialCost').value);
      
      if (!name || !qty || qty < 0 || !cost || cost < 0) {
        alert('Please fill in all fields');
        return;
      }
      
      const item = {
        id: generateId(),
        name,
        quantity: qty,
        avgCost: cost,
        totalValue: qty * cost
      };
      
      appState.lastOperation = {
        type: 'addInventory',
        item: JSON.parse(JSON.stringify(item)),
        businessId: business.id
      };
      
      business.inventory.push(item);
      
      document.getElementById('invName').value = '';
      document.getElementById('invInitialQty').value = '';
      document.getElementById('invInitialCost').value = '';
      
      saveData();
      renderAll();
    }
    
    function deleteInventoryItem(itemId) {
      if (!hasPermission('delete')) {
        alert('You do not have permission to delete inventory');
        return;
      }
      
      if (!confirm('Delete this inventory item?')) return;
      
      const business = getActiveBusiness();
      if (!business) return;
      
      business.inventory = business.inventory.filter(i => i.id !== itemId);
      saveData();
      renderAll();
    }
    
    // ============================================================================
    // FIXED ASSETS MANAGEMENT
    // ============================================================================
    
    function addFixedAsset() {
      const business = getActiveBusiness();
      if (!business || !hasPermission('edit')) {
        alert('You do not have permission to add assets');
        return;
      }
      
      const name = document.getElementById('assetName').value.trim();
      const cost = parseFloat(document.getElementById('assetCost').value);
      const purchaseDate = document.getElementById('assetPurchaseDate').value;
      const usefulLife = parseFloat(document.getElementById('assetUsefulLife').value);
      const caRate = parseFloat(document.getElementById('assetCARate').value);
      const depRate = parseFloat(document.getElementById('assetDepRate').value);
      const classification = document.getElementById('assetClassification').value;
      
      if (!name || !cost || cost <= 0 || !purchaseDate || !usefulLife || usefulLife <= 0 || 
          caRate < 0 || depRate < 0) {
        alert('Please fill in all required fields correctly');
        return;
      }
      
      const asset = {
        id: generateId(),
        name,
        cost,
        purchaseDate,
        usefulLife,
        caRate,
        depRate,
        classification,
        accumulatedDepreciation: 0,
        accumulatedCA: 0,
        disposed: false
      };
      
      appState.lastOperation = {
        type: 'addAsset',
        asset: JSON.parse(JSON.stringify(asset)),
        businessId: business.id
      };
      
      business.assets.push(asset);
      
      document.getElementById('assetName').value = '';
      document.getElementById('assetCost').value = '';
      document.getElementById('assetPurchaseDate').value = '';
      document.getElementById('assetUsefulLife').value = '';
      document.getElementById('assetCARate').value = '';
      document.getElementById('assetDepRate').value = '';
      document.getElementById('assetClassification').value = 'fixed';
      
      saveData();
      renderAll();
    }
    
    function disposeAsset(assetId) {
      if (!hasPermission('edit')) {
        alert('You do not have permission to dispose assets');
        return;
      }
      
      // Disposal is handled through transaction form
      alert('To dispose an asset, add a transaction with type "Fixed Asset Disposal"');
    }
    
    // ============================================================================
    // TAX CALCULATIONS - COMPREHENSIVE ENGINE
    // ============================================================================
    
    /**
     * Calculate depreciation for a fixed asset
     * Depreciation: straight-line monthly, prorated by days in purchase/disposal month
     */
    function calculateDepreciation(asset) {
      if (!asset || asset.disposed) {
        return {
          forYear: 0,
          accumulated: asset.accumulatedDepreciation || 0
        };
      }
      
      const purchaseDate = new Date(asset.purchaseDate);
      const today = new Date();
      const disposalDate = asset.disposalDate ? new Date(asset.disposalDate) : today;
      
      // Calculate months between purchase and disposal/today
      const monthsElapsed = (disposalDate.getFullYear() - purchaseDate.getFullYear()) * 12 +
                            (disposalDate.getMonth() - purchaseDate.getMonth());
      
      // Annual depreciation
      const annualDep = asset.cost * (asset.depRate / 100);
      const monthlyDep = annualDep / 12;
      
      // Prorated for first and last months
      const daysInPurchaseMonth = new Date(purchaseDate.getFullYear(), purchaseDate.getMonth() + 1, 0).getDate();
      const daysInPurchaseMonthUsed = daysInPurchaseMonth - purchaseDate.getDate() + 1;
      const firstMonthDep = monthlyDep * (daysInPurchaseMonthUsed / daysInPurchaseMonth);
      
      let totalDep = firstMonthDep + (monthsElapsed - 1) * monthlyDep;
      
      if (asset.disposed) {
        const daysInDisposalMonth = new Date(disposalDate.getFullYear(), disposalDate.getMonth() + 1, 0).getDate();
        const daysInDisposalMonthUsed = disposalDate.getDate();
        const lastMonthDep = monthlyDep * (daysInDisposalMonthUsed / daysInDisposalMonth);
        totalDep = firstMonthDep + (monthsElapsed - 1) * monthlyDep + lastMonthDep;
      }
      
      // Cap at asset cost
      totalDep = Math.min(totalDep, asset.cost);
      
      // Current year depreciation (simplified: all accumulated for demo)
      const currentYearDep = totalDep - (asset.accumulatedDepreciation || 0);
      
      return {
        forYear: Math.max(0, currentYearDep),
        accumulated: totalDep
      };
    }
    
    /**
     * Calculate capital allowance for a fixed asset
     * CA: computed monthly using asset's CA % on cost
     */
    function calculateCapitalAllowance(asset) {
      if (!asset) {
        return { forYear: 0, total: 0 };
      }
      
      const purchaseDate = new Date(asset.purchaseDate);
      const today = new Date();
      const disposalDate = asset.disposed && asset.disposalDate ? new Date(asset.disposalDate) : today;
      
      // Calculate months
      const monthsElapsed = Math.max(0,
        (disposalDate.getFullYear() - purchaseDate.getFullYear()) * 12 +
        (disposalDate.getMonth() - purchaseDate.getMonth()) + 1
      );
      
      // Annual CA
      const annualCA = asset.cost * (asset.caRate / 100);
      const monthlyCA = annualCA / 12;
      
      // Total CA for the period
      const totalCA = monthlyCA * monthsElapsed;
      const caForYear = totalCA - (asset.accumulatedCA || 0);
      
      return {
        forYear: Math.max(0, caForYear),
        total: totalCA
      };
    }
    
    /**
     * Calculate Profit & Loss
     * Accounting Profit = Revenue - COGS - Expenses + (profit/loss on disposal of fixed assets)
     * Excludes chargeable gains/losses from accounting profit
     */
    function calculateProfitAndLoss(business) {
      let revenue = 0;
      let cogs = 0;
      let expenses = 0;
      let depreciation = 0;
      let fixedAssetGainLoss = 0; // Only for fixed classification assets
      
      // Sum up transactions
      business.transactions.forEach(tx => {
        const account = business.accounts.find(a => a.id === tx.account);
        if (!account) return;
        
        if (account.category === 'Revenue') {
          revenue += tx.amount;
        } else if (account.category === 'Expense') {
          expenses += tx.amount;
        }
        
        // COGS from inventory sales
        if (tx.cogs) {
          cogs += tx.cogs;
        }
        
        // Asset disposal gain/loss (only for fixed assets)
        if (tx.type === 'asset_disposal' && tx.assetClassification === 'fixed') {
          fixedAssetGainLoss += tx.assetGainLoss || 0;
        }
      });
      
      // Calculate depreciation from all assets
      business.assets.forEach(asset => {
        const dep = calculateDepreciation(asset);
        depreciation += dep.forYear;
      });
      
      const grossProfit = revenue - cogs;
      const accountingProfit = grossProfit - expenses - depreciation + fixedAssetGainLoss;
      
      // Calculate taxable profit using the formula
      const taxableProfit = calculateTaxableProfit(business, {
        accountingProfit,
        depreciation,
        revenue
      });
      
      return {
        revenue,
        cogs,
        grossProfit,
        expenses,
        depreciation,
        fixedAssetGainLoss,
        accountingProfit,
        taxableProfit
      };
    }
    
    /**
     * Calculate Taxable Profit
     * Formula: Taxable profit = Accounting profit + Depreciation + Disallowable expenses + Chargeable gains
     *          - Non-taxable income - Loss relief b/f - Allowed capital allowance
     */
    function calculateTaxableProfit(business, profitData) {
      const { accountingProfit, depreciation, revenue } = profitData;
      
      // Calculate disallowable expenses
      let disallowableExpenses = 0;
      business.transactions.forEach(tx => {
        const account = business.accounts.find(a => a.id === tx.account);
        if (account && account.category === 'Expense' && account.disallowable) {
          disallowableExpenses += tx.amount;
        }
      });
      
      // Calculate non-taxable income
      let nonTaxableIncome = 0;
      business.transactions.forEach(tx => {
        const account = business.accounts.find(a => a.id === tx.account);
        if (account && account.category === 'Revenue' && account.nonTaxable) {
          nonTaxableIncome += tx.amount;
        }
      });
      
      // Calculate chargeable gains (only from chargeable assets)
      let chargeableGains = 0;
      business.transactions.forEach(tx => {
        if (tx.type === 'asset_disposal' && tx.assetClassification === 'chargeable') {
          const gainLoss = tx.assetGainLoss || 0;
          if (gainLoss > 0) {
            chargeableGains += gainLoss;
          }
          // Note: Chargeable losses are NOT included here, they're carried forward separately
        }
      });
      
      // Calculate total capital allowance for the year
      let caForYear = 0;
      business.assets.forEach(asset => {
        const ca = calculateCapitalAllowance(asset);
        caForYear += ca.forYear;
      });
      
      const totalCA = (business.settings.caBF || 0) + caForYear;
      
      // Determine allowed capital allowance
      // If non-taxable income < 10% of total revenue, allowed CA = 100% of total CA
      // Otherwise, allowed CA = 2/3 of total CA
      let allowedCA = totalCA;
      const nonTaxablePercentage = revenue > 0 ? (nonTaxableIncome / revenue) * 100 : 0;
      
      if (nonTaxablePercentage >= 10) {
        allowedCA = (2 / 3) * totalCA;
      }
      
      // Loss brought forward
      const lossBF = business.settings.lossBF || 0;
      
      // Calculate taxable profit
      let taxableProfit = accountingProfit
        + depreciation
        + disallowableExpenses
        + chargeableGains
        - nonTaxableIncome
        - lossBF
        - allowedCA;
      
      // Taxable profit cannot be negative (loss carried forward)
      taxableProfit = Math.max(0, taxableProfit);
      
      return taxableProfit;
    }
    
    /**
     * Calculate VAT
     * VAT Collected (on sales) - VAT Paid (on purchases)
     */
    function calculateVAT(business) {
      let collected = 0;
      let paid = 0;
      
      business.transactions.forEach(tx => {
        if (tx.vat && tx.vat.enabled) {
          const account = business.accounts.find(a => a.id === tx.account);
          if (account) {
            if (account.category === 'Revenue' || tx.type === 'revenue') {
              collected += tx.vat.amount;
            } else if (account.category === 'Expense' || tx.type === 'expense') {
              paid += tx.vat.amount;
            }
          }
        }
      });
      
      return {
        collected,
        paid,
        net: collected - paid
      };
    }
    
    /**
     * Calculate WHT
     * WHT Receivable (on expenses) - WHT Payable (on revenue)
     */
    function calculateWHT(business) {
      let receivable = 0;
      let payable = 0;
      
      business.transactions.forEach(tx => {
        if (tx.wht && tx.wht.enabled) {
          const account = business.accounts.find(a => a.id === tx.account);
          if (account) {
            if (account.category === 'Expense' || tx.type === 'expense') {
              receivable += tx.wht.amount;
            } else if (account.category === 'Revenue' || tx.type === 'revenue') {
              payable += tx.wht.amount;
            }
          }
        }
      });
      
      return {
        receivable,
        payable
      };
    }
    
    /**
     * Calculate PAYE
     * Apply PAYE bands on gross salary after statutory deductions
     * Bands: 1st 800,000 free; next 2,200,000 @15%; next 9,000,000 @18%;
     *        next 13,000,000 @21%; next 25,000,000 @23%; Above 50,000,000 @25%
     */
    function calculatePAYE(business) {
      const payeTransactions = business.transactions.filter(tx => tx.paye === true);
      
      let totalPAYE = 0;
      const perContact = {};
      
      payeTransactions.forEach(tx => {
        const contact = tx.contact || 'Unknown';
        const grossSalary = tx.amount;
        
        // Statutory deductions (simplified)
        const pension = grossSalary * ((business.settings.pensionRate || 8) / 100);
        const nhf = grossSalary * ((business.settings.nhfRate || 2.5) / 100);
        
        // For demo, assume rent and other deductions are 0
        const statutoryDeductions = pension + nhf;
        
        const taxableIncome = grossSalary - statutoryDeductions;
        
        // Apply PAYE bands
        const paye = applyPAYEBands(taxableIncome);
        totalPAYE += paye;
        
        if (!perContact[contact]) {
          perContact[contact] = { gross: 0, paye: 0, count: 0 };
        }
        perContact[contact].gross += grossSalary;
        perContact[contact].paye += paye;
        perContact[contact].count += 1;
      });
      
      return {
        total: totalPAYE,
        perContact
      };
    }
    
    /**
     * Apply PAYE tax bands
     * Annual bands:
     * - First 800,000: 0%
     * - Next 2,200,000 (up to 3,000,000): 15%
     * - Next 9,000,000 (up to 12,000,000): 18%
     * - Next 13,000,000 (up to 25,000,000): 21%
     * - Next 25,000,000 (up to 50,000,000): 23%
     * - Above 50,000,000: 25%
     */
    function applyPAYEBands(taxableIncome) {
      const bands = [
        { limit: 800000, rate: 0 },
        { limit: 3000000, rate: 0.15 },
        { limit: 12000000, rate: 0.18 },
        { limit: 25000000, rate: 0.21 },
        { limit: 50000000, rate: 0.23 },
        { limit: Infinity, rate: 0.25 }
      ];
      
      let tax = 0;
      let remaining = taxableIncome;
      let previousLimit = 0;
      
      for (const band of bands) {
        const bandSize = band.limit - previousLimit;
        const taxableInBand = Math.min(remaining, bandSize);
        
        if (taxableInBand > 0) {
          tax += taxableInBand * band.rate;
          remaining -= taxableInBand;
        }
        
        if (remaining <= 0) break;
        previousLimit = band.limit;
      }
      
      return tax;
    }
    
    /**
     * Calculate PIT (Personal Income Tax)
     * Uses same PAYE bands applied to taxable profit less statutory deductions
     */
    function calculatePIT(business) {
      if (!business.settings.pitEnabled || business.entityType !== 'SoleProprietor') {
        return { amount: 0, taxableIncome: 0 };
      }
      
      const profitData = calculateProfitAndLoss(business);
      const taxableProfit = profitData.taxableProfit;
      
      // Apply statutory deductions (simplified for PIT)
      const statutoryDeductions = 0; // Could add business-level deductions here
      const taxableIncome = Math.max(0, taxableProfit - statutoryDeductions);
      
      // Apply PAYE bands
      const pitAmount = applyPAYEBands(taxableIncome);
      
      return {
        amount: pitAmount,
        taxableIncome
      };
    }
    
    /**
     * Calculate CIT (Corporate Income Tax)
     * 0% for turnover <= 50,000,000
     * 25% on taxable profit for turnover > 50,000,000
     * Deduct WHT receivable when CIT computed
     */
    function calculateCIT(business) {
      if (!business.settings.citEnabled || business.entityType !== 'Company') {
        return {
          amount: 0,
          taxableProfit: 0,
          whtDeducted: 0,
          turnover: 0
        };
      }
      
      const profitData = calculateProfitAndLoss(business);
      const turnover = profitData.revenue;
      const taxableProfit = profitData.taxableProfit;
      
      let citAmount = 0;
      let whtDeducted = 0;
      
      if (turnover > 50000000) {
        // CIT rate from settings or default 25%
        const citRate = (business.settings.citRate || 25) / 100;
        citAmount = taxableProfit * citRate;
        
        // Deduct WHT receivable
        const wht = calculateWHT(business);
        const whtReceivableBF = business.settings.whtReceivableBF || 0;
        const totalWHTReceivable = wht.receivable + whtReceivableBF;
        
        whtDeducted = Math.min(citAmount, totalWHTReceivable);
        citAmount = Math.max(0, citAmount - whtDeducted);
      }
      
      return {
        amount: citAmount,
        taxableProfit,
        whtDeducted,
        turnover
      };
    }
    
    /**
     * Calculate all taxes
     */
    function calculateAllTaxes(business) {
      return {
        vat: calculateVAT(business),
        wht: calculateWHT(business),
        paye: calculatePAYE(business),
        pit: calculatePIT(business),
        cit: calculateCIT(business)
      };
    }
    
    // ============================================================================
    // REPORTS
    // ============================================================================
    
    let currentReport = null;
    let currentReportType = '';
    
    function showReport(reportType) {
      currentReportType = reportType;
      const business = getActiveBusiness();
      if (!business) {
        document.getElementById('reportContent').innerHTML = '<div class="notice">Please select a business first</div>';
        return;
      }
      
      let reportHTML = '';
      
      switch (reportType) {
        case 'accounting':
          reportHTML = generateAccountingProfitReport(business);
          break;
        case 'taxable':
          reportHTML = generateTaxableProfitReport(business);
          break;
        case 'vat':
          reportHTML = generateVATReport(business);
          break;
        case 'wht':
          reportHTML = generateWHTReport(business);
          break;
        case 'paye':
          reportHTML = generatePAYEReport(business);
          break;
        case 'pit':
          reportHTML = generatePITReport(business);
          break;
        case 'cit':
          reportHTML = generateCITReport(business);
          break;
        case 'inventory':
          reportHTML = generateInventoryReport(business);
          break;
        case 'assets':
          reportHTML = generateAssetsReport(business);
          break;
        case 'audit':
          reportHTML = generateAuditTrail(business);
          break;
        default:
          reportHTML = '<div class="notice">Report not found</div>';
      }
      
      document.getElementById('reportContent').innerHTML = reportHTML;
      currentReport = reportHTML;
    }
    
    function generateAccountingProfitReport(business) {
      const profitData = calculateProfitAndLoss(business);
      
      return `
        <h3>Accounting Profit Report</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <table class="ledger-table">
          <tr>
            <td><strong>Total Revenue</strong></td>
            <td style="text-align: right;">${formatCurrency(profitData.revenue)}</td>
          </tr>
          <tr>
            <td>Less: Cost of Goods Sold</td>
            <td style="text-align: right;">${formatCurrency(profitData.cogs)}</td>
          </tr>
          <tr>
            <td><strong>Gross Profit</strong></td>
            <td style="text-align: right;"><strong>${formatCurrency(profitData.grossProfit)}</strong></td>
          </tr>
          <tr>
            <td>Less: Expenses</td>
            <td style="text-align: right;">${formatCurrency(profitData.expenses)}</td>
          </tr>
          <tr>
            <td>Less: Depreciation</td>
            <td style="text-align: right;">${formatCurrency(profitData.depreciation)}</td>
          </tr>
          <tr>
            <td>Add: Gain/(Loss) on Asset Disposal (Fixed)</td>
            <td style="text-align: right;">${formatCurrency(profitData.fixedAssetGainLoss)}</td>
          </tr>
          <tr>
            <td><strong>Accounting Profit</strong></td>
            <td style="text-align: right;"><strong>${formatCurrency(profitData.accountingProfit)}</strong></td>
          </tr>
        </table>
        
        <small class="note">
          Note: Accounting profit excludes chargeable gains/losses. These are tracked separately for capital gains tax purposes.
        </small>
      `;
    }
    
    function generateTaxableProfitReport(business) {
      const profitData = calculateProfitAndLoss(business);
      
      // Calculate components
      let disallowable = 0;
      let nonTaxable = 0;
      let chargeableGains = 0;
      
      business.transactions.forEach(tx => {
        const account = business.accounts.find(a => a.id === tx.account);
        if (account) {
          if (account.category === 'Expense' && account.disallowable) {
            disallowable += tx.amount;
          }
          if (account.category === 'Revenue' && account.nonTaxable) {
            nonTaxable += tx.amount;
          }
        }
        
        if (tx.type === 'asset_disposal' && tx.assetClassification === 'chargeable' && (tx.assetGainLoss || 0) > 0) {
          chargeableGains += tx.assetGainLoss;
        }
      });
      
      let caForYear = 0;
      business.assets.forEach(asset => {
        const ca = calculateCapitalAllowance(asset);
        caForYear += ca.forYear;
      });
      
      const totalCA = (business.settings.caBF || 0) + caForYear;
      const nonTaxablePercent = profitData.revenue > 0 ? (nonTaxable / profitData.revenue) * 100 : 0;
      const allowedCA = nonTaxablePercent >= 10 ? (2 / 3) * totalCA : totalCA;
      const unrelievedCA = totalCA - allowedCA;
      
      return `
        <h3>Taxable Profit Computation</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <table class="ledger-table">
          <tr>
            <td><strong>Accounting Profit</strong></td>
            <td style="text-align: right;">${formatCurrency(profitData.accountingProfit)}</td>
          </tr>
          <tr>
            <td>Add: Depreciation</td>
            <td style="text-align: right;">${formatCurrency(profitData.depreciation)}</td>
          </tr>
          <tr>
            <td>Add: Disallowable Expenses</td>
            <td style="text-align: right;">${formatCurrency(disallowable)}</td>
          </tr>
          <tr>
            <td>Add: Chargeable Gains</td>
            <td style="text-align: right;">${formatCurrency(chargeableGains)}</td>
          </tr>
          <tr>
            <td>Less: Non-taxable Income</td>
            <td style="text-align: right;">(${formatCurrency(nonTaxable)})</td>
          </tr>
          <tr>
            <td>Less: Loss Relief B/F</td>
            <td style="text-align: right;">(${formatCurrency(business.settings.lossBF || 0)})</td>
          </tr>
          <tr>
            <td>Less: Allowed Capital Allowance</td>
            <td style="text-align: right;">(${formatCurrency(allowedCA)})</td>
          </tr>
          <tr>
            <td><strong>Taxable Profit</strong></td>
            <td style="text-align: right;"><strong>${formatCurrency(profitData.taxableProfit)}</strong></td>
          </tr>
        </table>
        
        <h4 style="margin-top: 16px;">Capital Allowance Details</h4>
        <table class="ledger-table">
          <tr>
            <td>CA Carryforward (B/F)</td>
            <td style="text-align: right;">${formatCurrency(business.settings.caBF || 0)}</td>
          </tr>
          <tr>
            <td>CA for Current Year</td>
            <td style="text-align: right;">${formatCurrency(caForYear)}</td>
          </tr>
          <tr>
            <td><strong>Total Capital Allowance</strong></td>
            <td style="text-align: right;"><strong>${formatCurrency(totalCA)}</strong></td>
          </tr>
          <tr>
            <td>Non-taxable Income %</td>
            <td style="text-align: right;">${formatNumber(nonTaxablePercent)}%</td>
          </tr>
          <tr>
            <td>CA Restriction Applied</td>
            <td style="text-align: right;">${nonTaxablePercent >= 10 ? 'Yes (2/3 rule)' : 'No'}</td>
          </tr>
          <tr>
            <td><strong>Allowed Capital Allowance</strong></td>
            <td style="text-align: right;"><strong>${formatCurrency(allowedCA)}</strong></td>
          </tr>
          <tr>
            <td>Unrelieved CA (Carry Forward)</td>
            <td style="text-align: right;">${formatCurrency(unrelievedCA)}</td>
          </tr>
        </table>
        
        <small class="note">
          <strong>Rules Applied:</strong><br/>
          ‚Ä¢ If non-taxable income &lt; 10% of total revenue: Allowed CA = 100% of total CA<br/>
          ‚Ä¢ If non-taxable income ‚â• 10% of total revenue: Allowed CA = 2/3 of total CA<br/>
          ‚Ä¢ Unrelieved CA carried forward to next period<br/>
          ‚Ä¢ Chargeable losses (if any) are excluded and carried forward separately
        </small>
      `;
    }
    
    function generateVATReport(business) {
      const vat = calculateVAT(business);
      const vatTransactions = business.transactions.filter(tx => tx.vat && tx.vat.enabled);
      
      let html = `
        <h3>VAT Report</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <div style="margin-bottom: 16px;">
          <table class="ledger-table" style="max-width: 500px;">
            <tr>
              <td><strong>VAT Collected (Output)</strong></td>
              <td style="text-align: right;">${formatCurrency(vat.collected)}</td>
            </tr>
            <tr>
              <td><strong>VAT Paid (Input)</strong></td>
              <td style="text-align: right;">${formatCurrency(vat.paid)}</td>
            </tr>
            <tr>
              <td><strong>Net VAT Payable/(Refundable)</strong></td>
              <td style="text-align: right;"><strong>${formatCurrency(vat.net)}</strong></td>
            </tr>
          </table>
        </div>
        
        <h4>VAT Transactions</h4>
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Type</th>
              <th>Amount</th>
              <th>VAT Mode</th>
              <th>VAT Rate</th>
              <th>VAT Amount</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      vatTransactions.forEach(tx => {
        const account = business.accounts.find(a => a.id === tx.account);
        const txType = account?.category === 'Revenue' ? 'Output' : 'Input';
        
        html += `
          <tr>
            <td>${tx.date}</td>
            <td>${tx.description || account?.name || '-'}</td>
            <td><span class="badge badge-${txType === 'Output' ? 'success' : 'warning'}">${txType}</span></td>
            <td>${formatCurrency(tx.amount)}</td>
            <td>${tx.vat.mode}</td>
            <td>${tx.vat.rate}%</td>
            <td>${formatCurrency(tx.vat.amount)}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      return html;
    }
    
    function generateWHTReport(business) {
      const wht = calculateWHT(business);
      const whtTransactions = business.transactions.filter(tx => tx.wht && tx.wht.enabled);
      
      let html = `
        <h3>WHT Report</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <div style="margin-bottom: 16px;">
          <table class="ledger-table" style="max-width: 500px;">
            <tr>
              <td><strong>WHT Receivable</strong></td>
              <td style="text-align: right;">${formatCurrency(wht.receivable)}</td>
            </tr>
            <tr>
              <td><strong>WHT Payable</strong></td>
              <td style="text-align: right;">${formatCurrency(wht.payable)}</td>
            </tr>
            <tr>
              <td><strong>WHT Receivable B/F</strong></td>
              <td style="text-align: right;">${formatCurrency(business.settings.whtReceivableBF || 0)}</td>
            </tr>
          </table>
        </div>
        
        <h4>WHT Transactions</h4>
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Contact</th>
              <th>Amount</th>
              <th>WHT Basis</th>
              <th>WHT Rate</th>
              <th>WHT Amount</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      whtTransactions.forEach(tx => {
        const account = business.accounts.find(a => a.id === tx.account);
        const whtType = account?.category === 'Expense' ? 'Receivable' : 'Payable';
        
        html += `
          <tr>
            <td>${tx.date}</td>
            <td>${tx.description || account?.name || '-'}</td>
            <td>${tx.contact || '-'}</td>
            <td>${formatCurrency(tx.amount)}</td>
            <td>${tx.wht.basis}</td>
            <td>${tx.wht.rate}%</td>
            <td>${formatCurrency(tx.wht.amount)}</td>
            <td><span class="badge">${whtType}</span></td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      return html;
    }
    
    function generatePAYEReport(business) {
      const paye = calculatePAYE(business);
      
      let html = `
        <h3>PAYE Report</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <div style="margin-bottom: 16px;">
          <table class="ledger-table" style="max-width: 500px;">
            <tr>
              <td><strong>Total PAYE</strong></td>
              <td style="text-align: right;"><strong>${formatCurrency(paye.total)}</strong></td>
            </tr>
          </table>
        </div>
        
        <h4>PAYE by Contact</h4>
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Contact</th>
              <th>Gross Salary</th>
              <th>PAYE</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      for (const [contact, data] of Object.entries(paye.perContact)) {
        html += `
          <tr>
            <td>${contact}</td>
            <td>${formatCurrency(data.gross)}</td>
            <td>${formatCurrency(data.paye)}</td>
            <td>${data.count}</td>
          </tr>
        `;
      }
      
      html += `
          </tbody>
        </table>
        
        <h4>PAYE Bands Applied (Annual)</h4>
        <table class="ledger-table">
          <tr><td>First ‚Ç¶800,000</td><td>0%</td></tr>
          <tr><td>Next ‚Ç¶2,200,000 (up to ‚Ç¶3,000,000)</td><td>15%</td></tr>
          <tr><td>Next ‚Ç¶9,000,000 (up to ‚Ç¶12,000,000)</td><td>18%</td></tr>
          <tr><td>Next ‚Ç¶13,000,000 (up to ‚Ç¶25,000,000)</td><td>21%</td></tr>
          <tr><td>Next ‚Ç¶25,000,000 (up to ‚Ç¶50,000,000)</td><td>23%</td></tr>
          <tr><td>Above ‚Ç¶50,000,000</td><td>25%</td></tr>
        </table>
      `;
      
      return html;
    }
    
    function generatePITReport(business) {
      const pit = calculatePIT(business);
      
      return `
        <h3>Personal Income Tax (PIT) Report</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <div class="notice ${pit.amount > 0 ? '' : 'info'}">
          ${business.entityType === 'Company' ? 
            'PIT does not apply to companies. Use CIT report instead.' :
            pit.amount > 0 ? 'PIT applies to sole proprietors.' : 'No PIT liability for this period.'
          }
        </div>
        
        <table class="ledger-table" style="max-width: 500px;">
          <tr>
            <td><strong>Taxable Income</strong></td>
            <td style="text-align: right;">${formatCurrency(pit.taxableIncome)}</td>
          </tr>
          <tr>
            <td><strong>PIT Amount</strong></td>
            <td style="text-align: right;"><strong>${formatCurrency(pit.amount)}</strong></td>
          </tr>
        </table>
        
        <small class="note">
          PIT uses the same PAYE band structure applied to taxable profit less statutory deductions.
        </small>
      `;
    }
    
    function generateCITReport(business) {
      const cit = calculateCIT(business);
      
      let html = `
        <h3>Corporate Income Tax (CIT) Report</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <div class="notice ${cit.amount > 0 ? '' : 'info'}">
          ${business.entityType === 'SoleProprietor' ? 
            'CIT does not apply to sole proprietors. Use PIT report instead.' :
            cit.turnover <= 50000000 ?
              'CIT exemption applies (turnover ‚â§ ‚Ç¶50,000,000).' :
              'CIT applies at ' + (business.settings.citRate || 25) + '% rate.'
          }
        </div>
        
        <table class="ledger-table" style="max-width: 500px;">
          <tr>
            <td><strong>Turnover</strong></td>
            <td style="text-align: right;">${formatCurrency(cit.turnover)}</td>
          </tr>
          <tr>
            <td><strong>Taxable Profit</strong></td>
            <td style="text-align: right;">${formatCurrency(cit.taxableProfit)}</td>
          </tr>
          <tr>
            <td>CIT Rate</td>
            <td style="text-align: right;">${cit.turnover <= 50000000 ? '0%' : (business.settings.citRate || 25) + '%'}</td>
          </tr>
          <tr>
            <td>CIT Before WHT</td>
            <td style="text-align: right;">${formatCurrency(cit.amount + cit.whtDeducted)}</td>
          </tr>
          <tr>
            <td>Less: WHT Receivable Deducted</td>
            <td style="text-align: right;">(${formatCurrency(cit.whtDeducted)})</td>
          </tr>
          <tr>
            <td><strong>CIT Payable</strong></td>
            <td style="text-align: right;"><strong>${formatCurrency(cit.amount)}</strong></td>
          </tr>
        </table>
        
        <small class="note">
          <strong>CIT Rules:</strong><br/>
          ‚Ä¢ Turnover ‚â§ ‚Ç¶50,000,000: 0% CIT<br/>
          ‚Ä¢ Turnover > ‚Ç¶50,000,000: CIT at specified rate on taxable profit<br/>
          ‚Ä¢ WHT receivable deducted when CIT computed; otherwise carried forward
        </small>
      `;
      
      return html;
    }
    
    function generateInventoryReport(business) {
      let html = `
        <h3>Inventory Report</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Avg Cost</th>
              <th>Total Value</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      let totalValue = 0;
      business.inventory.forEach(item => {
        totalValue += item.totalValue;
        html += `
          <tr>
            <td>${item.name}</td>
            <td>${formatNumber(item.quantity)}</td>
            <td>${formatCurrency(item.avgCost)}</td>
            <td>${formatCurrency(item.totalValue)}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3"><strong>Total Inventory Value</strong></td>
              <td><strong>${formatCurrency(totalValue)}</strong></td>
            </tr>
          </tfoot>
        </table>
        
        <small class="note">
          Inventory valued using weighted-average cost method.
        </small>
      `;
      
      return html;
    }
    
    function generateAssetsReport(business) {
      let html = `
        <h3>Fixed Assets Schedule</h3>
        <p class="muted">Business: ${business.name}</p>
        
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Asset</th>
              <th>Classification</th>
              <th>Cost</th>
              <th>Purchase Date</th>
              <th>Acc. Depreciation</th>
              <th>Book Value</th>
              <th>CA for Year</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      let totalCost = 0;
      let totalDep = 0;
      let totalBookValue = 0;
      let totalCA = 0;
      
      business.assets.forEach(asset => {
        const dep = calculateDepreciation(asset);
        const ca = calculateCapitalAllowance(asset);
        const bookValue = asset.cost - dep.accumulated;
        
        totalCost += asset.cost;
        totalDep += dep.accumulated;
        totalBookValue += bookValue;
        totalCA += ca.forYear;
        
        html += `
          <tr>
            <td>${asset.name}</td>
            <td><span class="badge">${asset.classification}</span></td>
            <td>${formatCurrency(asset.cost)}</td>
            <td>${asset.purchaseDate}</td>
            <td>${formatCurrency(dep.accumulated)}</td>
            <td>${formatCurrency(bookValue)}</td>
            <td>${formatCurrency(ca.forYear)}</td>
            <td>${asset.disposed ? '<span class="badge badge-danger">Disposed</span>' : '<span class="badge badge-success">Active</span>'}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
          <tfoot>
            <tr>
              <td colspan="2"><strong>Totals</strong></td>
              <td><strong>${formatCurrency(totalCost)}</strong></td>
              <td></td>
              <td><strong>${formatCurrency(totalDep)}</strong></td>
              <td><strong>${formatCurrency(totalBookValue)}</strong></td>
              <td><strong>${formatCurrency(totalCA)}</strong></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      `;
      
      return html;
    }
    
    function generateAuditTrail(business) {
      let html = `
        <h3>Audit Trail</h3>
        <p class="muted">Business: ${business.name} | Total Transactions: ${business.transactions.length}</p>
        
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Account</th>
              <th>Description</th>
              <th>Contact</th>
              <th>Amount</th>
              <th>VAT</th>
              <th>WHT</th>
              <th>PAYE</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      // Sort by date
      const sorted = [...business.transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      sorted.forEach(tx => {
        const account = business.accounts.find(a => a.id === tx.account);
        html += `
          <tr>
            <td>${tx.date}</td>
            <td><span class="badge">${tx.type}</span></td>
            <td>${account?.name || 'Unknown'}</td>
            <td>${tx.description || '-'}</td>
            <td>${tx.contact || '-'}</td>
            <td>${formatCurrency(tx.amount)}</td>
            <td>${tx.vat?.enabled ? formatCurrency(tx.vat.amount) : '-'}</td>
            <td>${tx.wht?.enabled ? formatCurrency(tx.wht.amount) : '-'}</td>
            <td>${tx.paye ? '‚úì' : '-'}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      return html;
    }
    
    // ============================================================================
    // EXPORT FUNCTIONALITY
    // ============================================================================
    
    function exportReport(format) {
      const business = getActiveBusiness();
      if (!business || !currentReport) {
        alert('Please generate a report first');
        return;
      }
      
      const reportName = `${business.name}_${currentReportType}_${new Date().toISOString().split('T')[0]}`;
      
      if (format === 'csv') {
        exportToCSV(reportName);
      } else if (format === 'pdf') {
        exportToPDF(reportName);
      } else if (format === 'xlsx') {
        exportToXLSX(reportName);
      }
    }
    
    function exportToCSV(filename) {
      // Extract table data from current report
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = currentReport;
      const table = tempDiv.querySelector('table');
      
      if (!table) {
        alert('No table data to export');
        return;
      }
      
      let csv = '';
      const rows = table.querySelectorAll('tr');
      
      rows.forEach(row => {
        const cols = row.querySelectorAll('td, th');
        const rowData = Array.from(cols).map(col => {
          let text = col.textContent.trim();
          // Remove currency symbols and format
          text = text.replace(/‚Ç¶/g, '').replace(/,/g, '');
          return `"${text}"`;
        });
        csv += rowData.join(',') + '\n';
      });
      
      downloadFile(csv, filename + '.csv', 'text/csv');
    }
    
    function exportToPDF(filename) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const business = getActiveBusiness();
        const title = `${business.name} - ${currentReportType.toUpperCase()} Report`;
        
        doc.setFontSize(16);
        doc.text(title, 14, 20);
        
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 30);
        
        // Add report content as text (simplified)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = currentReport;
        const text = tempDiv.textContent.trim();
        
        const lines = doc.splitTextToSize(text, 180);
        doc.text(lines, 14, 40);
        
        doc.save(filename + '.pdf');
      } catch (e) {
        console.error('PDF export error:', e);
        alert('PDF export failed. jsPDF may not be loaded.');
      }
    }
    
    function exportToXLSX(filename) {
      try {
        if (typeof XLSX === 'undefined') {
          alert('XLSX library not loaded. Cannot export to Excel.');
          return;
        }
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = currentReport;
        const table = tempDiv.querySelector('table');
        
        if (!table) {
          alert('No table data to export');
          return;
        }
        
        const wb = XLSX.utils.table_to_book(table, { sheet: "Report" });
        XLSX.writeFile(wb, filename + '.xlsx');
      } catch (e) {
        console.error('XLSX export error:', e);
        alert('XLSX export failed: ' + e.message);
      }
    }
    
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function exportJSON() {
      const data = JSON.stringify(appState, null, 2);
      const filename = `nigeria_tax_backup_${new Date().toISOString().split('T')[0]}.json`;
      downloadFile(data, filename, 'application/json');
    }
    
    function handleImportJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (confirm('Import data? This will replace all current data.')) {
            appState = data;
            saveData();
            init();
            alert('Data imported successfully');
          }
        } catch (err) {
          alert('Error importing data: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    function clearAllData() {
      if (!confirm('Clear ALL data? This cannot be undone!')) return;
      if (!confirm('Are you absolutely sure? All businesses, users, and transactions will be deleted.')) return;
      
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
    
    // ============================================================================
    // TAB & SETTINGS MANAGEMENT
    // ============================================================================
    
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.add('hidden'));
      
      // Show selected tab
      const tabContent = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
      if (tabContent) {
        tabContent.classList.remove('hidden');
      }
      
      // Update active tab button
      document.querySelectorAll('.tab[data-tab]').forEach(t => t.classList.remove('active'));
      const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.classList.add('active');
      }
      
      // Refresh data for current tab
      if (tabName === 'ledger') {
        renderAll();
      } else if (tabName === 'inventory') {
        renderInventory();
      } else if (tabName === 'assets') {
        renderAssets();
      } else if (tabName === 'reports') {
        if (currentReportType) {
          showReport(currentReportType);
        }
      } else if (tabName === 'settings') {
        showSettings('business');
      }
    }
    
    function showSettings(settingType) {
      const container = document.getElementById('settingsContent');
      const business = getActiveBusiness();
      
      if (settingType === 'business') {
        if (!business) {
          container.innerHTML = '<div class="notice">Please select a business first</div>';
          return;
        }
        
        container.innerHTML = `
          <h3>Business Settings: ${business.name}</h3>
          
          <div class="notice info">
            To edit business settings, use the "Edit Business" button in the header.
          </div>
          
          <h4>Current Settings</h4>
          <table class="ledger-table" style="max-width: 600px;">
            <tr><td><strong>Entity Type</strong></td><td>${business.entityType}</td></tr>
            <tr><td><strong>VAT Enabled</strong></td><td>${business.settings.vatEnabled ? 'Yes' : 'No'}</td></tr>
            <tr><td><strong>VAT Rate</strong></td><td>${business.settings.vatRate}%</td></tr>
            <tr><td><strong>WHT Enabled</strong></td><td>${business.settings.whtEnabled ? 'Yes' : 'No'}</td></tr>
            <tr><td><strong>WHT Rate</strong></td><td>${business.settings.whtRate}%</td></tr>
            <tr><td><strong>PAYE Enabled</strong></td><td>${business.settings.payeEnabled ? 'Yes' : 'No'}</td></tr>
            <tr><td><strong>PIT Enabled</strong></td><td>${business.settings.pitEnabled ? 'Yes' : 'No'}</td></tr>
            <tr><td><strong>CIT Enabled</strong></td><td>${business.settings.citEnabled ? 'Yes' : 'No'}</td></tr>
            <tr><td><strong>CIT Rate</strong></td><td>${business.settings.citRate}%</td></tr>
            <tr><td><strong>Default CA Rate</strong></td><td>${business.settings.caRate}%</td></tr>
          </table>
          
          <h4>Carry Forwards</h4>
          <table class="ledger-table" style="max-width: 600px;">
            <tr><td><strong>Loss B/F</strong></td><td>${formatCurrency(business.settings.lossBF || 0)}</td></tr>
            <tr><td><strong>CA Carryforward</strong></td><td>${formatCurrency(business.settings.caBF || 0)}</td></tr>
            <tr><td><strong>Capital B/F</strong></td><td>${formatCurrency(business.settings.capitalBF || 0)}</td></tr>
            <tr><td><strong>Chargeable Loss B/F</strong></td><td>${formatCurrency(business.settings.chargeableLossBF || 0)}</td></tr>
            <tr><td><strong>WHT Receivable B/F</strong></td><td>${formatCurrency(business.settings.whtReceivableBF || 0)}</td></tr>
          </table>
          
          <small class="note">
            <strong>Tax Rules Summary:</strong><br/>
            ‚Ä¢ <strong>PAYE Bands:</strong> First ‚Ç¶800k free; Next ‚Ç¶2.2M @15%; Next ‚Ç¶9M @18%; Next ‚Ç¶13M @21%; Next ‚Ç¶25M @23%; Above ‚Ç¶50M @25%<br/>
            ‚Ä¢ <strong>CIT:</strong> 0% for turnover ‚â§ ‚Ç¶50M; ${business.settings.citRate}% for turnover > ‚Ç¶50M<br/>
            ‚Ä¢ <strong>Capital Allowance:</strong> If non-taxable income < 10% of revenue: 100% allowed; else 2/3 allowed<br/>
            ‚Ä¢ <strong>Chargeable Assets:</strong> Gains/losses excluded from accounting profit, subject to capital gains rules<br/>
            ‚Ä¢ <strong>Fixed Assets:</strong> Disposal gains/losses included in accounting profit
          </small>
        `;
      } else if (settingType === 'accounts') {
        if (!business) {
          container.innerHTML = '<div class="notice">Please select a business first</div>';
          return;
        }
        
        container.innerHTML = `
          <h3>Chart of Accounts</h3>
          
          <div class="notice info">
            Use the "Manage Accounts" button in the header to add/edit accounts.
          </div>
          
          <h4>Current Accounts (${business.accounts.length})</h4>
          <div id="settingsAccountsList"></div>
        `;
        
        const listContainer = document.getElementById('settingsAccountsList');
        listContainer.innerHTML = business.accounts.map(acc => `
          <div class="account-row">
            <div>
              <strong>${acc.name}</strong>
              <span class="badge">${acc.category}</span>
              ${acc.disallowable ? '<span class="flag">Disallowable</span>' : ''}
              ${acc.nonTaxable ? '<span class="flag">Non-taxable</span>' : ''}
              ${acc.rentFrequency ? `<span class="flag">${acc.rentFrequency}</span>` : ''}
            </div>
          </div>
        `).join('');
      } else if (settingType === 'users') {
        const currentUser = getActiveUser();
        
        container.innerHTML = `
          <h3>User Management</h3>
          
          <div class="notice info">
            Use the "Add User" and "Edit User" buttons in the header to manage users.
          </div>
          
          <h4>Current Users (${appState.users.length})</h4>
          <table class="ledger-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Email</th>
                <th>Permissions</th>
              </tr>
            </thead>
            <tbody>
              ${appState.users.map(user => `
                <tr>
                  <td><strong>${user.username}</strong> ${user.id === appState.activeUserId ? '<span class="badge badge-success">Active</span>' : ''}</td>
                  <td><span class="badge">${user.role}</span></td>
                  <td>${user.email || '-'}</td>
                  <td>
                    ${user.permissions.view ? '<span class="flag">View</span>' : ''}
                    ${user.permissions.edit ? '<span class="flag">Edit</span>' : ''}
                    ${user.permissions.delete ? '<span class="flag">Delete</span>' : ''}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <small class="note">
            ‚Ä¢ <strong>Admin</strong> role has all permissions by default<br/>
            ‚Ä¢ <strong>User</strong> role permissions can be customized per user
          </small>
        `;
      }
    }
    
    // ============================================================================
    // INITIALIZE ON LOAD
    // ============================================================================
    
    // Run initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
