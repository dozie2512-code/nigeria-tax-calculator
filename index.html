GitHub Copilot Chat Assistant — Updated index.html follows.

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(680px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    pre.small { font-size:0.85rem; white-space:pre-wrap; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <label>Type:
          <select id="txnType">
            <option value="Income">Income (Sales)</option>
            <option value="Expense">Expense (Purchase)</option>
            <option value="Deduction">Deduction</option>
          </select>
        </label>
        <label>Category:
          <select id="txnCategory">
            <option>Pension</option>
            <option>NHF</option>
            <option>Insurance</option>
            <option>Salary</option>
            <option>Bonus</option>
            <option>Freelance</option>
            <option>Food</option>
            <option>Transport</option>
            <option>Rent</option>
            <option>Utilities</option>
            <option>Other</option>
          </select>
        </label>
        <label>Contact Type:
          <select id="txnContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
          </select>
        </label>
        <label>Contact Name: <input type="text" id="txnContactName" placeholder="e.g. John Doe" /></label>
        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved at the business level. Each transaction records its author (selected user). Business members can view/add transactions depending on membership.</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/type/category/contact info/description/amount/author" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf; border-radius:4px;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable" aria-live="polite">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Category</th>
            <th>Contact</th>
            <th>Description</th>
            <th>Amount (₦)</th>
            <th>VAT (₦)</th>
            <th>Author</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section" id="reportsPanel">
      <h2 style="margin:0 0 8px 0;">Reports</h2>
      <div class="form-inline" style="margin-bottom:8px;">
        <label>Report Type:
          <select id="reportType">
            <option value="profit">Profit</option>
            <option value="vat">VAT</option>
            <option value="paye">PAYE</option>
          </select>
        </label>
        <label>Date From: <input type="date" id="reportDateFrom" /></label>
        <label>Date To: <input type="date" id="reportDateTo" /></label>
        <button class="primary" id="btnGenerateReport">Generate Report</button>
        <button id="btnExportHtml" class="small">Export HTML</button>
        <button id="btnExportCsv" class="small">Export CSV</button>
        <button id="btnExportJson" class="small">Export JSON</button>
      </div>
      <div id="reportOutput" style="margin-top:12px;"></div>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="userNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
    </div>
    <div class="row">
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Members: <select id="bizMembers" multiple size="5" style="min-width:180px"></select></label>
      <small class="note">Hold Ctrl/Cmd to select multiple members. Owner will be included automatically on save.</small>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (tax)</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
    <small class="note">VAT & PIT toggles control whether VAT and personal income tax are computed for this business. VAT rate will be used to compute VAT per business. PIT logic defaults to Nigeria slices unless customized in the business object.</small>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>
    <label>Type:
      <select id="editTxnType">
        <option value="Income">Income (Sales)</option>
        <option value="Expense">Expense (Purchase)</option>
        <option value="Deduction">Deduction</option>
      </select>
    </label><br/>
    <label>Category:
      <select id="editTxnCategory">
        <option>Pension</option>
        <option>NHF</option>
        <option>Insurance</option>
        <option>Salary</option>
        <option>Bonus</option>
        <option>Freelance</option>
        <option>Food</option>
        <option>Transport</option>
        <option>Rent</option>
        <option>Utilities</option>
        <option>Other</option>
      </select>
    </label><br/>
    <label>Contact Type:
      <select id="editTxnContactType">
        <option value="Customer">Customer</option>
        <option value="Vendor">Vendor</option>
        <option value="Employee">Employee</option>
      </select>
    </label><br/>
    <label>Contact Name: <input type="text" id="editTxnContactName" /></label><br/>
    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button onclick="closeEditModal()">Cancel</button>
      <button class="primary" onclick="saveEdit()">Save</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant
    // Data model (new): data = { users: [], businesses: [], transactions: { [bizId]: [ txn, ... ] } }
    // Old model migration: data.transactions used to be { [userId]: { [bizId]: [txn,...] } } - migrated into new structure with authorUserId added.

    const STORAGE_KEY = 'ntc_data_v1';
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    // In-memory state
    let data = { users: [], businesses: [], transactions: {} };
    let selectedUserId = null;
    let selectedBusinessId = null;
    let editIndex = null;

    // Ledger UI state
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';
    let ledgerFiltered = [];

    function uid(prefix='id') { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    function migrateOldTransactions(oldTxns) {
      // oldTxns: { userId: { bizId: [txn,...] } }
      const newTxns = {};
      for (const userId of Object.keys(oldTxns)) {
        const perUser = oldTxns[userId] || {};
        for (const bizId of Object.keys(perUser)) {
          const arr = perUser[bizId] || [];
          if (!newTxns[bizId]) newTxns[bizId] = [];
          for (const t of arr) {
            // Ensure txn has id
            const newTxn = {
              id: t.id || uid('txn'),
              date: (t.date || new Date().toISOString().slice(0,10)),
              type: t.type || 'Income',
              category: t.category || 'Other',
              desc: t.desc || '',
              amount: Number(t.amount) || 0,
              authorUserId: userId,
              contactType: t.contactType || '',
              contactName: t.contactName || ''
            };
            newTxns[bizId].push(newTxn);
          }
        }
      }
      return newTxns;
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') {
            // Basic structure validation & migration
            data.users = parsed.users || [];
            data.businesses = parsed.businesses || [];
            const tx = parsed.transactions || {};
            // Detect old structure: keys are userIds and values are objects mapping bizId->array
            // Heuristic: if any value is object and keys look like biz ids containing 'biz_' OR values are objects and not arrays
            let isOldStructure = false;
            for (const k of Object.keys(tx)) {
              const v = tx[k];
              if (Array.isArray(v)) { isOldStructure = isOldStructure || false; }
              else if (v && typeof v === 'object') { isOldStructure = true; break; }
            }
            if (isOldStructure) {
              data.transactions = migrateOldTransactions(tx);
              // Also ensure that migrated transactions have authorUserId set (done in migrate)
            } else {
              // new structure expected: { [bizId]: [txn,...] }
              data.transactions = tx;
            }
            // Ensure businesses have members arrays
            data.businesses = data.businesses.map(b => {
              if (!Array.isArray(b.members)) b.members = [];
              if (!b.ownerId && b.members && b.members.length) b.ownerId = b.members[0];
              // ensure owner is in members
              if (b.ownerId && !b.members.includes(b.ownerId)) b.members.push(b.ownerId);
              return b;
            });
            // done
            return;
          }
        } catch(e) { console.error('Invalid saved data', e); }
      }
      // default demo (new structure)
      const userId = uid('user');
      const bizId = uid('biz');
      data = {
        users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{ id: bizId, name: 'Demo Business', ownerId: userId, members: [userId], vatRate: 7.5, currency: '₦', threshold: 800000, notes: 'Sample business', vatEnabled: true, pitEnabled: true }],
        transactions: { [bizId]: [
          { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Income', category: 'Freelance', desc: 'Demo sale', amount: 1500000, authorUserId: userId, contactType: 'Customer', contactName: 'Acme Corp' },
          { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Expense', category: 'Rent', desc: 'Office rent', amount: 200000, authorUserId: userId, contactType: 'Vendor', contactName: 'Landlord Services' }
        ] }
      };
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }

    // UI wiring
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    // User modal elements
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userNotes = document.getElementById('userNotes');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    // Business modal elements
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwner = document.getElementById('bizOwner');
    const bizMembers = document.getElementById('bizMembers');
    const bizVat = document.getElementById('bizVat');
    const bizCurrency = document.getElementById('bizCurrency');
    const bizThreshold = document.getElementById('bizThreshold');
    const bizNotes = document.getElementById('bizNotes');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');

    // Edit transaction modal
    const editModal = document.getElementById('editModal');
    const editTxnDate = document.getElementById('editTxnDate');
    const editTxnType = document.getElementById('editTxnType');
    const editTxnCategory = document.getElementById('editTxnCategory');
    const editTxnContactType = document.getElementById('editTxnContactType');
    const editTxnContactName = document.getElementById('editTxnContactName');
    const editTxnDesc = document.getElementById('editTxnDesc');
    const editTxnAmount = document.getElementById('editTxnAmount');

    // Search & pagination UI
    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    // Export/Import UI
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // Reports UI
    const reportType = document.getElementById('reportType');
    const reportDateFrom = document.getElementById('reportDateFrom');
    const reportDateTo = document.getElementById('reportDateTo');
    const btnGenerateReport = document.getElementById('btnGenerateReport');
    const btnExportHtml = document.getElementById('btnExportHtml');
    const btnExportCsv = document.getElementById('btnExportCsv');
    const btnExportJson = document.getElementById('btnExportJson');
    const reportOutput = document.getElementById('reportOutput');

    let userEditingId = null;
    let bizEditingId = null;

    // Initialization
    loadData();
    refreshUserBusinessSelectors();
    ensureSelection();
    currentPage = 1;
    renderLedger();
    calculateSummary();

    // --- Helpers for modals ---
    function openModal(modal) {
      modalOverlay.style.display = 'block';
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal) {
      modalOverlay.style.display = 'none';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      userEditingId = null;
      bizEditingId = null;
    }

    // --- User & Business management ---
    function refreshUserBusinessSelectors() {
      // Users
      userSelect.innerHTML = '';
      data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = (u.display || u.username) + ' (' + u.username + ')';
        userSelect.appendChild(opt);
      });

      // Businesses: show businesses the selected user is a member of; if none, show all
      businessSelect.innerHTML = '';
      const bizList = [];
      if (selectedUserId) {
        for (const b of data.businesses) {
          if (Array.isArray(b.members) && b.members.includes(selectedUserId)) bizList.push(b);
        }
      }
      if (bizList.length === 0) bizList.push(...data.businesses);

      bizList.forEach(b => {
        const owner = findUser(b.ownerId);
        const enabledParts = [];
        if (b.vatEnabled) enabledParts.push('VAT');
        if (b.pitEnabled) enabledParts.push('PIT');
        const status = enabledParts.length ? ' — ' + enabledParts.join('/') : '';
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name} ${owner ? ' — ' + (owner.display || owner.username) : ''} (${b.vatRate}% VAT)${status}`;
        businessSelect.appendChild(opt);
      });

      // bizOwner and members options
      bizOwner.innerHTML = '';
      bizMembers.innerHTML = '';
      data.users.forEach(u => {
        const o = document.createElement('option');
        o.value = u.id;
        o.textContent = (u.display || u.username);
        bizOwner.appendChild(o);

        const m = document.createElement('option');
        m.value = u.id;
        m.textContent = (u.display || u.username) + ' (' + u.username + ')';
        bizMembers.appendChild(m);
      });

      if (!data.users.find(u=>u.id===selectedUserId)) selectedUserId = data.users.length ? data.users[0].id : null;
      if (!data.businesses.find(b=>b.id===selectedBusinessId)) {
        // try to pick a business where selected user is member
        const pick = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
        selectedBusinessId = pick ? pick.id : (data.businesses.length ? data.businesses[0].id : null);
      }

      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function ensureSelection() {
      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length) {
        const pick = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
        selectedBusinessId = pick ? pick.id : data.businesses[0].id;
      }
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    // Users
    btnAddUser.addEventListener('click', () => {
      userModalTitle.textContent = 'Add User';
      userName.value = '';
      userDisplay.value = '';
      userNotes.value = '';
      userEditingId = null;
      openModal(userModal);
    });

    btnEditUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      userModalTitle.textContent = 'Edit User';
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userNotes.value = u.notes || '';
      userEditingId = u.id;
      openModal(userModal);
    });

    btnDeleteUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      if (!confirm(`Delete user "${u.display || u.username}" and remove their authored transactions? This action cannot be undone.`)) return;
      // Remove businesses owned by this user
      const ownedBizIds = data.businesses.filter(b => b.ownerId === u.id).map(b=>b.id);
      data.businesses = data.businesses.filter(b => b.ownerId !== u.id);
      for (const bid of ownedBizIds) {
        if (data.transactions[bid]) delete data.transactions[bid];
      }
      // Remove user from members lists of other businesses and remove their authored txns
      for (const b of data.businesses) {
        if (Array.isArray(b.members)) {
          b.members = b.members.filter(mid => mid !== u.id);
        }
        const txs = data.transactions[b.id] || [];
        data.transactions[b.id] = txs.filter(t => t.authorUserId !== u.id);
      }
      // Remove user
      data.users = data.users.filter(x => x.id !== u.id);
      // If no users left reset everything
      if (!data.users.length) {
        data = { users: [], businesses: [], transactions: {} };
      }
      saveData();
      selectedUserId = data.users.length ? data.users[0].id : null;
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
    });

    userSave.addEventListener('click', () => {
      const username = (userName.value || '').trim();
      if (!username) { alert('Username required'); return; }
      if (userEditingId) {
        const u = findUser(userEditingId);
        if (!u) return;
        u.username = username;
        u.display = (userDisplay.value||'').trim();
        u.notes = (userNotes.value||'').trim();
      } else {
        const exists = data.users.find(x => x.username === username);
        if (exists) { if (!confirm('Username already exists. Add anyway?')) return; }
        const id = uid('user');
        data.users.push({ id, username, display: (userDisplay.value||'').trim(), notes: (userNotes.value||'').trim() });
      }
      saveData();
      closeModal(userModal);
      refreshUserBusinessSelectors();
      ensureSelection();
    });

    userCancel.addEventListener('click', () => closeModal(userModal));

    userSelect.addEventListener('change', (e) => {
      selectedUserId = e.target.value;
      // prefer a business the user is member of
      const owned = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
      if (owned) selectedBusinessId = owned.id;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      currentPage = 1;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
    });

    // Businesses
    btnAddBusiness.addEventListener('click', () => {
      if (!selectedUserId) { alert('Create/select a user first'); return; }
      businessModalTitle.textContent = 'Add Business';
      bizName.value = '';
      bizVat.value = 7.5;
      bizCurrency.value = '₦';
      bizThreshold.value = 800000;
      bizNotes.value = '';
      bizOwner.value = selectedUserId || (data.users[0] && data.users[0].id) || '';
      // select owner as the sole member by default
      for (const opt of bizMembers.options) opt.selected = false;
      const ownerVal = bizOwner.value;
      for (const opt of bizMembers.options) if (opt.value === ownerVal) opt.selected = true;
      bizVatEnabled.checked = true;
      bizPitEnabled.checked = true;
      bizEditingId = null;
      openModal(businessModal);
    });

    btnEditBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizVat.value = (typeof b.vatRate === 'number') ? b.vatRate : 7.5;
      bizCurrency.value = b.currency || '₦';
      bizThreshold.value = (typeof b.threshold === 'number') ? b.threshold : 800000;
      bizNotes.value = b.notes || '';
      bizOwner.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
      // members
      for (const opt of bizMembers.options) {
        opt.selected = Array.isArray(b.members) && b.members.includes(opt.value);
      }
      bizVatEnabled.checked = !!b.vatEnabled;
      bizPitEnabled.checked = (typeof b.pitEnabled === 'undefined') ? true : !!b.pitEnabled;
      bizEditingId = b.id;
      openModal(businessModal);
    });

    btnDeleteBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm(`Delete business "${b.name}" and all its transactions? This action cannot be undone.`)) return;
      data.businesses = data.businesses.filter(x => x.id !== b.id);
      if (data.transactions[b.id]) delete data.transactions[b.id];
      saveData();
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizSave.addEventListener('click', () => {
      const name = (bizName.value || '').trim();
      const ownerIdVal = bizOwner.value;
      const vat = parseFloat(bizVat.value);
      const currency = (bizCurrency.value || '₦').trim();
      const threshold = Number(bizThreshold.value) || 800000;
      const vatEnabledVal = !!bizVatEnabled.checked;
      const pitEnabledVal = !!bizPitEnabled.checked;
      if (!name) { alert('Business name required'); return; }
      if (!ownerIdVal) { alert('Select owner'); return; }
      // gather members from multi-select
      const members = [];
      for (const opt of bizMembers.options) {
        if (opt.selected) members.push(opt.value);
      }
      // ensure owner included
      if (!members.includes(ownerIdVal)) members.push(ownerIdVal);

      if (bizEditingId) {
        const b = findBiz(bizEditingId);
        if (!b) return;
        b.name = name;
        b.ownerId = ownerIdVal;
        b.members = members;
        b.vatRate = isNaN(vat) ? 7.5 : vat;
        b.currency = currency;
        b.threshold = threshold;
        b.notes = (bizNotes.value || '').trim();
        b.vatEnabled = vatEnabledVal;
        b.pitEnabled = pitEnabledVal;
      } else {
        const id = uid('biz');
        data.businesses.push({
          id, name, ownerId: ownerIdVal, members,
          vatRate: isNaN(vat) ? 7.5 : vat,
          currency,
          threshold,
          notes: (bizNotes.value || '').trim(),
          vatEnabled: vatEnabledVal,
          pitEnabled: pitEnabledVal
        });
        // ensure transactions map has key
        if (!data.transactions[id]) data.transactions[id] = [];
      }
      saveData();
      closeModal(businessModal);
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizCancel.addEventListener('click', () => closeModal(businessModal));

    businessSelect.addEventListener('change', (e) => {
      selectedBusinessId = e.target.value;
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // Transactions
    btnAddTxn.addEventListener('click', () => {
      const date = document.getElementById('txnDate').value;
      const type = document.getElementById('txnType').value;
      const category = document.getElementById('txnCategory').value;
      const contactType = document.getElementById('txnContactType').value;
      const contactName = document.getElementById('txnContactName').value.trim();
      const desc = document.getElementById('txnDesc').value.trim();
      const amount = parseFloat(document.getElementById('txnAmount').value) || 0;

      if (!selectedUserId || !selectedBusinessId) {
        alert('Select user and business before adding a transaction.');
        return;
      }
      const biz = findBiz(selectedBusinessId);
      if (!biz) { alert('Selected business not found'); return; }
      // Check membership
      if (!Array.isArray(biz.members) || !biz.members.includes(selectedUserId)) {
        alert('You are not a member of the selected business. Ask the owner to add you as member.');
        return;
      }
      if (!date || !desc || amount <= 0) {
        alert('Please fill all fields and enter a valid amount.');
        return;
      }
      const txn = { id: uid('txn'), date, type, category, contactType, contactName, desc, amount, authorUserId: selectedUserId };
      if (!data.transactions[selectedBusinessId]) data.transactions[selectedBusinessId] = [];
      data.transactions[selectedBusinessId].push(txn);
      saveData();
      clearForm();
      renderLedger();
      calculateSummary();
    });

    function clearForm() {
      document.getElementById('txnDate').value = "";
      document.getElementById('txnDesc').value = "";
      document.getElementById('txnAmount').value = "";
      document.getElementById('txnType').value = "Income";
      document.getElementById('txnCategory').value = "Salary";
      document.getElementById('txnContactType').value = "Customer";
      document.getElementById('txnContactName').value = "";
    }

    function renderLedger() {
      ledgerTbody.innerHTML = '';
      if (!selectedUserId || !selectedBusinessId) {
        ledgerFiltered = [];
        updatePaginationControls();
        return;
      }
      const allTxns = (data.transactions[selectedBusinessId]) || [];
      const q = (ledgerFilterText || '').trim().toLowerCase();
      ledgerFiltered = allTxns.filter(txn => {
        if (!q) return true;
        const author = findUser(txn.authorUserId);
        const authorName = author ? (author.display || author.username) : '';
        const parts = [ txn.date || '', txn.type || '', txn.category || '', txn.contactType || '', txn.contactName || '', txn.desc || '', String(txn.amount || ''), authorName ];
        return parts.join(' ').toLowerCase().includes(q);
      });

      const biz = findBiz(selectedBusinessId);
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageSlice = ledgerFiltered.slice(start, start + PAGE_SIZE);

      pageSlice.forEach((txn) => {
        let vat = 0;
        if (biz && biz.vatEnabled && (txn.type === 'Income' || txn.type === 'Expense')) vat = txn.amount * vatRate;
        const author = findUser(txn.authorUserId);
        const authorName = author ? (author.display || author.username) : '(unknown)';
        let contactDisplay = '';
        if (txn.contactType || txn.contactName) {
          const type = txn.contactType || '';
          const name = txn.contactName || '';
          if (type && name) {
            contactDisplay = escapeHtml(type) + ' — ' + escapeHtml(name);
          } else if (type) {
            contactDisplay = escapeHtml(type);
          } else if (name) {
            contactDisplay = escapeHtml(name);
          }
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${txn.date}</td>
          <td>${txn.type}</td>
          <td>${txn.category}</td>
          <td>${contactDisplay}</td>
          <td>${escapeHtml(txn.desc)}</td>
          <td>${biz && biz.currency ? biz.currency : '₦'}${formatNumber(txn.amount)}</td>
          <td>${(vat && biz && biz.vatEnabled) ? (biz.currency || '₦') + formatNumber(vat) : ''}</td>
          <td>${escapeHtml(authorName)}</td>
          <td>
            <div class="actions">
              <button class="small" onclick="openEditModal('${txn.id}')">Edit</button>
              <button class="small danger" onclick="removeTransaction('${txn.id}')">Delete</button>
            </div>
          </td>`;
        ledgerTbody.appendChild(tr);
      });

      updatePaginationControls();
    }

    function updatePaginationControls() {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
      btnPrevPage.disabled = currentPage <= 1;
      btnNextPage.disabled = currentPage >= totalPages;
    }

    btnPrevPage.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderLedger();
      }
    });
    btnNextPage.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage < totalPages) {
        currentPage++;
        renderLedger();
      }
    });

    btnSearch.addEventListener('click', () => {
      ledgerFilterText = ledgerSearch.value || '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    btnClearSearch.addEventListener('click', () => {
      ledgerSearch.value = '';
      ledgerFilterText = '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    window.openEditModal = function(txnId) {
      if (!selectedBusinessId) return;
      const txns = data.transactions[selectedBusinessId] || [];
      const idx = txns.findIndex(t => t.id === txnId);
      if (idx === -1) return;
      editIndex = idx;
      const t = txns[idx];
      editTxnDate.value = t.date;
      editTxnType.value = t.type;
      editTxnCategory.value = t.category;
      editTxnContactType.value = t.contactType || 'Customer';
      editTxnContactName.value = t.contactName || '';
      editTxnDesc.value = t.desc;
      editTxnAmount.value = t.amount;
      openModal(editModal);
    };

    window.removeTransaction = function(txnId) {
      if (!selectedBusinessId) return;
      if (!confirm('Delete this transaction?')) return;
      const txns = data.transactions[selectedBusinessId] || [];
      const idx = txns.findIndex(t=>t.id===txnId);
      if (idx === -1) return;
      txns.splice(idx,1);
      saveData();
      renderLedger();
      calculateSummary();
    };

    function closeEditModal() {
      closeModal(editModal);
      editIndex = null;
    }
    window.closeEditModal = closeEditModal;

    function saveEdit() {
      if (editIndex === null) return;
      const date = editTxnDate.value;
      const type = editTxnType.value;
      const category = editTxnCategory.value;
      const contactType = editTxnContactType.value;
      const contactName = editTxnContactName.value.trim();
      const desc = editTxnDesc.value.trim();
      const amount = parseFloat(editTxnAmount.value) || 0;
      if (!date || !desc || amount <= 0) { alert('Fill fields and enter valid amount'); return; }
      const txns = data.transactions[selectedBusinessId];
      if (!txns || !txns[editIndex]) return;
      // preserve id and authorUserId
      const orig = txns[editIndex];
      txns[editIndex] = { ...orig, date, type, category, contactType, contactName, desc, amount };
      saveData();
      closeEditModal();
      renderLedger();
      calculateSummary();
    }
    window.saveEdit = saveEdit;

    // Summaries and tax calculations
    function calculateSummary() {
      const biz = findBiz(selectedBusinessId);
      const currency = (biz && biz.currency) ? biz.currency : '₦';
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const threshold = (biz && typeof biz.threshold === 'number') ? biz.threshold : DEFAULT_PIT.threshold;
      const pitEnabled = biz ? (typeof biz.pitEnabled === 'undefined' ? true : !!biz.pitEnabled) : false;
      const vatEnabled = biz ? !!biz.vatEnabled : false;
      const txns = ledgerFiltered && ledgerFiltered.length ? ledgerFiltered : (data.transactions[selectedBusinessId]) || [];

      let incomeTotal = 0, expenseTotal = 0, deductionTotal = 0, rentTotal = 0;
      let vatOutputTotal = 0, vatInputTotal = 0;
      txns.forEach(txn => {
        if (txn.type === 'Income') {
          incomeTotal += txn.amount;
          if (vatEnabled) vatOutputTotal += txn.amount * vatRate;
        } else if (txn.type === 'Expense') {
          expenseTotal += txn.amount;
          if (vatEnabled) vatInputTotal += txn.amount * vatRate;
          if (txn.category === 'Rent') rentTotal += txn.amount;
        } else if (txn.type === 'Deduction') {
          deductionTotal += txn.amount;
        }
      });

      let netBalance = incomeTotal - expenseTotal;
      let vatPayable = (vatOutputTotal - vatInputTotal);
      let rentRelief = rentTotal * 0.20;
      if (rentRelief > 500000) rentRelief = 500000;
      let adjIncome = incomeTotal - deductionTotal - rentRelief;
      if (adjIncome < 0) adjIncome = 0;
      let tax = 0;
      if (pitEnabled) tax = computeTax(adjIncome, biz);
      let effRate = incomeTotal > 0 ? (tax / incomeTotal) * 100 : 0;

      if (vatEnabled) {
        vatSummaryDiv.style.display = '';
        vatSummaryDiv.innerHTML =
          `<strong>VAT Summary (${(vatRate*100).toFixed(2)}%):</strong><br>
           VAT Output (Sales): ${currency}${formatNumber(vatOutputTotal)}<br>
           VAT Input (Purchases): ${currency}${formatNumber(vatInputTotal)}<br>
           <strong>VAT Payable:</strong> ${currency}${formatNumber(vatPayable)}`;
      } else {
        vatSummaryDiv.style.display = 'none';
        vatSummaryDiv.innerHTML = '';
      }

      totalsSummaryDiv.style.display = '';
      totalsSummaryDiv.innerHTML =
        `<strong>Income:</strong> ${currency}${formatNumber(incomeTotal)}  | 
         <strong>Expenses:</strong> ${currency}${formatNumber(expenseTotal)}  | 
         <strong>Deductions:</strong> ${currency}${formatNumber(deductionTotal)}  | 
         <strong>Net Balance:</strong> ${currency}${formatNumber(netBalance)}`;

      if (pitEnabled) {
        taxSummaryDiv.style.display = '';
        taxSummaryDiv.innerHTML =
          `<strong>Tax Calculation (PIT):</strong><br>
           Tax-free threshold: ${currency}${formatNumber(threshold)}<br>
           Rent relief applied: ${currency}${formatNumber(rentRelief)}<br>
           Taxable income after deductions: ${currency}${formatNumber(adjIncome)}<br>
           <strong>Tax payable:</strong> ${currency}${formatNumber(tax,0)}<br>
           Effective tax rate on gross income: ${effRate.toFixed(2)}%<br>
           ${adjIncome <= threshold ? `<strong>No tax payable (taxable income ≤ ${currency}${formatNumber(threshold)})</strong>` : ''}`;
      } else {
        taxSummaryDiv.style.display = 'none';
        taxSummaryDiv.innerHTML = '';
      }
    }

    function computeTax(adjIncome, biz) {
      if (biz && typeof biz.pitEnabled !== 'undefined' && !biz.pitEnabled) return 0;
      const pit = (biz && biz.pit && Array.isArray(biz.pit.slices)) ? biz.pit : DEFAULT_PIT;
      let tax = 0;
      if (adjIncome > (pit.threshold || DEFAULT_PIT.threshold)) {
        let remaining = adjIncome - (pit.threshold || DEFAULT_PIT.threshold);
        let prevUpper = (pit.threshold || DEFAULT_PIT.threshold);
        for (let s of pit.slices) {
          const upper = s.upTo;
          let sliceLimit = (upper === Infinity) ? Infinity : (upper - prevUpper);
          if (remaining <= 0) break;
          const slice = Math.min(remaining, sliceLimit);
          tax += slice * s.rate;
          remaining -= slice;
          prevUpper = upper;
        }
      }
      return Math.max(0, Math.round(tax));
    }

    // Export / Import / Clear
    btnExport.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const now = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `ntc_data_export_${now}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imported = JSON.parse(ev.target.result);
          if (!imported.users || !imported.businesses) throw new Error('Invalid format: missing users/businesses');
          if (!confirm('Import will replace current data. Continue?')) return;
          data = imported;
          // handle old transaction structure if present
          if (data.transactions && Object.keys(data.transactions).length) {
            // detect old structure again
            let isOld = false;
            for (const k of Object.keys(data.transactions)) {
              if (!Array.isArray(data.transactions[k]) && typeof data.transactions[k] === 'object') { isOld = true; break; }
            }
            if (isOld) data.transactions = migrateOldTransactions(data.transactions);
          }
          // ensure businesses have members array and owner included
          data.businesses = data.businesses.map(b => {
            if (!Array.isArray(b.members)) b.members = [];
            if (!b.ownerId && b.members && b.members.length) b.ownerId = b.members[0];
            if (b.ownerId && !b.members.includes(b.ownerId)) b.members.push(b.ownerId);
            return b;
          });
          saveData();
          refreshUserBusinessSelectors();
          ensureSelection();
          currentPage = 1;
          renderLedger();
          calculateSummary();
          alert('Import successful');
        } catch (err) {
          alert('Failed to import JSON: ' + err.message);
        }
      };
      reader.readAsText(f);
      fileInput.value = '';
    });

    btnClearAll.addEventListener('click', () => {
      if (!confirm('Clear ALL saved data (users, businesses, transactions)? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      loadData();
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      alert('All data cleared and reset to demo.');
    });

    // Reports
    btnGenerateReport.addEventListener('click', () => {
      const type = reportType.value;
      const dateFrom = reportDateFrom.value;
      const dateTo = reportDateTo.value;
      const result = generateReport(type, dateFrom, dateTo);
      renderReportOutput(result, type);
    });

    btnExportHtml.addEventListener('click', () => exportReport('html'));
    btnExportCsv.addEventListener('click', () => exportReport('csv'));
    btnExportJson.addEventListener('click', () => exportReport('json'));

    function filterTxnsByDate(txns, from, to) {
      if (!from && !to) return txns;
      return txns.filter(txn => {
        const d = txn.date;
        return (!from || d >= from) && (!to || d <= to);
      });
    }

    function generateReport(type, from, to) {
      if (!selectedUserId || !selectedBusinessId) return { error: "Select user and business first." };
      const allTxns = (data.transactions[selectedBusinessId]) || [];
      const txns = filterTxnsByDate(allTxns, from, to);
      const biz = findBiz(selectedBusinessId);
      const currency = (biz && biz.currency) ? biz.currency : '₦';
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const pitEnabled = biz ? (typeof biz.pitEnabled === 'undefined' ? true : !!biz.pitEnabled) : false;
      const vatEnabled = biz ? !!biz.vatEnabled : false;

      let incomeTotal = 0, expenseTotal = 0, deductionTotal = 0, rentTotal = 0, salaryTotal = 0;
      let vatOutputTotal = 0, vatInputTotal = 0;
      let salaryDetails = [];

      txns.forEach(txn => {
        if (txn.type === 'Income') {
          incomeTotal += txn.amount;
          if (vatEnabled) vatOutputTotal += txn.amount * vatRate;
        } else if (txn.type === 'Expense') {
          expenseTotal += txn.amount;
          if (vatEnabled) vatInputTotal += txn.amount * vatRate;
          if (txn.category === 'Rent') rentTotal += txn.amount;
        } else if (txn.type === 'Deduction') {
          deductionTotal += txn.amount;
        }
        if (txn.category === 'Salary' && txn.type === 'Expense') {
          salaryTotal += txn.amount;
          salaryDetails.push({ desc: txn.desc, amount: txn.amount, date: txn.date, author: findUser(txn.authorUserId) ? (findUser(txn.authorUserId).display || findUser(txn.authorUserId).username) : '(unknown)' });
        }
      });

      let netProfit = incomeTotal - expenseTotal;
      let vatPayable = vatOutputTotal - vatInputTotal;
      let rentRelief = Math.min(rentTotal * 0.20, 500000);
      let adjIncome = incomeTotal - deductionTotal - rentRelief;
      if (adjIncome < 0) adjIncome = 0;
      let tax = pitEnabled ? computeTax(adjIncome, biz) : 0;
      let payeTotal = pitEnabled ? computeTax(salaryTotal, biz) : 0;

      if (type === "profit") {
        return {
          heading: "Profit Report",
          items: [
            { label: "Income", value: `${currency}${formatNumber(incomeTotal)}` },
            { label: "Expenses", value: `${currency}${formatNumber(expenseTotal)}` },
            { label: "Deductions", value: `${currency}${formatNumber(deductionTotal)}` },
            { label: "Net Profit", value: `${currency}${formatNumber(netProfit)}` },
          ],
          raw: { incomeTotal, expenseTotal, deductionTotal, netProfit, from, to, business: biz ? biz.name : null }
        };
      } else if (type === "vat") {
        return {
          heading: "VAT Report",
          items: [
            { label: "VAT Output (Sales)", value: `${currency}${formatNumber(vatOutputTotal)}` },
            { label: "VAT Input (Purchases)", value: `${currency}${formatNumber(vatInputTotal)}` },
            { label: "VAT Payable", value: `${currency}${formatNumber(vatPayable)}` }
          ],
          raw: { vatOutputTotal, vatInputTotal, vatPayable, from, to, business: biz ? biz.name : null }
        };
      } else if (type === "paye") {
        return {
          heading: "PAYE Report",
          items: [
            { label: "Salary total", value: `${currency}${formatNumber(salaryTotal)}` },
            { label: "Estimated PAYE (tax on salaries)", value: `${currency}${formatNumber(payeTotal)}` }
          ],
          details: salaryDetails,
          raw: { salaryTotal, payeTotal, from, to, business: biz ? biz.name : null }
        };
      } else {
        return { error: "Unknown report type" };
      }
    }

    function renderReportOutput(result, type) {
      if (!result) { reportOutput.innerHTML = 'No data'; return; }
      if (result.error) { reportOutput.innerHTML = `<div class="muted">${escapeHtml(result.error)}</div>`; return; }
      let html = `<h3>${escapeHtml(result.heading)}</h3>`;
      html += '<ul>';
      result.items.forEach(it => {
        html += `<li><strong>${escapeHtml(it.label)}:</strong> ${escapeHtml(it.value)}</li>`;
      });
      html += '</ul>';
      if (result.details && result.details.length) {
        html += `<h4>Details</h4><ul>`;
        result.details.forEach(d => {
          html += `<li>${escapeHtml(d.date)} - ${escapeHtml(d.desc)} - ${escapeHtml(d.author)} - ${escapeHtml((data.businesses.find(b=>b.id===selectedBusinessId) || {}).currency || '₦')}${formatNumber(d.amount)}</li>`;
        });
        html += '</ul>';
      }
      reportOutput.innerHTML = html;
    }

    function exportReport(format) {
      const type = reportType.value;
      const dateFrom = reportDateFrom.value;
      const dateTo = reportDateTo.value;
      const result = generateReport(type, dateFrom, dateTo);
      if (result.error) return alert(result.error);
      if (format === 'json') {
        const blob = new Blob([JSON.stringify(result.raw || result, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${type}_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } else if (format === 'csv') {
        // Simple CSV from items
        let csv = 'label,value\n';
        (result.items || []).forEach(it => {
          csv += `"${it.label.replace(/"/g,'""')}","${String(it.value).replace(/"/g,'""')}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${type}_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } else if (format === 'html') {
        const html = reportOutput.innerHTML || '<div>No report</div>';
        const blob = new Blob([`<html><body>${html}</body></html>`], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${type}_${new Date().toISOString().slice(0,10)}.html`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
    }

    // Utilities
    function formatNumber(n, decimals=2) {
      if (typeof n !== 'number') n = Number(n) || 0;
      return n.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }
    function escapeHtml(s) {
      if (s === null || s === undefined) return '';
      return String(s).replace(/[&<>"']/g, function(m) {
        return { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m];
      });
    }

    // Initial UI update bindings for controls created earlier
    // ensure selected options reflect state
    refreshUserBusinessSelectors();
    ensureSelection();
    renderLedger();
    calculateSummary();

    // When page visibility changes (just a simple hook), re-render to account for updated user/business lists
    window.addEventListener('storage', () => {
      loadData();
      refreshUserBusinessSelectors();
      ensureSelection();
      renderLedger();
      calculateSummary();
    });

  </script>

  <footer>
    <div class="muted">This is a client-only demo. Data is stored in your browser localStorage. Export to backup.</div>
  </footer>
</body>
                             </html>
