<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Tax & Accounting — 2026 (PIT/CIT) — Enhanced</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:18px; color:#222; background:#fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(960px,96vw); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:220px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .bank-list { max-height:140px; overflow:auto; border:1px solid #eee; padding:6px; border-radius:6px; }
    .recon-row { display:flex; gap:8px; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0; padding:6px 0; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Nigeria Tax & Accounting — 2026 (PIT/CIT)</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnBankTab">Bank</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnSignIn" class="small">Sign in</button>
        <button id="btnSignUp" class="small">Sign up</button>
        <button id="btnSignOut" class="small" style="display:none;">Sign out</button>
      </div>

      <div style="width:8px;"></div>

      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none;" />
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <label><input type="checkbox" id="invIsOpening" /> Opening inventory</label>

          <button id="btnAddInv" class="small">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset</h3>

        <div id="assetPurchaseArea" class="form-inline" style="display:none;">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>

          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>
          <label>Receipt: <input type="file" id="assetReceipt" /></label>
          <label><input type="checkbox" id="assetIsOpening" /> Opening asset</label>
          <button id="btnAddAsset" class="small">Record Asset Purchase</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>

        <div id="assetDisposalArea" class="form-inline" style="display:none;">
          <label>Asset:
            <select id="assetSelectForDisposal"></select>
          </label>
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>
          <label>Contact: <input type="text" id="assetDisposalContact" placeholder="Contact name" /></label>
          <label>Receipt: <input type="file" id="assetDisposalReceipt" /></label>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetCancel2" class="small">Cancel</button>
        </div>

        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days. Capital allowance applied monthly from purchase.</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th style="text-align:right;">Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>

      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="bankSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Bank Accounts & Mini Reconciliation</h2>

      <div class="form-inline" style="margin-bottom:8px;">
        <label>Account name: <input type="text" id="bankName" /></label>
        <label>Opening balance (₦): <input type="number" id="bankOpening" min="0" step="0.01" /></label>
        <button id="btnAddBank" class="small">Add Account</button>
      </div>
      <div style="display:flex;gap:12px;">
        <div style="flex:1;">
          <h4>Bank Accounts</h4>
          <div id="bankList" class="bank-list"></div>
        </div>
        <div style="flex:2;">
          <h4>Mini Reconciliation</h4>
          <div class="form-inline" style="margin-bottom:8px;">
            <label>Bank:
              <select id="reconBankSelect"></select>
            </label>
            <label>Date: <input type="date" id="reconDate" /></label>
            <label>Amount: <input type="number" id="reconAmount" step="0.01" /></label>
            <label>Type:
              <select id="reconType">
                <option value="in">Deposit (in)</option>
                <option value="out">Withdrawal (out)</option>
              </select>
            </label>
            <button id="btnAddBankTxn" class="small">Add Bank Txn</button>
          </div>
          <div id="bankTxnList" class="bank-list"></div>
          <small class="note">Select a bank transaction to match against ledger transactions below. Matching marks it reconciled for this simple mini-recon.</small>
          <div style="margin-top:8px;">
            <h5>Unmatched ledger transactions</h5>
            <div id="unmatchedLedger" class="bank-list"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <!-- Minimal modals (kept basic for demo) -->
  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent frequency:
            <select id="bizRentFreq" class="smallInput">
              <option value="yearly">Yearly</option>
              <option value="monthly">Monthly</option>
            </select>
          </label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you have a Sole Trader contact defined, the statutory deductions on that contact will be used for PIT calculation instead of these values.</small>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">GitHub Copilot Chat Assistant — implemented per request (attachments and audit stored in localStorage)</footer>

  <script>
    // Identify as GitHub Copilot Chat Assistant in console
    console.log('GitHub Copilot Chat Assistant: initializing index.html');

    // STORAGE KEY and constants
    const STORAGE_KEY = 'ntc_2026_v6';
    const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, firsLabel:'' };
    // PAYE bands as provided (annual)
    const PAYE_BANDS = [
      { upTo: 800000, rate: 0.00 },
      { upTo: 3000000, rate: 0.15 },
      { upTo: 12000000, rate: 0.18 },
      { upTo: 25000000, rate: 0.21 },
      { upTo: 50000000, rate: 0.23 },
      { upTo: Infinity, rate: 0.25 }
    ];
    const CIT_TURNOVER_THRESHOLD = 50000000; // 50,000,000
    const DEVELOPMENT_LEVY_RATE = 0.04; // 4% when turnover > threshold

    // State
    let data = { users: [], businesses: [], transactions: {}, attachments: [], audit: [], auth: { currentUser:null }, banks: {} };
    let selectedUser = null;
    let selectedBiz = null;
    let activeTab = 'ledger';

    // DOM refs (only ones used in this version)
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const txnDate = document.getElementById('txnDate');
    const txnAction = document.getElementById('txnAction');
    const txnAccount = document.getElementById('txnAccount');
    const txnDesc = document.getElementById('txnDesc');
    const txnAmount = document.getElementById('txnAmount');
    const txnVatType = document.getElementById('txnVatType');
    const txnWht = document.getElementById('txnWht');
    const txnWhtBasis = document.getElementById('txnWhtBasis');
    const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
    const txnWhtRate = document.getElementById('txnWhtRate');
    const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
    const txnSalary = document.getElementById('txnSalary');
    const txnContact = document.getElementById('txnContact');
    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTableBody = document.querySelector('#ledgerTable tbody');
    const taxSummaryDiv = document.getElementById('taxSummary');
    const plSnapshotDiv = document.getElementById('plSnapshot');
    const plSnapshotQuick = document.getElementById('plSnapshotQuick');
    const btnLedgerTab = document.getElementById('btnLedgerTab');
    const btnBankTab = document.getElementById('btnBankTab');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');

    // utilities
    function uid(prefix = 'id') { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function today(){ return new Date().toISOString().slice(0,10); }

    // load/save
    function saveData(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){ console.error('saveData error', e); } }
    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ seedDemo(); return; }
      try { data = JSON.parse(raw); migrate(); } catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
    }
    function migrate(){
      data.users = data.users || [];
      data.businesses = data.businesses || [];
      data.transactions = data.transactions || {};
      data.attachments = data.attachments || [];
      data.audit = data.audit || [];
      data.auth = data.auth || { currentUser: null };
      data.banks = data.banks || {};
      data.businesses.forEach(b => {
        b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
        b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
        b.citRate = Number(b.citRate || DEFAULTS.citRate);
        b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
        b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
        b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
        b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
        b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
        b.accounts = b.accounts || [];
        b.inventory = b.inventory || [];
        b.assets = b.assets || [];
        b.contacts = b.contacts || [];
        b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
        b.lossBroughtForward = Number(b.lossBroughtForward || 0);
        b.caCarryForward = Number(b.caCarryForward || 0);
        b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
        b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
        b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
        b.rentFrequency = b.rentFrequency || 'yearly';
      });
      for(const u of data.users){ if(!data.transactions[u.id]) data.transactions[u.id] = {}; data.businesses.forEach(b => { if(!data.transactions[u.id][b.id]) data.transactions[u.id][b.id] = []; }); }
      saveData();
    }

    function seedDemo(){
      const u = uid('user'), b = uid('biz');
      const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
      const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const rent = { id: uid('acct'), name: 'Rent', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const chargeInc = { id: uid('acct'), name: 'Chargeable asset income', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
      const chargeCost = { id: uid('acct'), name: 'Chargeable asset cost', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };

      data = {
        users: [{ id: u, username: 'admin', display:'Admin User', role:'Admin', isAdmin:true, permissions:{ view:true, edit:true, delete:true }, passwordHash: null }],
        businesses: [{
          id: b,
          name: 'Demo Business',
          ownerId: u,
          entity: 'Company',
          vatRate: DEFAULTS.vatRate,
          whtRate: DEFAULTS.whtRate,
          citRate: DEFAULTS.citRate,
          vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
          accounts: [sales, cogs, salaries, rent, chargeInc, chargeCost],
          inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
          assets: [{ id: uid('asset'), name: 'Laptop', cost: 200000, purchaseDate: today(), usefulLifeYears:3, capitalAllowancePct: 20 }],
          contacts: [{ id: uid('c'), name:'John Employee', type:'Employee', statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 } }],
          statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
          lossBroughtForward: 0, caCarryForward: 0, capitalBroughtForward: 0,
          defaultExpenseDisallowable:false, defaultRevenueNonTax:false,
          firsLabel: '', firsUrl:'', rentFrequency:'yearly'
        }],
        transactions: {},
        attachments: [],
        audit: [],
        auth: { currentUser: u },
        banks: {}
      };
      data.transactions[u] = {};
      data.transactions[u][b] = [
        { id: uid('txn'), date: today(), action: 'Revenue', accountId: sales.id, accountName: sales.name, accountCategory: sales.category, description: 'Demo sale', amount: 150000, vatType: 'exclusive', whtApplied: false, paye:false, contact:'Customer A' },
        { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, accountCategory: salaries.category, description: 'Demo salary', amount: 50000, vatType: 'none', whtApplied: false, paye:true, contact:'John Employee' },
        { id: uid('txn'), date: today(), action: 'Expense', accountId: rent.id, accountName: rent.name, accountCategory: rent.category, description: 'Office rent', amount: 20000, vatType: 'none', whtApplied: false, paye:false, contact:'Landlord' }
      ];
      addAudit('seed','system','',`Seeded demo data`);
      saveData();
      selectedUser = u;
      selectedBiz = b;
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      renderAll();
    }

    function addAudit(type, entityType, entityId, details){
      const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: data.auth?.currentUser || null, type, entityType, entityId, details };
      data.audit = data.audit || [];
      data.audit.push(entry);
      saveData();
    }

    // UI basics
    function refreshSelectors(){
      userSelect.innerHTML = '';
      const bizOwnerSelect = document.getElementById('bizOwner');
      if(bizOwnerSelect) bizOwnerSelect.innerHTML = '';
      data.users.forEach(u => {
        const o = document.createElement('option'); o.value = u.id; o.textContent = u.display || u.username; userSelect.appendChild(o);
        if(bizOwnerSelect){ const o2 = o.cloneNode(true); bizOwnerSelect.appendChild(o2); }
      });
      businessSelect.innerHTML = '';
      data.businesses.forEach(b => {
        const o = document.createElement('option'); o.value = b.id; o.textContent = b.name; businessSelect.appendChild(o);
      });
      if(data.auth && data.auth.currentUser){
        const u = data.users.find(x => x.id === data.auth.currentUser);
        document.getElementById('authInfo').textContent = u ? `Signed in: ${u.display || u.username}` : '';
      } else {
        document.getElementById('authInfo').textContent = '';
      }
    }
    function ensureSelection(){
      if(!selectedUser) selectedUser = (data.users[0] && data.users[0].id) || null;
      if(!selectedBiz) selectedBiz = (data.businesses[0] && data.businesses[0].id) || null;
      if(selectedUser) userSelect.value = selectedUser;
      if(selectedBiz) businessSelect.value = selectedBiz;
      data.auth.currentUser = data.auth.currentUser || selectedUser;
    }

    function populateAccountSelect(){
      txnAccount.innerHTML = '';
      const b = findBiz(selectedBiz);
      if(!b) return;
      b.accounts.forEach(a => {
        const o = document.createElement('option'); o.value = a.id; o.textContent = `${a.name} (${a.category})`;
        txnAccount.appendChild(o);
      });
    }

    function findUser(id){ return data.users.find(u => u.id === id); }
    function findBiz(id){ return data.businesses.find(b => b.id === id); }
    function findAccount(biz, acctId){ return (biz && biz.accounts || []).find(a => a.id === acctId); }

    function resetForms(){
      try {
        txnDate.value = today();
        txnAction.value = '';
        txnAccount.value = txnAccount.options[0] ? txnAccount.options[0].value : '';
        txnDesc.value = '';
        txnAmount.value = '';
        txnVatType.value = 'none';
        txnWht.checked = false;
        txnWhtBasis.value = 'gross';
        txnWhtRate.value = '';
        txnSalary.checked = false;
        txnContact.value = '';
      } catch(e){ console.error('resetForms', e); }
    }

    // Rendering ledger & P&L
    function renderLedger(){
      ledgerTableBody.innerHTML = '';
      if(!selectedUser || !selectedBiz || !data.transactions[selectedUser] || !data.transactions[selectedUser][selectedBiz]) return;
      const txns = data.transactions[selectedUser][selectedBiz] || [];
      const search = (document.getElementById('ledgerSearch').value || '').toLowerCase();
      txns.forEach(tx => {
        const text = `${tx.date} ${tx.action} ${tx.accountName || ''} ${tx.description || ''} ${tx.amount || 0} ${tx.contact || ''}`.toLowerCase();
        if(search && text.indexOf(search) === -1) return;
        const tr = document.createElement('tr');
        const vatText = tx.vatType ? (tx.vatType === 'exclusive' ? 'Exclusive' : (tx.vatType === 'inclusive' ? 'Inclusive' : 'None')) : 'None';
        const whtText = tx.whtApplied ? (tx.whtRate ? `${tx.whtRate}%` : 'Yes') : '';
        const payeText = tx.paye ? 'Yes' : (tx.salary ? 'Yes' : '');
        const receiptLink = tx.receiptId ? `<a href="#" data-id="${tx.receiptId}" class="link-like">View</a>` : '';
        tr.innerHTML = `<td>${tx.date}</td><td>${tx.action}</td><td>${tx.accountName || ''}</td><td>${tx.description || ''}</td><td style="text-align:right;">${fmt(tx.amount)}</td><td>${vatText}</td><td>${whtText}</td><td>${payeText}</td><td>${tx.contact || ''}</td><td>${receiptLink}</td>`;
        ledgerTableBody.appendChild(tr);
      });
    }

    function renderPlSnapshot(){
      const b = findBiz(selectedBiz);
      if(!b) { plSnapshotDiv.innerHTML = ''; plSnapshotQuick.innerHTML = ''; return; }
      const txns = (data.transactions[selectedUser] && data.transactions[selectedUser][selectedBiz]) || [];
      const totals = txns.reduce((acc, t) => {
        if(t.accountCategory === 'Revenue') acc.revenue += Number(t.amount || 0);
        if(t.accountCategory === 'Expense') acc.expenses += Number(t.amount || 0);
        return acc;
      }, { revenue:0, expenses:0 });
      const profit = totals.revenue - totals.expenses;
      plSnapshotDiv.innerHTML = `<strong>Revenue:</strong> ₦${fmt(totals.revenue)} &nbsp;&nbsp; <strong>Expenses:</strong> ₦${fmt(totals.expenses)} &nbsp;&nbsp; <strong>Profit:</strong> ₦${fmt(profit)}`;
      plSnapshotQuick.innerHTML = plSnapshotDiv.innerHTML;
    }

    // Tax computations
    function computeVAT(txns, biz){
      // Returns object { vatOnSales, vatOnPurchases, vatPayable } (all numbers)
      const rate = Number(biz.vatRate || DEFAULTS.vatRate) / 100;
      let vatOnSales = 0;
      let vatOnPurchases = 0;
      txns.forEach(t => {
        const amt = Number(t.amount || 0);
        const vatType = t.vatType || 'none';
        if(t.accountCategory === 'Revenue'){
          if(vatType === 'exclusive') vatOnSales += amt * rate;
          else if(vatType === 'inclusive') vatOnSales += amt - (amt / (1 + rate)); // extract VAT portion
        } else if(t.accountCategory === 'Expense'){
          if(vatType === 'exclusive') vatOnPurchases += amt * rate;
          else if(vatType === 'inclusive') vatOnPurchases += amt - (amt / (1 + rate));
        }
      });
      const vatPayable = Math.max(0, vatOnSales - vatOnPurchases);
      return { vatOnSales, vatOnPurchases, vatPayable };
    }

    function computeWHT(txns, biz){
      // Sum WHT applied on txns with whtApplied true. Rate priority: txn.whtRate -> biz.whtRate
      let totalWHT = 0;
      txns.forEach(t => {
        if(!t.whtApplied) return;
        const rate = (typeof t.whtRate !== 'undefined' && t.whtRate !== null && t.whtRate !== '') ? Number(t.whtRate) : Number(biz.whtRate || DEFAULTS.whtRate);
        const basis = t.whtBasis || 'gross';
        const amt = Number(t.amount || 0);
        const rateDec = Number(rate || 0) / 100;
        let base = amt;
        if(basis === 'net' && t.vatType === 'exclusive'){
          const vatRate = Number(biz.vatRate || DEFAULTS.vatRate) / 100;
          base = amt - (amt * vatRate);
        }
        totalWHT += base * rateDec;
      });
      return { totalWHT };
    }

    function computePAYE(txns, biz){
      // Sum salary/payroll transactions and compute PAYE using PAYE_BANDS.
      // This is simplified: we treat total salaries recorded as annual total for PAYE calc.
      const salaryTxns = txns.filter(t => t.paye || t.salary || t.action === 'Payroll' || (t.accountCategory === 'Expense' && /salary|wage|payroll/i.test((t.accountName||'')+ (t.description||''))));
      const totalSalary = salaryTxns.reduce((s,t) => s + Number(t.amount||0), 0);
      // If business has payroll frequency or user expects monthly amounts, we assume amounts are annual in this simplified approach.
      const taxable = Math.max(0, totalSalary - getStatutoryDeductionAmount(biz));
      const tax = applyPayeBands(taxable);
      return { totalSalary, taxable, tax };
    }

    function getStatutoryDeductionAmount(biz){
      // Use business statutory deductions (annual). If rent frequency is monthly, multiply by 12.
      if(!biz) return 0;
      let s = biz.statutoryDeductions || {};
      let rent = Number(s.rent || biz.dedRent || 0);
      if(biz.rentFrequency === 'monthly') rent = rent * 12;
      const pension = Number(s.pension || biz.dedPension || 0);
      const life = Number(s.life || biz.dedLife || 0);
      const mortgage = Number(s.mortgage || biz.dedMortgage || 0);
      const nhf = Number(s.nhf || biz.dedNHF || 0);
      return pension + rent + life + mortgage + nhf;
    }

    function applyPayeBands(taxable){
      // Applies the progressive bands progressively.
      let remaining = taxable;
      let tax = 0;
      let lower = 0;
      for(const band of PAYE_BANDS){
        const cap = band.upTo;
        const bandAmount = Math.max(0, Math.min(remaining, cap - lower));
        if(bandAmount > 0){
          tax += bandAmount * band.rate;
          remaining -= bandAmount;
        }
        lower = cap;
        if(remaining <= 0) break;
      }
      return tax;
    }

    function computePIT(txns, biz){
      // Simplified PIT for sole proprietor. taxable = Revenue - allowable expenses - statutory deductions - capital allowances - lossBf
      if(!biz || biz.entity !== 'SoleProprietor') return { taxableProfit:0, pit:0, breakdown:{} };

      const revenue = txns.filter(t => t.accountCategory === 'Revenue').reduce((s,t)=>s+Number(t.amount||0),0);
      const expenses = txns.filter(t => t.accountCategory === 'Expense').reduce((s,t)=>s+Number(t.amount||0),0);
      const statDed = getStatutoryDeductionAmount(biz);
      const ca = computeAnnualCapitalAllowances(biz);
      let taxableProfit = revenue - expenses - statDed - ca - Number(biz.lossBroughtForward || 0);
      taxableProfit = Math.max(0, taxableProfit);
      const pit = applyPayeBands(taxableProfit); // reuse PAYE bands for PIT (as per simplification)
      return { revenue, expenses, statDed, ca, taxableProfit, pit };
    }

    function computeAnnualCapitalAllowances(biz){
      // Sum asset capital allowance % * cost (annual). If asset has capitalAllowancePct use that; otherwise use asset.capitalAllowancePct
      if(!biz || !Array.isArray(biz.assets)) return 0;
      return biz.assets.reduce((s,a) => {
        const pct = Number(a.capitalAllowancePct || a.ca || a.capitalAllowance || 0) / 100;
        const cost = Number(a.cost || a.value || 0);
        return s + (cost * pct);
      }, 0);
    }

    function computeCIT(txns, biz){
      // Simplified CIT: taxableProfit = revenue - allowableExpenses - capitalAllowances + adjustments
      if(!biz || biz.entity === 'SoleProprietor') return { taxableProfit:0, cit:0, developmentLevy:0, breakdown:{} };

      const revenue = txns.filter(t => t.accountCategory === 'Revenue').reduce((s,t)=>s+Number(t.amount||0),0);
      const expenses = txns.filter(t => t.accountCategory === 'Expense').reduce((s,t)=>s+Number(t.amount||0),0);
      const capitalAllowances = computeAnnualCapitalAllowances(biz);
      let taxableProfit = revenue - expenses - capitalAllowances - Number(biz.lossBroughtForward || 0);
      taxableProfit = Math.max(0, taxableProfit);
      const citRate = Number(biz.citRate || DEFAULTS.citRate) / 100;
      const cit = taxableProfit * citRate;
      let developmentLevy = 0;
      if(revenue > CIT_TURNOVER_THRESHOLD) developmentLevy = revenue * DEVELOPMENT_LEVY_RATE;
      return { revenue, expenses, capitalAllowances, taxableProfit, cit, developmentLevy };
    }

    // Aggregate and render tax summary into UI
    function renderTaxSummary(){
      const b = findBiz(selectedBiz);
      taxSummaryDiv.innerHTML = '';
      if(!b) return;
      const txns = (data.transactions[selectedUser] && data.transactions[selectedUser][selectedBiz]) || [];

      // VAT
      const vat = computeVAT(txns, b);

      // WHT
      const wht = computeWHT(txns, b);

      // PAYE
      const paye = computePAYE(txns, b);

      // PIT (sole proprietor)
      const pit = computePIT(txns, b);

      // CIT (company)
      const cit = computeCIT(txns, b);

      // Build HTML
      let html = `<h3>Tax Summary — ${b.name}</h3>`;
      html += `<div class="small-muted">Rates used: VAT ${b.vatRate}% | WHT ${b.whtRate}% | CIT ${b.citRate}%</div>`;
      html += `<div style="margin-top:8px;"><strong>VAT</strong><div class="mutedBlock">VAT on Sales: ₦${fmt(vat.vatOnSales)} — VAT on Purchases/Inputs: ₦${fmt(vat.vatOnPurchases)} — VAT payable: ₦${fmt(vat.vatPayable)}</div></div>`;
      html += `<div style="margin-top:8px;"><strong>WHT</strong><div class="mutedBlock">Total WHT withheld: ₦${fmt(wht.totalWHT)}</div></div>`;
      html += `<div style="margin-top:8px;"><strong>PAYE (Payroll)</strong><div class="mutedBlock">Total salaries recorded: ₦${fmt(paye.totalSalary)} — Taxable after statutory deductions: ₦${fmt(paye.taxable)} — PAYE due: ₦${fmt(paye.tax)}</div></div>`;

      if(b.entity === 'SoleProprietor' && b.pitEnabled){
        html += `<div style="margin-top:8px;"><strong>PIT (Sole Proprietor)</strong><div class="mutedBlock">Revenue: ₦${fmt(pit.revenue)} — Expenses: ₦${fmt(pit.expenses)} — Statutory deductions: ₦${fmt(pit.statDed)} — Capital allowances: ₦${fmt(pit.ca)} — Taxable profit: ₦${fmt(pit.taxableProfit)} — PIT due: ₦${fmt(pit.pit)}</div></div>`;
      }

      if(b.entity !== 'SoleProprietor' && b.citEnabled){
        html += `<div style="margin-top:8px;"><strong>CIT (Company)</strong><div class="mutedBlock">Revenue: ₦${fmt(cit.revenue)} — Expenses: ₦${fmt(cit.expenses)} — Capital allowances: ₦${fmt(cit.capitalAllowances)} — Taxable profit: ₦${fmt(cit.taxableProfit)} — CIT due: ₦${fmt(cit.cit)}</div>`;
        if(cit.developmentLevy && cit.developmentLevy > 0){
          html += `<div class="mutedBlock">Development levy (turnover > ₦${fmt(CIT_TURNOVER_THRESHOLD)}): ₦${fmt(cit.developmentLevy)}</div>`;
        }
        html += `</div>`;
      }

      if(b.showLines){
        html += `<div style="margin-top:10px;" class="notice">Note: These computations are simplified for demo purposes. For accurate filing, consult a tax professional.</div>`;
      }

      taxSummaryDiv.innerHTML = html;
    }

    // Event wiring and helpers for adding transactions
    function addTransactionFromForm(){
      const b = findBiz(selectedBiz);
      if(!selectedUser || !b) { alert('Select a user and business'); return; }
      const account = findAccount(b, txnAccount.value);
      const tx = {
        id: uid('txn'),
        date: txnDate.value || today(),
        action: txnAction.value || 'Expense',
        accountId: account ? account.id : null,
        accountName: account ? account.name : (txnAccount.options[txnAccount.selectedIndex] ? txnAccount.options[txnAccount.selectedIndex].text : ''),
        accountCategory: account ? account.category : 'Expense',
        description: txnDesc.value || '',
        amount: Number(txnAmount.value || 0),
        vatType: txnVatType.value || 'none',
        whtApplied: txnWht.checked || false,
        whtBasis: txnWhtBasis.value || 'gross',
        whtRate: txnWhtRate.value ? Number(txnWhtRate.value) : undefined,
        paye: txnSalary.checked || false,
        salary: txnSalary.checked || false,
        contact: txnContact.value || ''
      };
      data.transactions[selectedUser] = data.transactions[selectedUser] || {};
      data.transactions[selectedUser][selectedBiz] = data.transactions[selectedUser][selectedBiz] || [];
      data.transactions[selectedUser][selectedBiz].push(tx);
      addAudit('txn_add','transaction',tx.id, `Added txn ${tx.description || ''}`);
      saveData();
      resetForms();
      renderAll();
    }

    // Utility to wire simple UI interactions
    function renderAll(){
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      renderLedger();
      renderPlSnapshot();
      renderTaxSummary();
    }

    // Basic DOM event listeners
    btnAddTxn.addEventListener('click', (e) => { e.preventDefault(); addTransactionFromForm(); });
    userSelect.addEventListener('change', (e) => { selectedUser = e.target.value; renderAll(); });
    businessSelect.addEventListener('change', (e) => { selectedBiz = e.target.value; populateAccountSelect(); renderAll(); });
    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; renderTab(); });
    btnBankTab.addEventListener('click', ()=> { activeTab='bank'; renderTab(); });
    btnSearch.addEventListener('click', ()=> { renderLedger(); });
    btnClearSearch.addEventListener('click', ()=> { document.getElementById('ledgerSearch').value=''; renderLedger(); });

    function renderTab(){
      const ledgerSection = document.getElementById('ledgerSection');
      const bankSection = document.getElementById('bankSection');
      if(activeTab === 'ledger'){ ledgerSection.style.display='block'; bankSection.style.display='none'; btnLedgerTab.classList.add('active'); btnBankTab.classList.remove('active'); }
      else { ledgerSection.style.display='none'; bankSection.style.display='block'; btnLedgerTab.classList.remove('active'); btnBankTab.classList.add('active'); }
    }

    // Accounts management (very minimal)
    document.getElementById('btnManageAccounts').addEventListener('click', ()=> {
      const accountsModal = document.getElementById('accountsModal');
      openModal(accountsModal);
      renderAccounts();
    });
    document.getElementById('closeAccountsBtn').addEventListener('click', ()=> closeModal(document.getElementById('accountsModal')));
    document.getElementById('addAccountBtn').addEventListener('click', ()=> {
      const b = findBiz(selectedBiz);
      if(!b) return;
      const name = document.getElementById('newAccountName').value.trim();
      const cat = document.getElementById('newAccountCategory').value;
      if(!name) return alert('Account name required');
      const acct = { id: uid('acct'), name, category: cat, disallowableDefault:false, nonTaxableDefault:false };
      b.accounts.push(acct);
      saveData();
      populateAccountSelect();
      renderAccounts();
      closeModal(document.getElementById('accountsModal'));
      renderAll();
    });
    function renderAccounts(){
      const accountsList = document.getElementById('accountsList');
      accountsList.innerHTML = '';
      const b = findBiz(selectedBiz);
      if(!b) { accountsList.textContent = 'No business selected.'; return; }
      b.accounts.forEach(a => {
        const row = document.createElement('div');
        row.className = 'account-row';
        row.innerHTML = `<div><strong>${a.name}</strong> <span class="small-muted">(${a.category})</span></div><div><button data-id="${a.id}" class="small danger">Delete</button></div>`;
        accountsList.appendChild(row);
        const btn = row.querySelector('button');
        btn.addEventListener('click', ()=> {
          if(!confirm('Delete account? This will not remove historical transactions.')) return;
          b.accounts = b.accounts.filter(x=>x.id !== a.id);
          saveData();
          populateAccountSelect();
          renderAccounts();
          renderAll();
        });
      });
    }

    // Basic modal open/close helpers
    const modalOverlay = document.getElementById('modalOverlay');
    function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
    function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
    modalOverlay.addEventListener('click', ()=> {
      [document.getElementById('userModal'), document.getElementById('businessModal'), document.getElementById('accountsModal')].forEach(m => { if(m && m.style.display==='block') closeModal(m); });
    });

    // Simple user/business create flows
    document.getElementById('btnAddUser').addEventListener('click', ()=> {
      const name = prompt('username (id):', 'user');
      if(!name) return;
      const u = { id: uid('user'), username: name, display: name, role:'User', isAdmin:false, permissions:{ view:true, edit:true, delete:false } };
      data.users.push(u);
      data.transactions[u.id] = {};
      data.businesses.forEach(b => { data.transactions[u.id][b.id] = []; });
      saveData();
      refreshSelectors();
      ensureSelection();
      renderAll();
    });

    document.getElementById('btnAddBusiness').addEventListener('click', ()=> {
      const name = prompt('Business name:','New Business');
      if(!name) return;
      const ownerId = data.users[0] && data.users[0].id;
      const b = { id: uid('biz'), name, ownerId, entity:'Company', vatRate:DEFAULTS.vatRate, whtRate:DEFAULTS.whtRate, citRate:DEFAULTS.citRate, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, accounts:[], inventory:[], assets:[], contacts:[], statutoryDeductions:{pension:0, rent:0, life:0, mortgage:0, nhf:0}, lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, rentFrequency:'yearly' };
      // create default accounts
      b.accounts = [
        { id: uid('acct'), name:'Sales', category:'Revenue' },
        { id: uid('acct'), name:'COGS', category:'Expense' },
        { id: uid('acct'), name:'Salaries', category:'Expense' },
        { id: uid('acct'), name:'Rent', category:'Expense' }
      ];
      data.businesses.push(b);
      // ensure transactions map for all users
      for(const u of data.users){ data.transactions[u.id] = data.transactions[u.id] || {}; data.transactions[u.id][b.id] = []; }
      saveData();
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      renderAll();
    });

    // FILE import/export and clear
    document.getElementById('btnExport').addEventListener('click', ()=> {
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc_data.json'; a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', (e)=> {
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = (ev)=> {
        try { data = JSON.parse(ev.target.result); migrate(); renderAll(); alert('Imported'); } catch(err){ alert('Invalid JSON'); }
      };
      r.readAsText(f);
    });
    document.getElementById('btnClearAll').addEventListener('click', ()=> {
      if(!confirm('Clear all local data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    });

    // Simple init
    loadData();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    resetForms();
    renderAll();

    // Expose some helpers for debugging in console
    window.ntc = { data, computeVAT, computeWHT, computePAYE, computePIT, computeCIT, computeAnnualCapitalAllowances };
  </script>
</body>
          </html>
