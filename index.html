GitHub Copilot Chat Assistant
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(720px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .smallInput { width:76px; }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <label>Type:
          <select id="txnType">
            <option value="Income">Income (Sales)</option>
            <option value="COGS">COGS</option>
            <option value="Expense">Expense (Purchase)</option>
            <option value="Deduction">Deduction</option>
          </select>
        </label>
        <label>Category:
          <select id="txnCategory">
            <option>Pension</option>
            <option>NHF</option>
            <option>Insurance</option>
            <option>Salary</option>
            <option>Bonus</option>
            <option>Freelance</option>
            <option>Food</option>
            <option>Transport</option>
            <option>Rent</option>
            <option>Utilities</option>
            <option>Other</option>
          </select>
        </label>
        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="txnDep" /> Depreciable
        </label>
        <label id="txnUsefulLifeLabel" style="display:none;">Useful life (yrs): <input type="number" id="txnUsefulLife" class="smallInput" min="1" step="1" /></label>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved per selected user and business. VAT rate & tax rules are per business (editable in Business settings). Mark 'Depreciable' for capital allowance (straight-line).</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/type/category/description/amount" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf; border-radius:4px;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount (₦)</th>
            <th>VAT (₦)</th>
            <th>WHT (₦)</th>
            <th>Cap. Allow (yr)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="userNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
    </div>
    <div class="row">
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" class="smallInput" /></label>
      <label>WHT rate (%): <input type="number" id="bizWht" min="0" step="0.01" class="smallInput" /></label>
      <label>CIT rate (%): <input type="number" id="bizCit" min="0" step="0.01" class="smallInput" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Default useful life (yrs): <input type="number" id="bizUsefulLife" id="bizUsefulLife" min="1" step="1" class="smallInput" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (tax)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE on salaries</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
    <small class="note">VAT, PIT and PAYE toggles control whether the corresponding computations are shown for this business. WHT/CIT rates and useful life are defaults but can be overridden per transaction.</small>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>
    <label>Type:
      <select id="editTxnType">
        <option value="Income">Income (Sales)</option>
        <option value="COGS">COGS</option>
        <option value="Expense">Expense (Purchase)</option>
        <option value="Deduction">Deduction</option>
      </select>
    </label><br/>
    <label>Category:
      <select id="editTxnCategory">
        <option>Pension</option>
        <option>NHF</option>
        <option>Insurance</option>
        <option>Salary</option>
        <option>Bonus</option>
        <option>Freelance</option>
        <option>Food</option>
        <option>Transport</option>
        <option>Rent</option>
        <option>Utilities</option>
        <option>Other</option>
      </select>
    </label><br/>
    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="editTxnWht" /> WHT applied</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="editTxnDep" /> Depreciable</label>
      <label id="editTxnUsefulLabel" style="display:none;">Useful life (yrs): <input type="number" id="editTxnUseful" class="smallInput" min="1" step="1" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button onclick="closeEditModal()">Cancel</button>
      <button class="primary" onclick="saveEdit()">Save</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant
    // Data model in localStorage key 'ntc_data_v1'
    const STORAGE_KEY = 'ntc_data_v1';

    // Default PIT slices (as previously used)
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },  // slice from threshold up to 3,000,000
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    // sensible defaults for new business tax fields
    const DEFAULT_BUSINESS_TAX = {
      whtRate: 5.0,               // %
      citRate: 30.0,              // %
      defaultUsefulLifeYears: 5,  // years for straight-line
      payeEnabled: true
    };

    // In-memory state
    let data = {
      users: [],
      businesses: [],
      transactions: {} // { userId: { businessId: [ txns ] } }
    };

    let selectedUserId = null;
    let selectedBusinessId = null;

    // Transaction edit state
    let editIndex = null;

    // Ledger UI state
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';
    let ledgerFiltered = []; // filtered txns used for pagination and summaries

    // Utilities
    function uid(prefix='id') { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function ensureBizDefaults(biz) {
      if (!biz) return;
      if (typeof biz.whtRate === 'undefined') biz.whtRate = DEFAULT_BUSINESS_TAX.whtRate;
      if (typeof biz.citRate === 'undefined') biz.citRate = DEFAULT_BUSINESS_TAX.citRate;
      if (typeof biz.defaultUsefulLifeYears === 'undefined') biz.defaultUsefulLifeYears = DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      if (typeof biz.payeEnabled === 'undefined') biz.payeEnabled = DEFAULT_BUSINESS_TAX.payeEnabled;
      if (typeof biz.vatEnabled === 'undefined') biz.vatEnabled = true;
      if (typeof biz.pitEnabled === 'undefined') biz.pitEnabled = true;
      if (typeof biz.threshold === 'undefined') biz.threshold = DEFAULT_PIT.threshold;
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') {
            data = parsed;
            if (!data.users) data.users = [];
            if (!data.businesses) data.businesses = [];
            if (!data.transactions) data.transactions = {};
            // ensure defaults on businesses
            data.businesses.forEach(b => ensureBizDefaults(b));
            return;
          }
        } catch(e) {
          console.error('Invalid saved data', e);
        }
      }
      // initialize with a demo user and business if empty
      const userId = uid('user');
      const bizId = uid('biz');
      data = {
        users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{
          id: bizId,
          name: 'Demo Business',
          ownerId: userId,
          vatRate: 7.5,
          whtRate: DEFAULT_BUSINESS_TAX.whtRate,
          citRate: DEFAULT_BUSINESS_TAX.citRate,
          defaultUsefulLifeYears: DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears,
          currency: '₦',
          threshold: DEFAULT_PIT.threshold,
          notes: 'Sample business',
          vatEnabled: true,
          pitEnabled: true,
          payeEnabled: true
        }],
        transactions: { [userId]: { [bizId]: [
          { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Income', category: 'Freelance', desc: 'Demo sale', amount: 1500000, whtApplied: false, depreciable: false },
          { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Expense', category: 'Rent', desc: 'Office rent', amount: 200000, whtApplied: false, depreciable: false }
        ] } }
      };
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }

    // UI wiring
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    // User modal elements
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userNotes = document.getElementById('userNotes');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    // Business modal elements
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwner = document.getElementById('bizOwner');
    const bizVat = document.getElementById('bizVat');
    const bizWht = document.getElementById('bizWht');
    const bizCit = document.getElementById('bizCit');
    const bizCurrency = document.getElementById('bizCurrency');
    const bizThreshold = document.getElementById('bizThreshold');
    const bizNotes = document.getElementById('bizNotes');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizPayeEnabled = document.getElementById('bizPayeEnabled');
    const bizUsefulLife = document.getElementById('bizUsefulLife');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');

    // Edit transaction modal
    const editModal = document.getElementById('editModal');
    const editTxnDate = document.getElementById('editTxnDate');
    const editTxnType = document.getElementById('editTxnType');
    const editTxnCategory = document.getElementById('editTxnCategory');
    const editTxnDesc = document.getElementById('editTxnDesc');
    const editTxnAmount = document.getElementById('editTxnAmount');
    const editTxnWht = document.getElementById('editTxnWht');
    const editTxnDep = document.getElementById('editTxnDep');
    const editTxnUseful = document.getElementById('editTxnUseful');
    const editTxnUsefulLabel = document.getElementById('editTxnUsefulLabel');

    // Add txn fields
    const txnWht = document.getElementById('txnWht');
    const txnDep = document.getElementById('txnDep');
    const txnUsefulLife = document.getElementById('txnUsefulLife');
    const txnUsefulLifeLabel = document.getElementById('txnUsefulLifeLabel');

    // Search & pagination UI
    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    // Export/Import UI
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // State for modals: editing vs adding
    let userEditingId = null;
    let bizEditingId = null;

    // Initialization
    loadData();
    refreshUserBusinessSelectors();
    ensureSelection();
    currentPage = 1;
    renderLedger();
    calculateSummary();

    // --- User & Business management functions ---
    function refreshUserBusinessSelectors() {
      // Users
      userSelect.innerHTML = '';
      data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = (u.display || u.username) + ' (' + u.username + ')';
        userSelect.appendChild(opt);
      });
      // Businesses
      businessSelect.innerHTML = '';
      data.businesses.forEach(b => {
        const owner = findUser(b.ownerId);
        const enabledParts = [];
        if (b.vatEnabled) enabledParts.push('VAT');
        if (b.pitEnabled) enabledParts.push('PIT');
        if (b.payeEnabled) enabledParts.push('PAYE');
        const status = enabledParts.length ? ' — ' + enabledParts.join('/') : '';
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name} ${owner ? ' — ' + (owner.display || owner.username) : ''} (${(typeof b.vatRate === 'number' ? b.vatRate : 0)}% VAT, ${ (typeof b.citRate === 'number' ? b.citRate : DEFAULT_BUSINESS_TAX.citRate)}% CIT)${status}`;
        businessSelect.appendChild(opt);
      });
      // populate bizOwner select for business modal
      bizOwner.innerHTML = '';
      data.users.forEach(u => {
        const o = document.createElement('option');
        o.value = u.id;
        o.textContent = (u.display || u.username);
        bizOwner.appendChild(o);
      });

      // set selected values if still available, else pick first
      if (!data.users.find(u=>u.id===selectedUserId)) selectedUserId = data.users.length ? data.users[0].id : null;
      if (!data.businesses.find(b=>b.id===selectedBusinessId)) selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;

      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function ensureSelection() {
      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length) selectedBusinessId = data.businesses[0].id;
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function openModal(modal) {
      modalOverlay.style.display = 'block';
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal) {
      modalOverlay.style.display = 'none';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      // clear editing state
      userEditingId = null;
      bizEditingId = null;
    }

    // --- Users ---
    btnAddUser.addEventListener('click', () => {
      userModalTitle.textContent = 'Add User';
      userName.value = '';
      userDisplay.value = '';
      userNotes.value = '';
      userEditingId = null;
      openModal(userModal);
    });

    btnEditUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      userModalTitle.textContent = 'Edit User';
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userNotes.value = u.notes || '';
      userEditingId = u.id;
      openModal(userModal);
    });

    btnDeleteUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      if (!confirm(`Delete user "${u.display || u.username}" and all their businesses & transactions? This action cannot be undone.`)) return;
      // Delete user's businesses and transactions
      data.businesses = data.businesses.filter(b => b.ownerId !== u.id);
      delete data.transactions[u.id];
      data.users = data.users.filter(x => x.id !== u.id);
      if (!data.users.length) {
        // clear everything
        data = { users: [], businesses: [], transactions: {} };
      }
      saveData();
      selectedUserId = data.users.length ? data.users[0].id : null;
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
    });

    userSave.addEventListener('click', () => {
      const username = (userName.value || '').trim();
      if (!username) { alert('Username required'); return; }
      if (userEditingId) {
        const u = findUser(userEditingId);
        if (!u) return;
        u.username = username;
        u.display = (userDisplay.value||'').trim();
        u.notes = (userNotes.value||'').trim();
      } else {
        // ensure unique username
        const exists = data.users.find(x => x.username === username);
        if (exists) { if (!confirm('Username already exists. Add anyway?')) return; }
        const id = uid('user');
        data.users.push({ id, username, display: (userDisplay.value||'').trim(), notes: (userNotes.value||'').trim() });
      }
      saveData();
      closeModal(userModal);
      refreshUserBusinessSelectors();
      ensureSelection();
    });

    userCancel.addEventListener('click', () => closeModal(userModal));

    userSelect.addEventListener('change', (e) => {
      selectedUserId = e.target.value;
      // auto-select first business owned by user if possible
      const owned = data.businesses.find(b => b.ownerId === selectedUserId);
      if (owned) selectedBusinessId = owned.id;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // --- Businesses ---
    btnAddBusiness.addEventListener('click', () => {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = '';
      bizVat.value = 7.5;
      bizWht.value = DEFAULT_BUSINESS_TAX.whtRate;
      bizCit.value = DEFAULT_BUSINESS_TAX.citRate;
      bizCurrency.value = '₦';
      bizThreshold.value = DEFAULT_PIT.threshold;
      bizUsefulLife.value = DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      bizNotes.value = '';
      bizOwner.value = selectedUserId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = true;
      bizPitEnabled.checked = true;
      bizPayeEnabled.checked = true;
      bizEditingId = null;
      openModal(businessModal);
    });

    btnEditBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizVat.value = (typeof b.vatRate === 'number') ? b.vatRate : 7.5;
      bizWht.value = (typeof b.whtRate === 'number') ? b.whtRate : DEFAULT_BUSINESS_TAX.whtRate;
      bizCit.value = (typeof b.citRate === 'number') ? b.citRate : DEFAULT_BUSINESS_TAX.citRate;
      bizCurrency.value = b.currency || '₦';
      bizThreshold.value = (typeof b.threshold === 'number') ? b.threshold : DEFAULT_PIT.threshold;
      bizUsefulLife.value = (typeof b.defaultUsefulLifeYears === 'number') ? b.defaultUsefulLifeYears : DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      bizNotes.value = b.notes || '';
      bizOwner.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = !!b.vatEnabled;
      bizPitEnabled.checked = (typeof b.pitEnabled === 'undefined') ? true : !!b.pitEnabled;
      bizPayeEnabled.checked = (typeof b.payeEnabled === 'undefined') ? true : !!b.payeEnabled;
      bizEditingId = b.id;
      openModal(businessModal);
    });

    btnDeleteBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm(`Delete business "${b.name}" and all its transactions for all users? This action cannot be undone.`)) return;
      // remove business from businesses
      data.businesses = data.businesses.filter(x => x.id !== b.id);
      // remove transactions for this business across all users
      for (const uid of Object.keys(data.transactions)) {
        if (data.transactions[uid] && data.transactions[uid][b.id]) delete data.transactions[uid][b.id];
      }
      saveData();
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizSave.addEventListener('click', () => {
      const name = (bizName.value || '').trim();
      const ownerIdVal = bizOwner.value;
      const vat = parseFloat(bizVat.value);
      const wht = parseFloat(bizWht.value);
      const cit = parseFloat(bizCit.value);
      const currency = (bizCurrency.value || '₦').trim();
      const threshold = Number(bizThreshold.value) || DEFAULT_PIT.threshold;
      const usableLife = parseInt(bizUsefulLife.value) || DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      const vatEnabledVal = !!bizVatEnabled.checked;
      const pitEnabledVal = !!bizPitEnabled.checked;
      const payeEnabledVal = !!bizPayeEnabled.checked;
      if (!name) { alert('Business name required'); return; }
      if (!ownerIdVal) { alert('Select owner'); return; }
      if (bizEditingId) {
        const b = findBiz(bizEditingId);
        if (!b) return;
        b.name = name;
        b.ownerId = ownerIdVal;
        b.vatRate = isNaN(vat) ? 7.5 : vat;
        b.whtRate = isNaN(wht) ? DEFAULT_BUSINESS_TAX.whtRate : wht;
        b.citRate = isNaN(cit) ? DEFAULT_BUSINESS_TAX.citRate : cit;
        b.currency = currency;
        b.threshold = threshold;
        b.defaultUsefulLifeYears = usableLife;
        b.notes = (bizNotes.value || '').trim();
        b.vatEnabled = vatEnabledVal;
        b.pitEnabled = pitEnabledVal;
        b.payeEnabled = payeEnabledVal;
      } else {
        const id = uid('biz');
        data.businesses.push({
          id, name, ownerId: ownerIdVal,
          vatRate: isNaN(vat) ? 7.5 : vat,
          whtRate: isNaN(wht) ? DEFAULT_BUSINESS_TAX.whtRate : wht,
          citRate: isNaN(cit) ? DEFAULT_BUSINESS_TAX.citRate : cit,
          currency,
          threshold,
          defaultUsefulLifeYears: usableLife,
          notes: (bizNotes.value || '').trim(),
          vatEnabled: vatEnabledVal,
          pitEnabled: pitEnabledVal,
          payeEnabled: payeEnabledVal
        });
      }
      saveData();
      closeModal(businessModal);
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizCancel.addEventListener('click', () => closeModal(businessModal));

    businessSelect.addEventListener('change', (e) => {
      selectedBusinessId = e.target.value;
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // --- Transactions ---
    txnDep.addEventListener('change', () => {
      txnUsefulLifeLabel.style.display = txnDep.checked ? '' : 'none';
      if (!txnDep.checked) txnUsefulLife.value = '';
    });

    editTxnDep.addEventListener('change', () => {
      editTxnUsefulLabel.style.display = editTxnDep.checked ? '' : 'none';
      if (!editTxnDep.checked) editTxnUseful.value = '';
    });

    btnAddTxn.addEventListener('click', () => {
      const date = document.getElementById('txnDate').value;
      const type = document.getElementById('txnType').value;
      const category = document.getElementById('txnCategory').value;
      const desc = document.getElementById('txnDesc').value.trim();
      const amount = parseFloat(document.getElementById('txnAmount').value) || 0;
      const whtAppliedVal = !!txnWht.checked;
      const depreciableVal = !!txnDep.checked;
      const usefulLifeVal = depreciableVal ? (parseInt(txnUsefulLife.value) || null) : null;

      if (!selectedUserId || !selectedBusinessId) {
        alert('Select user and business before adding a transaction.');
        return;
      }
      if (!date || !desc || amount <= 0) {
        alert('Please fill all fields and enter a valid amount.');
        return;
      }
      const txn = { id: uid('txn'), date, type, category, desc, amount, whtApplied: whtAppliedVal, depreciable: depreciableVal };
      if (usefulLifeVal && usefulLifeVal > 0) txn.usefulLifeYears = usefulLifeVal;
      if (!data.transactions[selectedUserId]) data.transactions[selectedUserId] = {};
      if (!data.transactions[selectedUserId][selectedBusinessId]) data.transactions[selectedUserId][selectedBusinessId] = [];
      data.transactions[selectedUserId][selectedBusinessId].push(txn);
      saveData();
      clearForm();
      currentPage = Math.ceil(((ledgerFiltered.length || 0) + 1) / PAGE_SIZE); // jump to last page after adding (approx)
      renderLedger();
      calculateSummary();
    });

    function clearForm() {
      document.getElementById('txnDate').value = "";
      document.getElementById('txnDesc').value = "";
      document.getElementById('txnAmount').value = "";
      document.getElementById('txnType').value = "Income";
      document.getElementById('txnCategory').value = "Salary";
      txnWht.checked = false;
      txnDep.checked = false;
      txnUsefulLife.value = '';
      txnUsefulLifeLabel.style.display = 'none';
    }

    function renderLedger() {
      ledgerTbody.innerHTML = '';
      if (!selectedUserId || !selectedBusinessId) {
        ledgerFiltered = [];
        updatePaginationControls();
        return;
      }
      const allTxns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      // apply search filter (case-insensitive)
      const q = (ledgerFilterText || '').trim().toLowerCase();
      ledgerFiltered = allTxns.filter(txn => {
        if (!q) return true;
        const parts = [
          txn.date || '',
          txn.type || '',
          txn.category || '',
          txn.desc || '',
          String(txn.amount || '')
        ];
        return parts.join(' ').toLowerCase().includes(q);
      });

      const biz = findBiz(selectedBusinessId);
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const whtRate = (biz && typeof biz.whtRate === 'number') ? (biz.whtRate/100) : (DEFAULT_BUSINESS_TAX.whtRate/100);
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageSlice = ledgerFiltered.slice(start, start + PAGE_SIZE);

      pageSlice.forEach((txn, idx) => {
        let vat = 0;
        if (biz && biz.vatEnabled && (txn.type === 'Income' || txn.type === 'Expense')) vat = txn.amount * vatRate;
        let wht = 0;
        if (biz && txn.whtApplied) wht = txn.amount * whtRate;
        let capAllow = '';
        if (txn.depreciable) {
          const useful = txn.usefulLifeYears || (biz && biz.defaultUsefulLifeYears) || DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
          const annualDep = (useful && useful > 0) ? (txn.amount / useful) : 0;
          capAllow = (biz && biz.currency ? biz.currency : '₦') + formatNumber(annualDep);
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${txn.date}</td>
          <td>${txn.type}</td>
          <td>${txn.category}${txn.depreciable ? ' <span class="flag">depr</span>' : ''}</td>
          <td>${escapeHtml(txn.desc)}</td>
          <td>${biz && biz.currency ? biz.currency : '₦'}${formatNumber(txn.amount)}</td>
          <td>${(vat && biz && biz.vatEnabled) ? (biz.currency || '₦') + formatNumber(vat) : ''}</td>
          <td>${(wht && biz) ? (biz.currency || '₦') + formatNumber(wht) : ''}</td>
          <td>${capAllow}</td>
          <td>
            <div class="actions">
              <button class="small" onclick="openEditModal('${txn.id}')">Edit</button>
              <button class="small danger" onclick="removeTransaction('${txn.id}')">Delete</button>
            </div>
          </td>`;
        ledgerTbody.appendChild(tr);
      });

      updatePaginationControls();
    }

    function updatePaginationControls() {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
      btnPrevPage.disabled = currentPage <= 1;
      btnNextPage.disabled = currentPage >= totalPages;
    }

    btnPrevPage.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderLedger();
      }
    });
    btnNextPage.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage < totalPages) {
        currentPage++;
        renderLedger();
      }
    });

    btnSearch.addEventListener('click', () => {
      ledgerFilterText = ledgerSearch.value || '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    btnClearSearch.addEventListener('click', () => {
      ledgerSearch.value = '';
      ledgerFilterText = '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // Expose functions needed by inline onclick attributes
    window.openEditModal = function(txnId) {
      if (!selectedUserId || !selectedBusinessId) return;
      const txns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      const idx = txns.findIndex(t => t.id === txnId);
      if (idx === -1) return;
      editIndex = idx;
      const t = txns[idx];
      editTxnDate.value = t.date;
      editTxnType.value = t.type;
      editTxnCategory.value = t.category;
      editTxnDesc.value = t.desc;
      editTxnAmount.value = t.amount;
      editTxnWht.checked = !!t.whtApplied;
      editTxnDep.checked = !!t.depreciable;
      if (t.depreciable) {
        editTxnUsefulLabel.style.display = '';
        editTxnUseful.value = t.usefulLifeYears || '';
      } else {
        editTxnUsefulLabel.style.display = 'none';
        editTxnUseful.value = '';
      }
      openModal(editModal);
    };

    window.removeTransaction = function(txnId) {
      if (!selectedUserId || !selectedBusinessId) return;
      if (!confirm('Delete this transaction?')) return;
      const txns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      const idx = txns.findIndex(t=>t.id===txnId);
      if (idx === -1) return;
      txns.splice(idx,1);
      saveData();
      // keep page sane
      const totalPages = Math.max(1, Math.ceil(((ledgerFiltered.length - 1) || 0) / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      renderLedger();
      calculateSummary();
    };

    function closeEditModal() {
      closeModal(editModal);
      editIndex = null;
    }
    window.closeEditModal = closeEditModal;

    function saveEdit() {
      if (editIndex === null) return;
      const date = editTxnDate.value;
      const type = editTxnType.value;
      const category = editTxnCategory.value;
      const desc = editTxnDesc.value.trim();
      const amount = parseFloat(editTxnAmount.value) || 0;
      const whtAppliedVal = !!editTxnWht.checked;
      const depreciableVal = !!editTxnDep.checked;
      const usefulLifeVal = depreciableVal ? (parseInt(editTxnUseful.value) || null) : null;
      if (!date || !desc || amount <= 0) { alert('Fill fields and enter valid amount'); return; }
      const txns = data.transactions[selectedUserId][selectedBusinessId];
      if (!txns || !txns[editIndex]) return;
      const existing = txns[editIndex];
      txns[editIndex] = { ...existing, date, type, category, desc, amount, whtApplied: whtAppliedVal, depreciable: depreciableVal };
      if (usefulLifeVal && usefulLifeVal > 0) txns[editIndex].usefulLifeYears = usefulLifeVal;
      else delete txns[editIndex].usefulLifeYears;
      saveData();
      closeEditModal();
      renderLedger();
      calculateSummary();
    }
    window.saveEdit = saveEdit;

    // --- Summaries and tax calculations ---
    function calculateSummary() {
      const biz = findBiz(selectedBusinessId);
      const currency = (biz && biz.currency) ? biz.currency : '₦';
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const threshold = (biz && typeof biz.threshold === 'number') ? biz.threshold : DEFAULT_PIT.threshold;

      // Determine if PIT is enabled (default true if undefined)
      const pitEnabled = biz ? (typeof biz.pitEnabled === 'undefined' ? true : !!biz.pitEnabled) : false;
      const vatEnabled = biz ? !!biz.vatEnabled : false;
      const payeEnabled = biz ? (!!biz.payeEnabled) : false;
      const whtRate = (biz && typeof biz.whtRate === 'number') ? (biz.whtRate/100) : (DEFAULT_BUSINESS_TAX.whtRate/100);
      const citRate = (biz && typeof biz.citRate === 'number') ? (biz.citRate/100) : (DEFAULT_BUSINESS_TAX.citRate/100);

      // Use ledgerFiltered so summaries match the filtered view
      const txns = ledgerFiltered || [];

      let incomeTotal = 0, expenseTotal = 0, deductionTotal = 0, cogsTotal = 0, rentTotal = 0;
      let vatOutputTotal = 0, vatInputTotal = 0;
      let whtWithheldTotal = 0;
      let payeTotal = 0;
      let capitalAllowances = 0;

      txns.forEach(txn => {
        if (txn.type === 'Income') {
          incomeTotal += txn.amount;
          if (vatEnabled) vatOutputTotal += txn.amount * vatRate;
        } else if (txn.type === 'Expense') {
          expenseTotal += txn.amount;
          if (vatEnabled) vatInputTotal += txn.amount * vatRate;
          if (txn.category && txn.category.toLowerCase() === 'rent') rentTotal += txn.amount;
        } else if (txn.type === 'Deduction') {
          deductionTotal += txn.amount;
        } else if (txn.type === 'COGS') {
          cogsTotal += txn.amount;
        }

        // WHT
        if (txn.whtApplied) {
          whtWithheldTotal += txn.amount * whtRate;
        }

        // Capital allowance (straight-line annual depreciation)
        if (txn.depreciable) {
          const useful = txn.usefulLifeYears || (biz && biz.defaultUsefulLifeYears) || DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
          const annualDep = (useful && useful > 0) ? (txn.amount / useful) : 0;
          capitalAllowances += annualDep;
        }
      });

      // PAYE calculation: if PAYE enabled, aggregate Salary expense transactions
      if (payeEnabled && pitEnabled) {
        const salaryTotal = txns
          .filter(t => t.type === 'Expense' && t.category && t.category.toLowerCase() === 'salary')
          .reduce((s,t) => s + (t.amount || 0), 0);
        // computeTax expects an "adjIncome" and uses biz.pit settings. For PAYE we want tax on salaryTotal.
        payeTotal = computeTax(salaryTotal, biz);
      } else {
        payeTotal = 0;
      }

      let netBalance = incomeTotal - expenseTotal - cogsTotal;
      let vatPayable = (vatOutputTotal - vatInputTotal);

      // rent relief: 20% of rent up to 500,000
      let rentRelief = rentTotal * 0.20;
      if (rentRelief > 500000) rentRelief = 500000;

      // taxable income after deductions and relief and capital allowances and PAYE
      let taxableIncomeBeforeThreshold = incomeTotal - cogsTotal - expenseTotal - capitalAllowances - payeTotal - deductionTotal;
      // We will calculate CIT based on taxableIncomeBeforeThreshold (no threshold applied except as per business rules)
      let taxableProfit = taxableIncomeBeforeThreshold;
      if (taxableProfit < 0) taxableProfit = 0;

      // CIT calculation
      let citPayable = 0;
      if (typeof citRate === 'number' && citRate > 0) {
        citPayable = taxableProfit * citRate;
      } else {
        citPayable = 0;
      }

      // For PIT display (personal income tax) we can compute tax on adjIncome = incomeTotal - deductionTotal - rentRelief
      let adjIncome = incomeTotal - deductionTotal - rentRelief;
      if (adjIncome < 0) adjIncome = 0;
      let pitTax = 0;
      if (pitEnabled) {
        pitTax = computeTax(adjIncome, biz);
      } else {
        pitTax = 0;
      }

      let effRate = incomeTotal > 0 ? ( (pitTax + citPayable + whtWithheldTotal + payeTotal) / incomeTotal ) * 100 : 0;

      // VAT summary: show only when VAT enabled for the business
      if (vatEnabled) {
        vatSummaryDiv.style.display = '';
        vatSummaryDiv.innerHTML =
          `<strong>VAT Summary (${(vatRate*100).toFixed(2)}%):</strong><br>
           VAT Output (Sales): ${currency}${formatNumber(vatOutputTotal)}<br>
           VAT Input (Purchases): ${currency}${formatNumber(vatInputTotal)}<br>
           <strong>VAT Payable:</strong> ${currency}${formatNumber(vatPayable)}`;
      } else {
        vatSummaryDiv.style.display = 'none';
        vatSummaryDiv.innerHTML = '';
      }

      totalsSummaryDiv.style.display = ''; // totals always shown
      totalsSummaryDiv.innerHTML =
        `<strong>Income:</strong> ${currency}${formatNumber(incomeTotal)}  | 
         <strong>COGS:</strong> ${currency}${formatNumber(cogsTotal)}  |
         <strong>Expenses:</strong> ${currency}${formatNumber(expenseTotal)}  | 
         <strong>Deductions:</strong> ${currency}${formatNumber(deductionTotal)}  | 
         <strong>Net Balance:</strong> ${currency}${formatNumber(netBalance)}`;

      // Tax summary: combine items (PIT, PAYE, WHT, Capital allowances, CIT)
      taxSummaryDiv.style.display = '';
      taxSummaryDiv.innerHTML =
        `<strong>Tax Summary:</strong><br>
         <strong>PIT (on adjusted income):</strong> ${currency}${formatNumber(pitTax)}<br>
         Tax-free threshold: ${currency}${formatNumber(threshold)}<br>
         Rent relief applied: ${currency}${formatNumber(rentRelief)}<br>
         Taxable income for PIT: ${currency}${formatNumber(adjIncome)}<br>
         <hr style="border:none;border-top:1px solid #eee;margin:6px 0;">
         <strong>PAYE (on salaries):</strong> ${currency}${formatNumber(payeTotal)} ${payeEnabled ? '' : '<span class="muted">(PAYE disabled)</span>'}<br>
         <strong>WHT Withheld (credit):</strong> ${currency}${formatNumber(whtWithheldTotal)}<br>
         <strong>Capital allowances (annual):</strong> ${currency}${formatNumber(capitalAllowances)}<br>
         <strong>Taxable profit for CIT (Income - COGS - Expenses - Capital allowances - PAYE - Deductions):</strong> ${currency}${formatNumber(taxableProfit)}<br>
         <strong>CIT Rate:</strong> ${(citRate*100).toFixed(2)}%  | <strong>CIT Payable:</strong> ${currency}${formatNumber(citPayable)}<br>
         <strong>Effective tax burden (PIT + PAYE + CIT + WHT):</strong> ${currency}${formatNumber(pitTax + payeTotal + citPayable + whtWithheldTotal)}<br>
         Effective tax rate on gross income: ${effRate.toFixed(2)}%`;

    }

    function computeTax(adjIncome, biz) {
      // biz may include custom PIT slices in biz.pit (not exposed in UI now).
      // If PIT disabled on business, return 0
      if (biz && typeof biz.pitEnabled !== 'undefined' && !biz.pitEnabled) return 0;
      const pit = (biz && biz.pit && Array.isArray(biz.pit.slices)) ? biz.pit : DEFAULT_PIT;
      // If adjIncome <= threshold => 0
      let tax = 0;
      if (adjIncome > (pit.threshold || DEFAULT_PIT.threshold)) {
        let taxable = adjIncome;
        let remaining = taxable - (pit.threshold || DEFAULT_PIT.threshold);
        // iterate slices
        let prevUpper = (pit.threshold || DEFAULT_PIT.threshold);
        for (let s of pit.slices) {
          const upper = s.upTo;
          let sliceLimit = (upper === Infinity) ? Infinity : (upper - prevUpper);
          if (remaining <= 0) break;
          const slice = Math.min(remaining, sliceLimit);
          tax += slice * s.rate;
          remaining -= slice;
          prevUpper = upper;
        }
      }
      return Math.max(0, Math.round(tax)); // tax in whole Naira
    }

    // --- Export / Import / Clear ---
    btnExport.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const now = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `ntc_data_export_${now}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imported = JSON.parse(ev.target.result);
          if (!imported.users || !imported.businesses) throw new Error('Invalid format: missing users/businesses');
          if (!confirm('Import will replace current data. Continue?')) return;
          data = imported;
          if (!data.transactions) data.transactions = {};
          // Ensure business defaults for compatibility
          data.businesses.forEach(b => ensureBizDefaults(b));
          saveData();
          refreshUserBusinessSelectors();
          ensureSelection();
          currentPage = 1;
          renderLedger();
          calculateSummary();
          alert('Import successful');
        } catch (err) {
          alert('Failed to import JSON: ' + err.message);
        }
      };
      reader.readAsText(f);
      // reset file input
      fileInput.value = '';
    });

    btnClearAll.addEventListener('click', () => {
      if (!confirm('Clear ALL saved data (users, businesses, transactions)? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      loadData();
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      alert('All data cleared and reset to demo.');
    });

    // --- Helpers ---
    function formatNumber(n, fractionDigits=2) {
      if (typeof n !== 'number') n = Number(n) || 0;
      return n.toLocaleString(undefined, { maximumFractionDigits: fractionDigits, minimumFractionDigits: fractionDigits });
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // close modal when overlay clicked
    modalOverlay.addEventListener('click', () => {
      // close any open modal
      closeModal(userModal);
      closeModal(businessModal);
      closeModal(editModal);
    });

    // Keyboard: Esc closes modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal(userModal);
        closeModal(businessModal);
        closeModal(editModal);
      }
    });

    // Expose helper for debug (optional)
    window._ntc = { data, saveData, loadData, refreshUserBusinessSelectors, renderLedger, calculateSummary };

    // Initial focus improvements
    setTimeout(()=>{ if (userSelect.options.length) userSelect.focus(); }, 300);
  </script>

  <footer>
    <div class="muted">Notes: Data is stored locally in your browser (localStorage). For production or multi-device sharing, use a server-backed solution. This tool keeps VAT, WHT, PAYE and CIT per business and calculates straight-line capital allowances per depreciable transaction (annual depreciation). Rates and defaults are editable per business in Business settings.</div>
  </footer>
</body>
</html>
