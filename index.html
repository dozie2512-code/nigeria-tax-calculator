 <!-- Generated by GitHub Copilot Chat Assistant -->
 <!DOCTYPE html>
 <html lang="en">
 <head>
   <meta charset="utf-8" />
   <title>Nigeria Simple Accounting & Tax Software with VAT & WHT & PAYE (Multi-user / Multi-business)</title>
   <meta name="viewport" content="width=device-width,initial-scale=1" />
   <style>
     :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
     body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
     header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
     h1 { margin:0 8px 0 0; font-size:1.1rem; }
     .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
     .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
     label { font-size:0.9rem; color:var(--muted); }
     select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
     button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
     button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
     button.small { padding:5px 8px; font-size:0.9rem; }
     .section { margin-top:14px; }
     .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
     .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
     .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
     .ledger-table th { background:#f2f6fa; }
     .totals, .tax-summary, .vat-summary, .wht-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
     .muted { color:var(--muted); font-size:0.9rem; }
     .actions { display:flex; gap:6px; }
     .danger { color:var(--danger); border-color:var(--danger); }
     .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
     .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(720px,96vw); max-height:80vh; overflow:auto; }
     .modal h3 { margin-top:0; }
     .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
     .spacer { flex:1 1 auto; }
     small.note { color:var(--muted); display:block; margin-top:6px; }
     footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
     .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
     .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
     @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} .inline-grid{grid-template-columns:1fr} .tax-results{display:flex;flex-direction:column} }
     pre.small { font-size:0.85rem; white-space:pre-wrap; }
     .nowrap { white-space:nowrap; }
     table.paye-table { width:100%; border-collapse:collapse; margin-top:8px; }
     table.paye-table th, table.paye-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; background:#fff; }
     table.paye-table th { background:#f5f8fb; }
     .muted-inline { color:var(--muted); font-size:0.9rem; margin-left:8px; }
     .inline-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:start; }
     .field { display:flex; flex-direction:column; gap:4px; }
     .result-box { background:#fff; padding:10px; border:1px solid #eef2f6; border-radius:6px; margin-top:8px; }
     .result-row { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:4px 0; }
   </style>
 </head>
 <body>
   <header>
     <h1>Nigeria Accounting & Tax (VAT, WHT, PAYE & PIT) — Multi-user / Multi-business</h1>
     <div class="controls panel">
       <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
         <label for="userSelect">User:</label>
         <select id="userSelect"></select>
         <button class="small" id="btnAddUser">+ User</button>
         <button class="small" id="btnEditUser">Edit</button>
       </div>
       <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
       <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
         <label for="businessSelect">Business:</label>
         <select id="businessSelect"></select>
         <button class="small" id="btnAddBusiness">+ Business</button>
         <button class="small" id="btnEditBusiness">Edit</button>
       </div>
     </div>
     <div class="spacer"></div>
     <div style="display:flex;gap:8px;align-items:center;">
       <button id="btnExport" class="small">Export JSON</button>
       <button id="btnImport" class="small">Import JSON</button>
       <button id="btnClearAll" class="small danger">Clear All Data</button>
       <input type="file" id="fileInput" accept="application/json" style="display:none" />
     </div>
   </header>
 
   <main>
     <section class="panel section">
       <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
       <div class="form-inline">
         <label>Date: <input type="date" id="txnDate" /></label>
 
         <label>Account:
           <select id="txnAccount"></select>
         </label>
         <button class="small" id="btnAddAccountInline">+ Account</button>
 
         <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
         <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
 
         <label id="whtInlineLabel" style="display:none;">
           <input type="checkbox" id="txnWhtEnabled" /> Withhold WHT
         </label>
         <label id="whtRateInlineLabel" style="display:none;">
           WHT rate (%): <input type="number" id="txnWhtRate" min="0" step="0.01" value="5" style="width:70px;" />
         </label>
         <label id="whtInclusiveLabel" style="display:none;">
           <input type="checkbox" id="txnWhtInclusive" /> Amount includes WHT
         </label>
 
         <label>Contact:
           <select id="txnContact"></select>
         </label>
         <button class="small" id="btnAddContactInline">+ Contact</button>
 
         <button class="primary" id="btnAddTxn">Add Transaction</button>
       </div>
       <small class="note">Transactions are saved at the business level. VAT is calculated for sales (Revenue) and for purchases only (not all expenses). WHT (Withholding Tax) applies for qualifying ex[...]</small>
     </section>
 
     <section class="panel section">
       <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>
 
       <div class="search-bar">
         <input type="text" id="ledgerSearch" placeholder="Search by date/description/amount/author/contact/account" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf;" />
         <button id="btnSearch" class="small">Search</button>
         <button id="btnClearSearch" class="small">Clear</button>
       </div>
 
       <table class="ledger-table" id="ledgerTable" aria-live="polite">
         <thead>
           <tr>
             <th>Date</th>
             <th>Description</th>
             <th>Account</th>
             <th>Amount (₦)</th>
             <th>VAT (₦)</th>
             <th>WHT (₦)</th>
             <th>Contact</th>
             <th>Author</th>
             <th>Action</th>
           </tr>
         </thead>
         <tbody></tbody>
       </table>
 
       <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
         <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
           <button id="btnPrevPage" class="small">Prev</button>
           <span id="pageIndicator">Page 1 / 1</span>
           <button id="btnNextPage" class="small">Next</button>
         </div>
       </div>
 
       <div class="vat-summary" id="vatSummary"></div>
       <div class="wht-summary" id="whtSummary"></div>
       <div class="paye-summary totals" id="payeSummary" style="margin-top:10px;"></div>
       <div class="pit-summary totals" id="pitSummary" style="margin-top:10px;"></div>
       <div class="totals" id="totalsSummary"></div>
       <div class="tax-summary" id="taxSummary"></div>
     </section>
 
     <section class="panel section" id="contactsAccountsPanel" style="display:flex;gap:12px;flex-wrap:wrap;">
       <div style="flex:1;min-width:280px;">
         <h3>Contacts</h3>
         <div class="form-inline" style="margin-bottom:8px;">
           <button class="small" id="btnOpenContacts">Manage Contacts</button>
         </div>
         <div id="contactsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
       </div>
       <div style="flex:1;min-width:280px;">
         <h3>Chart of Accounts</h3>
         <div class="form-inline" style="margin-bottom:8px;">
           <button class="small" id="btnOpenAccounts">Manage Accounts</button>
         </div>
         <div id="accountsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
       </div>
     </section>
 
     <!-- NEW: Taxable income from Net profit A -->
     <section class="panel section" id="taxableFromNetProfitPanel">
       <h2 style="margin:0 0 8px 0;">Taxable Income — From Net profit A</h2>
       <div class="inline-grid">
         <div>
           <div class="field">
             <label>Net profit A (₦): <input type="number" id="netProfitA" step="0.01" /></label>
             <small class="muted">Accounting net profit (profit after operating items)</small>
           </div>
           <div class="field">
             <label>Disallowable expenses to add back (₦): <input type="number" id="disallowable" step="0.01" /></label>
             <small class="muted">Non-deductible expenses for tax purposes</small>
           </div>
 
           <div class="field">
             <label>Non-taxable income (₦): <input type="number" id="nonTaxableIncome" step="0.01" /></label>
             <small class="muted">Tax-exempt income to remove</small>
           </div>
           <div class="field">
             <label>Capital allowances (₦): <input type="number" id="capitalAllowances" step="0.01" /></label>
             <small class="muted">Tax depreciation allowances</small>
           </div>
 
           <div class="field">
             <label>Prior unrelieved losses (₦): <input type="number" id="priorLosses" step="0.01" /></label>
             <small class="muted">Losses carried forward</small>
           </div>
           <div class="field">
             <label>Other adjustments (₦): <input type="number" id="otherAdjustments" step="0.01" /></label>
             <small class="muted">Any other tax adjustments (positive reduces tax base when negative increase)</small>
           </div>
 
           <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
             <button class="primary" id="btnComputeTaxable">Compute Taxable Income</button>
             <label style="margin-left:8px;"><input type="checkbox" id="saveTaxAdjToBusiness" /> Save adjustments to business</label>
             <button id="btnLoadFromBusiness" class="small">Load saved adjustments</button>
           </div>
         </div>
 
         <!-- Results area (to the right) -->
         <div class="tax-results" style="display:flex;flex-direction:column;gap:8px;">
           <div id="taxableResult" class="result-box" aria-live="polite" style="display:none;">
             <div class="result-row"><div><strong>Taxable income</strong></div><div>₦ <span id="taxableResultValue">0</span></div></div>
             <div id="taxableBreakdown" style="margin-top:6px;"></div>
           </div>
 
           <div id="pitResult" class="result-box" aria-live="polite" style="display:none;">
             <div style="display:flex;justify-content:space-between;align-items:center;">
               <div><strong>Estimated PIT (annual)</strong></div>
               <div style="text-align:right;">
                 <div>₦ <span id="pitAnnualValue">0</span></div>
                 <div class="muted" style="font-size:0.9rem;">Monthly: ₦ <span id="pitMonthlyValue">0</span></div>
               </div>
             </div>
             <div id="pitNotes" style="margin-top:8px;" class="muted"></div>
           </div>
         </div>
       </div>
 
       <small class="muted">Formula: Taxable income = Net profit A + Disallowable expenses - Non-taxable income - Capital allowances - Prior losses + Other adjustments</small>
     </section>
 
   </main>
 
   <!-- Modals (simplified for this file) -->
   <div id="modalOverlay" class="modalOverlay" aria-hidden="true"></div>
 
   <div id="userModal" class="modal" aria-hidden="true">
     <h3 id="userModalTitle">Add User</h3>
     <div class="row">
       <label>Username: <input type="text" id="userName" /></label>
       <label>Display name: <input type="text" id="userDisplay" /></label>
     </div>
     <div style="display:flex;gap:8px;justify-content:flex-end;">
       <button id="userCancel">Cancel</button>
       <button class="primary" id="userSave">Save</button>
     </div>
   </div>
 
   <div id="businessModal" class="modal" aria-hidden="true">
     <h3 id="businessModalTitle">Add Business</h3>
     <div class="row">
       <label>Business name: <input type="text" id="bizName" /></label>
       <label>Owner (user id): <select id="bizOwner"></select></label>
     </div>
     <div class="row">
       <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" value="7.5" /></label>
       <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
     </div>
     <div class="row">
       <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
       <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
     </div>
     <div class="row">
       <label><input type="checkbox" id="bizVatEnabled" checked /> Enable VAT</label>
       <label><input type="checkbox" id="bizPitEnabled" checked /> Enable PIT (tax)</label>
       <label><input type="checkbox" id="bizVatInclusive" /> VAT amounts are inclusive</label>
     </div>
     <div class="row">
       <label><input type="checkbox" id="bizWhtEnabled" checked /> Auto-create WHT Payable account</label>
       <label>WHT account code: <input type="text" id="bizWhtCode" value="2300" style="width:90px" /></label>
     </div>
+    <!-- NEW: Startup balances -->
+    <div class="row">
+      <label>Startup Fixed Assets (₦): <input type="number" id="bizStartupFixedAssets" step="0.01" value="0" /></label>
+      <label>Opening Accum. Depreciation (₦): <input type="number" id="bizStartupAccumDep" step="0.01" value="0" /></label>
+    </div>
+    <div class="row">
+      <label>Opening Capital Allowances (₦): <input type="number" id="bizStartupCapitalAllowances" step="0.01" value="0" /></label>
+      <label>Opening Retained Profit (₦): <input type="number" id="bizStartupRetainedEarnings" step="0.01" value="0" /></label>
+    </div>
+    <div class="row">
+      <label><input type="checkbox" id="bizApplyStartupToTax" checked /> Apply opening capital allowances when computing tax</label>
+    </div>
     <div style="display:flex;gap:8px;justify-content:flex-end;">
       <button id="bizCancel">Cancel</button>
       <button class="primary" id="bizSave">Save</button>
     </div>
   </div>
 
   <div id="contactModal" class="modal" aria-hidden="true">
     <h3 id="contactModalTitle">Add Contact</h3>
     <div class="row">
       <label>Name: <input type="text" id="contactName" /></label>
       <label>Type:
         <select id="contactType">
           <option value="Customer">Customer</option>
           <option value="Vendor">Vendor</option>
           <option value="Employee">Employee</option>
         </select>
       </label>
     </div>
     <div class="row">
       <label>Phone/Email: <input type="text" id="contactInfo" placeholder="Phone or email" /></label>
     </div>
     <div style="display:flex;gap:8px;justify-content:flex-end;">
       <button id="contactCancel">Cancel</button>
       <button class="primary" id="contactSave">Save</button>
     </div>
   </div>
 
   <div id="accountModal" class="modal" aria-hidden="true">
     <h3 id="accountModalTitle">Add Account</h3>
     <div class="row">
       <label>Code: <input type="text" id="accountCode" placeholder="e.g. 4000" /></label>
       <label>Name: <input type="text" id="accountName" placeholder="Account name" /></label>
     </div>
     <div class="row">
       <label>Type:
         <select id="accountType">
           <option value="Asset">Asset</option>
           <option value="Liability">Liability</option>
           <option value="Equity">Equity</option>
           <option value="Revenue">Revenue</option>
           <option value="Expense">Expense/Deductions</option>
         </select>
       </label>
       <label>Notes: <input type="text" id="accountNotes" placeholder="Optional" /></label>
     </div>
     <div class="row">
       <label><input type="checkbox" id="accountIsSalary" /> Salary/Payroll account (include in gross)</label>
     </div>
     <div style="display:flex;gap:8px;justify-content:flex-end;">
       <button id="accountCancel">Cancel</button>
       <button class="primary" id="accountSave">Save</button>
     </div>
   </div>
 
   <script>
     // GitHub Copilot Chat Assistant — full HTML script with taxable income panel and PIT estimate
     const STORAGE_KEY = 'ntc_data_v3';
     const DEFAULT_PIT = {
       threshold: 800000,
       slices: [
         { upTo: 3000000, rate: 0.15 },
         { upTo: 12000000, rate: 0.18 },
         { upTo: 25000000, rate: 0.21 },
         { upTo: 50000000, rate: 0.23 },
         { upTo: Infinity, rate: 0.25 }
       ]
     };
 
     const DEFAULT_DEDUCTION_KEYWORDS = [
       'rent',
       'pension',
       'nhf',
       'nhis',
       'life assurance',
       'interest on loan for owner occupied house',
       'interest',
       'owner occupied'
     ];
 
     let data = { users: [], businesses: [], transactions: {} };
     let selectedUserId = null;
     let selectedBusinessId = null;
 
     const PAGE_SIZE = 20;
     let currentPage = 1;
     let ledgerFilterText = '';
 
     function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
     function formatMoney(v){
       const n = Number(v) || 0;
       const opts = { maximumFractionDigits:2, minimumFractionDigits: Number(n) % 1 === 0 ? 0 : 2 };
       return n.toLocaleString('en-NG', opts);
     }
     function escapeHtml(s){
       if (s === undefined || s === null) return '';
       return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
     }
     function saveData(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) { console.error('Save failed', e); alert('Saving failed: ' + (e && e.message)); } }
 
     function ensureBizWhtAccount(b){
       if (!b) return;
       if (!Array.isArray(b.accounts)) b.accounts = [];
       if (!b.whtAccountId && !!b.whtAutoCreate) {
         const exists = b.accounts.find(a => (a.code && String(a.code) === String(b.whtCode || '2300')) && a.name === 'WHT Payable');
         if (exists) b.whtAccountId = exists.id;
         else {
           const acc = { id: uid('a'), code: (b.whtCode || '2300'), name: 'WHT Payable', type: 'Liability', notes: 'Auto-created for withheld tax', isSalary: false };
           b.accounts.push(acc);
           b.whtAccountId = acc.id;
         }
       }
     }
 
     function loadData(){
       const raw = localStorage.getItem(STORAGE_KEY);
       if (raw){
         try {
           const parsed = JSON.parse(raw);
           if (parsed && typeof parsed === 'object'){
             data = parsed;
             data.businesses = (data.businesses || []).map(b=>{
               if (!Array.isArray(b.members)) b.members = [];
               if (!Array.isArray(b.contacts)) b.contacts = [];
               if (!Array.isArray(b.accounts)) b.accounts = [];
               b.accounts = b.accounts.map(a => ({ ...a, isSalary: !!a.isSalary }));
               if (typeof b.vatRate !== 'number') b.vatRate = 7.5;
               if (typeof b.vatEnabled === 'undefined') b.vatEnabled = true;
               if (typeof b.pitEnabled === 'undefined') b.pitEnabled = true;
               if (!b.pit) b.pit = DEFAULT_PIT;
               if (typeof b.whtAutoCreate === 'undefined') b.whtAutoCreate = true;
               if (!b.whtCode) b.whtCode = '2300';
               if (typeof b.vatInclusive === 'undefined') b.vatInclusive = false;
+              // NEW defaults for startup balances and options
+              if (typeof b.startupFixedAssets !== 'number') b.startupFixedAssets = Number(b.startupFixedAssets || 0);
+              if (typeof b.startupAccumDep !== 'number') b.startupAccumDep = Number(b.startupAccumDep || 0);
+              if (typeof b.startupCapitalAllowances !== 'number') b.startupCapitalAllowances = Number(b.startupCapitalAllowances || 0);
+              if (typeof b.startupRetainedEarnings !== 'number') b.startupRetainedEarnings = Number(b.startupRetainedEarnings || 0);
+              if (typeof b.applyStartupToTax === 'undefined') b.applyStartupToTax = true;
               ensureBizWhtAccount(b);
               return b;
             });
             if (!data.transactions) data.transactions = {};
             return;
           }
         } catch(e){ console.error('Invalid saved data', e); }
       }
 
       // default demo
       const userId = uid('user');
       const bizId = uid('biz');
       const whtAccountId = uid('a_wht');
       const contact1 = { id: uid('c'), name: 'ACME Co', type: 'Customer', info: 'acme@example.com', notes: '' };
       const contact2 = { id: uid('c'), name: 'Office Supplies Ltd', type: 'Vendor', info: '0803-xxx', notes: '' };
       const contact3 = { id: uid('c'), name: 'John Employee', type: 'Employee', info: 'john@demo', notes: '' };
       const accounts = [
         { id: uid('a'), code: '1000', name: 'Cash', type: 'Asset', notes: '', isSalary: false },
         { id: uid('a2'), code: '2000', name: 'Accounts Payable', type: 'Liability', notes: '', isSalary: false },
         { id: uid('a3'), code: '4000', name: 'Sales Revenue', type: 'Revenue', notes: '', isSalary: false },
         { id: uid('a4'), code: '5000', name: 'Rent Expense', type: 'Expense', notes: '', isSalary: false },
       ];
       accounts.push({ id: whtAccountId, code: '2300', name: 'WHT Payable', type: 'Liability', notes: 'Auto-created', isSalary: false });
       accounts.push({ id: uid('a_p'), code: '5100', name: 'Purchases', type: 'Expense', notes: 'Goods purchased for resale', isSalary: false });
 
       data = {
         users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
         businesses: [{
           id: bizId,
           name: 'Demo Business',
           ownerId: userId,
           members: [userId],
           vatRate: 7.5,
           currency: '₦',
           threshold: 800000,
           notes: 'Sample business',
           vatEnabled: true,
           pitEnabled: true,
           vatInclusive: false,
           whtAutoCreate: true,
           whtCode: '2300',
           whtAccountId: whtAccountId,
           contacts: [contact1, contact2, contact3],
           accounts: accounts,
           pit: DEFAULT_PIT,
-          taxAdjustments: {
+          taxAdjustments: {
             netProfitA: 1500000,
             disallowable: 0,
             nonTaxableIncome: 0,
             capitalAllowances: 0,
             priorLosses: 0,
             otherAdjustments: 0
           }
+          // demo startup values
+          , startupFixedAssets: 500000,
+          startupAccumDep: 80000,
+          startupCapitalAllowances: 40000,
+          startupRetainedEarnings: 120000,
+          applyStartupToTax: true
         }],
         transactions: {}
       };
       const now = new Date().toISOString().slice(0,10);
       data.transactions[bizId] = [
         { id: uid('txn'), date: now, desc: 'Demo sale to ACME', amount: 1500000, authorUserId: userId, contactId: contact1.id, accountId: accounts.find(a=>a.type==='Revenue').id, whtEnabled: false, whtRate: 0, whtInclusive: false, vatInclusive: false },
         { id: uid('txn'), date: now, desc: 'Office rent', amount: 200000, authorUserId: userId, contactId: contact2.id, accountId: accounts.find(a=>a.code==='5000').id, whtEnabled: false, whtRate: 0, whtInclusive: false, vatInclusive: false },
         { id: uid('txn'), date: now, desc: 'Purchase inventory', amount: 300000, authorUserId: userId, contactId: contact2.id, accountId: accounts.find(a=>a.name==='Purchases').id, whtEnabled: false, whtRate: 0, whtInclusive: false, vatInclusive: false },
       ];
       saveData();
     }
 
     function findUser(id){ return data.users.find(u=>u.id===id) || null; }
     function findBiz(id){ return data.businesses.find(b=>b.id===id) || null; }
     function findContact(bizId, contactId){
       const b = findBiz(bizId); if (!b || !Array.isArray(b.contacts)) return null;
       return b.contacts.find(c=>c.id===contactId) || null;
     }
     function findAccount(bizId, accountId){
       const b = findBiz(bizId); if (!b || !Array.isArray(b.accounts)) return null;
       return b.accounts.find(a=>a.id===accountId) || null;
     }
 
     // UI references
     const userSelect = document.getElementById('userSelect');
     const businessSelect = document.getElementById('businessSelect');
     const btnAddUser = document.getElementById('btnAddUser');
     const btnEditUser = document.getElementById('btnEditUser');
     const btnAddBusiness = document.getElementById('btnAddBusiness');
     const btnEditBusiness = document.getElementById('btnEditBusiness');
 
     const btnAddTxn = document.getElementById('btnAddTxn');
     const ledgerTbody = document.querySelector('#ledgerTable tbody');
 
     const vatSummaryDiv = document.getElementById('vatSummary');
     const whtSummaryDiv = document.getElementById('whtSummary');
     const totalsSummaryDiv = document.getElementById('totalsSummary');
     const taxSummaryDiv = document.getElementById('taxSummary');
     const payeSummaryDiv = document.getElementById('payeSummary');
     const pitSummaryDiv = document.getElementById('pitSummary');
 
     const modalOverlay = document.getElementById('modalOverlay');
 
     const txnDate = document.getElementById('txnDate');
     const txnDesc = document.getElementById('txnDesc');
     const txnAmount = document.getElementById('txnAmount');
     const txnContact = document.getElementById('txnContact');
     const txnAccount = document.getElementById('txnAccount');
 
     const btnAddContactInline = document.getElementById('btnAddContactInline');
     const btnAddAccountInline = document.getElementById('btnAddAccountInline');
     const btnOpenContacts = document.getElementById('btnOpenContacts');
     const contactsListDiv = document.getElementById('contactsList');
 
     const btnOpenAccounts = document.getElementById('btnOpenAccounts');
     const accountsListDiv = document.getElementById('accountsList');
 
     const ledgerSearch = document.getElementById('ledgerSearch');
     const btnSearch = document.getElementById('btnSearch');
     const btnClearSearch = document.getElementById('btnClearSearch');
     const btnPrevPage = document.getElementById('btnPrevPage');
     const btnNextPage = document.getElementById('btnNextPage');
     const pageIndicator = document.getElementById('pageIndicator');
 
     const btnExport = document.getElementById('btnExport');
     const btnImport = document.getElementById('btnImport');
     const fileInput = document.getElementById('fileInput');
     const btnClearAll = document.getElementById('btnClearAll');
 
     // taxable income elements
     const netProfitAInput = document.getElementById('netProfitA');
     const disallowableInput = document.getElementById('disallowable');
     const nonTaxableInput = document.getElementById('nonTaxableIncome');
     const capitalAllowancesInput = document.getElementById('capitalAllowances');
     const priorLossesInput = document.getElementById('priorLosses');
     const otherAdjustmentsInput = document.getElementById('otherAdjustments');
     const btnComputeTaxable = document.getElementById('btnComputeTaxable');
     const taxableResultDiv = document.getElementById('taxableResult');
     const taxableResultValue = document.getElementById('taxableResultValue');
     const taxableBreakdownDiv = document.getElementById('taxableBreakdown');
     const saveTaxAdjToBusinessChk = document.getElementById('saveTaxAdjToBusiness');
     const btnLoadFromBusiness = document.getElementById('btnLoadFromBusiness');
 
     const pitResultDiv = document.getElementById('pitResult');
     const pitAnnualValueSpan = document.getElementById('pitAnnualValue');
     const pitMonthlyValueSpan = document.getElementById('pitMonthlyValue');
     const pitNotesDiv = document.getElementById('pitNotes');
 
+    // Business modal startup fields
+    const bizNameInput = document.getElementById('bizName');
+    const bizOwnerSelect = document.getElementById('bizOwner');
+    const bizVatInput = document.getElementById('bizVat');
+    const bizCurrencyInput = document.getElementById('bizCurrency');
+    const bizThresholdInput = document.getElementById('bizThreshold');
+    const bizNotesInput = document.getElementById('bizNotes');
+    const bizVatEnabledChk = document.getElementById('bizVatEnabled');
+    const bizPitEnabledChk = document.getElementById('bizPitEnabled');
+    const bizVatInclusiveChk = document.getElementById('bizVatInclusive');
+    const bizWhtEnabledChk = document.getElementById('bizWhtEnabled');
+    const bizWhtCodeInput = document.getElementById('bizWhtCode');
+    const bizStartupFixedAssetsInput = document.getElementById('bizStartupFixedAssets');
+    const bizStartupAccumDepInput = document.getElementById('bizStartupAccumDep');
+    const bizStartupCapitalAllowancesInput = document.getElementById('bizStartupCapitalAllowances');
+    const bizStartupRetainedEarningsInput = document.getElementById('bizStartupRetainedEarnings');
+    const bizApplyStartupToTaxChk = document.getElementById('bizApplyStartupToTax');
 
     // helper functions
     function displayAccountType(type){
       return type === 'Expense' ? 'Expense/Deductions' : (type || '');
     }
 
     function normalizeForMatch(s){
       if (!s) return '';
       return String(s).toLowerCase().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
     }
 
     function isDeductionAccount(account, extraKeywords){
       if (!account) return false;
       const name = normalizeForMatch(account.name || '');
       const keywords = (extraKeywords && extraKeywords.length) ? extraKeywords : DEFAULT_DEDUCTION_KEYWORDS;
       for (const kw of keywords){
         const k = normalizeForMatch(kw);
         if (!k) continue;
         if (name.includes(k)) return true;
       }
       return false;
     }
 
     function isPurchaseAccount(biz, account){
       if (!account) return false;
       const name = (account.name || '').toLowerCase();
       const code = String(account.code || '');
       const notes = (account.notes || '').toLowerCase();
       if (name.includes('purchase') || name.includes('purchases') || name.includes('inventory')) return true;
       if (/^51\d{0,}/.test(code)) return true;
       if (notes.includes('purchase') || notes.includes('inventory')) return true;
       return false;
     }
 
     function computeAnnualTax(taxableIncome, pitRules){
       if (!pitRules) pitRules = DEFAULT_PIT;
       const threshold = typeof pitRules.threshold === 'number' ? pitRules.threshold : DEFAULT_PIT.threshold;
       let remaining = Math.max(0, Number(taxableIncome) - threshold);
       if (remaining <= 0) return 0;
       let tax = 0;
       let lower = threshold;
       for (const slice of (pitRules.slices || DEFAULT_PIT.slices)){
         const sliceUpTo = (slice.upTo === Infinity) ? Infinity : slice.upTo;
         const sliceRange = sliceUpTo === Infinity ? Infinity : Math.max(0, sliceUpTo - lower);
         const take = Math.min(remaining, sliceRange);
         if (take > 0){
           tax += take * (Number(slice.rate) || 0);
           remaining -= take;
         }
         lower = sliceUpTo;
         if (remaining <= 0) break;
       }
       return Math.max(0, tax);
     }
 
     function getEmployeesForBusiness(b){
       if (!b || !Array.isArray(b.contacts)) return [];
       return b.contacts.filter(c => (c.type || '').toLowerCase() === 'employee');
     }
 
     // PAYE summary (kept minimal)
     function computeEmployeePayeSummaries(biz){
       if (!biz) return [];
       const year = new Date().getFullYear();
       const txs = data.transactions[biz.id] || [];
       const pitRules = biz.pit || DEFAULT_PIT;
       const employees = getEmployeesForBusiness(biz);
       const keywords = DEFAULT_DEDUCTION_KEYWORDS.slice();
       const results = [];
 
       function classifyDeductionByAccountName(accName){
         if (!accName) return null;
         const n = normalizeForMatch(accName);
         if (n.includes('pension')) return 'pension';
         if (n.includes('nhf')) return 'nhf';
         if (n.includes('nhis')) return 'nhis';
         if (n.includes('life') && n.includes('assurance')) return 'life';
         if (n.includes('interest') && (n.includes('owner') || n.includes('house'))) return 'interest_owner_occupied';
         if (n.includes('rent')) return 'rent';
         return null;
       }
 
       for (const emp of employees){
         let gross = 0;
         let pensionTotal = 0, nhfTotal = 0, nhisTotal = 0, lifeTotal = 0, interestTotal = 0, rentTotal = 0, otherDeductionTotal = 0;
 
         for (const t of txs){
           if (!t.contactId || t.contactId !== emp.id) continue;
           if (!t.date) continue;
           if (t.date.slice(0,4) !== String(year)) continue;
           const acc = findAccount(biz.id, t.accountId);
           if (!acc) continue;
           const isDeduction = isDeductionAccount(acc, keywords);
           const treatAsSalary = !!acc.isSalary || acc.type === 'Revenue' || (acc.type === 'Expense' && !isDeduction);
           const amt = Number(t.amount || 0);
 
           if (treatAsSalary){
             gross += amt;
           }
 
           const cls = classifyDeductionByAccountName(acc.name || '');
           if (cls === 'pension') pensionTotal += amt;
           else if (cls === 'nhf') nhfTotal += amt;
           else if (cls === 'nhis') nhisTotal += amt;
           else if (cls === 'life') lifeTotal += amt;
           else if (cls === 'interest_owner_occupied') interestTotal += amt;
           else if (cls === 'rent') rentTotal += amt;
           else {
             if (isDeduction) otherDeductionTotal += amt;
           }
         }
 
         const rentDeduction = Math.min(rentTotal * 0.20, 500000);
         const deductions = pensionTotal + nhfTotal + nhisTotal + lifeTotal + interestTotal + rentDeduction + otherDeductionTotal;
         const taxable = Math.max(0, gross - deductions);
         const annualPaye = computeAnnualTax(taxable, pitRules);
         const monthlyPaye = annualPaye / 12;
 
         results.push({
           contactId: emp.id,
           name: emp.name || '(no name)',
           gross,
           deductions,
           breakdown: {
             pension: pensionTotal,
             nhf: nhfTotal,
             nhis: nhisTotal,
             lifeAssurance: lifeTotal,
             interestOnOwnerOccupied: interestTotal,
             rentTotal,
             rentDeduction,
             otherStatutory: otherDeductionTotal
           },
           taxable,
           annualPaye,
           monthlyPaye
         });
       }
       return results;
     }
 
     function renderPayeSummary(biz){
       payeSummaryDiv.innerHTML = '';
       if (!biz) { payeSummaryDiv.innerHTML = '<div class="muted">No business selected.</div>'; return; }
       if (!biz.pitEnabled) { payeSummaryDiv.innerHTML = '<div class="muted">PIT disabled for this business.</div>'; return; }
       const rows = computeEmployeePayeSummaries(biz);
       if (!rows.length) { payeSummaryDiv.innerHTML = '<div class="muted">No employees found for this business (contacts with type "Employee").</div>'; return; }
 
       let html = `<strong>PAYE Summary (calendar year ${new Date().getFullYear()})</strong>`;
       html += `<table class="paye-table" role="table" aria-label="PAYE summary">
         <thead><tr><th>Employee</th><th>Gross Salary (₦)</th><th>Statutory Deductions (₦)</th><th>Taxable Income (₦)</th><th>Annual PAYE (₦)</th><th>Monthly PAYE (₦)</th></tr></thead><tbody>`;
       let totalGross=0, totalDeductions=0, totalTaxable=0, totalAnnual=0, totalMonthly=0;
       for (const r of rows){
         html += `<tr>
           <td>${escapeHtml(r.name)}</td>
           <td class="nowrap">${formatMoney(r.gross)}</td>
           <td class="nowrap">${formatMoney(r.deductions)}</td>
           <td class="nowrap">${formatMoney(r.taxable)}</td>
           <td class="nowrap">${formatMoney(r.annualPaye)}</td>
           <td class="nowrap">${formatMoney(r.monthlyPaye)}</td>
         </tr>`;
         totalGross += r.gross;
         totalDeductions += r.deductions;
         totalTaxable += r.taxable;
         totalAnnual += r.annualPaye;
         totalMonthly += r.monthlyPaye;
       }
       html += `</tbody><tfoot><tr style="font-weight:600;">
         <td>Total</td>
         <td class="nowrap">${formatMoney(totalGross)}</td>
         <td class="nowrap">${formatMoney(totalDeductions)}</td>
         <td class="nowrap">${formatMoney(totalTaxable)}</td>
         <td class="nowrap">${formatMoney(totalAnnual)}</td>
         <td class="nowrap">${formatMoney(totalMonthly)}</td>
       </tr></tfoot></table>`;
       payeSummaryDiv.innerHTML = html;
     }
 
     function renderMonthlyPayePitSummaries(){
       const b = findBiz(selectedBusinessId);
       renderPayeSummary(b);
       pitSummaryDiv.innerHTML = '';
       if (b && b.pit) {
         const bands = (b.pit.slices || DEFAULT_PIT.slices).map(s => {
           const upTo = s.upTo === Infinity ? 'and above' : `up to ₦${formatMoney(s.upTo)}`;
           return `<div>${upTo}: ${(Number(s.rate || 0)*100).toFixed(0)}%</div>`;
         }).join('');
         pitSummaryDiv.innerHTML = `<div class="muted">Tax-free threshold: ₦${formatMoney((b.pit && b.pit.threshold) ? b.pit.threshold : DEFAULT_PIT.threshold)} — Rate bands:</div><div style="margin-top:6px">${bands}</div>`;
       } else {
         pitSummaryDiv.innerHTML = '<div class="muted">PIT settings not configured for this business.</div>';
       }
     }
 
     function populateUserBusinessSelects(){
       userSelect.innerHTML = '';
       businessSelect.innerHTML = '';
       if (!data.users.length) {
         const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no users --'; userSelect.appendChild(opt);
       } else {
         data.users.forEach(u=>{ const opt = document.createElement('option'); opt.value=u.id; opt.textContent = (u.display||u.username); userSelect.appendChild(opt); });
       }
       if (!data.businesses.length) {
         const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no businesses --'; businessSelect.appendChild(opt);
       } else {
         data.businesses.forEach(b=>{ const opt = document.createElement('option'); opt.value=b.id; opt.textContent = b.name; businessSelect.appendChild(opt); });
       }
 
       if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
       if (!selectedBusinessId && data.businesses.length) selectedBusinessId = data.businesses[0].id;
       if (selectedUserId) userSelect.value = selectedUserId;
       if (selectedBusinessId) businessSelect.value = selectedBusinessId;
     }
 
     function populateBizOwnerOptions(){
       const bizOwner = document.getElementById('bizOwner');
       bizOwner.innerHTML = '';
       if (!data.users.length) {
         const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no users --'; bizOwner.appendChild(opt);
       } else {
         data.users.forEach(u=>{ const opt = document.createElement('option'); opt.value=u.id; opt.textContent = (u.display||u.username); bizOwner.appendChild(opt); });
       }
     }
 
     function populateContactSelects(){
       const b = findBiz(selectedBusinessId);
       const lists = [txnContact];
       lists.forEach(select => {
         if (!select) return;
         select.innerHTML = '';
         if (!b || !Array.isArray(b.contacts) || b.contacts.length === 0){
           const opt = document.createElement('option'); opt.value=''; opt.textContent = '-- no contacts --'; select.appendChild(opt);
         } else {
           const empty = document.createElement('option'); empty.value=''; empty.textContent='-- select contact --'; select.appendChild(empty);
           b.contacts.forEach(c=>{
             const opt = document.createElement('option'); opt.value = c.id; opt.textContent = (c.name || c.info || '(no name)') + ' (' + (c.type||'') + ')';
             select.appendChild(opt);
           });
         }
       });
     }
 
     function populateAccountSelects(){
       const b = findBiz(selectedBusinessId);
       const lists = [txnAccount];
       lists.forEach(select => {
         if (!select) return;
         select.innerHTML = '';
         if (!b || !Array.isArray(b.accounts) || b.accounts.length === 0){
           const opt = document.createElement('option'); opt.value=''; opt.textContent = '-- no accounts --'; select.appendChild(opt);
         } else {
           const empty = document.createElement('option'); empty.value=''; empty.textContent='-- select account --'; select.appendChild(empty);
           b.accounts.forEach(a=>{
             const opt = document.createElement('option'); opt.value = a.id; opt.textContent = `${a.code || ''} - ${a.name} (${displayAccountType(a.type)})${a.isSalary ? ' [Salary]' : ''}`;
             select.appendChild(opt);
           });
         }
       });
     }
 
     function refreshContactsAccountsUI(){
       contactsListDiv.innerHTML = ''; accountsListDiv.innerHTML = '';
       const b = findBiz(selectedBusinessId);
       if (!b){ contactsListDiv.textContent='No business selected.'; accountsListDiv.textContent='No business selected.'; populateContactSelects(); populateAccountSelects(); return; }
       if (!Array.isArray(b.contacts)) b.contacts = [];
       if (!Array.isArray(b.accounts)) b.accounts = [];
 
       if (b.contacts.length === 0) contactsListDiv.innerHTML = '<div class="muted">No contacts for this business.</div>';
       else {
         b.contacts.forEach(c=>{
           const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
           d.innerHTML = `<div><strong>${escapeHtml(c.name)}</strong> <span class="muted">(${escapeHtml(c.type)})</span><br/><small class="muted">${escapeHtml(c.info||'')}</small></div>`;
           contactsListDiv.appendChild(d);
         });
       }
 
       if (b.accounts.length === 0) accountsListDiv.innerHTML = '<div class="muted">No accounts for this business.</div>';
       else {
         b.accounts.forEach(a=>{
           const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
           const isWht = (b.whtAccountId && a.id === b.whtAccountId);
           const salaryTag = a.isSalary ? '<span class="muted"> (Salary)</span>' : '';
           d.innerHTML = `<div><strong>${escapeHtml(a.code)} - ${escapeHtml(a.name)}</strong> ${isWht?'<span class="muted"> (WHT Payable)</span>':''}${salaryTag} <span class="muted">(${escapeHtml(displayAccountType(a.type))})</span></div>`;
           accountsListDiv.appendChild(d);
         });
       }
       populateContactSelects();
       populateAccountSelects();
+      // show startup balances under accounts list
+      const existingStartup = document.getElementById('startupBalancesDisplay');
+      if (existingStartup) existingStartup.remove();
+      const startupDiv = document.createElement('div');
+      startupDiv.id = 'startupBalancesDisplay';
+      startupDiv.style.marginTop = '8px';
+      if (b) {
+        const nbv = Number(b.startupFixedAssets || 0) - Number(b.startupAccumDep || 0);
+        startupDiv.innerHTML = `<strong>Opening balances</strong>
+          <div>Fixed assets: ₦${formatMoney(b.startupFixedAssets)}</div>
+          <div>Accum. depreciation: ₦${formatMoney(b.startupAccumDep)}</div>
+          <div>Net book value: ₦${formatMoney(nbv)}</div>
+          <div>Opening capital allowances: ₦${formatMoney(b.startupCapitalAllowances)}</div>
+          <div>Opening retained profit: ₦${formatMoney(b.startupRetainedEarnings)}</div>`;
+      } else {
+        startupDiv.innerHTML = `<div class="muted">No opening balances</div>`;
+      }
+      accountsListDiv.parentNode.insertBefore(startupDiv, accountsListDiv.nextSibling);
     }
 
     function renderLedger(){
       ledgerTbody.innerHTML = '';
       const b = findBiz(selectedBusinessId);
       if (!b) return;
       const txs = (data.transactions[b.id] || []).slice().sort((a,b2)=> (b2.date || '').localeCompare(a.date || '')); // desc by date
       let filtered = txs;
       const q = (ledgerFilterText || '').trim().toLowerCase();
       if (q){
         filtered = txs.filter(t=>{
           const acc = findAccount(b.id, t.accountId);
           const contact = findContact(b.id, t.contactId);
           const author = findUser(t.authorUserId);
           return (t.date||'').toLowerCase().includes(q) ||
                  (t.desc||'').toLowerCase().includes(q) ||
                  String(t.amount||'').toLowerCase().includes(q) ||
                  (acc && ((acc.name||'').toLowerCase().includes(q) || (acc.code||'').toLowerCase().includes(q))) ||
                  (contact && (contact.name||'').toLowerCase().includes(q)) ||
                  (author && ((author.display||'').toLowerCase().includes(q) || (author.username||'').toLowerCase().includes(q)));
         });
       }
       const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
       if (currentPage > totalPages) currentPage = totalPages;
       const start = (currentPage - 1) * PAGE_SIZE;
       const pageItems = filtered.slice(start, start + PAGE_SIZE);
       for (const t of pageItems){
         const tr = document.createElement('tr');
         const acc = findAccount(b.id, t.accountId);
         const contact = findContact(b.id, t.contactId);
         const author = findUser(t.authorUserId);
 
         let vatAmt = 0;
         if (b.vatEnabled && b.vatRate && acc && (acc.type === 'Revenue' || isPurchaseAccount(b, acc))){
           if (b.vatInclusive || t.vatInclusive){
             vatAmt = Number(t.amount || 0) * Number(b.vatRate || 0) / (100 + Number(b.vatRate || 0));
           } else {
             vatAmt = Number(t.amount || 0) * Number(b.vatRate || 0) / 100;
           }
         }
 
         let whtAmt = 0;
         if (t.whtEnabled && t.whtRate){
           if (t.whtInclusive){
             whtAmt = Number(t.amount || 0) * Number(t.whtRate || 0) / (100 + Number(t.whtRate || 0));
           } else {
             whtAmt = Number(t.amount || 0) * Number(t.whtRate || 0) / 100;
           }
         }
 
         const accText = acc ? `${acc.code || ''} - ${acc.name}` : '(no account)';
         tr.innerHTML = `<td>${escapeHtml(t.date || '')}</td>
           <td>${escapeHtml(t.desc || '')}</td>
           <td>${escapeHtml(accText)}</td>
           <td class="nowrap">${formatMoney(t.amount)}</td>
           <td class="nowrap">${formatMoney(vatAmt)}</td>
           <td class="nowrap">${formatMoney(whtAmt)}</td>
           <td>${escapeHtml(contact ? contact.name : '')}</td>
           <td>${escapeHtml(author ? (author.display || author.username) : '')}</td>
           <td style="white-space:nowrap">
             <button class="small" onclick="alert('Edit not implemented in this demo')">Edit</button>
             <button class="small danger" onclick="alert('Delete not implemented in this demo')">Delete</button>
           </td>`;
         ledgerTbody.appendChild(tr);
       }
       pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
     }
 
     function calculateSummary(){
       const b = findBiz(selectedBusinessId);
       if (!b) return;
       const txs = data.transactions[b.id] || [];
 
       let totalVatOutput = 0, totalVatInput = 0, totalWhtWithheld = 0, totalAmount = 0;
       for (const t of txs){
         const acc = findAccount(b.id, t.accountId);
         if (!acc) continue;
         const amt = Number(t.amount || 0);
         totalAmount += amt;
 
         let vatAmt = 0;
         if (b.vatEnabled && b.vatRate && acc && (acc.type === 'Revenue' || isPurchaseAccount(b, acc))){
           if (b.vatInclusive || t.vatInclusive){
             vatAmt = amt * b.vatRate / (100 + b.vatRate);
           } else {
             vatAmt = amt * b.vatRate / 100;
           }
         }
         if (acc.type === 'Revenue') totalVatOutput += vatAmt;
         else if (isPurchaseAccount(b, acc)) totalVatInput += vatAmt;
 
         if (t.whtEnabled && t.whtRate){
           let whtAmt = 0;
           if (t.whtInclusive) whtAmt = amt * t.whtRate / (100 + t.whtRate);
           else whtAmt = amt * t.whtRate / 100;
           totalWhtWithheld += whtAmt;
         }
       }
 
       vatSummaryDiv.innerHTML = `<strong>VAT</strong><div>Output VAT: ₦${formatMoney(totalVatOutput)}</div><div>Input VAT: ₦${formatMoney(totalVatInput)}</div><div>Net VAT (payable): ₦${formatMoney(Math.max(0,totalVatOutput - totalVatInput))}</div>`;
       whtSummaryDiv.innerHTML = `<strong>WHT</strong><div>Total withheld: ₦${formatMoney(totalWhtWithheld)}</div>`;
       totalsSummaryDiv.innerHTML = `<strong>Totals</strong><div>Total transactions amount: ₦${formatMoney(totalAmount)}</div>`;
     }
 
     // TAXABLE income compute and PIT display
     function computeTaxableAndPit(){
       const b = findBiz(selectedBusinessId);
       const netProfitA = Number(netProfitAInput.value || 0);
       const disallowable = Number(disallowableInput.value || 0);
       const nonTaxable = Number(nonTaxableInput.value || 0);
-      const capitalAllowances = Number(capitalAllowancesInput.value || 0);
+      let capitalAllowances = Number(capitalAllowancesInput.value || 0);
       const priorLosses = Number(priorLossesInput.value || 0);
       const otherAdj = Number(otherAdjustmentsInput.value || 0);
 
-      const taxable = Math.max(0, netProfitA + disallowable - nonTaxable - capitalAllowances - priorLosses + otherAdj);
+      // include business opening capital allowances if set and if business opted in
+      if (b && Number(b.startupCapitalAllowances || 0) && b.applyStartupToTax) {
+        capitalAllowances += Number(b.startupCapitalAllowances || 0);
+      }
+
+      const taxable = Math.max(0, netProfitA + disallowable - nonTaxable - capitalAllowances - priorLosses + otherAdj);
       taxableResultValue.textContent = formatMoney(taxable);
       taxableBreakdownDiv.innerHTML = `<div class="muted">Breakdown: Net profit A ${formatMoney(netProfitA)} + Disallowable ${formatMoney(disallowable)} - Non-taxable ${formatMoney(nonTaxable)} - Capital allowances ${formatMoney(capitalAllowances)} - Prior losses ${formatMoney(priorLosses)} + Other adjustments ${formatMoney(otherAdj)}</div>`;
       taxableResultDiv.style.display = 'block';
 
       // compute PIT using business PIT rules if present
       const pitRules = (b && b.pit) ? b.pit : DEFAULT_PIT;
       const annualPit = computeAnnualTax(taxable, pitRules);
       const monthlyPit = annualPit / 12;
       pitAnnualValueSpan.textContent = formatMoney(annualPit);
       pitMonthlyValueSpan.textContent = formatMoney(monthlyPit);
       let notes = `Using ${b && b.pit ? 'business PIT settings' : 'default PIT bands'}. Tax-free threshold: ₦${formatMoney(pitRules.threshold || DEFAULT_PIT.threshold)}.`;
       pitNotesDiv.textContent = notes;
       pitResultDiv.style.display = 'block';
 
       if (saveTaxAdjToBusinessChk.checked && b){
         b.taxAdjustments = {
           netProfitA: netProfitA,
           disallowable: disallowable,
-          nonTaxableIncome: nonTaxable,
-          capitalAllowances: capitalAllowances,
+          nonTaxableIncome: nonTaxable,
+          capitalAllowances: Number(capitalAllowancesInput.value || 0), // store user-provided CA only (startup CA is separate)
           priorLosses: priorLosses,
           otherAdjustments: otherAdj
         };
         saveData();
       }
     }
 
     function loadTaxAdjFromBusiness(){
       const b = findBiz(selectedBusinessId);
       if (!b || !b.taxAdjustments) {
         alert('No saved adjustments for this business.');
         return;
       }
       const t = b.taxAdjustments;
       netProfitAInput.value = t.netProfitA || 0;
       disallowableInput.value = t.disallowable || 0;
       nonTaxableInput.value = t.nonTaxableIncome || 0;
-      capitalAllowancesInput.value = (Number(t.capitalAllowances || 0));
+      // include startup capital allowances if configured
+      const startupCA = (b && b.applyStartupToTax) ? Number(b.startupCapitalAllowances || 0) : 0;
+      capitalAllowancesInput.value = (Number(t.capitalAllowances || 0) + startupCA);
       priorLossesInput.value = t.priorLosses || 0;
       otherAdjustmentsInput.value = t.otherAdjustments || 0;
       computeTaxableAndPit();
     }
 
     // Event wiring
     btnComputeTaxable.addEventListener('click', computeTaxableAndPit);
     btnLoadFromBusiness.addEventListener('click', loadTaxAdjFromBusiness);
 
     // Simplified UI actions to manage users/businesses minimally for demo purposes
-    document.getElementById('btnAddUser').addEventListener('click', ()=>{
-      const username = prompt('Username?','user'+Math.floor(Math.random()*1000));
-      if (!username) return;
-      const display = prompt('Display name?', username) || username;
-      const u = { id: uid('user'), username, display };
-      data.users.push(u);
-      saveData();
-      populateUserBusinessSelects();
-    });
+    document.getElementById('btnAddUser').addEventListener('click', ()=>{
+      const username = prompt('Username?','user'+Math.floor(Math.random()*1000));
+      if (!username) return;
+      const display = prompt('Display name?', username) || username;
+      const u = { id: uid('user'), username, display };
+      data.users.push(u);
+      saveData();
+      populateUserBusinessSelects();
+      populateBizOwnerOptions();
+    });
 
+    // open business modal for add
+    document.getElementById('btnAddBusiness').addEventListener('click', ()=>{
+      openBusinessModal();
+    });
+
+    // edit selected business
+    document.getElementById('btnEditBusiness').addEventListener('click', ()=>{
+      const b = findBiz(selectedBusinessId);
+      if (!b) { alert('No business selected'); return; }
+      openBusinessModal(b);
+    });
+
+    function openBusinessModal(biz){
+      // reset fields
+      bizNameInput.value = biz ? biz.name : '';
+      populateBizOwnerOptions();
+      bizOwnerSelect.value = biz ? (biz.ownerId || '') : (data.users[0] ? data.users[0].id : '');
+      bizVatInput.value = biz ? (biz.vatRate || 7.5) : 7.5;
+      bizCurrencyInput.value = biz ? (biz.currency || '₦') : '₦';
+      bizThresholdInput.value = biz ? (biz.threshold || '') : '';
+      bizNotesInput.value = biz ? (biz.notes || '') : '';
+      bizVatEnabledChk.checked = biz ? !!biz.vatEnabled : true;
+      bizPitEnabledChk.checked = biz ? !!biz.pitEnabled : true;
+      bizVatInclusiveChk.checked = biz ? !!biz.vatInclusive : false;
+      bizWhtEnabledChk.checked = biz ? !!biz.whtAutoCreate : true;
+      bizWhtCodeInput.value = biz ? (biz.whtCode || '2300') : '2300';
+      // startup fields
+      bizStartupFixedAssetsInput.value = biz ? (Number(biz.startupFixedAssets || 0)) : 0;
+      bizStartupAccumDepInput.value = biz ? (Number(biz.startupAccumDep || 0)) : 0;
+      bizStartupCapitalAllowancesInput.value = biz ? (Number(biz.startupCapitalAllowances || 0)) : 0;
+      bizStartupRetainedEarningsInput.value = biz ? (Number(biz.startupRetainedEarnings || 0)) : 0;
+      bizApplyStartupToTaxChk.checked = biz ? !!biz.applyStartupToTax : true;
+
+      document.getElementById('businessModalTitle').textContent = biz ? 'Edit Business' : 'Add Business';
+      document.getElementById('businessModal').dataset.editing = biz ? biz.id : '';
+      showModal('businessModal');
+    }
+
+    // business modal cancel/save handlers
+    document.getElementById('bizCancel').addEventListener('click', ()=>{ hideModal('businessModal'); });
+    document.getElementById('bizSave').addEventListener('click', ()=>{
+      const editingId = document.getElementById('businessModal').dataset.editing;
+      let b;
+      if (editingId) {
+        b = findBiz(editingId);
+        if (!b) { alert('Business not found'); hideModal('businessModal'); return; }
+      } else {
+        b = { id: uid('biz'), members: [], contacts: [], accounts: [] };
+        data.businesses.push(b);
+      }
+      b.name = bizNameInput.value || ('Business ' + (data.businesses.length));
+      b.ownerId = bizOwnerSelect.value || null;
+      b.vatRate = Number(bizVatInput.value || 7.5);
+      b.currency = bizCurrencyInput.value || '₦';
+      b.threshold = Number(bizThresholdInput.value || 0);
+      b.notes = bizNotesInput.value || '';
+      b.vatEnabled = !!bizVatEnabledChk.checked;
+      b.pitEnabled = !!bizPitEnabledChk.checked;
+      b.vatInclusive = !!bizVatInclusiveChk.checked;
+      b.whtAutoCreate = !!bizWhtEnabledChk.checked;
+      b.whtCode = bizWhtCodeInput.value || '2300';
+      // store startup balances
+      b.startupFixedAssets = Number(bizStartupFixedAssetsInput.value || 0);
+      b.startupAccumDep = Number(bizStartupAccumDepInput.value || 0);
+      b.startupCapitalAllowances = Number(bizStartupCapitalAllowancesInput.value || 0);
+      b.startupRetainedEarnings = Number(bizStartupRetainedEarningsInput.value || 0);
+      b.applyStartupToTax = !!bizApplyStartupToTaxChk.checked;
+      // ensure defaults
+      if (!Array.isArray(b.contacts)) b.contacts = [];
+      if (!Array.isArray(b.accounts)) b.accounts = [];
+      ensureBizWhtAccount(b);
+      saveData();
+      populateUserBusinessSelects();
+      refreshContactsAccountsUI();
+      hideModal('businessModal');
+    });
+
+    // modal helpers
+    function showModal(id){
+      document.getElementById('modalOverlay').style.display = 'block';
+      document.getElementById(id).style.display = 'block';
+      document.getElementById(id).setAttribute('aria-hidden','false');
+    }
+    function hideModal(id){
+      document.getElementById('modalOverlay').style.display = 'none';
+      document.getElementById(id).style.display = 'none';
+      document.getElementById(id).setAttribute('aria-hidden','true');
+    }
+
     // Simplified contact/account add handlers (inline)
     document.getElementById('btnAddContactInline').addEventListener('click', ()=>{
       const b = findBiz(selectedBusinessId);
       if (!b) { alert('Select a business first'); return; }
       const name = prompt('Contact name?','New Contact');
       if (!name) return;
       const type = prompt('Contact type? (Customer, Vendor, Employee)','Customer') || 'Customer';
       const contact = { id: uid('c'), name, type, info: '' };
       b.contacts.push(contact);
       saveData();
       refreshContactsAccountsUI();
     });
 
     document.getElementById('btnAddAccountInline').addEventListener('click', ()=>{
       const b = findBiz(selectedBusinessId);
       if (!b) { alert('Select a business first'); return; }
       const code = prompt('Account code?','5000');
       if (!code) return;
       const name = prompt('Account name?','New Account') || 'New Account';
       const type = prompt('Type? (Asset, Liability, Equity, Revenue, Expense)','Expense') || 'Expense';
       const acc = { id: uid('a'), code, name, type, notes: '', isSalary: false };
       b.accounts.push(acc);
       saveData();
       refreshContactsAccountsUI();
     });
 
     // add transaction
     document.getElementById('btnAddTxn').addEventListener('click', ()=>{
       const b = findBiz(selectedBusinessId);
       if (!b) { alert('Select a business'); return; }
       const date = txnDate.value || new Date().toISOString().slice(0,10);
       const accountId = txnAccount.value;
       if (!accountId) { alert('Select account'); return; }
       const amount = Number(txnAmount.value || 0);
       if (!amount) { alert('Enter amount'); return; }
       const desc = txnDesc.value || '';
       const contactId = txnContact.value || '';
       const txn = {
         id: uid('txn'),
         date,
         desc,
         accountId,
         amount,
         authorUserId: selectedUserId,
         contactId,
         whtEnabled: false,
         whtRate: 0,
         whtInclusive: false,
         vatInclusive: false
       };
       data.transactions[b.id] = data.transactions[b.id] || [];
       data.transactions[b.id].push(txn);
       saveData();
       renderLedger();
       calculateSummary();
       txnDate.value = '';
       txnDesc.value = '';
       txnAmount.value = '';
     });
 
     // search/pagination
     btnSearch.addEventListener('click', ()=>{ ledgerFilterText = ledgerSearch.value || ''; currentPage = 1; renderLedger(); });
     btnClearSearch.addEventListener('click', ()=>{ ledgerFilterText = ''; ledgerSearch.value=''; currentPage=1; renderLedger(); });
     btnPrevPage.addEventListener('click', ()=>{ if (currentPage>1) { currentPage--; renderLedger(); } });
     btnNextPage.addEventListener('click', ()=>{ currentPage++; renderLedger(); });
 
     // export/import
     btnExport.addEventListener('click', ()=>{
       const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
       const url = URL.createObjectURL(blob);
       const a = document.createElement('a'); a.href = url; a.download = 'ntc_data.json'; a.click();
       URL.revokeObjectURL(url);
     });
     btnImport.addEventListener('click', ()=> fileInput.click());
     fileInput.addEventListener('change', (e)=>{
       const f = e.target.files && e.target.files[0];
       if (!f) return;
       const r = new FileReader();
       r.onload = function(){ try { const parsed = JSON.parse(r.result); data = parsed; saveData(); loadData(); populateUserBusinessSelects(); refreshContactsAccountsUI(); renderLedger(); calculateSummary(); } catch(ex){ alert('Invalid JSON'); } };
       r.readAsText(f);
     });
 
     btnClearAll.addEventListener('click', ()=>{
       if (!confirm('Clear all saved data? This cannot be undone.')) return;
       localStorage.removeItem(STORAGE_KEY);
       data = { users: [], businesses: [], transactions: {} };
       selectedUserId = null; selectedBusinessId = null;
       loadData();
       populateUserBusinessSelects();
       refreshContactsAccountsUI();
       renderLedger();
       calculateSummary();
     });
 
     // wire user/business selects
     userSelect.addEventListener('change', (e)=>{ selectedUserId = e.target.value; });
     businessSelect.addEventListener('change', (e)=>{ selectedBusinessId = e.target.value; refreshContactsAccountsUI(); renderLedger(); calculateSummary(); renderMonthlyPayePitSummaries(); });
 
     // init
     loadData();
     populateUserBusinessSelects();
     populateBizOwnerOptions();
     refreshContactsAccountsUI();
     renderLedger();
     calculateSummary();
     renderMonthlyPayePitSummaries();
 
     // show/hide basic modals for contacts/accounts (not full CRUD in demo)
     document.getElementById('btnOpenContacts').addEventListener('click', ()=> alert('Manage contacts in-place using inline add (demo).'));
     document.getElementById('btnOpenAccounts').addEventListener('click', ()=> alert('Manage accounts in-place using inline add (demo).'));
 
     // a few accessibility helpers
     modalOverlay.addEventListener('click', ()=> {
       // hide any modals
       const modals = document.querySelectorAll('.modal');
       modals.forEach(m=>{ if (m.style.display === 'block') hideModal(m.id); });
     });
   </script>
 </body>
   </html>
