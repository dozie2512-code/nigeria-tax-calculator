Here's the full updated index.html with the changes you requested applied:

- Removed "Default dep %" and "CapAllow %" from the top business settings panel.
- Removed "Mark reconciled" checkbox from the Add Transaction form and removed related JS usage.
- Added an "Inventory" action button immediately after the Date field in the Add Transaction form that prompts for a simple inventory entry and saves it to the business inventory.
- Replaced the taxable-income input boxes with computed read-only fields showing:
  - Revenue
  - Expenses
  - Depreciation (sum of asset.cost * depRate%)
  - Net profit (Revenue - Expenses - Depreciation)
  - Capital allowance (sum of asset.cost * capAllowRate%)
  - Taxable income computed as max(0, Net profit - Capital allowance)
- Removed "Other adjustments" input boxes and other editable adjustments; taxable computations are displayed without boxes.
- Kept asset-level depreciation and capital allowance fields (asset modal remains unchanged), since you wanted dep/capallow left in the fixed-asset subform.

Save/replace your repository's index.html with the following content:

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Tax & Accounting — Multi-business</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background:#fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"], textarea { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary, .wht-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(920px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .inline-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:start; }
    .field { display:flex; flex-direction:column; gap:4px; }
    .result-box { background:#fff; padding:10px; border:1px solid #eef2f6; border-radius:6px; margin-top:8px; }
    .result-row { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:4px 0; }
    table.paye-table { width:100%; border-collapse:collapse; margin-top:8px; }
    table.paye-table th, table.paye-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; background:#fff; }
    table.paye-table th { background:#f5f8fb; }
    .nowrap { white-space:nowrap; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .asset-row { border-bottom:1px solid #eee; padding:8px 0; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .asset-left { display:flex; gap:8px; align-items:center; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Tax & Accounting — Multi-business</h1>

    <div class="controls panel">
      <label for="userSelect">User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>

      <label for="businessSelect">Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>

      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>

      <div class="settings-inline">
        <label>Type:
          <select id="businessTypeSelect" style="margin-left:6px;">
            <option value="product">Product</option>
            <option value="service">Service</option>
          </select>
        </label>

        <label>VAT %: <input type="number" id="businessVatRate" step="0.1" style="width:80px" /></label>
        <label>Enable VAT: <input type="checkbox" id="businessVatEnabled" style="margin-left:6px;" /></label>

        <label>CIT %: <input type="number" id="businessCitRate" step="0.1" style="width:80px" /></label>
        <label>WHT % (default): <input type="number" id="businessWhtRate" step="0.1" style="width:80px" /></label>

        <button id="btnSaveBizSettings" class="small">Save</button>
      </div>
    </div>

    <div class="spacer"></div>

    <div style="display:flex;gap:8px;align-items:center;">
      <label class="muted-inline">Tax year:
        <select id="taxYearSelect" style="margin-left:6px;"></select>
      </label>
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2>Add Transaction</h2>

      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <button class="small" id="btnInventoryAction">Inventory</button>

        <label>Account: <select id="txnAccount"></select></label>
        <button class="small" id="btnAddAccountInline">+ Account</button>

        <label id="txnDescLabel">Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label id="txnAmountLabel">Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label>Contact: <select id="txnContact"></select></label>
        <button class="small" id="btnAddContactInline">+ Contact</button>

        <label>Payroll: <input type="checkbox" id="txnPayroll" /></label>
        <label>Apply WHT: <input type="checkbox" id="txnApplyWht" /></label>
        <label>WHT %: <input type="number" id="txnWhtRate" step="0.1" style="width:80px" /></label>

        <label>Apply VAT: <input type="checkbox" id="txnApplyVat" /></label>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>Bank account: <select id="txnBankAccount"></select></label>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>

      <small class="note">Transactions saved per business. Tax fields (VAT/WHT/PAYE) computed from business settings and transaction options.</small>
    </section>

    <section class="panel section">
      <h2>Transactions Ledger</h2>
      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable" aria-live="polite">
        <thead>
          <tr><th>Date</th><th>Description</th><th>Account</th><th>Amount (₦)</th><th>Contact</th><th>Bank</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section" id="taxableFromNetProfitPanel">
      <h2>Taxable Income — Computed</h2>
      <div class="inline-grid">
        <div>
          <div class="field">
            <label>Revenue (₦): <input type="text" id="computedRevenue" readonly /></label>
          </div>

          <div class="field">
            <label>Expenses (₦): <input type="text" id="computedExpenses" readonly /></label>
          </div>

          <div class="field">
            <label>Depreciation (₦): <input type="text" id="computedDepreciation" readonly /></label>
          </div>

          <div class="field">
            <label>Net profit (₦): <input type="text" id="computedNetProfit" readonly /></label>
            <small class="muted">Net profit = Revenue - Expenses - Depreciation (computed from ledger & fixed assets)</small>
          </div>

          <div class="field">
            <label>Capital allowance (₦): <input type="text" id="computedCapitalAllowance" readonly /></label>
            <small class="muted">Computed from fixed assets (cost × asset capital allowance %)</small>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
            <button class="primary" id="btnComputeTaxable">Compute Taxable Income</button>
            <button id="btnLoadFromBusiness" class="small">Load saved adjustments</button>
          </div>
        </div>

        <div class="tax-results">
          <div id="taxableResult" class="result-box" style="display:none;">
            <div class="result-row"><div><strong>Taxable income</strong></div><div>₦ <span id="taxableResultValue">0</span></div></div>
            <div id="taxableBreakdown" style="margin-top:6px;"></div>
          </div>

          <div id="pitResult" class="result-box" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>Estimated PIT (annual)</strong></div>
              <div style="text-align:right;">
                <div>₦ <span id="pitAnnualValue">0</span></div>
                <div class="muted" style="font-size:0.9rem;">Monthly: ₦ <span id="pitMonthlyValue">0</span></div>
              </div>
            </div>
            <div id="pitNotes" style="margin-top:8px;" class="muted"></div>
          </div>

          <div id="citResult" class="result-box" style="display:none;">
            <div class="result-row"><div><strong>Estimated Company Income Tax (CIT)</strong></div><div>₦ <span id="citValue">0</span></div></div>
            <div id="citNotes" style="margin-top:6px;" class="muted"></div>
          </div>
        </div>
      </div>

      <small class="muted">Formula: Taxable income = Net profit - Capital allowances (non-negative). Other adjustments and manual boxes removed; figures are computed from ledger and fixed assets.</small>
    </section>

    <section class="panel section" id="assetsPanel">
      <h2>Fixed Assets</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="btnAddAsset" class="small">+ Add Asset</button>
        <button id="btnImportAssets" class="small">Import Assets</button>
        <button id="btnOpenDispose" class="small">Dispose Asset</button>
      </div>
      <div id="fixedAssetsList" style="margin-top:8px;"></div>
    </section>

  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true"></div>

  <div id="assetModal" class="modal" aria-hidden="true">
    <h3 id="assetModalTitle">Add / Edit Fixed Asset</h3>
    <div class="row">
      <label>Name: <input type="text" id="assetName" /></label>
      <label>Account: <select id="assetAccount"></select></label>
    </div>
    <div class="row">
      <label>Cost (₦): <input type="number" id="assetCost" step="0.01" /></label>
      <label>Date acquired: <input type="date" id="assetDate" /></label>
      <label>Useful life (yrs): <input type="number" id="assetLife" min="1" step="1" value="4" style="width:80px" /></label>
    </div>
    <div class="row">
      <label>Annual depreciation %: <input type="number" id="assetDepRate" step="0.1" style="width:100px" /></label>
      <label>Capital allowance %: <input type="number" id="assetCapAllowRate" step="0.1" style="width:100px" /></label>
      <label>Opening accumulated depreciation (₦): <input type="number" id="assetAccum" step="0.01" value="0" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="assetCancel">Cancel</button>
      <button class="primary" id="assetSave">Save</button>
    </div>
  </div>

  <div id="disposeModal" class="modal" aria-hidden="true">
    <h3>Dispose Asset</h3>
    <div class="row">
      <label>Asset: <select id="disposeAssetSelect"></select></label>
      <label>Disposal date: <input type="date" id="disposeDate" /></label>
      <label>Proceeds (₦): <input type="number" id="disposeProceeds" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="disposeCancel">Cancel</button>
      <button class="primary" id="disposeConfirm">Dispose</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant
    const STORAGE_KEY = 'ntc_data_v8';
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };
    const DEFAULT_USEFUL_LIFE_YEARS = 4;

    // Default global rates
    const DEFAULT_CIT_RATE = 30.0; // %
    const DEFAULT_WHT_RATE = 5.0; // %
    const DEFAULT_DEP_RATE = 25.0; // %
    const DEFAULT_CAPALLOW_RATE = 20.0; // %
    const DEFAULT_VAT_RATE = 7.5; // %

    let data = { users: [], businesses: [], transactions: {} };
    let selectedUserId = null;
    let selectedBusinessId = null;

    // DOM refs
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const businessTypeSelect = document.getElementById('businessTypeSelect');
    const businessCitRateInput = document.getElementById('businessCitRate');
    const businessWhtRateInput = document.getElementById('businessWhtRate');
    const businessVatRateInput = document.getElementById('businessVatRate');
    const businessVatEnabledInput = document.getElementById('businessVatEnabled');
    const btnSaveBizSettings = document.getElementById('btnSaveBizSettings');

    const taxYearSelect = document.getElementById('taxYearSelect');
    const txnDate = document.getElementById('txnDate');
    const txnDesc = document.getElementById('txnDesc');
    const txnAmount = document.getElementById('txnAmount');
    const txnContact = document.getElementById('txnContact');
    const txnAccount = document.getElementById('txnAccount');
    const txnPayrollCheckbox = document.getElementById('txnPayroll');
    const txnApplyWhtCheckbox = document.getElementById('txnApplyWht');
    const txnWhtRateInput = document.getElementById('txnWhtRate');
    const txnApplyVatCheckbox = document.getElementById('txnApplyVat');

    const txnDescLabel = document.getElementById('txnDescLabel');
    const txnAmountLabel = document.getElementById('txnAmountLabel');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');
    const fixedAssetsListDiv = document.getElementById('fixedAssetsList');

    const txnBankAccountSelect = document.getElementById('txnBankAccount');

    const btnInventoryAction = document.getElementById('btnInventoryAction');

    const computedRevenueInput = document.getElementById('computedRevenue');
    const computedExpensesInput = document.getElementById('computedExpenses');
    const computedDepreciationInput = document.getElementById('computedDepreciation');
    const computedNetProfitInput = document.getElementById('computedNetProfit');
    const computedCapitalAllowanceInput = document.getElementById('computedCapitalAllowance');
    const btnComputeTaxable = document.getElementById('btnComputeTaxable');

    // asset modal refs
    const assetModal = document.getElementById('assetModal');
    const assetNameInput = document.getElementById('assetName');
    const assetAccountSelect = document.getElementById('assetAccount');
    const assetCostInput = document.getElementById('assetCost');
    const assetDateInput = document.getElementById('assetDate');
    const assetLifeInput = document.getElementById('assetLife');
    const assetDepRateInput = document.getElementById('assetDepRate');
    const assetCapAllowRateInput = document.getElementById('assetCapAllowRate');
    const assetAccumInput = document.getElementById('assetAccum');
    const assetCancel = document.getElementById('assetCancel');
    const assetSave = document.getElementById('assetSave');
    const btnAddAsset = document.getElementById('btnAddAsset');

    // dispose modal refs
    const disposeModal = document.getElementById('disposeModal');
    const disposeAssetSelect = document.getElementById('disposeAssetSelect');
    const disposeDate = document.getElementById('disposeDate');
    const disposeProceeds = document.getElementById('disposeProceeds');
    const disposeCancel = document.getElementById('disposeCancel');
    const disposeConfirm = document.getElementById('disposeConfirm');
    const btnOpenDispose = document.getElementById('btnOpenDispose');

    // other controls
    const btnAddUser = document.getElementById('btnAddUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnAddAccountInline = document.getElementById('btnAddAccountInline');
    const btnAddContactInline = document.getElementById('btnAddContactInline');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');

    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function fmt(n){ n = Number(n)||0; return n.toLocaleString('en-NG', { maximumFractionDigits:2, minimumFractionDigits: (n%1===0?0:2) }); }

    function saveData(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){ console.error('save failed', e); alert('Save failed'); } }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try {
          data = JSON.parse(raw);
        } catch(e){
          console.warn('Invalid saved data, creating demo', e);
          initializeDemo();
        }
      }
      if (!data || !Array.isArray(data.users) || !Array.isArray(data.businesses)) initializeDemo();
      // normalize
      data.businesses.forEach(b=>{
        if (!Array.isArray(b.contacts)) b.contacts = [];
        if (!Array.isArray(b.accounts)) b.accounts = [];
        if (!Array.isArray(b.fixedAssets)) b.fixedAssets = [];
        if (!Array.isArray(b.inventory)) b.inventory = [];
        if (!Array.isArray(b.bankStatements)) b.bankStatements = [];
        if (!b.accountOpeningBalances) b.accountOpeningBalances = {};
        if (!data.transactions[b.id]) data.transactions[b.id] = [];
        if (!b.pit) b.pit = DEFAULT_PIT;
        if (!b.taxCarryforward) b.taxCarryforward = { capitalAllowances: 0, priorLosses: 0 };
        if (typeof b.vatRate !== 'number') b.vatRate = DEFAULT_VAT_RATE;
        if (typeof b.vatEnabled === 'undefined') b.vatEnabled = true;
        if (typeof b.pitEnabled === 'undefined') b.pitEnabled = true;
        if (!Array.isArray(b.bankAccounts)) b.bankAccounts = [];
        if (typeof b.citRate !== 'number') b.citRate = DEFAULT_CIT_RATE;
        if (typeof b.defaultWhtRate !== 'number') b.defaultWhtRate = DEFAULT_WHT_RATE;
        if (typeof b.defaultDepRate !== 'number') b.defaultDepRate = DEFAULT_DEP_RATE;
        if (typeof b.defaultCapAllowRate !== 'number') b.defaultCapAllowRate = DEFAULT_CAPALLOW_RATE;
        if (!b.type) b.type = 'product';
        // ensure existing transactions have taxes fields if missing
        const txs = data.transactions[b.id] || [];
        txs.forEach(t=>{
          if (!t.taxes) t.taxes = { vat: 0, wht: 0, paye: 0 };
          if (typeof t.bankAccountId === 'undefined') t.bankAccountId = '';
        });
      });
      if (!selectedUserId && data.users[0]) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses[0]) selectedBusinessId = data.businesses[0].id;
    }

    function initializeDemo(){
      const u = { id: uid('user'), username: 'demo', display: 'Demo User' };
      const b = {
        id: uid('biz'),
        name: 'Demo Business',
        ownerId: u.id,
        members: [u.id],
        vatRate: DEFAULT_VAT_RATE,
        currency: '₦',
        threshold: 800000,
        notes: '',
        vatEnabled: true,
        pitEnabled: true,
        vatInclusive: false,
        pit: DEFAULT_PIT,
        taxCarryforward: { capitalAllowances: 0, priorLosses: 0 },
        contacts: [],
        accounts: [],
        fixedAssets: [],
        inventory: [],
        bankAccounts: [],
        bankStatements: [],
        accountOpeningBalances: {},
        citRate: DEFAULT_CIT_RATE,
        defaultWhtRate: DEFAULT_WHT_RATE,
        defaultDepRate: DEFAULT_DEP_RATE,
        defaultCapAllowRate: DEFAULT_CAPALLOW_RATE,
        type: 'product'
      };

      const accounts = [
        { id: uid('a'), code: '1000', name: 'Cash / Bank', type: 'Bank' },
        { id: uid('a2'), code: '2000', name: 'Accounts Payable', type: 'Liability' },
        { id: uid('a3'), code: '4000', name: 'Sales Revenue', type: 'Revenue' },
        { id: uid('a4'), code: '5000', name: 'Rent Expense', type: 'Expense' },
        { id: uid('a5'), code: '5100', name: 'Purchases', type: 'Expense' },
        { id: uid('a6'), code: '5200', name: 'Cost of Goods Sold', type: 'Expense' }
      ];
      b.accounts = accounts;
      // mark bank account
      b.bankAccounts = [accounts[0].id];
      const now = new Date().toISOString().slice(0,10);
      data = { users: [u], businesses: [b], transactions: {} };
      data.transactions[b.id] = [
        { id: uid('t'), date: now, desc: 'Demo sale', amount: 1500000, authorUserId: u.id, contactId: '', accountId: accounts.find(a=>a.type==='Revenue').id, taxes: { vat: 0, wht: 0, paye: 0 }, bankAccountId: accounts[0].id },
        { id: uid('t2'), date: now, desc: 'Demo rent', amount: 200000, authorUserId: u.id, contactId: '', accountId: accounts.find(a=>a.code==='5000').id, taxes:{ vat:0,wht:0,paye:0 }, bankAccountId: accounts[0].id }
      ];
      selectedUserId = u.id;
      selectedBusinessId = b.id;
      saveData();
    }

    function findBiz(id){ return data.businesses.find(x=>x.id===id) || null; }
    function findAccount(bizId, accId){ const b = findBiz(bizId); if(!b) return null; return b.accounts.find(a=>a.id===accId) || null; }

    // Populate selectors
    function populateSelectors(){
      userSelect.innerHTML = '';
      businessSelect.innerHTML = '';
      data.users.forEach(u=>{ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); });
      data.businesses.forEach(b=>{ const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name; businessSelect.appendChild(opt); });
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      populateTaxYears();
      populateTxnContactAccount();
      renderAll();
      loadBusinessSettingsToUI();
    }

    function loadBusinessSettingsToUI(){
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessTypeSelect.value = b.type || 'product';
      businessCitRateInput.value = (typeof b.citRate === 'number') ? b.citRate : DEFAULT_CIT_RATE;
      businessWhtRateInput.value = (typeof b.defaultWhtRate === 'number') ? b.defaultWhtRate : DEFAULT_WHT_RATE;
      businessVatRateInput.value = (typeof b.vatRate === 'number') ? b.vatRate : DEFAULT_VAT_RATE;
      businessVatEnabledInput.checked = !!b.vatEnabled;
      // fill default txn WHT
      txnWhtRateInput.value = (typeof b.defaultWhtRate === 'number') ? b.defaultWhtRate : DEFAULT_WHT_RATE;
    }

    btnSaveBizSettings.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId);
      if (!b) { alert('Select business'); return; }
      b.type = businessTypeSelect.value;
      b.citRate = Number(businessCitRateInput.value) || DEFAULT_CIT_RATE;
      b.defaultWhtRate = Number(businessWhtRateInput.value) || DEFAULT_WHT_RATE;
      b.vatRate = Number(businessVatRateInput.value) || DEFAULT_VAT_RATE;
      b.vatEnabled = !!businessVatEnabledInput.checked;
      saveData(); renderAll(); alert('Business tax settings saved.');
    });

    function populateTaxYears(){
      const now = new Date(); const defaultYear = now.getFullYear() - 1;
      taxYearSelect.innerHTML = '';
      for (let y = defaultYear - 3; y <= defaultYear + 2; y++){
        const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y);
        if (y === defaultYear) opt.selected = true;
        taxYearSelect.appendChild(opt);
      }
    }

    function populateTxnContactAccount(){
      const b = findBiz(selectedBusinessId);
      if (txnContact) txnContact.innerHTML = '';
      if (txnAccount) txnAccount.innerHTML = '';
      if (assetAccountSelect) assetAccountSelect.innerHTML = '';
      if (disposeAssetSelect) disposeAssetSelect.innerHTML = '';
      if (txnBankAccountSelect) txnBankAccountSelect.innerHTML = '';

      if (!b) return;
      const emptyC = document.createElement('option'); emptyC.value=''; emptyC.textContent='-- select --'; txnContact.appendChild(emptyC);
      b.contacts.forEach(c=>{ const opt = document.createElement('option'); opt.value=c.id; opt.textContent=c.name + ' (' + (c.type||'') + ')'; txnContact.appendChild(opt); });

      const emptyA = document.createElement('option'); emptyA.value=''; emptyA.textContent='-- select --'; txnAccount.appendChild(emptyA);
      const emptyAssetAcct = document.createElement('option'); emptyAssetAcct.value=''; emptyAssetAcct.textContent='-- select --'; assetAccountSelect.appendChild(emptyAssetAcct);

      b.accounts.forEach(a=>{
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = (a.code||'') + ' - ' + a.name + ' (' + a.type + ')';
        txnAccount.appendChild(opt);

        const opt2 = opt.cloneNode(true);
        assetAccountSelect.appendChild(opt2);

        if (a.type === 'Bank' || a.code === '1000' || a.name.toLowerCase().includes('bank') || (b.bankAccounts||[]).includes(a.id)){
          const ba = document.createElement('option');
          ba.value = a.id;
          ba.textContent = (a.code||'') + ' - ' + a.name;
          txnBankAccountSelect.appendChild(ba);
        }
      });

      if (txnBankAccountSelect.children.length === 0){
        const found = b.accounts.find(a => a.code === '1000' || a.name.toLowerCase().includes('cash') || a.type === 'Bank');
        if (found){
          const ba = document.createElement('option');
          ba.value = found.id;
          ba.textContent = (found.code||'') + ' - ' + found.name;
          txnBankAccountSelect.appendChild(ba);
        } else if (b.accounts[0]){
          const ba = document.createElement('option');
          ba.value = b.accounts[0].id;
          ba.textContent = (b.accounts[0].code||'') + ' - ' + b.accounts[0].name;
          txnBankAccountSelect.appendChild(ba);
        }
      }

      // dispose assets select
      const e = document.createElement('option'); e.value=''; e.textContent='-- select asset --'; disposeAssetSelect.appendChild(e);
      b.fixedAssets.forEach(f=>{ const opt = document.createElement('option'); opt.value = f.id; opt.textContent = f.name + ' — cost ₦' + fmt(f.cost); disposeAssetSelect.appendChild(opt); });

      // set default depreciation/capallow in asset modal for new assets
      assetDepRateInput.value = b.defaultDepRate || DEFAULT_DEP_RATE;
      assetCapAllowRateInput.value = b.defaultCapAllowRate || DEFAULT_CAPALLOW_RATE;
    }

    // Add user/business/account/contact inline helpers
    btnAddUser.addEventListener('click', ()=>{
      const name = prompt('Enter user display name:','New User');
      if (!name) return;
      const u = { id: uid('user'), username: name.toLowerCase().replace(/\s+/g,'_'), display: name };
      data.users.push(u);
      selectedUserId = u.id;
      saveData(); populateSelectors();
    });

    btnAddBusiness.addEventListener('click', ()=>{
      const name = prompt('Enter business name:','New Business');
      if (!name) return;
      const b = {
        id: uid('biz'),
        name,
        ownerId: selectedUserId,
        members: [selectedUserId],
        vatRate: DEFAULT_VAT_RATE,
        currency: '₦',
        threshold: 800000,
        notes: '',
        vatEnabled: true,
        pitEnabled: true,
        vatInclusive: false,
        pit: DEFAULT_PIT,
        taxCarryforward: { capitalAllowances: 0, priorLosses: 0 },
        contacts: [],
        accounts: [],
        fixedAssets: [],
        inventory: [],
        bankAccounts: [],
        bankStatements: [],
        accountOpeningBalances: {},
        citRate: DEFAULT_CIT_RATE,
        defaultWhtRate: DEFAULT_WHT_RATE,
        defaultDepRate: DEFAULT_DEP_RATE,
        defaultCapAllowRate: DEFAULT_CAPALLOW_RATE,
        type: 'product'
      };
      data.businesses.push(b);
      data.transactions[b.id] = [];
      selectedBusinessId = b.id;
      saveData(); populateSelectors();
    });

    btnAddAccountInline.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) { alert('Select business first'); return; }
      const name = prompt('Account name (e.g., Sales Revenue):','New Account');
      if (!name) return;
      const type = prompt('Account type (Asset, Liability, Revenue, Expense, Equity, Bank):','Expense');
      const code = prompt('Account code (optional):','');
      const acc = { id: uid('acc'), code: code || '', name, type: type || 'Expense' };
      b.accounts.push(acc);
      if (acc.type === 'Bank') b.bankAccounts = b.bankAccounts || [], b.bankAccounts.push(acc.id);
      saveData(); populateTxnContactAccount(); renderAll();
    });

    btnAddContactInline.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) { alert('Select business first'); return; }
      const name = prompt('Contact name:','New Contact');
      if (!name) return;
      const type = prompt('Contact type (Customer, Supplier, Employee):','Customer');
      const c = { id: uid('c'), name, type };
      b.contacts.push(c);
      saveData(); populateTxnContactAccount(); renderAll();
    });

    // Inventory action
    btnInventoryAction.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId);
      if (!b) { alert('Select business first'); return; }
      const itemName = prompt('Inventory item name:');
      if (!itemName) return;
      const qtyStr = prompt('Quantity (number):','1');
      const qty = Number(qtyStr) || 0;
      const date = txnDate.value || new Date().toISOString().slice(0,10);
      const item = { id: uid('inv'), name: itemName, qty, date };
      b.inventory = b.inventory || [];
      b.inventory.push(item);
      saveData();
      alert('Inventory item added.');
    });

    // --- Transactions ---
    btnAddTxn.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId);
      if (!b){ alert('Select business'); return; }
      const date = txnDate.value || new Date().toISOString().slice(0,10);
      const desc = (txnDesc && txnDesc.value) || '';
      const amount = Number(txnAmount && txnAmount.value) || 0;
      const accountId = txnAccount.value || '';
      const contactId = txnContact.value || '';
      if (!accountId){ alert('Select account'); return; }

      const bankAccountId = txnBankAccountSelect.value || '';

      const applyWht = !!txnApplyWhtCheckbox.checked;
      const txnWhtRate = Number(txnWhtRateInput.value) || b.defaultWhtRate || DEFAULT_WHT_RATE;
      const applyVat = !!txnApplyVatCheckbox.checked && !!b.vatEnabled;
      const vatRate = Number(b.vatRate) || DEFAULT_VAT_RATE;

      // compute taxes
      const taxes = { vat: 0, wht: 0, paye: 0 };
      if (applyVat && amount > 0){
        taxes.vat = +(amount * (vatRate/100));
      }
      if (applyWht && amount > 0){
        taxes.wht = +(amount * (txnWhtRate/100));
      }
      // PAYE - only if payroll flagged; keep 0 as placeholder
      if (txnPayrollCheckbox.checked && amount > 0){
        taxes.paye = 0;
      }

      const t = {
        id: uid('t'),
        date,
        desc,
        amount,
        authorUserId: selectedUserId,
        contactId,
        accountId,
        taxes,
        bankAccountId
      };

      data.transactions[selectedBusinessId] = data.transactions[selectedBusinessId] || [];
      data.transactions[selectedBusinessId].push(t);
      saveData();
      clearTxnForm();
      renderAll();
    });

    function clearTxnForm(){
      txnDate.value = '';
      txnDesc.value = '';
      txnAmount.value = '';
      txnContact.value = '';
      txnAccount.value = '';
      txnPayrollCheckbox.checked = false;
      txnApplyWhtCheckbox.checked = false;
      txnApplyVatCheckbox.checked = false;
      txnWhtRateInput.value = '';
    }

    // Render ledger and summaries
    function renderAll(){
      renderLedger();
      renderTotalsAndTaxSummary();
      renderAssetsList();
      computeAndPopulateComputedFields();
    }

    function renderLedger(filterText=''){
      ledgerTbody.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const txs = (data.transactions[b.id] || []).slice().sort((a,b2)=> (b2.date||'') < (a.date||'') ? 1 : -1);
      const search = String(filterText || '').trim().toLowerCase();
      txs.forEach(t=>{
        if (search){
          const concat = ((t.desc||'') + ' ' + (findAccount(b.id, t.accountId) && findAccount(b.id, t.accountId).name || '')).toLowerCase();
          if (!concat.includes(search)) return;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="nowrap">${t.date || ''}</td>
                        <td>${escapeHtml(t.desc || '')}</td>
                        <td>${escapeHtml((findAccount(b.id, t.accountId) && findAccount(b.id, t.accountId).name) || '')}</td>
                        <td class="nowrap">₦ ${fmt(t.amount)}</td>
                        <td>${escapeHtml((b.contacts.find(c=>c.id===t.contactId) || {}).name || '')}</td>
                        <td class="nowrap">${escapeHtml((findAccount(b.id, t.bankAccountId) || {}).name || '')}</td>
                        <td class="nowrap">₦ ${fmt(t.taxes && t.taxes.vat)}</td>
                        <td class="nowrap">₦ ${fmt(t.taxes && t.taxes.wht)}</td>
                        <td class="nowrap">₦ ${fmt(t.taxes && t.taxes.paye)}</td>
                        <td class="nowrap"><button class="small" data-id="${t.id}" onclick="deleteTxn('${t.id}')">Delete</button></td>`;
        ledgerTbody.appendChild(tr);
      });
    }

    function deleteTxn(id){
      if(!confirm('Delete transaction?')) return;
      const b = findBiz(selectedBusinessId);
      if(!b) return;
      data.transactions[b.id] = (data.transactions[b.id] || []).filter(t=>t.id !== id);
      saveData(); renderAll();
    }

    function renderTotalsAndTaxSummary(){
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const txs = data.transactions[b.id] || [];
      const totals = txs.reduce((acc, t)=>{
        acc.amount += Number(t.amount) || 0;
        acc.vat += Number((t.taxes && t.taxes.vat) || 0);
        acc.wht += Number((t.taxes && t.taxes.wht) || 0);
        acc.paye += Number((t.taxes && t.taxes.paye) || 0);
        return acc;
      }, { amount:0, vat:0, wht:0, paye:0 });

      totalsSummaryDiv.innerHTML = `<div class="result-row"><div><strong>Total transactions</strong></div><div>₦ ${fmt(totals.amount)}</div></div>
                                    <div class="result-row"><div><strong>Total VAT</strong></div><div>₦ ${fmt(totals.vat)}</div></div>
                                    <div class="result-row"><div><strong>Total WHT</strong></div><div>₦ ${fmt(totals.wht)}</div></div>
                                    <div class="result-row"><div><strong>Total PAYE</strong></div><div>₦ ${fmt(totals.paye)}</div></div>`;

      taxSummaryDiv.innerHTML = `<div class="muted">VAT Rate: ${b.vatRate}% (enabled: ${b.vatEnabled ? 'yes' : 'no'}) · CIT: ${b.citRate}% · Default WHT: ${b.defaultWhtRate}%</div>`;
    }

    // Compute revenue/expenses/dep/capital allowance
    function computeAndPopulateComputedFields(){
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const txs = data.transactions[b.id] || [];
      let revenue = 0, expenses = 0;
      txs.forEach(t=>{
        const acc = findAccount(b.id, t.accountId);
        if (!acc) return;
        if ((acc.type || '').toLowerCase() === 'revenue') revenue += Number(t.amount) || 0;
        if ((acc.type || '').toLowerCase() === 'expense') expenses += Number(t.amount) || 0;
      });

      // Depreciation: sum of asset.cost * depRate%
      const depreciation = (b.fixedAssets || []).reduce((s, a) => {
        const rate = Number(a.depRate) || Number(b.defaultDepRate) || DEFAULT_DEP_RATE;
        return s + (Number(a.cost) || 0) * (rate/100);
      }, 0);

      // Capital allowance: sum of asset.cost * capAllowRate%
      const capitalAllowances = (b.fixedAssets || []).reduce((s, a) => {
        const rate = Number(a.capAllowRate) || Number(b.defaultCapAllowRate) || DEFAULT_CAPALLOW_RATE;
        return s + (Number(a.cost) || 0) * (rate/100);
      }, 0);

      const netProfit = revenue - expenses - depreciation;

      computedRevenueInput.value = fmt(revenue);
      computedExpensesInput.value = fmt(expenses);
      computedDepreciationInput.value = fmt(depreciation);
      computedNetProfitInput.value = fmt(netProfit);
      computedCapitalAllowanceInput.value = fmt(capitalAllowances);
    }

    // Assets
    function renderAssetsList(){
      const b = findBiz(selectedBusinessId);
      fixedAssetsListDiv.innerHTML = '';
      if (!b) return;
      b.fixedAssets.forEach(f=>{
        const div = document.createElement('div');
        div.className = 'asset-row';
        div.innerHTML = `<div class="asset-left"><strong>${escapeHtml(f.name)}</strong><div class="small-muted">Cost ₦${fmt(f.cost)} · Accum ₦${fmt(f.accumulatedDep || 0)} · Life ${f.lifeYears || DEFAULT_USEFUL_LIFE_YEARS} yrs · Dep % ${fmt(f.depRate)} · CapAllow % ${fmt(f.capAllowRate)}</div></div>
                         <div class="actions"><button class="small" onclick="editAsset('${f.id}')">Edit</button><button class="small danger" onclick="removeAsset('${f.id}')">Remove</button></div>`;
        fixedAssetsListDiv.appendChild(div);
      });
    }

    window.editAsset = function(id){
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const f = b.fixedAssets.find(x=>x.id===id);
      if(!f) return;
      assetModal.style.display = 'block';
      document.getElementById('modalOverlay').style.display = 'block';
      assetNameInput.value = f.name || '';
      assetAccountSelect.value = f.accountId || '';
      assetCostInput.value = f.cost || '';
      assetDateInput.value = f.dateAcquired || '';
      assetLifeInput.value = f.lifeYears || DEFAULT_USEFUL_LIFE_YEARS;
      assetDepRateInput.value = f.depRate || b.defaultDepRate || DEFAULT_DEP_RATE;
      assetCapAllowRateInput.value = f.capAllowRate || b.defaultCapAllowRate || DEFAULT_CAPALLOW_RATE;
      assetAccumInput.value = f.accumulatedDep || 0;
      assetSave.dataset.editId = f.id;
    }

    window.removeAsset = function(id){
      if(!confirm('Remove asset?')) return;
      const b = findBiz(selectedBusinessId);
      if(!b) return;
      b.fixedAssets = b.fixedAssets.filter(a=>a.id!==id);
      saveData(); renderAll();
    }

    btnAddAsset.addEventListener('click', ()=>{
      assetModal.style.display = 'block';
      document.getElementById('modalOverlay').style.display = 'block';
      assetNameInput.value = '';
      assetAccountSelect.value = '';
      assetCostInput.value = '';
      assetDateInput.value = '';
      assetLifeInput.value = DEFAULT_USEFUL_LIFE_YEARS;
      const b = findBiz(selectedBusinessId);
      assetDepRateInput.value = (b && b.defaultDepRate) || DEFAULT_DEP_RATE;
      assetCapAllowRateInput.value = (b && b.defaultCapAllowRate) || DEFAULT_CAPALLOW_RATE;
      assetAccumInput.value = 0;
      delete assetSave.dataset.editId;
    });

    assetCancel.addEventListener('click', closeAssetModal);
    function closeAssetModal(){ assetModal.style.display = 'none'; document.getElementById('modalOverlay').style.display = 'none'; delete assetSave.dataset.editId; }

    assetSave.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if(!b) return;
      const name = assetNameInput.value || 'Asset';
      const acct = assetAccountSelect.value || '';
      const cost = Number(assetCostInput.value) || 0;
      const date = assetDateInput.value || new Date().toISOString().slice(0,10);
      const life = Number(assetLifeInput.value) || DEFAULT_USEFUL_LIFE_YEARS;
      const depRate = Number(assetDepRateInput.value) || b.defaultDepRate || DEFAULT_DEP_RATE;
      const capAllowRate = Number(assetCapAllowRateInput.value) || b.defaultCapAllowRate || DEFAULT_CAPALLOW_RATE;
      const accum = Number(assetAccumInput.value) || 0;

      if (assetSave.dataset.editId){
        const f = b.fixedAssets.find(x=>x.id===assetSave.dataset.editId);
        if (!f) return;
        f.name = name; f.accountId = acct; f.cost = cost; f.dateAcquired = date; f.lifeYears = life; f.depRate = depRate; f.capAllowRate = capAllowRate; f.accumulatedDep = accum;
      } else {
        const f = { id: uid('fa'), name, accountId: acct, cost, dateAcquired: date, lifeYears: life, depRate, capAllowRate, accumulatedDep: accum };
        b.fixedAssets.push(f);
      }
      saveData();
      closeAssetModal();
      renderAll();
    });

    // Dispose asset
    btnOpenDispose.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if(!b) return;
      disposeModal.style.display = 'block';
      document.getElementById('modalOverlay').style.display = 'block';
      disposeDate.value = '';
      disposeProceeds.value = '';
    });

    disposeCancel.addEventListener('click', ()=>{ disposeModal.style.display = 'none'; document.getElementById('modalOverlay').style.display = 'none'; });
    disposeConfirm.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if(!b) return;
      const assetId = disposeAssetSelect.value;
      if (!assetId){ alert('Select asset'); return; }
      const a = b.fixedAssets.find(x=>x.id===assetId);
      if(!a) return;
      const proceeds = Number(disposeProceeds.value) || 0;
      // create disposal transaction (simple)
      const t = { id: uid('t'), date: disposeDate.value || new Date().toISOString().slice(0,10), desc: `Dispose ${a.name}`, amount: proceeds, authorUserId: selectedUserId, contactId:'', accountId: a.accountId || '', taxes:{ vat:0,wht:0,paye:0 }, bankAccountId: (b.bankAccounts && b.bankAccounts[0]) || '' };
      data.transactions[b.id] = data.transactions[b.id] || [];
      data.transactions[b.id].push(t);
      // Remove asset
      b.fixedAssets = b.fixedAssets.filter(x=>x.id!==assetId);
      saveData();
      disposeModal.style.display = 'none';
      document.getElementById('modalOverlay').style.display = 'none';
      renderAll();
    });

    // Taxable income calculations (computed fields)
    btnComputeTaxable.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if(!b) return;
      // ensure computed fields are up-to-date
      computeAndPopulateComputedFields();

      const revenue = Number(computedRevenueInput.value.replace(/,/g,'')) || 0;
      const expenses = Number(computedExpensesInput.value.replace(/,/g,'')) || 0;
      const depreciation = Number(computedDepreciationInput.value.replace(/,/g,'')) || 0;
      const capitalAllowances = Number(computedCapitalAllowanceInput.value.replace(/,/g,'')) || 0;

      const netProfit = revenue - expenses - depreciation;

      const taxable = Math.max(0, netProfit - capitalAllowances);

      document.getElementById('taxableResult').style.display = 'block';
      document.getElementById('taxableResultValue').textContent = fmt(taxable);
      const breakdown = document.getElementById('taxableBreakdown');
      breakdown.innerHTML = `<div class="muted">Revenue: ₦ ${fmt(revenue)}</div>
                             <div class="muted">Expenses: ₦ ${fmt(expenses)}</div>
                             <div class="muted">Depreciation: ₦ ${fmt(depreciation)}</div>
                             <div class="muted">Net profit: ₦ ${fmt(netProfit)}</div>
                             <div class="muted">Capital allowances: ₦ ${fmt(capitalAllowances)}</div>`;

      // CIT
      const cit = taxable * (Number(b.citRate || DEFAULT_CIT_RATE)/100);
      document.getElementById('citResult').style.display = 'block';
      document.getElementById('citValue').textContent = fmt(cit);
      document.getElementById('citNotes').textContent = `CIT at ${b.citRate}% on taxable income.`;

      // PIT - only shown as estimate if PIT enabled
      if (b.pitEnabled){
        const pit = computePIT(taxable, b.pit || DEFAULT_PIT);
        document.getElementById('pitResult').style.display = 'block';
        document.getElementById('pitAnnualValue').textContent = fmt(pit);
        document.getElementById('pitMonthlyValue').textContent = fmt(pit/12);
        document.getElementById('pitNotes').textContent = 'PIT estimated from taxable base (simple approximation).';
      } else {
        document.getElementById('pitResult').style.display = 'none';
      }
    });

    function computePIT(amount, pitConfig){
      if (!pitConfig) return 0;
      // simple approach: apply slices sequentially
      let total = 0;
      const slices = pitConfig.slices || DEFAULT_PIT.slices;
      const threshold = pitConfig.threshold || DEFAULT_PIT.threshold;
      if (amount <= threshold) return 0;
      for (let i=0;i<slices.length;i++){
        const s = slices[i];
        const prevUpTo = (i===0) ? threshold : slices[i-1].upTo;
        const slabAmount = Math.max(0, Math.min(amount, s.upTo) - prevUpTo);
        if (slabAmount > 0){
          total += slabAmount * (s.rate || 0);
        }
        if (amount <= s.upTo) break;
      }
      return total;
    }

    // Utility
    function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }

    // Search handlers
    btnSearch.addEventListener('click', ()=>{ renderLedger(document.getElementById('ledgerSearch').value); });
    btnClearSearch.addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

    // Selection change handlers
    userSelect.addEventListener('change', ()=>{ selectedUserId = userSelect.value; saveData(); });
    businessSelect.addEventListener('change', ()=>{
      selectedBusinessId = businessSelect.value;
      saveData();
      populateTxnContactAccount();
      loadBusinessSettingsToUI();
      renderAll();
    });

    // Export / Import / Clear
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const dump = JSON.stringify(data, null, 2);
      const blob = new Blob([dump], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'ntc-data.json';
      a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('btnImport').addEventListener('click', ()=>{ document.getElementById('fileInput').click(); });
    document.getElementById('fileInput').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = (ev)=>{
        try {
          const imported = JSON.parse(ev.target.result);
          data = imported;
          saveData();
          loadData();
          populateSelectors();
        } catch(err){ alert('Invalid JSON file'); }
      };
      r.readAsText(f);
    });
    document.getElementById('btnClearAll').addEventListener('click', ()=>{
      if (!confirm('Clear all data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      initializeDemo();
      loadData();
      populateSelectors();
      renderAll();
    });

    // Initialize
    loadData();
    populateSelectors();

  </script>
</body>
</html>

If you'd like, I can:
- Commit this updated index.html to a new branch in your repository and open a pull request (I can do that if you confirm the branch/PR details).
- Change how depreciation is calculated (e.g., pro-rate by acquisition month or use accumulatedDep instead).
- Make the inventory form/modal more detailed (account link, cost, unit price, etc.) instead of the simple prompt.

Confirm next steps (commit/PR or further adjustments) and I'll proceed.
