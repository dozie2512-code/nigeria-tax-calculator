<!-- index.html - Nigeria Tax Calculator (with VAT & PIT summaries in reports and exports) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ... [head content unchanged] ... -->
</head>
<body>
  <!-- ... [existing page markup unchanged] ... -->

  <script>
    // ... [existing JS code up to helpers] ...

    // --- VAT AND PIT SUMMARY HELPERS (added) ---

    // Compute VAT summary for a business in a date range
    function computeVatSummary(biz, transactions, dateFrom, dateTo) {
      if (!biz || !biz.vatEnabled) return { collected: 0, paid: 0, net: 0 };
      let collected = 0, paid = 0;
      const vatRate = Number(biz.vatRate) || 0;
      for (const t of transactions) {
        // Date filter
        if (dateFrom && t.date < dateFrom) continue;
        if (dateTo && t.date > dateTo) continue;
        if (t.type === 'Income') collected += Number(t.amount) * vatRate / 100;
        if (t.type === 'Expense') paid += Number(t.amount) * vatRate / 100;
      }
      return {
        collected,
        paid,
        net: collected - paid
      };
    }

    // Compute PIT summary for a business in a date range
    function computePitSummary(biz, transactions, dateFrom, dateTo) {
      if (!biz || !biz.pitEnabled) return {
        taxableIncome: 0,
        totalTax: 0,
        slices: []
      };
      const pit = biz.pit || DEFAULT_PIT;
      let taxableIncome = 0;
      // Find contacts for type check
      const contactsById = {};
      if (Array.isArray(biz.contacts)) for (const c of biz.contacts) contactsById[c.id] = c;
      for (const t of transactions) {
        if (t.type !== 'Income') continue;
        if (dateFrom && t.date < dateFrom) continue;
        if (dateTo && t.date > dateTo) continue;
        // Salary or Bonus, or contact is Employee
        const cat = (t.category || '').toLowerCase();
        const contactType = t.contactId && contactsById[t.contactId] ? (contactsById[t.contactId].type || '').toLowerCase() : '';
        if (cat === 'salary' || cat === 'bonus' || contactType === 'employee') {
          taxableIncome += Number(t.amount) || 0;
        }
      }
      // Apply threshold
      const threshold = typeof biz.threshold === 'number' ? biz.threshold : (pit.threshold || 0);
      let toTax = Math.max(0, taxableIncome - threshold);

      let totalTax = 0;
      let prev = 0;
      const slices = [];
      for (const s of pit.slices) {
        const upTo = Math.min(s.upTo, toTax + threshold) - prev;
        if (upTo <= 0) break;
        const sliceAmt = Math.min(upTo, toTax);
        const taxForSlice = sliceAmt * s.rate;
        if (sliceAmt > 0) {
          slices.push({
            sliceLabel: `₦${formatMoney(prev + 1)} – ₦${formatMoney(s.upTo)}`,
            taxableInSlice: sliceAmt,
            taxForSlice
          });
        }
        totalTax += taxForSlice;
        prev = s.upTo;
        toTax -= sliceAmt;
        if (toTax <= 0) break;
      }
      return {
        taxableIncome,
        totalTax,
        slices
      };
    }

    // ... [existing code unchanged up to report generation] ...

    // --- REPORT GENERATION UI (modified) ---

    btnGenerateReport.addEventListener('click', ()=>{
      // ... [existing code to get biz, transactions, filters] ...
      const biz = findBiz(selectedBusinessId);
      if (!biz) { reportOutput.innerHTML = '<div class="muted">No business selected.</div>'; return; }
      const txs = Array.isArray(data.transactions[biz.id]) ? data.transactions[biz.id].slice() : [];
      // Filter by date range
      let from = (reportDateFrom.value||'').trim();
      let to = (reportDateTo.value||'').trim();
      if (from && !/^\d{4}-\d{2}-\d{2}$/.test(from)) from = '';
      if (to && !/^\d{4}-\d{2}-\d{2}$/.test(to)) to = '';
      const displayTxs = txs.filter(t=>{
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        return true;
      });

      // --- NEW: VAT and PIT summaries
      const vatSummary = computeVatSummary(biz, displayTxs, from, to);
      const pitSummary = computePitSummary(biz, displayTxs, from, to);

      // ... [existing code: prepare report table/summary based on reportType] ...

      let html = '';

      // [existing: build report table for ledger]

      // --- Add VAT and PIT summary to report output ---
      html += `<div class="vat-summary"><strong>VAT Summary</strong><br>`;
      if (!biz.vatEnabled) {
        html += `<span>VAT: <em>Disabled for this business</em></span>`;
      } else {
        html += `VAT Collected: <strong>₦${formatMoney(vatSummary.collected)}</strong><br>`;
        html += `VAT Paid: <strong>₦${formatMoney(vatSummary.paid)}</strong><br>`;
        html += `VAT Net: <strong>₦${formatMoney(vatSummary.net)}</strong>`;
      }
      html += `</div>`;

      html += `<div class="tax-summary"><strong>PIT (Personal Income Tax) Summary</strong><br>`;
      if (!biz.pitEnabled) {
        html += `<span>PIT: <em>Disabled for this business</em></span>`;
      } else {
        html += `Taxable Income: <strong>₦${formatMoney(pitSummary.taxableIncome)}</strong><br>`;
        html += `Total PIT: <strong>₦${formatMoney(pitSummary.totalTax)}</strong><br>`;
        if (pitSummary.slices && pitSummary.slices.length) {
          html += `<u>Breakdown:</u><br>`;
          for (const s of pitSummary.slices) {
            html += `&nbsp;&nbsp;${s.sliceLabel}: <b>₦${formatMoney(s.taxableInSlice)}</b> taxed, PIT: <b>₦${formatMoney(s.taxForSlice)}</b><br>`;
          }
        }
      }
      html += `</div>`;

      reportOutput.innerHTML = html;

      // ... [rest of report output, e.g. ledger table, unchanged] ...
    });

    // --- EXPORT HANDLERS (HTML/CSV/JSON, modified) ---

    btnExportHtml.addEventListener('click', ()=>{
      // ... [get biz, transactions, filters as above] ...
      const biz = findBiz(selectedBusinessId);
      const txs = Array.isArray(data.transactions[biz.id]) ? data.transactions[biz.id].slice() : [];
      let from = (reportDateFrom.value||'').trim();
      let to = (reportDateTo.value||'').trim();
      // ... [filter displayTxs as above] ...
      const displayTxs = txs.filter(t=>{
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        return true;
      });
      const vatSummary = computeVatSummary(biz, displayTxs, from, to);
      const pitSummary = computePitSummary(biz, displayTxs, from, to);

      let html = '<h2>Report</h2>';
      // ... [existing: ledger table, etc.] ...

      html += `<div><strong>VAT Summary:</strong> Collected: ₦${formatMoney(vatSummary.collected)}, Paid: ₦${formatMoney(vatSummary.paid)}, Net: ₦${formatMoney(vatSummary.net)}</div>`;
      html += `<div><strong>PIT Summary:</strong> Taxable: ₦${formatMoney(pitSummary.taxableIncome)}, Total PIT: ₦${formatMoney(pitSummary.totalTax)}</div>`;
      if (pitSummary.slices && pitSummary.slices.length) {
        html += `<div>`;
        for (const s of pitSummary.slices) {
          html += `${s.sliceLabel}: ₦${formatMoney(s.taxableInSlice)} taxed, PIT: ₦${formatMoney(s.taxForSlice)}<br>`;
        }
        html += `</div>`;
      }
      // ... [export html logic unchanged] ...
    });

    btnExportCsv.addEventListener('click', ()=>{
      // ... [get biz, transactions, filters as above] ...
      const biz = findBiz(selectedBusinessId);
      const txs = Array.isArray(data.transactions[biz.id]) ? data.transactions[biz.id].slice() : [];
      let from = (reportDateFrom.value||'').trim();
      let to = (reportDateTo.value||'').trim();
      // ... [filter displayTxs as above] ...
      const displayTxs = txs.filter(t=>{
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        return true;
      });
      const vatSummary = computeVatSummary(biz, displayTxs, from, to);
      const pitSummary = computePitSummary(biz, displayTxs, from, to);

      // ... [existing: build csv rows for ledger] ...
      // At the end:
      let csv = "";
      // ... [existing csv rows] ...
      csv += `\nVAT Collected,${vatSummary.collected}\nVAT Paid,${vatSummary.paid}\nVAT Net,${vatSummary.net}`;
      csv += `\nPIT Taxable Income,${pitSummary.taxableIncome}\nTotal PIT,${pitSummary.totalTax}`;
      if (pitSummary.slices && pitSummary.slices.length) {
        for (const s of pitSummary.slices) {
          csv += `\nPIT ${s.sliceLabel} Taxed,${s.taxableInSlice},PIT,${s.taxForSlice}`;
        }
      }
      // ... [export csv logic unchanged] ...
    });

    btnExportJson.addEventListener('click', ()=>{
      // ... [get biz, transactions, filters as above] ...
      const biz = findBiz(selectedBusinessId);
      const txs = Array.isArray(data.transactions[biz.id]) ? data.transactions[biz.id].slice() : [];
      let from = (reportDateFrom.value||'').trim();
      let to = (reportDateTo.value||'').trim();
      // ... [filter displayTxs as above] ...
      const displayTxs = txs.filter(t=>{
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        return true;
      });
      const vatSummary = computeVatSummary(biz, displayTxs, from, to);
      const pitSummary = computePitSummary(biz, displayTxs, from, to);

      const reportObj = {
        business: biz.name,
        dateFrom: from,
        dateTo: to,
        vatSummary,
        pitSummary,
        transactions: displayTxs
      };
      // ... [export JSON logic unchanged] ...
    });

    // ... [rest of JS unchanged] ...
  </script>
</body>
</html>
