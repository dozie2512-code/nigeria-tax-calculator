GitHub Copilot Chat Assistant — updated index.html below.
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(520px,96vw); }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <label>Type:
          <select id="txnType">
            <option value="Income">Income (Sales)</option>
            <option value="Expense">Expense (Purchase)</option>
            <option value="COGS">COGS (Cost of Goods Sold)</option>
            <option value="Deduction">Deduction</option>
          </select>
        </label>
        <label>Category:
          <select id="txnCategory">
            <option>Pension</option>
            <option>NHF</option>
            <option>Insurance</option>
            <option>Salary</option>
            <option>Bonus</option>
            <option>Freelance</option>
            <option>Food</option>
            <option>Transport</option>
            <option>Rent</option>
            <option>Utilities</option>
            <option>Other</option>
          </select>
        </label>
        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
        <label><input type="checkbox" id="txnWhtApplied" /> WHT Applied</label>
        <label><input type="checkbox" id="txnDepreciable" /> Depreciable (capital allowance)</label>
        <label id="txnUsefulLifeLabel" style="display:none;">Useful life (yrs): <input type="number" id="txnUsefulLife" min="1" step="1" placeholder="Optional" style="width:80px;" /></label>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved per selected user and business. VAT rate & tax rules are per business (editable in Business settings). Use the search & pagination controls below to filter and navigate transactions.</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/type/category/description/amount" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf; border-radius:4px;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount (₦)</th>
            <th>VAT (₦)</th>
            <th>WHT (₦)</th>
            <th>Cap. Allow.</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="userNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
    </div>
    <div class="row">
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label>WHT rate (%): <input type="number" id="bizWhtRate" min="0" step="0.1" /></label>
      <label>CIT rate (%): <input type="number" id="bizCitRate" min="0" step="0.1" /></label>
      <label>Default useful life (yrs): <input type="number" id="bizDefaultUsefulLife" min="1" step="1" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (tax)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
    <small class="note">VAT & PIT toggles control whether VAT and personal income tax are computed for this business. VAT rate will be used to compute VAT per business. PIT logic defaults to Nigeria 2026 slices unless overridden programmatically. WHT (Withholding Tax) and CIT (Company Income Tax) rates can be customized per business.</small>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>
    <label>Type:
      <select id="editTxnType">
        <option value="Income">Income (Sales)</option>
        <option value="Expense">Expense (Purchase)</option>
        <option value="COGS">COGS (Cost of Goods Sold)</option>
        <option value="Deduction">Deduction</option>
      </select>
    </label><br/>
    <label>Category:
      <select id="editTxnCategory">
        <option>Pension</option>
        <option>NHF</option>
        <option>Insurance</option>
        <option>Salary</option>
        <option>Bonus</option>
        <option>Freelance</option>
        <option>Food</option>
        <option>Transport</option>
        <option>Rent</option>
        <option>Utilities</option>
        <option>Other</option>
      </select>
    </label><br/>
    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>
    <label><input type="checkbox" id="editTxnWhtApplied" /> WHT Applied</label><br/>
    <label><input type="checkbox" id="editTxnDepreciable" /> Depreciable (capital allowance)</label><br/>
    <label id="editTxnUsefulLifeLabel" style="display:none;">Useful life (yrs): <input type="number" id="editTxnUsefulLife" min="1" step="1" placeholder="Optional" style="width:80px;" /></label><br/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button onclick="closeEditModal()">Cancel</button>
      <button class="primary" onclick="saveEdit()">Save</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant
    // Data model in localStorage key 'ntc_data_v1'
    const STORAGE_KEY = 'ntc_data_v1';

    // Default PIT slices (Nigeria 2026 used in original). Will be used by computeTax unless overridden.
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },  // slice from threshold up to 3,000,000
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    // In-memory state
    let data = {
      users: [],
      businesses: [],
      transactions: {} // { userId: { businessId: [ txns ] } }
    };

    let selectedUserId = null;
    let selectedBusinessId = null;

    // Transaction edit state
    let editIndex = null;

    // Ledger UI state
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';
    let ledgerFiltered = []; // filtered txns used for pagination and summaries

    // Utilities
    function uid(prefix='id') { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          // basic validation
          if (parsed && typeof parsed === 'object') {
            data = parsed;
            if (!data.users) data.users = [];
            if (!data.businesses) data.businesses = [];
            if (!data.transactions) data.transactions = {};
            // *** BACKWARDS COMPATIBILITY: Set defaults for new business properties ***
            data.businesses.forEach(b => {
              if (typeof b.whtRate === 'undefined') b.whtRate = 5.0;
              if (typeof b.citRate === 'undefined') b.citRate = 30.0;
              if (typeof b.defaultUsefulLife === 'undefined') b.defaultUsefulLife = 5;
              if (typeof b.payeEnabled === 'undefined') b.payeEnabled = false;
            });
            return;
          }
        } catch(e) {
          console.error('Invalid saved data', e);
        }
      }
      // initialize with a demo user and business if empty
      const userId = uid('user');
      const bizId = uid('biz');
      data = {
        users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{ 
          id: bizId, 
          name: 'Demo Business', 
          ownerId: userId, 
          vatRate: 7.5, 
          currency: '₦', 
          threshold: 800000, 
          notes: 'Sample business', 
          vatEnabled: true, 
          pitEnabled: true,
          whtRate: 5.0,
          citRate: 30.0,
          defaultUsefulLife: 5,
          payeEnabled: false
        }],
        transactions: { [userId]: { [bizId]: [
          { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Income', category: 'Freelance', desc: 'Demo sale', amount: 1500000 },
          { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Expense', category: 'Rent', desc: 'Office rent', amount: 200000 }
        ] } }
      };
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }

    // UI wiring
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    // User modal elements
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userNotes = document.getElementById('userNotes');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    // Business modal elements
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwner = document.getElementById('bizOwner');
    const bizVat = document.getElementById('bizVat');
    const bizCurrency = document.getElementById('bizCurrency');
    const bizThreshold = document.getElementById('bizThreshold');
    const bizNotes = document.getElementById('bizNotes');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizWhtRate = document.getElementById('bizWhtRate');
    const bizCitRate = document.getElementById('bizCitRate');
    const bizDefaultUsefulLife = document.getElementById('bizDefaultUsefulLife');
    const bizPayeEnabled = document.getElementById('bizPayeEnabled');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');

    // Edit transaction modal
    const editModal = document.getElementById('editModal');
    const editTxnDate = document.getElementById('editTxnDate');
    const editTxnType = document.getElementById('editTxnType');
    const editTxnCategory = document.getElementById('editTxnCategory');
    const editTxnDesc = document.getElementById('editTxnDesc');
    const editTxnAmount = document.getElementById('editTxnAmount');
    const editTxnWhtApplied = document.getElementById('editTxnWhtApplied');
    const editTxnDepreciable = document.getElementById('editTxnDepreciable');
    const editTxnUsefulLife = document.getElementById('editTxnUsefulLife');
    const editTxnUsefulLifeLabel = document.getElementById('editTxnUsefulLifeLabel');

    // Search & pagination UI
    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    // Export/Import UI
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // State for modals: editing vs adding
    let userEditingId = null;
    let bizEditingId = null;

    // Initialization
    loadData();
    refreshUserBusinessSelectors();
    ensureSelection();
    currentPage = 1;
    renderLedger();
    calculateSummary();

    // *** DEPRECIABLE CHECKBOX HANDLERS ***
    // Add transaction form: show/hide useful life input based on depreciable checkbox
    const txnDepreciable = document.getElementById('txnDepreciable');
    const txnUsefulLifeLabel = document.getElementById('txnUsefulLifeLabel');
    txnDepreciable.addEventListener('change', () => {
      txnUsefulLifeLabel.style.display = txnDepreciable.checked ? '' : 'none';
    });
    // Edit transaction modal: show/hide useful life input based on depreciable checkbox
    editTxnDepreciable.addEventListener('change', () => {
      editTxnUsefulLifeLabel.style.display = editTxnDepreciable.checked ? '' : 'none';
    });

    // --- User & Business management functions ---
    function refreshUserBusinessSelectors() {
      // Users
      userSelect.innerHTML = '';
      data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = (u.display || u.username) + ' (' + u.username + ')';
        userSelect.appendChild(opt);
      });
      // Businesses
      businessSelect.innerHTML = '';
      data.businesses.forEach(b => {
        const owner = findUser(b.ownerId);
        const enabledParts = [];
        if (b.vatEnabled) enabledParts.push('VAT');
        if (b.pitEnabled) enabledParts.push('PIT');
        const status = enabledParts.length ? ' — ' + enabledParts.join('/') : '';
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name} ${owner ? ' — ' + (owner.display || owner.username) : ''} (${b.vatRate}% VAT)${status}`;
        businessSelect.appendChild(opt);
      });
      // populate bizOwner select for business modal
      bizOwner.innerHTML = '';
      data.users.forEach(u => {
        const o = document.createElement('option');
        o.value = u.id;
        o.textContent = (u.display || u.username);
        bizOwner.appendChild(o);
      });

      // set selected values if still available, else pick first
      if (!data.users.find(u=>u.id===selectedUserId)) selectedUserId = data.users.length ? data.users[0].id : null;
      if (!data.businesses.find(b=>b.id===selectedBusinessId)) selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;

      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function ensureSelection() {
      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length) selectedBusinessId = data.businesses[0].id;
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function openModal(modal) {
      modalOverlay.style.display = 'block';
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal) {
      modalOverlay.style.display = 'none';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      // clear editing state
      userEditingId = null;
      bizEditingId = null;
    }

    // --- Users ---
    btnAddUser.addEventListener('click', () => {
      userModalTitle.textContent = 'Add User';
      userName.value = '';
      userDisplay.value = '';
      userNotes.value = '';
      userEditingId = null;
      openModal(userModal);
    });

    btnEditUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      userModalTitle.textContent = 'Edit User';
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userNotes.value = u.notes || '';
      userEditingId = u.id;
      openModal(userModal);
    });

    btnDeleteUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      if (!confirm(`Delete user "${u.display || u.username}" and all their businesses & transactions? This action cannot be undone.`)) return;
      // Delete user's businesses and transactions
      data.businesses = data.businesses.filter(b => b.ownerId !== u.id);
      delete data.transactions[u.id];
      data.users = data.users.filter(x => x.id !== u.id);
      // if remaining businesses belonged to others but selectedBusinessId deleted, fix selection
      if (!data.users.length) {
        // clear everything
        data = { users: [], businesses: [], transactions: {} };
      }
      saveData();
      selectedUserId = data.users.length ? data.users[0].id : null;
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
    });

    userSave.addEventListener('click', () => {
      const username = (userName.value || '').trim();
      if (!username) { alert('Username required'); return; }
      if (userEditingId) {
        const u = findUser(userEditingId);
        if (!u) return;
        u.username = username;
        u.display = (userDisplay.value||'').trim();
        u.notes = (userNotes.value||'').trim();
      } else {
        // ensure unique username
        const exists = data.users.find(x => x.username === username);
        if (exists) { if (!confirm('Username already exists. Add anyway?')) return; }
        const id = uid('user');
        data.users.push({ id, username, display: (userDisplay.value||'').trim(), notes: (userNotes.value||'').trim() });
      }
      saveData();
      closeModal(userModal);
      refreshUserBusinessSelectors();
      ensureSelection();
    });

    userCancel.addEventListener('click', () => closeModal(userModal));

    userSelect.addEventListener('change', (e) => {
      selectedUserId = e.target.value;
      // auto-select first business owned by user if possible
      const owned = data.businesses.find(b => b.ownerId === selectedUserId);
      if (owned) selectedBusinessId = owned.id;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // --- Businesses ---
    btnAddBusiness.addEventListener('click', () => {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = '';
      bizVat.value = 7.5;
      bizCurrency.value = '₦';
      bizThreshold.value = 800000;
      bizNotes.value = '';
      bizOwner.value = selectedUserId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = true;
      bizPitEnabled.checked = true;
      bizWhtRate.value = 5.0;
      bizCitRate.value = 30.0;
      bizDefaultUsefulLife.value = 5;
      bizPayeEnabled.checked = false;
      bizEditingId = null;
      openModal(businessModal);
    });

    btnEditBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizVat.value = (typeof b.vatRate === 'number') ? b.vatRate : 7.5;
      bizCurrency.value = b.currency || '₦';
      bizThreshold.value = (typeof b.threshold === 'number') ? b.threshold : 800000;
      bizNotes.value = b.notes || '';
      bizOwner.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = !!b.vatEnabled;
      bizPitEnabled.checked = (typeof b.pitEnabled === 'undefined') ? true : !!b.pitEnabled;
      bizWhtRate.value = (typeof b.whtRate === 'number') ? b.whtRate : 5.0;
      bizCitRate.value = (typeof b.citRate === 'number') ? b.citRate : 30.0;
      bizDefaultUsefulLife.value = (typeof b.defaultUsefulLife === 'number') ? b.defaultUsefulLife : 5;
      bizPayeEnabled.checked = !!b.payeEnabled;
      bizEditingId = b.id;
      openModal(businessModal);
    });

    btnDeleteBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm(`Delete business "${b.name}" and all its transactions for all users? This action cannot be undone.`)) return;
      // remove business from businesses
      data.businesses = data.businesses.filter(x => x.id !== b.id);
      // remove transactions for this business across all users
      for (const uid of Object.keys(data.transactions)) {
        if (data.transactions[uid] && data.transactions[uid][b.id]) delete data.transactions[uid][b.id];
      }
      saveData();
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizSave.addEventListener('click', () => {
      const name = (bizName.value || '').trim();
      const ownerIdVal = bizOwner.value;
      const vat = parseFloat(bizVat.value);
      const currency = (bizCurrency.value || '₦').trim();
      const threshold = Number(bizThreshold.value) || 800000;
      const vatEnabledVal = !!bizVatEnabled.checked;
      const pitEnabledVal = !!bizPitEnabled.checked;
      const whtRateVal = parseFloat(bizWhtRate.value) || 5.0;
      const citRateVal = parseFloat(bizCitRate.value) || 30.0;
      const defaultUsefulLifeVal = parseInt(bizDefaultUsefulLife.value, 10) || 5;
      const payeEnabledVal = !!bizPayeEnabled.checked;
      if (!name) { alert('Business name required'); return; }
      if (!ownerIdVal) { alert('Select owner'); return; }
      if (bizEditingId) {
        const b = findBiz(bizEditingId);
        if (!b) return;
        b.name = name;
        b.ownerId = ownerIdVal;
        b.vatRate = isNaN(vat) ? 7.5 : vat;
        b.currency = currency;
        b.threshold = threshold;
        b.notes = (bizNotes.value || '').trim();
        b.vatEnabled = vatEnabledVal;
        b.pitEnabled = pitEnabledVal;
        b.whtRate = whtRateVal;
        b.citRate = citRateVal;
        b.defaultUsefulLife = defaultUsefulLifeVal;
        b.payeEnabled = payeEnabledVal;
      } else {
        const id = uid('biz');
        data.businesses.push({
          id, name, ownerId: ownerIdVal,
          vatRate: isNaN(vat) ? 7.5 : vat,
          currency,
          threshold,
          notes: (bizNotes.value || '').trim(),
          vatEnabled: vatEnabledVal,
          pitEnabled: pitEnabledVal,
          whtRate: whtRateVal,
          citRate: citRateVal,
          defaultUsefulLife: defaultUsefulLifeVal,
          payeEnabled: payeEnabledVal
        });
      }
      saveData();
      closeModal(businessModal);
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizCancel.addEventListener('click', () => closeModal(businessModal));

    businessSelect.addEventListener('change', (e) => {
      selectedBusinessId = e.target.value;
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // --- Transactions ---
    btnAddTxn.addEventListener('click', () => {
      const date = document.getElementById('txnDate').value;
      const type = document.getElementById('txnType').value;
      const category = document.getElementById('txnCategory').value;
      const desc = document.getElementById('txnDesc').value.trim();
      const amount = parseFloat(document.getElementById('txnAmount').value) || 0;
      const whtApplied = document.getElementById('txnWhtApplied').checked;
      const depreciable = document.getElementById('txnDepreciable').checked;
      const usefulLife = document.getElementById('txnUsefulLife').value ? parseInt(document.getElementById('txnUsefulLife').value, 10) : null;

      if (!selectedUserId || !selectedBusinessId) {
        alert('Select user and business before adding a transaction.');
        return;
      }
      if (!date || !desc || amount <= 0) {
        alert('Please fill all fields and enter a valid amount.');
        return;
      }
      const txn = { 
        id: uid('txn'), 
        date, 
        type, 
        category, 
        desc, 
        amount,
        whtApplied: whtApplied || false,
        depreciable: depreciable || false
      };
      if (usefulLife && usefulLife > 0) txn.usefulLife = usefulLife;
      if (!data.transactions[selectedUserId]) data.transactions[selectedUserId] = {};
      if (!data.transactions[selectedUserId][selectedBusinessId]) data.transactions[selectedUserId][selectedBusinessId] = [];
      data.transactions[selectedUserId][selectedBusinessId].push(txn);
      saveData();
      clearForm();
      currentPage = Math.ceil(((ledgerFiltered.length || 0) + 1) / PAGE_SIZE); // jump to last page after adding (approx)
      renderLedger();
      calculateSummary();
    });

    function clearForm() {
      document.getElementById('txnDate').value = "";
      document.getElementById('txnDesc').value = "";
      document.getElementById('txnAmount').value = "";
      document.getElementById('txnType').value = "Income";
      document.getElementById('txnCategory').value = "Salary";
      document.getElementById('txnWhtApplied').checked = false;
      document.getElementById('txnDepreciable').checked = false;
      document.getElementById('txnUsefulLife').value = "";
      document.getElementById('txnUsefulLifeLabel').style.display = 'none';
    }

    function renderLedger() {
      ledgerTbody.innerHTML = '';
      if (!selectedUserId || !selectedBusinessId) {
        ledgerFiltered = [];
        updatePaginationControls();
        return;
      }
      const allTxns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      // apply search filter (case-insensitive)
      const q = (ledgerFilterText || '').trim().toLowerCase();
      ledgerFiltered = allTxns.filter(txn => {
        if (!q) return true;
        const parts = [
          txn.date || '',
          txn.type || '',
          txn.category || '',
          txn.desc || '',
          String(txn.amount || '')
        ];
        return parts.join(' ').toLowerCase().includes(q);
      });

      const biz = findBiz(selectedBusinessId);
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageSlice = ledgerFiltered.slice(start, start + PAGE_SIZE);

      pageSlice.forEach((txn, idx) => {
        let vat = 0;
        if (biz && biz.vatEnabled && (txn.type === 'Income' || txn.type === 'Expense')) vat = txn.amount * vatRate;
        
        // *** WHT CALCULATION ***
        let wht = 0;
        const whtRate = (biz && typeof biz.whtRate === 'number') ? (biz.whtRate/100) : 0.05;
        if (txn.whtApplied) wht = txn.amount * whtRate;
        
        // *** CAPITAL ALLOWANCE CALCULATION ***
        let capAllow = '';
        if (txn.depreciable) {
          const usefulLifeYears = txn.usefulLife || (biz && biz.defaultUsefulLife) || 5;
          const annualDep = txn.amount / usefulLifeYears;
          capAllow = `${formatNumber(annualDep)}/yr`;
        }
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${txn.date}</td>
          <td>${txn.type}</td>
          <td>${txn.category}</td>
          <td>${escapeHtml(txn.desc)}</td>
          <td>${biz && biz.currency ? biz.currency : '₦'}${formatNumber(txn.amount)}</td>
          <td>${(vat && biz && biz.vatEnabled) ? (biz.currency || '₦') + formatNumber(vat) : ''}</td>
          <td>${wht > 0 ? (biz.currency || '₦') + formatNumber(wht) : ''}</td>
          <td>${capAllow}</td>
          <td>
            <div class="actions">
              <button class="small" onclick="openEditModal('${txn.id}')">Edit</button>
              <button class="small danger" onclick="removeTransaction('${txn.id}')">Delete</button>
            </div>
          </td>`;
        ledgerTbody.appendChild(tr);
      });

      updatePaginationControls();
    }

    function updatePaginationControls() {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
      btnPrevPage.disabled = currentPage <= 1;
      btnNextPage.disabled = currentPage >= totalPages;
    }

    btnPrevPage.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderLedger();
      }
    });
    btnNextPage.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage < totalPages) {
        currentPage++;
        renderLedger();
      }
    });

    btnSearch.addEventListener('click', () => {
      ledgerFilterText = ledgerSearch.value || '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    btnClearSearch.addEventListener('click', () => {
      ledgerSearch.value = '';
      ledgerFilterText = '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // Expose functions needed by inline onclick attributes
    window.openEditModal = function(txnId) {
      if (!selectedUserId || !selectedBusinessId) return;
      const txns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      const idx = txns.findIndex(t => t.id === txnId);
      if (idx === -1) return;
      editIndex = idx;
      const t = txns[idx];
      editTxnDate.value = t.date;
      editTxnType.value = t.type;
      editTxnCategory.value = t.category;
      editTxnDesc.value = t.desc;
      editTxnAmount.value = t.amount;
      editTxnWhtApplied.checked = !!t.whtApplied;
      editTxnDepreciable.checked = !!t.depreciable;
      editTxnUsefulLife.value = t.usefulLife || '';
      editTxnUsefulLifeLabel.style.display = t.depreciable ? '' : 'none';
      openModal(editModal);
    };

    window.removeTransaction = function(txnId) {
      if (!selectedUserId || !selectedBusinessId) return;
      if (!confirm('Delete this transaction?')) return;
      const txns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      const idx = txns.findIndex(t=>t.id===txnId);
      if (idx === -1) return;
      txns.splice(idx,1);
      saveData();
      // keep page sane
      const totalPages = Math.max(1, Math.ceil(((ledgerFiltered.length - 1) || 0) / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      renderLedger();
      calculateSummary();
    };

    function closeEditModal() {
      closeModal(editModal);
      editIndex = null;
    }
    window.closeEditModal = closeEditModal;

    function saveEdit() {
      if (editIndex === null) return;
      const date = editTxnDate.value;
      const type = editTxnType.value;
      const category = editTxnCategory.value;
      const desc = editTxnDesc.value.trim();
      const amount = parseFloat(editTxnAmount.value) || 0;
      const whtApplied = editTxnWhtApplied.checked;
      const depreciable = editTxnDepreciable.checked;
      const usefulLife = editTxnUsefulLife.value ? parseInt(editTxnUsefulLife.value, 10) : null;
      if (!date || !desc || amount <= 0) { alert('Fill fields and enter valid amount'); return; }
      const txns = data.transactions[selectedUserId][selectedBusinessId];
      if (!txns || !txns[editIndex]) return;
      txns[editIndex] = { 
        ...txns[editIndex], 
        date, 
        type, 
        category, 
        desc, 
        amount,
        whtApplied: whtApplied || false,
        depreciable: depreciable || false
      };
      if (usefulLife && usefulLife > 0) txns[editIndex].usefulLife = usefulLife;
      else delete txns[editIndex].usefulLife;
      saveData();
      closeEditModal();
      renderLedger();
      calculateSummary();
    }
    window.saveEdit = saveEdit;

    // --- Summaries and tax calculations ---
    function calculateSummary() {
  const biz = findBiz(selectedBusinessId);
  const currency = (biz && biz.currency) ? biz.currency : '₦';
  const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
  const threshold = (biz && typeof biz.threshold === 'number') ? biz.threshold : DEFAULT_PIT.threshold;
  const whtRate = (biz && typeof biz.whtRate === 'number') ? (biz.whtRate/100) : 0.05;
  const citRate = (biz && typeof biz.citRate === 'number') ? (biz.citRate/100) : 0.30;
  const defaultUsefulLife = (biz && typeof biz.defaultUsefulLife === 'number') ? biz.defaultUsefulLife : 5;

  // Determine if PIT, VAT, and PAYE are enabled
  const pitEnabled = biz ? (typeof biz.pitEnabled === 'undefined' ? true : !!biz.pitEnabled) : false;
  const vatEnabled = biz ? !!biz.vatEnabled : false;
  const payeEnabled = biz ? !!biz.payeEnabled : false;

  // Use ledgerFiltered so summaries match the filtered view
  const txns = ledgerFiltered || [];

  // *** TRANSACTION AGGREGATION ***
  let incomeTotal = 0, expenseTotal = 0, cogsTotal = 0, deductionTotal = 0, rentTotal = 0;
  let vatOutputTotal = 0, vatInputTotal = 0;
  let whtWithheldTotal = 0; // WHT withheld across transactions
  let salaryTotal = 0; // For PAYE calculation
  let capitalAllowancesTotal = 0; // Sum of annual depreciation for depreciable assets
  
  txns.forEach(txn => {
    if (txn.type === 'Income') {
      incomeTotal += txn.amount;
      if (vatEnabled) vatOutputTotal += txn.amount * vatRate;
    } else if (txn.type === 'Expense') {
      expenseTotal += txn.amount;
      if (vatEnabled) vatInputTotal += txn.amount * vatRate;
      if (txn.category === 'Rent') rentTotal += txn.amount;
      // Check if this is a Salary expense for PAYE
      if (payeEnabled && txn.category.toLowerCase() === 'salary') {
        salaryTotal += txn.amount;
      }
    } else if (txn.type === 'COGS') {
      cogsTotal += txn.amount;
    } else if (txn.type === 'Deduction') {
      deductionTotal += txn.amount;
    }
    
    // *** WHT CALCULATION (per transaction) ***
    if (txn.whtApplied) {
      whtWithheldTotal += txn.amount * whtRate;
    }
    
    // *** CAPITAL ALLOWANCE CALCULATION (per transaction) ***
    if (txn.depreciable) {
      const usefulLifeYears = txn.usefulLife || defaultUsefulLife;
      const annualDep = txn.amount / usefulLifeYears;
      capitalAllowancesTotal += annualDep;
    }
  });

  // *** PAYE CALCULATION ***
  let payeTotal = 0;
  if (payeEnabled && salaryTotal > 0) {
    // Use existing computeTax function for PAYE on aggregated salaries
    payeTotal = computeTax(salaryTotal, biz);
  }

  let netBalance = incomeTotal - expenseTotal - cogsTotal;
  let vatPayable = (vatOutputTotal - vatInputTotal);
  
  // Rent relief: 20% of rent up to 500,000 (for PIT calculation)
  let rentRelief = rentTotal * 0.20;
  if (rentRelief > 500000) rentRelief = 500000;

  // *** PIT CALCULATION (Personal Income Tax) ***
  // Taxable income after deductions and relief for PIT
  let adjIncome = incomeTotal - deductionTotal - rentRelief;
  if (adjIncome < 0) adjIncome = 0;

  let pitTax = 0;
  if (pitEnabled) {
    pitTax = computeTax(adjIncome, biz);
  }

  let pitEffRate = incomeTotal > 0 ? (pitTax / incomeTotal) * 100 : 0;

  // *** CIT CALCULATION (Company Income Tax) ***
  // Taxable profit = Income - COGS - Expenses - Capital Allowances - PAYE - Deductions
  let taxableProfit = incomeTotal - cogsTotal - expenseTotal - capitalAllowancesTotal - payeTotal - deductionTotal;
  if (taxableProfit < 0) taxableProfit = 0;
  let citPayable = taxableProfit * citRate;
  if (citPayable < 0) citPayable = 0;

  // *** VAT SUMMARY ***
  if (vatEnabled) {
    vatSummaryDiv.style.display = '';
    vatSummaryDiv.innerHTML =
      `<strong>VAT Summary (${(vatRate*100).toFixed(2)}%):</strong><br>
       VAT Output (Sales): ${currency}${formatNumber(vatOutputTotal)}<br>
       VAT Input (Purchases): ${currency}${formatNumber(vatInputTotal)}<br>
       <strong>VAT Payable:</strong> ${currency}${formatNumber(vatPayable)}`;
  } else {
    vatSummaryDiv.style.display = 'none';
    vatSummaryDiv.innerHTML = '';
  }

  // *** TOTALS SUMMARY ***
  totalsSummaryDiv.style.display = '';
  totalsSummaryDiv.innerHTML =
    `<strong>Income:</strong> ${currency}${formatNumber(incomeTotal)}  | 
     <strong>COGS:</strong> ${currency}${formatNumber(cogsTotal)}  | 
     <strong>Expenses:</strong> ${currency}${formatNumber(expenseTotal)}  | 
     <strong>Deductions:</strong> ${currency}${formatNumber(deductionTotal)}  | 
     <strong>Net Balance:</strong> ${currency}${formatNumber(netBalance)}`;

  // *** TAX SUMMARY (PIT + WHT + PAYE + CIT) ***
  let taxSummaryContent = '';
  
  // Show PIT summary if PIT enabled
  if (pitEnabled) {
    taxSummaryContent += `<strong>Personal Income Tax (PIT):</strong><br>
       Tax-free threshold: ${currency}${formatNumber(threshold)}<br>
       Rent relief applied: ${currency}${formatNumber(rentRelief)}<br>
       Taxable income after deductions: ${currency}${formatNumber(adjIncome)}<br>
       <strong>PIT payable:</strong> ${currency}${formatNumber(pitTax,0)}<br>
       Effective PIT rate on gross income: ${pitEffRate.toFixed(2)}%<br>
       ${adjIncome <= threshold ? `<strong>No PIT payable (taxable income ≤ ${currency}${formatNumber(threshold)})</strong><br>` : ''}<br>`;
  }
  
  // Show WHT summary (always show if any WHT withheld)
  if (whtWithheldTotal > 0) {
    taxSummaryContent += `<strong>Withholding Tax (WHT) at ${(whtRate*100).toFixed(1)}%:</strong><br>
       Total WHT withheld: ${currency}${formatNumber(whtWithheldTotal)}<br>
       <em>(WHT is treated as tax credit)</em><br><br>`;
  }
  
  // Show PAYE summary if PAYE enabled
  if (payeEnabled) {
    taxSummaryContent += `<strong>PAYE (Pay As You Earn):</strong><br>
       Total Salary expenses: ${currency}${formatNumber(salaryTotal)}<br>
       PAYE withheld: ${currency}${formatNumber(payeTotal,0)}<br>
       <em>(PAYE is deducted from taxable profit for CIT)</em><br><br>`;
  }
  
  // Show Capital Allowances summary if any depreciable assets
  if (capitalAllowancesTotal > 0) {
    taxSummaryContent += `<strong>Capital Allowances (Straight-line Depreciation):</strong><br>
       Total annual depreciation: ${currency}${formatNumber(capitalAllowancesTotal)}<br>
       <em>(Reduces taxable profit for CIT)</em><br><br>`;
  }
  
  // Show CIT summary (always show for businesses)
  taxSummaryContent += `<strong>Company Income Tax (CIT) at ${(citRate*100).toFixed(1)}%:</strong><br>
     Taxable Profit = Income (${currency}${formatNumber(incomeTotal)}) - COGS (${currency}${formatNumber(cogsTotal)}) - Expenses (${currency}${formatNumber(expenseTotal)}) - Capital Allowances (${currency}${formatNumber(capitalAllowancesTotal)}) - PAYE (${currency}${formatNumber(payeTotal,0)}) - Deductions (${currency}${formatNumber(deductionTotal)})<br>
     Taxable Profit: ${currency}${formatNumber(taxableProfit)}<br>
     <strong>CIT Payable:</strong> ${currency}${formatNumber(citPayable,0)}<br>`;
  
  if (taxSummaryContent) {
    taxSummaryDiv.style.display = '';
    taxSummaryDiv.innerHTML = taxSummaryContent;
  } else {
    taxSummaryDiv.style.display = 'none';
    taxSummaryDiv.innerHTML = '';
  }
    }   

    function computeTax(adjIncome, biz) {
      // biz may include custom PIT slices in biz.pit (not exposed in UI now).
      // If PIT disabled on business, return 0
      if (biz && typeof biz.pitEnabled !== 'undefined' && !biz.pitEnabled) return 0;
      const pit = (biz && biz.pit && Array.isArray(biz.pit.slices)) ? biz.pit : DEFAULT_PIT;
      // If adjIncome <= threshold => 0
      let tax = 0;
      if (adjIncome > (pit.threshold || DEFAULT_PIT.threshold)) {
        let taxable = adjIncome;
        let remaining = taxable - (pit.threshold || DEFAULT_PIT.threshold);
        // iterate slices
        let prevUpper = (pit.threshold || DEFAULT_PIT.threshold);
        for (let s of pit.slices) {
          const upper = s.upTo;
          let sliceLimit = (upper === Infinity) ? Infinity : (upper - prevUpper);
          if (remaining <= 0) break;
          const slice = Math.min(remaining, sliceLimit);
          tax += slice * s.rate;
          remaining -= slice;
          prevUpper = upper;
        }
      }
      return Math.max(0, Math.round(tax)); // tax in whole Naira
    }

    // --- Export / Import / Clear ---
    btnExport.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const now = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `ntc_data_export_${now}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imported = JSON.parse(ev.target.result);
          if (!imported.users || !imported.businesses) throw new Error('Invalid format: missing users/businesses');
          // optional merge or replace? ask user - for simplicity replace after confirmation
          if (!confirm('Import will replace current data. Continue?')) return;
          data = imported;
          if (!data.transactions) data.transactions = {};
          saveData();
          refreshUserBusinessSelectors();
          ensureSelection();
          currentPage = 1;
          renderLedger();
          calculateSummary();
          alert('Import successful');
        } catch (err) {
          alert('Failed to import JSON: ' + err.message);
        }
      };
      reader.readAsText(f);
      // reset file input
      fileInput.value = '';
    });

    btnClearAll.addEventListener('click', () => {
      if (!confirm('Clear ALL saved data (users, businesses, transactions)? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      loadData();
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      alert('All data cleared and reset to demo.');
    });

    // --- Helpers ---
    function formatNumber(n, fractionDigits=2) {
      if (typeof n !== 'number') n = Number(n) || 0;
      return n.toLocaleString(undefined, { maximumFractionDigits: fractionDigits, minimumFractionDigits: fractionDigits });
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // close modal when overlay clicked
    modalOverlay.addEventListener('click', () => {
      // close any open modal
      closeModal(userModal);
      closeModal(businessModal);
      closeModal(editModal);
    });

    // Keyboard: Esc closes modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal(userModal);
        closeModal(businessModal);
        closeModal(editModal);
      }
    });

    // Expose helper for debug (optional)
    window._ntc = { data, saveData, loadData, refreshUserBusinessSelectors, renderLedger, calculateSummary };

    // Initial focus improvements
    setTimeout(()=>{ if (userSelect.options.length) userSelect.focus(); }, 300);
  </script>

  <footer>
    <div class="muted">Notes: Data is stored locally in your browser (localStorage). For production or multi-device sharing, use a server-backed solution. This tool keeps VAT per business and calculates PIT per business when enabled.</div>
  </footer>
</body>
</html>

If you want, I can open a pull request in the repository adding this updated index.html (or push it to a new branch). Would you like me to create the PR now?
