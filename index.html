<!-- GitHub Copilot Chat Assistant -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Accounting & Tax Engine — Updated</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,96vw); max-height:80vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted-pill { background:#f2f4f7; padding:4px 8px; border-radius:6px; font-size:0.9rem; color:#333; }
    .disabled { opacity:0.45; pointer-events:none; }
    .code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f3f5f7; padding:4px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax Engine — Updated</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
      </div>
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset / Opening Balances</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <label><input type="checkbox" id="isOpening" /> Opening balance</label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="OpeningBalance">Opening Balance</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="Salary">Salary (PAYE)</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
            <option value="BankPayment">Bank Payment</option>
            <option value="BankReceipt">Bank Receipt</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="openingSection" class="form-inline" style="margin-top:10px; display:none;">
        <div class="panel" style="width:100%;">
          <h3 style="margin:4px 0;">Opening balances</h3>
          <div class="form-inline">
            <div style="min-width:260px;">
              <h4 style="margin:4px 0;">Opening balance (account)</h4>
              <label>Date: <input type="date" id="openDate" /></label>
              <label>Account: <select id="openAccount"></select></label>
              <label>Amount: <input type="number" id="openAmount" min="0" step="0.01" /></label>
              <button id="btnAddOpening" class="small primary">Apply Opening Balance</button>
            </div>

            <div style="min-width:260px;">
              <h4 style="margin:4px 0;">Opening inventory</h4>
              <label>Date: <input type="date" id="openInvDate" /></label>
              <label>Item: <input type="text" id="openInvName" /></label>
              <label>Qty: <input type="number" id="openInvQty" min="0" step="1" /></label>
              <label>Unit cost: <input type="number" id="openInvCost" min="0" step="0.01" /></label>
              <button id="btnAddOpenInv" class="small">Apply Opening Inventory</button>
              <small class="note">Opening inventory updates qty & avg cost without VAT/WHT.</small>
            </div>

            <div style="min-width:300px;">
              <h4 style="margin:4px 0;">Opening fixed asset</h4>
              <label>Asset name: <input type="text" id="openAssetName" /></label>
              <label>Purchase date: <input type="date" id="openAssetPurchaseDate" /></label>
              <label>Cost: <input type="number" id="openAssetCost" min="0" step="0.01" /></label>
              <label>Accumulated depreciation to date: <input type="number" id="openAssetAccumDep" min="0" step="0.01" /></label>
              <label>Useful life (years): <input type="number" id="openAssetLife" min="1" step="1" class="smallInput" /></label>
              <label>CA % (annual): <input type="number" id="openAssetCA" min="0" step="0.01" class="smallInput" /></label>
              <label>Dep % (annual): <input type="number" id="openAssetDepRate" min="0" step="0.01" class="smallInput" /></label>
              <button id="btnAddOpenAsset" class="small">Add Opening Asset</button>
              <small class="note">Opening asset sets accumulated depreciation and is marked as purchased earlier.</small>
            </div>
          </div>
        </div>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small primary">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetPurchaseSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset Purchase</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>
          <label>Classification:
            <select id="assetClassification">
              <option value="Fixed">Fixed</option>
              <option value="Chargeable">Chargeable</option>
            </select>
          </label>

          <label>Depreciation rate % (annual): <input type="number" id="assetDepRate" class="smallInput" min="0" step="0.01" /></label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small primary">Record Asset Purchase</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days. Capital allowance applied monthly from purchase.</small>
      </div>

      <div id="assetDisposalSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset Disposal</h3>
        <div class="form-inline">
          <label>Asset:
            <select id="assetSelectForDisposal"></select>
          </label>
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
        </div>
        <small class="note">Disposal will auto-post depreciation up to disposal date, mark asset disposed and post gain/loss to Gain/Loss accounts.</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable/Receivable</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Fixed Assets Report</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
        <button id="btnExportXlsx" class="small">Export XLSX (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (SoleTrader), that will override these values for PIT.</small>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add a contact with type "SoleTrader" and set statutory deductions there if you want PIT to use per-sole-trader deductions.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="max-height:360px; overflow:auto;"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountDisallowable" /> Disallowable</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountNonTax" /> Non-taxable</label>
      <select id="newAccountRentFreq">
        <option value="">Rent freq</option>
        <option value="monthly">Monthly rent</option>
        <option value="yearly">Yearly rent</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">
    Stored in browser (localStorage) and exportable to file (Export / Import JSON). To save to Git, export JSON and push via your Git client or GitHub UI.
  </footer>

  <script>
  /************************************************************************
   * Updated single-file frontend implementing requested features:
   * - LocalStorage persistence + Export/Import (no automatic Git push).
   * - Opening balances forms (account, inventory, fixed asset with accumulated depreciation).
   * - Salary transactions always create PAYE expense + PAYE liability and tax line.
   * - Depreciation calculated dynamically and shown on P&L and Tax Summary.
   * - Capital allowance accumulation and carryforward applied against taxable profit.
   * - Disposals auto-post depreciation to disposal date, mark asset disposed (keeps history), post gain/loss to Gain/Loss accounts.
   * - Default Gain on Disposal, Loss on Disposal, PAYE Expense and PAYE Liability accounts created on business creation.
   * - When business.entity === 'SoleProprietor' or bizPitEnabled checked -> show PIT and hide CIT; when entity === 'Company' -> show CIT and hide PIT.
   ************************************************************************/

  const STORAGE_KEY = 'ntc_full_accounting_v1';
  const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, caRateDefault:20.0, depRateDefault:20.0 };
  const PAYE_BANDS = [
    { upTo: 300000, rate: 0.07 },
    { upTo: 600000, rate: 0.11 },
    { upTo: 1100000, rate: 0.15 },
    { upTo: 1600000, rate: 0.19 },
    { upTo: 3200000, rate: 0.21 },
    { upTo: Infinity, rate: 0.24 }
  ];

  // state
  let state = { users: [], businesses: [], transactions: {}, attachments: {}, audit: [], auth: { currentUserId: null } };
  let selectedUserId = null;
  let selectedBizId = null;
  let activeTab = 'ledger';

  // DOM refs
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const txnReceipt = document.getElementById('txnReceipt');
  const btnAddTxn = document.getElementById('btnAddTxn');
  const mainTxnForm = document.getElementById('mainTxnForm');

  const openingSection = document.getElementById('openingSection');
  const isOpening = document.getElementById('isOpening');
  const openDate = document.getElementById('openDate');
  const openAccount = document.getElementById('openAccount');
  const openAmount = document.getElementById('openAmount');
  const btnAddOpening = document.getElementById('btnAddOpening');

  const openInvDate = document.getElementById('openInvDate');
  const openInvName = document.getElementById('openInvName');
  const openInvQty = document.getElementById('openInvQty');
  const openInvCost = document.getElementById('openInvCost');
  const btnAddOpenInv = document.getElementById('btnAddOpenInv');

  const openAssetName = document.getElementById('openAssetName');
  const openAssetPurchaseDate = document.getElementById('openAssetPurchaseDate');
  const openAssetCost = document.getElementById('openAssetCost');
  const openAssetAccumDep = document.getElementById('openAssetAccumDep');
  const openAssetLife = document.getElementById('openAssetLife');
  const openAssetCA = document.getElementById('openAssetCA');
  const openAssetDepRate = document.getElementById('openAssetDepRate');
  const btnAddOpenAsset = document.getElementById('btnAddOpenAsset');

  const inventorySubform = document.getElementById('inventorySubform');
  const invItemSelect = document.getElementById('invItemSelect');
  const invNewName = document.getElementById('invNewName');
  const invAccountSelect = document.getElementById('invAccountSelect');
  const invQty = document.getElementById('invQty');
  const invUnitPrice = document.getElementById('invUnitPrice');
  const invVatType = document.getElementById('invVatType');
  const invContact = document.getElementById('invContact');
  const invReceipt = document.getElementById('invReceipt');
  const btnAddInv = document.getElementById('btnAddInv');
  const btnInvCancel = document.getElementById('btnInvCancel');
  const btnInvUndo = document.getElementById('btnInvUndo');

  const assetPurchaseSubform = document.getElementById('assetPurchaseSubform');
  const assetName = document.getElementById('assetName');
  const assetCost = document.getElementById('assetCost');
  const assetPurchaseDate = document.getElementById('assetPurchaseDate');
  const assetLife = document.getElementById('assetLife');
  const assetCA = document.getElementById('assetCA');
  const btnAddAsset = document.getElementById('btnAddAsset');
  const btnAssetCancel = document.getElementById('btnAssetCancel');
  const btnAssetUndo = document.getElementById('btnAssetUndo');
  const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
  const assetClassification = document.getElementById('assetClassification');
  const assetDepRate = document.getElementById('assetDepRate');
  const assetContact = document.getElementById('assetContact');
  const assetReceipt = document.getElementById('assetReceipt');

  const assetDisposalSubform = document.getElementById('assetDisposalSubform');
  const assetSelectForDisposal = document.getElementById('assetSelectForDisposal');
  const assetDisposalDate = document.getElementById('assetDisposalDate');
  const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
  const assetDisposalAccount = document.getElementById('assetDisposalAccount');
  const btnDisposeAsset = document.getElementById('btnDisposeAsset');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const ledgerSection = document.getElementById('ledgerSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');

  const modalOverlay = document.getElementById('modalOverlay');
  const userModal = document.getElementById('userModal');
  const userModalTitle = document.getElementById('userModalTitle');
  const userName = document.getElementById('userName');
  const userDisplay = document.getElementById('userDisplay');
  const userRole = document.getElementById('userRole');
  const permView = document.getElementById('permView');
  const permEdit = document.getElementById('permEdit');
  const permDelete = document.getElementById('permDelete');
  const userSave = document.getElementById('userSave');
  const userCancel = document.getElementById('userCancel');

  const businessModal = document.getElementById('businessModal');
  const businessModalTitle = document.getElementById('businessModalTitle');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
  const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizCapitalBF = document.getElementById('bizCapitalBF');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');

  const accountsModal = document.getElementById('accountsModal');
  const accountsList = document.getElementById('accountsList');
  const newAccountName = document.getElementById('newAccountName');
  const newAccountCategory = document.getElementById('newAccountCategory');
  const newAccountDisallowable = document.getElementById('newAccountDisallowable');
  const newAccountNonTax = document.getElementById('newAccountNonTax');
  const newAccountRentFreq = document.getElementById('newAccountRentFreq');
  const addAccountBtn = document.getElementById('addAccountBtn');
  const closeAccountsBtn = document.getElementById('closeAccountsBtn');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnReportsTab = document.getElementById('btnReportsTab');

  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const fileInput = document.getElementById('fileInput');
  const btnClearAll = document.getElementById('btnClearAll');
  const userSelectLabel = document.getElementById('authInfo');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
  function toISO(date){ if(!date) return null; return new Date(date).toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }

  // persistence
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }
  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || { currentUserId: null };
    state.businesses.forEach(b => {
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
      b.accounts = b.accounts || [];
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
      b.caRateDefault = Number(b.caRateDefault || DEFAULTS.caRateDefault);
      b.depRateDefault = Number(b.depRateDefault || DEFAULTS.depRateDefault);
      ensureGainLossAccounts(b);
    });
    for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; for(const b of state.businesses){ state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || []; } }
    saveState();
  }

  function ensureGainLossAccounts(biz){
    biz.accounts = biz.accounts || [];
    if(!biz.accounts.find(a=>a.name==='Gain on Disposal')) biz.accounts.push({ id: uid('acct'), name:'Gain on Disposal', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
    if(!biz.accounts.find(a=>a.name==='Loss on Disposal')) biz.accounts.push({ id: uid('acct'), name:'Loss on Disposal', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
    if(!biz.accounts.find(a=>a.name==='PAYE Expense')) biz.accounts.push({ id: uid('acct'), name:'PAYE Expense', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
    if(!biz.accounts.find(a=>a.name==='PAYE Liability')) biz.accounts.push({ id: uid('acct'), name:'PAYE Liability', category:'Liability', disallowableDefault:false, nonTaxableDefault:false });
  }

  // seed demo
  function seedDemo(){
    const u = uid('user'), b = uid('biz');
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false };
    state = {
      users: [{ id: u, username: 'admin', display:'Admin', role:'Admin', permissions:{ view:true, edit:true, delete:true } }],
      businesses: [{
        id: b, name: 'Demo Business', ownerId: u, entity:'Company',
        vatRate: DEFAULTS.vatRate, whtRate: DEFAULTS.whtRate, citRate: DEFAULTS.citRate,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS.depRateDefault,
        accounts: [sales, cogs, salaries, bank],
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [],
        contacts: [],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: u }
    };
    ensureGainLossAccounts(state.businesses[0]);
    state.transactions[u] = {}; state.transactions[u][b] = [];
    addAudit('seed','system','',`Seeded demo data`);
    saveState();
    refreshSelectors();
    ensureSelection();
    renderAll();
  }

  // audit
  function addAudit(type, entityType, entityId, details){
    state.audit = state.audit || [];
    state.audit.push({ id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details });
    saveState();
  }

  // modal helpers
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }

  modalOverlay.addEventListener('click', ()=> {
    [userModal, businessModal, accountsModal].forEach(m => { if(m.style.display==='block') closeModal(m); });
  });

  // init
  loadState();
  initUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  function initUI(){
    btnAddUser.addEventListener('click', ()=> openUserModal());
    btnEditUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); openUserModal(selectedUserId); });
    btnDeleteUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); if(!confirm('Delete user?')) return; deleteUser(selectedUserId); });

    document.getElementById('userSave').addEventListener('click', ()=> {
      const username = (userName.value||'').trim(); if(!username) return alert('Username required');
      const editId = userSave.dataset.edit;
      if(editId){
        const u = state.users.find(x=>x.id===editId);
        u.username = username; u.display = userDisplay.value || username; u.role = userRole.value;
        u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked };
        addAudit('user.edit','user',u.id,'Edited user');
      } else {
        const newUser = { id: uid('user'), username, display: userDisplay.value || username, role: userRole.value, permissions: { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked } };
        state.users.push(newUser);
        state.transactions[newUser.id] = state.transactions[newUser.id] || {};
        for(const b of state.businesses) state.transactions[newUser.id][b.id] = state.transactions[newUser.id][b.id] || [];
        addAudit('user.add','user',newUser.id,'Added user');
      }
      saveState(); closeModal(userModal); refreshSelectors(); ensureSelection(); renderAll();
    });
    userCancel.addEventListener('click', ()=> closeModal(userModal));

    btnAddBusiness.addEventListener('click', ()=> {
      businessModalTitle.textContent = 'Add Business'; bizName.value=''; bizOwnerSelect.value = state.users[0] ? state.users[0].id : '';
      bizEntity.value='Company'; bizVat.value=DEFAULTS.vatRate; bizWht.value=DEFAULTS.whtRate; bizCit.value=DEFAULTS.citRate;
      bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
      bizSave.dataset.edit = '';
      bizContactsList.innerHTML = '';
      openModal(businessModal);
    });
    btnEditBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const b = findBiz(selectedBizId); if(!b) return alert('Business not found');
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (state.users[0] && state.users[0].id) || '';
      bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
      bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled;
      bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0; bizCapitalBF.value = b.capitalBroughtForward || 0;
      bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax;
      bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
      bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0;
      bizSave.dataset.edit = b.id;
      renderBizContacts(b);
      openModal(businessModal);
    });
    btnDeleteBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      if(!confirm('Delete business and all its transactions?')) return;
      deleteBusiness(selectedBizId);
    });

    bizSave.addEventListener('click', ()=> {
      const name = (bizName.value||'').trim(); if(!name) return alert('Business name required');
      const editId = bizSave.dataset.edit;
      if(editId){
        const b = findBiz(editId);
        b.name = name; b.ownerId = bizOwnerSelect.value; b.entity = bizEntity.value;
        b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
        b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked;
        b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0); b.capitalBroughtForward = Number(bizCapitalBF.value || 0);
        b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked;
        b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) };
        ensureGainLossAccounts(b);
        addAudit('business.edit','business', b.id, 'Edited business');
      } else {
        const newBiz = {
          id: uid('biz'), name, ownerId: bizOwnerSelect.value || (state.users[0] && state.users[0].id),
          entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate),
          vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
          accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
          lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS.depRateDefault
        };
        newBiz.accounts.push({ id: uid('acct'), name:'Sales', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Bank', category:'Asset', disallowableDefault:false, nonTaxableDefault:false });
        ensureGainLossAccounts(newBiz);
        state.businesses.push(newBiz);
        for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][newBiz.id] = []; }
        addAudit('business.add','business', newBiz.id, 'Added business');
      }
      saveState(); closeModal(businessModal); refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll();
    });
    bizCancel.addEventListener('click', ()=> closeModal(businessModal));
    btnAddContact.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business first');
      const b = findBiz(selectedBizId);
      const name = (newContactName.value||'').trim(); if(!name) return alert('Contact name required');
      b.contacts = b.contacts || [];
      b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } });
      saveState(); renderBizContacts(b);
    });

    btnManageAccounts.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      renderAccounts(); openModal(accountsModal);
    });
    addAccountBtn.addEventListener('click', ()=> {
      const name = (newAccountName.value||'').trim(); const cat = newAccountCategory.value; const dis = !!newAccountDisallowable.checked; const nt = !!newAccountNonTax.checked; const rentFreq = newAccountRentFreq.value || '';
      if(!name) return alert('Account name required');
      const b = findBiz(selectedBizId);
      b.accounts = b.accounts || [];
      b.accounts.push({ id: uid('acct'), name, category: cat, disallowableDefault:dis, nonTaxableDefault:nt, rentFreq:rentFreq });
      saveState(); renderAccounts(); populateAccountSelect();
    });
    closeAccountsBtn.addEventListener('click', ()=> closeModal(accountsModal));

    // transaction form behavior
    txnAction.addEventListener('change', ()=> {
      const val = txnAction.value;
      mainTxnForm.style.display = 'flex';
      inventorySubform.style.display = 'none';
      assetPurchaseSubform.style.display = 'none';
      assetDisposalSubform.style.display = 'none';
      openingSection.style.display = 'none';
      if(val === 'InventoryPurchase' || val === 'InventorySale'){
        mainTxnForm.style.display = 'none';
        inventorySubform.style.display = 'block';
        populateAccountSelect();
      } else if(val === 'FixedAssetPurchase'){
        mainTxnForm.style.display = 'none';
        assetPurchaseSubform.style.display = 'block';
        populateAccountSelect();
        populateAssetPurchaseAccounts();
      } else if(val === 'FixedAssetDisposal'){
        mainTxnForm.style.display = 'none';
        assetDisposalSubform.style.display = 'block';
        populateAccountSelect();
        populateAssetDisposal();
      } else if(val === 'OpeningBalance'){
        openingSection.style.display = 'flex';
      }
      renderFeatureVisibility();
    });
    isOpening.addEventListener('change', ()=> { openingSection.style.display = isOpening.checked ? 'flex' : 'none'; });

    txnWht.addEventListener('change', ()=> {
      const show = txnWht.checked;
      txnWhtRateLabel.style.display = show ? 'inline-flex' : 'none';
      txnWhtBasisLabel.style.display = show ? 'inline-flex' : 'none';
    });

    btnAddTxn.addEventListener('click', addTransaction);
    btnAddOpening.addEventListener('click', applyOpeningAccount);
    btnAddOpenInv.addEventListener('click', applyOpeningInventory);
    btnAddOpenAsset.addEventListener('click', applyOpeningAsset);

    btnAddInv.addEventListener('click', applyInventoryAction);
    btnInvCancel.addEventListener('click', ()=> { inventorySubform.style.display='none'; txnAction.value=''; mainTxnForm.style.display='flex'; });
    btnAddAsset.addEventListener('click', applyAssetPurchase);
    btnAssetCancel.addEventListener('click', ()=> { assetPurchaseSubform.style.display='none'; txnAction.value=''; mainTxnForm.style.display='flex'; });
    btnDisposeAsset.addEventListener('click', applyAssetDisposal);

    userSelect.addEventListener('change', ()=> { selectedUserId = userSelect.value; state.auth.currentUserId = selectedUserId; saveState(); refreshSelectors(); renderAll(); });
    businessSelect.addEventListener('change', ()=> { selectedBizId = businessSelect.value; saveState(); populateAccountSelect(); renderAll(); });

    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; btnLedgerTab.classList.add('active'); btnReportsTab.classList.remove('active'); ledgerSection.style.display='block'; reportsSection.style.display='none'; renderAll(); });
    btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; btnReportsTab.classList.add('active'); btnLedgerTab.classList.remove('active'); ledgerSection.style.display='none'; reportsSection.style.display='block'; renderReports(); });

    btnExport.addEventListener('click', ()=> {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc-export.json'; a.click();
      URL.revokeObjectURL(url);
    });
    btnImport.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){ try { state = JSON.parse(ev.target.result); migrateState(); renderAll(); alert('Import successful'); } catch(err){ alert('Import failed: '+err.message); } };
      reader.readAsText(f);
    });
    btnClearAll.addEventListener('click', ()=> { if(!confirm('Clear all data?')) return; localStorage.removeItem(STORAGE_KEY); location.reload(); });

    document.getElementById('btnSearch').addEventListener('click', renderLedger);
    document.getElementById('btnClearSearch').addEventListener('click', ()=> { document.getElementById('ledgerSearch').value=''; renderLedger(); });
  }

  // helpers
  function openUserModal(editId){
    userModalTitle.textContent = editId ? 'Edit User' : 'Add User';
    if(editId){
      const u = state.users.find(x=>x.id===editId);
      userName.value = u.username; userDisplay.value = u.display || u.username; userRole.value = u.role || 'User';
      permView.checked = !!u.permissions?.view; permEdit.checked = !!u.permissions?.edit; permDelete.checked = !!u.permissions?.delete;
      userSave.dataset.edit = u.id;
    } else {
      userName.value=''; userDisplay.value=''; userRole.value='User'; permView.checked=true; permEdit.checked=true; permDelete.checked=false;
      userSave.dataset.edit = '';
    }
    openModal(userModal);
  }
  function deleteUser(id){
    state.users = state.users.filter(u=>u.id!==id);
    delete state.transactions[id];
    if(state.auth.currentUserId === id) state.auth.currentUserId = state.users[0] ? state.users[0].id : null;
    saveState(); refreshSelectors(); ensureSelection(); renderAll();
  }
  function deleteBusiness(id){
    state.businesses = state.businesses.filter(b=>b.id!==id);
    for(const u of state.users) if(state.transactions[u.id]) delete state.transactions[u.id][id];
    if(selectedBizId === id) selectedBizId = state.businesses[0] ? state.businesses[0].id : null;
    saveState(); refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll();
  }
  function findBiz(id){ return state.businesses.find(b=>b.id===id); }
  function findAccount(biz, acctId){ return biz.accounts.find(a=>a.id===acctId); }
  function refreshSelectors(){
    // users
    userSelect.innerHTML=''; state.users.forEach(u=> { const opt = document.createElement('option'); opt.value=u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); });
    if(!state.auth.currentUserId && state.users[0]) state.auth.currentUserId = state.users[0].id;
    selectedUserId = state.auth.currentUserId;
    userSelect.value = selectedUserId || '';
    // businesses
    businessSelect.innerHTML=''; state.businesses.forEach(b=> { const opt = document.createElement('option'); opt.value=b.id; opt.textContent = b.name; businessSelect.appendChild(opt); });
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    businessSelect.value = selectedBizId || '';
    // owners list
    bizOwnerSelect.innerHTML=''; state.users.forEach(u=> { const opt = document.createElement('option'); opt.value=u.id; opt.textContent = u.display || u.username; bizOwnerSelect.appendChild(opt); });
    document.getElementById('authInfo').textContent = state.users.find(u=>u.id===selectedUserId)?.display || '';
  }
  function ensureSelection(){ if(!selectedUserId && state.users[0]) selectedUserId = state.users[0].id; if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id; saveState(); }

  function populateAccountSelect(){
    const b = findBiz(selectedBizId);
    txnAccount.innerHTML = '';
    openAccount.innerHTML = '';
    invAccountSelect.innerHTML = '';
    assetPurchaseAccount.innerHTML = '';
    assetDisposalAccount.innerHTML = '';
    assetAccountOptions = [];
    if(!b) return;
    b.accounts.forEach(a=> {
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = `${a.name} (${a.category})`; txnAccount.appendChild(opt);
      const opt2 = opt.cloneNode(true); openAccount.appendChild(opt2);
      const opt3 = opt.cloneNode(true); invAccountSelect.appendChild(opt3);
      const opt4 = opt.cloneNode(true); assetPurchaseAccount.appendChild(opt4);
      const opt5 = opt.cloneNode(true); assetDisposalAccount.appendChild(opt5);
    });
  }

  function renderAccounts(){
    const b = findBiz(selectedBizId); accountsList.innerHTML='';
    if(!b) return;
    b.accounts.forEach(a=> {
      const div = document.createElement('div'); div.className='account-row';
      div.innerHTML = `<div><strong>${a.name}</strong> <span class="small-muted">(${a.category})</span></div><div><button class="small" data-id="${a.id}">Delete</button></div>`;
      accountsList.appendChild(div);
      div.querySelector('button').addEventListener('click', ()=> {
        if(!confirm('Delete account?')) return;
        b.accounts = b.accounts.filter(x=>x.id!==a.id);
        saveState(); renderAccounts(); populateAccountSelect(); renderAll();
      });
    });
  }

  function renderBizContacts(b){
    bizContactsList.innerHTML = '';
    if(!b) return;
    b.contacts.forEach(c=> {
      const d = document.createElement('div'); d.textContent = `${c.name} (${c.type})`; bizContactsList.appendChild(d);
    });
  }

  function resetForms(){
    txnDate.value = today(); openDate.value = today(); txnAmount.value=''; txnDesc.value=''; txnAction.value=''; isOpening.checked=false;
    txnVatType.value='none'; txnWht.checked=false; txnWhtRate.value=''; txnWhtBasis.value='gross'; txnSalary.checked=false;
  }

  // ledger render
  function renderAll(){
    populateAccountSelect();
    renderLedger();
    renderPLSnapshot();
    renderTaxSummary();
    renderQuickLists();
  }

  function renderLedger(){
    ledgerTableBody.innerHTML = '';
    if(!selectedUserId || !selectedBizId) return;
    const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    const q = document.getElementById('ledgerSearch').value.trim().toLowerCase();
    const filtered = txns.filter(t => {
      if(!q) return true;
      return (t.date||'').includes(q) || (t.accountName||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q) || (''+t.amount).includes(q) || (t.contact||'').toLowerCase().includes(q);
    }).sort((a,b)=> new Date(b.date) - new Date(a.date));
    filtered.forEach(t => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.date||''}</td><td>${t.action||''}</td><td>${t.accountName||''}</td><td>${t.description||''}</td><td>${fmt(t.amount)}</td><td>${t.vatAmount ? fmt(t.vatAmount) : ''}</td><td>${t.whtAmount ? fmt(t.whtAmount) : ''}</td><td>${t.payeAmount ? fmt(t.payeAmount) : ''}</td><td>${t.contact||''}</td><td>${t.receipt?'<span class="small-muted">Yes</span>':''}</td><td><button class="small" data-id="${t.id}">Del</button></td>`;
      ledgerTableBody.appendChild(tr);
      tr.querySelector('button').addEventListener('click', ()=> {
        if(!confirm('Delete transaction?')) return;
        const arr = state.transactions[selectedUserId][selectedBizId];
        state.transactions[selectedUserId][selectedBizId] = arr.filter(x=>x.id!==t.id);
        saveState(); renderAll();
      });
    });
  }

  // P&L and Tax summary calculations
  function computePLAndTaxes(asOfDate){
    asOfDate = asOfDate || today();
    const b = findBiz(selectedBizId); if(!b) return { pl:{ revenue:0, cogs:0, expenses:0, depreciation:0 }, taxes:{} };
    const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    let revenue = 0, cogs = 0, expenses = 0, payeTotal=0, vatCollected=0, whtTotal=0;
    txns.forEach(t=>{
      if(new Date(t.date) > new Date(asOfDate)) return;
      if(t.action === 'Revenue' || t.action==='InventorySale') revenue += Number(t.amount||0);
      if(t.action === 'InventoryPurchase' || (t.accountCategory==='Expense' && t.action==='Expense')) {
        if(t.accountCategory === 'Expense') expenses += Number(t.amount||0); // general expense
        if(t.action === 'InventoryPurchase') cogs += Number(t.amount||0); // purchases to COGS on P&L classification
      }
      if(t.action === 'Salary') {
        expenses += Number(t.amount||0); // gross salary as expense
        if(t.payeAmount) { payeTotal += Number(t.payeAmount); expenses += Number(t.payeAmount); } // include PAYE as expense
      }
      if(t.vatAmount) vatCollected += Number(t.vatAmount);
      if(t.whtAmount) whtTotal += Number(t.whtAmount);
    });

    // depreciation dynamic calculation: sum monthly depreciation for assets not disposed before asOfDate and prorated; plus depreciation posted on disposals up to disposal date
    let totalDepreciation = 0;
    const assets = b.assets || [];
    assets.forEach(a => {
      if(a.disposed) {
        // depreciation until disposal date (already posted during disposal, but include for P&L reporting)
        const endDate = a.disposalDate || a.disposedOn || asOfDate;
        totalDepreciation += computeDepreciationForAsset(a, a.purchaseDate, endDate);
      } else {
        totalDepreciation += computeDepreciationForAsset(a, a.purchaseDate, asOfDate);
      }
    });

    // Capital allowance: compute CA accumulative on chargeable assets and available carryforward
    let totalCA = 0;
    assets.forEach(a => {
      if(a.classification === 'Chargeable') {
        totalCA += computeCapitalAllowanceForAsset(a, a.purchaseDate, asOfDate);
      }
    });
    // include previously carried forward CA
    const caCarryForwardStart = b.caCarryForward || 0;

    // Taxable profit before CA: revenue - cogs - expenses - depreciation
    const profitBeforeTaxAdjust = revenue - cogs - expenses - totalDepreciation;
    // Apply capital allowance as tax adjustment (reduce taxable profit)
    const caApplied = Math.min(Math.max(totalCA + caCarryForwardStart, 0), Math.max(profitBeforeTaxAdjust,0));
    let taxableProfit = profitBeforeTaxAdjust - caApplied;
    // Carryforward unused CA
    const totalCAAvailable = totalCA + caCarryForwardStart;
    const caUnused = Math.max(totalCAAvailable - caApplied, 0);

    return {
      pl: { revenue, cogs, expenses, depreciation: totalDepreciation, payeTotal },
      taxes: { vatCollected, whtTotal, totalCA, caApplied, caUnused, taxableProfit, profitBeforeTaxAdjust }
    };
  }

  function computeDepreciationForAsset(a, fromDate, toDate){
    if(!a || !a.cost) return 0;
    const purchase = new Date(a.purchaseDate || fromDate);
    const end = new Date(toDate);
    if(end <= purchase) return 0;
    const days = daysBetween(purchase.toISOString().slice(0,10), toDate);
    const annualRate = Number(a.depRate || a.depRateManual || a.depRateDefault || 0);
    const annualDep = (Number(a.cost) - (a.openAccumulatedDep || 0)) * (annualRate/100);
    const prorated = annualDep * (days/365.0);
    // ensure not exceed NBV
    const alreadyAccum = Number(a.accumulatedDep || 0);
    const maxRemaining = Math.max(Number(a.cost) - alreadyAccum, 0);
    return Math.min(prorated, maxRemaining);
  }

  function computeCapitalAllowanceForAsset(a, fromDate, toDate){
    if(!a || !a.cost) return 0;
    const purchase = new Date(a.purchaseDate || fromDate);
    const end = new Date(toDate);
    if(end < purchase) return 0;
    const days = daysBetween(purchase.toISOString().slice(0,10), toDate);
    const caRate = Number(a.caRate || a.caRateManual || a.caRateDefault || 0);
    const annualCA = Number(a.cost) * (caRate/100);
    return annualCA * (days/365.0);
  }

  function renderPLSnapshot(){
    const cp = computePLAndTaxes();
    plSnapshotDiv.innerHTML = `<strong>P&L Snapshot</strong>
      <div class="muted">Revenue: ₦${fmt(cp.pl.revenue)} | COGS: ₦${fmt(cp.pl.cogs)} | Expenses (incl PAYE): ₦${fmt(cp.pl.expenses)} | Depreciation: ₦${fmt(cp.pl.depreciation)}</div>`;
    plSnapshotQuick.innerHTML = `<div><strong>Revenue:</strong> ₦${fmt(cp.pl.revenue)}</div><div><strong>Net Profit (before tax adj):</strong> ₦${fmt(cp.taxes.profitBeforeTaxAdjust)}</div>`;
  }

  function renderTaxSummary(){
    const b = findBiz(selectedBizId);
    if(!b){ taxSummaryDiv.innerHTML='Select a business to view tax summary'; return; }
    const cp = computePLAndTaxes();
    const taxes = cp.taxes;
    const rows = [];
    rows.push(`<div><strong>Tax Summary (as of ${today()})</strong></div>`);
    rows.push(`<div class="muted">VAT Collected: ₦${fmt(taxes.vatCollected)} | WHT Total: ₦${fmt(taxes.whtTotal)}</div>`);
    rows.push(`<div style="margin-top:8px;"><strong>P&L lines</strong></div>`);
    rows.push(`<div>Depreciation (expense): ₦${fmt(cp.pl.depreciation)}</div>`);
    if(b.showLines) rows.push(`<div>Capital Allowance (tax adjustment): ₦${fmt(taxes.totalCA)}</div>`);
    rows.push(`<div>Profit before tax adjustments: ₦${fmt(taxes.profitBeforeTaxAdjust)}</div>`);
    rows.push(`<div>Applied CA against profit: ₦${fmt(taxes.caApplied)}</div>`);
    rows.push(`<div>Unused CA carried forward: ₦${fmt(taxes.caUnused)}</div>`);
    // Gains/losses from disposals: scan assets with disposal info
    let totalGains = 0, totalLosses=0;
    (b.assets||[]).forEach(a=>{
      if(a.disposed){
        const proceeds = Number(a.disposalProceeds || 0);
        const nbv = Number(a.cost || 0) - Number(a.accumulatedDep || 0);
        const gain = proceeds - nbv;
        if(gain>=0) totalGains += gain; else totalLosses += Math.abs(gain);
      }
    });
    rows.push(`<div>Chargeable gain from disposals: ₦${fmt(totalGains)} | Losses on disposal: ₦${fmt(totalLosses)}</div>`);
    // CIT/PIT visibility
    if((b.entity === 'SoleProprietor' || b.pitEnabled) && !b.citEnabled){
      rows.push(`<div style="margin-top:8px;"><strong>PIT (Sole Proprietor)</strong></div>`);
      rows.push(`<div>Taxable profit: ₦${fmt(taxes.taxableProfit)}</div>`);
    } else {
      rows.push(`<div style="margin-top:8px;"><strong>CIT (Company)</strong></div>`);
      rows.push(`<div>Taxable profit: ₦${fmt(taxes.taxableProfit)} | CIT rate: ${fmt(b.citRate)}%</div>`);
    }
    taxSummaryDiv.innerHTML = rows.join('');
  }

  function renderQuickLists(){
    const b = findBiz(selectedBizId); if(!b) return;
    inventoryListDiv.innerHTML = '';
    (b.inventory||[]).forEach(i => {
      const d = document.createElement('div'); d.innerHTML = `<strong>${i.name}</strong> — Qty: ${i.qty} | Avg cost: ₦${fmt(i.avgCost)}`; inventoryListDiv.appendChild(d);
    });
    assetListDiv.innerHTML = '';
    (b.assets||[]).forEach(a => {
      const d = document.createElement('div'); d.innerHTML = `<strong>${a.name}</strong> — Cost: ₦${fmt(a.cost)} | Acc Dep: ₦${fmt(a.accumulatedDep||0)} | ${a.disposed ? '<span class="small-muted">Disposed</span>' : '<span class="small-muted">Active</span>'}`; assetListDiv.appendChild(d);
    });
  }

  // transaction functions
  function addTransaction(){
    if(!selectedUserId || !selectedBizId) return alert('Select user and business');
    const b = findBiz(selectedBizId); if(!b) return;
    const action = txnAction.value || 'Expense';
    const date = txnDate.value || today();
    const desc = txnDesc.value || '';
    const acctId = txnAccount.value;
    const acct = findAccount(b, acctId);
    const amount = Number(txnAmount.value || 0);
    const t = { id: uid('txn'), date, action, accountId: acctId, accountName: acct ? acct.name : '', accountCategory: acct ? acct.category : '', description: desc, amount, vatType: txnVatType.value, contact: txnContact.value || '' };
    // VAT logic (simple)
    if(txnVatType.value === 'exclusive'){ t.vatAmount = amount * (b.vatRate/100); }
    else if(txnVatType.value === 'inclusive'){ t.vatAmount = amount - (amount / (1 + b.vatRate/100)); }
    // WHT logic
    if(txnWht.checked){ const rate = Number(txnWhtRate.value || b.whtRate || DEFAULTS.whtRate); t.whtAmount = amount * (rate/100); t.whtBasis = txnWhtBasis.value || 'gross'; }
    // Salary -> always trigger PAYE calculation and create PAYE entries
    if(action === 'Salary' || txnSalary.checked){
      const gross = amount;
      const paye = computePAYEForSalary(gross, b);
      t.payeAmount = paye;
      // create two transactions: salary (gross) and PAYE tax line (expense) and PAYE liability entry
      const userTxns = state.transactions[selectedUserId][selectedBizId];
      // salary transaction (gross)
      userTxns.push(t);
      // PAYE expense line
      const payeExpenseAccount = b.accounts.find(a=>a.name==='PAYE Expense');
      const payeLiabilityAccount = b.accounts.find(a=>a.name==='PAYE Liability');
      const payeExpense = { id: uid('txn'), date, action:'Tax', accountId: payeExpenseAccount.id, accountName: payeExpenseAccount.name, accountCategory: payeExpenseAccount.category, description: 'PAYE expense for salary: '+(desc||''), amount: paye, payeAmount: paye };
      userTxns.push(payeExpense);
      // PAYE liability (credit)
      const payeLiab = { id: uid('txn'), date, action:'Liability', accountId: payeLiabilityAccount.id, accountName: payeLiabilityAccount.name, accountCategory: payeLiabilityAccount.category, description: 'PAYE liability for salary: '+(desc||''), amount: paye };
      userTxns.push(payeLiab);
      addAudit('txn.add','transaction',t.id,`Added salary and PAYE ${fmt(paye)}`);
      saveState(); renderAll(); resetForms(); return;
    }

    // default single transaction
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {}; state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('txn.add','transaction',t.id,`Added transaction ${action} ${fmt(amount)}`);
    saveState(); renderAll(); resetForms();
  }

  function computePAYEForSalary(gross, biz){
    // Simplified PAYE: use PAYE_BANDS progressive on annualized salary and prorate to monthly if needed
    // For simplicity assume amounts entered are monthly; annualize by *12 for band calculation.
    const monthly = Number(gross||0);
    const annual = monthly * 12;
    // Basic reliefs not implemented fully — use progressive bands
    let taxAnnual = 0;
    let remaining = annual;
    let lower = 0;
    for(const band of PAYE_BANDS){
      const upTo = band.upTo;
      const taxableInBand = Math.max(0, Math.min(upTo - lower, remaining));
      taxAnnual += taxableInBand * band.rate;
      remaining -= taxableInBand;
      lower = upTo;
      if(remaining<=0) break;
    }
    const taxMonthly = taxAnnual / 12;
    return Math.max(0, Math.round(taxMonthly * 100)/100);
  }

  // Opening balances
  function applyOpeningAccount(){
    if(!selectedUserId || !selectedBizId) return alert('Select user and business');
    const date = openDate.value || today();
    const acctId = openAccount.value; const amount = Number(openAmount.value||0);
    if(!acctId) return alert('Select account');
    const acct = findAccount(findBiz(selectedBizId), acctId);
    const t = { id: uid('txn'), date, action:'OpeningBalance', accountId: acctId, accountName: acct.name, accountCategory: acct.category, description: 'Opening balance', amount };
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('opening.add','transaction',t.id,`Applied opening balance to ${acct.name}`);
    saveState(); renderAll();
  }

  function applyOpeningInventory(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const name = (openInvName.value||'').trim(); if(!name) return alert('Item name required');
    const qty = Number(openInvQty.value||0); const cost = Number(openInvCost.value||0);
    const existing = b.inventory.find(i=>i.name.toLowerCase()===name.toLowerCase());
    if(existing){
      // update weighted average
      const totalCostExisting = existing.qty * existing.avgCost;
      const totalNew = qty * cost;
      const newQty = existing.qty + qty;
      const newAvg = newQty ? (totalCostExisting + totalNew) / newQty : 0;
      existing.qty = newQty; existing.avgCost = newAvg;
    } else {
      b.inventory.push({ id: uid('item'), name, qty, avgCost: cost });
    }
    addAudit('opening.inv','inventory',null,`Opening inventory for ${name} qty:${qty} cost:${cost}`);
    saveState(); renderAll();
  }

  function applyOpeningAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const name = (openAssetName.value||'').trim(); if(!name) return alert('Asset name required');
    const purchaseDate = openAssetPurchaseDate.value || today();
    const cost = Number(openAssetCost.value||0);
    const accum = Number(openAssetAccumDep.value||0);
    const life = Number(openAssetLife.value||0);
    const caRate = Number(openAssetCA.value||b.caRateDefault||DEFAULTS.caRateDefault);
    const depRate = Number(openAssetDepRate.value||b.depRateDefault||DEFAULTS.depRateDefault);
    const asset = { id: uid('asset'), name, purchaseDate, cost, accumulatedDep: accum, openAccumulatedDep: accum, life, caRate, depRate, classification:'Fixed', disposed:false };
    b.assets.push(asset);
    addAudit('opening.asset','asset',asset.id,`Added opening asset ${name}`);
    saveState(); renderAll();
  }

  // inventory apply
  function applyInventoryAction(){
    if(!selectedBizId || !selectedUserId) return alert('Select business and user');
    const b = findBiz(selectedBizId);
    const action = txnAction.value;
    if(action === 'InventoryPurchase'){
      const itemName = invNewName.value.trim() || invItemSelect.value;
      if(!itemName) return alert('Item required');
      const qty = Number(invQty.value||0); const unit = Number(invUnitPrice.value||0);
      let item = b.inventory.find(i=>i.name.toLowerCase()===itemName.toLowerCase());
      if(!item){
        item = { id: uid('item'), name: itemName, qty:0, avgCost:0 };
        b.inventory.push(item);
      }
      // weighted average update
      const totalOld = item.qty * item.avgCost;
      const totalNew = qty * unit;
      const newQty = item.qty + qty;
      item.avgCost = newQty ? (totalOld + totalNew) / newQty : 0;
      item.qty = newQty;
      // create transaction to COGS (inventory purchase)
      const acctId = invAccountSelect.value;
      const acct = findAccount(b, acctId);
      const t = { id: uid('txn'), date: invReceipt ? today() : today(), action:'InventoryPurchase', accountId: acctId, accountName: acct ? acct.name : '', accountCategory: acct ? acct.category : '', description: `Purchase ${itemName}`, amount: qty*unit, qty, unitPrice: unit, contact: invContact.value||'' };
      state.transactions[selectedUserId][selectedBizId].push(t);
      addAudit('inv.purchase','inventory',item.id,`Purchased ${qty} ${itemName} @ ${unit}`);
    } else if(action === 'InventorySale'){
      const itemName = invItemSelect.value; if(!itemName) return alert('Select item');
      const qty = Number(invQty.value||0); if(!qty) return alert('Qty required');
      const item = b.inventory.find(i=>i.name===itemName); if(!item) return alert('Item not found');
      if(item.qty < qty) return alert('Insufficient quantity');
      const unit = Number(invUnitPrice.value||item.avgCost);
      const cogs = qty * item.avgCost;
      item.qty -= qty;
      // create sale transaction and record COGS
      const saleAcct = invAccountSelect.value;
      const saleAccount = findAccount(b, saleAcct);
      const tSale = { id: uid('txn'), date: today(), action:'InventorySale', accountId: saleAcct, accountName: saleAccount ? saleAccount.name : '', accountCategory: saleAccount ? saleAccount.category : '', description: `Sale ${itemName}`, amount: qty*unit, qty, unitPrice: unit };
      const tCogs = { id: uid('txn'), date: today(), action:'COGS', accountId: b.accounts.find(a=>a.name==='COGS')?.id || null, accountName: 'COGS', accountCategory: 'Expense', description: `COGS for ${itemName}`, amount: cogs };
      state.transactions[selectedUserId][selectedBizId].push(tSale);
      state.transactions[selectedUserId][selectedBizId].push(tCogs);
      addAudit('inv.sale','inventory',item.id,`Sold ${qty} ${itemName} @ ${unit}`);
    }
    saveState(); renderAll();
  }

  // asset purchase
  function applyAssetPurchase(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const name = (assetName.value||'').trim(); if(!name) return alert('Asset name required');
    const cost = Number(assetCost.value||0); const purchaseDate = assetPurchaseDate.value || today();
    const life = Number(assetLife.value||0); const ca = Number(assetCA.value||b.caRateDefault); const dep = Number(assetDepRate.value||b.depRateDefault);
    const classification = assetClassification.value || 'Fixed';
    const asset = { id: uid('asset'), name, purchaseDate, cost, accumulatedDep:0, life, caRate: ca, depRate: dep, classification, disposed:false };
    b.assets.push(asset);
    // auto-create purchase transaction
    const acctId = assetPurchaseAccount.value;
    const acct = findAccount(b, acctId);
    const t = { id: uid('txn'), date: purchaseDate, action:'FixedAssetPurchase', accountId: acctId, accountName: acct ? acct.name : '', accountCategory: acct ? acct.category : '', description: `Asset purchase ${name}`, amount: cost };
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('asset.add','asset', asset.id, `Added asset ${name}`);
    saveState(); renderAll();
  }

  // asset disposal
  function populateAssetDisposal(){
    assetSelectForDisposal.innerHTML=''; assetDisposalAccount.innerHTML='';
    const b = findBiz(selectedBizId); if(!b) return;
    b.assets.filter(a=>!a.disposed).forEach(a=> {
      const opt = document.createElement('option'); opt.value=a.id; opt.textContent = `${a.name} (Cost ₦${fmt(a.cost)})`; assetSelectForDisposal.appendChild(opt);
    });
    b.accounts.forEach(ac=> {
      const opt = document.createElement('option'); opt.value = ac.id; opt.textContent = `${ac.name} (${ac.category})`; assetDisposalAccount.appendChild(opt);
    });
  }

  function applyAssetDisposal(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const aid = assetSelectForDisposal.value; if(!aid) return alert('Select asset');
    const asset = b.assets.find(a=>a.id===aid); if(!asset) return alert('Asset not found');
    const disposalDate = assetDisposalDate.value || today();
    const proceeds = Number(assetDisposalProceeds.value||0);
    // compute depreciation up to disposalDate
    const depToPost = computeDepreciationForAsset(asset, asset.purchaseDate, disposalDate);
    asset.accumulatedDep = Number(asset.accumulatedDep || 0) + depToPost;
    asset.disposed = true;
    asset.disposalDate = disposalDate;
    asset.disposalProceeds = proceeds;
    // NBV
    const nbv = Math.max(Number(asset.cost) - Number(asset.accumulatedDep), 0);
    const gain = proceeds - nbv;
    let glAccount = null;
    if(gain >= 0){
      glAccount = b.accounts.find(a=>a.name==='Gain on Disposal');
    } else {
      glAccount = b.accounts.find(a=>a.name==='Loss on Disposal');
    }
    // Post ledger entries: depreciation expense up to disposal date (single transaction), disposal proceeds (bank/receipt), gain/loss
    const depAcct = b.accounts.find(a=>a.name==='Depreciation') || { id: uid('acct'), name:'Depreciation', category:'Expense' };
    if(!b.accounts.find(a=>a.name==='Depreciation')) b.accounts.push(depAcct);
    const depTxn = { id: uid('txn'), date: disposalDate, action:'Depreciation', accountId: depAcct.id, accountName: depAcct.name, accountCategory: depAcct.category, description:`Depreciation up to disposal for ${asset.name}`, amount: depToPost };
    const proceedsAcct = assetDisposalAccount.value || b.accounts.find(a=>a.category==='Asset')?.id || b.accounts[0].id;
    const proceedsTxn = { id: uid('txn'), date: disposalDate, action:'DisposalProceeds', accountId: proceedsAcct, accountName: findAccount(b, proceedsAcct)?.name || 'Proceeds', accountCategory: findAccount(b, proceedsAcct)?.category || 'Asset', description:`Disposal proceeds for ${asset.name}`, amount: proceeds };
    // gain/loss entry
    const gainLossAmt = Math.abs(gain);
    const gainLossTxn = { id: uid('txn'), date: disposalDate, action: gain>=0 ? 'GainOnDisposal' : 'LossOnDisposal', accountId: glAccount.id, accountName: glAccount.name, accountCategory: glAccount.category, description:`${gain>=0?'Gain':'Loss'} on disposal for ${asset.name}`, amount: gainLossAmt };

    state.transactions[selectedUserId][selectedBizId].push(depTxn, proceedsTxn, gainLossTxn);
    addAudit('asset.dispose','asset', asset.id, `Disposed asset ${asset.name}, proceeds ${fmt(proceeds)}, dep ${fmt(depToPost)}, gain ${fmt(gain)}`);
    saveState(); renderAll();
  }

  // Reports
  function renderReports(){
    reportContent.innerHTML = '';
    const b = findBiz(selectedBizId); if(!b) return reportContent.innerHTML='Select business';
    // default to tax reconciliation
    renderTaxReconciliation();
  }

  function renderTaxReconciliation(){
    const cp = computePLAndTaxes();
    reportContent.innerHTML = `<h4>Taxable Income Reconciliation</h4>
      <div>Revenue: ₦${fmt(cp.pl.revenue)}</div>
      <div>Less: COGS: ₦${fmt(cp.pl.cogs)}</div>
      <div>Less: Expenses: ₦${fmt(cp.pl.expenses)}</div>
      <div>Less: Depreciation: ₦${fmt(cp.pl.depreciation)}</div>
      <div><strong>Profit before CA: ₦${fmt(cp.taxes.profitBeforeTaxAdjust)}</strong></div>
      <div>Capital Allowance available: ₦${fmt(cp.taxes.totalCA)}</div>
      <div>CA applied: ₦${fmt(cp.taxes.caApplied)}</div>
      <div>Taxable profit: ₦${fmt(cp.taxes.taxableProfit)}</div>`;
  }

  // initial rendering helpers
  function populateAssetPurchaseAccounts(){ populateAccountSelect(); }
  function populateAssetDisposal(){ populateAssetDisposal(); }

  // Initial refresh
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  renderAll();

  </script>
</body>
  </html>
