<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Tax Calculator 2026</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.2rem; }
    h2 { font-size:1.1rem; margin:0 0 8px 0; }
    h3 { font-size:1rem; margin:12px 0 8px 0; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; font-size:0.9rem; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:6px; text-align:left; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; font-weight:600; }
    .totals, .tax-summary, .profit-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:5%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(850px,96vw); max-height:88vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .smallInput { width:96px; }
    .subform-table { width:100%; border-collapse:collapse; margin:8px 0; }
    .subform-table th, .subform-table td { border:1px solid #ddd; padding:4px 6px; }
    .subform-table th { background:#f5f5f5; font-weight:600; font-size:0.85rem; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Tax Calculator 2026</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <!-- Inventory Transaction Section -->
    <section class="panel section">
      <h2>Inventory Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="invDate" /></label>
        <label>Action:
          <select id="invAction">
            <option value="Purchase">Purchase</option>
            <option value="Sale">Sale</option>
            <option value="Disposal">Disposal</option>
            <option value="Other">Other</option>
          </select>
        </label>
        <label>Description: <input type="text" id="invDesc" placeholder="Details" style="width:200px;" /></label>
      </div>
      
      <h3>Items</h3>
      <table class="subform-table" id="invItemsTable">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Quantity</th>
            <th>Unit Cost/Price (₦)</th>
            <th>VAT Applicable</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="invItemsBody"></tbody>
      </table>
      <div class="form-inline">
        <input type="text" id="newItemName" placeholder="Item name" style="width:150px;" />
        <input type="number" id="newItemQty" placeholder="Qty" min="0" step="0.01" class="smallInput" />
        <input type="number" id="newItemPrice" placeholder="Price" min="0" step="0.01" class="smallInput" />
        <label><input type="checkbox" id="newItemVat" /> VAT</label>
        <button class="small" id="btnAddItem">Add Item</button>
      </div>
      <button class="primary" id="btnSaveInventory" style="margin-top:8px;">Save Transaction</button>
      <small class="note">For Purchase: unit cost. For Sale: unit price. COGS computed using moving weighted average.</small>
    </section>

    <!-- Fixed Assets Section -->
    <section class="panel section">
      <h2>Fixed Assets</h2>
      <table class="subform-table" id="assetsTable">
        <thead>
          <tr>
            <th>Asset Name</th>
            <th>Purchase Date</th>
            <th>Cost (₦)</th>
            <th>Useful Life (years)</th>
            <th>Capital Allowance %</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="assetsBody"></tbody>
      </table>
      <h3>Add/Dispose Asset</h3>
      <div class="form-inline">
        <input type="text" id="newAssetName" placeholder="Asset name" style="width:150px;" />
        <input type="date" id="newAssetDate" />
        <input type="number" id="newAssetCost" placeholder="Cost" min="0" step="0.01" class="smallInput" />
        <input type="number" id="newAssetLife" placeholder="Life (yrs)" min="1" step="1" class="smallInput" />
        <input type="number" id="newAssetCA" placeholder="CA %" min="0" max="100" step="0.1" class="smallInput" value="20" />
        <button class="small primary" id="btnAddAsset">Add Asset</button>
      </div>
      <small class="note">Depreciation: straight-line, prorated by days. Capital allowance: annual % apportioned monthly.</small>
    </section>

    <!-- Transactions Ledger -->
    <section class="panel section">
      <h2>Transactions History</h2>
      <table class="ledger-table" id="txnTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Description</th>
            <th>Amount (₦)</th>
            <th>VAT (₦)</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="txnBody"></tbody>
      </table>
    </section>

    <!-- Profit & Tax Summary -->
    <section class="panel section">
      <h2>Profit & Tax Summary</h2>
      <div id="profitSummary" class="profit-summary"></div>
      <div id="taxSummary" class="tax-summary" style="margin-top:10px;"></div>
    </section>
  </main>

  <!-- Business Modal -->
  <div id="modalOverlay" class="modalOverlay"></div>
  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business Name: <input type="text" id="bizName" style="width:250px;" /></label>
      <label>Entity Type:
        <select id="bizEntityType">
          <option value="Company">Company</option>
          <option value="Sole proprietor">Sole proprietor</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>VAT Rate (%): <input type="number" id="bizVatRate" value="7.5" min="0" step="0.01" class="smallInput" /></label>
      <label>WHT Rate (%): <input type="number" id="bizWhtRate" value="5.0" min="0" step="0.01" class="smallInput" /></label>
      <label><input type="checkbox" id="bizVatEnabled" checked /> Enable VAT</label>
    </div>
    <h3>Tax Summary Display Options</h3>
    <div class="row">
      <label><input type="checkbox" id="showVAT" checked /> Show VAT</label>
      <label><input type="checkbox" id="showWHT" checked /> Show WHT</label>
      <label><input type="checkbox" id="showPAYE" checked /> Show PAYE</label>
      <label><input type="checkbox" id="showPIT" checked /> Show PIT</label>
      <label><input type="checkbox" id="showCIT" checked /> Show CIT</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'ntc_2026_data';
    
    // Tax law constants for Nigeria 2026
    const CRA_MIN_AMOUNT = 200000;  // Minimum CRA in Naira
    const CRA_INCOME_PERCENT = 0.01;  // 1% of gross income
    const CRA_ADDITIONAL_PERCENT = 0.20;  // Additional 20% of gross income
    const AVERAGE_DAYS_PER_MONTH = 30.44;  // Average days per month for depreciation calculation
    
    // Nigeria 2026 PIT bands
    const PIT_BANDS = [
      { limit: 3000000, rate: 0.19 },
      { limit: 6000000, rate: 0.21 },
      { limit: 9000000, rate: 0.23 },
      { limit: 12000000, rate: 0.24 },
      { limit: Infinity, rate: 0.25 }
    ];
    
    // CIT rates
    const CIT_THRESHOLD = 50000000;
    const CIT_RATE_ABOVE = 0.25;
    
    // Data model: { businesses: [], inventory: {bizId: {itemName: {qty, totalCost}}}, assets: {bizId: []}, transactions: {bizId: []} }
    let data = { businesses: [], inventory: {}, assets: {}, transactions: {} };
    let selectedBusinessId = null;
    let currentItems = []; // temporary for building inventory transaction
    let editingBizId = null;
    
    // UI elements
    const businessSelect = document.getElementById('businessSelect');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
    
    const invDate = document.getElementById('invDate');
    const invAction = document.getElementById('invAction');
    const invDesc = document.getElementById('invDesc');
    const invItemsBody = document.getElementById('invItemsBody');
    const newItemName = document.getElementById('newItemName');
    const newItemQty = document.getElementById('newItemQty');
    const newItemPrice = document.getElementById('newItemPrice');
    const newItemVat = document.getElementById('newItemVat');
    const btnAddItem = document.getElementById('btnAddItem');
    const btnSaveInventory = document.getElementById('btnSaveInventory');
    
    const assetsBody = document.getElementById('assetsBody');
    const newAssetName = document.getElementById('newAssetName');
    const newAssetDate = document.getElementById('newAssetDate');
    const newAssetCost = document.getElementById('newAssetCost');
    const newAssetLife = document.getElementById('newAssetLife');
    const newAssetCA = document.getElementById('newAssetCA');
    const btnAddAsset = document.getElementById('btnAddAsset');
    
    const txnBody = document.getElementById('txnBody');
    const profitSummary = document.getElementById('profitSummary');
    const taxSummary = document.getElementById('taxSummary');
    
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizEntityType = document.getElementById('bizEntityType');
    const bizVatRate = document.getElementById('bizVatRate');
    const bizWhtRate = document.getElementById('bizWhtRate');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const showVAT = document.getElementById('showVAT');
    const showWHT = document.getElementById('showWHT');
    const showPAYE = document.getElementById('showPAYE');
    const showPIT = document.getElementById('showPIT');
    const showCIT = document.getElementById('showCIT');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');
    
    const modalOverlay = document.getElementById('modalOverlay');
    
    // Helper functions
    function uid(prefix='id'){ return prefix + '_' + Date.now() + '_' + Math.random().toString(36).slice(2,8); }
    function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function today(){ return new Date().toISOString().slice(0,10); }
    
    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          data = JSON.parse(raw);
          migrateData();
          return;
        } catch(e){ console.error('load error', e); }
      }
      seedDemo();
    }
    
    function migrateData(){
      if (!data.businesses) data.businesses = [];
      if (!data.inventory) data.inventory = {};
      if (!data.assets) data.assets = {};
      if (!data.transactions) data.transactions = {};
      data.businesses.forEach(b => {
        if (!b.entityType) b.entityType = 'Company';
        if (typeof b.vatRate === 'undefined') b.vatRate = 7.5;
        if (typeof b.whtRate === 'undefined') b.whtRate = 5.0;
        if (typeof b.vatEnabled === 'undefined') b.vatEnabled = true;
        if (typeof b.showVAT === 'undefined') b.showVAT = true;
        if (typeof b.showWHT === 'undefined') b.showWHT = true;
        if (typeof b.showPAYE === 'undefined') b.showPAYE = true;
        if (typeof b.showPIT === 'undefined') b.showPIT = true;
        if (typeof b.showCIT === 'undefined') b.showCIT = true;
      });
      saveData();
    }
    
    function seedDemo(){
      const bid = uid('biz');
      data = {
        businesses: [{
          id: bid,
          name: 'Demo Business',
          entityType: 'Company',
          vatRate: 7.5,
          whtRate: 5.0,
          vatEnabled: true,
          showVAT: true,
          showWHT: true,
          showPAYE: true,
          showPIT: false,
          showCIT: true
        }],
        inventory: {},
        assets: {},
        transactions: {}
      };
      data.inventory[bid] = {};
      data.assets[bid] = [];
      data.transactions[bid] = [];
      saveData();
    }
    
    function findBiz(id){ return data.businesses.find(b => b.id === id); }
    
    function openModal(modal){ modalOverlay.style.display = 'block'; modal.style.display = 'block'; }
    function closeModal(modal){ modalOverlay.style.display = 'none'; modal.style.display = 'none'; editingBizId = null; }
    
    modalOverlay.addEventListener('click', () => {
      if (businessModal.style.display === 'block') closeModal(businessModal);
    });
    
    // Init
    loadData();
    refreshBusinessSelect();
    ensureSelection();
    resetInventoryForm();
    renderAssets();
    renderTransactions();
    renderSummaries();
    
    function refreshBusinessSelect(){
      businessSelect.innerHTML = '';
      data.businesses.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name} (${b.entityType})`;
        businessSelect.appendChild(opt);
      });
    }
    
    function ensureSelection(){
      if (!selectedBusinessId && data.businesses.length > 0) {
        selectedBusinessId = data.businesses[0].id;
      }
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }
    
    businessSelect.addEventListener('change', () => {
      selectedBusinessId = businessSelect.value;
      renderAssets();
      renderTransactions();
      renderSummaries();
    });
    
    // Business CRUD
    btnAddBusiness.addEventListener('click', () => {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = '';
      bizEntityType.value = 'Company';
      bizVatRate.value = '7.5';
      bizWhtRate.value = '5.0';
      bizVatEnabled.checked = true;
      showVAT.checked = true;
      showWHT.checked = true;
      showPAYE.checked = true;
      showPIT.checked = true;
      showCIT.checked = true;
      editingBizId = null;
      openModal(businessModal);
    });
    
    btnEditBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizEntityType.value = b.entityType || 'Company';
      bizVatRate.value = b.vatRate || 7.5;
      bizWhtRate.value = b.whtRate || 5.0;
      bizVatEnabled.checked = !!b.vatEnabled;
      showVAT.checked = !!b.showVAT;
      showWHT.checked = !!b.showWHT;
      showPAYE.checked = !!b.showPAYE;
      showPIT.checked = !!b.showPIT;
      showCIT.checked = !!b.showCIT;
      editingBizId = b.id;
      openModal(businessModal);
    });
    
    btnDeleteBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      if (!confirm('Delete business and all data?')) return;
      data.businesses = data.businesses.filter(b => b.id !== selectedBusinessId);
      delete data.inventory[selectedBusinessId];
      delete data.assets[selectedBusinessId];
      delete data.transactions[selectedBusinessId];
      saveData();
      selectedBusinessId = null;
      refreshBusinessSelect();
      ensureSelection();
      renderAssets();
      renderTransactions();
      renderSummaries();
    });
    
    bizSave.addEventListener('click', () => {
      const name = (bizName.value || '').trim();
      if (!name) return alert('Business name required');
      const obj = {
        name,
        entityType: bizEntityType.value,
        vatRate: Number(bizVatRate.value || 0),
        whtRate: Number(bizWhtRate.value || 0),
        vatEnabled: !!bizVatEnabled.checked,
        showVAT: !!showVAT.checked,
        showWHT: !!showWHT.checked,
        showPAYE: !!showPAYE.checked,
        showPIT: !!showPIT.checked,
        showCIT: !!showCIT.checked
      };
      if (editingBizId) {
        const b = findBiz(editingBizId);
        if (b) Object.assign(b, obj);
      } else {
        const id = uid('biz');
        obj.id = id;
        data.businesses.push(obj);
        data.inventory[id] = {};
        data.assets[id] = [];
        data.transactions[id] = [];
        selectedBusinessId = id;
      }
      saveData();
      refreshBusinessSelect();
      ensureSelection();
      closeModal(businessModal);
      renderSummaries();
    });
    
    bizCancel.addEventListener('click', () => closeModal(businessModal));
    
    // Inventory management
    function resetInventoryForm(){
      invDate.value = today();
      invAction.value = 'Purchase';
      invDesc.value = '';
      currentItems = [];
      renderItemsTable();
    }
    
    function renderItemsTable(){
      invItemsBody.innerHTML = '';
      currentItems.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>${fmt(item.price)}</td>
          <td>${item.vat ? 'Yes' : 'No'}</td>
          <td><button class="small danger" onclick="removeItem(${idx})">Remove</button></td>
        `;
        invItemsBody.appendChild(tr);
      });
    }
    
    window.removeItem = function(idx){
      currentItems.splice(idx, 1);
      renderItemsTable();
    };
    
    btnAddItem.addEventListener('click', () => {
      const name = (newItemName.value || '').trim();
      const qty = Number(newItemQty.value || 0);
      const price = Number(newItemPrice.value || 0);
      if (!name || qty <= 0 || price < 0) return alert('Invalid item data');
      currentItems.push({ name, qty, price, vat: !!newItemVat.checked });
      newItemName.value = '';
      newItemQty.value = '';
      newItemPrice.value = '';
      newItemVat.checked = false;
      renderItemsTable();
    });
    
    btnSaveInventory.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      if (currentItems.length === 0) return alert('Add at least one item');
      const biz = findBiz(selectedBusinessId);
      if (!biz) return;
      
      const action = invAction.value;
      const date = invDate.value || today();
      const desc = invDesc.value || '';
      
      // Initialize inventory for this business if needed
      if (!data.inventory[selectedBusinessId]) data.inventory[selectedBusinessId] = {};
      const inv = data.inventory[selectedBusinessId];
      
      let totalAmount = 0;
      let totalVAT = 0;
      let totalCOGS = 0;
      const itemDetails = [];
      
      currentItems.forEach(item => {
        const itemName = item.name;
        if (!inv[itemName]) inv[itemName] = { qty: 0, totalCost: 0 };
        
        let itemAmount = item.qty * item.price;
        let itemVAT = 0;
        let itemCOGS = 0;
        
        if (action === 'Purchase') {
          // Add to inventory
          inv[itemName].qty += item.qty;
          inv[itemName].totalCost += itemAmount;
          if (item.vat && biz.vatEnabled) {
            itemVAT = itemAmount * (biz.vatRate / 100);
          }
        } else if (action === 'Sale') {
          // Calculate COGS using moving weighted average
          const avgCost = inv[itemName].qty > 0 ? inv[itemName].totalCost / inv[itemName].qty : 0;
          itemCOGS = item.qty * avgCost;
          
          // Reduce inventory
          inv[itemName].qty -= item.qty;
          inv[itemName].totalCost -= itemCOGS;
          if (inv[itemName].qty < 0) {
            alert(`Warning: Negative inventory for ${itemName}`);
            inv[itemName].qty = 0;
            // Keep totalCost at 0 or the remaining value if any
            if (inv[itemName].totalCost < 0) inv[itemName].totalCost = 0;
          }
          
          if (item.vat && biz.vatEnabled) {
            itemVAT = itemAmount * (biz.vatRate / 100);
          }
        } else if (action === 'Disposal') {
          // Remove from inventory at cost
          const avgCost = inv[itemName].qty > 0 ? inv[itemName].totalCost / inv[itemName].qty : 0;
          itemCOGS = item.qty * avgCost;
          inv[itemName].qty -= item.qty;
          inv[itemName].totalCost -= itemCOGS;
          if (inv[itemName].qty < 0) {
            inv[itemName].qty = 0;
            if (inv[itemName].totalCost < 0) inv[itemName].totalCost = 0;
          }
        }
        
        totalAmount += itemAmount;
        totalVAT += itemVAT;
        totalCOGS += itemCOGS;
        itemDetails.push({ name: itemName, qty: item.qty, price: item.price, vat: itemVAT, cogs: itemCOGS });
      });
      
      // Save transaction
      if (!data.transactions[selectedBusinessId]) data.transactions[selectedBusinessId] = [];
      const txn = {
        id: uid('txn'),
        date,
        type: 'Inventory',
        action,
        description: desc,
        amount: totalAmount,
        vat: totalVAT,
        cogs: totalCOGS,
        items: itemDetails
      };
      data.transactions[selectedBusinessId].push(txn);
      
      saveData();
      resetInventoryForm();
      renderTransactions();
      renderSummaries();
      alert('Inventory transaction saved');
    });
    
    // Fixed Assets
    function renderAssets(){
      assetsBody.innerHTML = '';
      if (!selectedBusinessId) return;
      const assets = data.assets[selectedBusinessId] || [];
      assets.forEach((asset, idx) => {
        const tr = document.createElement('tr');
        const status = asset.disposalDate ? 'Disposed' : 'Active';
        tr.innerHTML = `
          <td>${asset.name}</td>
          <td>${asset.purchaseDate}</td>
          <td>${fmt(asset.cost)}</td>
          <td>${asset.usefulLife}</td>
          <td>${asset.capitalAllowance}%</td>
          <td>${status}</td>
          <td>${!asset.disposalDate ? `<button class="small danger" onclick="disposeAsset(${idx})">Dispose</button>` : ''}</td>
        `;
        assetsBody.appendChild(tr);
      });
    }
    
    window.disposeAsset = function(idx){
      if (!selectedBusinessId) return;
      const asset = data.assets[selectedBusinessId][idx];
      if (!asset) return;
      const date = prompt('Disposal date (YYYY-MM-DD):', today());
      if (!date) return;
      asset.disposalDate = date;
      saveData();
      renderAssets();
      renderSummaries();
    };
    
    btnAddAsset.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      const name = (newAssetName.value || '').trim();
      const date = newAssetDate.value || today();
      const cost = Number(newAssetCost.value || 0);
      const life = Number(newAssetLife.value || 0);
      const ca = Number(newAssetCA.value || 0);
      if (!name || cost <= 0 || life <= 0) return alert('Invalid asset data');
      
      if (!data.assets[selectedBusinessId]) data.assets[selectedBusinessId] = [];
      data.assets[selectedBusinessId].push({
        id: uid('asset'),
        name,
        purchaseDate: date,
        cost,
        usefulLife: life,
        capitalAllowance: ca,
        disposalDate: null
      });
      
      newAssetName.value = '';
      newAssetDate.value = '';
      newAssetCost.value = '';
      newAssetLife.value = '';
      newAssetCA.value = '20';
      
      saveData();
      renderAssets();
      renderSummaries();
    });
    
    // Transactions display
    function renderTransactions(){
      txnBody.innerHTML = '';
      if (!selectedBusinessId) return;
      const txns = data.transactions[selectedBusinessId] || [];
      txns.forEach(txn => {
        const tr = document.createElement('tr');
        let details = '';
        if (txn.type === 'Inventory' && txn.items) {
          details = txn.items.map(i => `${i.name} x${i.qty}`).join(', ');
          if (txn.action === 'Sale') details += ` (COGS: ₦${fmt(txn.cogs)})`;
        }
        tr.innerHTML = `
          <td>${txn.date}</td>
          <td>${txn.type}${txn.action ? ' - ' + txn.action : ''}</td>
          <td>${txn.description || ''}</td>
          <td>${fmt(txn.amount)}</td>
          <td>${fmt(txn.vat)}</td>
          <td>${details}</td>
        `;
        txnBody.appendChild(tr);
      });
    }
    
    // Profit & Tax Computations
    function computeProfitAndTax(){
      if (!selectedBusinessId) return {};
      const biz = findBiz(selectedBusinessId);
      const txns = data.transactions[selectedBusinessId] || [];
      const assets = data.assets[selectedBusinessId] || [];
      
      let revenue = 0;
      let cogs = 0;
      let otherExpenses = 0;
      let vat = 0;
      let wht = 0;
      
      txns.forEach(txn => {
        if (txn.type === 'Inventory' && txn.action === 'Sale') {
          revenue += txn.amount;
          cogs += txn.cogs || 0;
          vat += txn.vat || 0;
        } else if (txn.type === 'Inventory' && txn.action === 'Purchase') {
          vat += txn.vat || 0;
        }
      });
      
      // Compute depreciation and capital allowance
      const today = new Date();
      let depreciation = 0;
      let capitalAllowance = 0;
      
      assets.forEach(asset => {
        const startDate = new Date(asset.purchaseDate);
        const endDate = asset.disposalDate ? new Date(asset.disposalDate) : today;
        
        // Days held
        const daysHeld = Math.max(0, Math.floor((endDate - startDate) / (1000*60*60*24)));
        const monthsHeld = daysHeld / AVERAGE_DAYS_PER_MONTH;
        
        // Straight-line depreciation prorated by days
        const annualDepreciation = asset.cost / asset.usefulLife;
        const monthlyDepreciation = annualDepreciation / 12;
        depreciation += monthlyDepreciation * monthsHeld;
        
        // Capital allowance apportioned monthly
        const annualCA = asset.cost * (asset.capitalAllowance / 100);
        const monthlyCA = annualCA / 12;
        capitalAllowance += monthlyCA * monthsHeld;
      });
      
      const grossProfit = revenue - cogs;
      const totalExpenses = otherExpenses + depreciation;
      const netProfit = grossProfit - totalExpenses;
      
      // Taxable income = net profit - capital allowance
      const taxableIncome = Math.max(0, netProfit - capitalAllowance);
      
      // Compute taxes
      let pit = 0;
      let cit = 0;
      let paye = 0; // simplified: assume 10% of salary expenses if any
      
      if (biz.entityType === 'Sole proprietor') {
        // PIT calculation with 2026 bands
        // CRA = max(₦200,000, 1% of gross income) + 20% of gross income
        const grossIncome = revenue;
        const craBase = Math.max(CRA_MIN_AMOUNT, grossIncome * CRA_INCOME_PERCENT);
        const cra = craBase + grossIncome * CRA_ADDITIONAL_PERCENT;
        const taxableForPIT = Math.max(0, taxableIncome - cra);
        
        // Progressive PIT bands
        let remaining = taxableForPIT;
        let cumulative = 0;
        for (const band of PIT_BANDS) {
          const taxableInBand = Math.min(remaining, band.limit - cumulative);
          if (taxableInBand <= 0) break;
          pit += taxableInBand * band.rate;
          remaining -= taxableInBand;
          cumulative += taxableInBand;
        }
      } else {
        // CIT calculation: 0% on first ₦50M, 25% on amount above ₦50M
        if (taxableIncome > CIT_THRESHOLD) {
          cit = (taxableIncome - CIT_THRESHOLD) * CIT_RATE_ABOVE;
        }
        // else cit remains 0 for income below threshold
      }
      
      return {
        revenue,
        cogs,
        grossProfit,
        depreciation,
        capitalAllowance,
        totalExpenses,
        netProfit,
        taxableIncome,
        vat,
        wht,
        paye,
        pit,
        cit
      };
    }
    
    function renderSummaries(){
      if (!selectedBusinessId) {
        profitSummary.innerHTML = '<em>Select a business</em>';
        taxSummary.innerHTML = '';
        return;
      }
      
      const biz = findBiz(selectedBusinessId);
      const calc = computeProfitAndTax();
      
      let html = `<strong>Profit Summary</strong><br/>`;
      html += `Revenue: ₦${fmt(calc.revenue)}<br/>`;
      html += `COGS: ₦${fmt(calc.cogs)}<br/>`;
      html += `Gross Profit: ₦${fmt(calc.grossProfit)}<br/>`;
      html += `Expenses (Depreciation): ₦${fmt(calc.depreciation)}<br/>`;
      html += `Net Profit: ₦${fmt(calc.netProfit)}<br/>`;
      html += `Capital Allowance: ₦${fmt(calc.capitalAllowance)}<br/>`;
      html += `<strong>Taxable Income: ₦${fmt(calc.taxableIncome)}</strong>`;
      profitSummary.innerHTML = html;
      
      let taxHtml = `<strong>Tax Summary</strong><br/>`;
      if (biz.showVAT) taxHtml += `VAT: ₦${fmt(calc.vat)}<br/>`;
      if (biz.showWHT) taxHtml += `WHT: ₦${fmt(calc.wht)}<br/>`;
      if (biz.showPAYE) taxHtml += `PAYE: ₦${fmt(calc.paye)}<br/>`;
      if (biz.showPIT && biz.entityType === 'Sole proprietor') {
        taxHtml += `PIT: ₦${fmt(calc.pit)}<br/>`;
      }
      if (biz.showCIT && biz.entityType === 'Company') {
        taxHtml += `CIT: ₦${fmt(calc.cit)}<br/>`;
      }
      taxSummary.innerHTML = taxHtml;
    }
    
    // Export/Import
    document.getElementById('btnExport').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'nigeria-tax-data.json';
      a.click();
      URL.revokeObjectURL(url);
    });
    
    document.getElementById('btnImport').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });
    
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          data = JSON.parse(reader.result);
          migrateData();
          refreshBusinessSelect();
          ensureSelection();
          renderAssets();
          renderTransactions();
          renderSummaries();
          alert('Data imported');
        } catch(err) {
          alert('Invalid JSON file');
        }
      };
      reader.readAsText(file);
    });
    
    document.getElementById('btnClearAll').addEventListener('click', () => {
      if (!confirm('Clear all data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    });
  </script>
</body>
</html>
