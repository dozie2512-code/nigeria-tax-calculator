<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Tax & Accounting — 2026 PIT/CIT + Inventory (Average Cost) + Fixed Assets</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:18px; color:#222; background:#fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(920px,96vw); max-height:80vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .smallInput { width:110px; }
    .table-scroll { max-height:220px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Tax & Accounting — 2026 (PIT/CIT)</h1>

    <div class="panel controls" style="align-items:center;">
      <label>User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none;" />
    </div>
  </header>

  <main>
    <!-- Add Transaction / Inventory / Asset panel -->
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnDisallowable" /> Disallowable expense (adds back)
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnNonTax" /> Non-taxable income (exclude)
        </label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>
          <label class="inline-label"><input type="checkbox" id="invVat" /> VAT applies</label>
          <label class="inline-label"><input type="checkbox" id="invDisallowable" /> Disallowable</label>
          <label class="inline-label"><input type="checkbox" id="invNonTax" /> Non-taxable</label>
          <button id="btnAddInv" class="small">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
        </div>
        <small class="note">Inventory uses moving weighted average (average cost) for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <button id="btnAddAsset" class="small">Record Asset Purchase</button>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
        </div>
        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days for mid-month purchase/disposal. Capital allowance applied monthly from purchase.</small>
      </div>
    </section>

    <!-- Ledger -->
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount (Net)</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Inv Item / Asset</th><th>Disallowable</th><th>Non-tax</th><th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="totalsSummary" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <!-- Inventory & Assets display -->
    <section class="panel section grid">
      <div>
        <h3>Inventory</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot</h3>
        <div id="plSnapshot" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">GitHub Copilot Chat Assistant — implemented per request</footer>

  <script>
    // GitHub Copilot Chat Assistant implementation
    const STORAGE_KEY = 'ntc_2026_v1';

    // Defaults
    const DEFAULTS = {
      vatRate: 7.5,
      whtRate: 5.0,
      citRate: 25.0,
      vatEnabled: true,
      payeEnabled: true,
      pitEnabled: true,
      showLines: true
    };

    // 2026 PIT bands (hard-coded as requested)
    const PIT_BANDS_2026 = [
      { upTo: 3000000, rate: 0.19 },
      { upTo: 6000000, rate: 0.21 },
      { upTo: 9000000, rate: 0.23 },
      { upTo: 12000000, rate: 0.24 },
      { upTo: Infinity, rate: 0.25 }
    ];

    // Data model
    // data = { users:[], businesses:[], transactions: { [userId]: { [bizId]: [] } } }
    let data = { users: [], businesses: [], transactions: {} };
    let selectedUser = null;
    let selectedBiz = null;

    // DOM refs
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
    const btnManageAccounts = document.getElementById('btnManageAccounts');

    const txnDate = document.getElementById('txnDate');
    const txnAction = document.getElementById('txnAction');
    const txnAccount = document.getElementById('txnAccount');
    const txnDesc = document.getElementById('txnDesc');
    const txnAmount = document.getElementById('txnAmount');
    const txnWht = document.getElementById('txnWht');
    const txnWhtRate = document.getElementById('txnWhtRate');
    const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
    const txnSalary = document.getElementById('txnSalary');
    const btnAddTxn = document.getElementById('btnAddTxn');
    const txnDisallowable = document.getElementById('txnDisallowable');
    const txnNonTax = document.getElementById('txnNonTax');

    const inventorySubform = document.getElementById('inventorySubform');
    const invItemSelect = document.getElementById('invItemSelect');
    const invNewName = document.getElementById('invNewName');
    const invQty = document.getElementById('invQty');
    const invUnitPrice = document.getElementById('invUnitPrice');
    const invVat = document.getElementById('invVat');
    const btnAddInv = document.getElementById('btnAddInv');
    const btnInvCancel = document.getElementById('btnInvCancel');
    const invDisallowable = document.getElementById('invDisallowable');
    const invNonTax = document.getElementById('invNonTax');

    const assetSubform = document.getElementById('assetSubform');
    const assetName = document.getElementById('assetName');
    const assetCost = document.getElementById('assetCost');
    const assetPurchaseDate = document.getElementById('assetPurchaseDate');
    const assetLife = document.getElementById('assetLife');
    const assetCA = document.getElementById('assetCA');
    const assetDisposalDate = document.getElementById('assetDisposalDate');
    const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
    const btnAddAsset = document.getElementById('btnAddAsset');
    const btnDisposeAsset = document.getElementById('btnDisposeAsset');
    const btnAssetCancel = document.getElementById('btnAssetCancel');

    const ledgerTable = document.querySelector('#ledgerTable tbody');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const inventoryListDiv = document.getElementById('inventoryList');
    const assetListDiv = document.getElementById('assetList');
    const plSnapshotDiv = document.getElementById('plSnapshot');

    // Modals
    const modalOverlay = document.getElementById('modalOverlay');
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwnerSelect = document.getElementById('bizOwner');
    const bizEntity = document.getElementById('bizEntity');
    const bizVat = document.getElementById('bizVat');
    const bizWht = document.getElementById('bizWht');
    const bizCit = document.getElementById('bizCit');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizPayeEnabled = document.getElementById('bizPayeEnabled');
    const bizShowLines = document.getElementById('bizShowLines');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');
    const bizLossBF = document.getElementById('bizLossBF');
    const bizCACF = document.getElementById('bizCACF');

    const accountsModal = document.getElementById('accountsModal');
    const accountsList = document.getElementById('accountsList');
    const newAccountName = document.getElementById('newAccountName');
    const newAccountCategory = document.getElementById('newAccountCategory');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const closeAccountsBtn = document.getElementById('closeAccountsBtn');

    const mainTxnForm = document.getElementById('mainTxnForm');

    // helper utils
    function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function today(){ return new Date().toISOString().slice(0,10); }

    // load/save
    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){ try { data = JSON.parse(raw); migrateData(); return; } catch(e){ console.error('invalid data', e); } }
      seedDemo();
    }

    function migrateData(){
      if (!data.users) data.users = [];
      if (!data.businesses) data.businesses = [];
      if (!data.transactions) data.transactions = {};
      data.businesses.forEach(b => {
        b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
        b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
        b.citRate = Number(b.citRate || DEFAULTS.citRate);
        b.vatEnabled = !!b.vatEnabled;
        b.payeEnabled = !!b.payeEnabled;
        b.pitEnabled = !!b.pitEnabled;
        b.showLines = (typeof b.showLines === 'undefined') ? true : !!b.showLines;
        b.entity = b.entity || 'Company';
        if (!b.accounts) b.accounts = [];
        if (!b.inventory) b.inventory = []; // items: {id,name,qty,avgCost}
        if (!b.assets) b.assets = []; // assets store
        b.lossBroughtForward = Number(b.lossBroughtForward || 0);
        b.caCarryForward = Number(b.caCarryForward || 0);
      });
      // ensure transaction arrays exist
      for (const u of data.users){
        if (!data.transactions[u.id]) data.transactions[u.id] = {};
        data.businesses.forEach(b => { if (!data.transactions[u.id][b.id]) data.transactions[u.id][b.id] = []; });
      }
      saveData();
    }

    function seedDemo(){
      const u = uid('user'), b = uid('biz');
      const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
      const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const expenseSalary = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      data = {
        users: [{ id: u, username: 'demo', display: 'Demo User' }],
        businesses: [{
          id: b, name: 'Demo Business', ownerId: u, entity: 'Company',
          vatRate: 7.5, whtRate: 5.0, citRate: 25.0,
          vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true,
          accounts: [sales, cogs, expenseSalary],
          inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
          assets: [],
          lossBroughtForward: 0,
          caCarryForward: 0
        }],
        transactions: {}
      };
      data.transactions[u] = {};
      data.transactions[u][b] = [
        // small demo transaction
        { id: uid('txn'), date: today(), action: 'Revenue', accountId: sales.id, accountName: sales.name, description:'Demo sale', amount: 150000, vatAmount: 11250, whtApplied:false, whtAmount:0, isSalary:false, payeAmount:0, disallowable:false, nonTaxable:false, userId:u }
      ];
      saveData();
    }

    // UI helpers: modal open/close
    function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; }
    function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }

    modalOverlay.addEventListener('click', () => {
      [userModal, businessModal, accountsModal].forEach(m => { if (m.style.display === 'block') closeModal(m); });
    });

    // init
    loadData();
    initUI();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    resetForms();
    renderAll();

    // --- Initialization & UI wiring ---
    function initUI(){
      // user buttons
      btnAddUser.addEventListener('click', ()=>{ userModalTitle.textContent='Add User'; userName.value=''; userDisplay.value=''; openModal(userModal); userSave.dataset.edit=''; });
      btnEditUser.addEventListener('click', ()=>{ if(!selectedUser) return alert('Select user'); const u = findUser(selectedUser); userModalTitle.textContent='Edit User'; userName.value=u.username; userDisplay.value=u.display||''; openModal(userModal); userSave.dataset.edit = u.id; });
      btnDeleteUser.addEventListener('click', ()=>{ if(!selectedUser) return alert('Select user'); if(!confirm('Delete user and their businesses & transactions?')) return; deleteUser(selectedUser); });

      userSave.addEventListener('click', ()=>{ const uname=(userName.value||'').trim(); if(!uname) return alert('Username required'); const id=userSave.dataset.edit; if(id){ const u=findUser(id); u.username = uname; u.display = userDisplay.value||uname; } else { const idn = uid('user'); data.users.push({ id: idn, username: uname, display: userDisplay.value||uname }); data.transactions[idn] = {}; } saveData(); closeModal(userModal); refreshSelectors(); ensureSelection(); renderAll(); });
      userCancel.addEventListener('click', ()=>closeModal(userModal));

      // business
      btnAddBusiness.addEventListener('click', ()=>{ businessModalTitle.textContent='Add Business'; bizName.value=''; bizOwnerSelect.value = data.users[0] ? data.users[0].id : ''; bizEntity.value='Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate; bizVatEnabled.checked=true; bizPitEnabled.checked=false; bizPayeEnabled.checked=true; bizShowLines.checked=true; bizLossBF.value = 0; bizCACF.value = 0; openModal(businessModal); bizSave.dataset.edit=''; });
      btnEditBusiness.addEventListener('click', ()=>{ if(!selectedBiz) return alert('Select business'); const b=findBiz(selectedBiz); businessModalTitle.textContent='Edit Business'; bizName.value=b.name; bizOwnerSelect.value=b.ownerId; bizEntity.value=b.entity; bizVat.value=b.vatRate; bizWht.value=b.whtRate; bizCit.value=b.citRate; bizVatEnabled.checked=!!b.vatEnabled; bizPitEnabled.checked=!!b.pitEnabled; bizPayeEnabled.checked=!!b.payeEnabled; bizShowLines.checked=!!b.showLines; bizLossBF.value = Number(b.lossBroughtForward||0); bizCACF.value = Number(b.caCarryForward||0); openModal(businessModal); bizSave.dataset.edit = b.id; });
      btnDeleteBusiness.addEventListener('click', ()=>{ if(!selectedBiz) return alert('Select business'); if(!confirm('Delete business and all transactions?')) return; deleteBusiness(selectedBiz); });

      bizSave.addEventListener('click', ()=>{ const name=(bizName.value||'').trim(); if(!name) return alert('Business name required'); const owner = bizOwnerSelect.value; const obj = { name, ownerId: owner, entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate), vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, accounts: [], inventory: [], assets: [], lossBroughtForward: Number(bizLossBF.value||0), caCarryForward: Number(bizCACF.value||0) }; const editId = bizSave.dataset.edit; if(editId){ const b = findBiz(editId); b.name = obj.name; b.ownerId = obj.ownerId; b.entity = obj.entity; b.vatRate = obj.vatRate; b.whtRate = obj.whtRate; b.citRate = obj.citRate; b.vatEnabled = obj.vatEnabled; b.pitEnabled = obj.pitEnabled; b.payeEnabled = obj.payeEnabled; b.showLines = obj.showLines; b.lossBroughtForward = obj.lossBroughtForward; b.caCarryForward = obj.caCarryForward; } else { obj.id = uid('biz'); // copy default accounts
        obj.accounts = [{id:uid('acct'),name:'Sales',category:'Revenue', disallowableDefault:false, nonTaxableDefault:false}, {id:uid('acct'),name:'COGS',category:'Expense', disallowableDefault:false, nonTaxableDefault:false}, {id:uid('acct'),name:'Salaries',category:'Expense', disallowableDefault:false, nonTaxableDefault:false}];
        data.businesses.push(obj);
        // initialize transactions mapping for all users
        data.users.forEach(u=>{ if(!data.transactions[u.id]) data.transactions[u.id] = {}; data.transactions[u.id][obj.id] = []; });
      } saveData(); refreshSelectors(); closeModal(businessModal); renderAll(); });

      bizCancel.addEventListener('click', ()=>closeModal(businessModal));

      // accounts modal
      btnManageAccounts.addEventListener('click', ()=>{ if(!selectedBiz) return alert('Select business'); renderAccounts(); openModal(accountsModal); });
      addAccountBtn.addEventListener('click', ()=>{ const name=(newAccountName.value||'').trim(); if(!name) return alert('Account name required'); const cat=newAccountCategory.value; const b=findBiz(selectedBiz); if(!b) return alert('Select business'); const acc = { id: uid('acct'), name, category: cat, disallowableDefault:false, nonTaxableDefault:false }; b.accounts.push(acc); newAccountName.value=''; saveData(); renderAccounts(); populateAccountSelect(); });
      closeAccountsBtn.addEventListener('click', ()=>closeModal(accountsModal));

      // transaction form behaviors
      txnAction.addEventListener('change', ()=>{ const val = txnAction.value; // show subforms alone
        if(val==='InventoryPurchase' || val==='InventorySale'){ mainTxnForm.style.display='none'; inventorySubform.style.display='block'; assetSubform.style.display='none'; populateAccountSelect(); } else if(val==='FixedAssetPurchase' || val==='FixedAssetDisposal'){ mainTxnForm.style.display='none'; inventorySubform.style.display='none'; assetSubform.style.display='block'; populateAccountSelect(); } else { mainTxnForm.style.display='flex'; inventorySubform.style.display='none'; assetSubform.style.display='none'; } });
      txnWht.addEventListener('change', ()=>{ txnWhtRateLabel.style.display = txnWht.checked ? 'inline-flex' : 'none'; });

      btnAddTxn.addEventListener('click', handleAddTransaction);

      // inventory subform
      btnAddInv.addEventListener('click', handleInventoryAction);
      btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });

      // asset subform
      btnAddAsset.addEventListener('click', handleAddAsset);
      btnDisposeAsset.addEventListener('click', handleDisposeAsset);
      btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });

      // ledger search
      document.getElementById('btnSearch').addEventListener('click', renderLedger);
      document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

      // export/import
      document.getElementById('btnExport').addEventListener('click', ()=>{ const dataStr = JSON.stringify(data, null, 2); const blob = new Blob([dataStr], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ntc_export.json'; a.click(); URL.revokeObjectURL(url); });
      document.getElementById('btnImport').addEventListener('click', ()=>document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload = () => { try{ data = JSON.parse(r.result); migrateData(); closeModal(accountsModal); refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll(); alert('Imported'); } catch(err){ alert('Invalid JSON'); } }; r.readAsText(f); });
      document.getElementById('btnClearAll').addEventListener('click', ()=>{ if(!confirm('Clear all stored data?')) return; localStorage.removeItem(STORAGE_KEY); data={users:[],businesses:[],transactions:{}}; location.reload(); });
    }

    function refreshSelectors(){
      userSelect.innerHTML=''; businessSelect.innerHTML=''; bizOwnerSelect.innerHTML='';
      data.users.forEach(u=>{ const opt=document.createElement('option'); opt.value=u.id; opt.textContent=u.display||u.username; userSelect.appendChild(opt); const o2=opt.cloneNode(true); bizOwnerSelect.appendChild(o2); });
      data.businesses.forEach(b=>{ const opt=document.createElement('option'); opt.value=b.id; const owner = data.users.find(u=>u.id===b.ownerId); opt.textContent = b.name + (owner ? ' — ' + (owner.display||owner.username) : ''); businessSelect.appendChild(opt); });
      userSelect.removeEventListener('change', onUserChange);
      businessSelect.removeEventListener('change', onBizChange);
      userSelect.addEventListener('change', onUserChange);
      businessSelect.addEventListener('change', onBizChange);
    }

    function onUserChange(e){ selectedUser = e.target.value; const anyBiz = data.businesses.find(bb=>bb.ownerId===selectedUser); if(anyBiz){ selectedBiz = anyBiz.id; businessSelect.value = selectedBiz; } populateAccountSelect(); renderAll(); }
    function onBizChange(e){ selectedBiz = e.target.value; populateAccountSelect(); renderAll(); }

    function ensureSelection(){
      if(!selectedUser) selectedUser = data.users[0] ? data.users[0].id : null;
      if(!selectedBiz) selectedBiz = data.businesses[0] ? data.businesses[0].id : null;
      if(selectedUser) userSelect.value = selectedUser;
      if(selectedBiz) businessSelect.value = selectedBiz;
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }

    function populateAccountSelect(){
      txnAccount.innerHTML=''; invItemSelect.innerHTML='';
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      (biz.accounts||[]).forEach(a=>{ const opt=document.createElement('option'); opt.value=a.id; opt.textContent = a.name + ' (' + a.category + ')'; txnAccount.appendChild(opt); });
      // ensure there are basic default accounts if empty
      if((biz.accounts||[]).length===0){
        biz.accounts = [ {id:uid('acct'),name:'Sales',category:'Revenue',disallowableDefault:false,nonTaxableDefault:false}, {id:uid('acct'),name:'COGS',category:'Expense',disallowableDefault:false,nonTaxableDefault:false}, {id:uid('acct'),name:'Salaries',category:'Expense',disallowableDefault:false,nonTaxableDefault:false} ];
        saveData();
        populateAccountSelect();
      }
      // inventory items
      (biz.inventory||[]).forEach(it=>{ const opt=document.createElement('option'); opt.value=it.id; opt.textContent=it.name + ' — qty:' + it.qty + ' @ ' + fmt(it.avgCost); invItemSelect.appendChild(opt); });
      // add a placeholder for creating new
      const newOpt = document.createElement('option'); newOpt.value='__new__'; newOpt.textContent='-- Add new item --'; invItemSelect.appendChild(newOpt);
      invItemSelect.value = biz.inventory.length ? biz.inventory[0].id : '__new__';
    }

    function resetForms(){
      txnDate.value = today();
      txnAction.value = '';
      txnDesc.value=''; txnAmount.value=''; txnWht.checked=false; txnWhtRate.value=''; txnWhtRateLabel.style.display='none'; txnSalary.checked=false;
      txnDisallowable.checked=false; txnNonTax.checked=false;
      inventorySubform.style.display='none'; assetSubform.style.display='none';
      invNewName.value=''; invQty.value=''; invUnitPrice.value=''; invVat.checked=false; invDisallowable.checked=false; invNonTax.checked=false;
      assetName.value=''; assetCost.value=''; assetPurchaseDate.value=''; assetLife.value=3; assetCA.value=20; assetDisposalDate.value=''; assetDisposalProceeds.value='';
      mainTxnForm.style.display='flex';
    }

    // --- Data operations ---
    function deleteUser(uid){
      // remove user & related mappings
      data.users = data.users.filter(u=>u.id!==uid);
      delete data.transactions[uid];
      // remove businesses owned by user
      const owned = data.businesses.filter(b=>b.ownerId===uid).map(b=>b.id);
      data.businesses = data.businesses.filter(b=>b.ownerId!==uid);
      // remove transactions referencing owned businesses
      for(const u of Object.keys(data.transactions||{})){
        owned.forEach(bid=>{ if(data.transactions[u]) delete data.transactions[u][bid]; });
      }
      saveData();
      selectedUser = data.users[0] ? data.users[0].id : null;
      selectedBiz = data.businesses[0] ? data.businesses[0].id : null;
      refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll();
    }

    function deleteBusiness(bid){
      data.businesses = data.businesses.filter(b=>b.id!==bid);
      // remove transactions for all users
      for(const uid of Object.keys(data.transactions||{})){ if(data.transactions[uid]) delete data.transactions[uid][bid]; }
      saveData();
      selectedBiz = data.businesses[0] ? data.businesses[0].id : null;
      refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll();
    }

    // ledger rendering
    function renderLedger(){
      ledgerTable.innerHTML='';
      if(!selectedUser || !selectedBiz) return;
      const arr = (data.transactions[selectedUser] && data.transactions[selectedUser][selectedBiz]) || [];
      const q = (document.getElementById('ledgerSearch').value||'').toLowerCase();
      arr.filter(tx => {
        if(!q) return true;
        return (tx.date||'').includes(q) || (tx.accountName||'').toLowerCase().includes(q) || (tx.description||'').toLowerCase().includes(q) || String(tx.amount||'').includes(q);
      }).forEach(tx=>{
        const tr = document.createElement('tr');
        const tdDate=document.createElement('td'); tdDate.textContent=tx.date||'';
        const tdAction=document.createElement('td'); tdAction.textContent=tx.action||tx.type||'';
        const tdAcc=document.createElement('td'); tdAcc.textContent = tx.accountName || '';
        const tdDesc=document.createElement('td'); tdDesc.textContent = tx.description || '';
        const tdAmt=document.createElement('td'); tdAmt.textContent = fmt(tx.amount||0);
        const tdVat=document.createElement('td'); tdVat.textContent = fmt(tx.vatAmount||0);
        const tdWht=document.createElement('td'); tdWht.textContent = (tx.whtApplied?fmt(tx.whtAmount||0)+' @'+(tx.whtRate||findBiz(selectedBiz).whtRate)+'%':'-');
        const tdPaye=document.createElement('td'); tdPaye.textContent = (tx.isSalary ? fmt(tx.payeAmount||0) : '-');
        const tdInv=document.createElement('td'); tdInv.textContent = (tx.invItemName? (tx.invItemName + ' x' + (tx.qty||0)) : (tx.assetName ? tx.assetName : ''));
        const tdDis=document.createElement('td'); tdDis.textContent = tx.disallowable ? 'Yes' : '-';
        const tdNon=document.createElement('td'); tdNon.textContent = tx.nonTaxable ? 'Yes' : '-';
        const tdAct=document.createElement('td');
        const editBtn=document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=>editTransaction(tx.id));
        const delBtn=document.createElement('button'); delBtn.className='small danger'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=>{ if(!confirm('Delete transaction?')) return; deleteTransaction(tx.id); });
        tdAct.appendChild(editBtn); tdAct.appendChild(delBtn);

        tr.appendChild(tdDate); tr.appendChild(tdAction); tr.appendChild(tdAcc); tr.appendChild(tdDesc); tr.appendChild(tdAmt); tr.appendChild(tdVat); tr.appendChild(tdWht); tr.appendChild(tdPaye); tr.appendChild(tdInv); tr.appendChild(tdDis); tr.appendChild(tdNon); tr.appendChild(tdAct);
        ledgerTable.appendChild(tr);
      });
    }

    function editTransaction(txId){
      // Minimal edit: allow toggling disallowable / non-tax / description via prompt for brevity
      const arr = data.transactions[selectedUser][selectedBiz];
      const tx = arr.find(t=>t.id===txId);
      if(!tx) return alert('Transaction not found');
      const newDesc = prompt('Edit description', tx.description||'');
      if(newDesc===null) return;
      tx.description = newDesc;
      const dis = confirm('Mark as disallowable expense? (OK = Yes, Cancel = No)');
      tx.disallowable = dis;
      const non = confirm('Mark as non-taxable income? (OK = Yes, Cancel = No)');
      tx.nonTaxable = non;
      saveData(); renderAll();
    }

    function deleteTransaction(txId){
      data.transactions[selectedUser][selectedBiz] = data.transactions[selectedUser][selectedBiz].filter(t=>t.id!==txId);
      saveData(); renderAll();
    }

    // helper: compute monthly PAYE based on annual PIT bands
    function computeMonthlyPAYE(grossMonthly, biz){
      const annual = Number(grossMonthly||0) * 12;
      let remaining = annual;
      let lower = 0;
      let totalTax = 0;
      PIT_BANDS_2026.forEach(band=>{
        if(remaining <= 0) return;
        const upper = band.upTo;
        const bandLimit = (upper === Infinity) ? Infinity : (upper - lower);
        const taxed = Math.min(bandLimit, remaining);
        const taxForBand = taxed * band.rate;
        totalTax += taxForBand;
        remaining -= taxed;
        lower = upper;
      });
      return totalTax / 12; // monthly withholding
    }

    // Add general non-inventory transactions
    function handleAddTransaction(){
      if(!selectedUser || !selectedBiz) return alert('Select user and business');
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      const action = txnAction.value;
      const amount = Number(txnAmount.value||0);
      const accountId = txnAccount.value;
      const account = biz.accounts.find(a=>a.id===accountId) || { name:'Unknown', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const dateVal = txnDate.value || today();
      const desc = txnDesc.value || '';
      const whtApplied = !!txnWht.checked;
      const whtRateVal = (txnWhtRate.value) ? Number(txnWhtRate.value) : undefined;
      const isSalary = !!txnSalary.checked;
      const disallowableFlag = !!txnDisallowable.checked || !!account.disallowableDefault;
      const nonTaxFlag = !!txnNonTax.checked || !!account.nonTaxableDefault;

      if(!action) return alert('Select an action.');

      // VAT: apply to revenue-related actions if enabled for business and applicable
      let vatAmount = 0;
      if(biz.vatEnabled && (action === 'Revenue' )) {
        vatAmount = amount * (Number(biz.vatRate||0)/100);
      }

      // WHT: gross-up if applied using business or provided rate
      let usedWht = (typeof whtRateVal !== 'undefined') ? whtRateVal : Number(biz.whtRate||0);
      let grossBase = amount;
      let whtAmount = 0;
      if(whtApplied && usedWht > 0 && usedWht < 100){
        grossBase = amount / (1 - (usedWht/100));
        whtAmount = grossBase * (usedWht/100);
      }

      // PAYE: compute monthly based on PIT bands if marked salary
      let payeAmount = 0;
      if(isSalary && biz.payeEnabled){
        payeAmount = computeMonthlyPAYE(amount, biz);
      }

      const txn = {
        id: uid('txn'),
        date: dateVal,
        action,
        accountId,
        accountName: account.name,
        description: desc,
        amount,
        vatAmount,
        whtApplied,
        whtRate: usedWht,
        whtAmount,
        grossBase,
        isSalary,
        payeAmount,
        userId: selectedUser,
        disallowable: disallowableFlag,
        nonTaxable: nonTaxFlag
      };

      data.transactions[selectedUser] = data.transactions[selectedUser] || {};
      data.transactions[selectedUser][selectedBiz] = data.transactions[selectedUser][selectedBiz] || [];
      data.transactions[selectedUser][selectedBiz].push(txn);
      saveData();
      resetForms(); renderAll();
      alert('Transaction recorded');
    }

    // Inventory handling (average cost)
    function handleInventoryAction(){
      if(!selectedUser || !selectedBiz) return alert('Select user/business');
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      const action = txnAction.value;
      if(!(action==='InventoryPurchase' || action==='InventorySale')) return alert('Choose an inventory action in Action selector');
      // determine item
      let itemId = invItemSelect.value;
      const newName = (invNewName.value||'').trim();
      let item = null;
      if(itemId === '__new__' && newName){
        item = { id: uid('item'), name: newName, qty:0, avgCost:0 };
        biz.inventory.push(item);
      } else {
        item = biz.inventory.find(it=>it.id===itemId);
        if(!item) return alert('Select or add an inventory item');
      }

      const qty = Number(invQty.value||0);
      if(qty <= 0) return alert('Quantity must be > 0');
      const unitPrice = Number(invUnitPrice.value||0);
      const vatApplies = !!invVat.checked;
      const dateVal = txnDate.value || today();
      const disallowableFlag = !!invDisallowable.checked;
      const nonTaxFlag = !!invNonTax.checked;

      if(action === 'InventoryPurchase'){
        // update weighted average
        const prevQty = Number(item.qty || 0);
        const prevAvg = Number(item.avgCost || 0);
        const newTotalCost = prevQty*prevAvg + qty*unitPrice;
        const newQty = prevQty + qty;
        const newAvg = newQty ? (newTotalCost / newQty) : 0;
        item.qty = newQty;
        item.avgCost = newAvg;

        const vatAmount = (biz.vatEnabled && vatApplies) ? (qty*unitPrice) * (biz.vatRate/100) : 0;
        const txn = {
          id: uid('txn'),
          date: dateVal,
          action: 'InventoryPurchase',
          accountId: txnAccount.value,
          accountName: (biz.accounts.find(a=>a.id===txnAccount.value)||{}).name||'Inventory Purchases',
          description: `Purchase ${item.name}`,
          amount: qty*unitPrice,
          vatAmount,
          whtApplied:false,
          whtAmount:0,
          invItemId: item.id,
          invItemName: item.name,
          qty,
          unitPrice,
          unitCost: unitPrice,
          userId: selectedUser,
          disallowable: disallowableFlag,
          nonTaxable: nonTaxFlag
        };
        data.transactions[selectedUser][selectedBiz].push(txn);
        saveData(); resetForms(); populateAccountSelect(); renderAll(); alert('Inventory purchase recorded');
        // return to default form
        txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex';
        return;
      }

      if(action === 'InventorySale'){
        if(item.qty < qty) return alert('Insufficient stock to sell');
        const unitCost = Number(item.avgCost || 0);
        const cogs = qty * unitCost;
        item.qty -= qty;
        // VAT on sale if enabled
        const vatAmount = biz.vatEnabled ? (qty*unitPrice) * (biz.vatRate/100) : 0;
        const txn = {
          id: uid('txn'),
          date: dateVal,
          action: 'InventorySale',
          accountId: txnAccount.value,
          accountName: (biz.accounts.find(a=>a.id===txnAccount.value)||{}).name||'Sales',
          description: `Sale ${item.name}`,
          amount: qty*unitPrice,
          vatAmount,
          whtApplied:false,
          whtAmount:0,
          invItemId: item.id,
          invItemName: item.name,
          qty,
          unitPrice,
          unitCost,
          cogs,
          userId: selectedUser,
          disallowable: disallowableFlag,
          nonTaxable: nonTaxFlag
        };
        data.transactions[selectedUser][selectedBiz].push(txn);
        saveData(); resetForms(); populateAccountSelect(); renderAll(); alert(`Sale recorded (COGS: ₦${fmt(cogs)})`);
        txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex';
        return;
      }
    }

    // Assets handling
    function handleAddAsset(){
      if(!selectedUser || !selectedBiz) return alert('Select user/business');
      const biz = findBiz(selectedBiz);
      const name = (assetName.value||'').trim();
      const cost = Number(assetCost.value||0);
      const pDate = assetPurchaseDate.value || today();
      const life = Number(assetLife.value||0);
      const caPerc = Number(assetCA.value||0);
      if(!name || cost <= 0 || life <= 0) return alert('Asset name, cost, and useful life required');
      const asset = { id:uid('asset'), name, cost, purchaseDate:pDate, lifeYears:life, capitalAllowancePercent:caPerc, disposed:false, disposalDate:null, disposalProceeds:0 };
      biz.assets = biz.assets || [];
      biz.assets.push(asset);
      // record transaction
      const txn = { id:uid('txn'), date:pDate, action:'FixedAssetPurchase', accountId: txnAccount.value, accountName: (biz.accounts.find(a=>a.id===txnAccount.value)||{}).name||'Fixed Assets', description:`Asset purchase ${name}`, amount: cost, vatAmount:0, whtApplied:false, whtAmount:0, assetId: asset.id, assetName: name, userId:selectedUser, disallowable:false, nonTaxable:false };
      data.transactions[selectedUser][selectedBiz].push(txn);
      saveData(); resetForms(); renderAll(); alert('Asset recorded');
      txnAction.value=''; assetSubform.style.display='none'; mainTxnForm.style.display='flex';
    }

    function handleDisposeAsset(){
      if(!selectedUser || !selectedBiz) return alert('Select user/business');
      const biz = findBiz(selectedBiz);
      const name = (assetName.value||'').trim();
      const disposalDate = assetDisposalDate.value;
      const proceeds = Number(assetDisposalProceeds.value||0);
      if(!name || !disposalDate) return alert('Asset name and disposal date required');
      const asset = biz.assets.find(a=>a.name===name && !a.disposed);
      if(!asset) return alert('Asset not found (not active)');
      asset.disposed = true;
      asset.disposalDate = disposalDate;
      asset.disposalProceeds = proceeds;
      // record transaction
      const txn = { id:uid('txn'), date:disposalDate, action:'FixedAssetDisposal', accountId: txnAccount.value, accountName:(biz.accounts.find(a=>a.id===txnAccount.value)||{}).name||'Fixed Assets', description:`Asset disposal ${name}`, amount: proceeds, vatAmount:0, whtApplied:false, whtAmount:0, assetId: asset.id, assetName: name, userId:selectedUser, disallowable:false, nonTaxable:false };
      data.transactions[selectedUser][selectedBiz].push(txn);
      saveData(); resetForms(); renderAll(); alert('Disposal recorded');
      txnAction.value=''; assetSubform.style.display='none'; mainTxnForm.style.display='flex';
    }

    // --- Computations: P&L, Taxes, Depreciation, CA, COGS ---
    function computePLandTaxes(){
      const biz = findBiz(selectedBiz);
      if(!biz) return null;
      const txs = (data.transactions[selectedUser] && data.transactions[selectedUser][selectedBiz]) || [];
      // aggregates
      let revenue = 0;
      let costsOfSales = 0;
      let expenses = 0;
      let vatOutput = 0;
      let vatInput = 0;
      let whtTotal = 0;
      let payeTotal = 0;
      let disallowableTotal = 0;
      let nonTaxableTotal = 0;

      // iterate transactions
      txs.forEach(tx=>{
        // VAT classification
        if(tx.vatAmount){
          // Treat InventorySale and Revenue as output VAT; InventoryPurchase and Expense as input VAT
          if(tx.action === 'InventorySale' || tx.action === 'Revenue') vatOutput += Number(tx.vatAmount||0);
          else vatInput += Number(tx.vatAmount||0);
        }
        // WHT
        whtTotal += Number(tx.whtAmount||0);
        // PAYE
        payeTotal += Number(tx.payeAmount||0);
        // disallowable/non-taxable
        if(tx.disallowable) disallowableTotal += Number(tx.amount||0);
        if(tx.nonTaxable) nonTaxableTotal += Number(tx.amount||0);

        // classify
        const acct = biz.accounts.find(a=>a.id===tx.accountId);
        const cat = acct ? acct.category : null;
        if(tx.action === 'InventorySale' || tx.action === 'Revenue'){
          revenue += Number(tx.amount||0);
          if(tx.cogs) costsOfSales += Number(tx.cogs||0);
        } else if(tx.action === 'InventoryPurchase'){
          // purchases increase inventory (input VAT handled above)
        } else if(tx.action === 'FixedAssetPurchase'){
          // capitalized (expense not immediate)
        } else if(tx.action === 'FixedAssetDisposal'){
          // disposal affects gain/loss - treat proceeds as revenue-like then adjust by disposal accounting later
          revenue += Number(tx.amount||0);
        } else {
          // generic classification by account category
          if(cat === 'Revenue') revenue += Number(tx.amount||0);
          else if(cat === 'Expense') expenses += Number(tx.amount||0);
          else {
            if(Number(tx.amount||0) < 0) expenses += Math.abs(Number(tx.amount));
          }
        }
      });

      // compute depreciation & capital allowances monthly
      const now = new Date();
      let depreciationExpenseTotal = 0;
      let capitalAllowanceComputed = 0; // computed from assets for this period (approx)
      (biz.assets||[]).forEach(asset=>{
        const purchaseDate = new Date(asset.purchaseDate);
        const disposed = !!asset.disposed;
        const disposalDate = asset.disposed ? new Date(asset.disposalDate) : null;
        const endDate = disposed ? disposalDate : now;
        if(endDate < purchaseDate) return;
        const daysUsed = Math.floor((endDate - purchaseDate)/(1000*60*60*24)) + 1;
        const monthlyDep = asset.cost / (asset.lifeYears * 12);
        const monthsUsedApprox = daysUsed / 30.4375;
        const deprAccrued = Math.min(asset.cost, monthlyDep * monthsUsedApprox);
        const ca = (asset.capitalAllowancePercent/100) * asset.cost * (monthsUsedApprox/12);
        depreciationExpenseTotal += deprAccrued;
        capitalAllowanceComputed += ca;
      });

      // For P&L show depreciation as expense
      expenses += depreciationExpenseTotal;

      // Profit computations
      const grossProfit = revenue - costsOfSales;
      const netProfit = grossProfit - expenses;

      // Capital allowances handling with 2/3 applied and 1/3 carry forward (includes previous carryforward)
      const previousCACarry = Number(biz.caCarryForward || 0);
      const totalCAAvailable = capitalAllowanceComputed + previousCACarry;
      const allowedCA = (2/3) * totalCAAvailable;
      const newCarryForward = totalCAAvailable - allowedCA; // this becomes carryforward for next period

      // Taxable income adjustments:
      // Start with accounting netProfit
      // Add back disallowable expenses (increase taxable)
      // Subtract non-taxable income (decrease taxable)
      // Subtract allowed capital allowances
      // Subtract loss brought forward
      let taxable = netProfit;
      taxable += disallowableTotal;
      taxable -= nonTaxableTotal;
      taxable -= allowedCA;
      taxable -= Number(biz.lossBroughtForward || 0);
      const taxableProfit = Math.max(0, taxable);

      // PIT (sole proprietor) using PIT_BANDS_2026 applied to taxableProfit
      let pit = 0;
      let pitDetails = { grossIncome: revenue, cra:0, taxableIncomeAfterCRA:0, bandsApplied: [], totalPit:0 };
      if(biz.entity === 'SoleProprietor' && biz.pitEnabled){
        // CRA as specified: max(200000, 1% of gross) + 20% of gross
        const craMin = 200000;
        const onePctGross = revenue * 0.01;
        const cra = Math.max(craMin, onePctGross) + (0.20 * revenue);
        pitDetails.cra = cra;
        let taxableAfterCRA = Math.max(0, taxableProfit - cra);
        pitDetails.taxableIncomeAfterCRA = taxableAfterCRA;
        let remaining = taxableAfterCRA;
        let lower = 0;
        let totalPitCalc = 0;
        PIT_BANDS_2026.forEach(band=>{
          if(remaining <= 0) return;
          const upper = band.upTo;
          const bandLimit = (upper === Infinity) ? Infinity : (upper - lower);
          const taxed = Math.min(bandLimit, remaining);
          const taxForBand = taxed * band.rate;
          pitDetails.bandsApplied.push({ taxed, rate: band.rate, tax: taxForBand });
          totalPitCalc += taxForBand;
          remaining -= taxed;
          lower = upper;
        });
        pit = totalPitCalc;
        pitDetails.totalPit = pit;
      }

      // CIT (company): 0% for first 50,000,000, 25% for amount above
      let cit = 0;
      if(biz.entity === 'Company'){
        const threshold = 50000000;
        const taxableForCIT = taxableProfit;
        const below = Math.min(threshold, taxableForCIT);
        const above = Math.max(0, taxableForCIT - threshold);
        cit = above * 0.25 + below * 0; // 0% on first threshold
      }

      // Update business carryforward for next period (persist)
      // Note: update persisted carryforward to reflect newCarryForward computed
      biz.caCarryForward = newCarryForward;

      // return summary
      return {
        revenue,
        costsOfSales,
        grossProfit,
        expenses,
        netProfit,
        depreciationExpenseTotal,
        capitalAllowanceComputed,
        previousCACarry,
        allowedCA,
        newCACarryForward: newCarryForward,
        vatOutput,
        vatInput,
        vatNet: vatOutput - vatInput,
        whtTotal,
        payeTotal,
        disallowableTotal,
        nonTaxableTotal,
        taxableProfit,
        pit,
        pitDetails,
        cit
      };
    }

    // render PL snapshot, inventory, assets, tax summary
    function renderAll(){
      populateAccountSelect();
      renderLedger();
      renderInventory();
      renderAssets();
      renderPLSnapshot();
      renderTaxSummary();
      renderTotalsSummary();
      saveData(); // persist carryforward updates, etc.
    }

    function renderInventory(){
      inventoryListDiv.innerHTML = '';
      const biz = findBiz(selectedBiz);
      if(!biz) { inventoryListDiv.textContent = 'No business selected'; return; }
      if(!biz.inventory || !biz.inventory.length){ inventoryListDiv.textContent = 'No inventory items'; return; }
      const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
      const thead = document.createElement('thead'); thead.innerHTML = '<tr><th style="border:1px solid #ddd;padding:6px">Item</th><th style="border:1px solid #ddd;padding:6px">Qty</th><th style="border:1px solid #ddd;padding:6px">Avg Cost</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      biz.inventory.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="border:1px solid #ddd;padding:6px">${it.name}</td><td style="border:1px solid #ddd;padding:6px">${it.qty}</td><td style="border:1px solid #ddd;padding:6px">₦${fmt(it.avgCost)}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      inventoryListDiv.appendChild(table);
    }

    function renderAssets(){
      assetListDiv.innerHTML = '';
      const biz = findBiz(selectedBiz);
      if(!biz) { assetListDiv.textContent = 'No business selected'; return; }
      if(!biz.assets || !biz.assets.length){ assetListDiv.textContent = 'No assets recorded'; return; }
      const table = document.createElement('table'); table.style.width='100%'; const thead = document.createElement('thead'); thead.innerHTML = '<tr><th style="border:1px solid #ddd;padding:6px">Asset</th><th style="border:1px solid #ddd;padding:6px">Cost</th><th style="border:1px solid #ddd;padding:6px">Purchased</th><th style="border:1px solid #ddd;padding:6px">Life (yrs)</th><th style="border:1px solid #ddd;padding:6px">CA %</th><th style="border:1px solid #ddd;padding:6px">Disposed</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      biz.assets.forEach(a=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td style="border:1px solid #ddd;padding:6px">${a.name}</td><td style="border:1px solid #ddd;padding:6px">₦${fmt(a.cost)}</td><td style="border:1px solid #ddd;padding:6px">${a.purchaseDate}</td><td style="border:1px solid #ddd;padding:6px">${a.lifeYears}</td><td style="border:1px solid #ddd;padding:6px">${a.capitalAllowancePercent}%</td><td style="border:1px solid #ddd;padding:6px">${a.disposed ? 'Yes ('+a.disposalDate+')' : 'No'}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      assetListDiv.appendChild(table);
    }

    function renderPLSnapshot(){
      plSnapshotDiv.innerHTML = '';
      const p = computePLandTaxes();
      if(!p){ plSnapshotDiv.innerHTML = '<em>No business selected</em>'; return; }
      const html = `<div><strong>Revenue:</strong> ₦${fmt(p.revenue)}</div>
      <div><strong>COGS:</strong> ₦${fmt(p.costsOfSales)}</div>
      <div><strong>Gross profit:</strong> ₦${fmt(p.grossProfit)}</div>
      <div><strong>Expenses (incl. depreciation):</strong> ₦${fmt(p.expenses)}</div>
      <div><strong>Net profit (accounting):</strong> ₦${fmt(p.netProfit)}</div>
      <div><strong>Accumulated Depreciation (approx):</strong> ₦${fmt(p.depreciationExpenseTotal)}</div>
      <div><strong>Capital allowance (computed this period, approx):</strong> ₦${fmt(p.capitalAllowanceComputed)}</div>
      <div><strong>Allowed CA this period (2/3 of available):</strong> ₦${fmt(p.allowedCA)}</div>
      <div><strong>CA carryforward (new):</strong> ₦${fmt(p.newCACarryForward)}</div>`;
      plSnapshotDiv.innerHTML = html;
    }

    function renderTaxSummary(){
      taxSummaryDiv.innerHTML = '';
      const biz = findBiz(selectedBiz);
      if(!biz) { taxSummaryDiv.innerHTML = '<em>No business selected</em>'; return; }
      const p = computePLandTaxes();
      if(!p) return;
      const lines = [];
      if(biz.showLines) {
        lines.push(`<div><strong>VAT Output:</strong> ₦${fmt(p.vatOutput)}</div>`);
        lines.push(`<div><strong>VAT Input:</strong> ₦${fmt(p.vatInput)}</div>`);
        lines.push(`<div><strong>Net VAT payable / (credit):</strong> ₦${fmt(p.vatNet)}</div>`);
        lines.push(`<div><strong>WHT total:</strong> ₦${fmt(p.whtTotal)}</div>`);
        lines.push(`<div><strong>PAYE withheld (sum):</strong> ₦${fmt(p.payeTotal)}</div>`);
        lines.push(`<div><strong>Disallowable additions:</strong> ₦${fmt(p.disallowableTotal)}</div>`);
        lines.push(`<div><strong>Non-taxable income excluded:</strong> ₦${fmt(p.nonTaxableTotal)}</div>`);
        lines.push(`<div><strong>Taxable profit (after adjustments & CA & losses B/F):</strong> ₦${fmt(p.taxableProfit)}</div>`);
      }
      lines.push(`<div style="margin-top:8px;"><strong>CIT (Company):</strong> ₦${fmt(p.cit)}</div>`);
      lines.push(`<div><strong>PIT (Sole proprietor):</strong> ₦${fmt(p.pit)}</div>`);
      taxSummaryDiv.innerHTML = lines.join('\n');
    }

    function renderTotalsSummary(){
      totalsSummaryDiv.innerHTML = '';
      const p = computePLandTaxes();
      if(!p){ totalsSummaryDiv.innerHTML = '<em>No data</em>'; return; }
      const html = `<div><strong>Revenue:</strong> ₦${fmt(p.revenue)} &nbsp; <strong>COGS:</strong> ₦${fmt(p.costsOfSales)} &nbsp; <strong>Net VAT:</strong> ₦${fmt(p.vatNet)}</div>
      <div class="mutedBlock">Profit & loss snapshot shown separately below.</div>`;
      totalsSummaryDiv.innerHTML = html;
    }

    // Accounts management render & edit
    function renderAccounts(){
      accountsList.innerHTML = '';
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      if(!biz.accounts.length) accountsList.innerHTML = '<div class="small-muted">No accounts defined</div>';
      biz.accounts.forEach(acc => {
        const row = document.createElement('div');
        row.className = 'account-row';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${acc.name}</strong> <span class="small-muted">(${acc.category})</span>`;
        const right = document.createElement('div');
        // toggles for defaults
        const disChk = document.createElement('input'); disChk.type='checkbox'; disChk.checked = !!acc.disallowableDefault;
        disChk.title = 'Default disallowable for this account';
        disChk.addEventListener('change', ()=>{ acc.disallowableDefault = disChk.checked; saveData(); });
        const nonChk = document.createElement('input'); nonChk.type='checkbox'; nonChk.checked = !!acc.nonTaxableDefault;
        nonChk.title = 'Default non-taxable for this account';
        nonChk.addEventListener('change', ()=>{ acc.nonTaxableDefault = nonChk.checked; saveData(); });
        const editBtn = document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=>{ const newName = prompt('Account name', acc.name); if(newName===null) return; acc.name = newName.trim() || acc.name; const newCat = prompt('Category (Revenue/Expense/Asset/Liability/Capital)', acc.category); if(newCat) acc.category = newCat; saveData(); renderAccounts(); populateAccountSelect(); });
        const delBtn = document.createElement('button'); delBtn.className='small danger'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=>{ if(!confirm('Delete account?')) return; biz.accounts = biz.accounts.filter(a=>a.id!==acc.id); saveData(); renderAccounts(); populateAccountSelect(); });
        right.appendChild(document.createTextNode('Disallowable ')); right.appendChild(disChk);
        right.appendChild(document.createTextNode(' Non-tax ')); right.appendChild(nonChk);
        right.appendChild(editBtn); right.appendChild(delBtn);
        row.appendChild(left); row.appendChild(right);
        accountsList.appendChild(row);
      });
    }

    // initial rendering helpers were called earlier; ensure they exist
    // Bootstrapping done above.

    // final render loop
    renderAll();

  </script>
</body>
                                                                                                     </html>
