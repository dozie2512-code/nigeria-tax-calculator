Updated index.html implementing your choices (default useful life = 4 years, editable per-asset, prorated depreciation, per-business fixedAssets, tax-year selector, capital allowance absorption 2/3 / carry forward 1/3, tax computations, etc.).

Copy and replace your existing index.html with the full content below.

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT & WHT & PAYE (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary, .wht-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(920px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} .inline-grid{grid-template-columns:1fr} .tax-results{display:block} }
    pre.small { font-size:0.85rem; white-space:pre-wrap; }
    .nowrap { white-space:nowrap; }
    table.paye-table { width:100%; border-collapse:collapse; margin-top:8px; }
    table.paye-table th, table.paye-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; background:#fff; }
    table.paye-table th { background:#f5f8fb; }
    .muted-inline { color:var(--muted); font-size:0.9rem; margin-left:8px; }
    .inline-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:start; }
    .field { display:flex; flex-direction:column; gap:4px; }
    .result-box { background:#fff; padding:10px; border:1px solid #eef2f6; border-radius:6px; margin-top:8px; }
    .result-row { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:4px 0; }
    .account-tag { font-size:0.85rem; color:var(--muted); margin-left:6px; }
    .flex-col { display:flex; flex-direction:column; gap:8px; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT, WHT, PAYE & PIT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <label class="muted-inline">Tax year:
        <select id="taxYearSelect" style="margin-left:6px;"></select>
      </label>
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>
        <button class="small" id="btnAddAccountInline">+ Account</button>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="whtInlineLabel" style="display:none;">
          <input type="checkbox" id="txnWhtEnabled" /> Withhold WHT
        </label>
        <label id="whtRateInlineLabel" style="display:none;">
          WHT rate (%): <input type="number" id="txnWhtRate" min="0" step="0.01" value="5" style="width:70px;" />
        </label>
        <label id="whtInclusiveLabel" style="display:none;">
          <input type="checkbox" id="txnWhtInclusive" /> Amount includes WHT
        </label>

        <label>Contact:
          <select id="txnContact"></select>
        </label>
        <button class="small" id="btnAddContactInline">+ Contact</button>

        <label title="Mark this transaction as acquisition of a fixed asset">
          <input type="checkbox" id="txnIsFixedAsset" /> Fixed asset?
        </label>
        <label style="display:flex;align-items:center;">
          Useful life (yrs): <input type="number" id="txnAssetLife" min="1" step="1" value="4" style="width:70px;margin-left:6px" />
        </label>

        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved at the business level. VAT is calculated for sales (Revenue) and for purchases only (not all expenses). WHT (Withholding Tax) applies for qualifying expenses. Mark an acquisition as fixed asset to create an asset record for depreciation and capital allowance.</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/description/amount/author/contact/account" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable" aria-live="polite">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Account</th>
            <th>Amount (₦)</th>
            <th>VAT (₦)</th>
            <th>WHT (₦)</th>
            <th>Contact</th>
            <th>Author</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="wht-summary" id="whtSummary"></div>
      <div class="paye-summary totals" id="payeSummary" style="margin-top:10px;"></div>
      <div class="pit-summary totals" id="pitSummary" style="margin-top:10px;"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section" id="contactsAccountsPanel" style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:280px;">
        <h3>Contacts</h3>
        <div class="form-inline" style="margin-bottom:8px;">
          <button class="small" id="btnOpenContacts">Manage Contacts</button>
        </div>
        <div id="contactsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
      </div>
      <div style="flex:1;min-width:280px;">
        <h3>Chart of Accounts</h3>
        <div class="form-inline" style="margin-bottom:8px;">
          <button class="small" id="btnOpenAccounts">Manage Accounts</button>
        </div>
        <div id="accountsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
      </div>
    </section>

    <!-- NEW: Taxable income from Net profit A -->
    <section class="panel section" id="taxableFromNetProfitPanel">
      <h2 style="margin:0 0 8px 0;">Taxable Income — From Net profit A</h2>
      <div class="inline-grid">
        <div>
          <div class="field">
            <label>Net profit A (₦): <input type="number" id="netProfitA" step="0.01" /></label>
            <small class="muted">Accounting net profit (profit after operating items)</small>
          </div>
          <div class="field">
            <label>Disallowable expenses to add back (₦): <input type="number" id="disallowable" step="0.01" /></label>
            <small class="muted">Non-deductible expenses for tax purposes</small>
          </div>

          <div class="field">
            <label>Non-taxable income (₦): <input type="number" id="nonTaxableIncome" step="0.01" /></label>
            <small class="muted">Tax-exempt income to remove</small>
          </div>
          <div class="field">
            <label>Capital allowances (₦) (auto): <input type="number" id="capitalAllowances" step="0.01" readonly /></label>
            <small class="muted">Tax depreciation allowances (computed)</small>
          </div>

          <div class="field">
            <label>Prior unrelieved losses (₦): <input type="number" id="priorLosses" step="0.01" /></label>
            <small class="muted">Losses carried forward</small>
          </div>
          <div class="field">
            <label>Other adjustments (₦): <input type="number" id="otherAdjustments" step="0.01" /></label>
            <small class="muted">Any other tax adjustments (positive reduces tax base when negative increase)</small>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
            <button class="primary" id="btnComputeTaxable">Compute Taxable Income</button>
            <label style="margin-left:8px;"><input type="checkbox" id="saveTaxAdjToBusiness" /> Save adjustments to business</label>
            <button id="btnLoadFromBusiness" class="small">Load saved adjustments</button>
          </div>
        </div>

        <!-- Results area (to the right) -->
        <div class="tax-results" style="display:flex;flex-direction:column;gap:8px;">
          <div id="taxableResult" class="result-box" aria-live="polite" style="display:none;">
            <div class="result-row"><div><strong>Taxable income</strong></div><div>₦ <span id="taxableResultValue">0</span></div></div>
            <div id="taxableBreakdown" style="margin-top:6px;"></div>
          </div>

          <div id="pitResult" class="result-box" aria-live="polite" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>Estimated PIT (annual)</strong></div>
              <div style="text-align:right;">
                <div>₦ <span id="pitAnnualValue">0</span></div>
                <div class="muted" style="font-size:0.9rem;">Monthly: ₦ <span id="pitMonthlyValue">0</span></div>
              </div>
            </div>
            <div id="pitNotes" style="margin-top:8px;" class="muted"></div>
          </div>

          <div id="citResult" class="result-box" aria-live="polite" style="display:none;">
            <div class="result-row"><div><strong>Estimated Company Income Tax (CIT)</strong></div><div>₦ <span id="citValue">0</span></div></div>
            <div id="citNotes" style="margin-top:6px;" class="muted"></div>
          </div>

          <div id="capAllowApplyBox" class="result-box" style="display:none;">
            <div class="result-row"><div><strong>Capital allowance available</strong></div><div>₦ <span id="capAllowAvailable">0</span></div></div>
            <div style="display:flex;gap:8px;">
              <button id="btnApplyCarryforwards" class="small">Apply carryforward (persist)</button>
              <button id="btnResetCarryforwards" class="small">Reset carryforward</button>
            </div>
          </div>
        </div>
      </div>

      <small class="muted">Formula: Taxable income = Net profit A + Disallowable expenses - Non-taxable income - Capital allowances applied - Prior losses + Other adjustments</small>
    </section>

    <section class="panel section" id="assetsPanel">
      <h2 style="margin:0 0 8px 0;">Fixed Assets</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="btnAddAsset" class="small">+ Add Asset</button>
        <button id="btnImportAssets" class="small">Import Assets</button>
      </div>
      <div id="fixedAssetsList" style="margin-top:8px;"></div>
    </section>

  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" value="7.5" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" checked /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" checked /> Enable PIT (tax)</label>
      <label><input type="checkbox" id="bizVatInclusive" /> VAT amounts are inclusive</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizWhtEnabled" checked /> Auto-create WHT Payable account</label>
      <label>WHT account code: <input type="text" id="bizWhtCode" value="2300" style="width:90px" /></label>
    </div>
    <!-- Startup balances -->
    <div class="row">
      <label>Startup Fixed Assets (₦): <input type="number" id="bizStartupFixedAssets" step="0.01" value="0" /></label>
      <label>Opening Accum. Depreciation (₦): <input type="number" id="bizStartupAccumDep" step="0.01" value="0" /></label>
    </div>
    <div class="row">
      <label>Opening Capital Allowances (₦): <input type="number" id="bizStartupCapitalAllowances" step="0.01" value="0" /></label>
      <label>Opening retained profit (₦): <input type="number" id="bizStartupRetainedEarnings" step="0.01" value="0" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizApplyStartupToTax" checked /> Apply opening capital allowances when computing tax</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <div id="contactModal" class="modal" aria-hidden="true">
    <h3 id="contactModalTitle">Add Contact</h3>
    <div class="row">
      <label>Name: <input type="text" id="contactName" /></label>
      <label>Type:
        <select id="contactType">
          <option value="Customer">Customer</option>
          <option value="Vendor">Vendor</option>
          <option value="Employee">Employee</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Phone/Email: <input type="text" id="contactInfo" placeholder="Phone or email" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="contactCancel">Cancel</button>
      <button class="primary" id="contactSave">Save</button>
    </div>
  </div>

  <div id="accountModal" class="modal" aria-hidden="true">
    <h3 id="accountModalTitle">Add Account</h3>
    <div class="row">
      <label>Code: <input type="text" id="accountCode" placeholder="e.g. 4000" /></label>
      <label>Name: <input type="text" id="accountName" placeholder="Account name" /></label>
    </div>
    <div class="row">
      <label>Type:
        <select id="accountType">
          <option value="Asset">Asset</option>
          <option value="Liability">Liability</option>
          <option value="Equity">Equity</option>
          <option value="Revenue">Revenue</option>
          <option value="Expense">Expense/Deductions</option>
        </select>
      </label>
      <label>Notes: <input type="text" id="accountNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="accountIsSalary" /> Salary/Payroll account (include in gross)</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="accountCancel">Cancel</button>
      <button class="primary" id="accountSave">Save</button>
    </div>
  </div>

  <div id="assetModal" class="modal" aria-hidden="true">
    <h3 id="assetModalTitle">Add Fixed Asset</h3>
    <div class="row">
      <label>Name: <input type="text" id="assetName" /></label>
      <label>Account:
        <select id="assetAccount"></select>
      </label>
    </div>
    <div class="row">
      <label>Cost (₦): <input type="number" id="assetCost" step="0.01" /></label>
      <label>Date acquired: <input type="date" id="assetDate" /></label>
      <label>Useful life (yrs): <input type="number" id="assetLife" min="1" step="1" value="4" style="width:80px" /></label>
    </div>
    <div class="row">
      <label>Opening accumulated depreciation (₦): <input type="number" id="assetAccum" step="0.01" value="0" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="assetCancel">Cancel</button>
      <button class="primary" id="assetSave">Save</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant — implemented requested tax & asset features
    const STORAGE_KEY = 'ntc_data_v4';
    // default PIT bands (as in repo)
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    // default deduction keywords
    const DEFAULT_DEDUCTION_KEYWORDS = [
      'rent',
      'pension',
      'nhf',
      'nhis',
      'life assurance',
      'life',
      'interest on loan for owner occupied house',
      'interest',
      'owner occupied'
    ];

    // default useful life (user chose 4)
    const DEFAULT_USEFUL_LIFE_YEARS = 4;

    let data = { users: [], businesses: [], transactions: {} };
    let selectedUserId = null;
    let selectedBusinessId = null;

    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';

    function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function formatMoney(v){
      const n = Number(v) || 0;
      const opts = { maximumFractionDigits:2, minimumFractionDigits: Number(n) % 1 === 0 ? 0 : 2 };
      return n.toLocaleString('en-NG', opts);
    }
    function escapeHtml(s){
      if (s === undefined || s === null) return '';
      return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function saveData(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) { console.error('Save failed', e); alert('Saving failed: ' + (e && e.message)); } }

    function ensureBizWhtAccount(b){
      if (!b) return;
      if (!Array.isArray(b.accounts)) b.accounts = [];
      if (!b.whtAccountId && !!b.whtAutoCreate) {
        const exists = b.accounts.find(a => (a.code && String(a.code) === String(b.whtCode || '2300')) && a.name === 'WHT Payable');
        if (exists) b.whtAccountId = exists.id;
        else {
          const acc = { id: uid('a'), code: (b.whtCode || '2300'), name: 'WHT Payable', type: 'Liability', notes: 'Auto-created for withheld tax', isSalary: false };
          b.accounts.push(acc);
          b.whtAccountId = acc.id;
        }
      }
    }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object'){
            data = parsed;
            data.businesses = (data.businesses || []).map(b=>{
              if (!Array.isArray(b.members)) b.members = [];
              if (!Array.isArray(b.contacts)) b.contacts = [];
              if (!Array.isArray(b.accounts)) b.accounts = [];
              if (!Array.isArray(b.fixedAssets)) b.fixedAssets = [];
              b.accounts = b.accounts.map(a => ({ ...a, isSalary: !!a.isSalary }));
              if (typeof b.vatRate !== 'number') b.vatRate = 7.5;
              if (typeof b.vatEnabled === 'undefined') b.vatEnabled = true;
              if (typeof b.pitEnabled === 'undefined') b.pitEnabled = true;
              if (!b.pit) b.pit = DEFAULT_PIT;
              if (typeof b.whtAutoCreate === 'undefined') b.whtAutoCreate = true;
              if (!b.whtCode) b.whtCode = '2300';
              if (typeof b.vatInclusive === 'undefined') b.vatInclusive = false;
              if (typeof b.taxCarryforward !== 'object' || b.taxCarryforward === null) b.taxCarryforward = { capitalAllowances: 0, priorLosses: 0 };
              // startup values fallback
              if (typeof b.startupFixedAssets !== 'number') b.startupFixedAssets = Number(b.startupFixedAssets || 0);
              if (typeof b.startupAccumDep !== 'number') b.startupAccumDep = Number(b.startupAccumDep || 0);
              if (typeof b.startupCapitalAllowances !== 'number') b.startupCapitalAllowances = Number(b.startupCapitalAllowances || 0);
              if (typeof b.startupRetainedEarnings !== 'number') b.startupRetainedEarnings = Number(b.startupRetainedEarnings || 0);
              if (typeof b.applyStartupToTax === 'undefined') b.applyStartupToTax = true;
              ensureBizWhtAccount(b);
              return b;
            });
            if (!data.transactions) data.transactions = {};
            return;
          }
        } catch(e){ console.error('Invalid saved data', e); }
      }

      // default demo
      const userId = uid('user');
      const bizId = uid('biz');
      const whtAccountId = uid('a_wht');
      const contact1 = { id: uid('c'), name: 'ACME Co', type: 'Customer', info: 'acme@example.com', notes: '' };
      const contact2 = { id: uid('c'), name: 'Office Supplies Ltd', type: 'Vendor', info: '0803-xxx', notes: '' };
      const contact3 = { id: uid('c'), name: 'John Employee', type: 'Employee', info: 'john@demo', notes: '' };
      const accounts = [
        { id: uid('a'), code: '1000', name: 'Cash', type: 'Asset', notes: '', isSalary: false },
        { id: uid('a2'), code: '2000', name: 'Accounts Payable', type: 'Liability', notes: '', isSalary: false },
        { id: uid('a3'), code: '4000', name: 'Sales Revenue', type: 'Revenue', notes: '', isSalary: false },
        { id: uid('a4'), code: '5000', name: 'Rent Expense', type: 'Expense', notes: '', isSalary: false },
      ];
      accounts.push({ id: whtAccountId, code: '2300', name: 'WHT Payable', type: 'Liability', notes: 'Auto-created', isSalary: false });
      accounts.push({ id: uid('a_p'), code: '5100', name: 'Purchases', type: 'Expense', notes: 'Goods purchased for resale', isSalary: false });

      data = {
        users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{
          id: bizId,
          name: 'Demo Business',
          ownerId: userId,
          members: [userId],
          vatRate: 7.5,
          currency: '₦',
          threshold: 800000,
          notes: 'Sample business',
          vatEnabled: true,
          pitEnabled: true,
          vatInclusive: false,
          whtAutoCreate: true,
          whtCode: '2300',
          whtAccountId: whtAccountId,
          contacts: [contact1, contact2, contact3],
          accounts: accounts,
          pit: DEFAULT_PIT,
          taxAdjustments: {
            netProfitA: 1500000,
            disallowable: 0,
            nonTaxableIncome: 0,
            capitalAllowances: 0,
            priorLosses: 0,
            otherAdjustments: 0
          },
          // new fields
          fixedAssets: [
            // demo asset
            { id: uid('fa'), accountId: accounts[0].id, name: 'Office Laptop', cost: 200000, dateAcquired: new Date().toISOString().slice(0,10), usefulLifeYears: DEFAULT_USEFUL_LIFE_YEARS, accumulatedDepreciation: 0 }
          ],
          taxCarryforward: { capitalAllowances: 40000, priorLosses: 0 },
          // demo startup values
          startupFixedAssets: 500000,
          startupAccumDep: 80000,
          startupCapitalAllowances: 40000,
          startupRetainedEarnings: 120000,
          applyStartupToTax: true
        }],
        transactions: {}
      };
      const now = new Date().toISOString().slice(0,10);
      data.transactions[bizId] = [
        { id: uid('txn'), date: now, desc: 'Demo sale to ACME', amount: 1500000, authorUserId: userId, contactId: contact1.id, accountId: accounts.find(a=>a.type==='Revenue').id, whtEnabled: false, whtRate:0, whtInclusive:false, vatInclusive:false, isFixedAsset:false },
        { id: uid('txn'), date: now, desc: 'Office rent', amount: 200000, authorUserId: userId, contactId: contact2.id, accountId: accounts.find(a=>a.code==='5000').id, whtEnabled: false, whtRate:0, whtInclusive:false, vatInclusive:false, isFixedAsset:false },
        { id: uid('txn'), date: now, desc: 'Purchase inventory', amount: 300000, authorUserId: userId, contactId: contact2.id, accountId: accounts.find(a=>a.name==='Purchases').id, whtEnabled: false, whtRate:0, whtInclusive:false, vatInclusive:false, isFixedAsset:false },
      ];
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id) || null; }
    function findBiz(id){ return data.businesses.find(b=>b.id===id) || null; }
    function findContact(bizId, contactId){
      const b = findBiz(bizId); if (!b || !Array.isArray(b.contacts)) return null;
      return b.contacts.find(c=>c.id===contactId) || null;
    }
    function findAccount(bizId, accountId){
      const b = findBiz(bizId); if (!b || !Array.isArray(b.accounts)) return null;
      return b.accounts.find(a=>a.id===accountId) || null;
    }
    function findAsset(bizId, assetId){
      const b = findBiz(bizId); if (!b || !Array.isArray(b.fixedAssets)) return null;
      return b.fixedAssets.find(f=>f.id===assetId) || null;
    }

    // UI references
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const whtSummaryDiv = document.getElementById('whtSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');
    const payeSummaryDiv = document.getElementById('payeSummary');
    const pitSummaryDiv = document.getElementById('pitSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    const txnDate = document.getElementById('txnDate');
    const txnDesc = document.getElementById('txnDesc');
    const txnAmount = document.getElementById('txnAmount');
    const txnContact = document.getElementById('txnContact');
    const txnAccount = document.getElementById('txnAccount');
    const txnIsFixedAsset = document.getElementById('txnIsFixedAsset');
    const txnAssetLife = document.getElementById('txnAssetLife');

    const btnAddContactInline = document.getElementById('btnAddContactInline');
    const btnAddAccountInline = document.getElementById('btnAddAccountInline');
    const btnOpenContacts = document.getElementById('btnOpenContacts');
    const contactsListDiv = document.getElementById('contactsList');

    const btnOpenAccounts = document.getElementById('btnOpenAccounts');
    const accountsListDiv = document.getElementById('accountsList');

    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // taxable income elements
    const netProfitAInput = document.getElementById('netProfitA');
    const disallowableInput = document.getElementById('disallowable');
    const nonTaxableInput = document.getElementById('nonTaxableIncome');
    const capitalAllowancesInput = document.getElementById('capitalAllowances');
    const priorLossesInput = document.getElementById('priorLosses');
    const otherAdjustmentsInput = document.getElementById('otherAdjustments');
    const btnComputeTaxable = document.getElementById('btnComputeTaxable');
    const taxableResultDiv = document.getElementById('taxableResult');
    const taxableResultValue = document.getElementById('taxableResultValue');
    const taxableBreakdownDiv = document.getElementById('taxableBreakdown');
    const saveTaxAdjToBusinessChk = document.getElementById('saveTaxAdjToBusiness');
    const btnLoadFromBusiness = document.getElementById('btnLoadFromBusiness');

    const pitResultDiv = document.getElementById('pitResult');
    const pitAnnualValueSpan = document.getElementById('pitAnnualValue');
    const pitMonthlyValueSpan = document.getElementById('pitMonthlyValue');
    const pitNotesDiv = document.getElementById('pitNotes');

    const citResultDiv = document.getElementById('citResult');
    const citValueSpan = document.getElementById('citValue');
    const citNotesDiv = document.getElementById('citNotes');

    const capAllowApplyBox = document.getElementById('capAllowApplyBox');
    const capAllowAvailableSpan = document.getElementById('capAllowAvailable');
    const btnApplyCarryforwards = document.getElementById('btnApplyCarryforwards');
    const btnResetCarryforwards = document.getElementById('btnResetCarryforwards');

    // Business modal startup fields
    const bizNameInput = document.getElementById('bizName');
    const bizOwnerSelect = document.getElementById('bizOwner');
    const bizVatInput = document.getElementById('bizVat');
    const bizCurrencyInput = document.getElementById('bizCurrency');
    const bizThresholdInput = document.getElementById('bizThreshold');
    const bizNotesInput = document.getElementById('bizNotes');
    const bizVatEnabledChk = document.getElementById('bizVatEnabled');
    const bizPitEnabledChk = document.getElementById('bizPitEnabled');
    const bizVatInclusiveChk = document.getElementById('bizVatInclusive');
    const bizWhtEnabledChk = document.getElementById('bizWhtEnabled');
    const bizWhtCodeInput = document.getElementById('bizWhtCode');
    const bizStartupFixedAssetsInput = document.getElementById('bizStartupFixedAssets');
    const bizStartupAccumDepInput = document.getElementById('bizStartupAccumDep');
    const bizStartupCapitalAllowancesInput = document.getElementById('bizStartupCapitalAllowances');
    const bizStartupRetainedEarningsInput = document.getElementById('bizStartupRetainedEarnings');
    const bizApplyStartupToTaxChk = document.getElementById('bizApplyStartupToTax');

    // asset modal refs
    const btnAddAsset = document.getElementById('btnAddAsset');
    const assetModal = document.getElementById('assetModal');
    const assetNameInput = document.getElementById('assetName');
    const assetAccountSelect = document.getElementById('assetAccount');
    const assetCostInput = document.getElementById('assetCost');
    const assetDateInput = document.getElementById('assetDate');
    const assetLifeInput = document.getElementById('assetLife');
    const assetAccumInput = document.getElementById('assetAccum');
    const assetCancel = document.getElementById('assetCancel');
    const assetSave = document.getElementById('assetSave');
    const fixedAssetsListDiv = document.getElementById('fixedAssetsList');

    const taxYearSelect = document.getElementById('taxYearSelect');

    // helper functions
    function displayAccountType(type){
      return type === 'Expense' ? 'Expense/Deductions' : (type || '');
    }

    function normalizeForMatch(s){
      if (!s) return '';
      return String(s).toLowerCase().replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function isDeductionAccount(account, extraKeywords){
      if (!account) return false;
      const name = normalizeForMatch(account.name || '');
      const keywords = (extraKeywords && extraKeywords.length) ? extraKeywords : DEFAULT_DEDUCTION_KEYWORDS;
      for (const kw of keywords){
        const k = normalizeForMatch(kw);
        if (!k) continue;
        if (name.includes(k)) return true;
      }
      return false;
    }

    function isPurchaseAccount(biz, account){
      if (!account) return false;
      const name = (account.name || '').toLowerCase();
      const code = String(account.code || '');
      const notes = (account.notes || '').toLowerCase();
      if (name.includes('purchase') || name.includes('purchases') || name.includes('inventory')) return true;
      if (/^51\d{0,}/.test(code)) return true;
      if (notes.includes('purchase') || notes.includes('inventory')) return true;
      return false;
    }

    function computeAnnualTax(taxableIncome, pitRules){
      if (!pitRules) pitRules = DEFAULT_PIT;
      const threshold = typeof pitRules.threshold === 'number' ? pitRules.threshold : DEFAULT_PIT.threshold;
      let remaining = Math.max(0, Number(taxableIncome) - threshold);
      if (remaining <= 0) return 0;
      let tax = 0;
      let lower = threshold;
      for (const slice of (pitRules.slices || DEFAULT_PIT.slices)){
        const sliceUpTo = (slice.upTo === Infinity) ? Infinity : slice.upTo;
        const sliceRange = sliceUpTo === Infinity ? Infinity : Math.max(0, sliceUpTo - lower);
        const take = Math.min(remaining, sliceRange);
        if (take > 0){
          tax += take * (Number(slice.rate) || 0);
          remaining -= take;
        }
        lower = sliceUpTo;
        if (remaining <= 0) break;
      }
      return Math.max(0, tax);
    }

    function getEmployeesForBusiness(b){
      if (!b || !Array.isArray(b.contacts)) return [];
      return b.contacts.filter(c => (c.type || '').toLowerCase() === 'employee');
    }

    // PAYE summary (kept minimal)
    function computeEmployeePayeSummaries(biz, taxYear){
      if (!biz) return [];
      // taxYear is a number (e.g., 2024)
      const txs = data.transactions[biz.id] || [];
      const pitRules = biz.pit || DEFAULT_PIT;
      const employees = getEmployeesForBusiness(biz);
      const keywords = DEFAULT_DEDUCTION_KEYWORDS.slice();
      const results = [];

      function classifyDeductionByAccountName(accName){
        if (!accName) return null;
        const n = normalizeForMatch(accName);
        if (n.includes('pension')) return 'pension';
        if (n.includes('nhf')) return 'nhf';
        if (n.includes('nhis')) return 'nhis';
        if (n.includes('life') && n.includes('assurance')) return 'life';
        if (n.includes('interest') && (n.includes('owner') || n.includes('house'))) return 'interest_owner_occupied';
        if (n.includes('rent')) return 'rent';
        return null;
      }

      for (const emp of employees){
        let gross = 0;
        let pensionTotal = 0, nhfTotal = 0, nhisTotal = 0, lifeTotal = 0, interestTotal = 0, rentTotal = 0, otherDeductionTotal = 0;

        for (const t of txs){
          if (!t.contactId || t.contactId !== emp.id) continue;
          if (!t.date) continue;
          if (t.date.slice(0,4) !== String(taxYear)) continue;
          const acc = findAccount(biz.id, t.accountId);
          if (!acc) continue;
          const isDeduction = isDeductionAccount(acc, keywords);
          const treatAsSalary = !!acc.isSalary || acc.type === 'Revenue' || (acc.type === 'Expense' && !isDeduction);
          const amt = Number(t.amount || 0);

          if (treatAsSalary){
            gross += amt;
          }

          const cls = classifyDeductionByAccountName(acc.name || '');
          if (cls === 'pension') pensionTotal += amt;
          else if (cls === 'nhf') nhfTotal += amt;
          else if (cls === 'nhis') nhisTotal += amt;
          else if (cls === 'life') lifeTotal += amt;
          else if (cls === 'interest_owner_occupied') interestTotal += amt;
          else if (cls === 'rent') rentTotal += amt;
          else {
            if (isDeduction) otherDeductionTotal += amt;
          }
        }

        const rentDeduction = Math.min(rentTotal * 0.20, 500000);
        const deductions = pensionTotal + nhfTotal + nhisTotal + lifeTotal + interestTotal + rentDeduction + otherDeductionTotal;
        const taxable = Math.max(0, gross - deductions);
        const annualPaye = computeAnnualTax(taxable, pitRules);
        const monthlyPaye = annualPaye / 12;

        results.push({
          contactId: emp.id,
          name: emp.name || '(no name)',
          gross,
          deductions,
          breakdown: {
            pension: pensionTotal,
            nhf: nhfTotal,
            nhis: nhisTotal,
            lifeAssurance: lifeTotal,
            interestOnOwnerOccupied: interestTotal,
            rentTotal,
            rentDeduction,
            otherStatutory: otherDeductionTotal
          },
          taxable,
          annualPaye,
          monthlyPaye
        });
      }
      return results;
    }

    function renderPayeSummary(biz, taxYear){
      payeSummaryDiv.innerHTML = '';
      if (!biz) { payeSummaryDiv.innerHTML = '<div class="muted">No business selected.</div>'; return; }
      if (!biz.pitEnabled) { payeSummaryDiv.innerHTML = '<div class="muted">PIT disabled for this business.</div>'; return; }
      const rows = computeEmployeePayeSummaries(biz, taxYear);
      if (!rows.length) { payeSummaryDiv.innerHTML = '<div class="muted">No employees found for this business (contacts with type "Employee").</div>'; return; }

      let html = `<strong>PAYE Summary (calendar year ${taxYear})</strong>`;
      html += `<table class="paye-table" role="table" aria-label="PAYE summary">
        <thead><tr><th>Employee</th><th>Gross Salary (₦)</th><th>Statutory Deductions (₦)</th><th>Taxable Income (₦)</th><th>Annual PAYE (₦)</th><th>Monthly PAYE (₦)</th></tr></thead><tbody>`;
      let totalGross=0, totalDeductions=0, totalTaxable=0, totalAnnual=0, totalMonthly=0;
      for (const r of rows){
        html += `<tr>
          <td>${escapeHtml(r.name)}</td>
          <td class="nowrap">${formatMoney(r.gross)}</td>
          <td class="nowrap">${formatMoney(r.deductions)}</td>
          <td class="nowrap">${formatMoney(r.taxable)}</td>
          <td class="nowrap">${formatMoney(r.annualPaye)}</td>
          <td class="nowrap">${formatMoney(r.monthlyPaye)}</td>
        </tr>`;
        totalGross += r.gross;
        totalDeductions += r.deductions;
        totalTaxable += r.taxable;
        totalAnnual += r.annualPaye;
        totalMonthly += r.monthlyPaye;
      }
      html += `</tbody><tfoot><tr style="font-weight:600;">
        <td>Total</td>
        <td class="nowrap">${formatMoney(totalGross)}</td>
        <td class="nowrap">${formatMoney(totalDeductions)}</td>
        <td class="nowrap">${formatMoney(totalTaxable)}</td>
        <td class="nowrap">${formatMoney(totalAnnual)}</td>
        <td class="nowrap">${formatMoney(totalMonthly)}</td>
      </tr></tfoot></table>`;
      payeSummaryDiv.innerHTML = html;
    }

    function renderMonthlyPayePitSummaries(){
      const b = findBiz(selectedBusinessId);
      const taxYear = Number(taxYearSelect.value);
      renderPayeSummary(b, taxYear);
      pitSummaryDiv.innerHTML = '';
      if (b && b.pit) {
        const bands = (b.pit.slices || DEFAULT_PIT.slices).map(s => {
          const upTo = s.upTo === Infinity ? 'and above' : `up to ₦${formatMoney(s.upTo)}`;
          return `<div>${upTo}: ${(Number(s.rate || 0)*100).toFixed(0)}%</div>`;
        }).join('');
        pitSummaryDiv.innerHTML = `<div class="muted">Tax-free threshold: ₦${formatMoney((b.pit && b.pit.threshold) ? b.pit.threshold : DEFAULT_PIT.threshold)} — Rate bands:</div><div style="margin-top:6px">${bands}</div>`;
      } else {
        pitSummaryDiv.innerHTML = '<div class="muted">PIT settings not configured for this business.</div>';
      }
    }

    function populateUserBusinessSelects(){
      userSelect.innerHTML = '';
      businessSelect.innerHTML = '';
      if (!data.users.length) {
        const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no users --'; userSelect.appendChild(opt);
      } else {
        data.users.forEach(u=>{ const opt = document.createElement('option'); opt.value=u.id; opt.textContent = (u.display||u.username); userSelect.appendChild(opt); });
      }
      if (!data.businesses.length) {
        const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no businesses --'; businessSelect.appendChild(opt);
      } else {
        data.businesses.forEach(b=>{ const opt = document.createElement('option'); opt.value=b.id; opt.textContent = b.name; businessSelect.appendChild(opt); });
      }

      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length) selectedBusinessId = data.businesses[0].id;
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function populateBizOwnerOptions(){
      const bizOwner = document.getElementById('bizOwner');
      bizOwner.innerHTML = '';
      if (!data.users.length) {
        const opt = document.createElement('option'); opt.value=''; opt.textContent='-- no users --'; bizOwner.appendChild(opt);
      } else {
        data.users.forEach(u=>{ const opt = document.createElement('option'); opt.value=u.id; opt.textContent = (u.display||u.username); bizOwner.appendChild(opt); });
      }
    }

    function populateContactSelects(){
      const b = findBiz(selectedBusinessId);
      const lists = [txnContact];
      lists.forEach(select => {
        if (!select) return;
        select.innerHTML = '';
        if (!b || !Array.isArray(b.contacts) || b.contacts.length === 0){
          const opt = document.createElement('option'); opt.value=''; opt.textContent = '-- no contacts --'; select.appendChild(opt);
        } else {
          const empty = document.createElement('option'); empty.value=''; empty.textContent='-- select contact --'; select.appendChild(empty);
          b.contacts.forEach(c=>{
            const opt = document.createElement('option'); opt.value = c.id; opt.textContent = (c.name || c.info || '(no name)') + ' (' + (c.type||'') + ')';
            select.appendChild(opt);
          });
        }
      });
    }

    function populateAccountSelects(){
      const b = findBiz(selectedBusinessId);
      const lists = [txnAccount, assetAccountSelect];
      lists.forEach(select => {
        if (!select) return;
        select.innerHTML = '';
        if (!b || !Array.isArray(b.accounts) || b.accounts.length === 0){
          const opt = document.createElement('option'); opt.value=''; opt.textContent = '-- no accounts --'; select.appendChild(opt);
        } else {
          const empty = document.createElement('option'); empty.value=''; empty.textContent='-- select account --'; select.appendChild(empty);
          b.accounts.forEach(a=>{
            const opt = document.createElement('option'); opt.value = a.id; opt.textContent = `${a.code || ''} - ${a.name} (${displayAccountType(a.type)})${a.isSalary ? ' [Salary]' : ''}`;
            select.appendChild(opt);
          });
        }
      });
    }

    function refreshContactsAccountsUI(){
      contactsListDiv.innerHTML = ''; accountsListDiv.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b){ contactsListDiv.textContent='No business selected.'; accountsListDiv.textContent='No business selected.'; populateContactSelects(); populateAccountSelects(); return; }
      if (!Array.isArray(b.contacts)) b.contacts = [];
      if (!Array.isArray(b.accounts)) b.accounts = [];

      if (b.contacts.length === 0) contactsListDiv.innerHTML = '<div class="muted">No contacts for this business.</div>';
      else {
        b.contacts.forEach(c=>{
          const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
          d.innerHTML = `<div><strong>${escapeHtml(c.name)}</strong> <span class="muted">(${escapeHtml(c.type)})</span><br/><small class="muted">${escapeHtml(c.info||'')}</small></div>`;
          contactsListDiv.appendChild(d);
        });
      }

      if (b.accounts.length === 0) accountsListDiv.innerHTML = '<div class="muted">No accounts for this business.</div>';
      else {
        b.accounts.forEach(a=>{
          const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='4px 0';
          const isWht = (b.whtAccountId && a.id === b.whtAccountId);
          const salaryTag = a.isSalary ? '<span class="muted"> (Salary)</span>' : '';
          d.innerHTML = `<div><strong>${escapeHtml(a.code)} - ${escapeHtml(a.name)}</strong> ${isWht?'<span class="muted"> (WHT Payable)</span>':''}${salaryTag} <span class="muted">(${escapeHtml(displayAccountType(a.type))})</span><br/><small class="muted">${escapeHtml(a.notes||'')}</small></div>`;
          accountsListDiv.appendChild(d);
        });
      }
      populateContactSelects();
      populateAccountSelects();
      // show startup balances under accounts list
      const existingStartup = document.getElementById('startupBalancesDisplay');
      if (existingStartup) existingStartup.remove();
      const startupDiv = document.createElement('div');
      startupDiv.id = 'startupBalancesDisplay';
      startupDiv.style.marginTop = '8px';
      if (b) {
        const nbv = Number(b.startupFixedAssets || 0) - Number(b.startupAccumDep || 0);
        startupDiv.innerHTML = `<strong>Opening balances</strong>
          <div>Fixed assets: ₦${formatMoney(b.startupFixedAssets)}</div>
          <div>Accum. depreciation: ₦${formatMoney(b.startupAccumDep)}</div>
          <div>Net book value: ₦${formatMoney(nbv)}</div>
          <div>Opening capital allowances: ₦${formatMoney(b.startupCapitalAllowances)}</div>
          <div>Opening retained profit: ₦${formatMoney(b.startupRetainedEarnings)}</div>`;
      } else {
        startupDiv.innerHTML = `<div class="muted">No opening balances</div>`;
      }
      accountsListDiv.parentNode.insertBefore(startupDiv, accountsListDiv.nextSibling);
    }

    function renderLedger(){
      ledgerTbody.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const txs = (data.transactions[b.id] || []).slice().sort((a,b2)=> (b2.date || '').localeCompare(a.date || '')); // desc by date
      let filtered = txs;
      const q = (ledgerFilterText || '').trim().toLowerCase();
      if (q){
        filtered = txs.filter(t=>{
          const acc = findAccount(b.id, t.accountId);
          const contact = findContact(b.id, t.contactId);
          const author = findUser(t.authorUserId);
          return (t.date||'').toLowerCase().includes(q) ||
                 (t.desc||'').toLowerCase().includes(q) ||
                 String(t.amount||'').toLowerCase().includes(q) ||
                 (acc && ((acc.name||'').toLowerCase().includes(q) || (acc.code||'').toLowerCase().includes(q))) ||
                 (contact && (contact.name||'').toLowerCase().includes(q)) ||
                 (author && ((author.display||'').toLowerCase().includes(q) || (author.username||'').toLowerCase().includes(q)));
        });
      }
      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageItems = filtered.slice(start, start + PAGE_SIZE);
      for (const t of pageItems){
        const tr = document.createElement('tr');
        const acc = findAccount(b.id, t.accountId);
        const contact = findContact(b.id, t.contactId);
        const author = findUser(t.authorUserId);

        let vatAmt = 0;
        if (b.vatEnabled && b.vatRate && acc && (acc.type === 'Revenue' || isPurchaseAccount(b, acc))){
          if (b.vatInclusive || t.vatInclusive){
            vatAmt = Number(t.amount || 0) * Number(b.vatRate || 0) / (100 + Number(b.vatRate || 0));
          } else {
            vatAmt = Number(t.amount || 0) * Number(b.vatRate || 0) / 100;
          }
        }

        let whtAmt = 0;
        if (t.whtEnabled && t.whtRate){
          if (t.whtInclusive){
            whtAmt = Number(t.amount || 0) * Number(t.whtRate || 0) / (100 + Number(t.whtRate || 0));
          } else {
            whtAmt = Number(t.amount || 0) * Number(t.whtRate || 0) / 100;
          }
        }

        const accText = acc ? `${acc.code || ''} - ${acc.name}` : '(no account)';
        tr.innerHTML = `<td>${escapeHtml(t.date || '')}</td>
          <td>${escapeHtml(t.desc || '')}${t.isFixedAsset ? '<div class="account-tag">[Fixed asset]</div>' : ''}</td>
          <td>${escapeHtml(accText)}</td>
          <td class="nowrap">${formatMoney(t.amount)}</td>
          <td class="nowrap">${formatMoney(vatAmt)}</td>
          <td class="nowrap">${formatMoney(whtAmt)}</td>
          <td>${escapeHtml(contact ? contact.name : '')}</td>
          <td>${escapeHtml(author ? (author.display || author.username) : '')}</td>
          <td style="white-space:nowrap">
            <button class="small" onclick="alert('Edit not implemented in this demo')">Edit</button>
            <button class="small danger" onclick="deleteTransaction('${b.id}','${t.id}')">Delete</button>
          </td>`;
        ledgerTbody.appendChild(tr);
      }
      pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
    }

    function deleteTransaction(bizId, txnId){
      if (!confirm('Delete transaction?')) return;
      if (!data.transactions[bizId]) return;
      data.transactions[bizId] = data.transactions[bizId].filter(t => t.id !== txnId);
      saveData();
      renderAll();
    }

    function calculateSummary(taxYearOverride){
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const txs = data.transactions[b.id] || [];

      let totalVatOutput = 0, totalVatInput = 0, totalWhtWithheld = 0, totalAmount = 0;
      for (const t of txs){
        // default summaries show for selected tax year unless not provided
        const taxYear = taxYearOverride || Number(taxYearSelect.value);
        if (!t.date || t.date.slice(0,4) !== String(taxYear)) continue;

        const acc = findAccount(b.id, t.accountId);
        if (!acc) continue;
        const amt = Number(t.amount || 0);
        totalAmount += amt;

        let vatAmt = 0;
        if (b.vatEnabled && b.vatRate && acc && (acc.type === 'Revenue' || isPurchaseAccount(b, acc))){
          if (b.vatInclusive || t.vatInclusive){
            vatAmt = amt * b.vatRate / (100 + b.vatRate);
          } else {
            vatAmt = amt * b.vatRate / 100;
          }
        }
        if (acc.type === 'Revenue') totalVatOutput += vatAmt;
        else if (isPurchaseAccount(b, acc)) totalVatInput += vatAmt;

        if (t.whtEnabled && t.whtRate){
          let whtAmt = 0;
          if (t.whtInclusive) whtAmt = amt * t.whtRate / (100 + t.whtRate);
          else whtAmt = amt * t.whtRate / 100;
          totalWhtWithheld += whtAmt;
        }
      }

      vatSummaryDiv.innerHTML = `<strong>VAT (year ${taxYearSelect.value})</strong><div>Output VAT: ₦${formatMoney(totalVatOutput)}</div><div>Input VAT: ₦${formatMoney(totalVatInput)}</div><div>Net VAT (payable): ₦${formatMoney(totalVatOutput - totalVatInput)}</div>`;
      whtSummaryDiv.innerHTML = `<strong>WHT</strong><div>Total withheld: ₦${formatMoney(totalWhtWithheld)}</div>`;
      totalsSummaryDiv.innerHTML = `<strong>Totals</strong><div>Total transactions amount (year): ₦${formatMoney(totalAmount)}</div>`;
    }

    // new: compute depreciation & capital allowances
    // prorated by months in tax year; straight-line
    function computeDepreciationAndCapitalAllowances(b, taxYear){
      if (!b) return { depreciation:0, capitalAllowanceThisYear:0, totalAvailableCapitalAllowance:0, openingCarry:0, carryForwardAfter:0 };
      const taxYearNum = Number(taxYear);
      // opening capital allowance from carryforward + startup
      const openingCAFromCarry = Number((b.taxCarryforward && b.taxCarryforward.capitalAllowances) || 0);
      const openingCAFromStartup = b.applyStartupToTax ? Number(b.startupCapitalAllowances || 0) : 0;
      const openingCA = openingCAFromCarry + openingCAFromStartup;

      // compute annual allowance = same as depreciation (straight-line) for assets
      let totalDepreciationThisYear = 0;
      let totalAnnualAllowanceThisYear = 0;
      // iterate fixed assets and compute prorated annual depreciation/allowance
      const assets = Array.isArray(b.fixedAssets) ? b.fixedAssets : [];
      for (const a of assets){
        const cost = Number(a.cost || 0);
        const accum = Number(a.accumulatedDepreciation || 0);
        const life = Number(a.usefulLifeYears || DEFAULT_USEFUL_LIFE_YEARS) || DEFAULT_USEFUL_LIFE_YEARS;
        if (cost <= accum) continue;
        // determine months in tax year for which asset is held
        // depreciable base
        const remainingNBV = cost - accum;
        const annualFull = remainingNBV / life;
        // prorate based on acquisition date:
        let monthsWithinYear = 12;
        if (a.dateAcquired){
          const acqDate = new Date(a.dateAcquired);
          const startOfYear = new Date(taxYearNum,0,1);
          const endOfYear = new Date(taxYearNum,11,31);
          if (acqDate > endOfYear) monthsWithinYear = 0;
          else {
            const effectiveStart = acqDate < startOfYear ? startOfYear : acqDate;
            // number of months inclusive in tax year
            const m = (endOfYear.getFullYear() - effectiveStart.getFullYear())*12 + (endOfYear.getMonth() - effectiveStart.getMonth()) + 1;
            monthsWithinYear = Math.max(0, Math.min(12, m));
          }
        }
        // prorate monthly
        const prorated = annualFull * (monthsWithinYear / 12);
        totalDepreciationThisYear += prorated;
        totalAnnualAllowanceThisYear += prorated; // per your instruction CA uses same straight-line rate
      }

      // also treat opening startup net CA as already included via openingCAFromStartup
      const totalAvailableCA = openingCA + totalAnnualAllowanceThisYear;
      // apply 2/3 of total available to this tax year, carry forward 1/3
      const applyThisYear = (2/3) * totalAvailableCA;
      const carryForward = totalAvailableCA - applyThisYear;

      return {
        depreciation: totalDepreciationThisYear,
        capitalAllowanceThisYear: totalAnnualAllowanceThisYear,
        totalAvailableCapitalAllowance: totalAvailableCA,
        openingCarry: openingCA,
        applyThisYear,
        carryForwardAfter: carryForward
      };
    }

    // taxable income compute and PIT display (complete implementation)
    function computeTaxableAndPit(){
      const b = findBiz(selectedBusinessId);
      if (!b) { alert('No business selected'); return; }

      const taxYear = Number(taxYearSelect.value);
      // compute accounting net profit A from transactions in tax year:
      // revenue - expenses - depreciation (from fixed assets)
      const txs = data.transactions[b.id] || [];
      let revenueTotal = 0;
      let expenseTotal = 0;
      // identify revenue vs expense by account type
      for (const t of txs){
        if (!t.date || t.date.slice(0,4) !== String(taxYear)) continue;
        const acc = findAccount(b.id, t.accountId);
        if (!acc) continue;
        const amt = Number(t.amount || 0);
        if (acc.type === 'Revenue') revenueTotal += amt;
        else if (acc.type === 'Expense') expenseTotal += amt;
        else {
          // treat Purchases as expense
          if (isPurchaseAccount(b, acc)) expenseTotal += amt;
        }
      }

      // compute depreciation & CA
      const depCA = computeDepreciationAndCapitalAllowances(b, taxYear);
      const depreciation = depCA.depreciation || 0;
      const capitalAllowanceThisYear = depCA.capitalAllowanceThisYear || 0;
      const totalAvailableCA = depCA.totalAvailableCapitalAllowance || 0;
      const openingCarry = depCA.openingCarry || 0;
      const applyThisYear = depCA.applyThisYear || 0;
      const carryForwardAfter = depCA.carryForwardAfter || 0;

      // Net profit A = revenue - expense - depreciation
      const netProfitA = revenueTotal - expenseTotal - depreciation;

      // gather user inputs
      const userNetProfitA = Number(netProfitAInput.value || 0);
      // allow manual override: if user supplied netProfitA input use that else computed
      const netProfitUsed = (userNetProfitA !== 0) ? userNetProfitA : netProfitA;

      const disallowable = Number(disallowableInput.value || 0);
      const nonTaxableIncome = Number(nonTaxableInput.value || 0);
      // capitalAllowancesInput is readonly; show applyThisYear computed
      capitalAllowancesInput.value = Math.round(applyThisYear * 100) / 100;

      const priorLossesInputNumber = Number(priorLossesInput.value || 0);
      // incorporate carryforward priorLosses stored in business.taxCarryforward as default
      const priorLossesStored = Number((b.taxCarryforward && b.taxCarryforward.priorLosses) || 0);
      const priorLosses = priorLossesInputNumber || priorLossesStored || 0;

      const otherAdjustments = Number(otherAdjustmentsInput.value || 0);

      // Taxable income = Net profit A + disallowable - nonTaxable - capital allowances applied - prior losses + other adjustments
      const taxableIncome = Math.max(0, netProfitUsed + disallowable - nonTaxableIncome - applyThisYear - priorLosses + otherAdjustments);

      // PIT (personal) — compute for a proprietor if needed (we compute PIT estimate on taxable income as provided)
      const pitRules = b.pit || DEFAULT_PIT;
      const annualPit = computeAnnualTax(taxableIncome, pitRules);

      // CIT
      // turnover = revenue for the tax year
      const turnover = revenueTotal;
      let cit = 0;
      let citRateUsed = 0;
      if (turnover < 50000000) {
        cit = 0;
        citRateUsed = 0;
      } else {
        citRateUsed = 0.25;
        cit = Math.max(0, taxableIncome * citRateUsed);
      }

      // prepare breakdown UI
      taxableResultDiv.style.display = 'block';
      taxableResultValue.textContent = formatMoney(taxableIncome);
      taxableBreakdownDiv.innerHTML = `
        <div class="muted">Computed net profit A (revenue - expenses - depreciation): ₦${formatMoney(netProfitA)}</div>
        <div class="muted">Depreciation (year ${taxYear}) : ₦${formatMoney(depreciation)}</div>
        <div class="muted">Opening capital allowances (carry & startup): ₦${formatMoney(openingCarry)}</div>
        <div class="muted">Annual capital allowance this year (from assets): ₦${formatMoney(capitalAllowanceThisYear)}</div>
        <div class="muted">Total available capital allowances (opening + current): ₦${formatMoney(totalAvailableCA)}</div>
        <div class="muted">Capital allowances applied to reduce taxable income (2/3 rule): ₦${formatMoney(applyThisYear)}</div>
        <div class="muted">Capital allowance carryforward after applying 2/3: ₦${formatMoney(carryForwardAfter)}</div>
        <div class="muted">Disallowable add-backs: ₦${formatMoney(disallowable)}</div>
        <div class="muted">Non-taxable income excluded: ₦${formatMoney(nonTaxableIncome)}</div>
        <div class="muted">Prior losses applied: ₦${formatMoney(priorLosses)}</div>
        <div class="muted">Other adjustments: ₦${formatMoney(otherAdjustments)}</div>
      `;

      // PIT UI
      pitResultDiv.style.display = 'block';
      pitAnnualValueSpan.textContent = formatMoney(annualPit);
      pitMonthlyValueSpan.textContent = formatMoney(annualPit / 12);
      pitNotesDiv.innerHTML = `<div class="muted">Using PIT bands with threshold ₦${formatMoney(pitRules.threshold)}</div>`;

      // CIT UI
      citResultDiv.style.display = 'block';
      citValueSpan.textContent = formatMoney(cit);
      citNotesDiv.innerHTML = `<div class="muted">Turnover in ${taxYear}: ₦${formatMoney(turnover)} — CIT rate used: ${(citRateUsed*100).toFixed(0)}%</div>`;

      // capital allowance apply/carry box
      capAllowApplyBox.style.display = 'block';
      capAllowAvailableSpan.textContent = formatMoney(totalAvailableCA);

      // show notable values in main tax summary
      taxSummaryDiv.innerHTML = `<strong>Tax Summary (${taxYear})</strong>
        <div>Net profit A: ₦${formatMoney(netProfitUsed)}</div>
        <div>Taxable income: ₦${formatMoney(taxableIncome)}</div>
        <div>PIT (annual estimate): ₦${formatMoney(annualPit)}</div>
        <div>CIT: ₦${formatMoney(cit)}</div>`;

      // Optionally save adjustments to business object
      if (saveTaxAdjToBusinessChk.checked){
        if (!b.taxAdjustments) b.taxAdjustments = {};
        b.taxAdjustments.netProfitA = netProfitUsed;
        b.taxAdjustments.disallowable = disallowable;
        b.taxAdjustments.nonTaxableIncome = nonTaxableIncome;
        b.taxAdjustments.capitalAllowances = applyThisYear;
        b.taxAdjustments.priorLosses = priorLosses;
        b.taxAdjustments.otherAdjustments = otherAdjustments;
        // update carryforward values in-memory but do not persist carryforward until user applies "Apply carryforward"
        b._computed = b._computed || {};
        b._computed.capAllowApplyThisYear = applyThisYear;
        b._computed.capAllowCarryAfter = carryForwardAfter;
        b._computed.capAllowTotalAvailable = totalAvailableCA;
        saveData();
        renderAll();
      }
    }

    function applyCarryforwardsToBusiness(){
      const b = findBiz(selectedBusinessId);
      if (!b) return alert('No business selected');
      // ensure we computed values
      if (!b._computed) return alert('Compute taxable income first to calculate carryforwards.');
      const carry = Number(b._computed.capAllowCarryAfter || 0);
      const priorLosses = Number(b.taxCarryforward && b.taxCarryforward.priorLosses || 0);
      // save carryforward capital allowances
      if (!b.taxCarryforward) b.taxCarryforward = { capitalAllowances: 0, priorLosses: 0 };
      b.taxCarryforward.capitalAllowances = carry;
      // we do not automatically change priorLosses here unless user indicates
      saveData();
      alert('Carryforwards saved to business (capital allowances).');
      renderAll();
    }

    function resetCarryforwardsForBusiness(){
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm('Reset carryforward capital allowances to zero?')) return;
      if (!b.taxCarryforward) b.taxCarryforward = { capitalAllowances: 0, priorLosses: 0 };
      b.taxCarryforward.capitalAllowances = 0;
      saveData();
      renderAll();
    }

    // UI for assets
    function renderFixedAssetsList(){
      fixedAssetsListDiv.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b) { fixedAssetsListDiv.innerHTML = '<div class="muted">No business selected.</div>'; return; }
      const taxYear = Number(taxYearSelect.value);
      if (!Array.isArray(b.fixedAssets) || b.fixedAssets.length === 0){
        fixedAssetsListDiv.innerHTML = '<div class="muted">No fixed assets recorded.</div>';
        return;
      }
      const ul = document.createElement('div');
      ul.innerHTML = '<strong>Fixed assets</strong>';
      b.fixedAssets.forEach(a=>{
        const acName = findAccount(b.id, a.accountId);
        const d = document.createElement('div');
        d.style.padding = '6px 0';
        const depInfo = computeDepForAsset(a, b, taxYear);
        d.innerHTML = `<div><strong>${escapeHtml(a.name)}</strong> <span class="muted">(${escapeHtml(acName ? acName.name : '')})</span></div>
          <div class="muted">Cost: ₦${formatMoney(a.cost)} — Acquired: ${escapeHtml(a.dateAcquired || '')} — Useful life: ${escapeHtml(String(a.usefulLifeYears || DEFAULT_USEFUL_LIFE_YEARS))} yrs</div>
          <div class="muted">Opening accumulated depreciation: ₦${formatMoney(a.accumulatedDepreciation || 0)} — Depreciation this year (prorated ${taxYear}): ₦${formatMoney(depInfo.prorated)}</div>
          <div style="margin-top:4px;"><button class="small" onclick="editAsset('${b.id}','${a.id}')">Edit</button> <button class="small danger" onclick="deleteAsset('${b.id}','${a.id}')">Delete</button></div>
        `;
        fixedAssetsListDiv.appendChild(d);
      });
    }

    function computeDepForAsset(a, b, taxYear){
      const cost = Number(a.cost || 0);
      const accum = Number(a.accumulatedDepreciation || 0);
      const life = Number(a.usefulLifeYears || DEFAULT_USEFUL_LIFE_YEARS) || DEFAULT_USEFUL_LIFE_YEARS;
      const remainingNBV = Math.max(0, cost - accum);
      const annualFull = remainingNBV / life;
      let monthsWithinYear = 12;
      if (a.dateAcquired){
        const acqDate = new Date(a.dateAcquired);
        const startOfYear = new Date(Number(taxYear),0,1);
        const endOfYear = new Date(Number(taxYear),11,31);
        if (acqDate > endOfYear) monthsWithinYear = 0;
        else {
          const effectiveStart = acqDate < startOfYear ? startOfYear : acqDate;
          const m = (endOfYear.getFullYear() - effectiveStart.getFullYear())*12 + (endOfYear.getMonth() - effectiveStart.getMonth()) + 1;
          monthsWithinYear = Math.max(0, Math.min(12, m));
        }
      }
      const prorated = annualFull * (monthsWithinYear / 12);
      return { annualFull, prorated };
    }

    function editAsset(bizId, assetId){
      const b = findBiz(bizId);
      const a = findAsset(bizId, assetId);
      if (!a) return;
      // populate modal
      assetNameInput.value = a.name || '';
      assetAccountSelect.value = a.accountId || '';
      assetCostInput.value = a.cost || 0;
      assetDateInput.value = a.dateAcquired || '';
      assetLifeInput.value = a.usefulLifeYears || DEFAULT_USEFUL_LIFE_YEARS;
      assetAccumInput.value = a.accumulatedDepreciation || 0;
      assetModal.style.display = 'block';
      modalOverlay.style.display = 'block';
      assetModal.setAttribute('data-editing', assetId);
    }

    function deleteAsset(bizId, assetId){
      if (!confirm('Delete fixed asset?')) return;
      const b = findBiz(bizId);
      if (!b || !Array.isArray(b.fixedAssets)) return;
      b.fixedAssets = b.fixedAssets.filter(f => f.id !== assetId);
      saveData();
      renderAll();
    }

    // initial population of taxYearSelect — default previous calendar year but editable + show +/- few years
    function populateTaxYearOptions(){
      const now = new Date();
      const current = now.getFullYear();
      const defaultYear = current - 1; // preceding calendar year
      taxYearSelect.innerHTML = '';
      for (let y = current - 5; y <= current + 1; y++){
        const opt = document.createElement('option'); opt.value = y; opt.textContent = y;
        if (y === defaultYear) opt.selected = true;
        taxYearSelect.appendChild(opt);
      }
    }

    // event handlers
    function wireUpEventHandlers(){
      userSelect.addEventListener('change', () => { selectedUserId = userSelect.value; saveData(); renderAll(); });
      businessSelect.addEventListener('change', () => { selectedBusinessId = businessSelect.value; saveData(); renderAll(); });
      btnAddTxn.addEventListener('click', () => {
        const b = findBiz(selectedBusinessId);
        if (!b) return alert('No business selected');
        const date = txnDate.value || new Date().toISOString().slice(0,10);
        const desc = txnDesc.value || '';
        const amt = Number(txnAmount.value || 0);
        const accId = txnAccount.value || '';
        const contactId = txnContact.value || '';
        const t = {
          id: uid('txn'),
          date,
          desc,
          amount: amt,
          authorUserId: selectedUserId,
          contactId,
          accountId: accId,
          whtEnabled: !!document.getElementById('txnWhtEnabled') && document.getElementById('txnWhtEnabled').checked,
          whtRate: Number(document.getElementById('txnWhtRate') ? document.getElementById('txnWhtRate').value : 0),
          whtInclusive: !!(document.getElementById('txnWhtInclusive') && document.getElementById('txnWhtInclusive').checked),
          vatInclusive: false,
          isFixedAsset: !!txnIsFixedAsset.checked
        };
        if (!data.transactions[b.id]) data.transactions[b.id] = [];
        data.transactions[b.id].push(t);
        // if transaction is marked fixed asset, create an asset entry
        if (t.isFixedAsset && accId){
          const asset = {
            id: uid('fa'),
            accountId: accId,
            name: desc || ('Asset ' + new Date().toISOString().slice(0,10)),
            cost: amt,
            dateAcquired: date,
            usefulLifeYears: Number(txnAssetLife.value || DEFAULT_USEFUL_LIFE_YEARS),
            accumulatedDepreciation: 0
          };
          if (!b.fixedAssets) b.fixedAssets = [];
          b.fixedAssets.push(asset);
        }
        // reset fields
        txnDate.value = '';
        txnDesc.value = '';
        txnAmount.value = '';
        txnContact.value = '';
        txnAccount.value = '';
        txnIsFixedAsset.checked = false;
        txnAssetLife.value = DEFAULT_USEFUL_LIFE_YEARS;
        saveData();
        renderAll();
      });

      btnSearch.addEventListener('click', () => { ledgerFilterText = ledgerSearch.value || ''; currentPage = 1; renderLedger(); });
      btnClearSearch.addEventListener('click', () => { ledgerSearch.value=''; ledgerFilterText=''; currentPage=1; renderLedger(); });

      btnPrevPage.addEventListener('click', () => { currentPage = Math.max(1, currentPage - 1); renderLedger(); });
      btnNextPage.addEventListener('click', () => { currentPage = currentPage + 1; renderLedger(); });

      btnExport.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'nigeria_tax_data.json'; a.click(); URL.revokeObjectURL(url);
      });
      btnImport.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = function(evt){
          try {
            data = JSON.parse(evt.target.result);
            saveData();
            renderAll();
          } catch(err){ alert('Invalid JSON file'); }
        };
        reader.readAsText(f);
      });
      btnClearAll.addEventListener('click', () => {
        if (!confirm('Clear all data? This cannot be undone.')) return;
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });

      btnComputeTaxable.addEventListener('click', () => computeTaxableAndPit());
      btnLoadFromBusiness.addEventListener('click', () => {
        const b = findBiz(selectedBusinessId);
        if (!b || !b.taxAdjustments) return alert('No saved tax adjustments for this business.');
        const t = b.taxAdjustments;
        netProfitAInput.value = Number(t.netProfitA || 0);
        disallowableInput.value = Number(t.disallowable || 0);
        nonTaxableInput.value = Number(t.nonTaxableIncome || 0);
        capitalAllowancesInput.value = Number(t.capitalAllowances || 0);
        priorLossesInput.value = Number(t.priorLosses || 0);
        otherAdjustmentsInput.value = Number(t.otherAdjustments || 0);
      });

      btnApplyCarryforwards.addEventListener('click', () => applyCarryforwardsToBusiness());
      btnResetCarryforwards.addEventListener('click', () => resetCarryforwardsForBusiness());

      // asset modal
      btnAddAsset.addEventListener('click', () => {
        assetModal.style.display = 'block';
        modalOverlay.style.display = 'block';
        assetModal.removeAttribute('data-editing');
        assetNameInput.value = '';
        assetAccountSelect.value = '';
        assetCostInput.value = '';
        assetDateInput.value = new Date().toISOString().slice(0,10);
        assetLifeInput.value = DEFAULT_USEFUL_LIFE_YEARS;
        assetAccumInput.value = 0;
      });
      assetCancel.addEventListener('click', () => { assetModal.style.display = 'none'; modalOverlay.style.display='none'; assetModal.removeAttribute('data-editing'); });
      assetSave.addEventListener('click', () => {
        const b = findBiz(selectedBusinessId);
        if (!b) return alert('No business selected');
        const editingId = assetModal.getAttribute('data-editing');
        const assetRecord = {
          id: editingId || uid('fa'),
          accountId: assetAccountSelect.value || '',
          name: assetNameInput.value || ('Asset ' + new Date().toISOString().slice(0,10)),
          cost: Number(assetCostInput.value || 0),
          dateAcquired: assetDateInput.value || new Date().toISOString().slice(0,10),
          usefulLifeYears: Number(assetLifeInput.value || DEFAULT_USEFUL_LIFE_YEARS),
          accumulatedDepreciation: Number(assetAccumInput.value || 0)
        };
        if (!b.fixedAssets) b.fixedAssets = [];
        if (editingId){
          b.fixedAssets = b.fixedAssets.map(f => f.id === editingId ? assetRecord : f);
        } else {
          b.fixedAssets.push(assetRecord);
        }
        assetModal.style.display = 'none';
        modalOverlay.style.display = 'none';
        assetModal.removeAttribute('data-editing');
        saveData();
        renderAll();
      });

      modalOverlay.addEventListener('click', () => {
        // close modals if overlay clicked
        document.querySelectorAll('.modal').forEach(m=>{ m.style.display='none'; m.removeAttribute('data-editing'); });
        modalOverlay.style.display = 'none';
      });

      taxYearSelect.addEventListener('change', () => renderAll());
    }

    // CRUD for users, businesses, accounts, contacts — minimal implementations
    // Add user
    btnAddUser.addEventListener('click', ()=> {
      document.getElementById('userModalTitle').textContent = 'Add User';
      document.getElementById('userName').value = '';
      document.getElementById('userDisplay').value = '';
      document.getElementById('userModal').style.display = 'block';
      modalOverlay.style.display = 'block';
    });
    document.getElementById('userCancel').addEventListener('click', ()=>{ document.getElementById('userModal').style.display='none'; modalOverlay.style.display='none'; });
    document.getElementById('userSave').addEventListener('click', ()=> {
      const username = document.getElementById('userName').value || ('user_' + Date.now());
      const display = document.getElementById('userDisplay').value || username;
      const u = { id: uid('user'), username, display };
      data.users.push(u);
      selectedUserId = u.id;
      saveData();
      document.getElementById('userModal').style.display='none'; modalOverlay.style.display='none';
      populateUserBusinessSelects(); populateBizOwnerOptions(); renderAll();
    });

    // Add business
    btnAddBusiness.addEventListener('click', () => {
      document.getElementById('businessModalTitle').textContent = 'Add Business';
      bizNameInput.value = '';
      populateBizOwnerOptions();
      bizVatInput.value = 7.5;
      bizCurrencyInput.value = '₦';
      bizThresholdInput.value = 800000;
      bizNotesInput.value = '';
      bizVatEnabledChk.checked = true;
      bizPitEnabledChk.checked = true;
      bizVatInclusiveChk.checked = false;
      bizWhtEnabledChk.checked = true;
      bizWhtCodeInput.value = '2300';
      bizStartupFixedAssetsInput.value = 0;
      bizStartupAccumDepInput.value = 0;
      bizStartupCapitalAllowancesInput.value = 0;
      bizStartupRetainedEarningsInput.value = 0;
      bizApplyStartupToTaxChk.checked = true;
      document.getElementById('businessModal').style.display = 'block';
      modalOverlay.style.display = 'block';
    });
    document.getElementById('bizCancel').addEventListener('click', ()=>{ document.getElementById('businessModal').style.display='none'; modalOverlay.style.display='none'; });
    document.getElementById('bizSave').addEventListener('click', () => {
      const ownerId = bizOwnerSelect.value || (data.users[0] && data.users[0].id) || '';
      const b = {
        id: uid('biz'),
        name: bizNameInput.value || ('Business ' + Date.now()),
        ownerId: ownerId,
        members: ownerId ? [ownerId] : [],
        vatRate: Number(bizVatInput.value || 7.5),
        currency: bizCurrencyInput.value || '₦',
        threshold: Number(bizThresholdInput.value || 800000),
        notes: bizNotesInput.value || '',
        vatEnabled: !!bizVatEnabledChk.checked,
        pitEnabled: !!bizPitEnabledChk.checked,
        vatInclusive: !!bizVatInclusiveChk.checked,
        whtAutoCreate: !!bizWhtEnabledChk.checked,
        whtCode: bizWhtCodeInput.value || '2300',
        contacts: [],
        accounts: [],
        fixedAssets: [],
        pit: DEFAULT_PIT,
        taxAdjustments: { netProfitA:0, disallowable:0, nonTaxableIncome:0, capitalAllowances:0, priorLosses:0, otherAdjustments:0 },
        taxCarryforward: { capitalAllowances: Number(bizStartupCapitalAllowancesInput.value || 0), priorLosses: 0 },
        startupFixedAssets: Number(bizStartupFixedAssetsInput.value || 0),
        startupAccumDep: Number(bizStartupAccumDepInput.value || 0),
        startupCapitalAllowances: Number(bizStartupCapitalAllowancesInput.value || 0),
        startupRetainedEarnings: Number(bizStartupRetainedEarningsInput.value || 0),
        applyStartupToTax: !!bizApplyStartupToTaxChk.checked
      };
      ensureBizWhtAccount(b);
      data.businesses.push(b);
      selectedBusinessId = b.id;
      if (!data.transactions[b.id]) data.transactions[b.id] = [];
      saveData();
      document.getElementById('businessModal').style.display='none'; modalOverlay.style.display='none';
      populateUserBusinessSelects(); renderAll();
    });

    // Contacts modal
    btnAddContactInline.addEventListener('click', ()=> {
      document.getElementById('contactModalTitle').textContent = 'Add Contact';
      document.getElementById('contactName').value='';
      document.getElementById('contactType').value='Customer';
      document.getElementById('contactInfo').value='';
      document.getElementById('contactModal').style.display='block';
      modalOverlay.style.display='block';
    });
    document.getElementById('contactCancel').addEventListener('click', ()=>{ document.getElementById('contactModal').style.display='none'; modalOverlay.style.display='none'; });
    document.getElementById('contactSave').addEventListener('click', ()=> {
      const b = findBiz(selectedBusinessId);
      if (!b) return alert('No business selected');
      const contact = { id: uid('c'), name: document.getElementById('contactName').value || 'Contact', type: document.getElementById('contactType').value || 'Customer', info: document.getElementById('contactInfo').value || '' };
      if (!b.contacts) b.contacts = [];
      b.contacts.push(contact);
      saveData();
      document.getElementById('contactModal').style.display='none'; modalOverlay.style.display='none';
      renderAll();
    });

    // Accounts modal
    btnAddAccountInline.addEventListener('click', ()=> {
      document.getElementById('accountModalTitle').textContent = 'Add Account';
      document.getElementById('accountCode').value='';
      document.getElementById('accountName').value='';
      document.getElementById('accountType').value='Expense';
      document.getElementById('accountNotes').value='';
      document.getElementById('accountIsSalary').checked = false;
      document.getElementById('accountModal').style.display='block';
      modalOverlay.style.display='block';
    });
    document.getElementById('accountCancel').addEventListener('click', ()=>{ document.getElementById('accountModal').style.display='none'; modalOverlay.style.display='none'; });
    document.getElementById('accountSave').addEventListener('click', ()=> {
      const b = findBiz(selectedBusinessId);
      if (!b) return alert('No business selected');
      const account = { id: uid('a'), code: document.getElementById('accountCode').value || '', name: document.getElementById('accountName').value || 'Account', type: document.getElementById('accountType').value || 'Expense', notes: document.getElementById('accountNotes').value || '', isSalary: !!document.getElementById('accountIsSalary').checked };
      if (!b.accounts) b.accounts = [];
      b.accounts.push(account);
      saveData();
      document.getElementById('accountModal').style.display='none'; modalOverlay.style.display='none';
      renderAll();
    });

    function renderTaxYearedViews(){
      const b = findBiz(selectedBusinessId);
      const taxYear = Number(taxYearSelect.value);
      // summaries
      calculateSummary(taxYear);
      renderMonthlyPayePitSummaries();
      // render assets list with depreciation info for selected year
      renderFixedAssetsList();
    }

    function renderAll(){
      populateUserBusinessSelects();
      populateBizOwnerOptions();
      populateContactSelects();
      populateAccountSelects();
      refreshContactsAccountsUI();
      renderLedger();
      renderTaxYearedViews();
      // refresh account/asset selects in modals
      populateAccountSelects();
    }

    // startup
    loadData();
    populateTaxYearOptions();
    populateUserBusinessSelects();
    populateBizOwnerOptions();
    wireUpEventHandlers();
    renderAll();

    // expose some helpers globally for inline onclick handlers
    window.deleteTransaction = deleteTransaction;
    window.editAsset = editAsset;
    window.deleteAsset = deleteAsset;

  </script>

  <footer>
    <div class="muted">Demo software for Nigerian tax computations — includes fixed assets, prorated straight-line depreciation, capital allowance absorption (2/3) and carry forward (1/3), CIT, VAT, WHT and PAYE summaries. Data stored in browser localStorage.</div>
  </footer>
</body>
</html>

Notes and next steps
- Default useful life: set to 4 years as you requested; per-asset useful life is editable in the Add Asset modal and when marking a transaction as a fixed asset you can set the useful life inline.
- Depreciation: straight-line, prorated by months in the tax year (partial-year allowance for assets acquired during the year).
- Capital allowances: computed using the same straight-line annual allowance. Total available CA = opening carryforward + opening startup CA (if enabled) + current-year allowance. 2/3 of total available is applied to reduce taxable income; 1/3 carried forward and persisted when you click "Apply carryforward (persist)".
- Tax year: selectable in the header (defaults to preceding calendar year), and all tax-year-relevant computations are filtered to that year (PIT, PAYE, VAT/WHT summaries, depreciation/CA).
- PAYE: computed by annualising gross salary after statutory deductions (pension, NHF, NHIS, life) using existing deduction detection. PIT uses DEFAULT_PIT bands you confirmed.
- CIT: uses turnover=total revenue for selected tax year; 0% if turnover < ₦50,000,000; 25% otherwise.
- Persistence: carryforwards saved on business.taxCarryforward when you click Apply; tax adjustments can be saved to business.taxAdjustments if you check the box when computing.

If you want, I can:
- Add an automatic "close tax year" button that both applies carryforwards and advances the tax year selector.
- Implement pro-rating rules differently (e.g., half-year convention) if desired.
- Add an export of the computed tax report for the selected year (PDF/CSV/JSON).

Tell me if you want any of the above changes or a PR opened directly to your repository (I can create a branch and PR if you confirm).
