<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Tax & Accounting — 2026 (PIT/CIT) + Inventory + Fixed Assets</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:18px; color:#222; background:#fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(960px,96vw); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .smallInput { width:110px; }
    .table-scroll { max-height:220px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Tax & Accounting — 2026 (PIT/CIT)</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none;" />
    </div>
  </header>

  <main>
    <!-- Ledger area (default) -->
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label class="inline-label">
          <input type="checkbox" id="txnVatApply" /> VAT applies
        </label>
        <label class="inline-label">
          <input type="checkbox" id="txnVatInclusive" /> VAT inclusive
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied (receivable)
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>
          Contact type:
          <select id="txnContactType">
            <option value="">-- none --</option>
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
          </select>
        </label>
        <label>Contact name: <input type="text" id="txnContactName" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>
          <label class="inline-label"><input type="checkbox" id="invVat" /> VAT applies</label>
          <label class="inline-label"><input type="checkbox" id="invVatInclusive" /> VAT inclusive</label>

          <label>Contact type:
            <select id="invContactType">
              <option value="">-- none --</option>
              <option value="Customer">Customer</option>
              <option value="Vendor">Vendor</option>
              <option value="Employee">Employee</option>
            </select>
          </label>
          <label>Contact name: <input type="text" id="invContactName" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>

          <label>Contact type:
            <select id="assetContactType">
              <option value="">-- none --</option>
              <option value="Customer">Customer</option>
              <option value="Vendor">Vendor</option>
              <option value="Employee">Employee</option>
            </select>
          </label>
          <label>Contact name: <input type="text" id="assetContactName" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small">Record Asset Purchase</button>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days. Capital allowance applied monthly from purchase.</small>
      </div>
    </section>

    <!-- Ledger list -->
    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount (Net)</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th><th>Inv Item / Asset</th><th>Disallowable</th><th>Non-tax</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="totalsSummary" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <!-- Reports section (hidden by default, opened via tab) -->
    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable</button>
        <button class="small tab" data-report="whtReceivable">WHT Receivable</button>
        <button class="small tab" data-report="profitSnapshot">Profit Snapshot</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Fixed Assets Report</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <!-- Inventory & Assets quick display (also kept but primary moved into Reports) -->
    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshot" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">FIRS / External</h4>
        <div class="row">
          <label>FIRS login label: <input type="text" id="bizFirsLabel" class="smallInput" /></label>
          <label>FIRS login URL: <input type="text" id="bizFirsUrl" style="min-width:320px;" /></label>
        </div>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">GitHub Copilot Chat Assistant — implemented per request (attachments and audit stored in localStorage)</footer>

  <script>
    // GitHub Copilot Chat Assistant implementation
    const STORAGE_KEY = 'ntc_2026_v2';

    // Defaults
    const DEFAULTS = {
      vatRate: 7.5,
      whtRate: 5.0,
      citRate: 25.0,
      vatEnabled: true,
      payeEnabled: true,
      pitEnabled: true,
      showLines: true,
      firsLabel: 'taxpromax',
      firsUrl: 'https://www.firs.gov.ng/login',
      citEnabled: true
    };

    // PAYE bands per user-provided table (annual progressive)
    const PAYE_BANDS = [
      { upTo: 800000, rate: 0.00 },
      { upTo: 3000000, rate: 0.15 },
      { upTo: 12000000, rate: 0.18 },
      { upTo: 25000000, rate: 0.21 },
      { upTo: 50000000, rate: 0.23 },
      { upTo: Infinity, rate: 0.25 }
    ];

    // Data model
    // data = { users:[], businesses:[], transactions: { [userId]: { [bizId]: [] } }, attachments:[], audit:[] }
    let data = { users: [], businesses: [], transactions: {}, attachments: [], audit: [] };
    let selectedUser = null;       // active user (performing actions)
    let selectedBiz = null;
    let activeTab = 'ledger';

    // DOM refs
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
    const btnManageAccounts = document.getElementById('btnManageAccounts');

    const txnDate = document.getElementById('txnDate');
    const txnAction = document.getElementById('txnAction');
    const txnAccount = document.getElementById('txnAccount');
    const txnDesc = document.getElementById('txnDesc');
    const txnAmount = document.getElementById('txnAmount');
    const txnVatApply = document.getElementById('txnVatApply');
    const txnVatInclusive = document.getElementById('txnVatInclusive');
    const txnWht = document.getElementById('txnWht');
    const txnWhtRate = document.getElementById('txnWhtRate');
    const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
    const txnSalary = document.getElementById('txnSalary');
    const txnContactType = document.getElementById('txnContactType');
    const txnContactName = document.getElementById('txnContactName');
    const txnReceipt = document.getElementById('txnReceipt');
    const btnAddTxn = document.getElementById('btnAddTxn');

    const inventorySubform = document.getElementById('inventorySubform');
    const invItemSelect = document.getElementById('invItemSelect');
    const invNewName = document.getElementById('invNewName');
    const invAccountSelect = document.getElementById('invAccountSelect');
    const invQty = document.getElementById('invQty');
    const invUnitPrice = document.getElementById('invUnitPrice');
    const invVat = document.getElementById('invVat');
    const invVatInclusive = document.getElementById('invVatInclusive');
    const invContactType = document.getElementById('invContactType');
    const invContactName = document.getElementById('invContactName');
    const invReceipt = document.getElementById('invReceipt');
    const btnAddInv = document.getElementById('btnAddInv');
    const btnInvCancel = document.getElementById('btnInvCancel');
    const btnInvUndo = document.getElementById('btnInvUndo');

    const assetSubform = document.getElementById('assetSubform');
    const assetName = document.getElementById('assetName');
    const assetCost = document.getElementById('assetCost');
    const assetPurchaseDate = document.getElementById('assetPurchaseDate');
    const assetLife = document.getElementById('assetLife');
    const assetCA = document.getElementById('assetCA');
    const assetDisposalDate = document.getElementById('assetDisposalDate');
    const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
    const btnAddAsset = document.getElementById('btnAddAsset');
    const btnDisposeAsset = document.getElementById('btnDisposeAsset');
    const btnAssetCancel = document.getElementById('btnAssetCancel');
    const btnAssetUndo = document.getElementById('btnAssetUndo');
    const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
    const assetDisposalAccount = document.getElementById('assetDisposalAccount');
    const assetContactType = document.getElementById('assetContactType');
    const assetContactName = document.getElementById('assetContactName');
    const assetReceipt = document.getElementById('assetReceipt');

    const ledgerTable = document.querySelector('#ledgerTable tbody');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const inventoryListDiv = document.getElementById('inventoryList');
    const assetListDiv = document.getElementById('assetList');
    const plSnapshotDiv = document.getElementById('plSnapshot');

    const ledgerSection = document.getElementById('ledgerSection');
    const ledgerListSection = document.getElementById('ledgerListSection');
    const reportsSection = document.getElementById('reportsSection');
    const reportContent = document.getElementById('reportContent');

    // Modals
    const modalOverlay = document.getElementById('modalOverlay');
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userRole = document.getElementById('userRole');
    const permView = document.getElementById('permView');
    const permEdit = document.getElementById('permEdit');
    const permDelete = document.getElementById('permDelete');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwnerSelect = document.getElementById('bizOwner');
    const bizEntity = document.getElementById('bizEntity');
    const bizVat = document.getElementById('bizVat');
    const bizWht = document.getElementById('bizWht');
    const bizCit = document.getElementById('bizCit');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizPayeEnabled = document.getElementById('bizPayeEnabled');
    const bizShowLines = document.getElementById('bizShowLines');
    const bizCitEnabled = document.getElementById('bizCitEnabled');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');
    const bizLossBF = document.getElementById('bizLossBF');
    const bizCACF = document.getElementById('bizCACF');
    const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
    const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
    const bizDedPension = document.getElementById('bizDedPension');
    const bizDedRent = document.getElementById('bizDedRent');
    const bizDedLife = document.getElementById('bizDedLife');
    const bizDedMortgage = document.getElementById('bizDedMortgage');
    const bizDedNHF = document.getElementById('bizDedNHF');
    const bizCACFInput = bizCACF;
    const bizCapitalBF = document.getElementById('bizCapitalBF');
    const bizFirsLabel = document.getElementById('bizFirsLabel');
    const bizFirsUrl = document.getElementById('bizFirsUrl');
    const bizContactsList = document.getElementById('bizContactsList');
    const newContactName = document.getElementById('newContactName');
    const newContactType = document.getElementById('newContactType');
    const btnAddContact = document.getElementById('btnAddContact');

    const accountsModal = document.getElementById('accountsModal');
    const accountsList = document.getElementById('accountsList');
    const newAccountName = document.getElementById('newAccountName');
    const newAccountCategory = document.getElementById('newAccountCategory');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const closeAccountsBtn = document.getElementById('closeAccountsBtn');

    // Header tabs
    const btnLedgerTab = document.getElementById('btnLedgerTab');
    const btnReportsTab = document.getElementById('btnReportsTab');

    // helpers
    function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function today(){ return new Date().toISOString().slice(0,10); }

    // load/save
    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){ try { data = JSON.parse(raw); migrateData(); return; } catch(e){ console.error('invalid data', e); } }
      seedDemo();
    }

    function migrateData(){
      if (!data.users) data.users = [];
      if (!data.businesses) data.businesses = [];
      if (!data.transactions) data.transactions = {};
      if (!data.attachments) data.attachments = [];
      if (!data.audit) data.audit = [];
      // normalize
      data.businesses.forEach(b => {
        b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
        b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
        b.citRate = Number(b.citRate || DEFAULTS.citRate);
        b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
        b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
        b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
        b.showLines = (typeof b.showLines === 'undefined') ? true : !!b.showLines;
        b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
        if (!b.accounts) b.accounts = [];
        if (!b.inventory) b.inventory = [];
        if (!b.assets) b.assets = [];
        b.lossBroughtForward = Number(b.lossBroughtForward || 0);
        b.caCarryForward = Number(b.caCarryForward || 0);
        b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
        if (typeof b.defaultExpenseDisallowable === 'undefined') b.defaultExpenseDisallowable = false;
        if (typeof b.defaultRevenueNonTax === 'undefined') b.defaultRevenueNonTax = false;
        if (!b.statutoryDeductions) b.statutoryDeductions = { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
        if (!b.contacts) b.contacts = [];
        if (!b.firsLabel) { b.firsLabel = DEFAULTS.firsLabel; }
        if (!b.firsUrl) { b.firsUrl = DEFAULTS.firsUrl; }
      });
      data.users.forEach((u, idx) => {
        if (typeof u.role === 'undefined') u.role = (idx === 0) ? 'Admin' : 'User';
        if (!u.permissions) u.permissions = { view: true, edit: true, delete: true };
        if (typeof u.isAdmin === 'undefined') u.isAdmin = (u.role === 'Admin');
      });
      // ensure transaction arrays exist
      for (const u of data.users){
        if (!data.transactions[u.id]) data.transactions[u.id] = {};
        data.businesses.forEach(b => { if (!data.transactions[u.id][b.id]) data.transactions[u.id][b.id] = []; });
      }
      saveData();
    }

    function seedDemo(){
      const u = uid('user'), b = uid('biz');
      const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
      const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const expenseSalary = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      data = {
        users: [{ id: u, username: 'admin', display: 'Admin User', role: 'Admin', isAdmin: true, permissions: { view:true, edit:true, delete:true } }],
        businesses: [{
          id: b, name: 'Demo Business', ownerId: u, entity: 'Company',
          vatRate: 7.5, whtRate: 5.0, citRate: 25.0,
          vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
          accounts: [sales, cogs, expenseSalary],
          inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
          assets: [],
          lossBroughtForward: 0,
          caCarryForward: 0,
          capitalBroughtForward: 0,
          defaultExpenseDisallowable: false,
          defaultRevenueNonTax: false,
          statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
          contacts: []
        }],
        transactions: {},
        attachments: [],
        audit: []
      };
      data.transactions[u] = {};
      data.transactions[u][b] = [
        { id: uid('txn'), date: today(), action: 'Revenue', accountId: sales.id, accountName: sales.name, description:'Demo sale', amount: 150000, vatAmount: 11250, whtApplied:false, whtAmount:0, isSalary:false, payeAmount:0, invItemName:'', disallowable:false, nonTaxable:false, contactType:'Customer', contactName:'Demo Customer', createdBy:u }
      ];
      addAudit('seed','system','',`Seeded demo user ${u} and business ${b}`);
      saveData();
    }

    // UI helpers: modal open/close
    function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; }
    function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }

    modalOverlay.addEventListener('click', () => {
      [userModal, businessModal, accountsModal].forEach(m => { if (m.style.display === 'block') closeModal(m); });
    });

    // init
    loadData();
    initUI();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    resetForms();
    renderAll();

    // --- Audit & Attachments ---
    function addAudit(actionType, entityType, entityId, details){
      const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: selectedUser, actionType, entityType, entityId, details };
      data.audit = data.audit || [];
      data.audit.push(entry);
      saveData();
    }

    function addAttachment({ bizId, txnId, fileObj, uploadedBy }){
      // fileObj: { filename, mime, dataUrl }
      const att = { id: uid('att'), bizId, txnId: txnId || null, filename: fileObj.filename, mime: fileObj.mime, dataUrl: fileObj.dataUrl, uploadedBy: uploadedBy || selectedUser, timestamp: new Date().toISOString() };
      data.attachments.push(att);
      saveData();
      addAudit('attachment.add', 'attachment', att.id, `File ${att.filename} uploaded for biz ${bizId} txn ${txnId || 'n/a'}`);
      return att;
    }

    function getAttachmentsForBiz(bizId){ return (data.attachments || []).filter(a => a.bizId === bizId); }
    function getAttachmentsForTxn(txnId){ return (data.attachments || []).filter(a => a.txnId === txnId); }

    // --- Initialization & UI wiring ---
    function initUI(){
      // user buttons
      btnAddUser.addEventListener('click', ()=>{ userModalTitle.textContent='Add User'; userName.value=''; userDisplay.value=''; userRole.value='User'; permView.checked=true; permEdit.checked=true; permDelete.checked=false; userSave.dataset.edit=''; openModal(userModal); });
      btnEditUser.addEventListener('click', ()=>{ if(!selectedUser) return alert('Select user'); const u = findUser(selectedUser); if(!canEdit()) return alert('Active user lacks permission to edit users'); userModalTitle.textContent='Edit User'; userName.value=u.username; userDisplay.value=u.display||''; userRole.value=u.role||'User'; permView.checked=!!u.permissions.view; permEdit.checked=!!u.permissions.edit; permDelete.checked=!!u.permissions.delete; userSave.dataset.edit=u.id; openModal(userModal); });
      btnDeleteUser.addEventListener('click', ()=>{ if(!selectedUser) return alert('Select user'); if(!canDelete()) return alert('Active user lacks permission to delete users'); if(!confirm('Delete user and their transactions & attachments?')) return; deleteUser(selectedUser); });

      userSave.addEventListener('click', ()=>{ const uname=(userName.value||'').trim(); if(!uname) return alert('Username required'); const id=userSave.dataset.edit; if(id){ const u=findUser(id); u.username = uname; u.display = userDisplay.value||uname; u.role = userRole.value; u.isAdmin = (u.role === 'Admin'); u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked }; addAudit('user.edit','user',u.id,`Edited user ${u.username}`); } else { const idd = uid('user'); const newu = { id: idd, username: uname, display: userDisplay.value||uname, role: userRole.value, isAdmin: userRole.value==='Admin', permissions:{ view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked } }; data.users.push(newu); data.transactions[idd] = {}; data.businesses.forEach(b=>{ data.transactions[idd][b.id] = []; }); addAudit('user.add','user',idd,`Created user ${uname}`); selectedUser = idd; } saveData(); closeModal(userModal); refreshSelectors(); ensureSelection(); renderAll(); });

      userCancel.addEventListener('click', ()=>closeModal(userModal));

      // business
      btnAddBusiness.addEventListener('click', ()=>{ businessModalTitle.textContent='Add Business'; bizName.value=''; bizOwnerSelect.value = data.users[0] ? data.users[0].id : ''; bizEntity.value='Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate; bizVatEnabled.checked = DEFAULTS.vatEnabled; bizPitEnabled.checked = DEFAULTS.pitEnabled; bizPayeEnabled.checked = DEFAULTS.payeEnabled; bizShowLines.checked = true; bizCitEnabled.checked = DEFAULTS.citEnabled; bizLossBF.value=''; bizCACF.value=''; bizCapitalBF.value=''; bizDefaultExpenseDisallowable.checked=false; bizDefaultRevenueNonTax.checked=false; bizDedPension.value=''; bizDedRent.value=''; bizDedLife.value=''; bizDedMortgage.value=''; bizDedNHF.value=''; bizFirsLabel.value = DEFAULTS.firsLabel; bizFirsUrl.value = DEFAULTS.firsUrl; bizContactsList.innerHTML=''; bizSave.dataset.edit=''; openModal(businessModal); });
      btnEditBusiness.addEventListener('click', ()=>{ if(!selectedBiz) return alert('Select business'); const b=findBiz(selectedBiz); businessModalTitle.textContent='Edit Business'; bizName.value=b.name||''; bizOwnerSelect.value=b.ownerId||''; bizEntity.value=b.entity||'Company'; bizVat.value=b.vatRate||DEFAULTS.vatRate; bizWht.value=b.whtRate||DEFAULTS.whtRate; bizCit.value=b.citRate||DEFAULTS.citRate; bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled; bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0; bizCapitalBF.value = b.capitalBroughtForward || 0; bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax; bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0; bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0; bizFirsLabel.value = b.firsLabel || DEFAULTS.firsLabel; bizFirsUrl.value = b.firsUrl || DEFAULTS.firsUrl; renderBizContacts(b); bizSave.dataset.edit=b.id; openModal(businessModal); });
      btnDeleteBusiness.addEventListener('click', ()=>{ if(!selectedBiz) return alert('Select business'); if(!canDelete()) return alert('Active user lacks permission to delete businesses'); if(!confirm('Delete business and all transactions & attachments?')) return; deleteBusiness(selectedBiz); });

      bizSave.addEventListener('click', ()=>{ const name=(bizName.value||'').trim(); if(!name) return alert('Business name required'); const owner = bizOwnerSelect.value; const edit = bizSave.dataset.edit; if(edit){ const b=findBiz(edit); b.name = name; b.ownerId = owner; b.entity = bizEntity.value; b.vatRate = Number(bizVat.value||0); b.whtRate = Number(bizWht.value||0); b.citRate = Number(bizCit.value||0); b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked; b.lossBroughtForward = Number(bizLossBF.value||0); b.caCarryForward = Number(bizCACF.value||0); b.capitalBroughtForward = Number(bizCapitalBF.value||0); b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked; b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) }; b.firsLabel = (bizFirsLabel.value||DEFAULTS.firsLabel); b.firsUrl = (bizFirsUrl.value||DEFAULTS.firsUrl); addAudit('business.edit','business',b.id,`Edited business ${b.name}`); } else { const id = uid('biz'); const obj = { id, name, ownerId: owner, entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate), vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked, accounts: [], inventory: [], assets: [], lossBroughtForward: Number(bizLossBF.value||0), caCarryForward: Number(bizCACF.value||0), capitalBroughtForward: Number(bizCapitalBF.value||0), defaultExpenseDisallowable: !!bizDefaultExpenseDisallowable.checked, defaultRevenueNonTax: !!bizDefaultRevenueNonTax.checked, statutoryDeductions: { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) }, contacts: [], firsLabel: (bizFirsLabel.value||DEFAULTS.firsLabel), firsUrl: (bizFirsUrl.value||DEFAULTS.firsUrl) }; data.businesses.push(obj); // create transaction arrays for all users
          data.users.forEach(u=>{ if(!data.transactions[u.id]) data.transactions[u.id] = {}; data.transactions[u.id][obj.id] = []; }); addAudit('business.add','business',obj.id,`Created business ${obj.name}`); selectedBiz = id; }
        saveData(); refreshSelectors(); closeModal(businessModal); renderAll(); });

      bizCancel.addEventListener('click', ()=>closeModal(businessModal));
      btnAddContact.addEventListener('click', ()=>{ if(!selectedBiz) return alert('Select business'); const b = findBiz(selectedBiz); const nm = (newContactName.value||'').trim(); if(!nm) return alert('Contact name required'); const ct = newContactType.value; const c = { id: uid('ct'), name: nm, type: ct }; b.contacts = b.contacts || []; b.contacts.push(c); saveData(); renderBizContacts(b); addAudit('contact.add','contact',c.id,`Added contact ${nm} (${ct}) to biz ${b.name}`); newContactName.value=''; });

      // accounts modal
      btnManageAccounts.addEventListener('click', ()=>{ if(!selectedBiz) return alert('Select business'); renderAccounts(); openModal(accountsModal); });
      addAccountBtn.addEventListener('click', ()=>{ const name=(newAccountName.value||'').trim(); if(!name) return alert('Account name required'); const cat=newAccountCategory.value; const b=findBiz(selectedBiz); const acct = { id: uid('acct'), name, category: cat, disallowableDefault:false, nonTaxableDefault:false }; b.accounts.push(acct); saveData(); populateAccountSelect(); renderAccounts(); addAudit('account.add','account',acct.id,`Added account ${name} to biz ${b.name}`); newAccountName.value=''; });
      closeAccountsBtn.addEventListener('click', ()=>closeModal(accountsModal));

      // transaction form behaviors
      txnAction.addEventListener('change', ()=>{ const val = txnAction.value; // show subforms alone
        if(val==='InventoryPurchase' || val==='InventorySale'){ mainTxnForm.style.display='none'; inventorySubform.style.display='block'; assetSubform.style.display='none'; populateAccountSelect(); } else if(val==='FixedAssetPurchase' || val==='FixedAssetDisposal'){ mainTxnForm.style.display='none'; inventorySubform.style.display='none'; assetSubform.style.display='block'; populateAccountSelect(); } else { mainTxnForm.style.display='flex'; inventorySubform.style.display='none'; assetSubform.style.display='none'; } });
      txnWht.addEventListener('change', ()=>{ txnWhtRateLabel.style.display = txnWht.checked ? 'inline-flex' : 'none'; });

      btnAddTxn.addEventListener('click', handleAddTransaction);

      // inventory subform
      btnAddInv.addEventListener('click', handleInventoryAction);
      btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
      btnInvUndo.addEventListener('click', handleUndoInventory);

      // asset subform
      btnAddAsset.addEventListener('click', handleAddAsset);
      btnDisposeAsset.addEventListener('click', handleDisposeAsset);
      btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
      btnAssetUndo.addEventListener('click', handleUndoAsset);

      // ledger search
      document.getElementById('btnSearch').addEventListener('click', renderLedger);
      document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

      // export/import
      document.getElementById('btnExport').addEventListener('click', ()=>{ const dataStr = JSON.stringify(data, null, 2); const blob = new Blob([dataStr], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ntc_data.json'; a.click(); URL.revokeObjectURL(url); });
      document.getElementById('btnImport').addEventListener('click', ()=>document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload = () => { try{ data = JSON.parse(r.result); migrateData(); saveData(); refreshSelectors(); ensureSelection(); populateAccountSelect(); resetForms(); renderAll(); alert('Import successful'); } catch(err){ alert('Invalid JSON import'); } }; r.readAsText(f); });
      document.getElementById('btnClearAll').addEventListener('click', ()=>{ if(!confirm('Clear all stored data?')) return; localStorage.removeItem(STORAGE_KEY); data={users:[],businesses:[],transactions:{},attachments:[],audit:[]}; seedDemo(); refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll(); });

      // header tabs
      btnLedgerTab.addEventListener('click', ()=>{ activeTab='ledger'; renderTab(); });
      btnReportsTab.addEventListener('click', ()=>{ activeTab='reports'; renderTab(); });

      // report tab buttons
      document.querySelectorAll('#reportsSection .tab').forEach(tb => {
        tb.addEventListener('click', (e) => {
          document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
          e.target.classList.add('active');
          renderReport(e.target.dataset.report);
        });
      });
    }

    function canEdit(){ // active user permission check
      const u = findUser(selectedUser);
      return !!(u && (u.permissions?.edit || u.isAdmin));
    }
    function canView(){ const u = findUser(selectedUser); return !!(u && (u.permissions?.view || u.isAdmin)); }
    function canDelete(){ const u = findUser(selectedUser); return !!(u && (u.permissions?.delete || u.isAdmin)); }

    function refreshSelectors(){
      userSelect.innerHTML=''; businessSelect.innerHTML=''; bizOwnerSelect.innerHTML='';
      data.users.forEach(u=>{ const opt=document.createElement('option'); opt.value=u.id; opt.textContent=u.display||u.username; userSelect.appendChild(opt); const o2=opt.cloneNode(true); bizOwnerSelect.appendChild(o2); });
      data.businesses.forEach(b=>{ const opt=document.createElement('option'); opt.value=b.id; const owner = data.users.find(u=>u.id===b.ownerId); opt.textContent = b.name + (owner ? ' — ' + (owner.display||owner.username) : ''); businessSelect.appendChild(opt); });
      userSelect.removeEventListener('change', onUserChange);
      businessSelect.removeEventListener('change', onBizChange);
      userSelect.addEventListener('change', onUserChange);
      businessSelect.addEventListener('change', onBizChange);
    }

    function onUserChange(e){ selectedUser = e.target.value; ensureSelection(); renderAll(); }
    function onBizChange(e){ selectedBiz = e.target.value; populateAccountSelect(); renderAll(); }

    function ensureSelection(){
      if(!selectedUser) selectedUser = data.users[0] ? data.users[0].id : null;
      if(!selectedBiz) selectedBiz = data.businesses[0] ? data.businesses[0].id : null;
      if(selectedUser) userSelect.value = selectedUser;
      if(selectedBiz) businessSelect.value = selectedBiz;
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }

    function populateAccountSelect(){
      txnAccount.innerHTML=''; invAccountSelect.innerHTML=''; assetPurchaseAccount.innerHTML=''; assetDisposalAccount.innerHTML=''; invItemSelect.innerHTML='';
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      (biz.accounts||[]).forEach(a=>{ const opt=document.createElement('option'); opt.value=a.id; opt.textContent = a.name + ' (' + a.category + ')'; txnAccount.appendChild(opt);
        const opt2 = opt.cloneNode(true); invAccountSelect.appendChild(opt2);
        const opt3 = opt.cloneNode(true); assetPurchaseAccount.appendChild(opt3);
        const opt4 = opt.cloneNode(true); assetDisposalAccount.appendChild(opt4);
      });
      // ensure there are basic default accounts if empty
      if((biz.accounts||[]).length===0){
        biz.accounts = [ {id:uid('acct'),name:'Sales',category:'Revenue',disallowableDefault:false,nonTaxableDefault:false}, {id:uid('acct'),name:'COGS',category:'Expense',disallowableDefault:false,nonTaxableDefault:false}, {id:uid('acct'),name:'Salaries',category:'Expense',disallowableDefault:false,nonTaxableDefault:false} ];
        saveData();
        populateAccountSelect();
      }
      // inventory items
      (biz.inventory||[]).forEach(it=>{ const opt=document.createElement('option'); opt.value=it.id; opt.textContent=it.name + ' — qty:' + it.qty + ' @ ' + fmt(it.avgCost); invItemSelect.appendChild(opt); });
      // add a placeholder for creating new
      const newOpt = document.createElement('option'); newOpt.value='__new__'; newOpt.textContent='-- Add new item --'; invItemSelect.appendChild(newOpt);
      invItemSelect.value = biz.inventory.length ? biz.inventory[0].id : '__new__';
      // default selects to txnAccount if present
      if (txnAccount.value) { invAccountSelect.value = txnAccount.value; assetPurchaseAccount.value = txnAccount.value; assetDisposalAccount.value = txnAccount.value; }
    }

    function resetForms(){
      txnDate.value = today();
      txnAction.value = '';
      txnDesc.value=''; txnAmount.value=''; txnWht.checked=false; txnWhtRate.value=''; txnWhtRateLabel.style.display='none'; txnSalary.checked=false; txnVatApply.checked=false; txnVatInclusive.checked=false;
      txnContactType.value=''; txnContactName.value=''; txnReceipt.value='';
      inventorySubform.style.display='none'; assetSubform.style.display='none';
      invNewName.value=''; invQty.value=''; invUnitPrice.value=''; invVat.checked=false; invVatInclusive.checked=false; invContactType.value=''; invContactName.value=''; invReceipt.value='';
      assetName.value=''; assetCost.value=''; assetPurchaseDate.value=''; assetLife.value=3; assetCA.value=20; assetDisposalDate.value=''; assetDisposalProceeds.value=''; assetContactType.value=''; assetContactName.value=''; assetReceipt.value='';
      mainTxnForm.style.display='flex';
    }

    // --- Data operations ---
    function deleteUser(uid){
      // remove user & related mappings
      data.users = data.users.filter(u=>u.id!==uid);
      delete data.transactions[uid];
      // remove attachments uploaded by user
      data.attachments = (data.attachments||[]).filter(a => a.uploadedBy !== uid);
      // remove audit entries by user (or keep them but mark removed) - we'll keep entries
      saveData();
      addAudit('user.delete','user',uid,`Deleted user ${uid}`);
      selectedUser = data.users[0] ? data.users[0].id : null;
      selectedBiz = data.businesses[0] ? data.businesses[0].id : null;
      refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll();
    }

    function deleteBusiness(bid){
      data.businesses = data.businesses.filter(b=>b.id!==bid);
      // remove transactions for all users
      for(const uid of Object.keys(data.transactions||{})){ if(data.transactions[uid]) delete data.transactions[uid][bid]; }
      // remove attachments for biz
      data.attachments = (data.attachments||[]).filter(a => a.bizId !== bid);
      saveData();
      addAudit('business.delete','business',bid,`Deleted business ${bid}`);
      selectedBiz = data.businesses[0] ? data.businesses[0].id : null;
      refreshSelectors(); ensureSelection(); populateAccountSelect(); renderAll();
    }

    // ledger rendering
    function renderLedger(){
      ledgerTable.innerHTML='';
      if(!selectedUser || !selectedBiz) return;
      if(!canView()) return ledgerTable.innerHTML = '<tr><td colspan="14">Active user lacks view permission.</td></tr>';
      const arr = (data.transactions[selectedUser] && data.transactions[selectedUser][selectedBiz]) || [];
      const q = (document.getElementById('ledgerSearch').value||'').toLowerCase();
      arr.filter(tx => {
        if(!q) return true;
        return (tx.date||'').includes(q) || (tx.accountName||'').toLowerCase().includes(q) || (tx.description||'').toLowerCase().includes(q) || String(tx.amount||'').includes(q) || ((tx.contactName||'').toLowerCase().includes(q));
      }).forEach(tx=>{
        const tr = document.createElement('tr');
        const tdDate=document.createElement('td'); tdDate.textContent=tx.date||'';
        const tdAction=document.createElement('td'); tdAction.textContent=tx.action||tx.type||'';
        const tdAcc=document.createElement('td'); tdAcc.textContent = tx.accountName || '';
        const tdDesc=document.createElement('td'); tdDesc.textContent = tx.description || '';
        const tdAmt=document.createElement('td'); tdAmt.textContent = fmt(tx.netAmount ?? tx.amount || 0);
        const tdVat=document.createElement('td'); tdVat.textContent = fmt(tx.vatAmount||0);
        const tdWht=document.createElement('td'); tdWht.textContent = (tx.whtApplied?fmt(tx.whtAmount||0)+' @'+(tx.whtRate||findBiz(selectedBiz).whtRate)+'%':'-');
        const tdPaye=document.createElement('td'); tdPaye.textContent = (tx.isSalary ? fmt(tx.payeAmount||0) : '-');
        const tdContact=document.createElement('td'); tdContact.textContent = (tx.contactType? tx.contactType + ': ' + (tx.contactName||'') : '-');
        const tdReceipt=document.createElement('td');
        const atts = getAttachmentsForTxn(tx.id);
        if(atts.length){
          atts.forEach(a=>{
            const ael = document.createElement('span');
            ael.className='link-like';
            ael.textContent = a.filename;
            ael.style.display='block';
            ael.addEventListener('click', ()=>{ openAttachment(a.id); });
            tdReceipt.appendChild(ael);
          });
        } else {
          const attachBtn = document.createElement('button');
          attachBtn.className='small';
          attachBtn.textContent='Attach';
          attachBtn.addEventListener('click', ()=>{ promptAttachToTxn(tx.id); });
          tdReceipt.appendChild(attachBtn);
        }
        const tdInv=document.createElement('td'); tdInv.textContent = (tx.invItemName? (tx.invItemName + ' x' + (tx.qty||0)) : (tx.assetName ? tx.assetName : ''));
        const tdDis=document.createElement('td'); tdDis.textContent = tx.disallowable ? 'Yes' : '-';
        const tdNon=document.createElement('td'); tdNon.textContent = tx.nonTaxable ? 'Yes' : '-';
        const tdAct=document.createElement('td');
        const editBtn=document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=>editTransaction(tx.id));
        const delBtn=document.createElement('button'); delBtn.className='small danger'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=>{ if(!confirm('Delete transaction?')) return; if(!canDelete()) return alert('Active user lacks permission to delete transactions'); deleteTransaction(tx.id); });
        tdAct.appendChild(editBtn); tdAct.appendChild(delBtn);

        tr.appendChild(tdDate); tr.appendChild(tdAction); tr.appendChild(tdAcc); tr.appendChild(tdDesc); tr.appendChild(tdAmt); tr.appendChild(tdVat); tr.appendChild(tdWht); tr.appendChild(tdPaye); tr.appendChild(tdContact); tr.appendChild(tdReceipt); tr.appendChild(tdInv); tr.appendChild(tdDis); tr.appendChild(tdNon); tr.appendChild(tdAct);
        ledgerTable.appendChild(tr);
      });
      renderTotalsAndTaxSummary();
    }

    function promptAttachToTxn(txnId){
      const fileInput = document.createElement('input');
      fileInput.type='file';
      fileInput.accept='image/*,application/pdf';
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = () => {
          addAttachment({ bizId: selectedBiz, txnId, fileObj:{ filename: f.name, mime: f.type, dataUrl: r.result }, uploadedBy: selectedUser });
          renderLedger();
        };
        r.readAsDataURL(f);
      });
      fileInput.click();
    }

    function openAttachment(attId){
      const a = data.attachments.find(x=>x.id===attId);
      if(!a) return alert('Attachment not found');
      // open in new tab as data URL
      const w = window.open();
      w.document.write(`<title>${a.filename}</title>`);
      if(a.mime && a.mime.startsWith('image/')){
        w.document.write(`<img src="${a.dataUrl}" style="max-width:100%;height:auto;" />`);
      } else if(a.mime === 'application/pdf'){
        w.document.write(`<iframe src="${a.dataUrl}" style="width:100%;height:100vh;border:none;"></iframe>`);
      } else {
        // show link
        w.document.write(`<a href="${a.dataUrl}" download="${a.filename}">Download ${a.filename}</a>`);
      }
      addAudit('attachment.view','attachment',a.id,`Viewed attachment ${a.filename}`);
    }

    function editTransaction(txId){
      // Minimal edit UI: allow toggling disallowable / non-tax / description via prompt for brevity
      if(!canEdit()) return alert('Active user lacks edit permission');
      const arr = data.transactions[selectedUser][selectedBiz];
      const tx = arr.find(t=>t.id===txId);
      if(!tx) return alert('Transaction not found');
      const newDesc = prompt('Edit description', tx.description||'');
      if(newDesc===null) return;
      tx.description = newDesc;
      const dis = confirm('Mark as disallowable expense? (OK = Yes, Cancel = No)');
      tx.disallowable = dis;
      const non = confirm('Mark as non-taxable income? (OK = Yes, Cancel = No)');
      tx.nonTaxable = non;
      saveData(); addAudit('transaction.edit','transaction',tx.id,`Edited transaction ${tx.id}`); renderAll();
    }

    function deleteTransaction(txId){
      data.transactions[selectedUser][selectedBiz] = data.transactions[selectedUser][selectedBiz].filter(t=>t.id!==txId);
      // remove attachments linked to txn
      data.attachments = (data.attachments||[]).map(a => { if(a.txnId === txId) a.txnId = null; return a; });
      saveData(); addAudit('transaction.delete','transaction',txId,`Deleted transaction ${txId}`); renderAll();
    }

    // helper: compute monthly PAYE based on annual bands and statutory deductions; dateStr used to pick band set
    function computeMonthlyPAYE(grossMonthly, biz, dateStr){
      const deductionsAnnual = (biz && biz.statutoryDeductions) ? (Number(biz.statutoryDeductions.pension||0) + Number(biz.statutoryDeductions.rent||0) + Number(biz.statutoryDeductions.life||0) + Number(biz.statutoryDeductions.mortgage||0) + Number(biz.statutoryDeductions.nhf||0)) : 0;
      // monthly taxable salary = grossMonthly - deductionsAnnual/12
      let monthlyTaxable = Number(grossMonthly||0) - (deductionsAnnual/12);
      if(monthlyTaxable < 0) monthlyTaxable = 0;
      const annualTaxable = monthlyTaxable * 12;
      // compute progressive tax on annualTaxable using PAYE_BANDS
      let remaining = annualTaxable;
      let lower = 0;
      let totalTax = 0;
      for (let i=0;i<PAYE_BANDS.length;i++){
        const band = PAYE_BANDS[i];
        const upper = band.upTo;
        const bandLimit = (upper === Infinity) ? Infinity : (upper - lower);
        if (remaining <= 0) break;
        const taxed = Math.min(bandLimit, remaining);
        totalTax += taxed * band.rate;
        remaining -= taxed;
        lower = upper;
      }
      return totalTax / 12;
    }

    // Add general non-inventory transactions
    async function handleAddTransaction(){
      if(!selectedUser || !selectedBiz) return alert('Select user and business');
      if(!canEdit()) return alert('Active user lacks edit permission');
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      const action = txnAction.value;
      const amountRaw = Number(txnAmount.value||0);
      const accountId = txnAccount.value;
      const account = biz.accounts.find(a=>a.id===accountId) || { name:'Unknown', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const dateVal = txnDate.value || today();
      const desc = txnDesc.value || '';
      const whtApplied = !!txnWht.checked;
      const whtRateVal = (txnWhtRate.value) ? Number(txnWhtRate.value) : undefined;
      const isSalary = !!txnSalary.checked;
      const vatApplies = !!txnVatApply.checked;
      const vatInclusive = !!txnVatInclusive.checked;
      const contactType = txnContactType.value || '';
      const contactNameVal = txnContactName.value || '';

      if(!action) return alert('Select an action.');

      // VAT: compute net and vat based on inclusive/exclusive
      let vatAmount = 0;
      let netAmount = amountRaw;
      if(vatApplies && biz.vatEnabled && (action === 'Revenue' || action === 'InventorySale' || action === 'InventoryPurchase')){
        const rate = Number(biz.vatRate||0)/100;
        if(vatInclusive){
          netAmount = amountRaw / (1 + rate);
          vatAmount = amountRaw - netAmount;
        } else {
          vatAmount = amountRaw * rate;
          netAmount = amountRaw;
        }
      }

      // WHT: record whtAmount as receivable (credit for tax), but do NOT reduce taxable income
      let usedWht = (typeof whtRateVal !== 'undefined') ? whtRateVal : Number(biz.whtRate||0);
      let whtAmount = 0;
      // If user checked WHT and provided amount, compute whtAmount as: if amount given is net after WHT? We'll treat entered amount as net (i.e. amount received), and WHT is computed as percentage of gross => We will compute WHT on gross base assumption consistent with earlier logic: gross = net / (1 - wht%)
      if(whtApplied && usedWht > 0 && usedWht < 100){
        const grossBase = netAmount / (1 - (usedWht/100));
        whtAmount = grossBase * (usedWht/100);
      }

      // PAYE: compute monthly based on PIT bands if marked salary
      let payeAmount = 0;
      if(isSalary && biz.payeEnabled){
        payeAmount = computeMonthlyPAYE(netAmount, biz, dateVal);
      }

      // determine disallowable / nonTaxable flags using account-level defaults else business-level defaults
      const disallowableFlag = !!(account.disallowableDefault) || (!!biz.defaultExpenseDisallowable && account.category === 'Expense') || false;
      const nonTaxFlag = !!(account.nonTaxableDefault) || (!!biz.defaultRevenueNonTax && account.category === 'Revenue') || false;

      const txn = {
        id: uid('txn'),
        date: dateVal,
        action,
        accountId,
        accountName: account.name,
        description: desc,
        amount: amountRaw,
        netAmount,
        vatAmount,
        vatInclusive,
        whtApplied,
        whtRate: usedWht,
        whtAmount,
        isSalary,
        payeAmount,
        userId: selectedUser,
        contactType,
        contactName: contactNameVal,
        disallowable: disallowableFlag,
        nonTaxable: nonTaxFlag,
        createdAt: new Date().toISOString(),
        createdBy: selectedUser
      };

      // handle receipt file if present
      const file = txnReceipt.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = () => {
          addAttachment({ bizId: selectedBiz, txnId: txn.id, fileObj: { filename: file.name, mime: file.type, dataUrl: reader.result }, uploadedBy: selectedUser });
          pushTransaction(txn);
        };
        reader.readAsDataURL(file);
      } else {
        pushTransaction(txn);
      }
    }

    function pushTransaction(txn){
      data.transactions[selectedUser] = data.transactions[selectedUser] || {};
      data.transactions[selectedUser][selectedBiz] = data.transactions[selectedUser][selectedBiz] || [];
      data.transactions[selectedUser][selectedBiz].push(txn);
      saveData();
      addAudit('transaction.add','transaction',txn.id,`Added transaction ${txn.action} ${txn.id}`);
      resetForms(); renderAll();
      alert('Transaction recorded');
    }

    // Inventory handling (average cost)
    function handleInventoryAction(){
      if(!selectedUser || !selectedBiz) return alert('Select user/business');
      if(!canEdit()) return alert('Active user lacks edit permission');
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      const action = txnAction.value;
      if(!(action==='InventoryPurchase' || action==='InventorySale')) return alert('Choose an inventory action in Action selector');
      // determine item
      let itemId = invItemSelect.value;
      const newName = (invNewName.value||'').trim();
      let item = null;
      if(itemId === '__new__' && newName){
        item = { id: uid('item'), name: newName, qty:0, avgCost:0 };
        biz.inventory.push(item);
        addAudit('inventory.item.add','inventoryItem',item.id,`Added inventory item ${newName}`);
      } else {
        item = biz.inventory.find(it=>it.id===itemId);
        if(!item) return alert('Select or add an inventory item');
      }

      const qty = Number(invQty.value||0);
      if(qty <= 0) return alert('Quantity must be > 0');
      const unitPrice = Number(invUnitPrice.value||0);
      const vatApplies = !!invVat.checked;
      const vatInclusive = !!invVatInclusive.checked;
      const dateVal = txnDate.value || today();
      const accountId = invAccountSelect.value || txnAccount.value;
      const account = biz.accounts.find(a=>a.id===accountId) || { name:'Inventory Purchases', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      // flags via account/business defaults
      const disallowableFlag = !!account.disallowableDefault || (!!biz.defaultExpenseDisallowable && account.category === 'Expense');
      const nonTaxFlag = !!account.nonTaxableDefault || (!!biz.defaultRevenueNonTax && account.category === 'Revenue');

      const contactType = invContactType.value || '';
      const contactNameVal = invContactName.value || '';

      // handle receipt file
      const file = invReceipt.files[0];

      if(action === 'InventoryPurchase'){
        // update weighted average
        const prevQty = Number(item.qty || 0);
        const prevAvg = Number(item.avgCost || 0);
        const purchaseTotal = qty * unitPrice;
        const newTotalCost = prevQty*prevAvg + purchaseTotal;
        const newQty = prevQty + qty;
        const newAvg = newQty ? (newTotalCost / newQty) : 0;
        item.qty = newQty;
        item.avgCost = newAvg;

        // VAT amount computed per unit price behavior
        let vatAmount = 0;
        if(vatApplies && biz.vatEnabled){
          const rate = Number(biz.vatRate||0)/100;
          if(vatInclusive){
            const net = purchaseTotal / (1 + rate);
            vatAmount = purchaseTotal - net;
          } else {
            vatAmount = purchaseTotal * rate;
          }
        }

        const txn = {
          id: uid('txn'),
          date: dateVal,
          action: 'InventoryPurchase',
          accountId: accountId,
          accountName: account.name || 'Inventory Purchases',
          description: `Purchase ${item.name}`,
          amount: qty*unitPrice,
          netAmount: qty*unitPrice,
          vatAmount,
          vatInclusive,
          whtApplied:false,
          whtAmount:0,
          invItemId: item.id,
          invItemName: item.name,
          qty,
          unitPrice,
          unitCost: unitPrice,
          userId: selectedUser,
          contactType,
          contactName: contactNameVal,
          disallowable: disallowableFlag,
          nonTaxable: nonTaxFlag,
          createdAt: new Date().toISOString(),
          createdBy: selectedUser
        };

        // if file attached, handle it then push
        if(file){
          const reader = new FileReader();
          reader.onload = () => {
            addAttachment({ bizId: selectedBiz, txnId: txn.id, fileObj: { filename: file.name, mime: file.type, dataUrl: reader.result }, uploadedBy: selectedUser });
            pushInventoryTxn(txn);
          };
          reader.readAsDataURL(file);
        } else {
          pushInventoryTxn(txn);
        }
        txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex';
        return;
      }

      if(action === 'InventorySale'){
        if(item.qty < qty) return alert('Insufficient stock to sell');
        const unitCost = Number(item.avgCost || 0);
        const saleTotal = qty * unitPrice;
        const cogs = qty * unitCost;
        item.qty -= qty;
        // VAT on sale if enabled
        let vatAmount = 0;
        if(biz.vatEnabled && vatApplies){
          const rate = Number(biz.vatRate||0)/100;
          if(vatInclusive){
            const net = saleTotal / (1 + rate);
            vatAmount = saleTotal - net;
          } else {
            vatAmount = saleTotal * rate;
          }
        }

        const txn = {
          id: uid('txn'),
          date: dateVal,
          action: 'InventorySale',
          accountId: accountId,
          accountName: account.name || 'Sales',
          description: `Sale ${item.name}`,
          amount: saleTotal,
          netAmount: vatInclusive ? (saleTotal / (1 + Number(biz.vatRate||0)/100)) : saleTotal,
          vatAmount,
          vatInclusive,
          whtApplied:false,
          whtAmount:0,
          invItemId: item.id,
          invItemName: item.name,
          qty,
          unitPrice,
          unitCost,
          cogs,
          userId: selectedUser,
          contactType,
          contactName: contactNameVal,
          disallowable: nonTaxFlag ? false : false,
          nonTaxable: nonTaxFlag,
          createdAt: new Date().toISOString(),
          createdBy: selectedUser
        };

        if(file){
          const reader = new FileReader();
          reader.onload = () => {
            addAttachment({ bizId: selectedBiz, txnId: txn.id, fileObj: { filename: file.name, mime: file.type, dataUrl: reader.result }, uploadedBy: selectedUser });
            pushInventoryTxn(txn);
          };
          reader.readAsDataURL(file);
        } else {
          pushInventoryTxn(txn);
        }

        saveData(); resetForms(); populateAccountSelect(); renderAll(); alert(`Sale recorded (COGS: ₦${fmt(cogs)})`);
        txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex';
        return;
      }
    }

    function pushInventoryTxn(txn){
      data.transactions[selectedUser] = data.transactions[selectedUser] || {};
      data.transactions[selectedUser][selectedBiz] = data.transactions[selectedUser][selectedBiz] || [];
      data.transactions[selectedUser][selectedBiz].push(txn);
      saveData();
      addAudit('transaction.add','transaction',txn.id,`Added inventory transaction ${txn.id}`);
      renderAll();
      alert('Inventory transaction recorded');
    }

    // Undo inventory action (single-level)
    function handleUndoInventory(){
      if(!selectedUser || !selectedBiz) return alert('Select user/business');
      if(!canEdit()) return alert('Active user lacks edit permission');
      const arr = data.transactions[selectedUser][selectedBiz] || [];
      // find last inventory txn (search from end)
      for(let i = arr.length-1; i>=0; i--){
        const tx = arr[i];
        if(tx.action === 'InventoryPurchase' || tx.action === 'InventorySale'){
          // revert inventory state
          const biz = findBiz(selectedBiz);
          const item = biz.inventory.find(it=>it.id === tx.invItemId);
          if(!item) {
            // if not found, just remove transaction
            arr.splice(i,1);
            saveData(); renderAll(); alert('Last inventory transaction removed');
            addAudit('transaction.delete','transaction',tx.id,`Removed inventory txn ${tx.id} (item missing)`);
            return;
          }
          if(tx.action === 'InventoryPurchase'){
            // Undo purchase: newQty = prevQty + qty. We have current item.qty = newQty.
            const purchasedQty = Number(tx.qty||0);
            const newQty = Number(item.qty || 0);
            const newAvg = Number(item.avgCost || 0);
            const prevQty = newQty - purchasedQty;
            let prevAvg = 0;
            if(prevQty > 0){
              // prevAvg = (newAvg*newQty - purchasedQty*unitPrice) / prevQty
              const numerator = (newAvg * newQty) - (purchasedQty * Number(tx.unitPrice||0));
              prevAvg = prevQty ? (numerator / prevQty) : 0;
            } else {
              prevAvg = 0;
            }
            item.qty = prevQty;
            item.avgCost = prevAvg;
            // remove txn
            arr.splice(i,1);
            saveData(); renderAll(); alert('Undo inventory purchase applied');
            addAudit('inventory.undo','inventory',tx.invItemId,`Undo purchase txn ${tx.id}`);
            return;
          } else if(tx.action === 'InventorySale'){
            // Undo sale: increase qty back
            const soldQty = Number(tx.qty||0);
            item.qty = Number(item.qty||0) + soldQty;
            // avgCost unchanged
            arr.splice(i,1);
            saveData(); renderAll(); alert('Undo inventory sale applied');
            addAudit('inventory.undo','inventory',tx.invItemId,`Undo sale txn ${tx.id}`);
            return;
          }
        }
      }
      alert('No recent inventory purchase/sale to undo');
    }

    // Assets handling
    function handleAddAsset(){
      if(!selectedUser || !selectedBiz) return alert('Select user/business');
      if(!canEdit()) return alert('Active user lacks edit permission');
      const biz = findBiz(selectedBiz);
      const name = (assetName.value||'').trim();
      const cost = Number(assetCost.value||0);
      const pDate = assetPurchaseDate.value || today();
      const life = Number(assetLife.value||0);
      const caPerc = Number(assetCA.value||0);
      const accountId = assetPurchaseAccount.value || txnAccount.value;
      const account = biz.accounts.find(a=>a.id===accountId) || { name:'Fixed Assets', category: 'Asset' };
      if(!name || cost <= 0 || life <= 0) return alert('Asset name, cost, and useful life required');
      const asset = { id:uid('asset'), name, cost, purchaseDate:pDate, lifeYears:life, capitalAllowancePercent:caPerc, disposed:false, disposalDate:null, disposalProceeds:0, createdBy:selectedUser };
      biz.assets = biz.assets || [];
      biz.assets.push(asset);
      // record transaction (include assetId reference)
      const txn = { id:uid('txn'), date:pDate, action:'FixedAssetPurchase', accountId: accountId, accountName: account.name || 'Fixed Assets', description:`Asset purchase ${name}`, amount: cost, netAmount: cost, vatAmount:0, whtApplied:false, whtAmount:0, assetId: asset.id, assetName: name, userId: selectedUser, createdAt:new Date().toISOString(), createdBy:selectedUser };
      const file = assetReceipt.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = () => {
          addAttachment({ bizId: selectedBiz, txnId: txn.id, fileObj: { filename: file.name, mime: file.type, dataUrl: reader.result }, uploadedBy: selectedUser });
          pushAssetTxn(asset, txn);
        };
        reader.readAsDataURL(file);
      } else {
        pushAssetTxn(asset, txn);
      }
    }

    function pushAssetTxn(asset, txn){
      data.transactions[selectedUser][selectedBiz].push(txn);
      saveData();
      addAudit('asset.add','asset',asset.id,`Added asset ${asset.name}`);
      resetForms(); renderAll(); alert('Asset recorded');
      txnAction.value=''; assetSubform.style.display='none'; mainTxnForm.style.display='flex';
    }

    function handleDisposeAsset(){
      if(!selectedUser || !selectedBiz) return alert('Select user/business');
      if(!canEdit()) return alert('Active user lacks edit permission');
      const biz = findBiz(selectedBiz);
      const name = (assetName.value||'').trim();
      const proceeds = Number(assetDisposalProceeds.value||0);
      const dDate = assetDisposalDate.value;
      const accountId = assetDisposalAccount.value || txnAccount.value;
      const asset = biz.assets.find(a => a.name === name || a.id === assetName.value) || biz.assets[0];
      if(!asset) return alert('Asset not found (enter existing asset name)');
      asset.disposed = true;
      asset.disposalDate = dDate || today();
      asset.disposalProceeds = proceeds;
      // record disposal txn
      const txn = { id:uid('txn'), date: asset.disposalDate, action:'FixedAssetDisposal', accountId: accountId, accountName: findBiz(selectedBiz).accounts.find(x=>x.id===accountId)?.name||'Asset Disposal', description:`Disposal ${asset.name}`, amount: proceeds, netAmount: proceeds, vatAmount:0, whtApplied:false, whtAmount:0, assetId:asset.id, assetName:asset.name, createdBy:selectedUser, createdAt:new Date().toISOString() };
      const file = assetReceipt.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = () => {
          addAttachment({ bizId: selectedBiz, txnId: txn.id, fileObj: { filename: file.name, mime: file.type, dataUrl: reader.result }, uploadedBy: selectedUser });
          pushDisposeTxn(txn);
        };
        reader.readAsDataURL(file);
      } else {
        pushDisposeTxn(txn);
      }
    }

    function pushDisposeTxn(txn){
      data.transactions[selectedUser][selectedBiz].push(txn);
      saveData();
      addAudit('asset.dispose','asset',txn.assetId,`Disposed asset ${txn.assetName}`);
      resetForms(); renderAll(); alert('Disposal recorded');
    }

    function handleUndoAsset(){
      if(!selectedUser || !selectedBiz) return alert('Select user/business');
      if(!canEdit()) return alert('Active user lacks edit permission');
      const arr = data.transactions[selectedUser][selectedBiz] || [];
      for(let i = arr.length-1; i>=0; i--){
        const tx = arr[i];
        if(tx.action === 'FixedAssetPurchase'){
          // remove asset entry
          const biz = findBiz(selectedBiz);
          biz.assets = (biz.assets||[]).filter(a=>a.id !== tx.assetId);
          arr.splice(i,1);
          saveData(); addAudit('asset.undo','asset',tx.assetId,`Undo asset purchase ${tx.assetId}`); renderAll(); alert('Undid last asset purchase'); return;
        }
        if(tx.action === 'FixedAssetDisposal'){
          const biz = findBiz(selectedBiz);
          const as = biz.assets.find(a=>a.id === tx.assetId);
          if(as){ as.disposed = false; as.disposalDate = null; as.disposalProceeds = 0; }
          arr.splice(i,1);
          saveData(); addAudit('asset.undo','asset',tx.assetId,`Undo asset disposal ${tx.assetId}`); renderAll(); alert('Undid last asset disposal'); return;
        }
      }
      alert('No recent asset actions to undo');
    }

    // --- Reports & tax reconciliation ---
    function renderTab(){
      if(activeTab === 'ledger'){
        ledgerSection.style.display='block';
        ledgerListSection.style.display='block';
        reportsSection.style.display='none';
        btnLedgerTab.classList.add('active');
        btnReportsTab.classList.remove('active');
      } else {
        ledgerSection.style.display='none';
        ledgerListSection.style.display='none';
        reportsSection.style.display='block';
        btnLedgerTab.classList.remove('active');
        btnReportsTab.classList.add('active');
        // default report
        document.querySelectorAll('#reportsSection .tab').forEach(t => { t.classList.remove('active'); if(t.dataset.report==='taxReconciliation'){ t.classList.add('active'); }});
        renderReport('taxReconciliation');
      }
    }

    function renderReport(name){
      reportContent.innerHTML = '';
      if(!selectedBiz) return reportContent.textContent = 'Select a business to view reports.';
      if(!canView()) return reportContent.textContent = 'Active user lacks view permission for reports.';
      const biz = findBiz(selectedBiz);
      if(!biz) return reportContent.textContent = 'Business not found.';
      if(name === 'taxReconciliation'){
        const div = document.createElement('div');
        const recon = computeTaxReconciliation(biz);
        // If taxableProfit negative, move to loss carryforward automatically
        if(recon.taxableProfit < 0){
          const loss = Math.abs(recon.taxableProfit);
          biz.lossBroughtForward = Number(biz.lossBroughtForward || 0) + loss;
          recon.lossCarried = loss;
          recon.taxableProfit = 0;
          saveData();
          addAudit('loss.carry','business',biz.id,`Carried loss ₦${fmt(loss)} to lossBroughtForward`);
        }
        div.innerHTML = `<h3>Taxable Income Reconciliation — ${biz.name}</h3>
          <div class="form-section">
            <div>Taxable profit: ₦${fmt(recon.taxableProfit)}</div>
            <div>Tax before credits (CIT/PIT): ₦${fmt(recon.taxBeforeCredits)}</div>
            <div>WHT receivable credit: ₦${fmt(recon.whtReceivable)}</div>
            <div>CA carryforward: ₦${fmt(biz.caCarryForward||0)}</div>
            <div>Loss brought forward: ₦${fmt(biz.lossBroughtForward||0)}</div>
            <div style="margin-top:8px;"><strong>Tax payable after credits: ₦${fmt(recon.taxPayable)}</strong></div>
          </div>
          <small class="muted">Note: WHT receivable is treated as a tax credit against CIT/PIT and does not reduce taxable income.</small>
        `;
        reportContent.appendChild(div);
      } else if(name === 'vatReport'){
        const div = document.createElement('div');
        const vatTxns = gatherVAT(selectedBiz);
        div.innerHTML = `<h3>VAT Report — ${biz.name}</h3><div>Total VAT collected: ₦${fmt(vatTxns.totalCollected)}</div><div>Total VAT paid (input): ₦${fmt(vatTxns.totalPaid)}</div><div>Net VAT: ₦${fmt(vatTxns.net)}</div>`;
        reportContent.appendChild(div);
      } else if(name === 'whtPayable'){
        const div = document.createElement('div');
        const wht = gatherWHT(selectedBiz);
        div.innerHTML = `<h3>WHT Payable Report — ${biz.name}</h3><div>Total WHT withheld (payable): ₦${fmt(wht.payable)}</div>`;
        reportContent.appendChild(div);
      } else if(name === 'whtReceivable'){
        const div = document.createElement('div');
        const wht = gatherWHT(selectedBiz);
        div.innerHTML = `<h3>WHT Receivable Report — ${biz.name}</h3><div>Total WHT receivable (credit): ₦${fmt(wht.receivable)}</div><div>Detailed:</div>`;
        const lst = document.createElement('div');
        (wht.details || []).forEach(d => { const el = document.createElement('div'); el.textContent = `${d.date} — ${d.accountName || ''} — ₦${fmt(d.whtAmount)} — txn ${d.txnId}`; lst.appendChild(el); });
        div.appendChild(lst);
        reportContent.appendChild(div);
      } else if(name === 'profitSnapshot'){
        const div = document.createElement('div');
        const snap = computePLSnapshot(biz);
        div.innerHTML = `<h3>Profit & Loss Snapshot — ${biz.name}</h3>
          <div>Revenue: ₦${fmt(snap.revenue)}</div>
          <div>COGS: ₦${fmt(snap.cogs)}</div>
          <div>Gross profit: ₦${fmt(snap.gross)}</div>
          <div>Expenses: ₦${fmt(snap.expenses)}</div>
          <div>Operating profit: ₦${fmt(snap.operating)}</div>
        `;
        reportContent.appendChild(div);
      } else if(name === 'inventoryReport'){
        const div = document.createElement('div');
        div.innerHTML = `<h3>Inventory Report — ${biz.name}</h3>`;
        const tbl = document.createElement('table'); tbl.className='ledger-table';
        tbl.innerHTML = `<thead><tr><th>Item</th><th>Qty</th><th>Avg cost</th><th>Total value</th></tr></thead>`;
        const tb = document.createElement('tbody');
        (biz.inventory||[]).forEach(it => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${it.name}</td><td>${fmt(it.qty)}</td><td>${fmt(it.avgCost)}</td><td>${fmt((it.qty||0) * (it.avgCost||0))}</td>`;
          tb.appendChild(tr);
        });
        tbl.appendChild(tb);
        div.appendChild(tbl);
        reportContent.appendChild(div);
      } else if(name === 'assetsReport'){
        const div = document.createElement('div');
        div.innerHTML = `<h3>Fixed Assets Report — ${biz.name}</h3>`;
        const tbl = document.createElement('table'); tbl.className='ledger-table';
        tbl.innerHTML = `<thead><tr><th>Asset</th><th>Cost</th><th>Purchase date</th><th>Life (yrs)</th><th>CA%</th><th>Disposed</th></tr></thead>`;
        const tb = document.createElement('tbody');
        (biz.assets||[]).forEach(a => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${a.name}</td><td>${fmt(a.cost)}</td><td>${a.purchaseDate||''}</td><td>${a.lifeYears||''}</td><td>${a.capitalAllowancePercent||''}%</td><td>${a.disposed?('Yes - '+(a.disposalDate||'')):'No'}</td>`;
          tb.appendChild(tr);
        });
        tbl.appendChild(tb);
        div.appendChild(tbl);
        reportContent.appendChild(div);
      } else if(name === 'auditTrail'){
        const div = document.createElement('div');
        div.innerHTML = `<h3>Audit Trail — ${biz.name}</h3>`;
        const tbl = document.createElement('table'); tbl.className='ledger-table';
        tbl.innerHTML = `<thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Entity</th><th>Details</th></tr></thead>`;
        const tb=document.createElement('tbody');
        (data.audit||[]).slice().reverse().forEach(a => {
          const owner = findUser(a.userId);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${a.timestamp}</td><td>${owner?owner.display||owner.username:'system'}</td><td>${a.actionType}</td><td>${a.entityType} (${a.entityId})</td><td>${a.details}</td>`;
          tb.appendChild(tr);
        });
        tbl.appendChild(tb);
        div.appendChild(tbl);
        reportContent.appendChild(div);
      } else if(name === 'receiptsFolder'){
        const div = document.createElement('div');
        div.innerHTML = `<h3>Receipts Folder — ${biz.name}</h3>`;
        const atts = getAttachmentsForBiz(biz.id);
        if(!atts.length) { div.innerHTML += '<div>No receipts uploaded for this business.</div>'; reportContent.appendChild(div); return; }
        atts.forEach(a => {
          const row = document.createElement('div');
          row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.marginBottom='6px';
          const thumb = document.createElement('div');
          if(a.mime && a.mime.startsWith('image/')) thumb.innerHTML = `<img src="${a.dataUrl}" class="receipt-thumb" />`;
          else thumb.innerHTML = `<div class="receipt-thumb" style="display:flex;align-items:center;justify-content:center;">${a.filename.split('.').pop().toUpperCase()}</div>`;
          const meta = document.createElement('div');
          meta.innerHTML = `<div><strong>${a.filename}</strong> (${a.mime})</div><div>Uploaded: ${a.timestamp}</div><div>Txn: ${a.txnId || 'n/a'}</div>`;
          const actions = document.createElement('div');
          const viewBtn = document.createElement('button'); viewBtn.className='small'; viewBtn.textContent='View'; viewBtn.addEventListener('click', ()=>openAttachment(a.id));
          const dlBtn = document.createElement('button'); dlBtn.className='small'; dlBtn.textContent='Download'; dlBtn.addEventListener('click', ()=>downloadAttachment(a.id));
          const delBtn = document.createElement('button'); delBtn.className='small danger'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=>{ if(!confirm('Delete attachment?')) return; data.attachments = data.attachments.filter(x=>x.id!==a.id); saveData(); addAudit('attachment.delete','attachment',a.id,`Deleted attachment ${a.filename}`); renderReport('receiptsFolder'); });
          actions.appendChild(viewBtn); actions.appendChild(dlBtn); actions.appendChild(delBtn);
          row.appendChild(thumb); row.appendChild(meta); row.appendChild(actions);
          div.appendChild(row);
        });
        reportContent.appendChild(div);
      }
    }

    function downloadAttachment(attId){
      const a = data.attachments.find(x=>x.id===attId);
      if(!a) return alert('Attachment not found');
      const link = document.createElement('a');
      link.href = a.dataUrl;
      link.download = a.filename;
      link.click();
    }

    function computePLSnapshot(biz){
      const txnsAll = gatherAllTxnsForBiz(biz.id);
      let revenue=0,cogs=0,expenses=0;
      txnsAll.forEach(tx => {
        if(tx.action === 'InventorySale' || (tx.accountName && tx.accountName.toLowerCase().includes('sales')) ) revenue += Number(tx.netAmount || tx.amount || 0);
        if(tx.cogs) cogs += Number(tx.cogs||0);
        if(tx.accountName && tx.accountName.toLowerCase().includes('cogs')) cogs += Number(tx.amount||0);
        if(tx.accountName && tx.accountName.toLowerCase().includes('expense')) expenses += Number(tx.amount||0);
        if(tx.action === 'Expense') expenses += Number(tx.amount||0);
      });
      const gross = revenue - cogs;
      const operating = gross - expenses;
      return { revenue, cogs, expenses, gross, operating };
    }

    function computeTaxReconciliation(biz){
      // For simplicity: Taxable profit = operating profit adjusted for disallowables and non-taxable items
      const txns = gatherAllTxnsForBiz(biz.id);
      let revenue = 0, expenses = 0, disallowable = 0, nonTaxableIncome = 0, cogs = 0;
      txns.forEach(tx=>{
        if(tx.action === 'InventorySale' || (tx.accountName && /sales/i.test(tx.accountName))) revenue += Number(tx.netAmount || tx.amount || 0);
        if(tx.cogs) cogs += Number(tx.cogs||0);
        if(tx.accountName && /cogs/i.test(tx.accountName)) cogs += Number(tx.amount||0);
        if(tx.accountName && /expense/i.test(tx.accountName)) expenses += Number(tx.amount||0);
        if(tx.disallowable) disallowable += Number(tx.amount||0);
        if(tx.nonTaxable) nonTaxableIncome += Number(tx.amount||0);
      });
      const grossProfit = revenue - cogs;
      const operatingProfit = grossProfit - expenses;
      // taxable profit = operatingProfit - disallowable adjustments? Disallowable are added back => taxable = operatingProfit + disallowable (if expense is disallowable)
      let taxableProfit = operatingProfit + disallowable; // nonTaxableIncome should be excluded from revenue earlier, but conservatively we add back disallowable
      // subtract loss brought forward and capital brought forward and CA carryforward?
      taxableProfit = taxableProfit - (biz.lossBroughtForward || 0);
      // tax before credits:
      const taxRate = (biz.citEnabled) ? Number(biz.citRate||0)/100 : 0;
      const taxBeforeCredits = taxableProfit > 0 ? taxableProfit * taxRate : 0;
      // WHT receivable
      const wht = gatherWHT(biz.id);
      const whtReceivable = wht.receivable || 0;
      // apply CA carryforward (deduction)
      const caCF = Number(biz.caCarryForward || 0);
      // tax payable = taxBeforeCredits - whtReceivable - (caCF * taxRate?) We'll treat CA as reduction to taxable profit directly by applying CA up to taxableProfit
      let taxAfterCA = taxBeforeCredits;
      // apply CA: we subtract CA amount from taxableProfit and recompute taxBeforeCredits equivalently; simpler: reduce taxAfterCA by (caCF * taxRate)
      taxAfterCA = Math.max(0, taxAfterCA - (caCF * taxRate));
      let taxPayable = Math.max(0, taxAfterCA - whtReceivable);
      return { taxableProfit, taxBeforeCredits, whtReceivable, taxPayable };
    }

    function gatherVAT(bizId){
      const txns = gatherAllTxnsForBiz(bizId);
      let collected = 0, paid = 0;
      txns.forEach(tx=>{
        if(tx.vatAmount) {
          if(tx.action === 'InventorySale' || tx.accountName && /sales/i.test(tx.accountName)) collected += Number(tx.vatAmount||0);
          else paid += Number(tx.vatAmount||0);
        }
      });
      return { totalCollected: collected, totalPaid: paid, net: collected - paid };
    }

    function gatherWHT(bizId){
      const txns = gatherAllTxnsForBiz(bizId);
      let payable = 0, receivable = 0;
      const details = [];
      txns.forEach(tx=>{
        if(tx.whtAmount){
          // classify: if transaction is expense (we withheld on payment to vendor) it's payable; if transaction is revenue where payer withheld, it's receivable
          if(tx.action === 'Expense' || (tx.accountName && /expense|cogs/i.test(tx.accountName))) {
            payable += Number(tx.whtAmount||0);
            details.push({ txnId: tx.id, date: tx.date, whtAmount: Number(tx.whtAmount||0), accountName: tx.accountName });
          } else {
            // treat as receivable (credit)
            receivable += Number(tx.whtAmount||0);
            details.push({ txnId: tx.id, date: tx.date, whtAmount: Number(tx.whtAmount||0), accountName: tx.accountName });
          }
        }
      });
      return { payable, receivable, details };
    }

    function gatherAllTxnsForBiz(bizId){
      let all=[];
      for(const uid of Object.keys(data.transactions||{})){
        if(data.transactions[uid] && data.transactions[uid][bizId]) all = all.concat(data.transactions[uid][bizId]);
      }
      return all.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    }

    // totals & tax summary rendering below ledger
    function renderTotalsAndTaxSummary(){
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      const txns = gatherAllTxnsForBiz(biz.id);
      let totalAmount=0,totalVat=0,totalWht=0,totalPaye=0;
      txns.forEach(tx => {
        totalAmount += Number(tx.netAmount || tx.amount || 0);
        totalVat += Number(tx.vatAmount||0);
        totalWht += Number(tx.whtAmount||0);
        totalPaye += Number(tx.payeAmount||0);
      });
      totalsSummaryDiv.innerHTML = `<div>Total transactions amount: ₦${fmt(totalAmount)} | VAT total: ₦${fmt(totalVat)} | WHT total: ₦${fmt(totalWht)} | PAYE total: ₦${fmt(totalPaye)}</div>`;
      const recon = computeTaxReconciliation(biz);
      taxSummaryDiv.innerHTML = `<div><strong>Tax reconciliation (summary):</strong> Taxable profit: ₦${fmt(recon.taxableProfit)} | Tax before credits: ₦${fmt(recon.taxBeforeCredits)} | WHT receivable: ₦${fmt(recon.whtReceivable)} | Tax payable after credits: ₦${fmt(recon.taxPayable)}</div>`;
    }

    // render ledger UI and quick panels
    function renderAll(){
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      renderLedger();
      renderQuickPanels();
    }

    function renderQuickPanels(){
      const biz = findBiz(selectedBiz);
      inventoryListDiv.innerHTML=''; assetListDiv.innerHTML=''; plSnapshotDiv.innerHTML='';
      if(!biz) return;
      // inventory quick
      const inv = biz.inventory || [];
      if(!inv.length) inventoryListDiv.innerHTML = '<div>No inventory items</div>'; else {
        const tbl = document.createElement('table'); tbl.className='ledger-table';
        tbl.innerHTML = '<thead><tr><th>Item</th><th>Qty</th><th>Avg cost</th></tr></thead>';
        const tb = document.createElement('tbody');
        inv.forEach(i => { const r = document.createElement('tr'); r.innerHTML = `<td>${i.name}</td><td>${fmt(i.qty)}</td><td>${fmt(i.avgCost)}</td>`; tb.appendChild(r); });
        tbl.appendChild(tb); inventoryListDiv.appendChild(tbl);
      }
      // assets quick
      const assets = biz.assets || [];
      if(!assets.length) assetListDiv.innerHTML = '<div>No assets</div>'; else {
        const tbl = document.createElement('table'); tbl.className='ledger-table';
        tbl.innerHTML = '<thead><tr><th>Asset</th><th>Cost</th><th>Disposed</th></tr></thead>';
        const tb = document.createElement('tbody');
        assets.forEach(a => { const r = document.createElement('tr'); r.innerHTML = `<td>${a.name}</td><td>${fmt(a.cost)}</td><td>${a.disposed? 'Yes':'No'}</td>`; tb.appendChild(r); });
        tbl.appendChild(tb); assetListDiv.appendChild(tbl);
      }
      // P&L quick
      const snap = computePLSnapshot(biz);
      plSnapshotDiv.innerHTML = `<div>Revenue: ₦${fmt(snap.revenue)}</div><div>COGS: ₦${fmt(snap.cogs)}</div><div>Expenses: ₦${fmt(snap.expenses)}</div><div>Operating profit: ₦${fmt(snap.operating)}</div>`;
    }

    // Accounts modal renderer
    function renderAccounts(){
      accountsList.innerHTML = '';
      const b = findBiz(selectedBiz);
      if(!b) return;
      if(!b.accounts.length) accountsList.innerHTML = '<div>No accounts</div>';
      b.accounts.forEach(a => {
        const row = document.createElement('div'); row.className='account-row';
        const left = document.createElement('div'); left.innerHTML = `<strong>${a.name}</strong> <span class="small-muted">(${a.category})</span>`;
        const right = document.createElement('div');
        const dis = document.createElement('label'); dis.style.marginRight='8px'; dis.innerHTML = `<input type="checkbox" data-acct="${a.id}" class="acct-dis" ${a.disallowableDefault ? 'checked':''} /> Disallowable`;
        const nt = document.createElement('label'); nt.innerHTML = `<input type="checkbox" data-acct="${a.id}" class="acct-non" ${a.nonTaxableDefault ? 'checked':''} /> Non-taxable`;
        const del = document.createElement('button'); del.className='small danger'; del.textContent='Delete'; del.addEventListener('click', ()=>{ if(!confirm('Delete account?')) return; b.accounts = b.accounts.filter(x=>x.id!==a.id); saveData(); populateAccountSelect(); renderAccounts(); addAudit('account.delete','account',a.id,`Deleted account ${a.name}`); });
        right.appendChild(dis); right.appendChild(nt); right.appendChild(del);
        row.appendChild(left); row.appendChild(right);
        accountsList.appendChild(row);
      });
      // wire checkboxes
      document.querySelectorAll('.acct-dis').forEach(cb => cb.addEventListener('change', (e)=>{ const id = e.target.dataset.acct; const acct = findBiz(selectedBiz).accounts.find(x=>x.id===id); if(acct) acct.disallowableDefault = !!e.target.checked; saveData(); }));
      document.querySelectorAll('.acct-non').forEach(cb => cb.addEventListener('change', (e)=>{ const id = e.target.dataset.acct; const acct = findBiz(selectedBiz).accounts.find(x=>x.id===id); if(acct) acct.nonTaxableDefault = !!e.target.checked; saveData(); }));
    }

    function renderBizContacts(b){
      bizContactsList.innerHTML = '';
      (b.contacts||[]).forEach(c => {
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='6px';
        row.innerHTML = `<div>${c.name} <span class="small-muted">(${c.type})</span></div>`;
        const del = document.createElement('button'); del.className='small danger'; del.textContent='Delete'; del.addEventListener('click', ()=>{ if(!confirm('Delete contact?')) return; b.contacts = b.contacts.filter(x=>x.id!==c.id); saveData(); renderBizContacts(b); addAudit('contact.delete','contact',c.id,`Deleted contact ${c.name}`); });
        row.appendChild(del);
        bizContactsList.appendChild(row);
      });
    }

    // small helper: prompt attach to a txn (already used above)
    function promptAttachToTxnByUser(txnId){
      promptAttachToTxn(txnId);
    }

    // helpers for attachments in addReceipt flow (not used directly)
    function readFileAsDataUrl(file){ return new Promise((resolve, reject) => { const r = new FileReader(); r.onload = ()=>resolve(r.result); r.onerror = reject; r.readAsDataURL(file); }); }

    // initial tab render
    renderTab();

    // expose renderReport globally for tab buttons
    window.renderReport = renderReport;

  </script>
</body>
                </html>
