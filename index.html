I updated index.html per your confirmations and requests. The file below:

- Keeps existing tax summary lines (VAT, WHT, PAYE, CIT/PIT).
- Adds new tax summary/P&L lines: Depreciation (expense), Capital Allowance (tax adjustment), Chargeable gain/loss from disposals (posted to Gain on Disposal / Loss on Disposal accounts).
- Uses strict dates for depreciation/CA/disposal calculations (prorates to disposal date / reporting date).
- Separates asset purchase and asset disposal subforms (standalone).
- Adds explicit Opening Balance section/forms for:
  - Opening balance transaction (date + account + amount)
  - Opening inventory (date, item, qty, cost) that sets quantity and average cost without VAT/WHT effects
  - Opening fixed asset (purchase date + accumulated depreciation to date, classification, life, CA%, dep rate)
- Ensures salary transactions always trigger a PAYE calculation: they create a PAYE tax line (a separate expense line) and include PAYE in expense reporting. PIT remains a separate business-level calculation based on taxable profit (PAYE does not reduce PIT taxable profit).
- Adds default "Gain on Disposal" (Revenue) and "Loss on Disposal" (Expense) accounts on business creation (if missing).
- Changes UI storage text: "Stored in browser (localStorage) and exportable to file" and keeps the explicit Save/Load (export/import) flow already present.
- Fixes Reports tab display/selection so reports render when switching to Reports.
- Adds helper functions to compute depreciation and capital allowance prorated to dates and uses those on disposal and reports. Disposal flow automatically posts depreciation up to disposal date, marks asset disposed, and posts gain/loss to the corresponding accounts and ledger.

Below is the updated index.html (full). Save/replace your existing index.html with this content.

Note: This is a single-file frontend-only prototype that stores data in localStorage and supports export/import. No server or Git push is included — if you want me to prepare a branch/PR in the repository, tell me and I can create the necessary patch content next.

[Begin updated index.html]
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Multi-User Accounting & Tax — Updated</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,96vw); max-height:80vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted-pill { background:#f2f4f7; padding:4px 8px; border-radius:6px; font-size:0.9rem; color:#333; }
    .disabled { opacity:0.45; pointer-events:none; }
    .code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f3f5f7; padding:4px 6px; border-radius:4px; }
  </style>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax Engine — Updated</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
      </div>
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset / Opening Balances</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <label><input type="checkbox" id="isOpening" /> Opening balance</label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="OpeningBalance">Opening Balance</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="Salary">Salary (PAYE)</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
            <option value="BankPayment">Bank Payment</option>
            <option value="BankReceipt">Bank Receipt</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <!-- Opening balance / opening inventory / opening asset -->
      <div id="openingSection" class="form-inline" style="margin-top:10px; display:none;">
        <div class="panel" style="width:100%;">
          <h3 style="margin:4px 0;">Opening balances</h3>
          <div class="form-inline">
            <div style="min-width:260px;">
              <h4 style="margin:4px 0;">Opening balance (account)</h4>
              <label>Date: <input type="date" id="openDate" /></label>
              <label>Account: <select id="openAccount"></select></label>
              <label>Amount: <input type="number" id="openAmount" min="0" step="0.01" /></label>
              <button id="btnAddOpening" class="small primary">Apply Opening Balance</button>
            </div>

            <div style="min-width:260px;">
              <h4 style="margin:4px 0;">Opening inventory</h4>
              <label>Date: <input type="date" id="openInvDate" /></label>
              <label>Item: <input type="text" id="openInvName" /></label>
              <label>Qty: <input type="number" id="openInvQty" min="0" step="1" /></label>
              <label>Unit cost: <input type="number" id="openInvCost" min="0" step="0.01" /></label>
              <button id="btnAddOpenInv" class="small">Apply Opening Inventory</button>
              <small class="note">Opening inventory updates qty & avg cost without VAT/WHT.</small>
            </div>

            <div style="min-width:300px;">
              <h4 style="margin:4px 0;">Opening fixed asset</h4>
              <label>Asset name: <input type="text" id="openAssetName" /></label>
              <label>Purchase date: <input type="date" id="openAssetPurchaseDate" /></label>
              <label>Cost: <input type="number" id="openAssetCost" min="0" step="0.01" /></label>
              <label>Accumulated depreciation to date: <input type="number" id="openAssetAccumDep" min="0" step="0.01" /></label>
              <label>Useful life (years): <input type="number" id="openAssetLife" min="1" step="1" class="smallInput" /></label>
              <label>CA % (annual): <input type="number" id="openAssetCA" min="0" step="0.01" class="smallInput" /></label>
              <label>Dep % (annual): <input type="number" id="openAssetDepRate" min="0" step="0.01" class="smallInput" /></label>
              <button id="btnAddOpenAsset" class="small">Add Opening Asset</button>
              <small class="note">Opening asset sets accumulated depreciation and is marked as purchased earlier.</small>
            </div>
          </div>
        </div>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small primary">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <!-- Asset purchase subform (standalone) -->
      <div id="assetPurchaseSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset Purchase</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>
          <label>Classification:
            <select id="assetClassification">
              <option value="Fixed">Fixed</option>
              <option value="Chargeable">Chargeable</option>
            </select>
          </label>

          <label>Depreciation rate % (annual): <input type="number" id="assetDepRate" class="smallInput" min="0" step="0.01" /></label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small primary">Record Asset Purchase</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days. Capital allowance applied monthly from purchase. Opening assets are handled in "Opening balances".</small>
      </div>

      <!-- Asset disposal subform (standalone) -->
      <div id="assetDisposalSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset Disposal</h3>
        <div class="form-inline">
          <label>Asset:
            <select id="assetSelectForDisposal"></select>
          </label>
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
        </div>
        <small class="note">Disposal will auto-post depreciation up to disposal date, mark asset disposed and post gain/loss to Gain/Loss accounts.</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable/Receivable</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Fixed Assets Report</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
        <button id="btnExportXlsx" class="small">Export XLSX (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <!-- User modal -->
  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <!-- Business modal -->
  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (SoleTrader), that will override these values for PIT.</small>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add a contact with type "SoleTrader" (or name "Sole trader") and set statutory deductions there if you want PIT to use per-sole-trader deductions.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <!-- Accounts modal -->
  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="max-height:360px; overflow:auto;"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountDisallowable" /> Disallowable</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountNonTax" /> Non-taxable</label>
      <select id="newAccountRentFreq">
        <option value="">Rent freq</option>
        <option value="monthly">Monthly rent</option>
        <option value="yearly">Yearly rent</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">
    Stored in browser (localStorage) and exportable to file (Export / Import JSON).
  </footer>

  <script>
  /************************************************************************
   * Nigeria Multi-User Multi-Business Accounting & Tax Engine (Updated)
   * Storage key: ntc_full_accounting_v1
   *
   * Notes on changes:
   * - Default Gain on Disposal and Loss on Disposal accounts added on biz creation.
   * - Asset purchase and asset disposal are separate subforms.
   * - Opening balances form: opening account balance, opening inventory, opening asset (with accumulated depreciation).
   * - Salary transactions always compute PAYE and create a PAYE expense line (separate transaction) but PIT remains business-level.
   * - Depreciation and Capital Allowance are computed dynamically for reports and prorated to dates (including disposal).
   * - Disposal posts depreciation up to disposal date, marks asset disposed, maps gains/losses to gain/loss accounts and posts ledger transaction.
   ************************************************************************/

  const STORAGE_KEY = 'ntc_full_accounting_v1';
  const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, caRateDefault:20.0, depRateDefault:20.0 };
  const PAYE_BANDS = [
    { upTo: 800000, rate: 0.00 },
    { upTo: 3000000, rate: 0.15 },
    { upTo: 12000000, rate: 0.18 },
    { upTo: 25000000, rate: 0.21 },
    { upTo: 50000000, rate: 0.23 },
    { upTo: Infinity, rate: 0.25 }
  ];

  let state = { users: [], businesses: [], transactions: {}, attachments: {}, audit: [], auth: { currentUserId: null } };
  let selectedUserId = null;
  let selectedBizId = null;
  let activeTab = 'ledger';

  // DOM refs (partial)
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const txnReceipt = document.getElementById('txnReceipt');
  const btnAddTxn = document.getElementById('btnAddTxn');
  const mainTxnForm = document.getElementById('mainTxnForm');

  const openingSection = document.getElementById('openingSection');
  const isOpening = document.getElementById('isOpening');
  const openDate = document.getElementById('openDate');
  const openAccount = document.getElementById('openAccount');
  const openAmount = document.getElementById('openAmount');
  const btnAddOpening = document.getElementById('btnAddOpening');

  const openInvDate = document.getElementById('openInvDate');
  const openInvName = document.getElementById('openInvName');
  const openInvQty = document.getElementById('openInvQty');
  const openInvCost = document.getElementById('openInvCost');
  const btnAddOpenInv = document.getElementById('btnAddOpenInv');

  const openAssetName = document.getElementById('openAssetName');
  const openAssetPurchaseDate = document.getElementById('openAssetPurchaseDate');
  const openAssetCost = document.getElementById('openAssetCost');
  const openAssetAccumDep = document.getElementById('openAssetAccumDep');
  const openAssetLife = document.getElementById('openAssetLife');
  const openAssetCA = document.getElementById('openAssetCA');
  const openAssetDepRate = document.getElementById('openAssetDepRate');
  const btnAddOpenAsset = document.getElementById('btnAddOpenAsset');

  const inventorySubform = document.getElementById('inventorySubform');
  const invItemSelect = document.getElementById('invItemSelect');
  const invNewName = document.getElementById('invNewName');
  const invAccountSelect = document.getElementById('invAccountSelect');
  const invQty = document.getElementById('invQty');
  const invUnitPrice = document.getElementById('invUnitPrice');
  const invVatType = document.getElementById('invVatType');
  const invContact = document.getElementById('invContact');
  const invReceipt = document.getElementById('invReceipt');
  const btnAddInv = document.getElementById('btnAddInv');
  const btnInvCancel = document.getElementById('btnInvCancel');
  const btnInvUndo = document.getElementById('btnInvUndo');

  const assetPurchaseSubform = document.getElementById('assetPurchaseSubform');
  const assetName = document.getElementById('assetName');
  const assetCost = document.getElementById('assetCost');
  const assetPurchaseDate = document.getElementById('assetPurchaseDate');
  const assetLife = document.getElementById('assetLife');
  const assetCA = document.getElementById('assetCA');
  const btnAddAsset = document.getElementById('btnAddAsset');
  const btnAssetCancel = document.getElementById('btnAssetCancel');
  const btnAssetUndo = document.getElementById('btnAssetUndo');
  const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
  const assetClassification = document.getElementById('assetClassification');
  const assetDepRate = document.getElementById('assetDepRate');
  const assetContact = document.getElementById('assetContact');
  const assetReceipt = document.getElementById('assetReceipt');

  const assetDisposalSubform = document.getElementById('assetDisposalSubform');
  const assetSelectForDisposal = document.getElementById('assetSelectForDisposal');
  const assetDisposalDate = document.getElementById('assetDisposalDate');
  const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
  const assetDisposalAccount = document.getElementById('assetDisposalAccount');
  const btnDisposeAsset = document.getElementById('btnDisposeAsset');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const ledgerSection = document.getElementById('ledgerSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');

  const modalOverlay = document.getElementById('modalOverlay');
  const userModal = document.getElementById('userModal');
  const userModalTitle = document.getElementById('userModalTitle');
  const userName = document.getElementById('userName');
  const userDisplay = document.getElementById('userDisplay');
  const userRole = document.getElementById('userRole');
  const permView = document.getElementById('permView');
  const permEdit = document.getElementById('permEdit');
  const permDelete = document.getElementById('permDelete');
  const userSave = document.getElementById('userSave');
  const userCancel = document.getElementById('userCancel');

  const businessModal = document.getElementById('businessModal');
  const businessModalTitle = document.getElementById('businessModalTitle');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
  const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizCapitalBF = document.getElementById('bizCapitalBF');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');

  const accountsModal = document.getElementById('accountsModal');
  const accountsList = document.getElementById('accountsList');
  const newAccountName = document.getElementById('newAccountName');
  const newAccountCategory = document.getElementById('newAccountCategory');
  const newAccountDisallowable = document.getElementById('newAccountDisallowable');
  const newAccountNonTax = document.getElementById('newAccountNonTax');
  const newAccountRentFreq = document.getElementById('newAccountRentFreq');
  const addAccountBtn = document.getElementById('addAccountBtn');
  const closeAccountsBtn = document.getElementById('closeAccountsBtn');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnReportsTab = document.getElementById('btnReportsTab');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
  function toISO(date){ if(!date) return null; return new Date(date).toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }

  // load/save
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }
  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || { currentUserId: null };
    state.businesses.forEach(b => {
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
      b.accounts = b.accounts || [];
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
      b.caRateDefault = Number(b.caRateDefault || DEFAULTS.caRateDefault);
      b.depRateDefault = Number(b.depRateDefault || DEFAULTS.depRateDefault);
      // ensure gain/loss accounts exist names: Gain on Disposal (Revenue), Loss on Disposal (Expense)
      ensureGainLossAccounts(b);
    });
    // ensure transactions map for each user and business
    for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; for(const b of state.businesses){ state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || []; } }
    saveState();
  }

  function ensureGainLossAccounts(biz){
    biz.accounts = biz.accounts || [];
    if(!biz.accounts.find(a=>a.name==='Gain on Disposal')) biz.accounts.push({ id: uid('acct'), name:'Gain on Disposal', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
    if(!biz.accounts.find(a=>a.name==='Loss on Disposal')) biz.accounts.push({ id: uid('acct'), name:'Loss on Disposal', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
    // ensure PAYE expense account exists
    if(!biz.accounts.find(a=>a.name==='PAYE Expense')) biz.accounts.push({ id: uid('acct'), name:'PAYE Expense', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
    // ensure PAYE payable (liability) exist
    if(!biz.accounts.find(a=>a.name==='PAYE Liability')) biz.accounts.push({ id: uid('acct'), name:'PAYE Liability', category:'Liability', disallowableDefault:false, nonTaxableDefault:false });
  }

  function seedDemo(){
    const u = uid('user'), b = uid('biz');
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const rent = { id: uid('acct'), name: 'Rent', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false, rentFreq:'monthly' };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false };
    const chargeInc = { id: uid('acct'), name: 'Chargeable asset income', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const chargeCost = { id: uid('acct'), name: 'Chargeable asset cost', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };

    state = {
      users: [{ id: u, username: 'admin', display:'Admin User', role:'Admin', isAdmin:true, permissions:{ view:true, edit:true, delete:true } }],
      businesses: [{
        id: b,
        name: 'Demo Business',
        ownerId: u,
        entity: 'Company',
        vatRate: DEFAULTS.vatRate,
        whtRate: DEFAULTS.whtRate,
        citRate: DEFAULTS.citRate,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault,
        depRateDefault: DEFAULTS.depRateDefault,
        accounts: [sales, cogs, salaries, rent, bank, chargeInc, chargeCost],
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [],
        contacts: [{ id: uid('c'), name:'John Employee', type:'Employee', statutory:{ pension: 20000, rent: 120000, life: 5000, mortgage: 100000, nhf: 5000 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } }],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward: 150000, caCarryForward: 50000, capitalBroughtForward: 0,
        defaultExpenseDisallowable:false, defaultRevenueNonTax:false,
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: u }
    };
    // ensure accounts like gain/loss and paye exist
    ensureGainLossAccounts(state.businesses[0]);

    // initialize transactions map
    state.transactions[u] = {};
    state.transactions[u][b] = [
      { id: uid('txn'), date: today(), action: 'Revenue', accountId: sales.id, accountName: sales.name, accountCategory: sales.category, description: 'Demo sale', amount: 150000, vatType:'exclusive', vatAmount:11250, wht:0, paye:0, contact:'Client' },
      { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, accountCategory: salaries.category, description: 'Demo salary', amount: 50000, vatType:'none', vatAmount:0, wht:0, paye:12000, contact:'John Employee' },
      { id: uid('txn'), date: today(), action: 'InventoryPurchase', accountId: cogs.id, accountName: cogs.name, accountCategory: cogs.category, description: 'Purchase widgets', qty:50, unitPrice:520, amount:26000, vatType:'exclusive', vatAmount:1950, wht:0, paye:0 }
    ];
    addAudit('seed','system','',`Seeded demo data`);
    migrateState();
    saveState();
  }

  // audit
  function addAudit(type, entityType, entityId, details){
    const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details };
    state.audit = state.audit || [];
    state.audit.push(entry);
    saveState();
  }

  // modal helpers
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
  modalOverlay.addEventListener('click', ()=> { [userModal, businessModal, accountsModal].forEach(m => { if(m.style.display==='block') closeModal(m); }); });

  // initialization
  loadState();
  initUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  function initUI(){
    // Users
    btnAddUser.addEventListener('click', ()=> openUserModal());
    btnEditUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); openUserModal(selectedUserId); });
    btnDeleteUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); if(!confirm('Delete user? This cannot be undone')) return; deleteUser(selectedUserId); });
    userSave.addEventListener('click', ()=> {
      const username = (userName.value||'').trim();
      if(!username) return alert('Username required');
      const editId = userSave.dataset.edit;
      if(editId){
        const u = state.users.find(x=>x.id===editId);
        u.username = username; u.display = userDisplay.value || username; u.role = userRole.value;
        u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked };
        addAudit('user.edit','user',u.id,'Edited user');
      } else {
        const newUser = { id: uid('user'), username, display: userDisplay.value || username, role: userRole.value, isAdmin: userRole.value==='Admin', permissions: { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked } };
        state.users.push(newUser);
        // ensure transactions map
        state.transactions[newUser.id] = state.transactions[newUser.id] || {};
        for(const b of state.businesses) state.transactions[newUser.id][b.id] = state.transactions[newUser.id][b.id] || [];
        addAudit('user.add','user',newUser.id,'Added user');
      }
      saveState();
      closeModal(userModal);
      refreshSelectors();
      ensureSelection();
      renderAll();
    });
    userCancel.addEventListener('click', ()=> closeModal(userModal));

    // Business
    btnAddBusiness.addEventListener('click', ()=> {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = ''; bizOwnerSelect.value = state.users[0] ? state.users[0].id : '';
      bizEntity.value = 'Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate;
      bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
      bizSave.dataset.edit = '';
      bizContactsList.innerHTML = '';
      openModal(businessModal);
    });
    btnEditBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const b = findBiz(selectedBizId); if(!b) return alert('Business not found');
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (state.users[0] && state.users[0].id) || '';
      bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
      bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled;
      bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0; bizCapitalBF.value = b.capitalBroughtForward || 0;
      bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax;
      bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
      bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0;
      bizCapitalBF.value = b.capitalBroughtForward || 0;
      renderBizContacts(b);
      bizSave.dataset.edit = b.id;
      openModal(businessModal);
    });
    btnDeleteBusiness.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      if(!confirm('Delete business and all its transactions/attachments?')) return;
      deleteBusiness(selectedBizId);
    });
    bizSave.addEventListener('click', ()=> {
      const name = (bizName.value||'').trim();
      if(!name) return alert('Business name required');
      const editId = bizSave.dataset.edit;
      if(editId){
        const b = findBiz(editId);
        if(!b) return alert('Business not found');
        b.name = name; b.ownerId = bizOwnerSelect.value; b.entity = bizEntity.value;
        b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
        b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked;
        b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0); b.capitalBroughtForward = Number(bizCapitalBF.value || 0);
        b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked;
        b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) };
        ensureGainLossAccounts(b);
        addAudit('business.edit','business', b.id, 'Edited business');
      } else {
        const newBiz = {
          id: uid('biz'), name, ownerId: bizOwnerSelect.value || (state.users[0] && state.users[0].id),
          entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate),
          vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
          accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
          lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS.depRateDefault
        };
        // default accounts
        newBiz.accounts.push({ id: uid('acct'), name:'Sales', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Bank', category:'Asset', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Chargeable asset income', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
        newBiz.accounts.push({ id: uid('acct'), name:'Chargeable asset cost', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
        // ensure gain/loss & PAYE accounts too
        ensureGainLossAccounts(newBiz);
        state.businesses.push(newBiz);
        for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][newBiz.id] = []; }
        addAudit('business.add','business', newBiz.id, 'Added business');
      }
      saveState();
      closeModal(businessModal);
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      renderAll();
    });
    bizCancel.addEventListener('click', ()=>closeModal(businessModal));
    btnAddContact.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business first');
      const b = findBiz(selectedBizId);
      const name = (newContactName.value||'').trim();
      if(!name) return alert('Contact name required');
      b.contacts = b.contacts || [];
      b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } });
      saveState();
      renderBizContacts(b);
    });

    // accounts modal
    btnManageAccounts.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      renderAccounts();
      openModal(accountsModal);
    });
    addAccountBtn.addEventListener('click', ()=> {
      const name = (newAccountName.value||'').trim();
      const cat = newAccountCategory.value;
      const dis = !!newAccountDisallowable.checked;
      const nt = !!newAccountNonTax.checked;
      const rentFreq = newAccountRentFreq.value || '';
      if(!name) return alert('Account name required');
      const b = findBiz(selectedBizId);
      b.accounts = b.accounts || [];
      b.accounts.push({ id: uid('acct'), name, category: cat, disallowableDefault:dis, nonTaxableDefault:nt, rentFreq:rentFreq });
      saveState();
      renderAccounts();
      populateAccountSelect();
    });
    closeAccountsBtn.addEventListener('click', ()=> closeModal(accountsModal));

    // transaction form behavior
    txnAction.addEventListener('change', ()=> {
      const val = txnAction.value;
      // hide everything then show relevant
      mainTxnForm.style.display = 'flex';
      inventorySubform.style.display = 'none';
      assetPurchaseSubform.style.display = 'none';
      assetDisposalSubform.style.display = 'none';
      openingSection.style.display = 'none';

      if(val === 'InventoryPurchase' || val === 'InventorySale'){
        mainTxnForm.style.display = 'none';
        inventorySubform.style.display = 'block';
        populateAccountSelect();
      } else if(val === 'FixedAssetPurchase'){
        mainTxnForm.style.display = 'none';
        assetPurchaseSubform.style.display = 'block';
        populateAccountSelect();
        populateAssetPurchaseAccounts();
      } else if(val === 'FixedAssetDisposal'){
        mainTxnForm.style.display = 'none';
        assetDisposalSubform.style.display = 'block';
        populateAccountSelect();
        populateAssetDisposal();
      } else if(val === 'OpeningBalance'){
        openingSection.style.display = 'flex';
      } else {
        // default single transaction form
      }
      renderFeatureVisibility();
    });
    isOpening.addEventListener('change', ()=> {
      openingSection.style.display = isOpening.checked ? 'flex' : 'none';
    });

    txnWht.addEventListener('change', ()=> {
      const show = txnWht.checked;
      txnWhtRateLabel.style.display = show ? 'inline-flex' : 'none';
      txnWhtBasisLabel.style.display = show ? 'inline-flex' : 'none';
      if(show && !txnWhtRate.value){ txnWhtRate.value = findBiz(selectedBizId)?.whtRate || DEFAULTS.whtRate; }
    } );
    btnAddTxn.addEventListener('click', handleAddTransaction);

    // opening handlers
    btnAddOpening.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const b = findBiz(selectedBizId);
      const acctId = openAccount.value;
      if(!acctId) return alert('Select account');
      const amt = Number(openAmount.value || 0);
      const date = openDate.value || today();
      const t = { id: uid('txn'), date, action: 'OpeningBalance', accountId: acctId, accountName: findAccount(b,acctId)?.name, accountCategory: findAccount(b,acctId)?.category, description: 'Opening balance', amount: amt, vatType:'none', vatAmount:0, wht:0, paye:0 };
      pushTxn(t);
      addAudit('opening','transaction','',`Applied opening balance ${fmt(amt)} to ${t.accountName}`);
      saveState(); renderAll();
    });
    btnAddOpenInv.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const b = findBiz(selectedBizId);
      const name = (openInvName.value||'').trim();
      const qty = Number(openInvQty.value||0);
      const cost = Number(openInvCost.value||0);
      if(!name) return alert('Item name required');
      // set or add inventory item without VAT/WHT or ledger purchases
      const existing = b.inventory.find(i=>i.name===name);
      if(existing){
        // weighted average: newAvg = (existing.qty*existing.avgCost + qty*cost)/(existing.qty+qty)
        const totalCost = (existing.qty * existing.avgCost) + (qty * cost);
        const newQty = existing.qty + qty;
        existing.avgCost = newQty ? (totalCost/newQty) : existing.avgCost;
        existing.qty = newQty;
      } else {
        b.inventory.push({ id: uid('item'), name, qty, avgCost: cost });
      }
      addAudit('opening.inv','inventory','',`Opening inventory ${name} qty:${qty} cost:${fmt(cost)}`);
      saveState(); renderAll();
    });
    btnAddOpenAsset.addEventListener('click', ()=> {
      if(!selectedBizId) return alert('Select business');
      const b = findBiz(selectedBizId);
      const name = (openAssetName.value||'').trim();
      if(!name) return alert('Asset name required');
      const purchaseDate = openAssetPurchaseDate.value || today();
      const cost = Number(openAssetCost.value || 0);
      const accumulatedDep = Number(openAssetAccumDep.value || 0);
      const lifeYears = Number(openAssetLife.value || 0) || 0;
      const caPercent = Number(openAssetCA.value || b.caRateDefault || 0);
      const depRate = Number(openAssetDepRate.value || b.depRateDefault || 0);
      const asset = { id: uid('asset'), name, cost, purchaseDate, lifeYears, caPercent, depRate, classification:'Fixed', accumulatedDep, disposed:false, disposal:{} };
      b.assets = b.assets || [];
      b.assets.push(asset);
      addAudit('opening.asset','asset',asset.id,`Added opening asset ${name}`);
      saveState(); renderAll();
    });

    // inventory
    btnAddInv.addEventListener('click', handleInventoryAction);
    btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnInvUndo.addEventListener('click', handleUndoInventory);

    // assets
    btnAddAsset.addEventListener('click', handleAddAsset);
    btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetPurchaseSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnAssetUndo.addEventListener('click', handleUndoAsset);
    btnDisposeAsset.addEventListener('click', handleDisposeAsset);

    // ledger search
    document.getElementById('btnSearch').addEventListener('click', renderLedger);
    document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

    // export/import/clear
    document.getElementById('btnExport').addEventListener('click', ()=> {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc_full_data.json'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const incoming = JSON.parse(r.result);
          if(!confirm('Import will replace current data. Continue?')) return;
          state = incoming;
          migrateState();
          refreshSelectors();
          ensureSelection();
          populateAccountSelect();
          resetForms();
          renderAll();
          saveState();
          alert('Import complete');
        } catch(err){ alert('Invalid JSON'); }
      };
      r.readAsText(f);
    });
    document.getElementById('btnClearAll').addEventListener('click', ()=> {
      if(!confirm('Clear all stored data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      state = { users:[], businesses:[], transactions:{}, attachments:{}, audit:[], auth:{ currentUserId:null } };
      seedDemo();
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      resetForms();
      renderAll();
    });

    // tabs
    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; renderTab(); });
    btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; renderTab(); });

    // Report tab handlers
    document.querySelectorAll('#reportsSection .tab').forEach(tb => {
      tb.addEventListener('click', (e) => {
        document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
        tb.classList.add('active');
        renderReport(tb.dataset.report);
      });
    });

    // exports from reports
    document.getElementById('btnExportCsv').addEventListener('click', ()=> exportCurrentReport('csv'));
    document.getElementById('btnExportPdf').addEventListener('click', ()=> exportCurrentReport('pdf'));
    document.getElementById('btnExportXlsx').addEventListener('click', ()=> exportCurrentReport('xlsx'));
  }

  // Helper finders
  function findUser(id){ return state.users.find(u=>u.id===id); }
  function findBiz(id){ return state.businesses.find(b=>b.id===id); }
  function findAccount(biz, acctId){ return (biz.accounts||[]).find(a=>a.id===acctId); }

  // UI: selection and refresh
  function refreshSelectors(){
    userSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); }
    businessSelect.innerHTML = '';
    for(const b of state.businesses){ const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name; businessSelect.appendChild(opt); }
    bizOwnerSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; bizOwnerSelect.appendChild(opt); }
  }
  function ensureSelection(){
    if(!selectedUserId && state.users[0]) selectedUserId = state.users[0].id;
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    userSelect.value = selectedUserId || (state.users[0] && state.users[0].id) || '';
    businessSelect.value = selectedBizId || (state.businesses[0] && state.businesses[0].id) || '';
    userSelect.addEventListener('change', ()=> { selectedUserId = userSelect.value; renderAll(); });
    businessSelect.addEventListener('change', ()=> { selectedBizId = businessSelect.value; populateAccountSelect(); renderAll(); renderFeatureVisibility(); });
    // set auth current user
    if(state.auth.currentUserId) selectedUserId = state.auth.currentUserId;
    userSelect.value = selectedUserId;
  }

  function populateAccountSelect(){
    txnAccount.innerHTML = '';
    invAccountSelect.innerHTML = '';
    assetPurchaseAccount.innerHTML = '';
    assetDisposalAccount.innerHTML = '';
    openAccount.innerHTML = '';
    assetDisposalAccount.innerHTML = '';
    assetPurchaseAccount.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of b.accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' ('+a.category+')';
      txnAccount.appendChild(opt);
      const opt2 = opt.cloneNode(true);
      invAccountSelect.appendChild(opt2);
      const opt3 = opt.cloneNode(true);
      assetPurchaseAccount.appendChild(opt3);
      const opt4 = opt.cloneNode(true);
      assetDisposalAccount.appendChild(opt4);
      const opt5 = opt.cloneNode(true);
      openAccount.appendChild(opt5);
    }
    populateAssetDisposal();
  }

  function populateAssetPurchaseAccounts(){
    const b = findBiz(selectedBizId);
    if(!b) return;
    assetPurchaseAccount.innerHTML = '';
    for(const a of b.accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' ('+a.category+')';
      assetPurchaseAccount.appendChild(opt);
    }
  }

  function populateAssetDisposal(){
    const b = findBiz(selectedBizId); if(!b) return;
    assetSelectForDisposal.innerHTML = '';
    assetDisposalAccount.innerHTML = '';
    for(const a of b.accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' ('+a.category+')';
      assetDisposalAccount.appendChild(opt);
    }
    for(const asset of (b.assets||[]).filter(x=>!x.disposed)){
      const opt = document.createElement('option'); opt.value = asset.id; opt.textContent = asset.name + ' - ' + fmt(asset.cost) + ' ('+ (asset.purchaseDate || '') +')';
      assetSelectForDisposal.appendChild(opt);
    }
  }

  function resetForms(){
    txnDate.value = today();
    txnAction.value = '';
    txnAccount.value = '';
    txnDesc.value = '';
    txnAmount.value = '';
    txnVatType.value = 'none';
    txnWht.checked = false;
    txnWhtRate.value = '';
    txnSalary.checked = false;
    txnContact.value = '';
    isOpening.checked = false;
    openingSection.style.display = 'none';
    inventorySubform.style.display = 'none';
    assetPurchaseSubform.style.display = 'none';
    assetDisposalSubform.style.display = 'none';
  }

  // push transaction for current user/business
  function pushTxn(txn){
    if(!selectedUserId || !selectedBizId) return alert('Select user and business');
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(txn);
    saveState();
  }

  // Transaction handlers
  function handleAddTransaction(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const action = txnAction.value;
    const date = txnDate.value || today();
    if(action === 'InventoryPurchase' || action === 'InventorySale'){
      // handled by inventory subform
      alert('Use inventory subform');
      return;
    }
    if(action === 'FixedAssetPurchase' || action === 'FixedAssetDisposal'){
      alert('Use asset subforms');
      return;
    }

    const accountId = txnAccount.value;
    const accountObj = findAccount(b, accountId) || { id:'', name:'', category:'' };
    const desc = txnDesc.value || '';
    const amount = Number(txnAmount.value || 0);
    const vatType = txnVatType.value || 'none';
    const whtApplied = txnWht.checked;
    const whtRate = Number(txnWhtRate.value || b.whtRate || DEFAULTS.whtRate);
    const contact = txnContact.value || '';

    if(action === 'Salary' || txnSalary.checked || action === 'Salary'){
      // create salary expense transaction
      const salaryTxn = { id: uid('txn'), date, action: 'Expense', accountId: accountId || (b.accounts.find(a=>a.name==='Salaries')||{}).id, accountName: accountObj.name || 'Salaries', accountCategory:'Expense', description: desc || 'Salary', amount, vatType:'none', vatAmount:0, wht:0, paye:0, contact };
      pushTxn(salaryTxn);
      // compute PAYE: annualize monthly if this is a monthly figure, then compute monthly PAYE
      const monthlySalary = amount; // assume amount is monthly salary entry
      const monthlyPaye = computePayeMonthlyFromMonthlySalary(monthlySalary);
      // create separate PAYE expense line (included in expense per your request)
      const payeAccount = b.accounts.find(a=>a.name==='PAYE Expense') || b.accounts[0];
      const payeTxn = { id: uid('txn'), date, action: 'PAYE', accountId: payeAccount.id, accountName: payeAccount.name, accountCategory: payeAccount.category, description: `PAYE for salary (${desc||''})`, amount: monthlyPaye, vatType:'none', vatAmount:0, wht:0, paye:monthlyPaye, contact };
      pushTxn(payeTxn);
      addAudit('txn.add','transaction','',`Salary ${fmt(amount)} and PAYE ${fmt(monthlyPaye)}`);
      saveState();
      renderAll();
      return;
    }

    // Generic transaction
    const txn = { id: uid('txn'), date, action: action || 'General', accountId, accountName: accountObj.name, accountCategory: accountObj.category, description: desc, amount, vatType, vatAmount:0, wht:0, paye:0, contact };
    // VAT basic handling
    if(vatType === 'exclusive') txn.vatAmount = +(amount * (b.vatRate/100));
    if(vatType === 'inclusive') txn.vatAmount = +(amount - (amount / (1 + (b.vatRate/100))));
    if(whtApplied) txn.wht = +(amount * (whtRate/100));
    pushTxn(txn);
    addAudit('txn.add','transaction','',`Added ${action} ${fmt(amount)} on ${date}`);
    saveState();
    renderAll();
  }

  // inventory handlers
  function handleInventoryAction(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const itemName = (invNewName.value||'').trim() || invItemSelect.value;
    if(!itemName) return alert('Item required');
    const qty = Number(invQty.value || 0);
    const unitPrice = Number(invUnitPrice.value || 0);
    const action = txnAction.value;
    if(action === 'InventoryPurchase'){
      // update weighted average
      let item = b.inventory.find(i=>i.name===itemName);
      if(!item){
        item = { id: uid('item'), name: itemName, qty:0, avgCost:0 };
        b.inventory.push(item);
      }
      const totalPrev = item.qty * item.avgCost;
      const totalNew = qty * unitPrice;
      const newQty = item.qty + qty;
      item.avgCost = newQty ? ((totalPrev + totalNew) / newQty) : 0;
      item.qty = newQty;
      // create ledger purchase txn
      const acct = findAccount(b, invAccountSelect.value) || b.accounts[0];
      const t = { id: uid('txn'), date: txnDate.value || today(), action:'InventoryPurchase', accountId: acct.id, accountName: acct.name, accountCategory: acct.category, description: `Purchase ${qty} x ${itemName}`, qty, unitPrice, amount: qty*unitPrice, vatType:invVatType.value||'none', vatAmount:0, wht:0, paye:0, contact: invContact.value||'' };
      if(invVatType.value === 'exclusive') t.vatAmount = +(t.amount * (b.vatRate/100));
      if(invVatType.value === 'inclusive') t.vatAmount = +(t.amount - (t.amount / (1 + (b.vatRate/100))));
      pushTxn(t);
      addAudit('inventory.purchase','inventory', item.id, `Purchased ${qty} ${itemName}`);
      saveState(); renderAll();
      return;
    } else if(action === 'InventorySale'){
      const item = b.inventory.find(i=>i.name===itemName);
      if(!item) return alert('Item not found');
      if(qty > item.qty) return alert('Insufficient qty');
      const cogs = qty * item.avgCost;
      item.qty -= qty;
      const acct = findAccount(b, invAccountSelect.value) || b.accounts[0];
      const t = { id: uid('txn'), date: txnDate.value || today(), action:'InventorySale', accountId: acct.id, accountName: acct.name, accountCategory: acct.category, description: `Sale ${qty} x ${itemName}`, qty, unitPrice, amount: qty*unitPrice, cogs, vatType:invVatType.value||'none', vatAmount:0, wht:0, paye:0, contact: invContact.value||'' };
      if(invVatType.value === 'exclusive') t.vatAmount = +(t.amount * (b.vatRate/100));
      if(invVatType.value === 'inclusive') t.vatAmount = +(t.amount - (t.amount / (1 + (b.vatRate/100))));
      pushTxn(t);
      addAudit('inventory.sale','inventory', item.id, `Sold ${qty} ${itemName}`);
      saveState(); renderAll();
      return;
    }
  }

  function handleUndoInventory(){
    if(!selectedUserId || !selectedBizId) return alert('Select user and business');
    const arr = state.transactions[selectedUserId][selectedBizId] || [];
    // find last inventory action and remove
    for(let i=arr.length-1;i>=0;i--){
      if(arr[i].action && (arr[i].action==='InventoryPurchase' || arr[i].action==='InventorySale')){
        arr.splice(i,1);
        addAudit('inventory.undo','transaction','',`Undid inventory action`);
        saveState(); renderAll(); return;
      }
    }
    alert('No inventory actions to undo');
  }

  // asset handlers
  function handleAddAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const name = (assetName.value||'').trim();
    if(!name) return alert('Asset name required');
    const cost = Number(assetCost.value || 0);
    const purchaseDate = assetPurchaseDate.value || today();
    const lifeYears = Number(assetLife.value || 0) || 0;
    const caPercent = Number(assetCA.value || b.caRateDefault || 0);
    const depRate = Number(assetDepRate.value || b.depRateDefault || 0);
    const classification = assetClassification.value || 'Fixed';
    const acct = findAccount(b, assetPurchaseAccount.value) || (b.accounts[0]||{id:'',name:'',category:''});
    const asset = { id: uid('asset'), name, cost, purchaseDate, lifeYears, caPercent, depRate, classification, accumulatedDep:0, disposed:false, disposal:{} };
    b.assets = b.assets || [];
    b.assets.push(asset);
    // create purchase transaction posting to purchase account
    const t = { id: uid('txn'), date: purchaseDate, action: 'FixedAssetPurchase', accountId: acct.id, accountName: acct.name, accountCategory: acct.category, description: `Asset purchase ${name}`, amount: cost, vatType:'none', vatAmount:0, wht:0, paye:0, contact: assetContact.value||'' };
    pushTxn(t);
    addAudit('asset.add','asset', asset.id, `Added asset ${name}`);
    saveState(); renderAll();
  }

  function handleUndoAsset(){
    if(!selectedUserId || !selectedBizId) return alert('Select user and business');
    const b = findBiz(selectedBizId);
    // remove last asset action transaction and asset
    const arr = state.transactions[selectedUserId][selectedBizId] || [];
    for(let i=arr.length-1;i>=0;i--){
      if(arr[i].action && (arr[i].action==='FixedAssetPurchase')) {
        const txn = arr.splice(i,1)[0];
        // remove asset matching description name if possible
        if(b.assets){
          const nameMatch = txn.description?.replace('Asset purchase ','') || '';
          const idx = b.assets.findIndex(a=>a.name===nameMatch && !a.disposed);
          if(idx>=0) b.assets.splice(idx,1);
        }
        addAudit('asset.undo','transaction','',`Undid asset purchase`);
        saveState(); renderAll(); return;
      }
    }
    alert('No asset purchases to undo');
  }

  function handleDisposeAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const assetId = assetSelectForDisposal.value;
    const asset = b.assets.find(a=>a.id===assetId);
    if(!asset) return alert('Select asset to dispose');
    const disposalDate = assetDisposalDate.value || today();
    const proceeds = Number(assetDisposalProceeds.value || 0);
    const disposalAccount = findAccount(b, assetDisposalAccount.value) || b.accounts.find(a=>a.name==='Bank') || b.accounts[0];

    // compute depreciation up to disposal date
    const depUpToDisposal = computeAccumulatedDepreciation(asset, disposalDate);
    const accumulatedBefore = asset.accumulatedDep || 0;
    const newAccumulated = Math.max(accumulatedBefore, depUpToDisposal);
    asset.accumulatedDep = newAccumulated;

    // compute net book value = cost - accumulatedDep
    const netBook = (asset.cost || 0) - (asset.accumulatedDep || 0);
    const gainLossAmount = (proceeds || 0) - netBook;

    // mark disposed
    asset.disposed = true;
    asset.disposal = { date: disposalDate, proceeds, postedAt: today() };

    // post depreciation up to disposal as an explanatory transaction (not creating monthly journals)
    const depDesc = `Depreciation to disposal ${asset.name}`;
    const depAccount = b.accounts.find(a=>a.name==='Depreciation') || b.accounts.find(a=>a.category==='Expense') || b.accounts[0];
    const depreciationTxn = { id: uid('txn'), date: disposalDate, action:'Depreciation', accountId: depAccount.id, accountName: depAccount.name, accountCategory: depAccount.category, description: depDesc, amount: asset.accumulatedDep - accumulatedBefore, vatType:'none', vatAmount:0, wht:0, paye:0, contact:'' };
    pushTxn(depreciationTxn);

    // post disposal proceeds receipt/expense
    const disposalTxn = { id: uid('txn'), date: disposalDate, action:'FixedAssetDisposal', accountId: disposalAccount.id, accountName: disposalAccount.name, accountCategory: disposalAccount.category, description: `Disposal ${asset.name}`, amount: proceeds, vatType:'none', vatAmount:0, wht:0, paye:0, contact:'' };
    pushTxn(disposalTxn);

    // post gain or loss to respective account
    if(gainLossAmount > 0){
      const gainAcct = b.accounts.find(a=>a.name==='Gain on Disposal') || { id:'', name:'Gain on Disposal', category:'Revenue' };
      const gainTxn = { id: uid('txn'), date: disposalDate, action:'Gain on Disposal', accountId: gainAcct.id, accountName: gainAcct.name, accountCategory: gainAcct.category, description: `Gain on disposal ${asset.name}`, amount: gainLossAmount, vatType:'none', vatAmount:0, wht:0, paye:0, contact:'' };
      pushTxn(gainTxn);
    } else if(gainLossAmount < 0){
      const lossAcct = b.accounts.find(a=>a.name==='Loss on Disposal') || { id:'', name:'Loss on Disposal', category:'Expense' };
      const lossTxn = { id: uid('txn'), date: disposalDate, action:'Loss on Disposal', accountId: lossAcct.id, accountName: lossAcct.name, accountCategory: lossAcct.category, description: `Loss on disposal ${asset.name}`, amount: Math.abs(gainLossAmount), vatType:'none', vatAmount:0, wht:0, paye:0, contact:'' };
      pushTxn(lossTxn);
    }

    addAudit('asset.dispose','asset', asset.id, `Disposed asset ${asset.name} proceeds:${fmt(proceeds)} gainLoss:${fmt(gainLossAmount)}`);
    saveState(); renderAll();
  }

  // tax & depreciation helpers
  function computeAccumulatedDepreciation(asset, uptoDate){
    // straight-line using asset.depRate (annual %) if present; otherwise derive from lifeYears
    const purchase = asset.purchaseDate || today();
    const start = new Date(purchase);
    const end = new Date(uptoDate || today());
    if(end < start) return 0;
    const days = (end - start) / (1000*60*60*24);
    const years = days / 365.0;
    let annualDep;
    if(asset.depRate && asset.depRate > 0){
      annualDep = (asset.cost || 0) * (asset.depRate / 100.0);
    } else if(asset.lifeYears && asset.lifeYears > 0){
      annualDep = (asset.cost || 0) / (asset.lifeYears || 1);
    } else {
      const defaultRate = asset.depRate || 0;
      annualDep = (asset.cost || 0) * (defaultRate/100);
    }
    const accum = annualDep * years;
    // cap at cost
    return Math.min(accum, asset.cost || 0);
  }

  function computeCapitalAllowance(asset, uptoDate){
    const purchase = asset.purchaseDate || today();
    const start = new Date(purchase);
    const end = new Date(uptoDate || today());
    if(end < start) return 0;
    const days = (end - start) / (1000*60*60*24);
    const years = days / 365.0;
    const annualCA = (asset.cost || 0) * ((asset.caPercent || 0) / 100.0);
    return annualCA * years;
  }

  function computePayeMonthlyFromMonthlySalary(monthlySalary){
    // annualize, compute annual PAYE using bands, then divide by 12
    const annual = monthlySalary * 12;
    let remaining = annual;
    let tax = 0;
    let lower = 0;
    for(const band of PAYE_BANDS){
      const upper = band.upTo;
      const taxable = Math.max(0, Math.min(remaining, upper - lower));
      tax += taxable * band.rate;
      remaining -= taxable;
      lower = upper;
      if(remaining <= 0) break;
    }
    return +(tax / 12.0);
  }

  // Reports / rendering
  function renderAll(){
    populateAccountSelect();
    populateAssetDisposal();
    renderLedger();
    renderPLSnapshot();
    renderTaxSummary();
    renderQuickLists();
    renderAuth();
    renderReportsDefaultIfNeeded();
  }

  function renderLedger(){
    ledgerTableBody.innerHTML = '';
    if(!selectedUserId || !selectedBizId) return;
    const rows = state.transactions[selectedUserId][selectedBizId] || [];
    const q = (document.getElementById('ledgerSearch').value||'').toLowerCase();
    for(const r of rows){
      const txt = JSON.stringify(r).toLowerCase();
      if(q && !txt.includes(q)) continue;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.date||''}</td><td>${r.action||''}</td><td>${r.accountName||''}</td><td>${r.description||''}</td><td>${fmt(r.amount||0)}</td><td>${fmt(r.vatAmount||0)}</td><td>${fmt(r.wht||0)}</td><td>${fmt(r.paye||0)}</td><td>${r.contact||''}</td><td>${r.receipt?'<span class="link-like">View</span>':''}</td><td><button class="small" data-id="${r.id}">Delete</button></td>`;
      const btn = tr.querySelector('button');
      btn.addEventListener('click', ()=> { if(!confirm('Delete transaction?')) return; deleteTransaction(r.id); });
      ledgerTableBody.appendChild(tr);
    }
  }

  function renderPLSnapshot(){
    const pl = computePLSnapshot();
    plSnapshotDiv.innerHTML = `<h3 style="margin:0 0 6px 0;">P&L Snapshot</h3>
      <div><strong>Revenue:</strong> ₦ ${fmt(pl.revenue)}</div>
      <div><strong>COGS:</strong> ₦ ${fmt(pl.cogs)}</div>
      <div><strong>Gross Profit:</strong> ₦ ${fmt(pl.gross)}</div>
      <div><strong>Expenses (excl depreciation):</strong> ₦ ${fmt(pl.expenses)}</div>
      <div><strong>Depreciation (reported):</strong> ₦ ${fmt(pl.depreciation)}</div>
      <div><strong>Total Expenses:</strong> ₦ ${fmt(pl.expenses + pl.depreciation)}</div>
      <div><strong>Net Profit:</strong> ₦ ${fmt(pl.net)}</div>
      `;
    plSnapshotQuick.innerHTML = plSnapshotDiv.innerHTML;
  }

  function computePLSnapshot(uptoDate){
    uptoDate = uptoDate || today();
    const b = findBiz(selectedBizId);
    if(!b) return { revenue:0, cogs:0, expenses:0, depreciation:0, gross:0, net:0 };
    const rows = state.transactions[selectedUserId][selectedBizId] || [];
    let revenue = 0, cogs = 0, expenses = 0;
    for(const r of rows){
      if(r.action === 'Revenue') revenue += Number(r.amount || 0);
      if(r.action === 'InventorySale' && r.cogs) cogs += Number(r.cogs || 0);
      if(r.accountCategory === 'Expense' && r.action !== 'Depreciation') expenses += Number(r.amount || 0);
      if(r.action === 'COGS') cogs += Number(r.amount || 0);
      if(r.action === 'Expense') expenses += Number(r.amount || 0);
    }
    // depreciation: compute dynamic depreciation for each non-disposed asset for the period up to uptoDate
    let depreciation = 0;
    for(const asset of b.assets || []){
      // if disposed and disposal.date <= uptoDate, compute depreciation up to disposal date only; otherwise up to uptoDate
      const end = (asset.disposed && asset.disposal && asset.disposal.date) ? (asset.disposal.date <= uptoDate ? asset.disposal.date : uptoDate) : uptoDate;
      if(new Date(end) < new Date(asset.purchaseDate)) continue;
      const accum = computeAccumulatedDepreciation(asset, end);
      // subtract any already posted accumulation (asset.accumulatedDep could be used to track previously recognized amounts)
      const posted = asset._postedDepForReports || 0; // internal ephemeral
      const toReport = Math.max(0, accum - posted);
      depreciation += toReport;
    }
    const gross = revenue - cogs;
    const net = gross - (expenses + depreciation);
    return { revenue, cogs, expenses, depreciation, gross, net };
  }

  function computeTaxSummary(uptoDate){
    uptoDate = uptoDate || today();
    const b = findBiz(selectedBizId); if(!b) return {};
    const rows = state.transactions[selectedUserId][selectedBizId] || [];
    // retain existing tax lines: VAT, WHT, PAYE, CIT/PIT
    let vatOutput = 0, vatInput = 0, whtTotal = 0, payeTotal = 0;
    let taxableProfit = 0, profitBeforeTaxAdjustments = 0;
    let depreciationTotal = 0;
    let capitalAllowanceTotal = 0;
    let disposalGains = 0, disposalLosses = 0;

    for(const r of rows){
      if(r.vatAmount && r.action === 'Revenue') vatOutput += r.vatAmount;
      if(r.vatAmount && (r.action === 'Expense' || r.action === 'InventoryPurchase' || r.action==='FixedAssetPurchase')) vatInput += r.vatAmount;
      if(r.wht) whtTotal += r.wht;
      if(r.action === 'PAYE' || (r.paye && r.paye>0)) payeTotal += Number(r.amount || r.paye || 0);
    }

    // Depreciation & CA across assets (prorated to uptoDate)
    for(const asset of (b.assets||[])){
      const end = (asset.disposed && asset.disposal && asset.disposal.date) ? (asset.disposal.date <= uptoDate ? asset.disposal.date : uptoDate) : uptoDate;
      if(new Date(end) < new Date(asset.purchaseDate)) continue;
      const accumDep = computeAccumulatedDepreciation(asset, end);
      const ca = computeCapitalAllowance(asset, end);
      depreciationTotal += accumDep;
      capitalAllowanceTotal += ca;
      if(asset.disposed && asset.disposal){
        const netBook = (asset.cost || 0) - accumDep;
        const gainLoss = (asset.disposal.proceeds || 0) - netBook;
        if(gainLoss > 0) disposalGains += gainLoss;
        else disposalLosses += Math.abs(gainLoss);
      }
    }

    // taxable profit baseline: business-level profit (revenue - cogs - expenses) using transactions ignoring depreciation but will apply CA as tax adjustment
    const pl = computePLSnapshot(uptoDate);
    profitBeforeTaxAdjustments = pl.net + (pl.depreciation || 0); // remove reported depreciation to start from expenses excluding depreciation
    // For taxable profit, treat depreciation as accounting expense but tax uses capital allowance: taxableProfit = profitBeforeTaxAdjustments + depreciation - capitalAllowance (i.e. add back depreciation, deduct CA)
    taxableProfit = profitBeforeTaxAdjustments + depreciationTotal - capitalAllowanceTotal;

    // Apply carry forward CA on business
    const caCarried = Math.max(0, b.caCarryForward || 0);
    const caApplied = Math.min(capitalAllowanceTotal + caCarried, taxableProfit > 0 ? taxableProfit : 0);
    const caCarriedForward = Math.max(0, (capitalAllowanceTotal + caCarried) - caApplied);

    // CIT or PIT application (simple)
    let taxOnProfit = 0;
    if(b.entity === 'Company' || b.citEnabled){
      const taxable = Math.max(0, taxableProfit - (b.lossBroughtForward || 0));
      taxOnProfit = taxable * (b.citRate/100);
    } else {
      // PIT shown separately elsewhere
      taxOnProfit = 0;
    }

    return {
      vatOutput, vatInput, vatPayable: vatOutput - vatInput,
      whtTotal, payeTotal,
      depreciationTotal, capitalAllowanceTotal, disposalGains, disposalLosses,
      taxableProfit, caApplied, caCarriedForward, profitBeforeTaxAdjustments, taxOnProfit
    };
  }

  function renderTaxSummary(){
    const b = findBiz(selectedBizId);
    if(!b) { taxSummaryDiv.innerHTML = ''; return; }
    const t = computeTaxSummary();
    let html = `<h3 style="margin:0 0 6px 0;">Tax Summary</h3>`;
    html += `<div><strong>VAT Output:</strong> ₦ ${fmt(t.vatOutput)} &nbsp; <strong>VAT Input:</strong> ₦ ${fmt(t.vatInput)} &nbsp; <strong>VAT Payable:</strong> ₦ ${fmt(t.vatPayable)}</div>`;
    html += `<div><strong>WHT total:</strong> ₦ ${fmt(t.whtTotal)}</div>`;
    html += `<div><strong>PAYE (posted):</strong> ₦ ${fmt(t.payeTotal)}</div>`;
    // Depreciation & CA lines visible when showLines is enabled
    if(b.showLines){
      html += `<div><strong>Depreciation (expense reported):</strong> ₦ ${fmt(t.depreciationTotal)}</div>`;
      html += `<div><strong>Capital Allowance (tax adjustment):</strong> ₦ ${fmt(t.capitalAllowanceTotal)} &nbsp; <small>Applied: ₦ ${fmt(t.caApplied)} &nbsp; Carried forward: ₦ ${fmt(t.caCarriedForward)}</small></div>`;
      html += `<div><strong>Disposals — Gains:</strong> ₦ ${fmt(t.disposalGains)} &nbsp; <strong>Losses:</strong> ₦ ${fmt(t.disposalLosses)}</div>`;
    }
    html += `<div><strong>Taxable profit (post tax adjustments):</strong> ₦ ${fmt(t.taxableProfit)}</div>`;
    if(b.entity === 'Company' || b.citEnabled) html += `<div><strong>CIT estimate:</strong> ₦ ${fmt(t.taxOnProfit)}</div>`;
    if((b.entity === 'SoleProprietor' || b.pitEnabled) && !b.citEnabled) html += `<div><strong>PIT:</strong> Shown when PIT calculations are run separately per sole proprietor (business-level taxable profit shown above)</div>`;
    taxSummaryDiv.innerHTML = html;
  }

  // Reports
  function renderReportsDefaultIfNeeded(){
    if(activeTab === 'reports'){
      // ensure a report is selected
      const first = document.querySelector('#reportsSection .tab.active');
      if(!first){
        const tb = document.querySelector('#reportsSection .tab');
        if(tb) { tb.classList.add('active'); renderReport(tb.dataset.report); }
      }
    }
  }

  function renderReport(name){
    reportContent.innerHTML = '';
    if(name === 'taxReconciliation'){
      reportContent.innerHTML = `<pre>${JSON.stringify(computeTaxSummary(), null, 2)}</pre>`;
    } else if(name === 'assetsReport'){
      const b = findBiz(selectedBizId) || {};
      reportContent.innerHTML = `<pre>${JSON.stringify(b.assets || [], null, 2)}</pre>`;
    } else {
      reportContent.innerHTML = `<div>Report: ${name}</div>`;
    }
  }

  function exportCurrentReport(fmtType){ alert('Export '+fmtType+' not implemented for prototype'); }

  function renderQuickLists(){
    const b = findBiz(selectedBizId) || {};
    inventoryListDiv.innerHTML = (b.inventory || []).map(i=>`<div>${i.name} — qty: ${i.qty} avg cost: ₦${fmt(i.avgCost)}</div>`).join('');
    assetListDiv.innerHTML = (b.assets || []).map(a=>`<div>${a.name} — cost: ₦${fmt(a.cost)} accDep: ₦${fmt(a.accumulatedDep||0)} ${a.disposed?'<strong>(disposed)</strong>':''}</div>`).join('');
  }

  function renderAuth(){
    const u = findUser(selectedUserId);
    document.getElementById('authInfo').textContent = u ? (u.display || u.username) : '';
  }

  function renderFeatureVisibility(){
    // show/hide parts depending on selection
    const b = findBiz(selectedBizId);
    const isSole = b && (b.entity === 'SoleProprietor' || b.pitEnabled);
    // if sole proprietor, show PIT note and hide CIT note
    // This is just UI text; the tax summary already respects entity mapping
  }

  function deleteTransaction(id){
    const arr = state.transactions[selectedUserId][selectedBizId] || [];
    const idx = arr.findIndex(x=>x.id===id);
    if(idx>=0){ arr.splice(idx,1); saveState(); addAudit('txn.delete','transaction',id,'Deleted transaction'); renderAll(); }
  }

  function deleteUser(id){ const idx = state.users.findIndex(u=>u.id===id); if(idx>=0){ state.users.splice(idx,1); delete state.transactions[id]; saveState(); refreshSelectors(); ensureSelection(); renderAll(); } }
  function deleteBusiness(id){ const idx = state.businesses.findIndex(u=>u.id===id); if(idx>=0){ state.businesses.splice(idx,1); for(const u of state.users) { if(state.transactions[u.id]) delete state.transactions[u.id][id]; } saveState(); refreshSelectors(); ensureSelection(); renderAll(); } }

  function openUserModal(editId){
    userModalTitle.textContent = editId ? 'Edit User' : 'Add User';
    userName.value = ''; userDisplay.value = ''; permView.checked = permEdit.checked = permDelete.checked = false;
    userSave.dataset.edit = editId || '';
    if(editId){ const u = findUser(editId); userName.value = u.username; userDisplay.value = u.display; userRole.value = u.role; permView.checked = !!u.permissions?.view; permEdit.checked = !!u.permissions?.edit; permDelete.checked = !!u.permissions?.delete; }
    openModal(userModal);
  }

  function renderBizContacts(b){
    bizContactsList.innerHTML = '';
    if(!b) return;
    for(const c of b.contacts || []){ const div = document.createElement('div'); div.textContent = `${c.name} (${c.type})`; bizContactsList.appendChild(div); }
  }

  function renderAccounts(){
    accountsList.innerHTML = '';
    const b = findBiz(selectedBizId) || {};
    for(const a of (b.accounts || [])){
      const div = document.createElement('div'); div.className='account-row';
      div.innerHTML = `<div><strong>${a.name}</strong> <span class="small-muted">(${a.category})</span></div><div><button class="small" data-id="${a.id}">Delete</button></div>`;
      accountsList.appendChild(div);
      div.querySelector('button').addEventListener('click', ()=> { if(!confirm('Delete account?')) return; b.accounts = b.accounts.filter(x=>x.id!==a.id); saveState(); renderAccounts(); populateAccountSelect(); });
    }
  }

  function renderReportsTab(){
    // ensure at least first tab active
    const tb = document.querySelector('#reportsSection .tab.active') || document.querySelector('#reportsSection .tab');
    if(tb) renderReport(tb.dataset.report);
  }

  function renderTab(){
    if(activeTab === 'ledger'){ ledgerSection.style.display='block'; reportsSection.style.display='none'; btnLedgerTab.classList.add('active'); btnReportsTab.classList.remove('active'); }
    else { ledgerSection.style.display='none'; reportsSection.style.display='block'; btnLedgerTab.classList.remove('active'); btnReportsTab.classList.add('active'); renderReportsTab(); }
  }

  // initial render
  renderTab();
  renderAll();

  </script>
</body>
</html>
[End updated index.html]

If you want, I can:
- Produce a git patch or create a new branch and open a pull request that replaces index.html in your repo (I have instructions/patterns to prepare a commit message and file content).
- Or further refine PIT calculation details (I left PIT as a business-level separate calculation — I can implement PIT bands and per-sole-trader deductions if you'd like).
- Or add persistent monthly depreciation journals (currently depreciation is calculated dynamically for reports and disposal; only disposal posts a one-off depreciation transaction).

Which of the three actions would you like next: (A) prepare a branch/PR with this file, (B) refine PIT calculations and statutory deductions per contact, or (C) add persistent monthly journal entries for depreciation?
