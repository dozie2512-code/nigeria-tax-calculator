Here is the full, self-contained index.html with the requested changes:
- VAT, WHT and PAYE inputs removed from the Add Transaction UI.
- Replaced that area with a Fixed Asset control that lets the user create an asset from the transaction or link an existing asset.
- Added an embedded Inventory subform to the Add Transaction area with three modes: Add item, Record purchase, Record sale. Those run as inline actions (after creating the transaction).
- Keeps the rest of the app behavior (users, businesses, transactions, fixed assets, inventory, persistence) and provides working UI/JS for the new controls.

Save this file as index.html (replace your existing file) in the repository root.

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Tax & Accounting — Multi-business</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background:#fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"], textarea { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary, .wht-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(920px,96vw); }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .inline-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:start; }
    .field { display:flex; flex-direction:column; gap:4px; }
    .result-box { background:#fff; padding:10px; border:1px solid #eef2f6; border-radius:6px; margin-top:8px; }
    .result-row { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:4px 0; }
    table.paye-table { width:100%; border-collapse:collapse; margin-top:8px; }
    table.paye-table th, table.paye-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; background:#fff; }
    table.paye-table th { background:#f5f8fb; }
    .nowrap { white-space:nowrap; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .inventory-list { margin-top:8px; }
    .bank-table { width:100%; border-collapse:collapse; margin-top:8px; }
    .bank-table th, .bank-table td { border:1px solid #ddd; padding:6px; }
    .reconcile-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Tax & Accounting — Multi-business</h1>

    <div class="controls panel">
      <label for="userSelect">User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>

      <label for="businessSelect">Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
    </div>

    <div class="spacer"></div>

    <div style="display:flex;gap:8px;align-items:center;">
      <label class="muted-inline">Tax year:
        <select id="taxYearSelect" style="margin-left:6px;"></select>
      </label>
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2>Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <label>Account: <select id="txnAccount"></select></label>
        <button class="small" id="btnAddAccountInline">+ Account</button>
        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
        <label>Contact: <select id="txnContact"></select></label>
        <button class="small" id="btnAddContactInline">+ Contact</button>

        <!-- Fixed Asset field: allow link existing OR create new -->
        <label>Fixed asset action:
          <select id="txnFixedAssetAction">
            <option value="none">None</option>
            <option value="create">Create asset from this transaction</option>
            <option value="link">Link existing asset</option>
          </select>
        </label>
        <label id="txnFixedAssetNameLabel" class="hidden">Asset name: <input type="text" id="txnFixedAssetName" placeholder="Asset name" /></label>
        <label id="txnFixedAssetLifeLabel" class="hidden">Useful life (yrs): <input type="number" id="txnFixedAssetLife" min="1" step="1" value="4" style="width:80px;" /></label>
        <label id="txnFixedAssetExistingLabel" class="hidden">Select asset: <select id="txnFixedAssetExisting"></select></label>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <!-- Removed VAT/WHT/PAYE input fields from Add Transaction as requested -->
        <label>Bank account: <select id="txnBankAccount"></select></label>
        <label><input type="checkbox" id="txnReconciled" /> Mark reconciled</label>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>

      <div style="margin-top:10px;">
        <label>Inventory action:
          <select id="txnInventoryAction">
            <option value="none">None</option>
            <option value="add">Add inventory item</option>
            <option value="purchase">Record purchase</option>
            <option value="sale">Record sale</option>
          </select>
        </label>

        <!-- Inline inventory subforms -->
        <div id="txnInvAdd" class="hidden" style="margin-top:8px;">
          <div class="row">
            <label>Item name: <input type="text" id="txnInvName" /></label>
            <label>SKU: <input type="text" id="txnInvSku" /></label>
            <label>Opening qty: <input type="number" id="txnInvQty" step="1" value="0" style="width:100px;" /></label>
            <label>Opening avg cost (₦): <input type="number" id="txnInvCost" step="0.01" style="width:140px;" /></label>
          </div>
        </div>

        <div id="txnInvPurchase" class="hidden" style="margin-top:8px;">
          <div class="row">
            <label>Item: <select id="txnPurchaseItem"></select></label>
            <label>Date: <input type="date" id="txnPurchaseDate" /></label>
            <label>Quantity: <input type="number" id="txnPurchaseQty" step="1" style="width:100px;" /></label>
            <label>Total cost (₦): <input type="number" id="txnPurchaseTotalCost" step="0.01" style="width:140px;" /></label>
            <label>Purchase account: <select id="txnPurchaseAccount"></select></label>
          </div>
        </div>

        <div id="txnInvSale" class="hidden" style="margin-top:8px;">
          <div class="row">
            <label>Item: <select id="txnSellItem"></select></label>
            <label>Date: <input type="date" id="txnSellDate" /></label>
            <label>Quantity: <input type="number" id="txnSellQty" step="1" style="width:100px;" /></label>
            <label>Sale amount (₦): <input type="number" id="txnSellAmount" step="0.01" style="width:140px;" /></label>
            <label>Revenue account: <select id="txnSellRevenueAccount"></select></label>
            <label>Contact: <select id="txnSellContact"></select></label>
          </div>
        </div>

        <small class="note">When you add a transaction you may also perform one embedded inventory action. Inventory actions run after the transaction is created.</small>
      </div>

      <small class="note">Transactions saved per business. Creating an asset from a transaction will add a fixed asset record. Tax entry fields were removed from the Add Transaction form.</small>
    </section>

    <section class="panel section">
      <h2>Transactions Ledger</h2>
      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable" aria-live="polite">
        <thead>
          <tr><th>Date</th><th>Description</th><th>Account</th><th>Amount (₦)</th><th>Contact</th><th>Bank</th><th>Tags</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section" id="taxableFromNetProfitPanel">
      <h2>Taxable Income — From Net profit A</h2>
      <div class="inline-grid">
        <div>
          <div class="field">
            <label>Net profit A (₦): <input type="number" id="netProfitA" step="0.01" /></label>
            <small class="muted">Accounting net profit (profit after operating items). Leave blank to compute from Chart of Accounts.</small>
          </div>

          <div class="field">
            <label>Disallowable expenses to add back (₦): <input type="number" id="disallowable" step="0.01" /></label>
          </div>

          <div class="field">
            <label>Non-taxable income (₦): <input type="number" id="nonTaxableIncome" step="0.01" /></label>
            <small class="muted">User-specified non-taxable income in addition to automatic tags (e.g., disposal proceeds flagged non-taxable)</small>
          </div>

          <div class="field">
            <label>Capital allowances (₦) (auto): <input type="text" id="capitalAllowances" readonly /></label>
            <small class="muted">Computed capital allowances (2/3 applied automatically for tax year)</small>
          </div>

          <div class="field">
            <label>Prior unrelieved losses (₦): <input type="number" id="priorLosses" step="0.01" /></label>
          </div>

          <div class="field">
            <label>Other adjustments (₦): <input type="number" id="otherAdjustments" step="0.01" /></label>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
            <button class="primary" id="btnComputeTaxable">Compute Taxable Income</button>
            <label style="margin-left:8px;"><input type="checkbox" id="saveTaxAdjToBusiness" /> Save adjustments to business</label>
            <button id="btnLoadFromBusiness" class="small">Load saved adjustments</button>
          </div>
        </div>

        <div class="tax-results">
          <div id="taxableResult" class="result-box" style="display:none;">
            <div class="result-row"><div><strong>Taxable income</strong></div><div>₦ <span id="taxableResultValue">0</span></div></div>
            <div id="taxableBreakdown" style="margin-top:6px;"></div>
          </div>

          <div id="pitResult" class="result-box" style="display:none;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>Estimated PIT (annual)</strong></div>
              <div style="text-align:right;">
                <div>₦ <span id="pitAnnualValue">0</span></div>
                <div class="muted" style="font-size:0.9rem;">Monthly: ₦ <span id="pitMonthlyValue">0</span></div>
              </div>
            </div>
            <div id="pitNotes" style="margin-top:8px;" class="muted"></div>
          </div>

          <div id="citResult" class="result-box" style="display:none;">
            <div class="result-row"><div><strong>Estimated Company Income Tax (CIT)</strong></div><div>₦ <span id="citValue">0</span></div></div>
            <div id="citNotes" style="margin-top:6px;" class="muted"></div>
          </div>

          <div id="capAllowApplyBox" class="result-box" style="display:none;">
            <div class="result-row"><div><strong>Capital allowance available</strong></div><div>₦ <span id="capAllowAvailable">0</span></div></div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button id="btnApplyCarryforwards" class="small">Apply carryforward (persist)</button>
              <button id="btnResetCarryforwards" class="small">Reset carryforward</button>
            </div>
          </div>
        </div>
      </div>

      <small class="muted">Formula: Taxable income = Net profit A + Disallowable addbacks - Non-taxable income - Capital allowances applied - Prior losses + Other adjustments</small>
    </section>

    <section class="panel section" id="assetsPanel">
      <h2>Fixed Assets</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="btnAddAsset" class="small">+ Add Asset</button>
        <button id="btnImportAssets" class="small">Import Assets</button>
        <button id="btnOpenDispose" class="small">Dispose Asset</button>
      </div>
      <div id="fixedAssetsList" style="margin-top:8px;"></div>

      <!-- Quick inventory buttons (scroll & focus existing Inventory fields) -->
      <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
        <button id="btnQuickAddInventory" class="small">+ Add inventory</button>
        <button id="btnQuickRecordPurchase" class="small">Record purchase</button>
        <button id="btnQuickRecordSale" class="small">Record sale</button>
      </div>
    </section>

    <section class="panel section" id="inventoryPanel">
      <h2>Inventory</h2>
      <div class="two-col">
        <div>
          <div class="row">
            <label>Item name: <input type="text" id="invName" /></label>
            <label>SKU: <input type="text" id="invSku" /></label>
            <label>Opening qty: <input type="number" id="invQty" step="1" value="0" style="width:100px;" /></label>
            <label>Opening avg cost (₦): <input type="number" id="invCost" step="0.01" style="width:140px;" /></label>
            <button class="small" id="btnAddInvItem">Add Item</button>
          </div>

          <div style="margin-top:10px;">
            <h4>Purchase (add stock)</h4>
            <div class="row">
              <label>Item: <select id="purchaseItem"></select></label>
              <label>Date: <input type="date" id="purchaseDate" /></label>
              <label>Quantity: <input type="number" id="purchaseQty" step="1" style="width:100px;" /></label>
              <label>Total cost (₦): <input type="number" id="purchaseTotalCost" step="0.01" style="width:140px;" /></label>
              <label>Purchase account: <select id="purchaseAccount"></select></label>
              <button class="small" id="btnPurchase">Record Purchase</button>
            </div>
          </div>

          <div style="margin-top:10px;">
            <h4>Sell (create sale + COGS)</h4>
            <div class="row">
              <label>Item: <select id="sellItem"></select></label>
              <label>Date: <input type="date" id="sellDate" /></label>
              <label>Quantity: <input type="number" id="sellQty" step="1" style="width:100px;" /></label>
              <label>Sale amount (₦): <input type="number" id="sellAmount" step="0.01" style="width:140px;" /></label>
              <label>Revenue account: <select id="sellRevenueAccount"></select></label>
              <label>Contact: <select id="sellContact"></select></label>
              <button class="small" id="btnSell">Record Sale</button>
            </div>
          </div>
        </div>

        <div>
          <h4>Inventory list</h4>
          <div id="inventoryList" class="inventory-list"></div>
          <div class="result-box" style="margin-top:8px;">
            <div class="result-row"><div><strong>Total stock value</strong></div><div>₦ <span id="totalStockValue">0</span></div></div>
          </div>
        </div>
      </div>
      <small class="muted">Average-cost (weighted) method used for COGS. Selling creates revenue transaction and an automatic COGS expense transaction.</small>
    </section>

    <section class="panel section" id="reportsPanel">
      <h2>Reports & Bank Reconciliation</h2>

      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <label>Report year: <select id="reportYearSelect"></select></label>
        <button id="btnGenerateReport" class="small">Generate</button>
        <button id="btnExportReport" class="small">Export JSON</button>
        <button id="btnPrintReport" class="small">Printable view</button>
      </div>

      <div id="reportResults" style="margin-top:8px;"></div>

      <div style="margin-top:12px;">
        <h4>Bank accounts & Reconciliation</h4>
        <div class="row">
          <label>Select bank account: <select id="bankAccountSelect"></select></label>
          <label>Opening balance for year: <input type="number" id="bankOpeningBalance" step="0.01" style="width:140px;" /></label>
          <button id="btnSaveOpeningBalance" class="small">Save</button>
        </div>

        <div style="margin-top:8px;">
          <label>Paste bank statement lines (one per line: date,description,amount):</label>
          <textarea id="bankStatementInput" rows="4" style="width:100%;"></textarea>
          <div style="display:flex;gap:8px;margin-top:6px;">
            <button id="btnParseBankStatement" class="small">Parse lines</button>
            <button id="btnClearBankStatement" class="small">Clear</button>
          </div>
        </div>

        <div id="bankStatementParsed" style="margin-top:8px;"></div>

        <div style="margin-top:8px;">
          <h5>Transactions (select to mark reconciled)</h5>
          <div id="bankTxList"></div>
        </div>
      </div>

      <small class="muted">Reconciliation is manual: parse or paste your statement lines and match them to application transactions. Matched transactions will be marked reconciled and saved to the business.</small>
    </section>

  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true"></div>

  <div id="assetModal" class="modal" aria-hidden="true">
    <h3 id="assetModalTitle">Add / Edit Fixed Asset</h3>
    <div class="row">
      <label>Name: <input type="text" id="assetName" /></label>
      <label>Account: <select id="assetAccount"></select></label>
    </div>
    <div class="row">
      <label>Cost (₦): <input type="number" id="assetCost" step="0.01" /></label>
      <label>Date acquired: <input type="date" id="assetDate" /></label>
      <label>Useful life (yrs): <input type="number" id="assetLife" min="1" step="1" value="4" style="width:80px" /></label>
    </div>
    <div class="row">
      <label>Opening accumulated depreciation (₦): <input type="number" id="assetAccum" step="0.01" value="0" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="assetCancel">Cancel</button>
      <button class="primary" id="assetSave">Save</button>
    </div>
  </div>

  <div id="disposeModal" class="modal" aria-hidden="true">
    <h3>Dispose Asset</h3>
    <div class="row">
      <label>Asset: <select id="disposeAssetSelect"></select></label>
      <label>Disposal date: <input type="date" id="disposeDate" /></label>
      <label>Proceeds (₦): <input type="number" id="disposeProceeds" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="disposeCancel">Cancel</button>
      <button class="primary" id="disposeConfirm">Dispose</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant
    const STORAGE_KEY = 'ntc_data_v6';
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };
    const DEFAULT_USEFUL_LIFE_YEARS = 4;

    let data = { users: [], businesses: [], transactions: {} };
    let selectedUserId = null;
    let selectedBusinessId = null;

    // DOM refs
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const taxYearSelect = document.getElementById('taxYearSelect');
    const txnDate = document.getElementById('txnDate');
    const txnDesc = document.getElementById('txnDesc');
    const txnAmount = document.getElementById('txnAmount');
    const txnContact = document.getElementById('txnContact');
    const txnAccount = document.getElementById('txnAccount');
    // Fixed asset controls
    const txnFixedAssetAction = document.getElementById('txnFixedAssetAction');
    const txnFixedAssetName = document.getElementById('txnFixedAssetName');
    const txnFixedAssetLife = document.getElementById('txnFixedAssetLife');
    const txnFixedAssetExisting = document.getElementById('txnFixedAssetExisting');
    const txnFixedAssetNameLabel = document.getElementById('txnFixedAssetNameLabel');
    const txnFixedAssetLifeLabel = document.getElementById('txnFixedAssetLifeLabel');
    const txnFixedAssetExistingLabel = document.getElementById('txnFixedAssetExistingLabel');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');
    const fixedAssetsListDiv = document.getElementById('fixedAssetsList');

    const txnBankAccountSelect = document.getElementById('txnBankAccount');
    const txnReconciledCheckbox = document.getElementById('txnReconciled');

    const netProfitAInput = document.getElementById('netProfitA');
    const disallowableInput = document.getElementById('disallowable');
    const nonTaxableInput = document.getElementById('nonTaxableIncome');
    const capitalAllowancesInput = document.getElementById('capitalAllowances');
    const priorLossesInput = document.getElementById('priorLosses');
    const otherAdjustmentsInput = document.getElementById('otherAdjustments');
    const btnComputeTaxable = document.getElementById('btnComputeTaxable');

    // asset modal refs
    const assetModal = document.getElementById('assetModal');
    const assetNameInput = document.getElementById('assetName');
    const assetAccountSelect = document.getElementById('assetAccount');
    const assetCostInput = document.getElementById('assetCost');
    const assetDateInput = document.getElementById('assetDate');
    const assetLifeInput = document.getElementById('assetLife');
    const assetAccumInput = document.getElementById('assetAccum');
    const assetCancel = document.getElementById('assetCancel');
    const assetSave = document.getElementById('assetSave');
    const btnAddAsset = document.getElementById('btnAddAsset');

    // dispose modal refs
    const disposeModal = document.getElementById('disposeModal');
    const disposeAssetSelect = document.getElementById('disposeAssetSelect');
    const disposeDate = document.getElementById('disposeDate');
    const disposeProceeds = document.getElementById('disposeProceeds');
    const disposeCancel = document.getElementById('disposeCancel');
    const disposeConfirm = document.getElementById('disposeConfirm');
    const btnOpenDispose = document.getElementById('btnOpenDispose');

    // inventory refs (existing panels)
    const invNameInput = document.getElementById('invName');
    const invSkuInput = document.getElementById('invSku');
    const invQtyInput = document.getElementById('invQty');
    const invCostInput = document.getElementById('invCost');
    const btnAddInvItem = document.getElementById('btnAddInvItem');
    const purchaseItemSelect = document.getElementById('purchaseItem');
    const purchaseDate = document.getElementById('purchaseDate');
    const purchaseQty = document.getElementById('purchaseQty');
    const purchaseTotalCost = document.getElementById('purchaseTotalCost');
    const purchaseAccountSelect = document.getElementById('purchaseAccount');
    const btnPurchase = document.getElementById('btnPurchase');
    const sellItemSelect = document.getElementById('sellItem');
    const sellDate = document.getElementById('sellDate');
    const sellQtyInput = document.getElementById('sellQty');
    const sellAmountInput = document.getElementById('sellAmount');
    const sellRevenueAccount = document.getElementById('sellRevenueAccount');
    const sellContactSelect = document.getElementById('sellContact');
    const btnSell = document.getElementById('btnSell');
    const inventoryListDiv = document.getElementById('inventoryList');
    const totalStockValueSpan = document.getElementById('totalStockValue');

    // inline inventory fields in Add Transaction
    const txnInventoryAction = document.getElementById('txnInventoryAction');
    const txnInvAdd = document.getElementById('txnInvAdd');
    const txnInvPurchase = document.getElementById('txnInvPurchase');
    const txnInvSale = document.getElementById('txnInvSale');

    const txnInvName = document.getElementById('txnInvName');
    const txnInvSku = document.getElementById('txnInvSku');
    const txnInvQty = document.getElementById('txnInvQty');
    const txnInvCost = document.getElementById('txnInvCost');

    const txnPurchaseItem = document.getElementById('txnPurchaseItem');
    const txnPurchaseDate = document.getElementById('txnPurchaseDate');
    const txnPurchaseQty = document.getElementById('txnPurchaseQty');
    const txnPurchaseTotalCost = document.getElementById('txnPurchaseTotalCost');
    const txnPurchaseAccount = document.getElementById('txnPurchaseAccount');

    const txnSellItem = document.getElementById('txnSellItem');
    const txnSellDate = document.getElementById('txnSellDate');
    const txnSellQty = document.getElementById('txnSellQty');
    const txnSellAmount = document.getElementById('txnSellAmount');
    const txnSellRevenueAccount = document.getElementById('txnSellRevenueAccount');
    const txnSellContact = document.getElementById('txnSellContact');

    // quick inventory buttons (DOM refs)
    const btnQuickAddInventory = document.getElementById('btnQuickAddInventory');
    const btnQuickRecordPurchase = document.getElementById('btnQuickRecordPurchase');
    const btnQuickRecordSale = document.getElementById('btnQuickRecordSale');

    // reports refs
    const reportYearSelect = document.getElementById('reportYearSelect');
    const btnGenerateReport = document.getElementById('btnGenerateReport');

    // bank refs
    const bankAccountSelect = document.getElementById('bankAccountSelect');
    const bankOpeningBalanceInput = document.getElementById('bankOpeningBalance');
    const btnSaveOpeningBalance = document.getElementById('btnSaveOpeningBalance');
    const bankStatementInput = document.getElementById('bankStatementInput');
    const btnParseBankStatement = document.getElementById('btnParseBankStatement');
    const btnClearBankStatement = document.getElementById('btnClearBankStatement');
    const bankStatementParsedDiv = document.getElementById('bankStatementParsed');
    const bankTxListDiv = document.getElementById('bankTxList');

    // other controls
    const btnAddUser = document.getElementById('btnAddUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnAddAccountInline = document.getElementById('btnAddAccountInline');
    const btnAddContactInline = document.getElementById('btnAddContactInline');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');

    function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function fmt(n){ n = Number(n)||0; return n.toLocaleString('en-NG', { maximumFractionDigits:2, minimumFractionDigits: (n%1===0?0:2) }); }

    function saveData(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e){ console.error('save failed', e); alert('Save failed'); } }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try {
          data = JSON.parse(raw);
        } catch(e){
          console.warn('Invalid saved data, creating demo', e);
          initializeDemo();
        }
      }
      if (!data || !Array.isArray(data.users) || !Array.isArray(data.businesses)) initializeDemo();
      // normalize
      data.businesses.forEach(b=>{
        if (!Array.isArray(b.contacts)) b.contacts = [];
        if (!Array.isArray(b.accounts)) b.accounts = [];
        if (!Array.isArray(b.fixedAssets)) b.fixedAssets = [];
        if (!Array.isArray(b.inventory)) b.inventory = [];
        if (!Array.isArray(b.bankStatements)) b.bankStatements = [];
        if (!b.accountOpeningBalances) b.accountOpeningBalances = {}; // { accountId: { year: amount } } simplified
        if (!data.transactions[b.id]) data.transactions[b.id] = [];
        if (!b.pit) b.pit = DEFAULT_PIT;
        if (!b.taxCarryforward) b.taxCarryforward = { capitalAllowances: 0, priorLosses: 0 };
        if (typeof b.vatRate !== 'number') b.vatRate = 7.5;
        if (typeof b.vatEnabled === 'undefined') b.vatEnabled = true;
        if (typeof b.pitEnabled === 'undefined') b.pitEnabled = true;
        if (!Array.isArray(b.bankAccounts)) b.bankAccounts = []; // store explicit bank account ids
        // ensure existing transactions have taxes/reconciled fields if missing
        const txs = data.transactions[b.id] || [];
        txs.forEach(t=>{
          if (!t.taxes) t.taxes = { vat: 0, wht: 0, paye: 0 };
          if (typeof t.reconciled === 'undefined') t.reconciled = false;
          if (typeof t.bankAccountId === 'undefined') t.bankAccountId = '';
        });
      });
      if (!selectedUserId && data.users[0]) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses[0]) selectedBusinessId = data.businesses[0].id;
    }

    function initializeDemo(){
      const u = { id: uid('user'), username: 'demo', display: 'Demo User' };
      const b = {
        id: uid('biz'),
        name: 'Demo Business',
        ownerId: u.id,
        members: [u.id],
        vatRate: 7.5,
        currency: '₦',
        threshold: 800000,
        notes: '',
        vatEnabled: true,
        pitEnabled: true,
        vatInclusive: false,
        pit: DEFAULT_PIT,
        taxCarryforward: { capitalAllowances: 0, priorLosses: 0 },
        contacts: [],
        accounts: [],
        fixedAssets: [],
        inventory: [],
        bankAccounts: [],
        bankStatements: [],
        accountOpeningBalances: {}
      };

      const accounts = [
        { id: uid('a'), code: '1000', name: 'Cash / Bank', type: 'Bank' },
        { id: uid('a2'), code: '2000', name: 'Accounts Payable', type: 'Liability' },
        { id: uid('a3'), code: '4000', name: 'Sales Revenue', type: 'Revenue' },
        { id: uid('a4'), code: '5000', name: 'Rent Expense', type: 'Expense' },
        { id: uid('a5'), code: '5100', name: 'Purchases', type: 'Expense' },
        { id: uid('a6'), code: '5200', name: 'Cost of Goods Sold', type: 'Expense' }
      ];
      b.accounts = accounts;
      // mark bank account
      b.bankAccounts = [accounts[0].id];
      // initial inventory demo
      b.inventory = [
        { id: uid('inv'), sku: 'SKU-001', name: 'Demo Item', qtyOnHand: 10, avgCost: 5000, lots: [] }
      ];
      const now = new Date().toISOString().slice(0,10);
      data = { users: [u], businesses: [b], transactions: {} };
      data.transactions[b.id] = [
        { id: uid('t'), date: now, desc: 'Demo sale', amount: 1500000, authorUserId: u.id, contactId: '', accountId: accounts.find(a=>a.type==='Revenue').id, taxes: { vat: 0, wht: 0, paye: 0 }, reconciled: false, bankAccountId: '', tags: [] },
        { id: uid('t2'), date: now, desc: 'Demo rent', amount: 200000, authorUserId: u.id, contactId: '', accountId: accounts.find(a=>a.code==='5000').id, taxes:{ vat:0,wht:0,paye:0 }, reconciled:false, bankAccountId:'', tags:[] }
      ];
      selectedUserId = u.id;
      selectedBusinessId = b.id;
      saveData();
    }

    function findBiz(id){ return data.businesses.find(x=>x.id===id) || null; }
    function findAccount(bizId, accId){ const b = findBiz(bizId); if(!b) return null; return b.accounts.find(a=>a.id===accId) || null; }
    function findAccountByCodeOrName(biz, matcher){
      if (!biz) return null;
      return biz.accounts.find(a => (a.code && a.code === matcher) || (a.name && a.name.toLowerCase().includes(String(matcher).toLowerCase())));
    }

    // Populate selectors
    function populateSelectors(){
      userSelect.innerHTML = '';
      businessSelect.innerHTML = '';
      data.users.forEach(u=>{ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); });
      data.businesses.forEach(b=>{ const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name; businessSelect.appendChild(opt); });
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      populateTaxYears();
      populateTxnContactAccount();
      populateInventorySelectors();
      populateReportYears();
      renderAll();
    }

    function populateTaxYears(){
      const now = new Date(); const defaultYear = now.getFullYear() - 1;
      taxYearSelect.innerHTML = '';
      for (let y = defaultYear - 3; y <= defaultYear + 2; y++){
        const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y);
        if (y === defaultYear) opt.selected = true;
        taxYearSelect.appendChild(opt);
      }
    }

    function populateReportYears(){
      reportYearSelect.innerHTML = '';
      const now = new Date(); const defaultYear = now.getFullYear() - 1;
      for (let y = defaultYear - 3; y <= defaultYear + 2; y++){
        const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y);
        if (y === defaultYear) opt.selected = true;
        reportYearSelect.appendChild(opt);
      }
      reportYearSelect.value = String(defaultYear);
    }

    function populateTxnContactAccount(){
      const b = findBiz(selectedBusinessId);
      txnContact.innerHTML = ''; txnAccount.innerHTML = ''; assetAccountSelect.innerHTML = ''; disposeAssetSelect.innerHTML = ''; txnBankAccountSelect.innerHTML = '';
      purchaseAccountSelect.innerHTML = ''; sellRevenueAccount.innerHTML = ''; sellContactSelect.innerHTML = ''; sellItemSelect.innerHTML = ''; purchaseItemSelect.innerHTML = ''; bankAccountSelect.innerHTML = '';
      txnFixedAssetExisting.innerHTML = ''; txnPurchaseItem.innerHTML = ''; txnSellItem.innerHTML = ''; txnPurchaseAccount.innerHTML = ''; txnSellRevenueAccount.innerHTML = ''; txnSellContact.innerHTML = '';

      if (!b) return;
      const emptyC = document.createElement('option'); emptyC.value=''; emptyC.textContent='-- select --'; txnContact.appendChild(emptyC);
      b.contacts.forEach(c=>{ const opt = document.createElement('option'); opt.value=c.id; opt.textContent=c.name + ' (' + (c.type||'') + ')'; txnContact.appendChild(opt); });
      const emptyA = document.createElement('option'); emptyA.value=''; emptyA.textContent='-- select --'; txnAccount.appendChild(emptyA);
      const emptyAssetAcct = document.createElement('option'); emptyAssetAcct.value=''; emptyAssetAcct.textContent='-- select --'; assetAccountSelect.appendChild(emptyAssetAcct);

      b.accounts.forEach(a=>{
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = (a.code||'') + ' - ' + a.name + ' (' + a.type + ')';
        txnAccount.appendChild(opt);
        // asset account select for assets modal
        const opt2 = opt.cloneNode(true);
        assetAccountSelect.appendChild(opt2);
        // purchase account
        const opt3 = opt.cloneNode(true);
        purchaseAccountSelect.appendChild(opt3);
        // sell revenue account
        const opt4 = opt.cloneNode(true);
        sellRevenueAccount.appendChild(opt4);

        // inline purchase/sell selects
        const pOpt = opt.cloneNode(true);
        txnPurchaseAccount.appendChild(pOpt);
        const rOpt = opt.cloneNode(true);
        txnSellRevenueAccount.appendChild(rOpt);

        // bank accounts for txn
        if (a.type === 'Bank' || a.code === '1000' || a.name.toLowerCase().includes('bank') || b.bankAccounts.includes(a.id)){
          const ba = document.createElement('option');
          ba.value = a.id;
          ba.textContent = (a.code||'') + ' - ' + a.name;
          txnBankAccountSelect.appendChild(ba);
          const ba2 = ba.cloneNode(true);
          bankAccountSelect.appendChild(ba2);
        }
      });

      // If no explicit bank accounts, add first Asset named Cash or code 1000
      if (txnBankAccountSelect.children.length === 0){
        const found = b.accounts.find(a => a.code === '1000' || a.name.toLowerCase().includes('cash') || a.type === 'Bank');
        if (found){
          const ba = document.createElement('option');
          ba.value = found.id;
          ba.textContent = (found.code||'') + ' - ' + found.name;
          txnBankAccountSelect.appendChild(ba);
          const ba2 = ba.cloneNode(true);
          bankAccountSelect.appendChild(ba2);
        } else if (b.accounts[0]){
          const ba = document.createElement('option');
          ba.value = b.accounts[0].id;
          ba.textContent = (b.accounts[0].code||'') + ' - ' + b.accounts[0].name;
          txnBankAccountSelect.appendChild(ba);
          const ba2 = ba.cloneNode(true);
          bankAccountSelect.appendChild(ba2);
        }
      }

      // dispose assets select
      const e = document.createElement('option'); e.value=''; e.textContent='-- select asset --'; disposeAssetSelect.appendChild(e);
      b.fixedAssets.forEach(f=>{ const opt = document.createElement('option'); opt.value = f.id; opt.textContent = f.name + ' — cost ₦' + fmt(f.cost); disposeAssetSelect.appendChild(opt); });

      // populate asset existing select
      const aeEmpty = document.createElement('option'); aeEmpty.value=''; aeEmpty.textContent='-- select asset --'; txnFixedAssetExisting.appendChild(aeEmpty);
      b.fixedAssets.forEach(f=>{ const opt = document.createElement('option'); opt.value = f.id; opt.textContent = f.name + ' — cost ₦' + fmt(f.cost); txnFixedAssetExisting.appendChild(opt); });

      // inventory selectors
      const piEmpty = document.createElement('option'); piEmpty.value=''; piEmpty.textContent='-- select item --'; purchaseItemSelect.appendChild(piEmpty);
      const siEmpty = document.createElement('option'); siEmpty.value=''; siEmpty.textContent='-- select item --'; sellItemSelect.appendChild(siEmpty);
      const tiPiEmpty = document.createElement('option'); tiPiEmpty.value=''; tiPiEmpty.textContent='-- select item --'; txnPurchaseItem.appendChild(tiPiEmpty);
      const tiSiEmpty = document.createElement('option'); tiSiEmpty.value=''; tiSiEmpty.textContent='-- select item --'; txnSellItem.appendChild(tiSiEmpty);
      (b.inventory || []).forEach(it=>{
        const opt = document.createElement('option'); opt.value = it.id; opt.textContent = (it.sku?it.sku+' - ':'') + it.name + ' (Qty ' + (it.qtyOnHand||0) + ')';
        purchaseItemSelect.appendChild(opt);
        sellItemSelect.appendChild(opt.cloneNode(true));
        txnPurchaseItem.appendChild(opt.cloneNode(true));
        txnSellItem.appendChild(opt.cloneNode(true));
      });

      // contacts for sell flow
      const scEmpty = document.createElement('option'); scEmpty.value=''; scEmpty.textContent='-- select --'; sellContactSelect.appendChild(scEmpty);
      const tiScEmpty = document.createElement('option'); tiScEmpty.value=''; tiScEmpty.textContent='-- select --'; txnSellContact.appendChild(tiScEmpty);
      b.contacts.forEach(c=>{ const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; sellContactSelect.appendChild(opt); txnSellContact.appendChild(opt.cloneNode(true)); });
    }

    function populateInventorySelectors(){
      populateTxnContactAccount(); // reuses same population
    }

    // Add user/business/account/contact inline helpers
    btnAddUser.addEventListener('click', ()=>{
      const name = prompt('Enter user display name:','New User');
      if (!name) return;
      const u = { id: uid('user'), username: name.toLowerCase().replace(/\s+/g,'_'), display: name };
      data.users.push(u);
      selectedUserId = u.id;
      saveData(); populateSelectors();
    });

    btnAddBusiness.addEventListener('click', ()=>{
      const name = prompt('Enter business name:','New Business');
      if (!name) return;
      const b = {
        id: uid('biz'),
        name,
        ownerId: selectedUserId,
        members: [selectedUserId],
        vatRate: 7.5,
        currency: '₦',
        threshold: 800000,
        notes: '',
        vatEnabled: true,
        pitEnabled: true,
        vatInclusive: false,
        pit: DEFAULT_PIT,
        taxCarryforward: { capitalAllowances: 0, priorLosses: 0 },
        contacts: [],
        accounts: [],
        fixedAssets: [],
        inventory: [],
        bankAccounts: [],
        bankStatements: [],
        accountOpeningBalances: {}
      };
      data.businesses.push(b);
      data.transactions[b.id] = [];
      selectedBusinessId = b.id;
      saveData(); populateSelectors();
    });

    btnAddAccountInline.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) { alert('Select business first'); return; }
      const name = prompt('Account name (e.g., Sales Revenue):','New Account');
      if (!name) return;
      const type = prompt('Account type (Asset, Liability, Revenue, Expense, Equity, Bank):','Expense');
      const code = prompt('Account code (optional):','');
      const acc = { id: uid('acc'), code: code || '', name, type: type || 'Expense' };
      b.accounts.push(acc);
      // if user designated Bank, ensure bankAccounts contains it
      if (acc.type === 'Bank') b.bankAccounts = b.bankAccounts || [], b.bankAccounts.push(acc.id);
      saveData(); populateTxnContactAccount(); renderAll();
    });

    btnAddContactInline.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if (!b) { alert('Select business first'); return; }
      const name = prompt('Contact name:','New Contact');
      if (!name) return;
      const type = prompt('Contact type (Customer, Supplier, Employee):','Customer');
      const c = { id: uid('c'), name, type };
      b.contacts.push(c);
      saveData(); populateTxnContactAccount(); renderAll();
    });

    // Transactions
    btnAddTxn.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId);
      if (!b){ alert('Select business'); return; }
      const date = txnDate.value || new Date().toISOString().slice(0,10);
      const desc = txnDesc.value || '';
      const amount = Number(txnAmount.value) || 0;
      const accountId = txnAccount.value || '';
      const contactId = txnContact.value || '';
      if (!accountId){ alert('Select account'); return; }
      // Taxes inputs removed from form; keep taxes object (defaults)
      const taxes = { vat: 0, wht: 0, paye: 0 };
      const bankAccountId = txnBankAccountSelect.value || '';
      const reconciled = !!txnReconciledCheckbox.checked;
      const tx = { id: uid('t'), date, desc, amount, authorUserId: selectedUserId, contactId, accountId, taxes, reconciled, bankAccountId, tags: [] };
      data.transactions[b.id] = data.transactions[b.id] || [];

      // Fixed asset handling based on new controls
      const faAction = (txnFixedAssetAction && txnFixedAssetAction.value) || 'none';
      if (faAction === 'create'){
        const life = Number(txnFixedAssetLife.value) || DEFAULT_USEFUL_LIFE_YEARS;
        const name = (txnFixedAssetName && txnFixedAssetName.value) || desc || 'Fixed asset';
        const asset = { id: uid('fa'), name: name, accountId: accountId, cost: amount, dateAcquired: date, usefulLifeYears: life, accumulatedDepreciation: 0 };
        b.fixedAssets = b.fixedAssets || [];
        b.fixedAssets.push(asset);
        tx.tags.push('fixed-asset-acquisition');
      } else if (faAction === 'link'){
        const existingId = txnFixedAssetExisting.value;
        if (existingId){
          tx.tags.push('fixed-asset-linked');
          tx.linkedAssetId = existingId;
        }
      }

      data.transactions[b.id].push(tx);

      // Perform inline inventory action (if any)
      const invAction = (txnInventoryAction && txnInventoryAction.value) || 'none';
      try {
        if (invAction === 'add'){
          inlineAddInventory(b);
          tx.tags.push('inventory-add');
        } else if (invAction === 'purchase'){
          inlineRecordPurchase(b, tx);
          tx.tags.push('inventory-purchase');
        } else if (invAction === 'sale'){
          inlineRecordSale(b, tx);
          tx.tags.push('inventory-sale');
        }
      } catch(e){ console.error('Inline inventory action failed', e); alert('Inventory action failed: ' + e.message); }

      saveData();
      populateTxnContactAccount();
      renderAll();
      clearTxnForm();
    });

    function clearTxnForm(){
      txnDate.value = ''; txnDesc.value = ''; txnAmount.value=''; txnContact.value=''; txnAccount.value='';
      txnBankAccountSelect.value=''; txnReconciledCheckbox.checked=false;
      // reset fixed asset controls
      if (txnFixedAssetAction) txnFixedAssetAction.value = 'none';
      txnFixedAssetName && (txnFixedAssetName.value = '');
      txnFixedAssetLife && (txnFixedAssetLife.value = DEFAULT_USEFUL_LIFE_YEARS);
      txnFixedAssetExisting && (txnFixedAssetExisting.value = '');
      // reset inventory inline controls
      if (txnInventoryAction) txnInventoryAction.value = 'none';
      txnInvAdd && (txnInvName.value=''); txnInvSku && (txnInvSku.value=''); txnInvQty && (txnInvQty.value='0'); txnInvCost && (txnInvCost.value='0');
      txnPurchaseItem && (txnPurchaseItem.value=''); txnPurchaseDate && (txnPurchaseDate.value=''); txnPurchaseQty && (txnPurchaseQty.value=''); txnPurchaseTotalCost && (txnPurchaseTotalCost.value=''); txnPurchaseAccount && (txnPurchaseAccount.value='');
      txnSellItem && (txnSellItem.value=''); txnSellDate && (txnSellDate.value=''); txnSellQty && (txnSellQty.value=''); txnSellAmount && (txnSellAmount.value=''); txnSellRevenueAccount && (txnSellRevenueAccount.value=''); txnSellContact && (txnSellContact.value='');
      // hide inline blocks
      updateFixedAssetVisibility(); updateInventoryVisibility();
    }

    // Assets modal and operations
    btnAddAsset.addEventListener('click', ()=>{ openAssetModal(); });
    assetCancel.addEventListener('click', ()=>{ closeModal(assetModal); });
    assetSave.addEventListener('click', ()=>{ saveAssetFromModal(); });

    function openAssetModal(editAsset){
      assetModal.dataset.editId = editAsset ? editAsset.id : '';
      assetNameInput.value = editAsset ? editAsset.name : '';
      assetCostInput.value = editAsset ? editAsset.cost : '';
      assetDateInput.value = editAsset ? editAsset.dateAcquired : '';
      assetLifeInput.value = editAsset ? editAsset.usefulLifeYears : DEFAULT_USEFUL_LIFE_YEARS;
      assetAccumInput.value = editAsset ? (editAsset.accumulatedDepreciation||0) : 0;
      populateTxnContactAccount();
      showModal(assetModal);
    }

    function saveAssetFromModal(){
      const b = findBiz(selectedBusinessId); if(!b) return closeModal(assetModal);
      const editId = assetModal.dataset.editId;
      const name = assetNameInput.value || 'Asset';
      const accountId = assetAccountSelect.value || (b.accounts[0] && b.accounts[0].id) || '';
      const cost = Number(assetCostInput.value) || 0;
      const dateAcquired = assetDateInput.value || new Date().toISOString().slice(0,10);
      const life = Number(assetLifeInput.value) || DEFAULT_USEFUL_LIFE_YEARS;
      const accum = Number(assetAccumInput.value) || 0;
      b.fixedAssets = b.fixedAssets || [];
      if (editId){
        const a = b.fixedAssets.find(x=>x.id===editId);
        if (a){ a.name=name; a.accountId=accountId; a.cost=cost; a.dateAcquired=dateAcquired; a.usefulLifeYears=life; a.accumulatedDepreciation=accum; }
      } else {
        b.fixedAssets.push({ id: uid('fa'), name, accountId, cost, dateAcquired, usefulLifeYears: life, accumulatedDepreciation: accum });
      }
      saveData(); closeModal(assetModal); populateTxnContactAccount(); renderAll();
    }

    // Disposal modal
    btnOpenDispose.addEventListener('click', ()=>{ openDisposeModal(); });
    disposeCancel.addEventListener('click', ()=>{ closeModal(disposeModal); });
    disposeConfirm.addEventListener('click', ()=>{ confirmDisposeAsset(); });

    function openDisposeModal(){
      populateTxnContactAccount();
      disposeDate.value = new Date().toISOString().slice(0,10);
      disposeProceeds.value = '';
      showModal(disposeModal);
    }

    function confirmDisposeAsset(){
      const b = findBiz(selectedBusinessId); if(!b) return;
      const assetId = disposeAssetSelect.value; if (!assetId){ alert('Select asset'); return; }
      const date = disposeDate.value || new Date().toISOString().slice(0,10);
      const proceeds = Number(disposeProceeds.value) || 0;
      const idx = (b.fixedAssets||[]).findIndex(x=>x.id===assetId);
      if (idx === -1){ alert('Asset not found'); closeModal(disposeModal); return; }
      const asset = b.fixedAssets[idx];
      const accumToDate = computeAccumulatedDepreciationForAsset(asset, date, b);
      const nbv = (asset.cost || 0) - accumToDate;
      const gain = proceeds - nbv;
      // create disposal transaction: proceeds to revenue account but mark non-taxable for CIT/PIT
      const revenueAccount = b.accounts.find(a=>a.type==='Revenue') || b.accounts[0] || { id: '', name: 'Revenue' };
      const tx = {
        id: uid('t'),
        date,
        desc: 'Asset disposal: ' + (asset.name || ''),
        amount: proceeds,
        authorUserId: selectedUserId,
        contactId: '',
        accountId: revenueAccount.id,
        tags: ['asset-disposal'],
        nonTaxableForTax: true,
        disposalDetails: { assetId: asset.id, proceeds, nbv, gain, accumToDate },
        taxes: { vat:0,wht:0,paye:0 },
        reconciled: false,
        bankAccountId: ''
      };
      data.transactions[b.id] = data.transactions[b.id] || [];
      data.transactions[b.id].push(tx);
      // remove asset
      b.fixedAssets.splice(idx,1);
      saveData(); closeModal(disposeModal); populateTxnContactAccount(); renderAll();
      alert('Asset disposed. Proceeds recorded as revenue and marked non-taxable for tax computations.');
    }

    // Depreciation helpers
    function monthDiff(d1, d2){
      return (d2.getFullYear()-d1.getFullYear())*12 + (d2.getMonth()-d1.getMonth());
    }

    function computeAccumulatedDepreciationForAsset(asset, upToDateStr, business){
      const openingAccum = Number(asset.accumulatedDepreciation || 0);
      const acquired = new Date(asset.dateAcquired || new Date().toISOString().slice(0,10));
      const upTo = new Date(upToDateStr || new Date().toISOString().slice(0,10));
      if (upTo < acquired) return openingAccum;
      const monthsOwned = monthDiff(acquired, upTo) + 1;
      const lifeMonths = (asset.usefulLifeYears || DEFAULT_USEFUL_LIFE_YEARS) * 12;
      const monthsForDep = Math.min(monthsOwned, lifeMonths);
      const annualDep = (asset.cost || 0) / (asset.usefulLifeYears || DEFAULT_USEFUL_LIFE_YEARS);
      const depToDate = (annualDep / 12) * monthsForDep;
      return Math.min(asset.cost, openingAccum + depToDate);
    }

    // Inventory functions
    btnAddInvItem.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if(!b) { alert('Select business'); return; }
      const name = (invNameInput.value || '').trim(); if (!name){ alert('Enter item name'); return; }
      const sku = (invSkuInput.value || '').trim();
      const qty = Number(invQtyInput.value) || 0;
      const cost = Number(invCostInput.value) || 0;
      const item = { id: uid('inv'), sku, name, qtyOnHand: qty, avgCost: cost, lots: [] };
      if (qty > 0){
        item.lots.push({ id: uid('lot'), date: new Date().toISOString().slice(0,10), qty, totalCost: qty * cost });
      }
      b.inventory = b.inventory || [];
      b.inventory.push(item);
      saveData(); populateTxnContactAccount(); renderAll();
      invNameInput.value=''; invSkuInput.value=''; invQtyInput.value='0'; invCostInput.value='0';
    });

    btnPurchase.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if(!b) { alert('Select business'); return; }
      const itemId = purchaseItemSelect.value; const q = Number(purchaseQty.value) || 0; const totalCost = Number(purchaseTotalCost.value) || 0;
      const date = purchaseDate.value || new Date().toISOString().slice(0,10);
      const accountId = purchaseAccountSelect.value || '';
      if (!itemId){ alert('Select item'); return; }
      if (q <= 0){ alert('Enter purchase quantity'); return; }
      const item = (b.inventory || []).find(i=>i.id===itemId);
      if (!item){ alert('Item not found'); return; }
      // update avg cost (weighted average)
      const oldQty = Number(item.qtyOnHand || 0);
      const oldAvg = Number(item.avgCost || 0);
      const purchaseUnitCost = totalCost / q;
      const newQty = oldQty + q;
      const newAvg = newQty > 0 ? ((oldQty * oldAvg) + (q * purchaseUnitCost)) / newQty : 0;
      item.qtyOnHand = newQty;
      item.avgCost = newAvg;
      item.lots = item.lots || [];
      item.lots.push({ id: uid('lot'), date, qty: q, totalCost });
      // optionally create purchase transaction
      if (accountId){
        const tx = { id: uid('t'), date, desc: `Purchase ${item.name}`, amount: totalCost, authorUserId: selectedUserId, contactId: '', accountId, taxes:{vat:0,wht:0,paye:0}, reconciled:false, bankAccountId:'' };
        data.transactions[b.id] = data.transactions[b.id] || [];
        data.transactions[b.id].push(tx);
      }
      saveData(); populateTxnContactAccount(); renderAll();
      purchaseQty.value=''; purchaseTotalCost.value=''; purchaseDate.value='';
    });

    btnSell.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId); if(!b) { alert('Select business'); return; }
      const itemId = sellItemSelect.value; const q = Number(sellQtyInput.value) || 0; const saleAmount = Number(sellAmountInput.value) || 0;
      const date = sellDate.value || new Date().toISOString().slice(0,10);
      const revenueAccId = sellRevenueAccount.value || (b.accounts.find(a=>a.type==='Revenue') && b.accounts.find(a=>a.type==='Revenue').id) || '';
      const contactId = sellContactSelect.value || '';
      if (!itemId){ alert('Select item'); return; }
      if (q <= 0){ alert('Enter sale quantity'); return; }
      const item = (b.inventory || []).find(i=>i.id===itemId);
      if (!item){ alert('Item not found'); return; }
      if ((item.qtyOnHand || 0) < q){
        if (!confirm(`Available qty ${item.qtyOnHand}. Selling ${q} will make inventory negative. Proceed?`)) return;
      }
      // compute COGS using avgCost
      const avg = Number(item.avgCost || 0);
      const cogs = q * avg;
      // reduce qty
      item.qtyOnHand = (item.qtyOnHand || 0) - q;
      // create revenue transaction
      if (revenueAccId){
        const saleTx = { id: uid('t'), date, desc: `Sale ${item.name}`, amount: saleAmount, authorUserId: selectedUserId, contactId, accountId: revenueAccId, taxes:{vat:0,wht:0,paye:0}, reconciled:false, bankAccountId:'' };
        data.transactions[b.id] = data.transactions[b.id] || [];
        data.transactions[b.id].push(saleTx);
      } else {
        alert('No revenue account selected; sale will not be recorded as revenue transaction.');
      }
      // ensure COGS account exists
      let cogsAcc = b.accounts.find(a => (a.code === '5200') || (a.name && a.name.toLowerCase().includes('cost of goods sold')));
      if (!cogsAcc){
        cogsAcc = { id: uid('acc'), code: '5200', name: 'Cost of Goods Sold', type: 'Expense' };
        b.accounts.push(cogsAcc);
      }
      // create COGS transaction (expense)
      const cogsTx = { id: uid('t'), date, desc: `COGS ${item.name}`, amount: cogs, authorUserId: selectedUserId, contactId, accountId: cogsAcc.id, taxes:{vat:0,wht:0,paye:0}, reconciled:false, bankAccountId:'' };
      data.transactions[b.id] = data.transactions[b.id] || [];
      data.transactions[b.id].push(cogsTx);

      saveData(); populateTxnContactAccount(); renderAll();
      sellQtyInput.value=''; sellAmountInput.value=''; sellDate.value='';
    });

    // Inline inventory helpers used by Add Transaction
    function inlineAddInventory(b){
      const name = (txnInvName.value || '').trim(); if (!name) throw new Error('Enter item name');
      const sku = (txnInvSku.value || '').trim();
      const qty = Number(txnInvQty.value) || 0;
      const cost = Number(txnInvCost.value) || 0;
      const item = { id: uid('inv'), sku, name, qtyOnHand: qty, avgCost: cost, lots: [] };
      if (qty > 0){
        item.lots.push({ id: uid('lot'), date: new Date().toISOString().slice(0,10), qty, totalCost: qty * cost });
      }
      b.inventory = b.inventory || [];
      b.inventory.push(item);
      saveData();
      populateTxnContactAccount();
      renderAll();
    }

    function inlineRecordPurchase(b, originatingTx){
      const itemId = txnPurchaseItem.value; const q = Number(txnPurchaseQty.value) || 0; const totalCost = Number(txnPurchaseTotalCost.value) || 0;
      const date = txnPurchaseDate.value || new Date().toISOString().slice(0,10);
      const accountId = txnPurchaseAccount.value || '';
      if (!itemId) throw new Error('Select item for purchase');
      if (q <= 0) throw new Error('Enter purchase quantity');
      const item = (b.inventory || []).find(i=>i.id===itemId);
      if (!item) throw new Error('Item not found');
      const oldQty = Number(item.qtyOnHand || 0);
      const oldAvg = Number(item.avgCost || 0);
      const purchaseUnitCost = totalCost / q;
      const newQty = oldQty + q;
      const newAvg = newQty > 0 ? ((oldQty * oldAvg) + (q * purchaseUnitCost)) / newQty : 0;
      item.qtyOnHand = newQty;
      item.avgCost = newAvg;
      item.lots = item.lots || [];
      item.lots.push({ id: uid('lot'), date, qty: q, totalCost });
      // optionally create purchase transaction if purchase account set
      if (accountId){
        const tx = { id: uid('t'), date, desc: `Purchase ${item.name}`, amount: totalCost, authorUserId: selectedUserId, contactId: '', accountId, taxes:{vat:0,wht:0,paye:0}, reconciled:false, bankAccountId:'' };
        data.transactions[b.id] = data.transactions[b.id] || [];
        data.transactions[b.id].push(tx);
      }
      saveData();
      populateTxnContactAccount();
      renderAll();
    }

    function inlineRecordSale(b, originatingTx){
      const itemId = txnSellItem.value; const q = Number(txnSellQty.value) || 0; const saleAmount = Number(txnSellAmount.value) || 0;
      const date = txnSellDate.value || new Date().toISOString().slice(0,10);
      const revenueAccId = txnSellRevenueAccount.value || (b.accounts.find(a=>a.type==='Revenue') && b.accounts.find(a=>a.type==='Revenue').id) || '';
      const contactId = txnSellContact.value || '';
      if (!itemId) throw new Error('Select item for sale');
      if (q <= 0) throw new Error('Enter sale quantity');
      const item = (b.inventory || []).find(i=>i.id===itemId);
      if (!item) throw new Error('Item not found');
      if ((item.qtyOnHand || 0) < q){
        if (!confirm(`Available qty ${item.qtyOnHand}. Selling ${q} will make inventory negative. Proceed?`)) return;
      }
      const avg = Number(item.avgCost || 0);
      const cogs = q * avg;
      item.qtyOnHand = (item.qtyOnHand || 0) - q;
      // create revenue transaction
      if (revenueAccId){
        const saleTx = { id: uid('t'), date, desc: `Sale ${item.name}`, amount: saleAmount, authorUserId: selectedUserId, contactId, accountId: revenueAccId, taxes:{vat:0,wht:0,paye:0}, reconciled:false, bankAccountId:'' };
        data.transactions[b.id] = data.transactions[b.id] || [];
        data.transactions[b.id].push(saleTx);
      }
      // ensure COGS account exists
      let cogsAcc = b.accounts.find(a => (a.code === '5200') || (a.name && a.name.toLowerCase().includes('cost of goods sold')));
      if (!cogsAcc){
        cogsAcc = { id: uid('acc'), code: '5200', name: 'Cost of Goods Sold', type: 'Expense' };
        b.accounts.push(cogsAcc);
      }
      const cogsTx = { id: uid('t'), date, desc: `COGS ${item.name}`, amount: cogs, authorUserId: selectedUserId, contactId, accountId: cogsAcc.id, taxes:{vat:0,wht:0,paye:0}, reconciled:false, bankAccountId:'' };
      data.transactions[b.id] = data.transactions[b.id] || [];
      data.transactions[b.id].push(cogsTx);

      saveData();
      populateTxnContactAccount();
      renderAll();
    }

    // Quick inventory buttons: scroll to inventory and focus the appropriate field
    if (btnQuickAddInventory) {
      btnQuickAddInventory.addEventListener('click', () => {
        const invPanel = document.getElementById('inventoryPanel');
        if (!invPanel) return alert('Inventory panel not found');
        invPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setTimeout(() => { const el = document.getElementById('invName'); if (el) el.focus(); }, 300);
      });
    }
    if (btnQuickRecordPurchase) {
      btnQuickRecordPurchase.addEventListener('click', () => {
        const invPanel = document.getElementById('inventoryPanel');
        if (!invPanel) return alert('Inventory panel not found');
        invPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setTimeout(() => { const el = document.getElementById('purchaseItem'); if (el) el.focus(); }, 300);
      });
    }
    if (btnQuickRecordSale) {
      btnQuickRecordSale.addEventListener('click', () => {
        const invPanel = document.getElementById('inventoryPanel');
        if (!invPanel) return alert('Inventory panel not found');
        invPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setTimeout(() => { const el = document.getElementById('sellItem'); if (el) el.focus(); }, 300);
      });
    }

    // UI helpers
    function showModal(modal){
      document.getElementById('modalOverlay').style.display = 'block';
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal){
      document.getElementById('modalOverlay').style.display = 'none';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    function updateFixedAssetVisibility(){
      const v = txnFixedAssetAction.value;
      txnFixedAssetNameLabel.classList.toggle('hidden', v !== 'create');
      txnFixedAssetLifeLabel.classList.toggle('hidden', v !== 'create');
      txnFixedAssetExistingLabel.classList.toggle('hidden', v !== 'link');
    }

    function updateInventoryVisibility(){
      const v = txnInventoryAction.value;
      txnInvAdd.classList.toggle('hidden', v !== 'add');
      txnInvPurchase.classList.toggle('hidden', v !== 'purchase');
      txnInvSale.classList.toggle('hidden', v !== 'sale');
    }

    txnFixedAssetAction.addEventListener('change', updateFixedAssetVisibility);
    txnInventoryAction.addEventListener('change', updateInventoryVisibility);

    // Render functions
    function renderAll(){
      populateSelectorsSafely();
      renderLedger();
      renderAssetsList();
      renderInventoryList();
      updateFixedAssetVisibility();
      updateInventoryVisibility();
    }

    function populateSelectorsSafely(){
      // Re-populate selects if UI exists
      populateTxnContactAccount();
    }

    function renderLedger(){
      ledgerTbody.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const txs = (data.transactions[b.id] || []).slice().sort((a,b2)=>new Date(b2.date) - new Date(a.date));
      txs.forEach(tx=>{
        const tr = document.createElement('tr');
        const bank = findAccount(b.id, tx.bankAccountId);
        const acct = findAccount(b.id, tx.accountId);
        tr.innerHTML = `
          <td class="nowrap">${tx.date || ''}</td>
          <td>${escapeHtml(tx.desc || '')}</td>
          <td class="nowrap">${acct ? escapeHtml((acct.code||'') + ' - ' + acct.name) : ''}</td>
          <td class="nowrap">${fmt(tx.amount || 0)}</td>
          <td>${getContactName(b, tx.contactId)}</td>
          <td class="nowrap">${bank ? escapeHtml((bank.code||'') + ' - ' + bank.name) : ''}</td>
          <td>${(tx.tags||[]).join(', ')}</td>
          <td><button class="small" data-txid="${tx.id}">Delete</button></td>
        `;
        const delBtn = tr.querySelector('button[data-txid]');
        delBtn.addEventListener('click', ()=>{ if (confirm('Delete transaction?')) { deleteTransaction(b.id, tx.id); } });
        ledgerTbody.appendChild(tr);
      });
      const totalsDiv = document.getElementById('totalsSummary');
      const total = (data.transactions[b.id] || []).reduce((s,t)=>s + Number(t.amount||0),0);
      totalsDiv.innerHTML = `<div class="result-row"><div><strong>Transactions total</strong></div><div>₦ ${fmt(total)}</div></div>`;
    }

    function deleteTransaction(bizId, txId){
      const arr = data.transactions[bizId] || [];
      const idx = arr.findIndex(x=>x.id===txId);
      if (idx !== -1) arr.splice(idx,1);
      saveData(); renderAll();
    }

    function renderAssetsList(){
      fixedAssetsListDiv.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!b.fixedAssets || b.fixedAssets.length === 0) { fixedAssetsListDiv.textContent = '(no fixed assets)'; return; }
      const ul = document.createElement('ul');
      b.fixedAssets.forEach(a=>{
        const li = document.createElement('li');
        li.innerHTML = `<strong>${escapeHtml(a.name)}</strong> — cost ₦${fmt(a.cost||0)} — life ${a.usefulLifeYears || DEFAULT_USEFUL_LIFE_YEARS} yrs
          <span style="margin-left:8px;">
            <button class="small" data-edit="${a.id}">Edit</button>
            <button class="small" data-delete="${a.id}">Delete</button>
          </span>`;
        ul.appendChild(li);
      });
      fixedAssetsListDiv.appendChild(ul);
      // wire edit/delete
      fixedAssetsListDiv.querySelectorAll('button[data-edit]').forEach(but=>{
        but.addEventListener('click', (e)=>{
          const id = e.target.getAttribute('data-edit');
          const asset = findBiz(selectedBusinessId).fixedAssets.find(x=>x.id===id);
          if (asset) openAssetModal(asset);
        });
      });
      fixedAssetsListDiv.querySelectorAll('button[data-delete]').forEach(but=>{
        but.addEventListener('click', (e)=>{
          const id = e.target.getAttribute('data-delete');
          if (!confirm('Delete asset?')) return;
          const b = findBiz(selectedBusinessId);
          const idx = (b.fixedAssets||[]).findIndex(x=>x.id===id);
          if (idx!==-1) b.fixedAssets.splice(idx,1);
          saveData(); populateTxnContactAccount(); renderAll();
        });
      });
    }

    function renderInventoryList(){
      inventoryListDiv.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!b.inventory || b.inventory.length === 0) { inventoryListDiv.textContent = '(no inventory)'; totalStockValueSpan.textContent = fmt(0); return; }
      const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
      table.innerHTML = `<thead><tr><th style="border:1px solid #ddd;padding:6px">SKU</th><th style="border:1px solid #ddd;padding:6px">Name</th><th style="border:1px solid #ddd;padding:6px">Qty</th><th style="border:1px solid #ddd;padding:6px">Avg cost (₦)</th><th style="border:1px solid #ddd;padding:6px">Value (₦)</th></tr></thead>`;
      const tbody = document.createElement('tbody');
      let totalVal = 0;
      (b.inventory || []).forEach(it=>{
        const row = document.createElement('tr');
        const value = (Number(it.qtyOnHand||0) * Number(it.avgCost||0));
        totalVal += value;
        row.innerHTML = `<td style="border:1px solid #ddd;padding:6px">${escapeHtml(it.sku||'')}</td>
          <td style="border:1px solid #ddd;padding:6px">${escapeHtml(it.name||'')}</td>
          <td style="border:1px solid #ddd;padding:6px">${it.qtyOnHand||0}</td>
          <td style="border:1px solid #ddd;padding:6px">${fmt(it.avgCost||0)}</td>
          <td style="border:1px solid #ddd;padding:6px">${fmt(value)}</td>`;
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      inventoryListDiv.appendChild(table);
      totalStockValueSpan.textContent = fmt(totalVal);
    }

    function getContactName(b, contactId){
      if (!b || !b.contacts) return '';
      const c = b.contacts.find(x=>x.id===contactId);
      return c ? c.name : '';
    }

    // escape for text nodes
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

    // Selection changes
    userSelect.addEventListener('change', ()=>{ selectedUserId = userSelect.value; saveData(); renderAll(); });
    businessSelect.addEventListener('change', ()=>{ selectedBusinessId = businessSelect.value; saveData(); populateSelectors(); renderAll(); });

    // import/export and clear
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const out = JSON.stringify(data, null, 2);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([out], { type: 'application/json' }));
      a.download = 'ntc-data.json';
      a.click();
    });
    document.getElementById('btnImport').addEventListener('click', ()=>{ document.getElementById('fileInput').click(); });
    document.getElementById('fileInput').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = (ev)=>{
        try {
          const parsed = JSON.parse(ev.target.result);
          if (parsed) { data = parsed; saveData(); loadData(); populateSelectors(); renderAll(); alert('Imported'); }
        } catch(err){ alert('Invalid JSON'); }
      };
      r.readAsText(f);
    });
    document.getElementById('btnClearAll').addEventListener('click', ()=>{
      if (!confirm('Clear all saved data?')) return;
      localStorage.removeItem(STORAGE_KEY);
      data = { users: [], businesses: [], transactions: {} };
      initializeDemo();
      populateSelectors();
    });

    // simple compute handler (keeps original UI but not complex tax rules)
    btnComputeTaxable.addEventListener('click', ()=>{
      const n = Number(netProfitAInput.value) || 0;
      const dis = Number(disallowableInput.value) || 0;
      const nonTax = Number(nonTaxableInput.value) || 0;
      const cap = Number(capitalAllowancesInput.value) || 0;
      const prior = Number(priorLossesInput.value) || 0;
      const other = Number(otherAdjustmentsInput.value) || 0;
      let taxable = n + dis - nonTax - cap - prior + other;
      taxable = Math.max(0, taxable);
      document.getElementById('taxableResult').style.display = 'block';
      document.getElementById('taxableResultValue').textContent = fmt(taxable);
    });

    // initial load
    loadData();
    populateSelectors();

  </script>
</body>
</html>

Notes / next steps:
- I preserved transaction objects' taxes property (defaulted to zeros) so you won't break other parts of the app that rely on t.taxes.
- The inline inventory actions are executed after the transaction is created and will create/modify inventory lots and optionally create purchase/sale transactions if account fields are set.
- Fixed asset control supports "create" (creates an asset from this transaction) and "link" (adds linkedAssetId to the transaction). The asset create uses transaction amount as cost and transaction date as date acquired.
- I kept the rest of the app (asset modal, inventory panel) functional and wired up populate/render functions so the UI updates after changes.

If you'd like, I can:
- Open a PR in your repo with this file replacing the existing index.html.
- Or provide a concise git patch/diff instead. Which would you prefer?
