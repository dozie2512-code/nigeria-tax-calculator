<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Multi-User Accounting & Tax ‚Äî Full Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,96vw); max-height:80vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted-pill { background:#f2f4f7; padding:4px 8px; border-radius:6px; font-size:0.9rem; color:#333; }
    .disabled { opacity:0.45; pointer-events:none; }
    .code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f3f5f7; padding:4px 6px; border-radius:4px; }
    /* Pre-login overlay styles */
    .prelogin-overlay { position:fixed; inset:0; background:linear-gradient(135deg, #0b76d1 0%, #00a3b5 100%); z-index:9999; display:flex; align-items:center; justify-content:center; }
    .prelogin-overlay.hidden { display:none; }
    .prelogin-card { background:#fff; padding:40px 48px; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,0.3); text-align:center; max-width:420px; width:90%; }
    .prelogin-card h2 { margin:0 0 8px 0; font-size:1.5rem; color:#222; }
    .prelogin-tagline { color:#0b76d1; font-size:1rem; font-weight:600; margin:0 0 12px 0; }
    .prelogin-offer-box { background:linear-gradient(135deg, #0b76d1 0%, #00a3b5 100%); color:#fff; padding:12px 16px; border-radius:10px; margin:0 0 18px 0; }
    .prelogin-offer-box .timer-label { font-size:0.85rem; margin-bottom:4px; }
    .prelogin-offer-box .timer-value { font-size:1.5rem; font-weight:700; letter-spacing:1px; }
    .prelogin-offer-box .buy-now-btn { display:inline-block; margin-top:10px; padding:10px 28px; background:#fff; color:#0b76d1; font-weight:700; border-radius:8px; text-decoration:none; transition:background 0.2s, color 0.2s; }
    .prelogin-offer-box .buy-now-btn:hover { background:#e6f4fa; }
    .prelogin-enquiries { background:#f4f8fb; border-radius:10px; padding:14px 16px; margin-top:18px; text-align:left; }
    .prelogin-enquiries .enquiries-title { font-weight:700; color:#222; margin:0 0 8px 0; font-size:0.95rem; }
    .prelogin-enquiries .enquiries-item { color:#444; font-size:0.9rem; margin:4px 0; }
    .prelogin-enquiries a { color:#0b76d1; text-decoration:none; }
    .prelogin-enquiries a:hover { text-decoration:underline; }
    .prelogin-subtitle { color:var(--muted); margin:0 0 24px 0; font-size:0.95rem; }
    .prelogin-form { display:flex; flex-direction:column; gap:16px; }
    .prelogin-form label { display:flex; flex-direction:column; text-align:left; font-size:0.9rem; color:var(--muted); gap:6px; }
    .prelogin-form input { padding:10px 12px; border:1px solid #cfcfcf; border-radius:8px; font-size:1rem; }
    .prelogin-form input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(11,118,209,0.15); }
    .prelogin-btn { padding:12px 24px; font-size:1rem; margin-top:8px; }
    .prelogin-note { color:var(--muted); font-size:0.8rem; margin:20px 0 0 0; }
    /* Auth tabs styles (merged from auth.css) */
    .auth-tabs { display:flex; gap:8px; margin-bottom:12px; justify-content:center; }
    .auth-tabs .tab { padding:8px 12px; border-radius:8px; border:1px solid #e6e9ef; background:#fff; cursor:pointer; }
    .auth-tabs .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .auth-panel { display:block; }
    .auth-panel.hidden { display:none; }
    .auth-msg { color:var(--muted); margin-top:8px; font-size:0.9rem; }
    /* Prevent body scroll when overlay/modals are shown */
    body.modal-open { overflow:hidden; }
    html:has(.prelogin-overlay:not(.hidden)) { overflow:hidden; }
    html:has(.modal[style*="display:block"]), html:has(.modal[style*="display: block"]) { overflow:hidden; }
    /* Hero promo section styles */
    .hero-promo { background:linear-gradient(135deg, #0b76d1 0%, #00a3b5 100%); color:#fff; padding:32px 24px; border-radius:12px; margin-bottom:16px; text-align:center; }
    .hero-promo h2 { margin:0 0 8px 0; font-size:1.35rem; font-weight:700; }
    .hero-promo p { margin:0 0 16px 0; font-size:1rem; opacity:0.95; }
    .hero-promo .hero-timer { font-size:1.1rem; margin-bottom:12px; }
    .hero-promo .hero-timer strong { font-size:1.4rem; letter-spacing:1px; }
    .hero-promo .hero-cta { display:inline-block; padding:12px 32px; background:#fff; color:#0b76d1; font-weight:700; border-radius:8px; text-decoration:none; transition:background 0.2s, color 0.2s; }
    .hero-promo .hero-cta:hover { background:#e6f4fa; }
    /* Pricing plan cards styles */
    .plan-cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin:16px 0; }
    .plan-card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:14px; text-align:left; }
    .plan-card.highlight { border-color:#0b76d1; box-shadow:0 2px 8px rgba(11,118,209,0.15); }
    .plan-card h3 { margin:0 0 8px 0; font-size:1.05rem; color:#1e293b; display:flex; align-items:center; gap:6px; }
    .plan-badge { background:#0b76d1; color:#fff; font-size:0.7rem; padding:2px 6px; border-radius:4px; font-weight:600; }
    .plan-pricing { margin:8px 0; }
    .plan-full-price { color:#64748b; font-size:0.85rem; text-decoration:line-through; }
    .plan-offer-price { color:#059669; font-size:1.15rem; font-weight:700; }
    .plan-features { list-style:none; padding:0; margin:10px 0; font-size:0.8rem; color:#475569; }
    .plan-features li { padding:3px 0; padding-left:16px; position:relative; }
    .plan-features li::before { content:"‚úì"; position:absolute; left:0; color:#059669; font-weight:600; }
    .plan-checkbox-row { display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#334155; margin:6px 0; }
    .plan-checkbox-row input[type="checkbox"] { margin:0; accent-color:#0b76d1; }
    .plan-total { background:#e0f2fe; padding:8px; border-radius:6px; margin:10px 0 8px 0; text-align:center; }
    .plan-total-label { font-size:0.75rem; color:#0369a1; }
    .plan-total-value { font-size:1.1rem; font-weight:700; color:#0b76d1; }
    .plan-buy-btn { display:block; width:100%; padding:10px; background:#0b76d1; color:#fff; border:none; border-radius:6px; font-weight:600; font-size:0.9rem; text-decoration:none; text-align:center; cursor:pointer; transition:background 0.2s; }
    .plan-buy-btn:hover { background:#0a68be; }
    .offer-countdown-box { background:linear-gradient(135deg, #0b76d1 0%, #00a3b5 100%); color:#fff; padding:12px 16px; border-radius:10px; margin-bottom:16px; text-align:center; }
    .offer-countdown-box .countdown-label { font-size:0.85rem; margin-bottom:4px; }
    .offer-countdown-box .countdown-value { font-size:1.4rem; font-weight:700; letter-spacing:1px; }
    .offer-flash { animation: offerFlash 0.6s ease-out; }
    @keyframes offerFlash { 0%,100%{background:linear-gradient(135deg,#0b76d1 0%,#00a3b5 100%);} 50%{background:linear-gradient(135deg,#10b981 0%,#059669 100%);} }
    .prelogin-card-wide { max-width:720px; width:95%; padding:24px 28px; }
    .addon-price { color:#0b76d1; font-weight:600; }
    /* Collapsible plan card styles using <details> */
    details.plan-card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:0; text-align:left; }
    details.plan-card[open] { padding:14px; padding-top:0; }
    details.plan-card.highlight { border-color:#0b76d1; box-shadow:0 2px 8px rgba(11,118,209,0.15); }
    details.plan-card summary { display:flex; align-items:center; justify-content:space-between; padding:14px; cursor:pointer; list-style:none; }
    details.plan-card summary::-webkit-details-marker { display:none; }
    details.plan-card summary::marker { display:none; }
    details.plan-card summary .plan-header-left { display:flex; align-items:center; gap:6px; }
    details.plan-card summary .plan-header-left h3 { margin:0; font-size:1.05rem; color:#1e293b; display:flex; align-items:center; gap:6px; }
    details.plan-card summary .plan-header-right { display:flex; align-items:center; gap:8px; }
    details.plan-card summary .plan-header-right .plan-offer-price { color:#059669; font-size:1.15rem; font-weight:700; }
    details.plan-card summary .plan-arrow { transition:transform 0.2s ease; font-size:0.8rem; color:#64748b; }
    details.plan-card[open] summary .plan-arrow { transform:rotate(180deg); }
  </style>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Pre-login overlay - blocks access until user signs in -->
  <div id="preLoginOverlay" class="prelogin-overlay">
    <div class="prelogin-card prelogin-card-wide">
      <h2>Nigeria Accounting & Tax Engine</h2>
      <p class="prelogin-tagline">Your all-in-one financial management solution!</p>

      <!-- Offer countdown timer -->
      <div id="preloginOfferBox" class="offer-countdown-box">
        <div class="countdown-label">üî• Limited Time Offer Ends In:</div>
        <div class="countdown-value" id="preloginCountdown">3d 00:00:00</div>
      </div>

      <!-- Pricing Plan Cards -->
      <div class="plan-cards">
        <!-- Individual Plan -->
        <details class="plan-card">
          <summary>
            <div class="plan-header-left">
              <h3>Individual <span class="plan-badge">7 Day Trial</span></h3>
            </div>
            <div class="plan-header-right">
              <span class="plan-offer-price">‚Ç¶20,000/year</span>
              <span class="plan-arrow">‚ñº</span>
            </div>
          </summary>
          <div class="plan-pricing">
            <div class="plan-full-price">‚Ç¶30,000/year</div>
            <div class="plan-offer-price">‚Ç¶20,000/year</div>
          </div>
          <ul class="plan-features">
            <li>1 user + tax advisor</li>
            <li>Track VAT and PIT</li>
            <li>Embedded Tax Chat</li>
          </ul>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="individualApplyOffer" checked />
            <label for="individualApplyOffer">Apply Buy Now Offer</label>
          </div>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="individualAddon" />
            <label for="individualAddon">Add: Self Filing Support <span class="addon-price">‚Ç¶20,000/year</span></label>
          </div>
          <div class="plan-total">
            <div class="plan-total-label">Total</div>
            <div class="plan-total-value" id="individualTotal">‚Ç¶20,000</div>
          </div>
          <a href="https://paystack.shop/pay/individual20000?plan=individual&price=20000" target="_blank" class="plan-buy-btn" id="individualBuyLink">Buy Now</a>
        </details>

        <!-- Enterprise Plan -->
        <details class="plan-card highlight">
          <summary>
            <div class="plan-header-left">
              <h3>Enterprise <span class="plan-badge">Popular</span></h3>
            </div>
            <div class="plan-header-right">
              <span class="plan-offer-price">‚Ç¶25,000/year</span>
              <span class="plan-arrow">‚ñº</span>
            </div>
          </summary>
          <div class="plan-pricing">
            <div class="plan-full-price">‚Ç¶37,500/year</div>
            <div class="plan-offer-price">‚Ç¶25,000/year</div>
          </div>
          <ul class="plan-features">
            <li>2 users + tax advisor</li>
            <li>Track VAT, WHT, PAYE and PIT</li>
            <li>Embedded Tax Chat</li>
          </ul>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="enterpriseApplyOffer" checked />
            <label for="enterpriseApplyOffer">Apply Buy Now Offer</label>
          </div>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="enterpriseAddon" />
            <label for="enterpriseAddon">Add: Self Filing Support <span class="addon-price">‚Ç¶30,000/year</span></label>
          </div>
          <div class="plan-total">
            <div class="plan-total-label">Total</div>
            <div class="plan-total-value" id="enterpriseTotal">‚Ç¶25,000</div>
          </div>
          <a href="https://paystack.shop/pay/enterprise25000?plan=enterprise&price=25000" target="_blank" class="plan-buy-btn" id="enterpriseBuyLink">Buy Now</a>
        </details>

        <!-- Company Plan -->
        <details class="plan-card">
          <summary>
            <div class="plan-header-left">
              <h3>Company <span class="plan-badge">7 Day Trial</span></h3>
            </div>
            <div class="plan-header-right">
              <span class="plan-offer-price">‚Ç¶30,000/year</span>
              <span class="plan-arrow">‚ñº</span>
            </div>
          </summary>
          <div class="plan-pricing">
            <div class="plan-full-price">‚Ç¶50,000/year</div>
            <div class="plan-offer-price">‚Ç¶30,000/year</div>
          </div>
          <ul class="plan-features">
            <li>2 users + tax advisor</li>
            <li>Track VAT, WHT, PAYE and CIT, CGT</li>
            <li>Embedded Tax Chat</li>
          </ul>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="companyApplyOffer" checked />
            <label for="companyApplyOffer">Apply Buy Now Offer</label>
          </div>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="companyAddon" />
            <label for="companyAddon">Add: Self Filing Support <span class="addon-price">‚Ç¶40,000/year</span></label>
          </div>
          <div class="plan-total">
            <div class="plan-total-label">Total</div>
            <div class="plan-total-value" id="companyTotal">‚Ç¶30,000</div>
          </div>
          <a href="https://paystack.shop/pay/company30000?plan=company&price=30000" target="_blank" class="plan-buy-btn" id="companyBuyLink">Buy Now</a>
        </details>
      </div>

      <p class="prelogin-subtitle">Sign in or create an account to continue</p>

      <!-- Auth tabs (merged from auth.html) -->
      <div class="auth-tabs">
        <button id="authTabLogin" class="tab active">Login</button>
        <button id="authTabSignup" class="tab">Sign up</button>
      </div>

      <!-- Login panel -->
      <div id="authLoginPanel" class="auth-panel prelogin-form">
        <label>Username or Email:
          <input type="text" id="preLoginUsername" placeholder="Enter username or email" autocomplete="username" />
        </label>
        <label>Password:
          <input type="password" id="preLoginPassword" placeholder="Enter password" autocomplete="current-password" />
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="primary prelogin-btn" id="preLoginSubmit">Sign In</button>
        </div>
        <p id="authLoginMsg" class="auth-msg"></p>
      </div>

      <!-- Signup panel (merged from auth.html) -->
      <div id="authSignupPanel" class="auth-panel prelogin-form hidden">
        <label>Full Name:
          <input type="text" id="authSignupName" placeholder="Enter your full name" autocomplete="name" required />
        </label>
        <label>Username:
          <input type="text" id="authSignupUsername" placeholder="Choose a username" autocomplete="username" required />
        </label>
        <label>Email:
          <input type="email" id="authSignupEmail" placeholder="your@email.com" autocomplete="email" required />
        </label>
        <label>Phone:
          <input type="tel" id="authSignupPhone" placeholder="e.g. +234..." autocomplete="tel" />
        </label>
        <label>Password (min 6 chars):
          <input type="password" id="authSignupPassword" placeholder="Choose a password" autocomplete="new-password" minlength="6" required />
        </label>
        <label>Confirm Password:
          <input type="password" id="authSignupPassword2" placeholder="Confirm password" minlength="6" required />
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="primary prelogin-btn" id="authSignupSubmit">Create Account</button>
          <button class="prelogin-btn" id="authSignupCancel" type="button">Cancel</button>
        </div>
        <p id="authSignupMsg" class="auth-msg"></p>
      </div>

      <!-- Enquiries contact block -->
      <div class="prelogin-enquiries">
        <div class="enquiries-title">Enquiries</div>
        <div class="enquiries-item">üìû Call: <a href="tel:+234">+234</a></div>
        <div class="enquiries-item">üí¨ Chat: <a href="tel:+234">+234</a></div>
        <div class="enquiries-item">‚úâÔ∏è Email: <a href="mailto:salesrepng@gmail.com">salesrepng@gmail.com</a></div>
        <div class="enquiries-item">üìç Address: &mdash;</div>
      </div>

      <p class="prelogin-note">Note: This is a prototype. Credentials stored locally. Passwords hashed with SHA-256.</p>
    </div>
  </div>

  <header>
    <h1>Nigeria Accounting & Tax Engine ‚Äî Prototype</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnLogin" class="small primary">Login</button>
        <button id="btnLogout" class="small" style="display:none;">Logout</button>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
        <a id="buyNowBtn" class="small primary" href="https://paystack.shop/pay/financialbook" target="_blank" style="text-decoration:none;">Buy Now</a>
        <span id="offerTimer" class="small-note" style="margin-left:8px;">Offer ends in: <strong id="offerCountdown">3d 00:00:00</strong></span>
      </div>
    </div>
  </header>

  <!-- Hero Promo Section (visible after pre-login overlay is dismissed) -->
  <section id="heroPromo" class="hero-promo">
    <h2>üéâ Limited Time Offer ‚Äî Get Started Today!</h2>
    <p>Manage your Nigerian tax, accounting, and finances seamlessly with our powerful all-in-one engine.</p>
    <div class="hero-timer">Offer ends in: <strong id="heroCountdown">3d 00:00:00</strong></div>
    <a href="https://paystack.shop/pay/financialbook" target="_blank" class="hero-cta">Buy Now</a>
  </section>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
            <option value="AssetPurchase">Asset Purchase</option>
            <option value="AssetDisposal">Asset Disposal</option>
            <option value="OpeningAssetBal">Opening Asset Bal</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (‚Ç¶): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

        <label>Adjustment:
          <select id="txnAdjustmentType">
            <option value="">None</option>
            <option value="disallowable">Disallowable expense</option>
            <option value="nontaxable">Non-taxable income</option>
          </select>
        </label>
        <label id="txnAdjustmentAmountLabel" style="display:none;">Amt (‚Ç¶): <input type="number" id="txnAdjustmentAmount" class="smallInput" min="0" step="0.01" /></label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (‚Ç¶): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label>Opening Qty: <input type="number" id="invOpeningQty" min="0" step="1" /></label>
          <label>Opening Avg Cost (‚Ç¶): <input type="number" id="invOpeningAvgCost" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small primary">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetPurchaseSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Asset Purchase</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" list="assetNameSuggestions" /></label>
          <datalist id="assetNameSuggestions">
            <!-- Populated dynamically based on category selection -->
          </datalist>
          <label>Category:
            <select id="assetCategory">
              <option value="Property Plant and Equipment">Property Plant and Equipment</option>
              <option value="Furniture & Fittings">Furniture & Fittings</option>
              <option value="Motor Vehicles">Motor Vehicles</option>
              <option value="Land & Building">Land & Building</option>
              <option value="Other Asset">Other Asset</option>
            </select>
          </label>
          <label>Qty: <input type="number" id="assetQty" min="1" step="1" class="smallInput" value="1" /></label>
          <label>Unit Price (‚Ç¶): <input type="number" id="assetUnitPrice" min="0" step="0.01" /></label>
          <label>Cost (‚Ç¶): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Opening Cost (‚Ç¶): <input type="number" id="assetOpeningCost" min="0" step="0.01" /></label>
          <label>Opening Accumulated Depreciation (‚Ç¶): <input type="number" id="assetOpeningAccDep" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>

          <label>Classification:
            <select id="assetClassification">
              <option value="Fixed">Fixed</option>
              <option value="Chargeable">Chargeable</option>
            </select>
          </label>

          <label>Depreciation rate % (annual): <input type="number" id="assetDepRate" class="smallInput" min="0" step="0.01" /></label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small primary">Record Asset Purchase</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Depreciation & capital allowance computed daily (prorated); asset schedule shows quantity and unit price.</small>
      </div>

      <div id="assetDisposalSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Asset Disposal</h3>
        <div class="form-inline">
          <label>Asset to dispose:
            <select id="assetDisposeSelect"></select>
          </label>
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Quantity to dispose: <input type="number" id="assetDisposalQty" min="1" step="1" class="smallInput" value="1" /></label>
          <label>Disposal proceeds (‚Ç¶): <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>
          <label>Contact: <input type="text" id="assetDisposalContact" placeholder="Contact name" /></label>
          <label>Receipt: <input type="file" id="assetDisposalReceipt" /></label>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetDisposalCancel" class="small">Cancel</button>
          <button id="btnAssetDisposalUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Chargeable gains and losses will be classified based on asset classification and included in tax calculations according to entity rules. Profit/loss = proceeds - tax written down value (TWDV = ‚Ç¶10 residual at end of life).</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable</button>
        <button class="small tab" data-report="whtReceivable">WHT Receivable</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Assets Report</button>
        <button class="small tab" data-report="pitIndividual">PIT (Individual)</button>
        <button class="small tab" data-report="pitEnterprise">PIT (Enterprise)</button>
        <button class="small tab" data-report="companyAccounts">Company Accounts</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
        <button id="btnExportXlsx" class="small">Export XLSX (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <!-- User modal -->
  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <!-- Business modal -->
  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="Enterprise">Enterprise</option>
          <option value="Individual">Individual</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <!-- CIT fields hidden but preserved in data via hidden inputs -->
      <input type="hidden" id="bizCit" />
      <input type="hidden" id="bizTurnoverThreshold" />
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <!-- CIT enabled checkbox hidden but preserved -->
      <input type="hidden" id="bizCitEnabled" />
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (‚Ç¶): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (‚Ç¶): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (‚Ç¶): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (‚Ç¶): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (‚Ç¶): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (‚Ç¶): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (‚Ç¶): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (SoleTrader), that will override these values for PIT.</small>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add a contact with type "SoleTrader" (or name "Sole trader") and set statutory deductions there if you want PIT to use per-sole-trader deductions.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <!-- Accounts modal -->
  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="max-height:360px; overflow:auto;"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountDisallowable" /> Disallowable</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountNonTax" /> Non-taxable</label>
      <select id="newAccountRentFreq">
        <option value="">Rent freq</option>
        <option value="monthly">Monthly rent</option>
        <option value="yearly">Yearly rent</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginModal" class="modal">
    <h3>Login</h3>
    <div class="row">
      <label>Username: <input type="text" id="loginUsername" /></label>
      <label>Password: <input type="password" id="loginPassword" placeholder="(optional)" /></label>
    </div>
    <small class="note">Note: Prototype. Credentials stored locally. Passwords hashed with SHA-256.</small>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="loginCancel">Cancel</button>
      <button class="primary" id="loginSubmit">Login</button>
    </div>
  </div>

<div id="signupModal" class="modal">
  <h3>Signup ‚Äî Nigeria Tax (7-day trial)</h3>
  <div class="row">
    <label>Name: <input type="text" id="signupName" required></label>
    <label>Username: <input type="text" id="signupUsername" required></label>
    <label>Email: <input type="email" id="signupEmail" required placeholder="your@email.com"></label>
  </div>
  <div class="row">
    <label>Phone: <input type="tel" id="signupPhone" placeholder="e.g. +234..."></label>
    <label>Password: <input type="password" id="signupPassword" minlength="6" placeholder="Min 6 characters" required></label>
    <label>Plan:
      <select id="signupPlan">
        <option value="Individual">Individual</option>
        <option value="Enterprise">Enterprise</option>
        <option value="Company">Company</option>
      </select>
    </label>
  </div>
  <small class="note">Account valid for 7 days from signup. A notification will be sent to salesrepng@gmail.com.</small>
  <small class="note" style="display:block;margin-top:4px;color:#555;">‚ö†Ô∏è Prototype only: Credentials are stored locally in your browser (localStorage). Passwords are hashed client-side using SHA-256.</small>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
    <button id="signupCancel">Cancel</button>
    <button class="primary" id="signupSubmit">Create account</button>
  </div>
</div>

<div id="forgotModal" class="modal">
  <h3>Forgot Password</h3>
  <div class="row">
    <label>Username: <input type="text" id="forgotUsername"></label>
  </div>
  <small class="note">We will open an email request to the admin/sales team to process the reset (prototype). If you are the user, contact your admin to reset.</small>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
    <button id="forgotCancel">Cancel</button>
    <button class="primary" id="forgotSubmit">Request reset</button>
  </div>
</div>

<!-- Entity Selection Modal - shown after signup -->
<div id="entitySelectModal" class="modal">
  <h3>Select Your Entity Type</h3>
  <p class="muted">Please confirm the type of entity you'll be using this account for:</p>
  <div class="row">
    <label>Entity Type:
      <select id="entitySelectType">
        <option value="Individual">Individual</option>
        <option value="Enterprise">Enterprise</option>
        <option value="Company">Company</option>
      </select>
    </label>
  </div>
  <small class="note">This will create a default business for your account with the selected entity type.</small>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
    <button class="primary" id="entitySelectConfirm">Confirm & Continue</button>
  </div>
</div>

<!-- Video Tour Modal - shown first time after signup -->
<div id="videoTourModal" class="modal" style="text-align:center;">
  <h3>Welcome to Nigeria Accounting & Tax Engine!</h3>
  <p class="muted">Take a quick 5-minute tour to learn how to use the app.</p>
  <div id="videoTourContainer" style="margin:16px 0;">
    <iframe id="tourVideoIframe" width="560" height="315" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
  </div>
  <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;">
    <button id="videoTourSkip">Skip Tour</button>
    <button class="primary" id="videoTourWatch">Watch Tour</button>
  </div>
  <small class="note" style="margin-top:8px;display:block;">The tour will auto-close after 5 minutes if not dismissed.</small>
</div>

  <footer class="muted" style="margin-top:16px;">GitHub Copilot Chat Assistant ‚Äî prototype stores data in localStorage (ntc_full_accounting_v1)</footer>

  <script>
  /************************************************************************
   * Nigeria Multi-User Multi-Business Accounting & Tax Engine (Prototype)
   * Enhanced Version 2.0 - Comprehensive Tax & Entity Management
   * 
   * CHANGELOG:
   * - Renamed SoleProprietor ‚Üí Enterprise
   * - Added Individual entity type with restricted UI/tax rules
   * - Renamed Revenue action ‚Üí Income
   * - Added turnoverThreshold configuration (0, 50M, 100M)
   * - Enhanced asset management with opening balances
   * - Improved tax calculations for PIT, CIT, CGT with thresholds
   * - Added comprehensive account types
   * - Enhanced VAT/WHT calculations (inclusive/net options)
   * - Added SHA-256 password hashing for secure credential storage
   * - Added email uniqueness validation at signup
   * - Added entity selection step after signup
   * - Added video tour modal for new users
   * - Added 3-user limit per business enforcement
   ************************************************************************/

  // Video tour YouTube hash - replace with actual video hash
  const TOUR_VIDEO_HASH = 'REPLACE_ME_YOUTUBE_HASH';
  
  // Maximum users allowed per business (including owner)
  const MAX_USERS_PER_BUSINESS = 3;

  /**
   * Computes SHA-256 hex hash of a string using Web Crypto API.
   * Used for client-side password hashing before storage.
   * @param {string} str - The string to hash
   * @returns {Promise<string>} - Hex digest of the hash
   */
  async function sha256Hex(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
  }

  // Constants & defaults
  const STORAGE_KEY = 'ntc_full_accounting_v2'; // Updated storage key for migration
  const DEFAULTS = { 
    vatRate:7.5, whtRate:5.0, citRate:25.0,
    vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, 
    caRateDefault:20.0, depRateDefault:20.0, turnoverThreshold:100000000 
  };
  
  // WARNING: This plaintext password is committed in source for prototype/demo only. Do NOT use in production.
  const DEFAULT_ADMIN_USERNAME = 'admin';
  const DEFAULT_ADMIN_PASSWORD = 'chukwuedozie25$';
  
  /**
   * Stores signup lead and opens mailto for sales notification.
   * Contains only name, email, phone - no sensitive data.
   * @param {string} name - User's full name
   * @param {string} email - User's email address
   * @param {string} phone - User's phone number
   */
  function storeSignupLeadAndNotify(name, email, phone) {
    // Store lead in signupLeads localStorage (name, email, phone only)
    try {
      const leads = JSON.parse(localStorage.getItem('signupLeads') || '[]');
      leads.push({ name: name, email: email, phone: phone, createdAt: Date.now() });
      localStorage.setItem('signupLeads', JSON.stringify(leads));
    } catch (leadErr) {
      console.warn('Failed to store signup lead:', leadErr);
    }
    
    // Open mailto with lead info (name, email, phone only - no sensitive data)
    try {
      const mailtoBody = 'Name: ' + encodeURIComponent(name) + '%0AEmail: ' + encodeURIComponent(email) + '%0APhone: ' + encodeURIComponent(phone);
      const mailtoUrl = 'mailto:salesrepng@gmail.com?subject=New%20Signup&body=' + mailtoBody;
      window.open(mailtoUrl, '_blank');
    } catch (mailtoErr) {
      console.warn('Failed to open mailto:', mailtoErr);
    }
  }
  
  // PIT/PAYE bands per Nigerian tax law (updated to match requirements)
  const PAYE_BANDS = [
    { upTo: 800000, rate: 0.00 },       // First ‚Ç¶800,000 @ 0%
    { upTo: 3000000, rate: 0.15 },      // Next ‚Ç¶2,200,000 @ 15%
    { upTo: 12000000, rate: 0.18 },     // Next ‚Ç¶9,000,000 @ 18%
    { upTo: 25000000, rate: 0.21 },     // Next ‚Ç¶13,000,000 @ 21%
    { upTo: 50000000, rate: 0.23 },     // Next ‚Ç¶25,000,000 @ 23%
    { upTo: Infinity, rate: 0.25 }      // Above ‚Ç¶50,000,000 @ 25%
  ];
  
  // CIT Turnover threshold options
  const CIT_THRESHOLDS = {
    NONE: 0,
    MEDIUM: 50000000,   // ‚Ç¶50,000,000
    LARGE: 100000000    // ‚Ç¶100,000,000
  };
  
  // Tax calculation constants
  const ASSET_RESIDUAL_VALUE = 10; // ‚Ç¶10 residual at end of useful life
  const NON_TAXABLE_INCOME_CA_THRESHOLD = 0.10; // 10% threshold for CA relief
  const CGT_EXEMPTION_PROCEEDS = 150000000; // ‚Ç¶150,000,000
  const CGT_EXEMPTION_GAIN = 10000000; // ‚Ç¶10,000,000
  
  // Individual-only account names (for UI filtering)
  const INDIVIDUAL_ACCOUNTS = ['Salary', 'Benefit in kind', 'Dividend', 'Interest', 'Royalty', 'Share of profit'];

  // App state
  let state = {
    users: [], businesses: [], transactions: {}, attachments: {}, audit: [], auth: { currentUserId: null },
  };
  let selectedUserId = null;
  let selectedBizId = null;
  let activeTab = 'ledger';
  let inventoryHistory = [];
  let assetHistory = [];
  let videoTourTimeout = null; // Timer for auto-closing video tour

  /**
   * Creates a default business for a user after signup.
   * @param {string} userId - The user's ID
   * @param {string} entityType - The entity type (Individual/Enterprise/Company)
   * @returns {string} - The created business ID
   */
  function createBusinessForUser(userId, entityType) {
    const user = state.users.find(u => u.id === userId);
    if (!user) return null;
    
    const bizId = uid('biz');
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 };
    
    const newBusiness = {
      id: bizId,
      name: (user.display || user.username) + "'s Business",
      ownerId: userId,
      entity: entityType,
      vatRate: DEFAULTS.vatRate,
      whtRate: DEFAULTS.whtRate,
      citRate: DEFAULTS.citRate,
      turnoverThreshold: DEFAULTS.turnoverThreshold,
      vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
      caRateDefault: DEFAULTS.caRateDefault,
      depRateDefault: DEFAULTS.depRateDefault,
      accounts: [sales, cogs, bank],
      inventory: [],
      assets: [],
      contacts: [],
      statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
      lossBroughtForward: 0, caCarryForward: 0,
      defaultExpenseDisallowable: false, defaultRevenueNonTax: false,
      userIds: [userId] // Track users associated with this business
    };
    
    state.businesses.push(newBusiness);
    
    // Initialize transactions for this user/business combo
    if (!state.transactions[userId]) {
      state.transactions[userId] = {};
    }
    state.transactions[userId][bizId] = [];
    
    saveState();
    addAudit('business.create', 'business', bizId, 'Default business created for user: ' + user.username);
    
    return bizId;
  }

  /**
   * Checks if a business can accept more users (enforces 3-user limit).
   * @param {string} bizId - The business ID to check
   * @returns {boolean} - True if more users can be added, false if limit reached
   */
  function canAddUserToBusiness(bizId) {
    const biz = state.businesses.find(b => b.id === bizId);
    if (!biz) return false;
    
    // Count users associated with this business
    // Include owner + any users in userIds array
    let userCount = 0;
    
    // Count from userIds array if it exists
    if (biz.userIds && Array.isArray(biz.userIds)) {
      userCount = biz.userIds.length;
    } else {
      // Fallback: count owner only
      userCount = 1;
    }
    
    return userCount < MAX_USERS_PER_BUSINESS;
  }

  /**
   * Gets the count of users associated with a business.
   * @param {string} bizId - The business ID
   * @returns {number} - Number of users
   */
  function getUserCountForBusiness(bizId) {
    const biz = state.businesses.find(b => b.id === bizId);
    if (!biz) return 0;
    
    if (biz.userIds && Array.isArray(biz.userIds)) {
      return biz.userIds.length;
    }
    return 1; // At least the owner
  }

  /**
   * Shows the video tour modal for new users.
   * @param {string} userId - The user ID for tracking
   */
  function showTourModal(userId) {
    const modal = document.getElementById('videoTourModal');
    const iframe = document.getElementById('tourVideoIframe');
    
    if (!modal || !iframe) return;
    
    // Set iframe src with autoplay
    iframe.src = 'https://www.youtube.com/embed/' + TOUR_VIDEO_HASH + '?autoplay=1&rel=0';
    
    // Log audit entry for tour shown
    addAudit('tour.shown', 'user', userId, 'Video tour modal displayed');
    
    // Open modal
    openModal(modal);
    
    // Auto-close after 5 minutes (300 seconds)
    if (videoTourTimeout) clearTimeout(videoTourTimeout);
    videoTourTimeout = setTimeout(function() {
      closeTourModal(userId, 'auto');
    }, 300000);
  }

  /**
   * Closes the video tour modal and marks tour as seen.
   * @param {string} userId - The user ID
   * @param {string} reason - 'skip', 'watch', or 'auto'
   */
  function closeTourModal(userId, reason) {
    const modal = document.getElementById('videoTourModal');
    const iframe = document.getElementById('tourVideoIframe');
    
    if (videoTourTimeout) {
      clearTimeout(videoTourTimeout);
      videoTourTimeout = null;
    }
    
    // Stop video
    if (iframe) iframe.src = '';
    
    // Mark tour as seen
    const user = state.users.find(u => u.id === userId);
    if (user) {
      user.tourSeen = true;
      saveState();
    }
    
    // Log audit entry
    addAudit('tour.closed', 'user', userId, 'Video tour closed: ' + reason);
    
    if (modal) closeModal(modal);
  }

  /**
   * Validates email format.
   * @param {string} email - Email to validate
   * @returns {boolean} - True if valid email format
   */
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  // DOM refs
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const txnReceipt = document.getElementById('txnReceipt');
  const btnAddTxn = document.getElementById('btnAddTxn');
  const mainTxnForm = document.getElementById('mainTxnForm');

  const inventorySubform = document.getElementById('inventorySubform');
  const invItemSelect = document.getElementById('invItemSelect');
  const invNewName = document.getElementById('invNewName');
  const invAccountSelect = document.getElementById('invAccountSelect');
  const invQty = document.getElementById('invQty');
  const invUnitPrice = document.getElementById('invUnitPrice');
  const invOpeningQty = document.getElementById('invOpeningQty');
  const invOpeningAvgCost = document.getElementById('invOpeningAvgCost');
  const invVatType = document.getElementById('invVatType');
  const invContact = document.getElementById('invContact');
  const invReceipt = document.getElementById('invReceipt');
  const btnAddInv = document.getElementById('btnAddInv');
  const btnInvCancel = document.getElementById('btnInvCancel');
  const btnInvUndo = document.getElementById('btnInvUndo');

  const assetPurchaseSubform = document.getElementById('assetPurchaseSubform');
  const assetDisposalSubform = document.getElementById('assetDisposalSubform');
  const assetName = document.getElementById('assetName');
  const assetCategory = document.getElementById('assetCategory');
  const assetQty = document.getElementById('assetQty');
  const assetUnitPrice = document.getElementById('assetUnitPrice');
  const assetCost = document.getElementById('assetCost');
  const assetOpeningCost = document.getElementById('assetOpeningCost');
  const assetOpeningAccDep = document.getElementById('assetOpeningAccDep');
  const assetPurchaseDate = document.getElementById('assetPurchaseDate');
  const assetLife = document.getElementById('assetLife');
  const assetCA = document.getElementById('assetCA');
  const assetDisposalDate = document.getElementById('assetDisposalDate');
  const assetDisposalQty = document.getElementById('assetDisposalQty');
  const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
  const btnAddAsset = document.getElementById('btnAddAsset');
  const btnDisposeAsset = document.getElementById('btnDisposeAsset');
  const btnAssetCancel = document.getElementById('btnAssetCancel');
  const btnAssetUndo = document.getElementById('btnAssetUndo');
  const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
  const assetDisposalAccount = document.getElementById('assetDisposalAccount');
  const assetClassification = document.getElementById('assetClassification');
  const assetDepRate = document.getElementById('assetDepRate');
  const assetContact = document.getElementById('assetContact');
  const assetReceipt = document.getElementById('assetReceipt');
  const assetDisposeSelect = document.getElementById('assetDisposeSelect');
  const assetDisposalContact = document.getElementById('assetDisposalContact');
  const assetDisposalReceipt = document.getElementById('assetDisposalReceipt');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const ledgerSection = document.getElementById('ledgerSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');
  const quickPanels = document.getElementById('quickPanels');

  const modalOverlay = document.getElementById('modalOverlay');
  const userModal = document.getElementById('userModal');
  const userModalTitle = document.getElementById('userModalTitle');
  const userName = document.getElementById('userName');
  const userDisplay = document.getElementById('userDisplay');
  const userRole = document.getElementById('userRole');
  const permView = document.getElementById('permView');
  const permEdit = document.getElementById('permEdit');
  const permDelete = document.getElementById('permDelete');
  const userSave = document.getElementById('userSave');
  const userCancel = document.getElementById('userCancel');

  const businessModal = document.getElementById('businessModal');
  const businessModalTitle = document.getElementById('businessModalTitle');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizTurnoverThreshold = document.getElementById('bizTurnoverThreshold');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
  const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');

  const accountsModal = document.getElementById('accountsModal');
  const accountsList = document.getElementById('accountsList');
  const newAccountName = document.getElementById('newAccountName');
  const newAccountCategory = document.getElementById('newAccountCategory');
  const newAccountDisallowable = document.getElementById('newAccountDisallowable');
  const newAccountNonTax = document.getElementById('newAccountNonTax');
  const newAccountRentFreq = document.getElementById('newAccountRentFreq');
  const addAccountBtn = document.getElementById('addAccountBtn');
  const closeAccountsBtn = document.getElementById('closeAccountsBtn');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnReportsTab = document.getElementById('btnReportsTab');

  // New DOM refs for added features
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const loginModal = document.getElementById('loginModal');
  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const loginSubmit = document.getElementById('loginSubmit');
  const loginCancel = document.getElementById('loginCancel');
  const authInfo = document.getElementById('authInfo');
  
  // Pre-login overlay DOM refs
  const preLoginOverlay = document.getElementById('preLoginOverlay');
  const preLoginUsername = document.getElementById('preLoginUsername');
  const preLoginPassword = document.getElementById('preLoginPassword');
  const preLoginSubmit = document.getElementById('preLoginSubmit');
  
  // Auth tabs and panels DOM refs (merged from auth.js)
  const authTabLogin = document.getElementById('authTabLogin');
  const authTabSignup = document.getElementById('authTabSignup');
  const authLoginPanel = document.getElementById('authLoginPanel');
  const authSignupPanel = document.getElementById('authSignupPanel');
  const authLoginMsg = document.getElementById('authLoginMsg');
  const authSignupMsg = document.getElementById('authSignupMsg');
  const authSignupName = document.getElementById('authSignupName');
  const authSignupUsername = document.getElementById('authSignupUsername');
  const authSignupEmail = document.getElementById('authSignupEmail');
  const authSignupPhone = document.getElementById('authSignupPhone');
  const authSignupPassword = document.getElementById('authSignupPassword');
  const authSignupPassword2 = document.getElementById('authSignupPassword2');
  const authSignupSubmit = document.getElementById('authSignupSubmit');
  const authSignupCancel = document.getElementById('authSignupCancel');
  
  const txnAdjustmentType = document.getElementById('txnAdjustmentType');
  const txnAdjustmentAmount = document.getElementById('txnAdjustmentAmount');
  const txnAdjustmentAmountLabel = document.getElementById('txnAdjustmentAmountLabel');
  
  const btnAssetDisposalCancel = document.getElementById('btnAssetDisposalCancel');
  const btnAssetDisposalUndo = document.getElementById('btnAssetDisposalUndo');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return (n==null || isNaN(Number(n))) ? '‚Ç¶0.00' : '‚Ç¶' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function rawFmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
  function toISO(date){ if(!date) return null; return new Date(date).toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }
  function isLeapYear(y){ return (y%4===0 && y%100!==0) || (y%400===0); }
  function daysInYear(d){ const y = new Date(d).getFullYear(); return isLeapYear(y) ? 366 : 365; }

  // load/save
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }
  
  /**
   * Seeds the default admin account if it does not exist.
   * Called during migration to ensure admin is always available for prototype/demo.
   */
  async function seedAdminIfNeeded() {
    // Check if admin user already exists
    const existingAdmin = state.users.find(u => u.id === 'admin' || u.username === DEFAULT_ADMIN_USERNAME);
    if (existingAdmin) {
      // Ensure admin has passwordHash if missing (prototype migration)
      if (!existingAdmin.passwordHash) {
        existingAdmin.passwordHash = await sha256Hex(DEFAULT_ADMIN_PASSWORD);
        saveState();
      }
      return;
    }
    
    // Create seeded admin user
    const adminPasswordHash = await sha256Hex(DEFAULT_ADMIN_PASSWORD);
    const adminUser = {
      id: 'admin',
      username: DEFAULT_ADMIN_USERNAME,
      display: 'Admin',
      role: 'Admin',
      isAdmin: true,
      passwordHash: adminPasswordHash,
      permissions: { view: true, edit: true, delete: true },
      createdAt: new Date().toISOString(),
      tourSeen: true
    };
    
    state.users.push(adminUser);
    
    // Create a default business for admin using existing helper
    createBusinessForUser('admin', 'Company');
    
    saveState();
    addAudit('admin.seed', 'user', 'admin', 'Seeded default admin account for prototype/demo');
  }
  
  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || { currentUserId: null };
    
    // Seed admin account if not present (runs async, saves state when done)
    seedAdminIfNeeded();
    
    state.businesses.forEach(b => {
      // MIGRATION: Rename SoleProprietor to Enterprise
      if (b.entity === 'SoleProprietor') {
        b.entity = 'Enterprise';
      }
      
      // MIGRATION: Add turnoverThreshold if missing (default 100M)
      if (typeof b.turnoverThreshold === 'undefined') {
        b.turnoverThreshold = DEFAULTS.turnoverThreshold;
      }
      
      // MIGRATION: Add userIds array if missing (for 3-user limit enforcement)
      if (!b.userIds || !Array.isArray(b.userIds)) {
        b.userIds = b.ownerId ? [b.ownerId] : [];
      }
      
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
      b.accounts = b.accounts || [];
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
      
      // MIGRATION: Add missing default accounts
      const existingAccountNames = b.accounts.map(a => a.name);
      const accountsToAdd = [
        { name: 'Purchases', category: 'Expense' },
        { name: 'Salary', category: 'Expense' },
        { name: 'Benefit in kind', category: 'Expense' },
        { name: 'Dividend', category: 'Revenue' },
        { name: 'Interest', category: 'Revenue' },
        { name: 'Royalty', category: 'Revenue' },
        { name: 'Share of profit', category: 'Revenue' },
        { name: 'Receivable', category: 'Asset' },
        { name: 'Payable', category: 'Liability' },
        { name: 'Capital', category: 'Capital' },
        { name: 'Accruals', category: 'Liability' },
        { name: 'Prepayment', category: 'Asset' },
        { name: 'Sales Revenue', category: 'Revenue' }  // Added for Individual
      ];
      
      // Add Rent as Revenue for Individual entities only
      if(b.entity === 'Individual'){
        accountsToAdd.push({ name: 'Rent', category: 'Revenue' });
      }
      
      for (const acct of accountsToAdd) {
        if (!existingAccountNames.includes(acct.name)) {
          b.accounts.push({
            id: uid('acct'),
            name: acct.name,
            category: acct.category,
            disallowableDefault: false,
            nonTaxableDefault: false,
            openingBalance: 0,
            closingBalance: 0
          });
        }
      }
      
      // Ensure balance accounts have balance fields
      b.accounts.forEach(a => {
        if (['Receivable', 'Bank', 'Payable', 'Capital', 'Accruals', 'Prepayment'].includes(a.name)) {
          a.openingBalance = a.openingBalance || 0;
          a.closingBalance = a.closingBalance || 0;
        }
      });
    });
    
    // MIGRATION: Map Revenue action to Income in transactions
    for (const u of state.users) {
      state.transactions[u.id] = state.transactions[u.id] || {};
      for (const b of state.businesses) {
        state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || [];
        // Convert Revenue ‚Üí Income
        state.transactions[u.id][b.id].forEach(txn => {
          if (txn.action === 'Revenue') {
            txn.action = 'Income';
          }
        });
      }
    }
    
    saveState();
  }

  async function seedDemo(){
    const u = 'admin', b = uid('biz');  // Use 'admin' as the user ID for seeded admin
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const purchases = { id: uid('acct'), name: 'Purchases', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const rent = { id: uid('acct'), name: 'Rent', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false, rentFreq:'monthly' };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 };
    const chargeInc = { id: uid('acct'), name: 'Chargeable asset income', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const chargeCost = { id: uid('acct'), name: 'Chargeable asset cost', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };

    // Compute password hash for seeded admin
    const adminPasswordHash = await sha256Hex(DEFAULT_ADMIN_PASSWORD);

    state = {
      users: [{ 
        id: u, 
        username: DEFAULT_ADMIN_USERNAME, 
        display:'Admin', 
        role:'Admin', 
        isAdmin:true, 
        passwordHash: adminPasswordHash,
        permissions:{ view:true, edit:true, delete:true }, 
        createdAt: new Date().toISOString(),
        tourSeen: true 
      }],
      businesses: [{
        id: b,
        name: 'Demo Business',
        ownerId: u,
        entity: 'Company',
        vatRate: DEFAULTS.vatRate,
        whtRate: DEFAULTS.whtRate,
        citRate: DEFAULTS.citRate,
        turnoverThreshold: DEFAULTS.turnoverThreshold,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault,
        depRateDefault: DEFAULTS.depRateDefault,
        accounts: [sales, cogs, purchases, salaries, rent, bank, chargeInc, chargeCost],
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [
          { id: uid('asset'), name: 'Office PC', qty:1, unitPrice:150000, cost: 150000, purchaseDate: today(), lifeYears: 5, caPercent: 20, depRate: 20, classification: 'Fixed', accumulatedDep:0, disposed:false, disposal:{}, openingAccDep:0 },
          { id: uid('asset'), name: 'Land Plot', qty:1, unitPrice:2000000, cost: 2000000, purchaseDate: '2020-01-01', lifeYears: 20, caPercent: 5, depRate: 0, classification: 'Chargeable', accumulatedDep:0, disposed:false, disposal:{}, openingAccDep:0 }
        ],
        contacts: [{ id: uid('c'), name:'John Employee', type:'Employee', statutory:{ pension: 20000, rent: 120000, life: 5000, mortgage: 100000, nhf: 5000 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } }],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward: 150000, caCarryForward: 50000,
        defaultExpenseDisallowable:false, defaultRevenueNonTax:false,
        userIds: [u] // Track users associated with this business
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: null }  // Not logged in by default - user must sign in via pre-login overlay
    };
    state.transactions[u] = {};
    state.transactions[u][b] = [
      { id: uid('txn'), date: today(), action: 'Income', accountId: sales.id, accountName: sales.name, accountCategory: sales.category, description: 'Demo sale', amount: 150000, vatType:'exclusive', whtApplied:false, paye:false, contact:'', receiptId:null },
      { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, accountCategory: salaries.category, description: 'Demo salary', amount: 50000, vatType:'none', whtApplied:false, paye:true, contact:'John Employee', receiptId:null },
      { id: uid('txn'), date: today(), action: 'InventoryPurchase', accountId: cogs.id, accountName: cogs.name, accountCategory: cogs.category, description: 'Purchase widgets', qty:50, unitPrice:520, amount: 26000, vatType:'none', whtApplied:false, paye:false, contact:'', receiptId:null },
    ];
    addAudit('seed','system','',`Seeded demo data with admin account (prototype)`);
    saveState();
  }

  // audit
  function addAudit(type, entityType, entityId, details){
    const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details };
    state.audit = state.audit || [];
    state.audit.push(entry);
    saveState();
  }

  // modal helpers
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
  modalOverlay.addEventListener('click', ()=> { 
    const signupModalEl = document.getElementById('signupModal');
    const preLoginOverlayEl = document.getElementById('preLoginOverlay');
    const wasSignupModalOpen = signupModalEl && signupModalEl.style.display === 'block';
    
    [userModal, businessModal, accountsModal, loginModal, signupModalEl, document.getElementById('forgotModal'), document.getElementById('entitySelectModal'), document.getElementById('videoTourModal')].forEach(m => { if(m && m.style.display==='block') closeModal(m); }); 
    
    // Show pre-login overlay if signup modal was closed and user is not logged in
    if (wasSignupModalOpen && preLoginOverlayEl && (!state || !state.auth || !state.auth.currentUserId)) {
      preLoginOverlayEl.classList.remove('hidden');
    }
  });

  // Login/Logout functions - Updated to use password hashing
  async function handleLogin(){
    const username = (loginUsername.value || '').trim();
    const password = (loginPassword.value || '');
    
    if(!username) return alert('Username required');
    const user = state.users.find(u => u.username === username);
    if(!user) return alert('User not found');
    
    // Check password if user has passwordHash (new users)
    // Otherwise allow login for backward compatibility (demo users)
    if(user.passwordHash) {
      if(!password) return alert('Password required');
      const inputHash = await sha256Hex(password);
      if(inputHash !== user.passwordHash) {
        return alert('Invalid password');
      }
    }
    
    state.auth.currentUserId = user.id;
    saveState();
    addAudit('auth.login', 'user', user.id, 'User logged in');
    closeModal(loginModal);
    loginUsername.value = '';
    loginPassword.value = '';
    updateAuthUI();
    renderAll();
  }

  function handleLogout(){
    if(!state.auth.currentUserId) return;
    addAudit('auth.logout', 'user', state.auth.currentUserId, 'User logged out');
    state.auth.currentUserId = null;
    saveState();
    updateAuthUI();
    renderAll();
  }

  // Pre-login overlay handler - authenticates user from the blocking overlay form
  async function handlePreLogin(){
    const loginInput = (preLoginUsername.value || '').trim();
    const password = (preLoginPassword.value || '');
    
    if(!loginInput) {
      if(authLoginMsg) { authLoginMsg.textContent = 'Username or email required'; authLoginMsg.style.color = '#b00'; }
      return;
    }
    // Support login by username or email (merged from auth.js)
    const loginLower = loginInput.toLowerCase();
    const user = state.users.find(u => u.username === loginInput || u.username === loginLower || u.email === loginLower);
    if(!user) {
      if(authLoginMsg) { authLoginMsg.textContent = 'No matching user found'; authLoginMsg.style.color = '#b00'; }
      return;
    }
    
    // Check password if user has passwordHash (new users)
    // Otherwise allow login for backward compatibility (demo users)
    if(user.passwordHash) {
      if(!password) {
        if(authLoginMsg) { authLoginMsg.textContent = 'Password required'; authLoginMsg.style.color = '#b00'; }
        return;
      }
      const inputHash = await sha256Hex(password);
      if(inputHash !== user.passwordHash) {
        if(authLoginMsg) { authLoginMsg.textContent = 'Invalid credentials'; authLoginMsg.style.color = '#b00'; }
        return;
      }
    }
    
    state.auth.currentUserId = user.id;
    saveState();
    addAudit('auth.login', 'user', user.id, 'User logged in via pre-login overlay');
    preLoginUsername.value = '';
    preLoginPassword.value = '';
    if(authLoginMsg) { authLoginMsg.textContent = 'Signed in ‚Äî loading...'; authLoginMsg.style.color = 'green'; }
    
    setTimeout(() => {
      updateAuthUI();
      renderAll();
      
      // Check if user needs to see video tour (first time after signup)
      if(user.tourSeen !== true) {
        showTourModal(user.id);
      }
    }, 400);
  }

  function updateAuthUI(){
    if(state.auth.currentUserId){
      const user = state.users.find(u => u.id === state.auth.currentUserId);
      if(user){
        authInfo.textContent = `Logged in as: ${user.display || user.username}`;
        btnLogin.style.display = 'none';
        btnLogout.style.display = 'inline-block';
        // Hide pre-login overlay when logged in
        if(preLoginOverlay) preLoginOverlay.classList.add('hidden');
      }
    } else {
      authInfo.textContent = 'Not logged in';
      btnLogin.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      // Show pre-login overlay when not logged in
      if(preLoginOverlay) preLoginOverlay.classList.remove('hidden');
    }
    enforcePermissions();
  }

  function enforcePermissions(){
    const user = state.users.find(u => u.id === state.auth.currentUserId);
    const isAdmin = user && user.isAdmin;
    
    // Disable business management buttons for non-admins
    btnAddBusiness.disabled = !isAdmin;
    btnEditBusiness.disabled = !isAdmin;
    btnDeleteBusiness.disabled = !isAdmin;
    btnManageAccounts.disabled = !isAdmin;
    
    if(!isAdmin){
      btnAddBusiness.classList.add('disabled');
      btnEditBusiness.classList.add('disabled');
      btnDeleteBusiness.classList.add('disabled');
      btnManageAccounts.classList.add('disabled');
    } else {
      btnAddBusiness.classList.remove('disabled');
      btnEditBusiness.classList.remove('disabled');
      btnDeleteBusiness.classList.remove('disabled');
      btnManageAccounts.classList.remove('disabled');
    }
  }

  // Helper functions for asset and inventory deletion
  function deleteAssetIfCurrentYear(assetId){
    const b = findBiz(selectedBizId);
    if(!b) return false;
    
    const asset = b.assets.find(a => a.id === assetId);
    if(!asset) return false;
    
    const currentYear = new Date().getFullYear();
    const purchaseYear = new Date(asset.purchaseDate).getFullYear();
    const disposalYear = asset.disposed && asset.disposal.date ? new Date(asset.disposal.date).getFullYear() : null;
    
    // Check if purchase or disposal occurred in current year
    if(purchaseYear !== currentYear && (!disposalYear || disposalYear !== currentYear)){
      alert(`Cannot delete asset. Purchase/disposal must have occurred in ${currentYear}.`);
      return false;
    }
    
    // Delete the asset
    b.assets = b.assets.filter(a => a.id !== assetId);
    
    // Delete related transactions (depreciation, capital allowance, purchase, disposal)
    const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    state.transactions[selectedUserId][selectedBizId] = txns.filter(t => 
      !(t.assetId === assetId || (t.description && t.description.includes(asset.name)))
    );
    
    addAudit('asset.delete', 'asset', assetId, `Deleted asset: ${asset.name}`);
    saveState();
    return true;
  }

  function deleteInventoryIfCurrentYear(itemId){
    const b = findBiz(selectedBizId);
    if(!b) return false;
    
    const item = b.inventory.find(i => i.id === itemId);
    if(!item) return false;
    
    const currentYear = new Date().getFullYear();
    const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    
    // Check if any inventory transactions for this item occurred in current year
    const itemTxns = txns.filter(t => t.itemId === itemId);
    const hasCurrentYearTxn = itemTxns.some(t => new Date(t.date).getFullYear() === currentYear);
    
    if(!hasCurrentYearTxn && itemTxns.length > 0){
      const firstTxnYear = new Date(itemTxns[0].date).getFullYear();
      alert(`Cannot delete inventory item. Transactions must have occurred in ${currentYear}.`);
      return false;
    }
    
    // Delete the inventory item
    b.inventory = b.inventory.filter(i => i.id !== itemId);
    
    // Delete related transactions
    state.transactions[selectedUserId][selectedBizId] = txns.filter(t => t.itemId !== itemId);
    
    addAudit('inventory.delete', 'inventory', itemId, `Deleted inventory: ${item.name}`);
    saveState();
    return true;
  }

  // initialization
  loadState();
  initUI();
  updateAuthUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  function initUI(){
    btnAddUser.addEventListener('click', ()=> openUserModal());
    btnEditUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); openUserModal(selectedUserId); });
    btnDeleteUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); if(!confirm('Delete user? This cannot be undone')) return; deleteUser(selectedUserId); });
    userSave.addEventListener('click', saveUser);
    userCancel.addEventListener('click', ()=> closeModal(userModal));

    btnAddBusiness.addEventListener('click', openAddBusinessModal);
    btnEditBusiness.addEventListener('click', openEditBusinessModal);
    btnDeleteBusiness.addEventListener('click', ()=> { if(!selectedBizId) return alert('Select business'); if(!confirm('Delete business and all its transactions/attachments?')) return; deleteBusiness(selectedBizId); });
    bizSave.addEventListener('click', saveBusiness);
    bizCancel.addEventListener('click', ()=>closeModal(businessModal));
    btnAddContact.addEventListener('click', addContactToBiz);

    btnManageAccounts.addEventListener('click', ()=> { if(!selectedBizId) return alert('Select business'); renderAccounts(); openModal(accountsModal); });
    addAccountBtn.addEventListener('click', addAccount);
    closeAccountsBtn.addEventListener('click', ()=> closeModal(accountsModal));

    txnAction.addEventListener('change', txnActionChanged);
    txnWht.addEventListener('change', ()=> {
      const show = txnWht.checked;
      txnWhtRateLabel.style.display = show ? 'inline-flex' : 'none';
      txnWhtBasisLabel.style.display = show ? 'inline-flex' : 'none';
      if(show && !txnWhtRate.value){ txnWhtRate.value = findBiz(selectedBizId)?.whtRate || DEFAULTS.whtRate; }
    } );
    btnAddTxn.addEventListener('click', handleAddTransaction);

    btnAddInv.addEventListener('click', handleInventoryAction);
    btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnInvUndo.addEventListener('click', handleUndoInventory);

    btnAddAsset.addEventListener('click', handleAddAsset);
    btnDisposeAsset.addEventListener('click', handleDisposeAsset);
    btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetPurchaseSubform.style.display='none'; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnAssetUndo.addEventListener('click', handleUndoAsset);
    btnAssetDisposalCancel.addEventListener('click', ()=>{ txnAction.value=''; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnAssetDisposalUndo.addEventListener('click', handleUndoAsset);

    // Login/Logout handlers
    btnLogin.addEventListener('click', ()=> openModal(loginModal));
    btnLogout.addEventListener('click', handleLogout);
    loginSubmit.addEventListener('click', handleLogin);
    loginCancel.addEventListener('click', ()=> closeModal(loginModal));

    // Pre-login overlay handler - authenticates user from overlay form
    if(preLoginSubmit){
      preLoginSubmit.addEventListener('click', handlePreLogin);
    }
    if(preLoginUsername){
      preLoginUsername.addEventListener('keypress', (e)=> { if(e.key === 'Enter') handlePreLogin(); });
    }
    if(preLoginPassword){
      preLoginPassword.addEventListener('keypress', (e)=> { if(e.key === 'Enter') handlePreLogin(); });
    }
    
    // Auth tabs switching logic (merged from auth.js)
    function switchAuthTab(panel) {
      if (panel === 'login') {
        if (authTabLogin) authTabLogin.classList.add('active');
        if (authTabSignup) authTabSignup.classList.remove('active');
        if (authLoginPanel) authLoginPanel.classList.remove('hidden');
        if (authSignupPanel) authSignupPanel.classList.add('hidden');
      } else {
        if (authTabSignup) authTabSignup.classList.add('active');
        if (authTabLogin) authTabLogin.classList.remove('active');
        if (authSignupPanel) authSignupPanel.classList.remove('hidden');
        if (authLoginPanel) authLoginPanel.classList.add('hidden');
      }
    }
    
    if (authTabLogin) authTabLogin.addEventListener('click', () => switchAuthTab('login'));
    if (authTabSignup) authTabSignup.addEventListener('click', () => switchAuthTab('signup'));
    if (authSignupCancel) authSignupCancel.addEventListener('click', () => {
      // Clear form and switch back to login
      if (authSignupName) authSignupName.value = '';
      if (authSignupUsername) authSignupUsername.value = '';
      if (authSignupEmail) authSignupEmail.value = '';
      if (authSignupPassword) authSignupPassword.value = '';
      if (authSignupPassword2) authSignupPassword2.value = '';
      if (authSignupMsg) authSignupMsg.textContent = '';
      switchAuthTab('login');
    });
    
    // Auth signup form handler (merged from auth.js)
    if (authSignupSubmit) {
      authSignupSubmit.addEventListener('click', async function(e) {
        e.preventDefault();
        if (authSignupMsg) authSignupMsg.textContent = '';
        
        const name = authSignupName ? authSignupName.value.trim() : '';
        const username = authSignupUsername ? authSignupUsername.value.trim() : '';
        const email = authSignupEmail ? authSignupEmail.value.trim().toLowerCase() : '';
        const phone = authSignupPhone ? authSignupPhone.value.trim() : '';
        const pass = authSignupPassword ? authSignupPassword.value : '';
        const pass2 = authSignupPassword2 ? authSignupPassword2.value : '';
        
        if (!name || !username || !email || !pass) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Please fill all fields'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        if (pass !== pass2) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Passwords do not match'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        if (pass.length < 6) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Password must be at least 6 characters'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        if (!isValidEmail(email)) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Please enter a valid email address'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        
        // Check username and email uniqueness
        const existingUsername = state.users.find(u => u.username === username);
        if (existingUsername) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Username already exists'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        const existingEmail = state.users.find(u => u.email === email);
        if (existingEmail) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Email already registered'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        
        // Hash password
        const passwordHash = await sha256Hex(pass);
        
        // Create user
        const userId = uid('user');
        const newUser = {
          id: userId,
          username: username,
          display: name,
          email: email,
          phone: phone,
          passwordHash: passwordHash,
          role: 'User',
          isAdmin: false,
          permissions: { view: true, edit: true, delete: false },
          plan: 'Individual',
          createdAt: new Date().toISOString(),
          trialStart: new Date().toISOString(),
          tourSeen: false
        };
        
        state.users.push(newUser);
        state.auth.currentUserId = userId;
        saveState();
        addAudit('user.signup', 'user', userId, 'User signed up via auth panel: ' + username);
        
        // Store lead and notify sales (uses helper function)
        storeSignupLeadAndNotify(name, email, phone);
        
        // Clear form
        if (authSignupName) authSignupName.value = '';
        if (authSignupUsername) authSignupUsername.value = '';
        if (authSignupEmail) authSignupEmail.value = '';
        if (authSignupPhone) authSignupPhone.value = '';
        if (authSignupPassword) authSignupPassword.value = '';
        if (authSignupPassword2) authSignupPassword2.value = '';
        
        if (authSignupMsg) { authSignupMsg.textContent = 'Account created ‚Äî loading...'; authSignupMsg.style.color = 'green'; }
        
        // Show entity selection modal for new user
        setTimeout(() => {
          if (preLoginOverlay) preLoginOverlay.classList.add('hidden');
          showEntitySelectModal(userId, 'Individual');
        }, 500);
      });
    }

    // Defensive signup handler - attaches to #signupSubmit button with fallbacks
    (function initDefensiveSignupHandler() {
      try {
        var signupSubmitBtn = document.getElementById('signupSubmit');
        if (!signupSubmitBtn) return;

        signupSubmitBtn.addEventListener('click', async function(e) {
          try {
            e.preventDefault();

            // Get storage key once for use in fallbacks
            var storageKey = (typeof STORAGE_KEY !== 'undefined') ? STORAGE_KEY : 'ntc_full_accounting_v2';

            // Get form field references defensively
            var nameEl = document.getElementById('signupName');
            var usernameEl = document.getElementById('signupUsername');
            var emailEl = document.getElementById('signupEmail');
            var phoneEl = document.getElementById('signupPhone');
            var passwordEl = document.getElementById('signupPassword');
            var planEl = document.getElementById('signupPlan');

            var name = (nameEl && nameEl.value) ? nameEl.value.trim() : '';
            var username = (usernameEl && usernameEl.value) ? usernameEl.value.trim() : '';
            var email = (emailEl && emailEl.value) ? emailEl.value.trim() : '';
            var phone = (phoneEl && phoneEl.value) ? phoneEl.value.trim() : '';
            var password = (passwordEl && passwordEl.value) ? passwordEl.value : '';
            var plan = (planEl && planEl.value) ? planEl.value : 'Individual';

            // Validate required fields
            if (!name || !username || !email || !password) {
              alert('Name, Username, Email, and Password are required.');
              return;
            }

            // Validate email format
            var emailValid = false;
            if (typeof isValidEmail === 'function') {
              emailValid = isValidEmail(email);
            } else {
              // Fallback email validation
              var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              emailValid = emailRegex.test(email);
            }
            if (!emailValid) {
              alert('Please enter a valid email address.');
              return;
            }

            // Validate password minimum length
            if (password.length < 6) {
              alert('Password must be at least 6 characters long.');
              return;
            }

            // Check username uniqueness against state.users
            if (typeof state !== 'undefined' && state.users && Array.isArray(state.users)) {
              var existingUserByUsername = state.users.find(function(u) { return u.username === username; });
              if (existingUserByUsername) {
                alert('Username already exists. Please choose a different username.');
                return;
              }

              // Check email uniqueness
              var existingUserByEmail = state.users.find(function(u) { return u.email === email; });
              if (existingUserByEmail) {
                alert('This email address is already registered. Please use a different email or login with your existing account.');
                return;
              }
            }

            // Hash password using sha256Hex if available, otherwise store plain (prototype only)
            var passwordHash = password;
            if (typeof sha256Hex === 'function') {
              try {
                passwordHash = await sha256Hex(password);
              } catch (hashErr) {
                console.warn('Password hashing failed, using plain password:', hashErr);
              }
            }

            // Generate user ID using uid() or fallback
            var userId;
            if (typeof uid === 'function') {
              userId = uid('user');
            } else {
              // Fallback: generate ID similar to uid() function pattern
              userId = 'user_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
            }

            // Create user object
            var newUser = {
              id: userId,
              username: username,
              display: name,
              email: email,
              phone: phone,
              passwordHash: passwordHash,
              role: 'User',
              isAdmin: false,
              permissions: { view: true, edit: true, delete: false },
              plan: plan,
              createdAt: new Date().toISOString(),
              trialStart: new Date().toISOString(),
              tourSeen: false
            };

            // Add user to state
            if (typeof state !== 'undefined') {
              state.users = state.users || [];
              state.users.push(newUser);
              state.auth = state.auth || {};
              state.auth.currentUserId = userId;
            }

            // Persist state via saveState() or fallback to localStorage
            if (typeof saveState === 'function') {
              try {
                saveState();
              } catch (saveErr) {
                console.warn('saveState() failed, using localStorage fallback:', saveErr);
                try {
                  localStorage.setItem(storageKey, JSON.stringify(state));
                } catch (lsErr) {
                  console.error('localStorage fallback also failed:', lsErr);
                }
              }
            } else {
              // Fallback to localStorage directly
              try {
                localStorage.setItem(storageKey, JSON.stringify(state));
              } catch (lsErr) {
                console.error('localStorage save failed:', lsErr);
              }
            }

            // Log audit entry via addAudit() if available
            if (typeof addAudit === 'function') {
              try {
                addAudit('user.signup', 'user', userId, 'User signed up: ' + username + ' (Plan: ' + plan + ', Email: ' + email + ')');
              } catch (auditErr) {
                console.warn('addAudit() failed:', auditErr);
              }
            }

            // Store lead and notify sales (uses helper function if available, fallback inline)
            if (typeof storeSignupLeadAndNotify === 'function') {
              storeSignupLeadAndNotify(name, email, phone);
            } else {
              // Fallback: inline implementation
              try {
                var leads = JSON.parse(localStorage.getItem('signupLeads') || '[]');
                leads.push({ name: name, email: email, phone: phone, createdAt: Date.now() });
                localStorage.setItem('signupLeads', JSON.stringify(leads));
              } catch (leadErr) {
                console.warn('Failed to store signup lead:', leadErr);
              }
              try {
                var mailtoBody = 'Name: ' + encodeURIComponent(name) + '%0AEmail: ' + encodeURIComponent(email) + '%0APhone: ' + encodeURIComponent(phone);
                var mailtoUrl = 'mailto:salesrepng@gmail.com?subject=New%20Signup&body=' + mailtoBody;
                window.open(mailtoUrl, '_blank');
              } catch (mailtoErr) {
                console.warn('Failed to open mailto:', mailtoErr);
              }
            }

            // Clear form fields
            if (nameEl) nameEl.value = '';
            if (usernameEl) usernameEl.value = '';
            if (emailEl) emailEl.value = '';
            if (phoneEl) phoneEl.value = '';
            if (passwordEl) passwordEl.value = '';
            if (planEl) planEl.value = 'Individual';

            // Close signup modal
            var signupModalEl = document.getElementById('signupModal');
            if (signupModalEl) {
              if (typeof closeModal === 'function') {
                try {
                  closeModal(signupModalEl);
                } catch (closeErr) {
                  signupModalEl.style.display = 'none';
                  var overlay = document.getElementById('modalOverlay');
                  if (overlay) overlay.style.display = 'none';
                }
              } else {
                signupModalEl.style.display = 'none';
                var overlay = document.getElementById('modalOverlay');
                if (overlay) overlay.style.display = 'none';
              }
            }

            // Create default business via createBusinessForUser() if available
            var bizId = null;
            if (typeof createBusinessForUser === 'function') {
              try {
                bizId = createBusinessForUser(userId, plan);
              } catch (bizErr) {
                console.warn('createBusinessForUser() failed:', bizErr);
              }
            }

            // Set selected user and business
            if (typeof selectedUserId !== 'undefined') {
              selectedUserId = userId;
            }
            if (bizId && typeof selectedBizId !== 'undefined') {
              selectedBizId = bizId;
            }

            // Open entity selection modal if present (and createBusinessForUser wasn't called or failed)
            var entitySelectModal = document.getElementById('entitySelectModal');
            if (entitySelectModal && !bizId) {
              if (typeof pendingSignupUserId !== 'undefined') {
                pendingSignupUserId = userId;
              }
              var entitySelectType = document.getElementById('entitySelectType');
              if (entitySelectType) entitySelectType.value = plan;
              if (typeof openModal === 'function') {
                try {
                  openModal(entitySelectModal);
                } catch (openErr) {
                  entitySelectModal.style.display = 'block';
                  var overlay = document.getElementById('modalOverlay');
                  if (overlay) overlay.style.display = 'block';
                }
              } else {
                entitySelectModal.style.display = 'block';
                var overlay = document.getElementById('modalOverlay');
                if (overlay) overlay.style.display = 'block';
              }
            }

            // Trigger video tour for new user if available
            if (typeof showTourModal === 'function' && bizId) {
              try {
                showTourModal(userId);
              } catch (tourErr) {
                console.warn('showTourModal() failed:', tourErr);
              }
            }

            // Refresh UI selects - try multiple approaches
            var uiRefreshed = false;

            // Try populateUserBusinessSelects() if available
            if (typeof populateUserBusinessSelects === 'function') {
              try {
                populateUserBusinessSelects();
                uiRefreshed = true;
              } catch (popErr) {
                console.warn('populateUserBusinessSelects() failed:', popErr);
              }
            }

            // Try populateUsers() if available
            if (typeof populateUsers === 'function') {
              try {
                populateUsers();
                uiRefreshed = true;
              } catch (popErr) {
                console.warn('populateUsers() failed:', popErr);
              }
            }

            // Try refreshSelectors() if available
            if (typeof refreshSelectors === 'function') {
              try {
                refreshSelectors();
                uiRefreshed = true;
              } catch (refErr) {
                console.warn('refreshSelectors() failed:', refErr);
              }
            }

            // Try ensureSelection() if available
            if (typeof ensureSelection === 'function') {
              try {
                ensureSelection();
              } catch (ensErr) {
                console.warn('ensureSelection() failed:', ensErr);
              }
            }

            // Try renderUI() or renderAll() if available
            if (typeof renderUI === 'function') {
              try {
                renderUI();
                uiRefreshed = true;
              } catch (renErr) {
                console.warn('renderUI() failed:', renErr);
              }
            } else if (typeof renderAll === 'function') {
              try {
                renderAll();
                uiRefreshed = true;
              } catch (renErr) {
                console.warn('renderAll() failed:', renErr);
              }
            }

            // Try updateAuthUI() if available
            if (typeof updateAuthUI === 'function') {
              try {
                updateAuthUI();
              } catch (authErr) {
                console.warn('updateAuthUI() failed:', authErr);
              }
            }

            // Last resort: reload the page if UI refresh failed and entity select modal is not open
            // The entity select modal would be handling the rest of the signup flow if open
            var entityModalIsOpen = entitySelectModal && entitySelectModal.style.display === 'block';
            if (!uiRefreshed && !entityModalIsOpen) {
              console.log('UI refresh methods unavailable, reloading page...');
              window.location.reload();
            }

          } catch (handlerErr) {
            console.error('Signup handler error:', handlerErr);
            alert('An error occurred during signup. Please try again.');
          }
        });
      } catch (initErr) {
        console.error('Failed to initialize defensive signup handler:', initErr);
      }
    })();

    // Adjustment type handler
    txnAdjustmentType.addEventListener('change', ()=> {
      const show = txnAdjustmentType.value !== '';
      txnAdjustmentAmountLabel.style.display = show ? 'inline-flex' : 'none';
    });

    // Asset qty/unitPrice auto-computation handlers
    assetQty.addEventListener('input', autoComputeAssetCost);
    assetUnitPrice.addEventListener('input', autoComputeAssetCost);
    
    // Asset category change handler
    assetCategory.addEventListener('change', updateAssetNameSuggestions);

    document.getElementById('btnSearch').addEventListener('click', renderLedger);
    document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

    document.getElementById('btnExport').addEventListener('click', exportJSON);
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', importJSON);
    document.getElementById('btnClearAll').addEventListener('click', clearAllData);

    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; renderTab(); });
    btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; renderTab(); });

    document.querySelectorAll('#reportsSection .tab').forEach(tb => {
      tb.addEventListener('click', (e) => {
        document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
        tb.classList.add('active');
        renderReport(tb.dataset.report);
      });
    });

    document.getElementById('btnExportCsv').addEventListener('click', ()=> exportCurrentReport('csv'));
    document.getElementById('btnExportPdf').addEventListener('click', ()=> exportCurrentReport('pdf'));
    document.getElementById('btnExportXlsx').addEventListener('click', ()=> exportCurrentReport('xlsx'));
  }

  // UI helper functions
  function openUserModal(editId){
    userModalTitle.textContent = editId ? 'Edit User' : 'Add User';
    userName.value = ''; userDisplay.value = ''; userRole.value = 'User';
    permView.checked = permEdit.checked = permDelete.checked = false;
    userSave.dataset.edit = editId || '';
    
    // Check 3-user limit per business when adding new users
    if(!editId && selectedBizId) {
      if(!canAddUserToBusiness(selectedBizId)) {
        alert('User limit reached! This business already has the maximum of ' + MAX_USERS_PER_BUSINESS + ' users. Cannot add more users.');
        return;
      }
    }
    
    if(editId){
      const u = state.users.find(x=>x.id===editId);
      if(u){ userName.value = u.username; userDisplay.value = u.display || u.username; userRole.value = u.role; permView.checked = !!u.permissions?.view; permEdit.checked = !!u.permissions?.edit; permDelete.checked = !!u.permissions?.delete; }
    }
    openModal(userModal);
  }
  function saveUser(){
    const username = (userName.value||'').trim();
    if(!username) return alert('Username required');
    const editId = userSave.dataset.edit;
    if(editId){
      const u = state.users.find(x=>x.id===editId);
      u.username = username; u.display = userDisplay.value || username; u.role = userRole.value;
      u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked };
      addAudit('user.edit','user',u.id,'Edited user');
    } else {
      // Check 3-user limit per business before adding
      if(selectedBizId && !canAddUserToBusiness(selectedBizId)) {
        return alert('User limit reached! This business already has the maximum of ' + MAX_USERS_PER_BUSINESS + ' users. Cannot add more users.');
      }
      
      // Check username uniqueness
      const existingUser = state.users.find(u => u.username === username);
      if(existingUser) {
        return alert('Username already exists. Please choose a different username.');
      }
      
      const newUser = { id: uid('user'), username, display: userDisplay.value || username, role: userRole.value, isAdmin: userRole.value==='Admin', permissions: { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked }, createdAt: new Date().toISOString(), tourSeen: true };
      state.users.push(newUser);
      state.transactions[newUser.id] = state.transactions[newUser.id] || {};
      for(const b of state.businesses) state.transactions[newUser.id][b.id] = state.transactions[newUser.id][b.id] || [];
      
      // Associate user with current business if selected
      if(selectedBizId) {
        const biz = findBiz(selectedBizId);
        if(biz) {
          biz.userIds = biz.userIds || [];
          if(!biz.userIds.includes(newUser.id)) {
            biz.userIds.push(newUser.id);
          }
        }
      }
      
      addAudit('user.add','user',newUser.id,'Added user to business: ' + (selectedBizId || 'none'));
    }
    saveState();
    closeModal(userModal);
    refreshSelectors();
    ensureSelection();
    renderAll();
  }

  function openAddBusinessModal(){
    businessModalTitle.textContent = 'Add Business';
    bizName.value = ''; bizOwnerSelect.value = state.users[0] ? state.users[0].id : '';
    bizEntity.value = 'Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate;
    bizTurnoverThreshold.value = DEFAULTS.turnoverThreshold;
    bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
    bizSave.dataset.edit = '';
    bizContactsList.innerHTML = '';
    openModal(businessModal);
  }
  function openEditBusinessModal(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId); if(!b) return alert('Business not found');
    businessModalTitle.textContent = 'Edit Business';
    bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (state.users[0] && state.users[0].id) || '';
    bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
    bizTurnoverThreshold.value = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
    bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled;
    bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0;
    bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax;
    bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
    bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0;
    renderBizContacts(b);
    bizSave.dataset.edit = b.id;
    openModal(businessModal);
  }
  function saveBusiness(){
    const name = (bizName.value||'').trim();
    if(!name) return alert('Business name required');
    const editId = bizSave.dataset.edit;
    if(editId){
      const b = findBiz(editId);
      if(!b) return alert('Business not found');
      b.name = name; b.ownerId = bizOwnerSelect.value; b.entity = bizEntity.value;
      b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
      b.turnoverThreshold = Number(bizTurnoverThreshold.value || DEFAULTS.turnoverThreshold);
      b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked;
      b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0);
      b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked;
      b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) };
      addAudit('business.edit','business', b.id, 'Edited business');
    } else {
      const newBiz = {
        id: uid('biz'), name, ownerId: bizOwnerSelect.value || (state.users[0] && state.users[0].id),
        entity: bizEntity.value, 
        vatRate: Number(bizVat.value||DEFAULTS.vatRate), 
        whtRate: Number(bizWht.value||DEFAULTS.whtRate), 
        citRate: Number(bizCit.value||DEFAULTS.citRate),
        turnoverThreshold: Number(bizTurnoverThreshold.value||DEFAULTS.turnoverThreshold),
        vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
        accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward:0, caCarryForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS.depRateDefault
      };
      newBiz.accounts.push({ id: uid('acct'), name:'Sales', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
      newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
      newBiz.accounts.push({ id: uid('acct'), name:'Purchases', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
      newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
      newBiz.accounts.push({ id: uid('acct'), name:'Bank', category:'Asset', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 });
      newBiz.accounts.push({ id: uid('acct'), name:'Chargeable asset income', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
      newBiz.accounts.push({ id: uid('acct'), name:'Chargeable asset cost', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
      state.businesses.push(newBiz);
      for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][newBiz.id] = []; }
      addAudit('business.add','business', newBiz.id, 'Added business');
    }
    saveState();
    closeModal(businessModal);
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    renderAll();
  }

  function addContactToBiz(){
    if(!selectedBizId) return alert('Select business first');
    const b = findBiz(selectedBizId);
    const name = (newContactName.value||'').trim();
    if(!name) return alert('Contact name required');
    b.contacts = b.contacts || [];
    b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } });
    saveState();
    renderBizContacts(b);
  }

  function addAccount(){
    const name = (newAccountName.value||'').trim();
    const cat = newAccountCategory.value;
    const dis = !!newAccountDisallowable.checked;
    const nt = !!newAccountNonTax.checked;
    const rentFreq = newAccountRentFreq.value || '';
    if(!name) return alert('Account name required');
    const b = findBiz(selectedBizId);
    b.accounts = b.accounts || [];
    const newAcct = { id: uid('acct'), name, category: cat, disallowableDefault:dis, nonTaxableDefault:nt, rentFreq:rentFreq };
    b.accounts.push(newAcct);
    addAudit('account.add','account', newAcct.id, `Added account: ${name}`);
    saveState();
    renderAccounts();
    populateAccountSelect();
  }

  function renderFeatureVisibility(){
    // Handle Individual entity restrictions
    const b = findBiz(selectedBizId);
    if (!b) return;
    
    const isIndividual = b.entity === 'Individual';
    
    if (isIndividual) {
      // Hide panels and elements for Individual
      const inventoryQuick = document.querySelector('#quickPanels > div:nth-child(1)');
      const assetsQuick = document.querySelector('#quickPanels > div:nth-child(2)');
      const plQuick = document.querySelector('#quickPanels > div:nth-child(3)');
      if(inventoryQuick) inventoryQuick.style.display = 'none';
      if(assetsQuick) assetsQuick.style.display = 'none';
      if(plQuick) plQuick.style.display = 'none';
      
      // Restrict actions - only show Income for Individuals
      Array.from(txnAction.options).forEach(opt => {
        if (opt.value && opt.value !== 'Income') {
          opt.style.display = 'none';
        } else if (opt.value === 'Income') {
          opt.style.display = '';
        }
      });
      
      // Restrict accounts - show Individual income accounts, hide Salary
      Array.from(txnAccount.options).forEach(opt => {
        const accountText = opt.textContent.split(' (')[0]; // Get name without category
        if (accountText === 'Salary') {
          opt.style.display = 'none';  // Hide Salary for Individual
        } else if (['Dividend', 'Interest', 'Royalty', 'Rent', 'Benefit in kind', 'Share of profit', 'Sales Revenue'].includes(accountText)) {
          opt.style.display = '';  // Show Individual income accounts
        } else {
          opt.style.display = 'none';
        }
      });
    } else {
      // Show all panels for non-Individual entities
      const inventoryQuick = document.querySelector('#quickPanels > div:nth-child(1)');
      const assetsQuick = document.querySelector('#quickPanels > div:nth-child(2)');
      const plQuick = document.querySelector('#quickPanels > div:nth-child(3)');
      if(inventoryQuick) inventoryQuick.style.display = 'block';
      if(assetsQuick) assetsQuick.style.display = 'block';
      if(plQuick) plQuick.style.display = 'block';
      
      // Show all actions and accounts for non-Individual entities
      Array.from(txnAction.options).forEach(opt => { opt.style.display = ''; });
      Array.from(txnAccount.options).forEach(opt => { opt.style.display = ''; });
    }
  }

  function txnActionChanged(){
    const val = txnAction.value;
    if(val === 'InventoryPurchase' || val === 'InventorySale'){
      mainTxnForm.style.display = 'none';
      inventorySubform.style.display = 'block';
      assetPurchaseSubform.style.display = 'none';
      assetDisposalSubform.style.display = 'none';
      populateAccountSelect();
      renderFeatureVisibility();
    } else if(val === 'AssetPurchase' || val === 'OpeningAssetBal'){
      mainTxnForm.style.display = 'none';
      assetPurchaseSubform.style.display = 'block';
      assetDisposalSubform.style.display = 'none';
      inventorySubform.style.display = 'none';
      populateAccountSelect();
      renderFeatureVisibility();
      
      // Update UI labels and field behavior for asset actions
      if(val === 'OpeningAssetBal') {
        document.querySelector('#assetPurchaseSubform h3').textContent = 'Opening Asset Balance';
        btnAddAsset.textContent = 'Record Opening Balance';
        // For Opening Asset Bal: disable Cost, auto-compute Opening Cost
        assetCost.disabled = true;
        assetOpeningCost.disabled = false;
        assetOpeningAccDep.disabled = false;
      } else {
        document.querySelector('#assetPurchaseSubform h3').textContent = 'Asset Purchase';
        btnAddAsset.textContent = 'Record Asset Purchase';
        // For Asset Purchase: disable Opening Cost/Acc Dep, auto-compute Cost
        assetCost.disabled = false;
        assetOpeningCost.disabled = true;
        assetOpeningAccDep.disabled = true;
      }
      
      // Set default account to Bank if available
      setDefaultAssetAccount();
    } else if(val === 'AssetDisposal'){
      mainTxnForm.style.display = 'none';
      assetDisposalSubform.style.display = 'block';
      assetPurchaseSubform.style.display = 'none';
      inventorySubform.style.display = 'none';
      populateAccountSelect();
      renderFeatureVisibility();
      // Set default account to Bank if available
      setDefaultAssetAccount();
    } else {
      mainTxnForm.style.display = 'flex';
      inventorySubform.style.display = 'none';
      assetPurchaseSubform.style.display = 'none';
      assetDisposalSubform.style.display = 'none';
      renderFeatureVisibility();
    }
  }

  function setDefaultAssetAccount(){
    const b = findBiz(selectedBizId);
    if(!b) return;
    const bankAccount = b.accounts.find(a => a.name === 'Bank' && a.category === 'Asset');
    if(bankAccount){
      if(assetPurchaseAccount) assetPurchaseAccount.value = bankAccount.id;
      if(assetDisposalAccount) assetDisposalAccount.value = bankAccount.id;
    }
  }

  function autoComputeAssetCost(){
    const action = txnAction.value;
    const qty = Number(assetQty.value || 0);
    const unitPrice = Number(assetUnitPrice.value || 0);
    const computed = qty * unitPrice;
    
    if(action === 'AssetPurchase'){
      // Auto-compute Cost
      assetCost.value = computed;
    } else if(action === 'OpeningAssetBal'){
      // Auto-compute Opening Cost
      assetOpeningCost.value = computed;
    }
  }

  function updateAssetNameSuggestions(){
    const category = assetCategory.value;
    const datalist = document.getElementById('assetNameSuggestions');
    datalist.innerHTML = '';
    
    // For "Other Asset" category, provide the removed asset names as suggestions
    if(category === 'Other Asset'){
      const otherAssetNames = ['Shares', 'Options', 'Rights', 'Debt', 'Digital/Virtual Asset'];
      for(const name of otherAssetNames){
        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
      }
    }
  }

  function exportJSON(){
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'ntc_full_data.json'; a.click(); URL.revokeObjectURL(url);
  }
  function importJSON(e){
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const incoming = JSON.parse(r.result);
        if(!confirm('Import will replace current data. Continue?')) return;
        state = incoming;
        migrateState();
        refreshSelectors();
        ensureSelection();
        populateAccountSelect();
        resetForms();
        renderAll();
        saveState();
        alert('Import complete');
      } catch(err){ alert('Invalid JSON'); }
    };
    r.readAsText(f);
  }
  function clearAllData(){
    if(!confirm('Clear all stored data?')) return;
    localStorage.removeItem(STORAGE_KEY);
    state = { users:[], businesses:[], transactions:{}, attachments:{}, audit:[], auth:{ currentUserId:null } };
    seedDemo();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    resetForms();
    renderAll();
  }

  // Helper finders
  function findUser(id){ return state.users.find(u=>u.id===id); }
  function findBiz(id){ return state.businesses.find(b=>b.id===id); }
  function findAccount(biz, acctId){ return (biz.accounts||[]).find(a=>a.id===acctId); }

  // UI: selection and refresh
  function refreshSelectors(){
    userSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); }
    businessSelect.innerHTML = '';
    for(const b of state.businesses){ const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name; businessSelect.appendChild(opt); }
    bizOwnerSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; bizOwnerSelect.appendChild(opt); }
  }
  function ensureSelection(){
    if(!selectedUserId && state.users[0]) selectedUserId = state.users[0].id;
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    userSelect.value = selectedUserId || (state.users[0] && state.users[0].id) || '';
    businessSelect.value = selectedBizId || (state.businesses[0] && state.businesses[0].id) || '';
    userSelect.addEventListener('change', ()=> { selectedUserId = userSelect.value; renderAll(); });
    businessSelect.addEventListener('change', ()=> { selectedBizId = businessSelect.value; populateAccountSelect(); renderAll(); renderFeatureVisibility(); });
    if(state.auth.currentUserId) selectedUserId = state.auth.currentUserId;
    userSelect.value = selectedUserId;
  }

  function populateAccountSelect(){
    txnAccount.innerHTML = '';
    invAccountSelect.innerHTML = '';
    assetPurchaseAccount.innerHTML = '';
    assetDisposalAccount.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of b.accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' ('+a.category+')';
      txnAccount.appendChild(opt);
      const opt2 = opt.cloneNode(true);
      invAccountSelect.appendChild(opt2);
      const opt3 = opt.cloneNode(true);
      assetPurchaseAccount.appendChild(opt3);
      const opt4 = opt.cloneNode(true);
      assetDisposalAccount.appendChild(opt4);
    }
    renderInventorySelect();
    renderAssetDisposeSelect();
  }

  function renderInventorySelect(){
    invItemSelect.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const it of (b.inventory||[])){
      const opt = document.createElement('option'); opt.value = it.id; opt.textContent = it.name + ' (Qty: ' + (it.qty||0) + ')';
      invItemSelect.appendChild(opt);
    }
    const newOpt = document.createElement('option'); newOpt.value = '__new__'; newOpt.textContent = '-- Add new item --'; invItemSelect.appendChild(newOpt);
  }

  function renderAssetDisposeSelect(){
    assetDisposeSelect.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of (b.assets||[])){
      if(!a.disposed){
        const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' (Cost: ' + fmt(a.cost) + ')';
        assetDisposeSelect.appendChild(opt);
      }
    }
  }

  // Reset forms and defaults
  function resetForms(){
    txnDate.value = today();
    txnAction.value = '';
    txnAccount.selectedIndex = 0;
    txnDesc.value = '';
    txnAmount.value = '';
    txnVatType.value = 'none';
    txnWht.checked = false; txnWhtRate.value = ''; txnWhtBasis.value='gross';
    txnSalary.checked = false;
    txnContact.value = '';
    txnReceipt.value = '';

    invItemSelect.value=''; invNewName.value=''; invAccountSelect.selectedIndex=0; invQty.value=''; invUnitPrice.value=''; invVatType.value='none'; invContact.value=''; invReceipt.value=''; invOpeningQty.value=''; invOpeningAvgCost.value='';

    assetName.value=''; assetQty.value=1; assetUnitPrice.value=''; assetCost.value=''; assetOpeningCost.value=''; assetOpeningAccDep.value=''; assetPurchaseDate.value=''; assetLife.value=''; assetCA.value=''; assetPurchaseAccount.selectedIndex=0; assetClassification.value='Fixed'; assetDepRate.value=''; assetContact.value=''; assetReceipt.value='';
    assetDisposalDate.value=''; assetDisposalProceeds.value=''; assetDisposalAccount.selectedIndex=0; assetDisposalContact.value=''; assetDisposalReceipt.value='';

    // ensure add button text resets
    btnAddTxn.textContent = 'Add';
    btnAddTxn.dataset.edit = '';
    try { btnAddTxn.removeEventListener('click', saveEditedTxnHandler); } catch(e){}
    try { btnAddTxn.addEventListener('click', handleAddTransaction); } catch(e){}
  }

  // Add transaction (basic)
  function handleAddTransaction(){
    if(!selectedUserId || !selectedBizId) return alert('Select user & business');
    const b = findBiz(selectedBizId);
    
    // Handle adjustment transactions
    if(txnAdjustmentType.value && txnAdjustmentType.value !== ''){
      const adjustmentAmount = Number(txnAdjustmentAmount.value || 0);
      if(adjustmentAmount <= 0) return alert('Adjustment amount required');
      
      const adjTxn = {
        id: uid('txn'),
        date: txnDate.value || today(),
        action: 'Adjustment',
        accountId: txnAccount.value,
        accountName: findAccount(b, txnAccount.value)?.name || '',
        accountCategory: findAccount(b, txnAccount.value)?.category || '',
        description: `Adjustment: ${txnAdjustmentType.value === 'disallowable' ? 'Disallowable expense' : 'Non-taxable income'}`,
        amount: adjustmentAmount,
        adjustmentType: txnAdjustmentType.value,
        vatType: 'none',
        whtApplied: false,
        paye: false,
        contact: '',
        receiptId: null
      };
      pushTransaction(adjTxn);
      return;
    }
    
    const t = {
      id: uid('txn'),
      date: txnDate.value || today(),
      action: txnAction.value || 'Expense',
      accountId: txnAccount.value,
      accountName: findAccount(b, txnAccount.value)?.name || '',
      accountCategory: findAccount(b, txnAccount.value)?.category || '',
      description: txnDesc.value || '',
      amount: Number(txnAmount.value || 0),
      vatType: txnVatType.value || 'none',
      whtApplied: !!txnWht.checked,
      whtRate: Number(txnWhtRate.value || 0),
      whtBasis: txnWhtBasis.value || 'gross',
      paye: !!txnSalary.checked,
      contact: txnContact.value || '',
      receiptId: null
    };
    if(txnReceipt.files && txnReceipt.files[0]){
      const r = txnReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        t.receiptId = id;
        pushTransaction(t);
      };
      reader.readAsDataURL(r);
    } else {
      pushTransaction(t);
    }
  }
  function pushTransaction(txn){
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(txn);
    addAudit('txn.add','txn',txn.id, `Added txn ${txn.action} ${txn.amount}`);
    saveState();
    resetForms();
    txnAction.value=''; inventorySubform.style.display='none'; assetPurchaseSubform.style.display='none'; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex';
    renderAll();
  }

  // Inventory handlers
  function handleInventoryAction(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const selectedItemId = invItemSelect.value;
    if(selectedItemId === '__new__'){
      const name = (invNewName.value || '').trim();
      if(!name) return alert('New item name required');
      const item = { id: uid('item'), name, qty: Number(invQty.value||0), avgCost: Number(invUnitPrice.value || 0) };
      if(Number(invOpeningQty.value)){
        item.qty = Number(invOpeningQty.value);
        item.avgCost = Number(invOpeningAvgCost.value || item.avgCost);
      }
      b.inventory = b.inventory || [];
      b.inventory.push(item);
      addAudit('inv.add','inventory', item.id, `Added inventory ${item.name}`);
    } else {
      const item = (b.inventory||[]).find(x=>x.id===selectedItemId);
      if(!item) return alert('Item not found');
      const qty = Number(invQty.value || 0);
      const unit = Number(invUnitPrice.value || 0);
      if(txnAction.value === 'InventoryPurchase'){
        const existingValue = (item.qty || 0) * (item.avgCost || 0);
        const incomingValue = qty * unit;
        const newQty = (item.qty || 0) + qty;
        item.avgCost = newQty ? ((existingValue + incomingValue) / newQty) : item.avgCost;
        item.qty = newQty;
      } else if(txnAction.value === 'InventorySale'){
        item.qty = (item.qty || 0) - qty;
        if(item.qty < 0) item.qty = 0;
      }
      addAudit('inv.update','inventory', item.id, `Inventory updated ${item.name}`);
    }
    const t = { id: uid('txn'), date: today(), action: txnAction.value || 'InventoryPurchase', accountId: invAccountSelect.value, accountName: findAccount(b, invAccountSelect.value)?.name || '', accountCategory: findAccount(b, invAccountSelect.value)?.category || '', description: 'Inventory '+ (invNewName.value||findItemName(invItemSelect.value)), qty: Number(invQty.value||0), unitPrice: Number(invUnitPrice.value||0), amount: Number((invQty.value||0)*(invUnitPrice.value||0)), vatType: invVatType.value || 'none', whtApplied:false, paye:false, contact: invContact.value || '', receiptId:null };
    if(invReceipt.files && invReceipt.files[0]){
      const r = invReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        t.receiptId = id;
        pushInventoryTxn(t);
      };
      reader.readAsDataURL(r);
    } else pushInventoryTxn(t);
  }
  function pushInventoryTxn(t){
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('txn.inv','txn',t.id, `Inventory txn ${t.action} ${t.amount}`);
    saveState();
    txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex';
    resetForms();
    renderAll();
  }
  function handleUndoInventory(){
    const arr = state.transactions[selectedUserId][selectedBizId];
    for(let i=arr.length-1;i>=0;i--){
      if(arr[i].action && arr[i].action.startsWith('Inventory')){
        arr.splice(i,1);
        addAudit('txn.undo','txn','','Undo inventory txn');
        saveState();
        renderAll();
        return alert('Undid last inventory transaction (ledger entry removed). Inventory quantities may require manual adjustment.');
      }
    }
    alert('No inventory transaction found to undo');
  }

  // Asset handlers
  function handleAddAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const isOpeningBalance = txnAction.value === 'OpeningAssetBal';
    
    // For opening balance: auto-compute opening cost from qty * unit price
    let computedCost = Number(assetQty.value || 1) * Number(assetUnitPrice.value || 0);
    let computedOpeningCost = isOpeningBalance ? computedCost : Number(assetOpeningCost.value || 0);
    
    const item = {
      id: uid('asset'),
      name: assetName.value || 'Asset',
      category: assetCategory.value || 'Other Asset',
      qty: Number(assetQty.value || 1),
      unitPrice: Number(assetUnitPrice.value || 0),
      cost: isOpeningBalance ? 0 : computedCost, // Opening balance sets cost to 0, openingCost holds value
      openingCost: computedOpeningCost,
      openingAccDep: Number(assetOpeningAccDep.value || 0),
      purchaseDate: assetPurchaseDate.value || today(),
      lifeYears: Number(assetLife.value || 0),
      caPercent: Number(assetCA.value || findBiz(selectedBizId)?.caRateDefault || DEFAULTS.caRateDefault),
      depRate: Number(assetDepRate.value || findBiz(selectedBizId)?.depRateDefault || DEFAULTS.depRateDefault),
      classification: assetClassification.value || 'Fixed',
      accumulatedDep: Number(assetOpeningAccDep.value || 0),
      disposed: false,
      disposal: {}
    };
    b.assets = b.assets || [];
    b.assets.push(item);
    
    const actionType = isOpeningBalance ? 'OpeningAssetBal' : 'AssetPurchase';
    const txnAmount = isOpeningBalance ? computedOpeningCost : computedCost;
    const t = { 
      id: uid('txn'), 
      date: item.purchaseDate, 
      action: actionType, 
      accountId: assetPurchaseAccount.value, 
      accountName: findAccount(b, assetPurchaseAccount.value)?.name || '', 
      accountCategory: findAccount(b, assetPurchaseAccount.value)?.category || '', 
      description: isOpeningBalance ? `Opening balance: ${item.name}` : `Asset purchase ${item.name}`, 
      amount: txnAmount, 
      qty: item.qty, 
      unitPrice: item.unitPrice, 
      vatType:'none', 
      whtApplied:false, 
      paye:false, 
      contact: assetContact.value || '', 
      receiptId:null 
    };
    if(assetReceipt.files && assetReceipt.files[0]){
      const r = assetReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        t.receiptId = id;
        pushAssetTxn(t);
      };
      reader.readAsDataURL(r);
    } else pushAssetTxn(t);
  }
  function pushAssetTxn(t){
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('asset.add','asset',t.id, `Added asset txn ${t.description}`);
    saveState();
    txnAction.value=''; assetPurchaseSubform.style.display='none'; mainTxnForm.style.display='flex';
    resetForms();
    renderAll();
  }
  function handleDisposeAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const aid = assetDisposeSelect.value;
    const asset = (b.assets||[]).find(a=>a.id===aid);
    if(!asset) return alert('Select asset to dispose');
    
    const qtyDisposed = Number(assetDisposalQty.value || 1);
    if(qtyDisposed > (asset.qty || 1)) return alert('Cannot dispose more than available quantity');
    
    asset.disposed = qtyDisposed >= (asset.qty || 1); // Fully disposed if qty matches
    asset.disposal = { 
      date: assetDisposalDate.value || today(), 
      proceeds: Number(assetDisposalProceeds.value || 0), 
      qty: qtyDisposed,
      accountId: assetDisposalAccount.value || '', 
      accountName: findAccount(b, assetDisposalAccount.value)?.name || '' 
    };
    
    // Compute Tax Written Down Value (TWDV)
    // TWDV = cost - accumulated depreciation - capital allowances claimed
    // Use residual value of ‚Ç¶10 at end of useful life
    const totalCost = (asset.cost || 0) + (asset.openingCost || 0);
    const totalAccDep = (asset.accumulatedDep || 0) + (asset.openingAccDep || 0);
    let twdv = Math.max(totalCost - totalAccDep, ASSET_RESIDUAL_VALUE);
    
    // Chargeable gain/loss = proceeds - TWDV
    const gain = (asset.disposal.proceeds || 0) - twdv;
    asset.disposal.gain = gain;
    asset.disposal.twdv = twdv;
    
    // Update asset qty if partial disposal
    if(!asset.disposed) {
      asset.qty = (asset.qty || 1) - qtyDisposed;
    }
    
    addAudit('asset.dispose','asset',asset.id, `Disposed asset ${asset.name} qty ${qtyDisposed} gain ${gain}`);
    const t = { id: uid('txn'), date: asset.disposal.date, action: 'AssetDisposal', accountId: assetDisposalAccount.value, accountName: findAccount(b, assetDisposalAccount.value)?.name || '', accountCategory: findAccount(b, assetDisposalAccount.value)?.category || '', description: `Asset disposal ${asset.name} (qty: ${qtyDisposed})`, amount: asset.disposal.proceeds, gain: gain, qty: qtyDisposed, vatType:'none', whtApplied:false, paye:false, contact: assetDisposalContact.value || '', receiptId:null, assetId: asset.id };
    if(assetDisposalReceipt.files && assetDisposalReceipt.files[0]){
      const r = assetDisposalReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        t.receiptId = id;
        pushAssetDisposeTxn(t);
      };
      reader.readAsDataURL(r);
    } else pushAssetDisposeTxn(t);
  }
  function pushAssetDisposeTxn(t){
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('txn.asset.dispose','txn',t.id, `Asset disposal txn ${t.amount}`);
    saveState();
    txnAction.value=''; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex';
    resetForms();
    renderAll();
  }
  function handleUndoAsset(){
    const arr = state.transactions[selectedUserId][selectedBizId] || [];
    for(let i=arr.length-1;i>=0;i--){
      if(arr[i].action && (arr[i].action === 'AssetPurchase' || arr[i].action === 'AssetDisposal')){
        const tx = arr.splice(i,1)[0];
        if(tx.assetId){
          const b = findBiz(selectedBizId);
          const a = b.assets.find(x=>x.id===tx.assetId);
          if(a) { a.disposed = false; a.disposal = {}; }
        }
        addAudit('txn.undo','txn','','Undo asset txn');
        saveState();
        renderAll();
        return alert('Undid last asset transaction (ledger entry removed). Asset state may require manual adjustment.');
      }
    }
    alert('No asset transaction found to undo');
  }

  // Find item name helper (fixed)
  function findItemName(id){
    const b = findBiz(selectedBizId);
    if(!b) return '';
    const it = (b.inventory||[]).find(x=>x.id===id);
    return it ? it.name : '';
  }

  // Ledger rendering & edit (fixed to avoid inline onclick string issues)
  function renderLedger(){
    ledgerTableBody.innerHTML = '';
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    const search = (document.getElementById('ledgerSearch').value || '').toLowerCase();
    for(const t of arr){
      if(search){
        const hay = `${t.date} ${t.action} ${t.accountName || ''} ${t.description || ''} ${t.amount || ''} ${t.contact || ''}`.toLowerCase();
        if(!hay.includes(search)) continue;
      }
      const tr = document.createElement('tr');

      const tdDate = document.createElement('td'); tdDate.textContent = t.date || '';
      const tdAction = document.createElement('td'); tdAction.textContent = t.action || '';
      const tdAccount = document.createElement('td'); tdAccount.textContent = t.accountName || '';
      const tdDesc = document.createElement('td'); tdDesc.textContent = t.description || '';
      const tdAmount = document.createElement('td'); tdAmount.textContent = fmt(t.amount||0);
      const tdVat = document.createElement('td'); tdVat.textContent = t.vatType || '';
      const tdWht = document.createElement('td'); tdWht.textContent = t.whtApplied ? ((t.whtRate || findBiz(selectedBizId)?.whtRate||DEFAULTS.whtRate) + '%') : '';
      const tdPaye = document.createElement('td'); tdPaye.textContent = t.paye ? 'Yes' : '';
      const tdContact = document.createElement('td'); tdContact.textContent = t.contact || '';
      const tdReceipt = document.createElement('td');
      if(t.receiptId){
        const link = document.createElement('span');
        link.className = 'link-like';
        link.textContent = 'View';
        link.addEventListener('click', ()=> viewReceipt(t.receiptId));
        tdReceipt.appendChild(link);
      } else {
        tdReceipt.textContent = '';
      }
      const tdActions = document.createElement('td');

      const editBtn = document.createElement('button'); editBtn.textContent = 'Edit'; editBtn.className='small';
      editBtn.addEventListener('click', ()=> openEditTxn(t));
      const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='small danger';
      delBtn.addEventListener('click', ()=> { if(!confirm('Delete txn?')) return; deleteTxn(t.id); });

      tdActions.appendChild(editBtn);
      tdActions.appendChild(delBtn);

      tr.appendChild(tdDate);
      tr.appendChild(tdAction);
      tr.appendChild(tdAccount);
      tr.appendChild(tdDesc);
      tr.appendChild(tdAmount);
      tr.appendChild(tdVat);
      tr.appendChild(tdWht);
      tr.appendChild(tdPaye);
      tr.appendChild(tdContact);
      tr.appendChild(tdReceipt);
      tr.appendChild(tdActions);

      ledgerTableBody.appendChild(tr);
    }
  }

  function viewReceipt(id){
    const att = state.attachments[id];
    if(!att) return alert('Receipt not found');
    const w = window.open('', '_blank');
    w.document.write(`<h3>${att.name}</h3><img src="${att.data}" style="max-width:100%"/>`);
  }

  function openEditTxn(tx){
    if(!tx) return;
    if(tx.action === 'InventoryPurchase' || tx.action === 'InventorySale'){
      txnAction.value = tx.action;
      mainTxnForm.style.display='none';
      inventorySubform.style.display='block';
      assetPurchaseSubform.style.display='none';
      assetDisposalSubform.style.display='none';
      renderInventorySelect();
      invNewName.value = tx.description || '';
      invQty.value = tx.qty || '';
      invUnitPrice.value = tx.unitPrice || '';
      invContact.value = tx.contact || '';
      return;
    } else if(tx.action === 'AssetPurchase'){
      txnAction.value = tx.action;
      mainTxnForm.style.display='none';
      assetPurchaseSubform.style.display='block';
      inventorySubform.style.display='none';
      assetDisposalSubform.style.display='none';
      assetName.value = tx.description || '';
      assetCost.value = tx.amount || '';
      assetQty.value = tx.qty || 1;
      assetUnitPrice.value = tx.unitPrice || '';
      assetContact.value = tx.contact || '';
      return;
    } else if(tx.action === 'AssetDisposal'){
      txnAction.value = tx.action;
      mainTxnForm.style.display='none';
      assetDisposalSubform.style.display='block';
      assetPurchaseSubform.style.display='none';
      inventorySubform.style.display='none';
      assetDisposalDate.value = tx.date || '';
      assetDisposalProceeds.value = tx.amount || '';
      assetDisposalContact.value = tx.contact || '';
      return;
    }
    txnDate.value = tx.date || today();
    txnAction.value = tx.action || '';
    txnAccount.value = tx.accountId || '';
    txnDesc.value = tx.description || '';
    txnAmount.value = tx.amount || '';
    txnVatType.value = tx.vatType || 'none';
    txnWht.checked = !!tx.whtApplied; txnWhtRate.value = tx.whtRate || '';
    txnSalary.checked = !!tx.paye;
    txnContact.value = tx.contact || '';

    btnAddTxn.textContent = 'Save';
    btnAddTxn.dataset.edit = tx.id;
    btnAddTxn.removeEventListener('click', handleAddTransaction);
    btnAddTxn.addEventListener('click', saveEditedTxnHandler);
  }

  function saveEditedTxnHandler(){
    const editId = btnAddTxn.dataset.edit;
    if(!editId) return;
    const arr = state.transactions[selectedUserId][selectedBizId];
    const tx = arr.find(x=>x.id===editId);
    if(!tx) return alert('Transaction not found');
    tx.date = txnDate.value || tx.date;
    tx.action = txnAction.value || tx.action;
    tx.accountId = txnAccount.value;
    tx.accountName = findAccount(findBiz(selectedBizId), txnAccount.value)?.name || tx.accountName;
    tx.accountCategory = findAccount(findBiz(selectedBizId), txnAccount.value)?.category || tx.accountCategory;
    tx.description = txnDesc.value;
    tx.amount = Number(txnAmount.value || 0);
    tx.vatType = txnVatType.value;
    tx.whtApplied = !!txnWht.checked; tx.whtRate = Number(txnWhtRate.value || 0); tx.whtBasis = txnWhtBasis.value || 'gross';
    tx.paye = !!txnSalary.checked;
    tx.contact = txnContact.value || '';
    if(txnReceipt.files && txnReceipt.files[0]){
      const r = txnReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        tx.receiptId = id;
        finishSaveEdit(tx);
      };
      reader.readAsDataURL(r);
    } else finishSaveEdit(tx);
  }
  function finishSaveEdit(tx){
    saveState();
    addAudit('txn.edit','txn',tx.id,'Edited txn');
    btnAddTxn.textContent = 'Add';
    btnAddTxn.dataset.edit = '';
    try { btnAddTxn.removeEventListener('click', saveEditedTxnHandler); } catch(e){}
    try { btnAddTxn.addEventListener('click', handleAddTransaction); } catch(e){}
    resetForms();
    renderAll();
  }

  function deleteTxn(id){
    const arr = state.transactions[selectedUserId][selectedBizId];
    const idx = arr.findIndex(x=>x.id===id);
    if(idx>=0){ arr.splice(idx,1); saveState(); addAudit('txn.del','txn',id,'Deleted txn'); renderAll(); }
  }

  // Render overall UI
  function renderAll(){
    populateAccountSelect();
    renderLedger();
    renderQuickPanels();
    renderTaxSummary();
    renderReportsTabState();
  }

  function renderQuickPanels(){
    inventoryListDiv.innerHTML = '';
    assetListDiv.innerHTML = '';
    plSnapshotQuick.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    if(b.inventory && b.inventory.length){
      for(const it of b.inventory){
        const d = document.createElement('div'); d.className='account-row'; d.innerHTML = `<div><strong>${it.name}</strong><div class="small-muted">Qty: ${it.qty || 0} | Avg cost: ${fmt(it.avgCost||0)}</div></div>`;
        inventoryListDiv.appendChild(d);
      }
    }
    
    // Group assets by category and compute totals
    if(b.assets && b.assets.length){
      const assetsByCategory = {};
      for(const a of b.assets){
        const cat = a.category || 'Other Asset';
        if(!assetsByCategory[cat]) {
          assetsByCategory[cat] = { assets: [], totalCost: 0, totalAccDep: 0, totalNBV: 0 };
        }
        const totalCost = (a.cost || 0) + (a.openingCost || 0);
        const totalAccDep = (a.accumulatedDep || 0) + (a.openingAccDep || 0);
        const nbv = totalCost - totalAccDep;
        
        assetsByCategory[cat].assets.push(a);
        assetsByCategory[cat].totalCost += totalCost;
        assetsByCategory[cat].totalAccDep += totalAccDep;
        assetsByCategory[cat].totalNBV += nbv;
      }
      
      // Display by category
      for(const cat in assetsByCategory){
        const catData = assetsByCategory[cat];
        const catDiv = document.createElement('div');
        catDiv.className = 'account-row';
        catDiv.innerHTML = `<div><strong>${cat}</strong> (${catData.assets.length} assets)<div class="small-muted">Cost: ${fmt(catData.totalCost)} | Acc Dep: ${fmt(catData.totalAccDep)} | NBV: ${fmt(catData.totalNBV)}</div></div>`;
        assetListDiv.appendChild(catDiv);
        
        // List individual assets in this category
        for(const a of catData.assets){
          const totalCost = (a.cost || 0) + (a.openingCost || 0);
          const totalAccDep = (a.accumulatedDep || 0) + (a.openingAccDep || 0);
          const nbv = totalCost - totalAccDep;
          const d = document.createElement('div');
          d.className = 'small-muted';
          d.style.paddingLeft = '16px';
          d.innerHTML = `${a.name} - Qty: ${a.qty||1} | Cost: ${fmt(totalCost)} | Acc Dep: ${fmt(totalAccDep)} | NBV: ${fmt(nbv)}`;
          assetListDiv.appendChild(d);
        }
      }
    }
    
    const pl = computePLSnapshot();
    plSnapshotQuick.innerHTML = `<div><strong>Accounting Profit:</strong> ${fmt(pl.accountingProfit)}</div><div class="small-muted">Revenue ${fmt(pl.revenue)} | Expenses ${fmt(pl.expenses)} | Depreciation ${fmt(pl.depreciation)}</div>`;
  }

  // PL computation
  function computePLSnapshot(){
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    let revenue=0, expenses=0, depreciation=0;
    let disallowableExpense=0, nonTaxableIncome=0;
    
    for(const t of arr){
      if(t.accountCategory === 'Revenue') revenue += Number(t.amount||0);
      if(t.accountCategory === 'Expense') expenses += Number(t.amount||0);
      
      // Handle adjustment transactions
      if(t.action === 'Adjustment' && t.adjustmentType){
        if(t.adjustmentType === 'disallowable'){
          disallowableExpense += Number(t.amount||0);
        } else if(t.adjustmentType === 'nontaxable'){
          nonTaxableIncome += Number(t.amount||0);
        }
      }
    }
    const dep = computeTotalDepreciation();
    depreciation = dep;
    expenses += depreciation;
    const accountingProfit = revenue - expenses;
    return { revenue, expenses, depreciation, accountingProfit, disallowableExpense, nonTaxableIncome };
  }

  // compute daily depreciation for all assets
  function computeTotalDepreciation(asOfDate){
    const b = findBiz(selectedBizId);
    if(!b) return 0;
    const arr = b.assets || [];
    let totalDep = 0;
    const asOf = asOfDate || today();
    for(const a of arr){
      if(!a.purchaseDate) continue;
      const days = Math.max(0, daysBetween(a.purchaseDate, asOf));
      const dinYear = daysInYear(a.purchaseDate);
      if(a.lifeYears && a.lifeYears>0){
        const annualDep = (a.cost || 0) / a.lifeYears;
        const daily = annualDep / dinYear;
        totalDep += daily * days;
      } else {
        const annual = ((a.depRate || 0)/100) * (a.cost || 0);
        const daily = annual / dinYear;
        totalDep += daily * days;
      }
    }
    return totalDep;
  }

  // compute daily capital allowance (for taxable adjustments)
  function computeTotalCapitalAllowance(asOfDate){
    const b = findBiz(selectedBizId);
    if(!b) return 0;
    const arr = b.assets || [];
    let totalCA = 0;
    const asOf = asOfDate || today();
    for(const a of arr){
      if(!a.purchaseDate) continue;
      const days = Math.max(0, daysBetween(a.purchaseDate, asOf));
      const dinYear = daysInYear(a.purchaseDate);
      const caPercent = Number(a.caPercent || b.caRateDefault || DEFAULTS.caRateDefault);
      const annualCA = (caPercent/100) * (a.cost || 0);
      const daily = annualCA / dinYear;
      totalCA += daily * days;
    }
    return totalCA;
  }

  // PAYE computation per contact using PAYE_BANDS
  function computePAYEOnAnnualIncome(annualTaxable){
    if(!annualTaxable || annualTaxable <= 0) return 0;
    let remaining = annualTaxable;
    let tax = 0;
    let lower = 0;
    for(const band of PAYE_BANDS){
      const upper = band.upTo;
      const slice = Math.max(0, Math.min(remaining, upper - lower));
      if(slice>0){
        tax += slice * band.rate;
        remaining -= slice;
      }
      lower = upper;
      if(remaining <= 0) break;
    }
    return tax;
  }

  // Tax summary rendering
  function renderTaxSummary(){
    const b = findBiz(selectedBizId);
    taxSummaryDiv.innerHTML = '';
    if(!b) return;
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    let revenue=0, expenses=0, vatCollected=0, vatPaid=0, whtPayable=0, whtReceivable=0;
    const payeByContact = {};
    
    for(const t of arr){
      if(t.accountCategory === 'Revenue') revenue += Number(t.amount||0);
      if(t.accountCategory === 'Expense') expenses += Number(t.amount||0);
      
      // VAT calculation with inclusive option
      if(t.vatType === 'exclusive' && t.accountCategory === 'Revenue') {
        vatCollected += (Number(t.amount||0) * (b.vatRate/100));
      } else if(t.vatType === 'inclusive' && t.accountCategory === 'Revenue') {
        // VAT inclusive: VAT = (vatRate / (100 + vatRate)) * amount
        vatCollected += (Number(t.amount||0) * (b.vatRate / (100 + b.vatRate)));
      }
      
      if(t.vatType === 'exclusive' && t.accountCategory === 'Expense') {
        vatPaid += (Number(t.amount||0) * (b.vatRate/100));
      } else if(t.vatType === 'inclusive' && t.accountCategory === 'Expense') {
        vatPaid += (Number(t.amount||0) * (b.vatRate / (100 + b.vatRate)));
      }
      
      // WHT calculation with net basis option
      if(t.whtApplied && t.accountCategory === 'Expense') {
        if(t.whtBasis === 'net') {
          // WHT net basis: WHT = rate * (amount / (1 - rate))
          const rate = (t.whtRate || b.whtRate) / 100;
          whtPayable += Number(t.amount||0) * (rate / (1 - rate));
        } else {
          whtPayable += Number(t.amount||0) * ((t.whtRate || b.whtRate)/100);
        }
      }
      
      if(t.whtApplied && t.accountCategory === 'Revenue') {
        if(t.whtBasis === 'net') {
          const rate = (t.whtRate || b.whtRate) / 100;
          whtReceivable += Number(t.amount||0) * (rate / (1 - rate));
        } else {
          whtReceivable += Number(t.amount||0) * ((t.whtRate || b.whtRate)/100);
        }
      }
      
      if(t.paye && t.contact){
        payeByContact[t.contact] = (payeByContact[t.contact]||0) + Number(t.amount||0);
      }
    }
    
    const depreciationDaily = computeTotalDepreciation();
    expenses += depreciationDaily;
    const accountingProfit = revenue - expenses;
    
    // Get adjustment values from P&L snapshot
    const plSnapshot = computePLSnapshot();
    const disallowableExpense = plSnapshot.disallowableExpense || 0;
    const nonTaxableIncomeAdjustment = plSnapshot.nonTaxableIncome || 0;
    
    // Calculate non-taxable income for CA relief rule
    let nonTaxableIncome = nonTaxableIncomeAdjustment;
    for(const t of arr){
      if(t.accountCategory === 'Revenue'){
        const acct = findAccount(b, t.accountId);
        if(acct && acct.nonTaxableDefault) {
          nonTaxableIncome += Number(t.amount || 0);
        }
      }
    }
    
    // Capital Allowance Relief Rule:
    // If non-taxable income < 10% of total revenue: allow 100% of CA
    // Otherwise: allow 2/3 of CA, carry forward 1/3
    const capitalAllowanceDaily = computeTotalCapitalAllowance();
    const totalCA = capitalAllowanceDaily + (b.caCarryForward || 0);
    let allowedCA = totalCA;
    let carriedForwardCA = 0;
    
    if(revenue > 0 && (nonTaxableIncome / revenue) >= NON_TAXABLE_INCOME_CA_THRESHOLD) {
      // Non-taxable >= 10% of revenue: only allow 2/3
      allowedCA = (2/3) * totalCA;
      carriedForwardCA = (1/3) * totalCA;
    }
    
    // Taxable profit calculation: Add back depreciation for tax, deduct CA
    // Also add disallowable expenses and deduct non-taxable income adjustments
    let taxableProfit = accountingProfit + depreciationDaily - allowedCA + disallowableExpense - nonTaxableIncomeAdjustment + (b.lossBroughtForward ? -b.lossBroughtForward : 0);
    const chargeableGains = computeChargeableGainsForBiz();
    const turnover = revenue;
    let cgtCharge = 0;
    let cgtExcludedFromTaxable = 0;
    
    // Chargeable gains treatment based on entity type and turnover threshold
    if(b.entity === 'Company'){
      const threshold = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
      if(turnover > threshold && threshold > 0){
        // Above threshold: charge CGT, exclude from CIT base
        for(const g of chargeableGains){
          if((g.proceeds <= CGT_EXEMPTION_PROCEEDS) || (g.gain <= CGT_EXEMPTION_GAIN)) {
            // Exempt
            cgtExcludedFromTaxable += g.gain;
          } else {
            cgtCharge += g.gain * 0.30;
            cgtExcludedFromTaxable += g.gain;
          }
        }
        taxableProfit -= cgtExcludedFromTaxable;
      } else {
        // Below threshold: no CGT, exclude gains from profit
        for(const g of chargeableGains){
          if((g.proceeds <= CGT_EXEMPTION_PROCEEDS) || (g.gain <= CGT_EXEMPTION_GAIN)) {
            taxableProfit -= g.gain;
          } else {
            // No CGT below threshold, but still exclude
            taxableProfit -= g.gain;
          }
        }
      }
    } else {
      // Individual or Enterprise: include in taxable profit unless exempt
      for(const g of chargeableGains){
        if((g.proceeds <= CGT_EXEMPTION_PROCEEDS) || (g.gain <= CGT_EXEMPTION_GAIN)) {
          // Exempt: exclude from taxable profit
          taxableProfit -= g.gain;
        } else {
          // Not exempt: leave in taxable profit
        }
      }
    }

    let payeMonthlyTotal = 0;
    let payeAnnualTotal = 0;
    for(const cName in payeByContact){
      const annualSalary = payeByContact[cName];
      const computedTax = computePAYEOnAnnualIncome(annualSalary || 0);
      payeAnnualTotal += computedTax;
      payeMonthlyTotal += computedTax / 12;
    }

    // CIT calculation with turnover threshold
    let citCharge = 0;
    if(b.entity === 'Company' && b.citEnabled){
      const threshold = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
      if(threshold === CIT_THRESHOLDS.NONE) {
        // No CIT
        citCharge = 0;
      } else if(threshold === CIT_THRESHOLDS.MEDIUM) {
        // 50M threshold: 0% if ‚â§50M, 25% if >50M
        if(turnover > CIT_THRESHOLDS.MEDIUM) {
          citCharge = 0.25 * Math.max(0, taxableProfit);
        }
      } else if(threshold === CIT_THRESHOLDS.LARGE) {
        // 100M threshold: 0% if ‚â§100M, 30% if >100M
        if(turnover > CIT_THRESHOLDS.LARGE) {
          citCharge = 0.30 * Math.max(0, taxableProfit);
        }
      }
      
      // Deduct WHT receivable only if CIT > 0
      if(citCharge > 0) {
        citCharge = Math.max(0, citCharge - whtReceivable);
      }
      // If CIT not computed, WHT receivable carries forward (note for user)
    }

    // PIT for Enterprise (renamed from SoleProprietor)
    let pitCharge = 0;
    if(b.entity === 'Enterprise' && b.pitEnabled){
      if(taxableProfit > 0){
        pitCharge = computePAYEOnAnnualIncome(taxableProfit);
      }
    }

    const vatNet = vatCollected - vatPaid;
    
    // INDIVIDUAL ENTITY: Special display
    const isIndividual = b.entity === 'Individual';
    
    // PIT for Individual (gross values, deduct WHT receivable)
    if(isIndividual && b.pitEnabled){
      // Use gross income (revenue) for PIT computation
      if(revenue > 0){
        pitCharge = computePAYEOnAnnualIncome(revenue);
        // Deduct WHT receivable from PIT
        pitCharge = Math.max(0, pitCharge - whtReceivable);
      }
    }
    
    let html = '';
    if(isIndividual){
      // For Individual: show simplified summary - no WHT Payable, no PAYE, no CA details
      html += `<div><strong>Gross Income:</strong> ${fmt(revenue)}</div>`;
      html += `<div><strong>Taxable Income:</strong> ${fmt(taxableProfit)}</div>`;
      html += `<div class="small-muted">Expenses ${fmt(expenses)}</div>`;
      html += `<hr/>`;
      // For Individual: show only WHT Receivable and PIT
      html += `<div><strong>WHT Receivable:</strong> ${fmt(whtReceivable)}</div>`;
      html += `<div><strong>PIT (Personal Income Tax):</strong> ${fmt(pitCharge)}</div>`;
      html += `<div class="small-note">PIT is computed on gross income less WHT receivable</div>`;
    } else {
      // For Company/Enterprise: show full summary
      html += `<div><strong>Accounting Profit:</strong> ${fmt(accountingProfit)}</div>`;
      html += `<div><strong>Taxable Profit:</strong> ${fmt(taxableProfit)}</div>`;
      html += `<div class="small-muted">Revenue ${fmt(revenue)} | Expenses ${fmt(expenses)} (including Dep ${fmt(depreciationDaily)})</div>`;
      html += `<div class="small-muted">CA allowed: ${fmt(allowedCA)} | CA c/f: ${fmt(carriedForwardCA)} | Non-taxable income: ${fmt(nonTaxableIncome)} (${revenue > 0 ? ((nonTaxableIncome/revenue)*100).toFixed(1) : 0}% of revenue)</div>`;
      html += `<hr/>`;
      html += `<div><strong>VAT Collected:</strong> ${fmt(vatCollected)} | <strong>VAT Paid:</strong> ${fmt(vatPaid)} | <strong>VAT Net:</strong> ${fmt(vatNet)}</div>`;
      html += `<div><strong>WHT Payable:</strong> ${fmt(whtPayable)} | <strong>WHT Receivable:</strong> ${fmt(whtReceivable)}</div>`;
      html += `<div><strong>PAYE (Monthly):</strong> ${fmt(payeMonthlyTotal)} | <strong>PAYE (Annual):</strong> ${fmt(payeAnnualTotal)}</div>`;
      if(b.entity === 'Company'){
        html += `<div><strong>CIT Charge (after WHT):</strong> ${fmt(citCharge)}</div>`;
        html += `<div><strong>CGT Charge (30% where applicable):</strong> ${fmt(cgtCharge)}</div>`;
        const threshold = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
        html += `<div class="small-note">CIT threshold: ${fmt(threshold)} | Turnover: ${fmt(turnover)}</div>`;
      } else {
        html += `<div><strong>PIT Charge:</strong> ${fmt(pitCharge)}</div>`;
      }
    }
    
    if(b.showLines){
      html += `<div style="margin-top:8px;"><strong>Notes:</strong> PAYE shown as totals (monthly & annual). Full PAYE contact breakdown is in Reports & PAYE Report.</div>`;
      if(carriedForwardCA > 0) {
        html += `<div class="notice" style="margin-top:6px;"><strong>CA Carryforward:</strong> ${fmt(carriedForwardCA)} will be carried forward to next period (non-taxable income ‚â• 10% of revenue).</div>`;
      }
    }

    taxSummaryDiv.innerHTML = html;
  }

  function computeChargeableGainsForBiz(){
    const b = findBiz(selectedBizId);
    if(!b) return [];
    const gains = [];
    for(const a of b.assets || []){
      if(a.disposed && a.disposal){
        if(a.classification === 'Chargeable'){
          gains.push({ assetId: a.id, name: a.name, proceeds: Number(a.disposal.proceeds || 0), gain: Number(a.disposal.gain || 0) });
        }
      }
    }
    return gains;
  }

  // Reports rendering
  function renderTab(){
    if(activeTab === 'ledger'){
      ledgerSection.style.display = 'block';
      reportsSection.style.display = 'none';
      quickPanels.style.display = 'block';
      btnLedgerTab.classList.add('active'); btnReportsTab.classList.remove('active');
      renderAll();
    } else {
      ledgerSection.style.display = 'none';
      reportsSection.style.display = 'block';
      quickPanels.style.display = 'none';
      btnLedgerTab.classList.remove('active'); btnReportsTab.classList.add('active');
      document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
      const tb = document.querySelector('#reportsSection .tab[data-report="vatReport"]');
      if(tb) tb.classList.add('active');
      renderReport('vatReport');
    }
  }

  function renderReportsTabState(){
    if(activeTab === 'reports') {
      ledgerSection.style.display = 'none';
      reportsSection.style.display = 'block';
      quickPanels.style.display = 'none';
    } else {
      ledgerSection.style.display = 'block';
      reportsSection.style.display = 'none';
      quickPanels.style.display = 'block';
    }
  }

  function renderReport(name){
    const b = findBiz(selectedBizId);
    if(!b) { reportContent.innerHTML = '<div>Select a business to view reports</div>'; return; }
    
    // Add audit for report generation
    addAudit('report.view', 'report', name, `Viewed report: ${name}`);
    
    if(name === 'vatReport'){
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      let html = `<h3>VAT Report</h3>`;
      html += `<h4>Sales (VAT Collected)</h4>`;
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Description</th><th>Contact</th><th>Amount</th><th>VAT</th></tr></thead><tbody>`;
      let totalVATCollected = 0;
      for(const t of arr){
        if(t.vatType && t.vatType !== 'none' && t.accountCategory === 'Revenue'){
          const vat = computeVAT(Number(t.amount||0), t.vatType, b.vatRate);
          totalVATCollected += vat;
          html += `<tr><td>${t.date}</td><td>${t.description||''}</td><td>${t.contact||''}</td><td>${fmt(t.amount)}</td><td>${fmt(vat)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="4">Total VAT Collected</th><th>${fmt(totalVATCollected)}</th></tr></tfoot></table>`;
      
      html += `<h4 style="margin-top:16px;">Purchases (VAT Paid)</h4>`;
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Description</th><th>Contact</th><th>Amount</th><th>VAT</th></tr></thead><tbody>`;
      let totalVATPaid = 0;
      for(const t of arr){
        if(t.vatType && t.vatType !== 'none' && t.accountCategory === 'Expense'){
          const vat = computeVAT(Number(t.amount||0), t.vatType, b.vatRate);
          totalVATPaid += vat;
          html += `<tr><td>${t.date}</td><td>${t.description||''}</td><td>${t.contact||''}</td><td>${fmt(t.amount)}</td><td>${fmt(vat)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="4">Total VAT Paid</th><th>${fmt(totalVATPaid)}</th></tr></tfoot></table>`;
      html += `<div style="margin-top:16px;"><strong>VAT Net (Collected - Paid):</strong> ${fmt(totalVATCollected - totalVATPaid)}</div>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'whtPayable'){
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      let html = `<h3>WHT Payable Report</h3>`;
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Vendor</th><th>Description</th><th>Rate %</th><th>Gross</th><th>WHT Payable</th></tr></thead><tbody>`;
      let totalWHT = 0;
      for(const t of arr){
        if(t.whtApplied && t.accountCategory === 'Expense'){
          const rate = Number(t.whtRate || b.whtRate);
          const basis = t.whtBasis || 'gross';
          const wht = computeWHT(Number(t.amount||0), basis, rate);
          totalWHT += wht;
          html += `<tr><td>${t.date}</td><td>${t.contact||''}</td><td>${t.description||''}</td><td>${rate}</td><td>${fmt(t.amount)}</td><td>${fmt(wht)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="5">Total WHT Payable</th><th>${fmt(totalWHT)}</th></tr></tfoot></table>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'whtReceivable'){
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      let html = `<h3>WHT Receivable Report</h3>`;
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Contact</th><th>Description</th><th>Rate %</th><th>Gross</th><th>WHT Receivable</th></tr></thead><tbody>`;
      let totalWHT = 0;
      for(const t of arr){
        if(t.whtApplied && t.accountCategory === 'Revenue'){
          const rate = Number(t.whtRate || b.whtRate);
          const basis = t.whtBasis || 'gross';
          const wht = computeWHT(Number(t.amount||0), basis, rate);
          totalWHT += wht;
          html += `<tr><td>${t.date}</td><td>${t.contact||''}</td><td>${t.description||''}</td><td>${rate}</td><td>${fmt(t.amount)}</td><td>${fmt(wht)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="5">Total WHT Receivable</th><th>${fmt(totalWHT)}</th></tr></tfoot></table>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'payeReport'){
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      const payeByContact = {};
      // Exclude sole traders from PAYE report
      for(const t of arr){
        if(t.paye && t.contact){
          // Check if contact is a sole trader
          const contact = b.contacts.find(c => c.name === t.contact);
          if(!contact || contact.type !== 'SoleTrader'){
            payeByContact[t.contact] = (payeByContact[t.contact] || 0) + Number(t.amount || 0);
          }
        }
      }
      let html = `<h3>PAYE Report</h3>`;
      if(Object.keys(payeByContact).length===0) html += '<div>No PAYE records found</div>';
      else {
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Contact</th><th>Annual Salary</th><th>PAYE Annual</th><th>PAYE Monthly</th></tr></thead><tbody>`;
        for(const c in payeByContact){
          const annual = payeByContact[c];
          const tax = computePAYEOnAnnualIncome(annual);
          html += `<tr><td>${c}</td><td>${fmt(annual)}</td><td>${fmt(tax)}</td><td>${fmt(tax/12)}</td></tr>`;
        }
        html += `</tbody></table>`;
      }
      reportContent.innerHTML = html;
      
    } else if(name === 'inventoryReport'){
      let html = `<h3>Inventory Report</h3>`;
      if(b.inventory && b.inventory.length){
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Item</th><th>Quantity</th><th>Avg Cost</th><th>Total Value</th></tr></thead><tbody>`;
        for(const item of b.inventory){
          const value = (item.qty || 0) * (item.avgCost || 0);
          html += `<tr><td>${item.name}</td><td>${item.qty||0}</td><td>${fmt(item.avgCost||0)}</td><td>${fmt(value)}</td></tr>`;
        }
        html += `</tbody></table>`;
      } else {
        html += '<div>No inventory items</div>';
      }
      reportContent.innerHTML = html;
      
    } else if(name === 'assetsReport'){
      const gains = computeChargeableGainsForBiz();
      let html = `<h3>Fixed Assets Schedule</h3>`;
      if(b.assets && b.assets.length){
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Name</th><th>Qty</th><th>Unit Price</th><th>Cost</th><th>Acc Dep</th><th>NBV</th><th>Life (yrs)</th><th>Purchase Date</th><th>Classification</th><th>Disposed</th></tr></thead><tbody>`;
        for(const a of b.assets){
          const nbv = (a.cost || 0) - (a.accumulatedDep || 0);
          html += `<tr><td>${a.name}</td><td>${a.qty||1}</td><td>${fmt(a.unitPrice||0)}</td><td>${fmt(a.cost||0)}</td><td>${fmt(a.accumulatedDep||0)}</td><td>${fmt(nbv)}</td><td>${a.lifeYears||0}</td><td>${a.purchaseDate||''}</td><td>${a.classification}</td><td>${a.disposed ? 'Yes' : 'No'}</td></tr>`;
        }
        html += `</tbody></table>`;
      } else html += '<div>No assets</div>';
      if(gains.length){
        html += `<h4 style="margin-top:16px;">Disposal & Chargeable Gains</h4><table style="width:100%;border-collapse:collapse;"><thead><tr><th>Asset</th><th>Proceeds</th><th>Gain/Loss</th><th>CGT@30%</th></tr></thead><tbody>`;
        for(const g of gains){
          const cgt = (g.gain > 0) ? g.gain * 0.30 : 0;
          html += `<tr><td>${g.name}</td><td>${fmt(g.proceeds)}</td><td>${fmt(g.gain)}</td><td>${fmt(cgt)}</td></tr>`;
        }
        html += `</tbody></table>`;
      }
      reportContent.innerHTML = html;
      
    } else if(name === 'pitIndividual'){
      const currentYear = new Date().getFullYear();
      let html = `<h3>Personal Income Tax Computation (Individual) - ${currentYear}</h3>`;
      html += `<p><strong>Name:</strong> [Taxpayer Name]</p>`;
      html += `<p><strong>Tax Year:</strong> ${currentYear}</p>`;
      html += `<table style="width:100%;border-collapse:collapse;margin-top:16px;"><thead><tr><th>Description</th><th>Amount (‚Ç¶)</th></tr></thead><tbody>`;
      html += `<tr><td colspan="2"><strong>Gross Income</strong></td></tr>`;
      html += `<tr><td>Sales Revenue</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Dividend</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Interest</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Royalty</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Rent</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Benefit in kind</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Share of profit</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td><strong>Total Gross Income</strong></td><td style="text-align:right;"><strong>-</strong></td></tr>`;
      html += `<tr><td colspan="2"><strong>Less: Statutory Deductions</strong></td></tr>`;
      html += `<tr><td>Pension</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Rent relief</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Life assurance</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Mortgage interest</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>NHF</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td><strong>Taxable Income</strong></td><td style="text-align:right;"><strong>-</strong></td></tr>`;
      html += `<tr><td colspan="2"><strong>PIT Computation</strong></td></tr>`;
      html += `<tr><td>PIT as per bands</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Less: WHT Receivable</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td><strong>Final PIT Payable</strong></td><td style="text-align:right;"><strong>-</strong></td></tr>`;
      html += `</tbody></table>`;
      html += `<p style="margin-top:16px;"><em>Note: This is a template. Actual values should be filled based on transactions.</em></p>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'pitEnterprise'){
      const currentYear = new Date().getFullYear();
      let html = `<h3>Personal Income Tax Computation (Enterprise) - ${currentYear}</h3>`;
      html += `<p><strong>Business Name:</strong> [Enterprise Name]</p>`;
      html += `<p><strong>Tax Year:</strong> ${currentYear}</p>`;
      html += `<table style="width:100%;border-collapse:collapse;margin-top:16px;"><thead><tr><th>Description</th><th>Amount (‚Ç¶)</th></tr></thead><tbody>`;
      html += `<tr><td><strong>Accounting Profit</strong></td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Add: Depreciation</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Less: Capital Allowance</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Add: Chargeable Gains (if applicable)</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td><strong>Adjusted Profit</strong></td><td style="text-align:right;"><strong>-</strong></td></tr>`;
      html += `<tr><td colspan="2"><strong>Less: Statutory Deductions</strong></td></tr>`;
      html += `<tr><td>Pension</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Rent relief</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Life assurance</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>Mortgage interest</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td>NHF</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td><strong>Taxable Profit</strong></td><td style="text-align:right;"><strong>-</strong></td></tr>`;
      html += `<tr><td colspan="2"><strong>PIT Computation</strong></td></tr>`;
      html += `<tr><td>PIT as per bands</td><td style="text-align:right;">-</td></tr>`;
      html += `<tr><td><strong>Final PIT Payable</strong></td><td style="text-align:right;"><strong>-</strong></td></tr>`;
      html += `</tbody></table>`;
      html += `<p style="margin-top:16px;"><em>Note: This is a template. Actual values should be filled based on transactions.</em></p>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'companyAccounts'){
      const currentYear = new Date().getFullYear();
      let html = `<h3>Company Accounts - ${currentYear}</h3>`;
      html += `<p><strong>Company Name:</strong> [Company Name]</p>`;
      html += `<p><strong>Financial Year Ended:</strong> ${currentYear}</p>`;
      html += `<h4>Statement of Profit or Loss</h4>`;
      html += `<p><em>[Profit and loss statement to be generated from transactions]</em></p>`;
      html += `<h4>Statement of Financial Position</h4>`;
      html += `<p><em>[Balance sheet to be generated from accounts]</em></p>`;
      html += `<h4>Fixed Assets Schedule</h4>`;
      html += `<p><em>[See Assets Report for details]</em></p>`;
      html += `<h4>Tax Computations</h4>`;
      html += `<p><em>[Tax computation summary]</em></p>`;
      html += `<hr style="margin:24px 0;"/>`;
      html += `<h4>Management Attestation</h4>`;
      html += `<p>I certify that the accounts presented herein are a true and fair representation of the financial position of [Company Name] as at the date stated, and have been prepared in accordance with applicable accounting standards.</p>`;
      html += `<p style="margin-top:24px;">`;
      html += `<strong>Signed:</strong> _______________________<br/>`;
      html += `<strong>Name:</strong> [Director Name]<br/>`;
      html += `<strong>Position:</strong> Director<br/>`;
      html += `<strong>Date:</strong> [Date]`;
      html += `</p>`;
      reportContent.innerHTML = html;
      
    } else {
      reportContent.innerHTML = '<div>Report not implemented</div>';
    }
  }

  function exportCurrentReport(fmtType){
    alert('Export ' + fmtType + ' not implemented in this simplified prototype');
  }

  // Business helpers
  function renderBizContacts(b){
    bizContactsList.innerHTML = '';
    if(!b) return;
    for(const c of b.contacts || []){
      const div = document.createElement('div'); div.className='account-row';
      const editBtn = document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=> editContact(c.id));
      div.innerHTML = `<div><strong>${c.name}</strong> <span class="small-muted">(${c.type})</span></div>`;
      div.appendChild(editBtn);
      bizContactsList.appendChild(div);
    }
  }

  function editContact(id){
    alert('Contact edit not implemented in this simplified prototype');
  }

  function renderAccounts(){
    accountsList.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    const balanceAccounts = ['Receivable', 'Bank', 'Payable', 'Capital', 'Accruals', 'Prepayment'];
    
    for(const a of b.accounts){
      const div = document.createElement('div'); 
      div.className='account-row';
      div.style.flexDirection = 'column';
      div.style.alignItems = 'flex-start';
      div.style.gap = '6px';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.display = 'flex';
      headerDiv.style.justifyContent = 'space-between';
      headerDiv.style.width = '100%';
      
      const delBtn = document.createElement('button'); 
      delBtn.className='small'; 
      delBtn.textContent='Delete'; 
      delBtn.addEventListener('click', ()=> deleteAccount(a.id));
      
      headerDiv.innerHTML = `<div><strong>${a.name}</strong> <span class="small-muted">${a.category}</span></div>`;
      headerDiv.appendChild(delBtn);
      div.appendChild(headerDiv);
      
      // Show balance fields for eligible accounts
      if(balanceAccounts.includes(a.name)){
        const balDiv = document.createElement('div');
        balDiv.style.display = 'flex';
        balDiv.style.gap = '8px';
        balDiv.innerHTML = `
          <label class="small-note">Opening: 
            <input type="number" class="smallInput" value="${a.openingBalance||0}" 
              onchange="updateAccountBalance('${a.id}', 'opening', this.value)" step="0.01" />
          </label>
          <label class="small-note">Closing: 
            <input type="number" class="smallInput" value="${a.closingBalance||0}" 
              onchange="updateAccountBalance('${a.id}', 'closing', this.value)" step="0.01" />
          </label>
        `;
        div.appendChild(balDiv);
      }
      
      accountsList.appendChild(div);
    }
  }
  
  function updateAccountBalance(accountId, type, value){
    const b = findBiz(selectedBizId);
    if(!b) return;
    const account = b.accounts.find(a => a.id === accountId);
    if(!account) return;
    
    if(type === 'opening'){
      account.openingBalance = Number(value || 0);
    } else if(type === 'closing'){
      account.closingBalance = Number(value || 0);
    }
    saveState();
  }
  
  // Make updateAccountBalance available globally for inline onchange handlers
  window.updateAccountBalance = updateAccountBalance;
  function deleteAccount(id){
    const b = findBiz(selectedBizId);
    if(!b) return;
    b.accounts = (b.accounts||[]).filter(x=>x.id!==id);
    saveState();
    renderAccounts();
    populateAccountSelect();
  }

  function deleteBusiness(id){
    state.businesses = state.businesses.filter(x=>x.id!==id);
    for(const u of state.users) if(state.transactions[u.id]) delete state.transactions[u.id][id];
    saveState();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    renderAll();
  }

  function deleteUser(id){
    state.users = state.users.filter(x=>x.id!==id);
    delete state.transactions[id];
    saveState();
    refreshSelectors();
    ensureSelection();
    renderAll();
  }

  // utilities for tax computations reused earlier
  function computePLAndTaxesForReports(){
    // placeholder if needed
  }

  // final initialization
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  // Offer countdown timer and pricing logic
  (function initOfferCountdownAndPricing() {
    // DOM elements for countdown
    const countdownEl = document.getElementById('offerCountdown');
    const preloginCountdownEl = document.getElementById('preloginCountdown');
    const heroCountdownEl = document.getElementById('heroCountdown');
    const preloginOfferBox = document.getElementById('preloginOfferBox');
    
    // Pricing configuration
    const PLANS = {
      individual: {
        fullPrice: 30000,
        offerPrice: 20000,
        addonPrice: 20000,
        buyLink: 'https://paystack.shop/pay/individual20000',
        addonLink: 'https://paystack.shop/pay/addon_selffile_20000'
      },
      enterprise: {
        fullPrice: 37500,
        offerPrice: 25000,
        addonPrice: 30000,
        buyLink: 'https://paystack.shop/pay/enterprise25000',
        addonLink: 'https://paystack.shop/pay/addon_selffile_30000'
      },
      company: {
        fullPrice: 50000,
        offerPrice: 30000,
        addonPrice: 40000,
        buyLink: 'https://paystack.shop/pay/company30000',
        addonLink: 'https://paystack.shop/pay/addon_selffile_40000'
      }
    };
    
    const OFFER_DURATION_MS = 72 * 60 * 60 * 1000; // 72 hours in milliseconds
    const STORAGE_KEY_OFFER = 'offerEndTimestamp';
    
    // Initialize or retrieve offer end timestamp
    function getOfferEndTimestamp() {
      let endTime = localStorage.getItem(STORAGE_KEY_OFFER);
      if (!endTime) {
        endTime = Date.now() + OFFER_DURATION_MS;
        localStorage.setItem(STORAGE_KEY_OFFER, endTime);
      } else {
        endTime = parseInt(endTime, 10);
      }
      return endTime;
    }
    
    let offerEndTimestamp = getOfferEndTimestamp();
    
    // Reset offer to new 72-hour window
    function resetOffer() {
      offerEndTimestamp = Date.now() + OFFER_DURATION_MS;
      localStorage.setItem(STORAGE_KEY_OFFER, offerEndTimestamp);
      
      // Flash the offer box to indicate restart
      if (preloginOfferBox) {
        preloginOfferBox.classList.add('offer-flash');
        setTimeout(function() {
          preloginOfferBox.classList.remove('offer-flash');
        }, 600);
      }
      
      // Re-enable all offer checkboxes
      ['individual', 'enterprise', 'company'].forEach(function(plan) {
        const checkbox = document.getElementById(plan + 'ApplyOffer');
        if (checkbox) {
          checkbox.checked = true;
          checkbox.disabled = false;
        }
      });
      
      // Recalculate totals
      updateAllTotals();
    }
    
    // Format time as Days:HH:MM:SS
    function formatCountdown(remaining) {
      if (remaining <= 0) return '0d 00:00:00';
      
      const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
      const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
      
      return days + 'd ' + 
        String(hours).padStart(2, '0') + ':' +
        String(minutes).padStart(2, '0') + ':' +
        String(seconds).padStart(2, '0');
    }
    
    // Update countdown display
    function updateCountdown() {
      const now = Date.now();
      const remaining = offerEndTimestamp - now;
      
      if (remaining <= 0) {
        // Offer expired - restart it
        resetOffer();
        return;
      }
      
      const timeString = formatCountdown(remaining);
      
      // Update all countdown elements
      if (countdownEl) countdownEl.textContent = timeString;
      if (preloginCountdownEl) preloginCountdownEl.textContent = timeString;
      if (heroCountdownEl) heroCountdownEl.textContent = timeString;
    }
    
    // Format currency
    function formatNaira(amount) {
      return '‚Ç¶' + amount.toLocaleString();
    }
    
    // Calculate and update total for a plan
    function updatePlanTotal(planName) {
      const plan = PLANS[planName];
      if (!plan) return;
      
      const applyOfferCheckbox = document.getElementById(planName + 'ApplyOffer');
      const addonCheckbox = document.getElementById(planName + 'Addon');
      const totalEl = document.getElementById(planName + 'Total');
      const buyLink = document.getElementById(planName + 'BuyLink');
      
      if (!totalEl) return;
      
      const applyOffer = applyOfferCheckbox ? applyOfferCheckbox.checked : false;
      const includeAddon = addonCheckbox ? addonCheckbox.checked : false;
      
      const basePrice = applyOffer ? plan.offerPrice : plan.fullPrice;
      const addonPrice = includeAddon ? plan.addonPrice : 0;
      const total = basePrice + addonPrice;
      
      totalEl.textContent = formatNaira(total);
      
      // Update buy link with current price
      if (buyLink) {
        try {
          const url = new URL(plan.buyLink);
          url.searchParams.set('plan', planName);
          url.searchParams.set('price', total);
          if (includeAddon) {
            url.searchParams.set('addon', 'selffile');
            url.searchParams.set('addonPrice', plan.addonPrice);
          }
          buyLink.href = url.toString();
        } catch (e) {
          // Fallback if URL parsing fails
          buyLink.href = plan.buyLink + '?plan=' + encodeURIComponent(planName) + '&price=' + total;
        }
      }
    }
    
    // Update all plan totals
    function updateAllTotals() {
      ['individual', 'enterprise', 'company'].forEach(updatePlanTotal);
    }
    
    // Wire up event listeners for checkboxes
    function initCheckboxListeners() {
      ['individual', 'enterprise', 'company'].forEach(function(plan) {
        const applyOfferCheckbox = document.getElementById(plan + 'ApplyOffer');
        const addonCheckbox = document.getElementById(plan + 'Addon');
        
        if (applyOfferCheckbox) {
          applyOfferCheckbox.addEventListener('change', function() {
            updatePlanTotal(plan);
          });
        }
        
        if (addonCheckbox) {
          addonCheckbox.addEventListener('change', function() {
            updatePlanTotal(plan);
          });
        }
      });
    }
    
    // Initialize
    updateCountdown();
    setInterval(updateCountdown, 1000);
    initCheckboxListeners();
    updateAllTotals();
  })();

  // Signup modal cancel handler only - submit is handled by defensive handler above
  (function initSignupModalCancel() {
    const signupModal = document.getElementById('signupModal');
    const signupCancel = document.getElementById('signupCancel');
    const preLoginOverlay = document.getElementById('preLoginOverlay');
    
    if (!signupModal) return;
    
    if (signupCancel) {
      signupCancel.addEventListener('click', function() {
        closeModal(signupModal);
        // Show pre-login overlay again since user didn't complete signup
        if (preLoginOverlay && (!state || !state.auth || !state.auth.currentUserId)) {
          preLoginOverlay.classList.remove('hidden');
        }
      });
    }
  })();
  
  // Temporary storage for signup flow
  let pendingSignupUserId = null;
  
  /**
   * Shows entity selection modal after signup.
   * @param {string} userId - The new user's ID
   * @param {string} preselectedPlan - The plan selected during signup
   */
  function showEntitySelectModal(userId, preselectedPlan) {
    pendingSignupUserId = userId;
    
    const entitySelectModal = document.getElementById('entitySelectModal');
    const entitySelectType = document.getElementById('entitySelectType');
    
    if (!entitySelectModal || !entitySelectType) {
      // Fallback: create business directly without modal
      createBusinessForUser(userId, preselectedPlan || 'Individual');
      completeSignupFlow(userId);
      return;
    }
    
    // Pre-select based on signup plan
    entitySelectType.value = preselectedPlan || 'Individual';
    
    openModal(entitySelectModal);
  }
  
  /**
   * Completes the signup flow after entity selection.
   * @param {string} userId - The user's ID
   */
  function completeSignupFlow(userId) {
    updateAuthUI();
    refreshSelectors();
    ensureSelection();
    renderAll();
    
    // Show video tour modal for the new user
    const user = state.users.find(u => u.id === userId);
    if (user && !user.tourSeen) {
      showTourModal(userId);
    }
  }
  
  // Entity selection modal handlers
  (function initEntitySelectModal() {
    const entitySelectModal = document.getElementById('entitySelectModal');
    const entitySelectConfirm = document.getElementById('entitySelectConfirm');
    const entitySelectType = document.getElementById('entitySelectType');
    
    if (!entitySelectModal || !entitySelectConfirm) return;
    
    entitySelectConfirm.addEventListener('click', function() {
      if (!pendingSignupUserId) {
        closeModal(entitySelectModal);
        return;
      }
      
      const entityType = entitySelectType ? entitySelectType.value : 'Individual';
      
      // Create default business for the user
      const bizId = createBusinessForUser(pendingSignupUserId, entityType);
      
      // Set as selected business
      if (bizId) {
        selectedBizId = bizId;
        selectedUserId = pendingSignupUserId;
      }
      
      closeModal(entitySelectModal);
      
      // Complete signup flow
      completeSignupFlow(pendingSignupUserId);
      pendingSignupUserId = null;
    });
  })();
  
  // Video tour modal handlers
  (function initVideoTourModal() {
    const videoTourModal = document.getElementById('videoTourModal');
    const videoTourSkip = document.getElementById('videoTourSkip');
    const videoTourWatch = document.getElementById('videoTourWatch');
    
    if (!videoTourModal) return;
    
    if (videoTourSkip) {
      videoTourSkip.addEventListener('click', function() {
        const userId = state.auth.currentUserId;
        closeTourModal(userId, 'skip');
      });
    }
    
    if (videoTourWatch) {
      videoTourWatch.addEventListener('click', function() {
        const userId = state.auth.currentUserId;
        closeTourModal(userId, 'watch');
      });
    }
  })();

  // Forgot password modal handlers
  (function initForgotModal() {
    const forgotModal = document.getElementById('forgotModal');
    const forgotCancel = document.getElementById('forgotCancel');
    const forgotSubmit = document.getElementById('forgotSubmit');
    const forgotUsername = document.getElementById('forgotUsername');
    
    if (!forgotModal) return;
    
    if (forgotCancel) {
      forgotCancel.addEventListener('click', function() {
        closeModal(forgotModal);
      });
    }
    
    if (forgotSubmit) {
      forgotSubmit.addEventListener('click', function() {
        const username = (forgotUsername && forgotUsername.value) ? forgotUsername.value.trim() : '';
        
        if (!username) {
          alert('Please enter your username.');
          return;
        }
        
        // Check if user exists
        const user = state.users.find(function(u) { return u.username === username; });
        if (!user) {
          alert('User not found. Please check your username.');
          return;
        }
        
        addAudit('user.forgot_password', 'user', user.id, 'Password reset requested for: ' + username);
        
        alert('Password reset request logged. (Prototype: This is a manual process. Please contact your admin or the sales team at salesrepng@gmail.com to process the reset.)');
        
        // Clear form and close modal
        if (forgotUsername) forgotUsername.value = '';
        closeModal(forgotModal);
      });
    }
  })();

  </script>

<!-- Copilot Chat Widget -->
<style>
#copilotChatBtn{position:fixed;bottom:24px;right:24px;z-index:9999;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#fff;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;font-size:1.5rem;}
#copilotChatModal{position:fixed;bottom:90px;right:24px;z-index:9998;width:340px;max-height:420px;background:#fff;border:1px solid #ccc;border-radius:10px;display:none;flex-direction:column;box-shadow:0 6px 24px rgba(0,0,0,0.18);}
#copilotChatHeader{padding:10px 14px;background:var(--accent);color:#fff;border-radius:10px 10px 0 0;font-weight:600;display:flex;justify-content:space-between;align-items:center;}
#copilotChatClose{background:transparent;border:none;color:#fff;font-size:1.2rem;cursor:pointer;}
#copilotChatMessages{flex:1;padding:10px;overflow-y:auto;font-size:0.95rem;min-height:180px;max-height:260px;}
#copilotChatInput{display:flex;border-top:1px solid #e6e6e6;}
#copilotChatInput input{flex:1;padding:10px;border:none;outline:none;font-size:0.95rem;}
#copilotChatInput button{padding:10px 14px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:600;}
.copilot-msg{margin-bottom:8px;padding:8px 10px;border-radius:8px;max-width:90%;}
.copilot-msg.user{background:#e6f3ff;align-self:flex-end;margin-left:auto;}
.copilot-msg.assistant{background:#f2f4f7;}
</style>
<button id="copilotChatBtn" title="Copilot Chat">üí¨</button>
<div id="copilotChatModal">
  <div id="copilotChatHeader"><span>Copilot Chat</span><button id="copilotChatClose">√ó</button></div>
  <div id="copilotChatMessages"></div>
  <div id="copilotChatInput"><input type="text" id="copilotInput" placeholder="Ask a question‚Ä¶" /><button id="copilotSend">Send</button></div>
</div>
<script>
(function(){
  const btn=document.getElementById('copilotChatBtn'),modal=document.getElementById('copilotChatModal'),closeBtn=document.getElementById('copilotChatClose'),input=document.getElementById('copilotInput'),sendBtn=document.getElementById('copilotSend'),msgs=document.getElementById('copilotChatMessages');
  function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}
  btn.onclick=()=>{modal.style.display=modal.style.display==='flex'?'none':'flex';};
  closeBtn.onclick=()=>{modal.style.display='none';};
  async function send(){
    const q=input.value.trim();if(!q)return;
    msgs.innerHTML+=`<div class="copilot-msg user">${escapeHtml(q)}</div>`;input.value='';msgs.scrollTop=msgs.scrollHeight;
    try{
      const res=await fetch('/api/assistant',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:q,context:{url:location.href}})});
      const data=await res.json();
      msgs.innerHTML+=`<div class="copilot-msg assistant">${escapeHtml(data.reply||data.error||'No response')}</div>`;
    }catch(e){msgs.innerHTML+=`<div class="copilot-msg assistant">Error: ${escapeHtml(e.message)}</div>`;}
    msgs.scrollTop=msgs.scrollHeight;
  }
  sendBtn.onclick=send;
  input.onkeydown=e=>{if(e.key==='Enter')send();};
})();
</script>
</body>
        </html>
