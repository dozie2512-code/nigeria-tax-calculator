GitHub Copilot Chat Assistant — Updated index.html follows.

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(720px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    pre.small { font-size:0.85rem; white-space:pre-wrap; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <label>Type:
          <select id="txnType">
            <option value="Income">Income (Sales)</option>
            <option value="Expense">Expense (Purchase)</option>
            <option value="Deduction">Deduction</option>
          </select>
        </label>
        <label>Category:
          <select id="txnCategory">
            <option>Pension</option>
            <option>NHF</option>
            <option>Insurance</option>
            <option>Salary</option>
            <option>Bonus</option>
            <option>Freelance</option>
            <option>Food</option>
            <option>Transport</option>
            <option>Rent</option>
            <option>Utilities</option>
            <option>Other</option>
          </select>
        </label>
        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
        <label><input type="checkbox" id="txnWhtEnabled" /> Withhold WHT</label>
        <label>WHT rate (%): <input type="number" id="txnWhtRate" min="0" max="100" step="0.01" value="5" style="width:80px;" /></label>
        <label>Contact:
          <select id="txnContact"></select>
        </label>
        <button class="small" id="btnAddContactInline">+ Contact</button>
        <label>Account:
          <select id="txnAccount"></select>
        </label>
        <button class="small" id="btnAddAccountInline">+ Account</button>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved at the business level. Each transaction records its author (selected user). Business members can view/add transactions depending on membership. Contacts and Accounts are scoped per business. WHT (Withholding Tax) applies to Expense transactions at a default rate of 5%.</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/type/category/description/amount/author/contact/account" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf; border-radius:4px;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable" aria-live="polite">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount (₦)</th>
            <th>VAT (₦)</th>
            <th>WHT (₦)</th>
            <th>Contact</th>
            <th>Account</th>
            <th>Author</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section" id="contactsAccountsPanel" style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:280px;">
        <h3>Contacts</h3>
        <div class="form-inline" style="margin-bottom:8px;">
          <button class="small" id="btnOpenContacts">Manage Contacts</button>
          <button class="small" id="btnExportContacts">Export Contacts</button>
        </div>
        <div id="contactsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
      </div>
      <div style="flex:1;min-width:280px;">
        <h3>Chart of Accounts</h3>
        <div class="form-inline" style="margin-bottom:8px;">
          <button class="small" id="btnOpenAccounts">Manage Accounts</button>
          <button class="small" id="btnExportAccounts">Export Accounts</button>
        </div>
        <div id="accountsList" style="max-height:220px;overflow:auto;border:1px solid #eef2f6;padding:8px;border-radius:6px;background:#fbfcff;"></div>
      </div>
    </section>

    <section class="panel section" id="reportsPanel">
      <h2 style="margin:0 0 8px 0;">Reports</h2>
      <div class="form-inline" style="margin-bottom:8px;">
        <label>Report Type:
          <select id="reportType">
            <option value="profit">Profit</option>
            <option value="vat">VAT</option>
            <option value="paye">PAYE</option>
          </select>
        </label>
        <label>Date From: <input type="date" id="reportDateFrom" /></label>
        <label>Date To: <input type="date" id="reportDateTo" /></label>
        <button class="primary" id="btnGenerateReport">Generate Report</button>
        <button id="btnExportHtml" class="small">Export HTML</button>
        <button id="btnExportCsv" class="small">Export CSV</button>
        <button id="btnExportJson" class="small">Export JSON</button>
      </div>
      <div id="reportOutput" style="margin-top:12px;"></div>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="userNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
    </div>
    <div class="row">
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Members: <select id="bizMembers" multiple size="5" style="min-width:180px"></select></label>
      <small class="note">Hold Ctrl/Cmd to select multiple members. Owner will be included automatically on save.</small>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (tax)</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
    <small class="note">VAT & PIT toggles control whether VAT and personal income tax are computed for this business.</small>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>
    <label>Type:
      <select id="editTxnType">
        <option value="Income">Income (Sales)</option>
        <option value="Expense">Expense (Purchase)</option>
        <option value="Deduction">Deduction</option>
      </select>
    </label><br/>
    <label>Category:
      <select id="editTxnCategory">
        <option>Pension</option>
        <option>NHF</option>
        <option>Insurance</option>
        <option>Salary</option>
        <option>Bonus</option>
        <option>Freelance</option>
        <option>Food</option>
        <option>Transport</option>
        <option>Rent</option>
        <option>Utilities</option>
        <option>Other</option>
      </select>
    </label><br/>
    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>
    <label><input type="checkbox" id="editTxnWhtEnabled" /> Withhold WHT</label><br/>
    <label>WHT rate (%): <input type="number" id="editTxnWhtRate" min="0" max="100" step="0.01" value="5" style="width:80px;" /></label><br/>
    <label>Contact:
      <select id="editTxnContact"></select>
    </label><br/>
    <label>Account:
      <select id="editTxnAccount"></select>
    </label><br/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button onclick="closeEditModal()">Cancel</button>
      <button class="primary" onclick="saveEdit()">Save</button>
    </div>
  </div>

  <div id="contactModal" class="modal" aria-hidden="true">
    <h3 id="contactModalTitle">Add Contact</h3>
    <div class="row">
      <label>Name: <input type="text" id="contactName" /></label>
      <label>Type:
        <select id="contactType">
          <option value="Customer">Customer</option>
          <option value="Vendor">Vendor</option>
          <option value="Employee">Employee</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Phone/Email: <input type="text" id="contactInfo" placeholder="Phone or email" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="contactNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="contactCancel">Cancel</button>
      <button class="primary" id="contactSave">Save</button>
    </div>
  </div>

  <div id="accountModal" class="modal" aria-hidden="true">
    <h3 id="accountModalTitle">Add Account</h3>
    <div class="row">
      <label>Code: <input type="text" id="accountCode" placeholder="e.g. 4000" /></label>
      <label>Name: <input type="text" id="accountName" placeholder="Account name" /></label>
    </div>
    <div class="row">
      <label>Type:
        <select id="accountType">
          <option>Asset</option>
          <option>Liability</option>
          <option>Equity</option>
          <option>Revenue</option>
          <option>Expense</option>
        </select>
      </label>
      <label>Notes: <input type="text" id="accountNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="accountCancel">Cancel</button>
      <button class="primary" id="accountSave">Save</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant
    // Extended: contacts and chart of accounts (COA) per business. Transactions now store contactId and accountId.

    const STORAGE_KEY = 'ntc_data_v2';
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    // In-memory state
    let data = { users: [], businesses: [], transactions: {} };
    let selectedUserId = null;
    let selectedBusinessId = null;
    let editIndex = null;

    // Ledger UI state
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';
    let ledgerFiltered = [];

    function uid(prefix='id') { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }

    function ensureWHTAccount(b) {
      if (!b) return;
      if (!Array.isArray(b.accounts)) b.accounts = [];
      // Check if WHT Payable account already exists
      if (b.whtAccountId) {
        const existing = b.accounts.find(a => a.id === b.whtAccountId);
        if (existing) return; // Already exists and is valid
      }
      // Look for existing account with code 2300
      let whtAccount = b.accounts.find(a => a.code === '2300');
      if (!whtAccount) {
        // Create new WHT Payable account
        whtAccount = {
          id: uid('a'),
          code: '2300',
          name: 'WHT Payable',
          type: 'Liability',
          notes: 'Withholding Tax Payable'
        };
        b.accounts.push(whtAccount);
      }
      b.whtAccountId = whtAccount.id;
    }

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    function migrateOldTransactions(oldTxns) {
      // oldTxns: { userId: { bizId: [txn,...] } }
      const newTxns = {};
      for (const userId of Object.keys(oldTxns)) {
        const perUser = oldTxns[userId] || {};
        for (const bizId of Object.keys(perUser)) {
          const arr = perUser[bizId] || [];
          if (!newTxns[bizId]) newTxns[bizId] = [];
          for (const t of arr) {
            const newTxn = {
              id: t.id || uid('txn'),
              date: (t.date || new Date().toISOString().slice(0,10)),
              type: t.type || 'Income',
              category: t.category || 'Other',
              desc: t.desc || '',
              amount: Number(t.amount) || 0,
              authorUserId: userId,
              contactId: t.contactId || null,
              accountId: t.accountId || null
            };
            newTxns[bizId].push(newTxn);
          }
        }
      }
      return newTxns;
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object') {
            data.users = parsed.users || [];
            data.businesses = parsed.businesses || [];
            const tx = parsed.transactions || {};
            // detect old structure
            let isOldStructure = false;
            for (const k of Object.keys(tx)) {
              const v = tx[k];
              if (Array.isArray(v)) { /* new style */ }
              else if (v && typeof v === 'object') { isOldStructure = true; break; }
            }
            if (isOldStructure) {
              data.transactions = migrateOldTransactions(tx);
            } else {
              data.transactions = tx;
            }
            // Ensure businesses have members, contacts, accounts arrays and default vats/pit
            data.businesses = data.businesses.map(b => {
              if (!Array.isArray(b.members)) b.members = [];
              if (!b.ownerId && b.members && b.members.length) b.ownerId = b.members[0];
              if (!Array.isArray(b.contacts)) b.contacts = [];
              if (!Array.isArray(b.accounts)) b.accounts = [];
              if (!b.vatRate) b.vatRate = 7.5;
              if (typeof b.vatEnabled === 'undefined') b.vatEnabled = true;
              if (typeof b.pitEnabled === 'undefined') b.pitEnabled = true;
              if (!b.pit) b.pit = DEFAULT_PIT;
              if (b.ownerId && !b.members.includes(b.ownerId)) b.members.push(b.ownerId);
              // Ensure WHT Payable account exists
              ensureWHTAccount(b);
              return b;
            });
            // Migrate transactions to include WHT fields if missing
            for (const bizId of Object.keys(data.transactions)) {
              const txns = data.transactions[bizId];
              if (Array.isArray(txns)) {
                data.transactions[bizId] = txns.map(t => {
                  if (typeof t.whtEnabled === 'undefined') t.whtEnabled = false;
                  if (typeof t.whtRate === 'undefined') t.whtRate = 5;
                  if (typeof t.whtAmount === 'undefined') t.whtAmount = 0;
                  if (typeof t.whtAccountId === 'undefined') t.whtAccountId = null;
                  return t;
                });
              }
            }
            return;
          }
        } catch(e) { console.error('Invalid saved data', e); }
      }

      // default demo (new structure)
      const userId = uid('user');
      const bizId = uid('biz');
      const whtAccId = uid('a');
      data = {
        users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{
          id: bizId,
          name: 'Demo Business',
          ownerId: userId,
          members: [userId],
          vatRate: 7.5,
          currency: '₦',
          threshold: 800000,
          notes: 'Sample business',
          vatEnabled: true,
          pitEnabled: true,
          whtAccountId: whtAccId,
          contacts: [
            { id: uid('c'), name: 'ACME Co', type: 'Customer', info: 'acme@example.com', notes: '' },
            { id: uid('c'), name: 'Office Supplies Ltd', type: 'Vendor', info: '0803-xxx', notes: '' },
            { id: uid('c'), name: 'John Employee', type: 'Employee', info: 'john@demo', notes: '' }
          ],
          accounts: [
            { id: uid('a'), code: '1000', name: 'Cash', type: 'Asset', notes: '' },
            { id: uid('a'), code: '2000', name: 'Accounts Payable', type: 'Liability', notes: '' },
            { id: whtAccId, code: '2300', name: 'WHT Payable', type: 'Liability', notes: 'Withholding Tax Payable' },
            { id: uid('a'), code: '4000', name: 'Sales Revenue', type: 'Revenue', notes: '' },
            { id: uid('a'), code: '5000', name: 'Rent Expense', type: 'Expense', notes: '' }
          ],
          pit: DEFAULT_PIT
        }],
        transactions: {}
      };
      data.transactions[bizId] = [
        { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Income', category: 'Freelance', desc: 'Demo sale to ACME', amount: 1500000, authorUserId: userId, contactId: data.businesses[0].contacts[0].id, accountId: data.businesses[0].accounts[3].id, whtEnabled: false, whtRate: 5, whtAmount: 0, whtAccountId: null },
        { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Expense', category: 'Rent', desc: 'Office rent', amount: 200000, authorUserId: userId, contactId: data.businesses[0].contacts[1].id, accountId: data.businesses[0].accounts[4].id, whtEnabled: false, whtRate: 5, whtAmount: 0, whtAccountId: null }
      ];
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }
    function findContact(bizId, contactId) {
      const b = findBiz(bizId);
      if (!b || !Array.isArray(b.contacts)) return null;
      return b.contacts.find(c => c.id === contactId) || null;
    }
    function findAccount(bizId, accountId) {
      const b = findBiz(bizId);
      if (!b || !Array.isArray(b.accounts)) return null;
      return b.accounts.find(a => a.id === accountId) || null;
    }

    // UI wiring
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    // User modal elements
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userNotes = document.getElementById('userNotes');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    // Business modal elements
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwner = document.getElementById('bizOwner');
    const bizMembers = document.getElementById('bizMembers');
    const bizVat = document.getElementById('bizVat');
    const bizCurrency = document.getElementById('bizCurrency');
    const bizThreshold = document.getElementById('bizThreshold');
    const bizNotes = document.getElementById('bizNotes');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');

    // Contact modal
    const contactModal = document.getElementById('contactModal');
    const contactModalTitle = document.getElementById('contactModalTitle');
    const contactName = document.getElementById('contactName');
    const contactType = document.getElementById('contactType');
    const contactInfo = document.getElementById('contactInfo');
    const contactNotes = document.getElementById('contactNotes');
    const contactSave = document.getElementById('contactSave');
    const contactCancel = document.getElementById('contactCancel');

    // Account modal
    const accountModal = document.getElementById('accountModal');
    const accountModalTitle = document.getElementById('accountModalTitle');
    const accountCode = document.getElementById('accountCode');
    const accountName = document.getElementById('accountName');
    const accountType = document.getElementById('accountType');
    const accountNotes = document.getElementById('accountNotes');
    const accountSave = document.getElementById('accountSave');
    const accountCancel = document.getElementById('accountCancel');

    // Edit transaction modal
    const editModal = document.getElementById('editModal');
    const editTxnDate = document.getElementById('editTxnDate');
    const editTxnType = document.getElementById('editTxnType');
    const editTxnCategory = document.getElementById('editTxnCategory');
    const editTxnDesc = document.getElementById('editTxnDesc');
    const editTxnAmount = document.getElementById('editTxnAmount');
    const editTxnWhtEnabled = document.getElementById('editTxnWhtEnabled');
    const editTxnWhtRate = document.getElementById('editTxnWhtRate');
    const editTxnContact = document.getElementById('editTxnContact');
    const editTxnAccount = document.getElementById('editTxnAccount');

    // Transaction inline selects
    const txnContact = document.getElementById('txnContact');
    const txnAccount = document.getElementById('txnAccount');
    const btnAddContactInline = document.getElementById('btnAddContactInline');
    const btnAddAccountInline = document.getElementById('btnAddAccountInline');

    // Search & pagination UI
    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    // Export/Import UI
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // Contacts & accounts UI
    const btnOpenContacts = document.getElementById('btnOpenContacts');
    const contactsListDiv = document.getElementById('contactsList');
    const btnExportContacts = document.getElementById('btnExportContacts');

    const btnOpenAccounts = document.getElementById('btnOpenAccounts');
    const accountsListDiv = document.getElementById('accountsList');
    const btnExportAccounts = document.getElementById('btnExportAccounts');

    // Reports UI
    const reportType = document.getElementById('reportType');
    const reportDateFrom = document.getElementById('reportDateFrom');
    const reportDateTo = document.getElementById('reportDateTo');
    const btnGenerateReport = document.getElementById('btnGenerateReport');
    const btnExportHtml = document.getElementById('btnExportHtml');
    const btnExportCsv = document.getElementById('btnExportCsv');
    const btnExportJson = document.getElementById('btnExportJson');
    const reportOutput = document.getElementById('reportOutput');

    let userEditingId = null;
    let bizEditingId = null;
    let contactEditingId = null;
    let accountEditingId = null;

    // Initialization
    loadData();
    refreshUserBusinessSelectors();
    ensureSelection();
    currentPage = 1;
    refreshContactsAccountsUI();
    renderLedger();
    calculateSummary();

    // --- Helpers for modals ---
    function openModal(modal) {
      modalOverlay.style.display = 'block';
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal) {
      modalOverlay.style.display = 'none';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      userEditingId = null;
      bizEditingId = null;
      contactEditingId = null;
      accountEditingId = null;
    }

    modalOverlay.addEventListener('click', () => {
      // close any open modal
      const modals = [userModal, businessModal, editModal, contactModal, accountModal];
      modals.forEach(m => { if (m && m.style.display === 'block') closeModal(m); });
    });

    // --- User & Business management ---
    function refreshUserBusinessSelectors() {
      // Users
      userSelect.innerHTML = '';
      data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = (u.display || u.username) + ' (' + u.username + ')';
        userSelect.appendChild(opt);
      });

      // Businesses: show businesses the selected user is a member of; if none, show all
      businessSelect.innerHTML = '';
      const bizList = [];
      if (selectedUserId) {
        for (const b of data.businesses) {
          if (Array.isArray(b.members) && b.members.includes(selectedUserId)) bizList.push(b);
        }
      }
      if (bizList.length === 0) bizList.push(...data.businesses);

      bizList.forEach(b => {
        const owner = findUser(b.ownerId);
        const enabledParts = [];
        if (b.vatEnabled) enabledParts.push('VAT');
        if (b.pitEnabled) enabledParts.push('PIT');
        const status = enabledParts.length ? ' — ' + enabledParts.join('/') : '';
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name} ${owner ? ' — ' + (owner.display || owner.username) : ''} (${b.vatRate}% VAT)${status}`;
        businessSelect.appendChild(opt);
      });

      // bizOwner and members options
      bizOwner.innerHTML = '';
      bizMembers.innerHTML = '';
      data.users.forEach(u => {
        const o = document.createElement('option');
        o.value = u.id;
        o.textContent = (u.display || u.username);
        bizOwner.appendChild(o);

        const m = document.createElement('option');
        m.value = u.id;
        m.textContent = (u.display || u.username) + ' (' + u.username + ')';
        bizMembers.appendChild(m);
      });

      if (!data.users.find(u=>u.id===selectedUserId)) selectedUserId = data.users.length ? data.users[0].id : null;
      if (!data.businesses.find(b=>b.id===selectedBusinessId)) {
        const pick = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
        selectedBusinessId = pick ? pick.id : (data.businesses.length ? data.businesses[0].id : null);
      }

      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;

      // refresh inline selects
      populateContactSelects();
      populateAccountSelects();
    }

    function ensureSelection() {
      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length) {
        const pick = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
        selectedBusinessId = pick ? pick.id : data.businesses[0].id;
      }
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    // Users
    btnAddUser.addEventListener('click', () => {
      userModalTitle.textContent = 'Add User';
      userName.value = '';
      userDisplay.value = '';
      userNotes.value = '';
      userEditingId = null;
      openModal(userModal);
    });

    btnEditUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      userModalTitle.textContent = 'Edit User';
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userNotes.value = u.notes || '';
      userEditingId = u.id;
      openModal(userModal);
    });

    btnDeleteUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      if (!confirm(`Delete user "${u.display || u.username}" and remove their authored transactions? This action cannot be undone.`)) return;
      const ownedBizIds = data.businesses.filter(b => b.ownerId === u.id).map(b=>b.id);
      data.businesses = data.businesses.filter(b => b.ownerId !== u.id);
      for (const bid of ownedBizIds) {
        if (data.transactions[bid]) delete data.transactions[bid];
      }
      for (const b of data.businesses) {
        if (Array.isArray(b.members)) {
          b.members = b.members.filter(mid => mid !== u.id);
        }
        const txs = data.transactions[b.id] || [];
        data.transactions[b.id] = txs.filter(t => t.authorUserId !== u.id);
      }
      data.users = data.users.filter(x => x.id !== u.id);
      if (!data.users.length) {
        data = { users: [], businesses: [], transactions: {} };
      }
      saveData();
      selectedUserId = data.users.length ? data.users[0].id : null;
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
    });

    userSave.addEventListener('click', () => {
      const username = (userName.value || '').trim();
      if (!username) { alert('Username required'); return; }
      if (userEditingId) {
        const u = findUser(userEditingId);
        if (!u) return;
        u.username = username;
        u.display = (userDisplay.value||'').trim();
        u.notes = (userNotes.value||'').trim();
      } else {
        const exists = data.users.find(x => x.username === username);
        if (exists) { if (!confirm('Username already exists. Add anyway?')) return; }
        const id = uid('user');
        data.users.push({ id, username, display: (userDisplay.value||'').trim(), notes: (userNotes.value||'').trim() });
      }
      saveData();
      closeModal(userModal);
      refreshUserBusinessSelectors();
      ensureSelection();
    });

    userCancel.addEventListener('click', () => closeModal(userModal));

    userSelect.addEventListener('change', (e) => {
      selectedUserId = e.target.value;
      const owned = data.businesses.find(b => Array.isArray(b.members) && b.members.includes(selectedUserId));
      if (owned) selectedBusinessId = owned.id;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      currentPage = 1;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
    });

    // Businesses
    btnAddBusiness.addEventListener('click', () => {
      if (!selectedUserId) { alert('Create/select a user first'); return; }
      businessModalTitle.textContent = 'Add Business';
      bizName.value = '';
      bizVat.value = 7.5;
      bizCurrency.value = '₦';
      bizThreshold.value = 800000;
      bizNotes.value = '';
      bizOwner.value = selectedUserId || (data.users[0] && data.users[0].id) || '';
      for (const opt of bizMembers.options) opt.selected = false;
      const ownerVal = bizOwner.value;
      for (const opt of bizMembers.options) if (opt.value === ownerVal) opt.selected = true;
      bizVatEnabled.checked = true;
      bizPitEnabled.checked = true;
      bizEditingId = null;
      openModal(businessModal);
    });

    btnEditBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizVat.value = (typeof b.vatRate === 'number') ? b.vatRate : 7.5;
      bizCurrency.value = b.currency || '₦';
      bizThreshold.value = (typeof b.threshold === 'number') ? b.threshold : 800000;
      bizNotes.value = b.notes || '';
      bizOwner.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
      for (const opt of bizMembers.options) {
        opt.selected = Array.isArray(b.members) && b.members.includes(opt.value);
      }
      bizVatEnabled.checked = !!b.vatEnabled;
      bizPitEnabled.checked = (typeof b.pitEnabled === 'undefined') ? true : !!b.pitEnabled;
      bizEditingId = b.id;
      openModal(businessModal);
    });

    btnDeleteBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm(`Delete business "${b.name}" and all its transactions? This action cannot be undone.`)) return;
      data.businesses = data.businesses.filter(x => x.id !== b.id);
      if (data.transactions[b.id]) delete data.transactions[b.id];
      saveData();
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizSave.addEventListener('click', () => {
      const name = (bizName.value || '').trim();
      const ownerIdVal = bizOwner.value;
      const vat = parseFloat(bizVat.value);
      const currency = (bizCurrency.value || '₦').trim();
      const threshold = Number(bizThreshold.value) || 800000;
      const vatEnabledVal = !!bizVatEnabled.checked;
      const pitEnabledVal = !!bizPitEnabled.checked;
      if (!name) { alert('Business name required'); return; }
      if (!ownerIdVal) { alert('Select owner'); return; }
      const members = [];
      for (const opt of bizMembers.options) {
        if (opt.selected) members.push(opt.value);
      }
      if (!members.includes(ownerIdVal)) members.push(ownerIdVal);

      if (bizEditingId) {
        const b = findBiz(bizEditingId);
        if (!b) return;
        b.name = name;
        b.ownerId = ownerIdVal;
        b.members = members;
        b.vatRate = isNaN(vat) ? 7.5 : vat;
        b.currency = currency;
        b.threshold = threshold;
        b.notes = (bizNotes.value || '').trim();
        b.vatEnabled = vatEnabledVal;
        b.pitEnabled = pitEnabledVal;
        ensureWHTAccount(b);
      } else {
        const id = uid('biz');
        const newBiz = {
          id, name, ownerId: ownerIdVal, members,
          vatRate: isNaN(vat) ? 7.5 : vat,
          currency,
          threshold,
          notes: (bizNotes.value || '').trim(),
          vatEnabled: vatEnabledVal,
          pitEnabled: pitEnabledVal,
          contacts: [],
          accounts: [],
          pit: DEFAULT_PIT
        };
        ensureWHTAccount(newBiz);
        data.businesses.push(newBiz);
        if (!data.transactions[id]) data.transactions[id] = [];
      }
      saveData();
      closeModal(businessModal);
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizCancel.addEventListener('click', () => closeModal(businessModal));

    businessSelect.addEventListener('change', (e) => {
      selectedBusinessId = e.target.value;
      currentPage = 1;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
      refreshContactsAccountsUI();
    });

    // Contacts and Accounts management
    function refreshContactsAccountsUI() {
      contactsListDiv.innerHTML = '';
      accountsListDiv.innerHTML = '';
      const b = findBiz(selectedBusinessId);
      if (!b) {
        contactsListDiv.textContent = 'No business selected.';
        accountsListDiv.textContent = 'No business selected.';
        populateContactSelects();
        populateAccountSelects();
        return;
      }
      if (!Array.isArray(b.contacts)) b.contacts = [];
      if (!Array.isArray(b.accounts)) b.accounts = [];

      if (b.contacts.length === 0) {
        contactsListDiv.innerHTML = '<div class="muted">No contacts for this business.</div>';
      } else {
        b.contacts.forEach(c => {
          const d = document.createElement('div');
          d.style.display = 'flex';
          d.style.justifyContent = 'space-between';
          d.style.padding = '4px 0';
          d.innerHTML = `<div><strong>${escapeHtml(c.name)}</strong> <span class="muted">(${c.type})</span><br/><small class="muted">${escapeHtml(c.info || '')}</small></div>
            <div style="display:flex;gap:6px"><button class="small" onclick="editContact('${c.id}')">Edit</button><button class="small danger" onclick="deleteContact('${c.id}')">Delete</button></div>`;
          contactsListDiv.appendChild(d);
        });
      }

      if (b.accounts.length === 0) {
        accountsListDiv.innerHTML = '<div class="muted">No accounts for this business.</div>';
      } else {
        b.accounts.forEach(a => {
          const d = document.createElement('div');
          d.style.display = 'flex';
          d.style.justifyContent = 'space-between';
          d.style.padding = '4px 0';
          d.innerHTML = `<div><strong>${escapeHtml(a.code)} - ${escapeHtml(a.name)}</strong> <span class="muted">(${a.type})</span><br/><small class="muted">${escapeHtml(a.notes || '')}</small></div>
            <div style="display:flex;gap:6px"><button class="small" onclick="editAccount('${a.id}')">Edit</button><button class="small danger" onclick="deleteAccount('${a.id}')">Delete</button></div>`;
          accountsListDiv.appendChild(d);
        });
      }

      populateContactSelects();
      populateAccountSelects();
    }

    btnOpenContacts.addEventListener('click', () => {
      contactModalTitle.textContent = 'Add Contact';
      contactName.value = '';
      contactType.value = 'Customer';
      contactInfo.value = '';
      contactNotes.value = '';
      contactEditingId = null;
      openModal(contactModal);
    });

    btnOpenAccounts.addEventListener('click', () => {
      accountModalTitle.textContent = 'Add Account';
      accountCode.value = '';
      accountName.value = '';
      accountType.value = 'Asset';
      accountNotes.value = '';
      accountEditingId = null;
      openModal(accountModal);
    });

    btnAddContactInline.addEventListener('click', () => {
      contactModalTitle.textContent = 'Add Contact';
      contactName.value = '';
      contactType.value = 'Customer';
      contactInfo.value = '';
      contactNotes.value = '';
      contactEditingId = null;
      openModal(contactModal);
    });

    btnAddAccountInline.addEventListener('click', () => {
      accountModalTitle.textContent = 'Add Account';
      accountCode.value = '';
      accountName.value = '';
      accountType.value = 'Asset';
      accountNotes.value = '';
      accountEditingId = null;
      openModal(accountModal);
    });

    contactSave.addEventListener('click', () => {
      const b = findBiz(selectedBusinessId);
      if (!b) { alert('Select a business first'); return; }
      const name = (contactName.value || '').trim();
      if (!name) { alert('Contact name required'); return; }
      const info = (contactInfo.value || '').trim();
      const notes = (contactNotes.value || '').trim();
      const type = contactType.value || 'Customer';
      if (contactEditingId) {
        const c = b.contacts.find(x=>x.id===contactEditingId);
        if (!c) return;
        c.name = name; c.type = type; c.info = info; c.notes = notes;
      } else {
        b.contacts.push({ id: uid('c'), name, type, info, notes });
      }
      saveData();
      closeModal(contactModal);
      refreshContactsAccountsUI();
      renderLedger();
    });

    contactCancel.addEventListener('click', () => closeModal(contactModal));

    accountSave.addEventListener('click', () => {
      const b = findBiz(selectedBusinessId);
      if (!b) { alert('Select a business first'); return; }
      const code = (accountCode.value || '').trim();
      const name = (accountName.value || '').trim();
      if (!name) { alert('Account name required'); return; }
      const notes = (accountNotes.value || '').trim();
      const type = accountType.value || 'Asset';
      if (accountEditingId) {
        const a = b.accounts.find(x=>x.id===accountEditingId);
        if (!a) return;
        a.code = code; a.name = name; a.type = type; a.notes = notes;
      } else {
        b.accounts.push({ id: uid('a'), code, name, type, notes });
      }
      saveData();
      closeModal(accountModal);
      refreshContactsAccountsUI();
      renderLedger();
    });

    accountCancel.addEventListener('click', () => closeModal(accountModal));

    window.editContact = function(contactId) {
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const c = b.contacts.find(x=>x.id===contactId);
      if (!c) return;
      contactModalTitle.textContent = 'Edit Contact';
      contactName.value = c.name || '';
      contactType.value = c.type || 'Customer';
      contactInfo.value = c.info || '';
      contactNotes.value = c.notes || '';
      contactEditingId = c.id;
      openModal(contactModal);
    };

    window.deleteContact = function(contactId) {
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm('Delete this contact?')) return;
      b.contacts = b.contacts.filter(c => c.id !== contactId);
      // remove contact reference from transactions
      const txs = data.transactions[b.id] || [];
      txs.forEach(t => { if (t.contactId === contactId) t.contactId = null; });
      saveData();
      refreshContactsAccountsUI();
      renderLedger();
    };

    window.editAccount = function(accountId) {
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      const a = b.accounts.find(x=>x.id===accountId);
      if (!a) return;
      accountModalTitle.textContent = 'Edit Account';
      accountCode.value = a.code || '';
      accountName.value = a.name || '';
      accountType.value = a.type || 'Asset';
      accountNotes.value = a.notes || '';
      accountEditingId = a.id;
      openModal(accountModal);
    };

    window.deleteAccount = function(accountId) {
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm('Delete this account?')) return;
      b.accounts = b.accounts.filter(a => a.id !== accountId);
      const txs = data.transactions[b.id] || [];
      txs.forEach(t => { if (t.accountId === accountId) t.accountId = null; });
      saveData();
      refreshContactsAccountsUI();
      renderLedger();
    };

    function populateContactSelects() {
      const b = findBiz(selectedBusinessId);
      [txnContact, editTxnContact].forEach(sel => {
        if (!sel) return;
        sel.innerHTML = '<option value="">(none)</option>';
        if (!b || !Array.isArray(b.contacts)) return;
        b.contacts.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = `${c.name} (${c.type})`;
          sel.appendChild(opt);
        });
      });
    }

    function populateAccountSelects() {
      const b = findBiz(selectedBusinessId);
      [txnAccount, editTxnAccount].forEach(sel => {
        if (!sel) return;
        sel.innerHTML = '<option value="">(none)</option>';
        if (!b || !Array.isArray(b.accounts)) return;
        b.accounts.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = `${a.code ? a.code + ' - ' : ''}${a.name} (${a.type})`;
          sel.appendChild(opt);
        });
      });
    }

    // Transactions
    btnAddTxn.addEventListener('click', () => {
      const date = document.getElementById('txnDate').value;
      const type = document.getElementById('txnType').value;
      const category = document.getElementById('txnCategory').value;
      const desc = document.getElementById('txnDesc').value.trim();
      const amount = parseFloat(document.getElementById('txnAmount').value) || 0;
      const contactIdVal = txnContact.value || null;
      const accountIdVal = txnAccount.value || null;
      const whtEnabled = document.getElementById('txnWhtEnabled').checked;
      const whtRate = parseFloat(document.getElementById('txnWhtRate').value) || 5;

      if (!selectedUserId || !selectedBusinessId) {
        alert('Select user and business before adding a transaction.');
        return;
      }
      const biz = findBiz(selectedBusinessId);
      if (!biz) { alert('Selected business not found'); return; }
      if (!Array.isArray(biz.members) || !biz.members.includes(selectedUserId)) {
        alert('You are not a member of the selected business. Ask the owner to add you as member.');
        return;
      }
      if (!date || !desc || amount <= 0) {
        alert('Please fill all fields and enter a valid amount.');
        return;
      }

      // Calculate WHT amount
      let whtAmount = 0;
      let whtAccountId = null;
      if (whtEnabled && type === 'Expense') {
        whtAmount = amount * (whtRate / 100);
        whtAccountId = biz.whtAccountId || null;
      }

      const txn = { 
        id: uid('txn'), 
        date, 
        type, 
        category, 
        desc, 
        amount, 
        authorUserId: selectedUserId, 
        contactId: contactIdVal || null, 
        accountId: accountIdVal || null,
        whtEnabled: whtEnabled && type === 'Expense',
        whtRate: whtRate,
        whtAmount: whtAmount,
        whtAccountId: whtAccountId
      };
      if (!data.transactions[selectedBusinessId]) data.transactions[selectedBusinessId] = [];
      data.transactions[selectedBusinessId].push(txn);
      saveData();
      clearForm();
      renderLedger();
      calculateSummary();
    });

    function clearForm() {
      document.getElementById('txnDate').value = "";
      document.getElementById('txnDesc').value = "";
      document.getElementById('txnAmount').value = "";
      document.getElementById('txnType').value = "Income";
      document.getElementById('txnCategory').value = "Salary";
      document.getElementById('txnWhtEnabled').checked = false;
      document.getElementById('txnWhtRate').value = "5";
      if (txnContact) txnContact.value = '';
      if (txnAccount) txnAccount.value = '';
    }

    function renderLedger() {
      ledgerTbody.innerHTML = '';
      if (!selectedUserId || !selectedBusinessId) {
        ledgerFiltered = [];
        updatePaginationControls();
        return;
      }
      const allTxns = (data.transactions[selectedBusinessId]) || [];
      const q = (ledgerFilterText || '').trim().toLowerCase();
      ledgerFiltered = allTxns.filter(txn => {
        if (!q) return true;
        const author = findUser(txn.authorUserId);
        const authorName = author ? (author.display || author.username) : '';
        const contact = findContact(selectedBusinessId, txn.contactId);
        const account = findAccount(selectedBusinessId, txn.accountId);
        const contactName = contact ? contact.name : '';
        const accountName = account ? (account.code ? account.code + ' ' + account.name : account.name) : '';
        const parts = [ txn.date || '', txn.type || '', txn.category || '', txn.desc || '', String(txn.amount || ''), authorName, contactName, accountName ];
        return parts.join(' ').toLowerCase().includes(q);
      });

      const biz = findBiz(selectedBusinessId);
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageSlice = ledgerFiltered.slice(start, start + PAGE_SIZE);

      pageSlice.forEach((txn) => {
        let vat = 0;
        if (biz && biz.vatEnabled && (txn.type === 'Income' || txn.type === 'Expense')) vat = txn.amount * vatRate;
        
        // Display WHT for Expense transactions where whtEnabled is true
        let whtDisplay = '';
        if (txn.whtEnabled && txn.type === 'Expense' && txn.whtAmount > 0) {
          whtDisplay = (biz && biz.currency ? biz.currency : '₦') + formatNumber(txn.whtAmount);
        }
        
        const author = findUser(txn.authorUserId);
        const authorName = author ? (author.display || author.username) : '(unknown)';
        const contact = findContact(selectedBusinessId, txn.contactId);
        const contactName = contact ? (contact.name + (contact.type ? ' ('+contact.type+')' : '')) : '';
        const account = findAccount(selectedBusinessId, txn.accountId);
        const accountName = account ? (account.code ? (account.code + ' - ' + account.name) : account.name) : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${txn.date}</td>
          <td>${txn.type}</td>
          <td>${txn.category}</td>
          <td>${escapeHtml(txn.desc)}</td>
          <td>${biz && biz.currency ? biz.currency : '₦'}${formatNumber(txn.amount)}</td>
          <td>${(vat && biz && biz.vatEnabled) ? (biz.currency || '₦') + formatNumber(vat) : ''}</td>
          <td>${whtDisplay}</td>
          <td>${escapeHtml(contactName)}</td>
          <td>${escapeHtml(accountName)}</td>
          <td>${escapeHtml(authorName)}</td>
          <td>
            <div class="actions">
              <button class="small" onclick="openEditModal('${txn.id}')">Edit</button>
              <button class="small danger" onclick="removeTransaction('${txn.id}')">Delete</button>
            </div>
          </td>`;
        ledgerTbody.appendChild(tr);
      });

      updatePaginationControls();
    }

    function updatePaginationControls() {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
      btnPrevPage.disabled = currentPage <= 1;
      btnNextPage.disabled = currentPage >= totalPages;
    }

    btnPrevPage.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderLedger();
      }
    });
    btnNextPage.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage < totalPages) {
        currentPage++;
        renderLedger();
      }
    });

    btnSearch.addEventListener('click', () => {
      ledgerFilterText = ledgerSearch.value || '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    btnClearSearch.addEventListener('click', () => {
      ledgerSearch.value = '';
      ledgerFilterText = '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    window.openEditModal = function(txnId) {
      if (!selectedBusinessId) return;
      const txns = data.transactions[selectedBusinessId] || [];
      const idx = txns.findIndex(t => t.id === txnId);
      if (idx === -1) return;
      editIndex = idx;
      const t = txns[idx];
      editTxnDate.value = t.date;
      editTxnType.value = t.type;
      editTxnCategory.value = t.category;
      editTxnDesc.value = t.desc;
      editTxnAmount.value = t.amount;
      editTxnWhtEnabled.checked = t.whtEnabled || false;
      editTxnWhtRate.value = t.whtRate || 5;
      populateContactSelects();
      populateAccountSelects();
      editTxnContact.value = t.contactId || '';
      editTxnAccount.value = t.accountId || '';
      openModal(editModal);
    };

    window.removeTransaction = function(txnId) {
      if (!selectedBusinessId) return;
      if (!confirm('Delete this transaction?')) return;
      const txns = data.transactions[selectedBusinessId] || [];
      const idx = txns.findIndex(t=>t.id===txnId);
      if (idx === -1) return;
      txns.splice(idx,1);
      saveData();
      renderLedger();
      calculateSummary();
    };

    function closeEditModal() {
      closeModal(editModal);
      editIndex = null;
    }
    window.closeEditModal = closeEditModal;

    function saveEdit() {
      if (editIndex === null) return;
      const date = editTxnDate.value;
      const type = editTxnType.value;
      const category = editTxnCategory.value;
      const desc = editTxnDesc.value.trim();
      const amount = parseFloat(editTxnAmount.value) || 0;
      const contactIdVal = editTxnContact.value || null;
      const accountIdVal = editTxnAccount.value || null;
      const whtEnabled = editTxnWhtEnabled.checked;
      const whtRate = parseFloat(editTxnWhtRate.value) || 5;
      
      if (!date || !desc || amount <= 0) { alert('Fill fields and enter valid amount'); return; }
      
      const biz = findBiz(selectedBusinessId);
      
      // Calculate WHT amount
      let whtAmount = 0;
      let whtAccountId = null;
      if (whtEnabled && type === 'Expense') {
        whtAmount = amount * (whtRate / 100);
        whtAccountId = biz && biz.whtAccountId ? biz.whtAccountId : null;
      }
      
      const txns = data.transactions[selectedBusinessId];
      if (!txns || !txns[editIndex]) return;
      const orig = txns[editIndex];
      txns[editIndex] = { 
        ...orig, 
        date, 
        type, 
        category, 
        desc, 
        amount, 
        contactId: contactIdVal, 
        accountId: accountIdVal,
        whtEnabled: whtEnabled && type === 'Expense',
        whtRate: whtRate,
        whtAmount: whtAmount,
        whtAccountId: whtAccountId
      };
      saveData();
      closeEditModal();
      renderLedger();
      calculateSummary();
    }
    window.saveEdit = saveEdit;

    // Summaries and tax calculations
    function calculateSummary() {
      const biz = findBiz(selectedBusinessId);
      const currency = (biz && biz.currency) ? biz.currency : '₦';
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const threshold = (biz && typeof biz.threshold === 'number') ? biz.threshold : DEFAULT_PIT.threshold;
      const pitEnabled = biz ? (typeof biz.pitEnabled === 'undefined' ? true : !!biz.pitEnabled) : false;
      const vatEnabled = biz ? !!biz.vatEnabled : false;
      const txns = ledgerFiltered && ledgerFiltered.length ? ledgerFiltered : (data.transactions[selectedBusinessId]) || [];

      let incomeTotal = 0, expenseTotal = 0, deductionTotal = 0, rentTotal = 0;
      let vatOutputTotal = 0, vatInputTotal = 0;
      let whtTotal = 0;
      const whtByContact = {};
      
      txns.forEach(txn => {
        if (txn.type === 'Income') {
          incomeTotal += txn.amount;
          if (vatEnabled) vatOutputTotal += txn.amount * vatRate;
        } else if (txn.type === 'Expense') {
          expenseTotal += txn.amount;
          if (vatEnabled) vatInputTotal += txn.amount * vatRate;
          if (txn.category === 'Rent') rentTotal += txn.amount;
          
          // Calculate WHT for Expense transactions
          if (txn.whtEnabled && txn.whtAmount > 0) {
            whtTotal += txn.whtAmount;
            if (txn.contactId) {
              const contact = findContact(selectedBusinessId, txn.contactId);
              const contactName = contact ? contact.name : 'Unknown Contact';
              if (!whtByContact[contactName]) {
                whtByContact[contactName] = 0;
              }
              whtByContact[contactName] += txn.whtAmount;
            }
          }
        } else if (txn.type === 'Deduction') {
          deductionTotal += txn.amount;
        }
      });

      let netBalance = incomeTotal - expenseTotal;
      let vatPayable = (vatOutputTotal - vatInputTotal);
      let rentRelief = rentTotal * 0.20;
      if (rentRelief > 500000) rentRelief = 500000;
      let adjIncome = incomeTotal - deductionTotal - rentRelief;
      if (adjIncome < 0) adjIncome = 0;
      let tax = 0;
      if (pitEnabled) tax = computeTax(adjIncome, biz);
      let effRate = incomeTotal > 0 ? (tax / incomeTotal) * 100 : 0;

      if (vatEnabled) {
        vatSummaryDiv.style.display = '';
        vatSummaryDiv.innerHTML =
          `<strong>VAT Summary (${(vatRate*100).toFixed(2)}%):</strong><br>
           VAT Output (Sales): ${currency}${formatNumber(vatOutputTotal)}<br>
           VAT Input (Purchases): ${currency}${formatNumber(vatInputTotal)}<br>
           <strong>VAT Payable:</strong> ${currency}${formatNumber(vatPayable)}`;
      } else {
        vatSummaryDiv.style.display = 'none';
        vatSummaryDiv.innerHTML = '';
      }

      totalsSummaryDiv.style.display = '';
      totalsSummaryDiv.innerHTML =
        `<strong>Income:</strong> ${currency}${formatNumber(incomeTotal)}  | 
         <strong>Expenses:</strong> ${currency}${formatNumber(expenseTotal)}  | 
         <strong>Deductions:</strong> ${currency}${formatNumber(deductionTotal)}  | 
         <strong>Net Balance:</strong> ${currency}${formatNumber(netBalance)}`;

      if (pitEnabled) {
        taxSummaryDiv.style.display = '';
        let whtSection = '';
        if (whtTotal > 0) {
          whtSection = `<br><br><strong>WHT Summary:</strong><br>
           Total WHT withheld: ${currency}${formatNumber(whtTotal)}<br>`;
          const contactNames = Object.keys(whtByContact).sort();
          if (contactNames.length > 0) {
            whtSection += '<strong>WHT by Contact:</strong><br>';
            contactNames.forEach(name => {
              whtSection += `  ${escapeHtml(name)}: ${currency}${formatNumber(whtByContact[name])}<br>`;
            });
          }
        }
        
        taxSummaryDiv.innerHTML =
          `<strong>Tax Calculation (PIT):</strong><br>
           Tax-free threshold: ${currency}${formatNumber(threshold)}<br>
           Rent relief applied: ${currency}${formatNumber(rentRelief)}<br>
           Taxable income after deductions: ${currency}${formatNumber(adjIncome)}<br>
           <strong>Tax payable:</strong> ${currency}${formatNumber(tax,0)}<br>
           Effective tax rate on gross income: ${effRate.toFixed(2)}%<br>
           ${adjIncome <= threshold ? `<strong>No tax payable (taxable income ≤ ${currency}${formatNumber(threshold)})</strong>` : ''}${whtSection}`;
      } else {
        taxSummaryDiv.style.display = 'none';
        taxSummaryDiv.innerHTML = '';
      }
    }

    function computeTax(adjIncome, biz) {
      if (biz && typeof biz.pitEnabled !== 'undefined' && !biz.pitEnabled) return 0;
      const pit = (biz && biz.pit && Array.isArray(biz.pit.slices)) ? biz.pit : DEFAULT_PIT;
      let tax = 0;
      if (adjIncome > (pit.threshold || DEFAULT_PIT.threshold)) {
        let remaining = adjIncome - (pit.threshold || DEFAULT_PIT.threshold);
        let prevUpper = (pit.threshold || DEFAULT_PIT.threshold);
        for (let s of pit.slices) {
          const upper = s.upTo;
          let sliceLimit = (upper === Infinity) ? Infinity : (upper - prevUpper);
          if (remaining <= 0) break;
          const slice = Math.min(remaining, sliceLimit);
          tax += slice * s.rate;
          remaining -= slice;
          prevUpper = upper;
        }
      }
      return Math.round(tax);
    }

    // Utility helpers
    function escapeHtml(s) {
      if (!s) return '';
      return String(s).replace(/[&<>"']/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
      });
    }
    function formatNumber(n, decimals=2) {
      if (typeof n !== 'number') n = Number(n) || 0;
      return n.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    // Export / Import
    btnExport.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ntc-data.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const parsed = JSON.parse(e.target.result);
          if (parsed && typeof parsed === 'object') {
            data = parsed;
            saveData();
            refreshUserBusinessSelectors();
            ensureSelection();
            refreshContactsAccountsUI();
            renderLedger();
            calculateSummary();
            alert('Import successful');
          } else alert('Invalid JSON');
        } catch(err) { alert('Invalid JSON file'); }
      };
      reader.readAsText(f);
    });

    btnClearAll.addEventListener('click', () => {
      if (!confirm('Clear all local data? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      data = { users: [], businesses: [], transactions: {} };
      selectedUserId = null; selectedBusinessId = null;
      loadData();
      refreshUserBusinessSelectors();
      ensureSelection();
      refreshContactsAccountsUI();
      renderLedger();
      calculateSummary();
    });

    // Simple exports for contacts/accounts
    btnExportContacts.addEventListener('click', () => {
      const b = findBiz(selectedBusinessId);
      if (!b) return alert('Select a business first');
      const blob = new Blob([JSON.stringify(b.contacts || [], null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(b.name||'business')}-contacts.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
    btnExportAccounts.addEventListener('click', () => {
      const b = findBiz(selectedBusinessId);
      if (!b) return alert('Select a business first');
      const blob = new Blob([JSON.stringify(b.accounts || [], null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(b.name||'business')}-accounts.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Reports (simple)
    btnGenerateReport.addEventListener('click', () => {
      const type = reportType.value;
      const from = reportDateFrom.value;
      const to = reportDateTo.value;
      const txns = (data.transactions[selectedBusinessId] || []).filter(t => {
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        return true;
      });
      if (type === 'vat') {
        const b = findBiz(selectedBusinessId);
        const vatRate = (b && typeof b.vatRate === 'number') ? (b.vatRate/100) : 0.075;
        let out = 0, inp = 0;
        txns.forEach(t => {
          if (t.type === 'Income') out += t.amount * vatRate;
          if (t.type === 'Expense') inp += t.amount * vatRate;
        });
        reportOutput.innerHTML = `<strong>VAT report</strong><br>VAT Output: ${b.currency || '₦'}${formatNumber(out)}<br>VAT Input: ${b.currency || '₦'}${formatNumber(inp)}<br>VAT Payable: ${b.currency || '₦'}${formatNumber(out-inp)}`;
      } else if (type === 'profit') {
        let inc = 0, exp = 0;
        txns.forEach(t => { if (t.type==='Income') inc += t.amount; if (t.type==='Expense') exp += t.amount; });
        reportOutput.innerHTML = `<strong>Profit report</strong><br>Income: ${inc.toLocaleString()}<br>Expenses: ${exp.toLocaleString()}<br>Net: ${(inc-exp).toLocaleString()}`;
      } else if (type === 'paye') {
        calculateSummary();
        reportOutput.innerHTML = `<strong>PAYE preview</strong><br/>See Tax summary panel for details.`;
      }
    });

    // Export handlers for reports
    btnExportHtml.addEventListener('click', () => {
      const from = reportDateFrom.value;
      const to = reportDateTo.value;
      const txns = (data.transactions[selectedBusinessId] || []).filter(t => {
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        return true;
      });
      const biz = findBiz(selectedBusinessId);
      const currency = (biz && biz.currency) ? biz.currency : '₦';
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      
      let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Transaction Report</title><style>
        body{font-family:Arial;margin:20px} table{border-collapse:collapse;width:100%} 
        th,td{border:1px solid #ddd;padding:8px;text-align:left} th{background:#f2f6fa}
      </style></head><body><h1>Transaction Report</h1>`;
      
      if (from || to) {
        html += `<p>Period: ${from || '(start)'} to ${to || '(end)'}</p>`;
      }
      
      html += `<table><thead><tr>
        <th>Date</th><th>Type</th><th>Category</th><th>Description</th>
        <th>Amount</th><th>VAT</th><th>WHT</th><th>Contact</th><th>Account</th><th>Author</th>
      </tr></thead><tbody>`;
      
      txns.forEach(t => {
        const vat = (biz && biz.vatEnabled && (t.type === 'Income' || t.type === 'Expense')) ? t.amount * vatRate : 0;
        const wht = (t.whtEnabled && t.whtAmount) ? t.whtAmount : 0;
        const author = findUser(t.authorUserId);
        const contact = findContact(selectedBusinessId, t.contactId);
        const account = findAccount(selectedBusinessId, t.accountId);
        
        html += `<tr>
          <td>${escapeHtml(t.date)}</td>
          <td>${escapeHtml(t.type)}</td>
          <td>${escapeHtml(t.category)}</td>
          <td>${escapeHtml(t.desc)}</td>
          <td>${currency}${formatNumber(t.amount)}</td>
          <td>${vat > 0 ? currency + formatNumber(vat) : ''}</td>
          <td>${wht > 0 ? currency + formatNumber(wht) : ''}</td>
          <td>${contact ? escapeHtml(contact.name) : ''}</td>
          <td>${account ? escapeHtml(account.name) : ''}</td>
          <td>${author ? escapeHtml(author.display || author.username) : ''}</td>
        </tr>`;
      });
      
      html += `</tbody></table></body></html>`;
      
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `report-${new Date().toISOString().slice(0,10)}.html`;
      a.click();
      URL.revokeObjectURL(url);
    });

    btnExportCsv.addEventListener('click', () => {
      const from = reportDateFrom.value;
      const to = reportDateTo.value;
      const txns = (data.transactions[selectedBusinessId] || []).filter(t => {
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        return true;
      });
      const biz = findBiz(selectedBusinessId);
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      
      let csv = 'Date,Type,Category,Description,Amount,VAT,WHT_Enabled,WHT_Rate,WHT_Amount,Contact,Account,Author\n';
      txns.forEach(t => {
        const vat = (biz && biz.vatEnabled && (t.type === 'Income' || t.type === 'Expense')) ? t.amount * vatRate : 0;
        const author = findUser(t.authorUserId);
        const contact = findContact(selectedBusinessId, t.contactId);
        const account = findAccount(selectedBusinessId, t.accountId);
        
        const row = [
          t.date,
          t.type,
          t.category,
          `"${(t.desc || '').replace(/"/g, '""')}"`,
          t.amount,
          vat.toFixed(2),
          t.whtEnabled ? 'true' : 'false',
          t.whtRate || 5,
          (t.whtAmount || 0).toFixed(2),
          contact ? `"${contact.name.replace(/"/g, '""')}"` : '',
          account ? `"${account.name.replace(/"/g, '""')}"` : '',
          author ? `"${(author.display || author.username).replace(/"/g, '""')}"` : ''
        ];
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `report-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    btnExportJson.addEventListener('click', () => {
      const from = reportDateFrom.value;
      const to = reportDateTo.value;
      const txns = (data.transactions[selectedBusinessId] || []).filter(t => {
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        return true;
      });
      
      const exportData = txns.map(t => {
        const author = findUser(t.authorUserId);
        const contact = findContact(selectedBusinessId, t.contactId);
        const account = findAccount(selectedBusinessId, t.accountId);
        
        return {
          id: t.id,
          date: t.date,
          type: t.type,
          category: t.category,
          description: t.desc,
          amount: t.amount,
          whtEnabled: t.whtEnabled || false,
          whtRate: t.whtRate || 5,
          whtAmount: t.whtAmount || 0,
          whtAccountId: t.whtAccountId || null,
          contact: contact ? { id: contact.id, name: contact.name, type: contact.type } : null,
          account: account ? { id: account.id, code: account.code, name: account.name } : null,
          author: author ? { id: author.id, username: author.username, display: author.display } : null
        };
      });
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `report-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Utilities used in inline onclicks
    window.removeTransaction = window.removeTransaction;
    window.openEditModal = window.openEditModal;
    window.editContact = window.editContact;
    window.deleteContact = window.deleteContact;
    window.editAccount = window.editAccount;
    window.deleteAccount = window.deleteAccount;

    // Initial population of inline selects
    populateContactSelects();
    populateAccountSelects();
    refreshContactsAccountsUI();

  </script>
  <footer>
    <div class="muted">Built with Nigeria taxation basics in mind — demo data included. Contacts and Chart of Accounts are scoped per business. Transactions reference contact and account IDs.</div>
  </footer>
</body>
  </html>
