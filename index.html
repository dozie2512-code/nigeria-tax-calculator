<!-- GitHub Copilot Chat Assistant -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(760px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .smallInput { width:76px; }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .inventory-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .inventory-table th, .inventory-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .inventory-table th { background:#f9fbff; }
    .account-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
        <button class="small" id="btnManageAccounts">Manage Accounts</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Inventory action:
          <select id="txnInventoryAction">
            <option value="None">None</option>
            <option value="Add">Add inventory</option>
            <option value="Purchase">Purchase inventory</option>
            <option value="Sale">Sale inventory</option>
          </select>
        </label>

        <label id="invItemLabel" style="display:none;">Item:
          <select id="invItemSelect"></select>
        </label>

        <label id="invNewSkuLabel" style="display:none;">SKU: <input type="text" id="invNewSku" /></label>
        <label id="invNewNameLabel" style="display:none;">Name: <input type="text" id="invNewName" /></label>

        <label id="invQtyLabel" style="display:none;">Qty: <input type="number" id="invQty" class="smallInput" min="0" step="1" /></label>
        <label id="invUnitCostLabel" style="display:none;">Unit cost (₦): <input type="number" id="invUnitCost" class="smallInput" min="0" step="0.01" /></label>
        <label id="invSalePriceLabel" style="display:none;">Sale price/unit (₦): <input type="number" id="invSalePrice" class="smallInput" min="0" step="0.01" /></label>

        <label id="acctLabel">Account:
          <select id="txnAccount"></select>
        </label>

        <label id="descLabel">Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label id="amountLabel">Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
        <label id="whtLabel" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="depLabel" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="txnDep" /> Depreciable
        </label>
        <label id="txnUsefulLifeLabel" style="display:none;">Useful life (yrs): <input type="number" id="txnUsefulLife" class="smallInput" min="1" step="1" /></label>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved per selected user and business. VAT rate & tax rules are per business (editable in Business settings). Mark 'Depreciable' for capital allowance (straight-line)</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf; border-radius:4px;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Account</th>
            <th>Description</th>
            <th>Amount</th>
            <th>VAT</th>
            <th>WHT</th>
            <th>Cap. Allow (yr)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Inventory (selected business)</h2>
      <div>
        <button class="small" id="btnOpenInventoryModal">Manage Inventory</button>
      </div>
      <table class="inventory-table" id="inventoryTable">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Name</th>
            <th>Qty</th>
            <th>Avg cost</th>
            <th>Value</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Assets (selected business)</h2>
      <div style="display:flex;gap:8px;margin-bottom:10px;">
        <button class="small primary" id="btnPurchaseAsset">Purchase Asset</button>
        <button class="small" id="btnDisposeAsset">Dispose Asset</button>
        <button class="small" id="btnTaxAdjustments">Tax Adjustments</button>
      </div>
      <table class="inventory-table" id="assetsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Cost</th>
            <th>Purchase Date</th>
            <th>Useful Life</th>
            <th>Acc. Depreciation</th>
            <th>Book Value</th>
            <th>CA Allowed</th>
            <th>CA Carryforward</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="userNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
    </div>
    <div class="row">
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" class="smallInput" /></label>
      <label>WHT rate (%): <input type="number" id="bizWht" min="0" step="0.01" class="smallInput" /></label>
      <label>WHT base:
        <select id="bizWhtMode">
          <option value="gross">Gross (before VAT)</option>
          <option value="net">Net (after VAT)</option>
        </select>
      </label>
      <label>CIT rate (%): <input type="number" id="bizCit" min="0" step="0.01" class="smallInput" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Default useful life (yrs): <input type="number" id="bizUsefulLife" min="1" step="1" class="smallInput" /></label>
      <label>Opening CA balance (₦): <input type="number" id="bizOpeningCA" min="0" step="0.01" /></label>
    </div>
    <div class="row">
      <label>Accounts (comma-separated): <input type="text" id="bizAccounts" placeholder="Sales,COGS,Expense,Assets" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (tax)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE on salaries</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
    <small class="note">Provide accounts as a comma-separated list. Each business maintains its own accounts used in transactions.</small>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>
    <label>Account:
      <select id="editTxnAccount"></select>
    </label><br/>
    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="editTxnWht" /> WHT applied</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="editTxnDep" /> Depreciable</label>
      <label id="editTxnUsefulLabel" style="display:none;">Useful life (yrs): <input type="number" id="editTxnUseful" class="smallInput" min="1" step="1" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="editCancelBtn">Cancel</button>
      <button class="primary" id="editSaveBtn">Save</button>
    </div>
  </div>

  <div id="inventoryModal" class="modal" aria-hidden="true">
    <h3>Manage Inventory Item</h3>
    <div class="row">
      <label>SKU: <input type="text" id="invModalSku" /></label>
      <label>Name: <input type="text" id="invModalName" /></label>
    </div>
    <div class="row">
      <label>Qty: <input type="number" id="invModalQty" class="smallInput" min="0" step="1" /></label>
      <label>Unit cost (₦): <input type="number" id="invModalUnitCost" class="smallInput" min="0" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="invModalCancel">Cancel</button>
      <button class="primary" id="invModalSave">Save</button>
    </div>
  </div>

  <div id="accountsModal" class="modal" aria-hidden="true">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="margin-bottom:12px;"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <button id="addAccountBtn" class="small">Add Account</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
    <small class="note">You cannot delete an account that has transactions. Rename and add accounts freely.</small>
  </div>

  <div id="purchaseAssetModal" class="modal" aria-hidden="true">
    <h3>Purchase Asset</h3>
    <div class="row">
      <label>Asset name: <input type="text" id="assetName" placeholder="Equipment, Vehicle, etc." style="width:200px;" /></label>
    </div>
    <div class="row">
      <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
      <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
    </div>
    <div class="row">
      <label>Useful life (yrs): <input type="number" id="assetUsefulLife" min="1" step="1" class="smallInput" /></label>
      <label>Opening CA (₦): <input type="number" id="assetOpeningCA" min="0" step="0.01" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="assetCancelBtn">Cancel</button>
      <button class="primary" id="assetSaveBtn">Purchase Asset</button>
    </div>
    <small class="note">Asset will be depreciated monthly (straight-line) for accounting. Capital allowance computed separately for tax purposes using 2/3 rule.</small>
  </div>

  <div id="disposeAssetModal" class="modal" aria-hidden="true">
    <h3>Dispose Asset</h3>
    <div class="row">
      <label>Select asset:
        <select id="disposeAssetSelect" style="width:300px;"></select>
      </label>
    </div>
    <div class="row">
      <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
      <label>Disposal proceeds (₦): <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="disposeAssetCancelBtn">Cancel</button>
      <button class="primary" id="disposeAssetSaveBtn">Dispose Asset</button>
    </div>
    <small class="note">Disposal will mark asset as disposed, compute accumulated depreciation to disposal date, and record gain/loss transaction.</small>
  </div>

  <div id="taxAdjustmentsModal" class="modal" aria-hidden="true">
    <h3>Tax Adjustments (Deductions)</h3>
    <p class="muted" style="margin-top:0;">Enter annual deductible amounts for the selected user and business.</p>
    <div class="row">
      <label>Pension contributions (₦): <input type="number" id="taxPension" min="0" step="0.01" /></label>
      <label>NHF contributions (₦): <input type="number" id="taxNHF" min="0" step="0.01" /></label>
    </div>
    <div class="row">
      <label>Mortgage interest (₦): <input type="number" id="taxMortgage" min="0" step="0.01" /></label>
      <label>Life insurance (₦): <input type="number" id="taxLifeInsurance" min="0" step="0.01" /></label>
    </div>
    <div class="row">
      <label>Rent paid (₦): <input type="number" id="taxRentPaid" min="0" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="taxAdjustmentsCancelBtn">Cancel</button>
      <button class="primary" id="taxAdjustmentsSaveBtn">Save</button>
    </div>
    <small class="note">Rent relief is computed as 20% of rent paid. These adjustments reduce taxable income for PIT/PAYE calculations.</small>
  </div>

  <script>
    // GitHub Copilot Chat Assistant
    const STORAGE_KEY = 'ntc_data_v2';

    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    const DEFAULT_BUSINESS_TAX = {
      whtRate: 5.0,
      citRate: 30.0,
      defaultUsefulLifeYears: 5,
      payeEnabled: true
    };

    // Data structure:
    // - assets: object keyed by business id, each containing array of asset objects
    // - taxAdjustments: object keyed by bizId, then userId, containing deduction fields
    let data = { users: [], businesses: [], transactions: {}, inventories: {}, assets: {}, taxAdjustments: {} };
    let selectedUserId = null;
    let selectedBusinessId = null;
    let editTxnRef = null;
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';

    function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function formatNumber(n){ return Number(n || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    function ensureBizDefaults(biz){
      if(!biz) return;
      if (typeof biz.whtRate === 'undefined') biz.whtRate = DEFAULT_BUSINESS_TAX.whtRate;
      if (typeof biz.citRate === 'undefined') biz.citRate = DEFAULT_BUSINESS_TAX.citRate;
      if (typeof biz.defaultUsefulLifeYears === 'undefined') biz.defaultUsefulLifeYears = DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      if (typeof biz.payeEnabled === 'undefined') biz.payeEnabled = DEFAULT_BUSINESS_TAX.payeEnabled;
      if (typeof biz.vatEnabled === 'undefined') biz.vatEnabled = true;
      if (typeof biz.pitEnabled === 'undefined') biz.pitEnabled = true;
      if (typeof biz.threshold === 'undefined') biz.threshold = DEFAULT_PIT.threshold;
      if (!Array.isArray(biz.accounts)) biz.accounts = [];
      // New fields for WHT mode and capital allowances
      if (typeof biz.whtMode === 'undefined') biz.whtMode = 'gross'; // 'gross' or 'net'
      if (typeof biz.openingCapitalAllowanceBalance === 'undefined') biz.openingCapitalAllowanceBalance = 0;
    }

    function ensureInventoriesForBusiness(bizId){
      if (!data.inventories) data.inventories = {};
      if (!data.inventories[bizId]) data.inventories[bizId] = [];
    }

    function ensureAssetsForBusiness(bizId){
      if (!data.assets) data.assets = {};
      if (!data.assets[bizId]) data.assets[bizId] = [];
    }

    function ensureTaxAdjustmentsForBusiness(bizId){
      if (!data.taxAdjustments) data.taxAdjustments = {};
      if (!data.taxAdjustments[bizId]) data.taxAdjustments[bizId] = {};
    }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object'){
            data = parsed;
            if (!data.users) data.users = [];
            if (!data.businesses) data.businesses = [];
            if (!data.transactions) data.transactions = {};
            if (!data.inventories) data.inventories = {};
            // Migration: add new data structures if missing
            if (!data.assets) data.assets = {};
            if (!data.taxAdjustments) data.taxAdjustments = {};
            data.businesses.forEach(b => {
              ensureBizDefaults(b);
              ensureInventoriesForBusiness(b.id);
              ensureAssetsForBusiness(b.id);
              ensureTaxAdjustmentsForBusiness(b.id);
            });
            migrateTransactionsToAccounts();
            return;
          }
        } catch(e){
          console.error('Invalid saved data', e);
        }
      }
      // seed demo
      const u = uid('user'), b = uid('biz');
      data = {
        users: [{ id: u, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{
          id: b, name: 'Demo Business', ownerId: u, vatRate: 7.5,
          whtRate: DEFAULT_BUSINESS_TAX.whtRate, citRate: DEFAULT_BUSINESS_TAX.citRate,
          defaultUsefulLifeYears: DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears,
          currency: '₦', threshold: DEFAULT_PIT.threshold, notes: 'Sample business',
          vatEnabled: true, pitEnabled: true, payeEnabled: true,
          whtMode: 'gross', openingCapitalAllowanceBalance: 0,
          accounts: [
            { id: uid('acct'), name: 'Sales' },
            { id: uid('acct'), name: 'COGS' },
            { id: uid('acct'), name: 'Purchases' },
            { id: uid('acct'), name: 'Expense' },
            { id: uid('acct'), name: 'Depreciation' },
            { id: uid('acct'), name: 'Asset Disposal Gain/Loss' }
          ]
        }],
        transactions: { },
        inventories: {},
        assets: {},
        taxAdjustments: {}
      };
      data.inventories[b] = [
        { id: uid('inv'), sku: 'DEMO-001', name: 'Demo Item', qty: 10, unitCost: 5000.00, avgCost: 5000.00 }
      ];
      // Add sample asset for Demo Business
      data.assets[b] = [
        {
          id: uid('asset'),
          bizId: b,
          name: 'Demo Equipment',
          cost: 1200000,
          purchaseDate: '2024-01-01',
          usefulLifeYears: 5,
          accumulatedDepreciation: 0,
          disposed: false,
          disposalDate: null,
          disposalProceeds: 0,
          openingCapitalAllowance: 0,
          accumulatedCapitalAllowance: 0,
          caCarryforward: 0
        }
      ];
      data.taxAdjustments[b] = {};
      ensureBizDefaults(data.businesses[0]);
      saveData();
    }

    function migrateTransactionsToAccounts(){
      for (const b of data.businesses || []) ensureBizDefaults(b);
      for (const uidKey of Object.keys(data.transactions || {})){
        const perUser = data.transactions[uidKey] || {};
        for (const bid of Object.keys(perUser || {})){
          const arr = perUser[bid] || [];
          for (const txn of arr){
            if (txn.accountId) continue;
            let acctName = txn.accountName || null;
            if (!acctName) {
              const t = txn.type || '', c = txn.category || '';
              if (t && c) acctName = `${t} - ${c}`;
              else if (t) acctName = t;
              else if (c) acctName = c;
              else acctName = 'Unassigned';
            }
            const biz = findBiz(bid);
            if (!biz) {
              txn.accountName = acctName;
              continue;
            }
            ensureBizDefaults(biz);
            let acct = biz.accounts.find(a => a.name === acctName);
            if (!acct){
              acct = { id: uid('acct'), name: acctName };
              biz.accounts.push(acct);
            }
            txn.accountId = acct.id;
            txn.accountName = acct.name;
          }
        }
      }
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }
    function findAccount(bizId, accountId){ const b = findBiz(bizId); if (!b || !b.accounts) return null; return b.accounts.find(a=>a.id===accountId) || null; }

    // UI refs
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    // User modal
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userNotes = document.getElementById('userNotes');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    // Business modal
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwner = document.getElementById('bizOwner');
    const bizVat = document.getElementById('bizVat');
    const bizWht = document.getElementById('bizWht');
    const bizWhtMode = document.getElementById('bizWhtMode');
    const bizCit = document.getElementById('bizCit');
    const bizCurrency = document.getElementById('bizCurrency');
    const bizThreshold = document.getElementById('bizThreshold');
    const bizOpeningCA = document.getElementById('bizOpeningCA');
    const bizNotes = document.getElementById('bizNotes');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizPayeEnabled = document.getElementById('bizPayeEnabled');
    const bizUsefulLife = document.getElementById('bizUsefulLife');
    const bizAccounts = document.getElementById('bizAccounts');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');

    // Edit modal
    const editModal = document.getElementById('editModal');
    const editTxnDate = document.getElementById('editTxnDate');
    const editTxnAccount = document.getElementById('editTxnAccount');
    const editTxnDesc = document.getElementById('editTxnDesc');
    const editTxnAmount = document.getElementById('editTxnAmount');
    const editTxnWht = document.getElementById('editTxnWht');
    const editTxnDep = document.getElementById('editTxnDep');
    const editTxnUseful = document.getElementById('editTxnUseful');
    const editTxnUsefulLabel = document.getElementById('editTxnUsefulLabel');
    const editCancelBtn = document.getElementById('editCancelBtn');
    const editSaveBtn = document.getElementById('editSaveBtn');

    // Add txn fields
    const txnWht = document.getElementById('txnWht');
    const txnDep = document.getElementById('txnDep');
    const txnUsefulLife = document.getElementById('txnUsefulLife');
    const txnUsefulLifeLabel = document.getElementById('txnUsefulLifeLabel');

    const txnInventoryAction = document.getElementById('txnInventoryAction');
    const invItemSelect = document.getElementById('invItemSelect');
    const invNewSku = document.getElementById('invNewSku');
    const invNewName = document.getElementById('invNewName');
    const invQty = document.getElementById('invQty');
    const invUnitCost = document.getElementById('invUnitCost');
    const invSalePrice = document.getElementById('invSalePrice');

    const invItemLabel = document.getElementById('invItemLabel');
    const invNewSkuLabel = document.getElementById('invNewSkuLabel');
    const invNewNameLabel = document.getElementById('invNewNameLabel');
    const invQtyLabel = document.getElementById('invQtyLabel');
    const invUnitCostLabel = document.getElementById('invUnitCostLabel');
    const invSalePriceLabel = document.getElementById('invSalePriceLabel');

    const acctLabel = document.getElementById('acctLabel');
    const txnAccount = document.getElementById('txnAccount');

    const descLabel = document.getElementById('descLabel');
    const amountLabel = document.getElementById('amountLabel');
    const whtLabel = document.getElementById('whtLabel');
    const depLabel = document.getElementById('depLabel');

    // Search & pagination UI
    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    // Export/Import
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // Inventory UI
    const inventoryTableBody = document.querySelector('#inventoryTable tbody');
    const btnOpenInventoryModal = document.getElementById('btnOpenInventoryModal');
    const inventoryModal = document.getElementById('inventoryModal');
    const invModalSku = document.getElementById('invModalSku');
    const invModalName = document.getElementById('invModalName');
    const invModalQty = document.getElementById('invModalQty');
    const invModalUnitCost = document.getElementById('invModalUnitCost');
    const invModalCancel = document.getElementById('invModalCancel');
    const invModalSave = document.getElementById('invModalSave');

    // Accounts modal
    const btnManageAccounts = document.getElementById('btnManageAccounts');
    const accountsModal = document.getElementById('accountsModal');
    const accountsList = document.getElementById('accountsList');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const newAccountName = document.getElementById('newAccountName');
    const closeAccountsBtn = document.getElementById('closeAccountsBtn');

    // Assets modal elements
    const btnPurchaseAsset = document.getElementById('btnPurchaseAsset');
    const btnDisposeAsset = document.getElementById('btnDisposeAsset');
    const btnTaxAdjustments = document.getElementById('btnTaxAdjustments');
    const assetsTableBody = document.querySelector('#assetsTable tbody');
    
    const purchaseAssetModal = document.getElementById('purchaseAssetModal');
    const assetName = document.getElementById('assetName');
    const assetCost = document.getElementById('assetCost');
    const assetPurchaseDate = document.getElementById('assetPurchaseDate');
    const assetUsefulLife = document.getElementById('assetUsefulLife');
    const assetOpeningCA = document.getElementById('assetOpeningCA');
    const assetCancelBtn = document.getElementById('assetCancelBtn');
    const assetSaveBtn = document.getElementById('assetSaveBtn');
    
    const disposeAssetModal = document.getElementById('disposeAssetModal');
    const disposeAssetSelect = document.getElementById('disposeAssetSelect');
    const assetDisposalDate = document.getElementById('assetDisposalDate');
    const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
    const disposeAssetCancelBtn = document.getElementById('disposeAssetCancelBtn');
    const disposeAssetSaveBtn = document.getElementById('disposeAssetSaveBtn');
    
    const taxAdjustmentsModal = document.getElementById('taxAdjustmentsModal');
    const taxPension = document.getElementById('taxPension');
    const taxNHF = document.getElementById('taxNHF');
    const taxMortgage = document.getElementById('taxMortgage');
    const taxLifeInsurance = document.getElementById('taxLifeInsurance');
    const taxRentPaid = document.getElementById('taxRentPaid');
    const taxAdjustmentsCancelBtn = document.getElementById('taxAdjustmentsCancelBtn');
    const taxAdjustmentsSaveBtn = document.getElementById('taxAdjustmentsSaveBtn');

    let userEditingId = null;
    let bizEditingId = null;
    let inventoryEditingId = null;
    let editingTxnRef = null;

    // Helper functions for depreciation and capital allowances
    
    // Compute monthly depreciation for an asset (straight-line)
    function computeMonthlyDepreciation(asset) {
      if (!asset || asset.disposed) return 0;
      return asset.cost / (asset.usefulLifeYears * 12);
    }
    
    // Compute accumulated depreciation up to a given date
    function computeAccumulatedDepreciation(asset, upToDate) {
      if (!asset) return 0;
      const purchaseDate = new Date(asset.purchaseDate);
      const endDate = asset.disposed ? new Date(asset.disposalDate) : new Date(upToDate);
      
      if (endDate < purchaseDate) return 0;
      
      const monthlyDep = computeMonthlyDepreciation(asset);
      let totalDep = 0;
      
      // Calculate months between purchase and end date
      const monthsDiff = (endDate.getFullYear() - purchaseDate.getFullYear()) * 12 + 
                         (endDate.getMonth() - purchaseDate.getMonth());
      
      // Full months depreciation
      totalDep = monthsDiff * monthlyDep;
      
      // Prorate first partial month if purchase wasn't on the 1st
      if (purchaseDate.getDate() > 1) {
        const daysInPurchaseMonth = new Date(purchaseDate.getFullYear(), purchaseDate.getMonth() + 1, 0).getDate();
        const remainingDays = daysInPurchaseMonth - purchaseDate.getDate() + 1;
        const firstMonthProrated = (monthlyDep * remainingDays) / daysInPurchaseMonth;
        totalDep += firstMonthProrated;
      } else {
        totalDep += monthlyDep;
      }
      
      // Prorate last partial month if disposal wasn't on the last day or if current month
      if (asset.disposed && endDate.getDate() !== new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate()) {
        const daysInDisposalMonth = new Date(endDate.getFullYear(), endDate.getMonth() + 1, 0).getDate();
        const lastMonthProrated = (monthlyDep * endDate.getDate()) / daysInDisposalMonth;
        totalDep += lastMonthProrated - monthlyDep; // Subtract full month, add prorated
      }
      
      return Math.min(totalDep, asset.cost); // Cap at cost
    }
    
    // Compute annual capital allowance for tax purposes (straight-line tax allowance)
    function computeAnnualCapitalAllowance(asset) {
      if (!asset) return 0;
      return asset.cost / asset.usefulLifeYears;
    }
    
    // Compute allowable capital allowance (2/3 rule) and carryforward
    function computeCapitalAllowanceForPeriod(asset, periodStartDate, periodEndDate) {
      const annualCA = computeAnnualCapitalAllowance(asset);
      const purchaseDate = new Date(asset.purchaseDate);
      const startDate = new Date(periodStartDate);
      const endDate = new Date(periodEndDate);
      
      // Check if asset is in the period
      if (asset.disposed && new Date(asset.disposalDate) < startDate) return { allowed: 0, carryforward: 0 };
      if (purchaseDate > endDate) return { allowed: 0, carryforward: 0 };
      
      // Calculate proportion of year in period
      const yearDays = 365;
      const periodDays = Math.min(
        (endDate - Math.max(purchaseDate, startDate)) / (1000 * 60 * 60 * 24),
        yearDays
      );
      const periodCA = (annualCA * periodDays) / yearDays;
      
      // Apply 2/3 rule
      const allowedCA = (periodCA * 2) / 3;
      const carryforwardCA = periodCA / 3;
      
      return { allowed: allowedCA, carryforward: carryforwardCA };
    }

    function computePIT(income, biz){
      const threshold = (biz && typeof biz.threshold === 'number') ? biz.threshold : DEFAULT_PIT.threshold;
      if (income <= threshold) return 0;
      let tax = 0;
      let prevUpper = threshold;
      for (const slice of DEFAULT_PIT.slices){
        const upper = slice.upTo;
        const sliceUpper = Math.max(prevUpper, Math.min(income, upper));
        const taxableInSlice = Math.max(0, sliceUpper - prevUpper);
        tax += taxableInSlice * slice.rate;
        prevUpper = upper;
        if (income <= upper) break;
      }
      return tax;
    }

    function openModal(modal){
      modalOverlay.style.display = 'block';
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal){
      modalOverlay.style.display = 'none';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      userEditingId = null;
      bizEditingId = null;
      inventoryEditingId = null;
      editingTxnRef = null;
    }

    modalOverlay.addEventListener('click', () => {
      [userModal, businessModal, editModal, inventoryModal, accountsModal, purchaseAssetModal, disposeAssetModal, taxAdjustmentsModal].forEach(m => { if (m.style.display === 'block') closeModal(m); });
    });

    // Initialization
    loadData();
    refreshUserBusinessSelectors();
    ensureSelection();
    populateInvItemSelect();
    populateAccountSelect();
    currentPage = 1;
    renderLedger();
    calculateSummary();
    renderInventory();
    renderAssets();
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('txnDate').value = today;

    // --- User & Business management functions ---
    function refreshUserBusinessSelectors(){
      userSelect.innerHTML = '';
      data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = (u.display || u.username) + ' (' + u.username + ')';
        userSelect.appendChild(opt);
      });

      businessSelect.innerHTML = '';
      data.businesses.forEach(b => {
        ensureBizDefaults(b);
        const owner = findUser(b.ownerId);
        const enabledParts = [];
        if (b.vatEnabled) enabledParts.push('VAT');
        if (b.pitEnabled) enabledParts.push('PIT');
        if (b.payeEnabled) enabledParts.push('PAYE');
        const status = enabledParts.length ? ' — ' + enabledParts.join('/') : '';
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name}${owner ? ' — ' + (owner.display || owner.username) : ''} (${(typeof b.vatRate === 'number' ? b.vatRate : 0)}% VAT, ${(typeof b.citRate === 'number' ? b.citRate : 0)}% CIT)${status}`;
        businessSelect.appendChild(opt);
        ensureInventoriesForBusiness(b.id);
      });

      bizOwner.innerHTML = '';
      data.users.forEach(u => {
        const o = document.createElement('option');
        o.value = u.id;
        o.textContent = (u.display || u.username);
        bizOwner.appendChild(o);
      });

      if (!data.users.find(u=>u.id===selectedUserId)) selectedUserId = data.users.length ? data.users[0].id : null;
      if (!data.businesses.find(b=>b.id===selectedBusinessId)) selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;

      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function ensureSelection(){
      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length) selectedBusinessId = data.businesses[0].id;
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    // Users
    btnAddUser.addEventListener('click', () => {
      userModalTitle.textContent = 'Add User';
      userName.value = '';
      userDisplay.value = '';
      userNotes.value = '';
      userEditingId = null;
      openModal(userModal);
    });

    btnEditUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      userModalTitle.textContent = 'Edit User';
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userNotes.value = u.notes || '';
      userEditingId = u.id;
      openModal(userModal);
    });

    btnDeleteUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      if (!confirm(`Delete user "${u.display || u.username}" and all their businesses & transactions? This action cannot be undone.`)) return;
      data.businesses = data.businesses.filter(b => b.ownerId !== u.id);
      delete data.transactions[u.id];
      data.users = data.users.filter(x => x.id !== u.id);
      const remainingBizIds = new Set(data.businesses.map(b => b.id));
      const newInventories = {};
      for (const bid of Object.keys(data.inventories || {})) {
        if (remainingBizIds.has(bid)) newInventories[bid] = data.inventories[bid];
      }
      data.inventories = newInventories;
      if (!data.users.length) data = { users: [], businesses: [], transactions: {}, inventories: {}, assets: {}, taxAdjustments: {} };
      saveData();
      selectedUserId = data.users.length ? data.users[0].id : null;
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
      renderInventory();
      renderAssets();
    });

    userSave.addEventListener('click', () => {
      const username = (userName.value || '').trim();
      if (!username) { alert('Username required'); return; }
      if (userEditingId) {
        const u = findUser(userEditingId);
        if (!u) return;
        u.username = username;
        u.display = (userDisplay.value||'').trim();
        u.notes = (userNotes.value||'').trim();
      } else {
        const exists = data.users.find(x => x.username === username);
        if (exists) { if (!confirm('Username already exists. Add anyway?')) return; }
        const id = uid('user');
        data.users.push({ id, username, display: (userDisplay.value||'').trim(), notes: (userNotes.value||'').trim() });
      }
      saveData();
      closeModal(userModal);
      refreshUserBusinessSelectors();
      ensureSelection();
    });

    userCancel.addEventListener('click', () => closeModal(userModal));

    userSelect.addEventListener('change', (e) => {
      selectedUserId = e.target.value;
      const owned = data.businesses.find(b => b.ownerId === selectedUserId);
      if (owned) selectedBusinessId = owned.id;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderInventory();
      renderAssets();
      populateInvItemSelect();
      populateAccountSelect();
    });

    // Businesses
    btnAddBusiness.addEventListener('click', () => {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = '';
      bizVat.value = 7.5;
      bizWht.value = DEFAULT_BUSINESS_TAX.whtRate;
      bizWhtMode.value = 'gross';
      bizCit.value = DEFAULT_BUSINESS_TAX.citRate;
      bizCurrency.value = '₦';
      bizThreshold.value = DEFAULT_PIT.threshold;
      bizUsefulLife.value = DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      bizOpeningCA.value = 0;
      bizNotes.value = '';
      bizAccounts.value = 'Sales,COGS,Purchases,Expense,Depreciation,Asset Disposal Gain/Loss';
      bizOwner.value = selectedUserId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = true;
      bizPitEnabled.checked = true;
      bizPayeEnabled.checked = true;
      bizEditingId = null;
      openModal(businessModal);
    });

    btnEditBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizVat.value = (typeof b.vatRate === 'number') ? b.vatRate : 7.5;
      bizWht.value = (typeof b.whtRate === 'number') ? b.whtRate : DEFAULT_BUSINESS_TAX.whtRate;
      bizWhtMode.value = b.whtMode || 'gross';
      bizCit.value = (typeof b.citRate === 'number') ? b.citRate : DEFAULT_BUSINESS_TAX.citRate;
      bizCurrency.value = b.currency || '₦';
      bizThreshold.value = (typeof b.threshold === 'number') ? b.threshold : DEFAULT_PIT.threshold;
      bizUsefulLife.value = (typeof b.defaultUsefulLifeYears === 'number') ? b.defaultUsefulLifeYears : DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      bizOpeningCA.value = (typeof b.openingCapitalAllowanceBalance === 'number') ? b.openingCapitalAllowanceBalance : 0;
      bizNotes.value = b.notes || '';
      bizOwner.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = !!b.vatEnabled;
      bizPitEnabled.checked = (typeof b.pitEnabled === 'undefined') ? true : !!b.pitEnabled;
      bizPayeEnabled.checked = (typeof b.payeEnabled === 'undefined') ? true : !!b.payeEnabled;
      bizAccounts.value = (b.accounts || []).map(a => a.name).join(',');
      bizEditingId = b.id;
      openModal(businessModal);
    });

    btnDeleteBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm(`Delete business "${b.name}" and all its transactions for all users? This action cannot be undone.`)) return;
      data.businesses = data.businesses.filter(x => x.id !== b.id);
      for (const uidKey of Object.keys(data.transactions)) {
        if (data.transactions[uidKey] && data.transactions[uidKey][b.id]) delete data.transactions[uidKey][b.id];
      }
      if (data.inventories && data.inventories[b.id]) delete data.inventories[b.id];
      if (data.assets && data.assets[b.id]) delete data.assets[b.id];
      if (data.taxAdjustments && data.taxAdjustments[b.id]) delete data.taxAdjustments[b.id];
      saveData();
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderInventory();
      renderAssets();
      populateInvItemSelect();
      populateAccountSelect();
    });

    bizSave.addEventListener('click', () => {
      const name = (bizName.value || '').trim();
      const ownerIdVal = bizOwner.value;
      const vat = parseFloat(bizVat.value);
      const wht = parseFloat(bizWht.value);
      const whtModeVal = bizWhtMode.value || 'gross';
      const cit = parseFloat(bizCit.value);
      const currency = (bizCurrency.value || '₦').trim();
      const threshold = Number(bizThreshold.value) || DEFAULT_PIT.threshold;
      const usableLife = parseInt(bizUsefulLife.value) || DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      const openingCA = parseFloat(bizOpeningCA.value) || 0;
      const vatEnabledVal = !!bizVatEnabled.checked;
      const pitEnabledVal = !!bizPitEnabled.checked;
      const payeEnabledVal = !!bizPayeEnabled.checked;
      const accountsStr = (bizAccounts.value || '').trim();
      if (!name) { alert('Business name required'); return; }
      if (!ownerIdVal) { alert('Select owner'); return; }
      const parsedAccounts = accountsStr ? accountsStr.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if (bizEditingId) {
        const b = findBiz(bizEditingId);
        if (!b) return;
        b.name = name;
        b.ownerId = ownerIdVal;
        b.vatRate = isNaN(vat) ? 7.5 : vat;
        b.whtRate = isNaN(wht) ? DEFAULT_BUSINESS_TAX.whtRate : wht;
        b.whtMode = whtModeVal;
        b.citRate = isNaN(cit) ? DEFAULT_BUSINESS_TAX.citRate : cit;
        b.currency = currency;
        b.threshold = threshold;
        b.defaultUsefulLifeYears = usableLife;
        b.openingCapitalAllowanceBalance = openingCA;
        b.notes = (bizNotes.value || '').trim();
        b.vatEnabled = vatEnabledVal;
        b.pitEnabled = pitEnabledVal;
        b.payeEnabled = payeEnabledVal;
        const newAccounts = [];
        parsedAccounts.forEach(nameVal => {
          const existing = b.accounts.find(a=>a.name===nameVal);
          if (existing) newAccounts.push(existing);
          else newAccounts.push({ id: uid('acct'), name: nameVal });
        });
        b.accounts = newAccounts;
      } else {
        const id = uid('biz');
        const accounts = parsedAccounts.map(nameVal => ({ id: uid('acct'), name: nameVal }));
        data.businesses.push({
          id, name, ownerId: ownerIdVal,
          vatRate: isNaN(vat) ? 7.5 : vat,
          whtRate: isNaN(wht) ? DEFAULT_BUSINESS_TAX.whtRate : wht,
          whtMode: whtModeVal,
          citRate: isNaN(cit) ? DEFAULT_BUSINESS_TAX.citRate : cit,
          currency,
          threshold,
          defaultUsefulLifeYears: usableLife,
          openingCapitalAllowanceBalance: openingCA,
          notes: (bizNotes.value || '').trim(),
          vatEnabled: vatEnabledVal,
          pitEnabled: pitEnabledVal,
          payeEnabled: payeEnabledVal,
          accounts
        });
        ensureInventoriesForBusiness(id);
        ensureAssetsForBusiness(id);
        ensureTaxAdjustmentsForBusiness(id);
      }
      saveData();
      closeModal(businessModal);
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderInventory();
      renderAssets();
      populateInvItemSelect();
      populateAccountSelect();
    });

    bizCancel.addEventListener('click', () => closeModal(businessModal));

    businessSelect.addEventListener('change', (e) => {
      selectedBusinessId = e.target.value;
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderInventory();
      renderAssets();
      populateInvItemSelect();
      populateAccountSelect();
    });

    // Transactions: UI behavior
    txnDep.addEventListener('change', () => {
      txnUsefulLifeLabel.style.display = txnDep.checked ? '' : 'none';
      if (!txnDep.checked) txnUsefulLife.value = '';
    });

    editTxnDep.addEventListener('change', () => {
      editTxnUsefulLabel.style.display = editTxnDep.checked ? '' : 'none';
      if (!editTxnDep.checked) editTxnUseful.value = '';
    });

    // Inventory action behaviour (hide/show fields)
    txnInventoryAction.addEventListener('change', () => {
      const v = txnInventoryAction.value;
      invItemLabel.style.display = 'none';
      invNewSkuLabel.style.display = 'none';
      invNewNameLabel.style.display = 'none';
      invQtyLabel.style.display = 'none';
      invUnitCostLabel.style.display = 'none';
      invSalePriceLabel.style.display = 'none';

      if (v === 'None') {
        invItemLabel.style.display = 'none';
        descLabel.style.display = '';
        amountLabel.style.display = '';
        acctLabel.style.display = '';
        whtLabel.style.display = 'inline-flex';
        depLabel.style.display = 'inline-flex';
        txnUsefulLifeLabel.style.display = txnDep.checked ? '' : 'none';
        populateInvItemSelect();
        populateAccountSelect();
        return;
      }

      invItemLabel.style.display = '';
      if (v === 'Add' || v === 'Purchase') {
        invNewSkuLabel.style.display = '';
        invNewNameLabel.style.display = '';
        invQtyLabel.style.display = '';
        invUnitCostLabel.style.display = '';
        invSalePriceLabel.style.display = 'none';
      } else if (v === 'Sale') {
        invNewSkuLabel.style.display = 'none';
        invNewNameLabel.style.display = 'none';
        invQtyLabel.style.display = '';
        invUnitCostLabel.style.display = 'none';
        invSalePriceLabel.style.display = '';
      }

      descLabel.style.display = 'none';
      amountLabel.style.display = 'none';
      acctLabel.style.display = 'none';
      whtLabel.style.display = 'none';
      depLabel.style.display = 'none';
      txnUsefulLifeLabel.style.display = 'none';

      populateInvItemSelect();
    });

    invItemSelect.addEventListener('change', () => {
      const val = invItemSelect.value;
      if (val === '__new__') {
        invNewSkuLabel.style.display = '';
        invNewNameLabel.style.display = '';
      } else {
        invNewSkuLabel.style.display = 'none';
        invNewNameLabel.style.display = 'none';
      }
    });

    function populateInvItemSelect(){
      invItemSelect.innerHTML = '';
      if (!selectedBusinessId) return;
      ensureInventoriesForBusiness(selectedBusinessId);
      const items = data.inventories[selectedBusinessId] || [];
      const optNone = document.createElement('option');
      optNone.value = '';
      optNone.textContent = '-- select --';
      invItemSelect.appendChild(optNone);
      items.forEach(it=>{
        const o = document.createElement('option');
        o.value = it.id;
        o.textContent = `${it.sku || ''} — ${it.name || ''}`;
        invItemSelect.appendChild(o);
      });
      const optNew = document.createElement('option');
      optNew.value = '__new__';
      optNew.textContent = '-- New item --';
      invItemSelect.appendChild(optNew);
    }

    function populateAccountSelect(){
      [txnAccount, editTxnAccount].forEach(sel=>{
        if (!sel) return;
        sel.innerHTML = '';
        if (!selectedBusinessId) {
          const o = document.createElement('option'); o.value=''; o.textContent='-- no business --'; sel.appendChild(o); return;
        }
        const biz = findBiz(selectedBusinessId);
        if (!biz) { const o = document.createElement('option'); o.value=''; o.textContent='-- no business --'; sel.appendChild(o); return; }
        ensureBizDefaults(biz);
        if (!biz.accounts || !biz.accounts.length) {
          const o = document.createElement('option'); o.value=''; o.textContent='-- no accounts defined --'; sel.appendChild(o);
        } else {
          const o = document.createElement('option'); o.value=''; o.textContent='-- select account --'; sel.appendChild(o);
          biz.accounts.forEach(a=>{
            const opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = a.name;
            sel.appendChild(opt);
          });
        }
      });
    }

    // Add Transaction logic (core change: reset inventory action to None after add)
    btnAddTxn.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user');
      if (!selectedBusinessId) return alert('Select a business');
      const biz = findBiz(selectedBusinessId);
      if (!biz) return alert('Invalid business');

      const date = document.getElementById('txnDate').value || new Date().toISOString().slice(0,10);
      const inventoryAction = txnInventoryAction.value || 'None';

      // Ensure transactions structure
      if (!data.transactions) data.transactions = {};
      if (!data.transactions[selectedUserId]) data.transactions[selectedUserId] = {};
      if (!data.transactions[selectedUserId][selectedBusinessId]) data.transactions[selectedUserId][selectedBusinessId] = [];

      // handle inventory actions
      if (inventoryAction === 'None') {
        // normal transaction
        const accountId = txnAccount.value || '';
        if (!accountId) return alert('Select an account for the transaction.');
        const amount = parseFloat(document.getElementById('txnAmount').value || '0');
        if (isNaN(amount) || amount <= 0) return alert('Enter a valid amount.');
        const desc = (document.getElementById('txnDesc').value || '').trim();
        const whtApplied = !!txnWht.checked;
        const depApplied = !!txnDep.checked;
        const useful = depApplied ? (parseInt(txnUsefulLife.value) || biz.defaultUsefulLifeYears) : null;
        const acct = findAccount(selectedBusinessId, accountId);
        const txn = {
          id: uid('txn'),
          date, accountId, accountName: acct ? acct.name : '',
          description: desc,
          amount,
          vat: (biz.vatEnabled && typeof biz.vatRate === 'number') ? (amount * (biz.vatRate/100)) : 0,
          wht: whtApplied ? (amount * ((biz.whtRate || DEFAULT_BUSINESS_TAX.whtRate)/100)) : 0,
          depreciable: depApplied,
          usefulLifeYears: useful
        };
        data.transactions[selectedUserId][selectedBusinessId].push(txn);
      } else {
        // Inventory operations: Add / Purchase / Sale
        ensureInventoriesForBusiness(selectedBusinessId);
        const items = data.inventories[selectedBusinessId];
        const selectedItemId = invItemSelect.value;
        const qty = parseInt(invQty.value || '0') || 0;
        if (qty <= 0) return alert('Enter a valid quantity for inventory operation.');
        if (inventoryAction === 'Add' || inventoryAction === 'Purchase') {
          let item = null;
          if (selectedItemId && selectedItemId !== '__new__') {
            item = items.find(i => i.id === selectedItemId);
            if (!item) return alert('Selected inventory item not found.');
            // update avg cost if unit cost provided
            const unitCost = parseFloat(invUnitCost.value || '0') || 0;
            if (unitCost > 0) {
              const prevVal = (item.avgCost || item.unitCost || 0) * (item.qty || 0);
              const addVal = unitCost * qty;
              const newQty = (item.qty || 0) + qty;
              item.qty = newQty;
              item.unitCost = unitCost;
              item.avgCost = newQty ? ((prevVal + addVal) / newQty) : unitCost;
            } else {
              item.qty = (item.qty || 0) + qty;
            }
          } else {
            // new item
            const sku = (invNewSku.value || '').trim();
            const name = (invNewName.value || '').trim();
            const unitCost = parseFloat(invUnitCost.value || '0') || 0;
            const newItem = { id: uid('inv'), sku, name, qty: qty, unitCost: unitCost || 0, avgCost: unitCost || 0 };
            items.push(newItem);
          }

          // record a transaction for purchase/add: record value if unit cost provided
          const unitCostVal = parseFloat(invUnitCost.value || '0') || 0;
          const value = unitCostVal * qty;
          if (value > 0) {
            const acct = (biz.accounts && biz.accounts.find(a=>a.name==='Purchases')) ? biz.accounts.find(a=>a.name==='Purchases') : (biz.accounts && biz.accounts[0]);
            const txn = {
              id: uid('txn'),
              date,
              accountId: acct ? acct.id : '',
              accountName: acct ? acct.name : 'Purchases',
              description: `${inventoryAction} inventory (${qty} units)`,
              amount: value,
              vat: (biz.vatEnabled && typeof biz.vatRate === 'number') ? (value * (biz.vatRate/100)) : 0,
              wht: 0,
              inventoryAction,
              inventoryItemId: selectedItemId === '__new__' ? (items[items.length-1] && items[items.length-1].id) : selectedItemId,
              qty
            };
            data.transactions[selectedUserId][selectedBusinessId].push(txn);
          }
        } else if (inventoryAction === 'Sale') {
          // sale: reduce qty and create COGS transaction
          if (!selectedItemId || selectedItemId === '__new__') return alert('Select an existing item to sell.');
          const item = items.find(i => i.id === selectedItemId);
          if (!item) return alert('Selected item not found.');
          // Allow negative stock
          const salePrice = parseFloat(invSalePrice.value || '0') || 0;
          const value = salePrice * qty;
          const cogsValue = (item.avgCost || item.unitCost || 0) * qty;
          item.qty = (item.qty || 0) - qty;
          
          // create sales txn
          const salesAcct = (biz.accounts && biz.accounts.find(a=>a.name==='Sales')) ? biz.accounts.find(a=>a.name==='Sales') : (biz.accounts && biz.accounts[0]);
          const salesTxn = {
            id: uid('txn'),
            date,
            accountId: salesAcct ? salesAcct.id : '',
            accountName: salesAcct ? salesAcct.name : 'Sales',
            description: `Sale of ${item.name || item.sku || ''} (${qty})`,
            amount: value,
            vat: (biz.vatEnabled && typeof biz.vatRate === 'number') ? (value * (biz.vatRate/100)) : 0,
            wht: 0,
            whtApplied: false,
            inventoryAction,
            inventoryItemId: selectedItemId,
            qty
          };
          data.transactions[selectedUserId][selectedBusinessId].push(salesTxn);
          
          // create COGS transaction
          let cogsAcct = biz.accounts.find(a => a.name === 'COGS');
          if (!cogsAcct) {
            // Create COGS account if doesn't exist
            cogsAcct = { id: uid('acct'), name: 'COGS' };
            biz.accounts.push(cogsAcct);
          }
          const cogsTxn = {
            id: uid('txn'),
            date,
            accountId: cogsAcct.id,
            accountName: cogsAcct.name,
            description: `COGS for ${item.name || item.sku || ''} (${qty})`,
            amount: cogsValue,
            vat: 0,
            wht: 0,
            whtApplied: false,
            inventoryAction: 'COGS',
            inventoryItemId: selectedItemId,
            qty
          };
          data.transactions[selectedUserId][selectedBusinessId].push(cogsTxn);
        }
      }

      // Persist and update UI
      saveData();
      renderLedger();
      calculateSummary();
      renderInventory();

      // Reset form fields to defaults
      document.getElementById('txnDesc').value = '';
      document.getElementById('txnAmount').value = '';
      txnWht.checked = false;
      txnDep.checked = false;
      txnUsefulLife.value = '';
      invItemSelect.value = '';
      invNewSku.value = '';
      invNewName.value = '';
      invQty.value = '';
      invUnitCost.value = '';
      invSalePrice.value = '';

      // Reset Inventory action to 'None' and update UI
      document.getElementById('txnInventoryAction').value = 'None';
      document.getElementById('txnInventoryAction').dispatchEvent(new Event('change'));

      // Reset to first page
      currentPage = 1;
    });

    // Ledger rendering and utilities
    function getCurrentTxns(){
      if (!selectedUserId || !selectedBusinessId) return [];
      if (!data.transactions) return [];
      const byUser = data.transactions[selectedUserId] || {};
      return byUser[selectedBusinessId] || [];
    }

    function renderLedger(){
      ledgerTbody.innerHTML = '';
      const all = getCurrentTxns().slice().sort((a,b)=> (a.date < b.date ? 1 : (a.date > b.date ? -1 : 0)));
      const filtered = ledgerFilterText ? all.filter(t => {
        const q = ledgerFilterText.toLowerCase();
        return (t.date && t.date.toLowerCase().includes(q)) ||
               (t.accountName && t.accountName.toLowerCase().includes(q)) ||
               (t.description && t.description.toLowerCase().includes(q)) ||
               (String(t.amount || '').toLowerCase().includes(q));
      }) : all;

      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage-1) * PAGE_SIZE;
      const pageItems = filtered.slice(start, start + PAGE_SIZE);

      pageItems.forEach(txn => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(txn.date || '')}</td>
          <td>${escapeHtml(txn.accountName || '')}</td>
          <td>${escapeHtml(txn.description || '')}${txn.inventoryAction ? '<div class="muted">['+escapeHtml(txn.inventoryAction)+']</div>' : ''}</td>
          <td style="white-space:nowrap;">${formatNumber(txn.amount || 0)}</td>
          <td style="white-space:nowrap;">${formatNumber(txn.vat || 0)}</td>
          <td style="white-space:nowrap;">${formatNumber(txn.wht || 0)}</td>
          <td>${txn.depreciable ? (txn.usefulLifeYears || '') : ''}</td>
          <td>
            <div class="actions">
              <button class="small" data-id="${txn.id}" data-action="edit">Edit</button>
              <button class="small danger" data-id="${txn.id}" data-action="delete">Delete</button>
            </div>
          </td>
        `;
        ledgerTbody.appendChild(tr);
      });

      pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;

      // action handlers
      ledgerTbody.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'delete') {
            if (!confirm('Delete this transaction?')) return;
            deleteTransaction(id);
          } else if (action === 'edit') {
            openEditTransaction(id);
          }
        });
      });
    }

    function deleteTransaction(txnId){
      if (!selectedUserId || !selectedBusinessId) return;
      const arr = data.transactions[selectedUserId][selectedBusinessId] || [];
      const idx = arr.findIndex(t => t.id === txnId);
      if (idx === -1) return;
      arr.splice(idx,1);
      saveData();
      renderLedger();
      calculateSummary();
    }

    function openEditTransaction(txnId){
      if (!selectedUserId || !selectedBusinessId) return;
      const arr = data.transactions[selectedUserId][selectedBusinessId] || [];
      const txn = arr.find(t=>t.id===txnId);
      if (!txn) return alert('Transaction not found.');
      editingTxnRef = { userId: selectedUserId, bizId: selectedBusinessId, txnId: txnId };
      editTxnDate.value = txn.date || '';
      populateAccountSelect();
      if (txn.accountId) editTxnAccount.value = txn.accountId;
      editTxnDesc.value = txn.description || '';
      editTxnAmount.value = txn.amount || '';
      editTxnWht.checked = !!txn.wht;
      editTxnDep.checked = !!txn.depreciable;
      editTxnUseful.value = txn.usefulLifeYears || '';
      editTxnUsefulLabel.style.display = editTxnDep.checked ? '' : 'none';
      openModal(editModal);
    }

    editCancelBtn.addEventListener('click', () => closeModal(editModal));

    editSaveBtn.addEventListener('click', () => {
      if (!editingTxnRef) return;
      const { userId, bizId, txnId } = editingTxnRef;
      const arr = data.transactions[userId][bizId] || [];
      const txn = arr.find(t=>t.id===txnId);
      if (!txn) return alert('Transaction missing');
      txn.date = editTxnDate.value || txn.date;
      txn.accountId = editTxnAccount.value || txn.accountId;
      const acct = findAccount(bizId, txn.accountId);
      txn.accountName = acct ? acct.name : txn.accountName;
      txn.description = (editTxnDesc.value || '').trim();
      txn.amount = parseFloat(editTxnAmount.value || '0') || 0;
      txn.wht = editTxnWht.checked ? (txn.amount * ((findBiz(bizId).whtRate || DEFAULT_BUSINESS_TAX.whtRate)/100)) : 0;
      txn.depreciable = !!editTxnDep.checked;
      txn.usefulLifeYears = txn.depreciable ? (parseInt(editTxnUseful.value) || findBiz(bizId).defaultUsefulLifeYears) : null;
      // recalc vat
      const biz = findBiz(bizId);
      txn.vat = (biz && biz.vatEnabled && typeof biz.vatRate === 'number') ? (txn.amount * (biz.vatRate/100)) : 0;
      saveData();
      closeModal(editModal);
      renderLedger();
      calculateSummary();
    });

    function calculateSummary(){
      const txns = getCurrentTxns();
      const biz = findBiz(selectedBusinessId);
      if (!biz) return;
      
      // Basic totals
      let total = 0, totalVat = 0, totalWht = 0;
      let salesTotal = 0, cogsTotal = 0, expenseTotal = 0, depreciationTotal = 0;
      
      txns.forEach(t=>{
        total += (t.amount || 0);
        totalVat += (t.vat || 0);
        totalWht += (t.wht || 0);
        
        // Categorize transactions
        const acctName = (t.accountName || '').toLowerCase();
        if (acctName.includes('sales')) {
          salesTotal += (t.amount || 0);
        } else if (acctName.includes('cogs') || t.inventoryAction === 'COGS') {
          cogsTotal += (t.amount || 0);
        } else if (acctName.includes('expense')) {
          expenseTotal += (t.amount || 0);
        } else if (acctName.includes('depreciation')) {
          depreciationTotal += (t.amount || 0);
        }
      });
      
      // Add synthetic depreciation from assets
      ensureAssetsForBusiness(selectedBusinessId);
      const assets = data.assets[selectedBusinessId] || [];
      const today = new Date().toISOString().slice(0,10);
      let totalAssetDepreciation = 0;
      
      assets.forEach(asset => {
        if (!asset.disposed) {
          const accDep = computeAccumulatedDepreciation(asset, today);
          totalAssetDepreciation += accDep;
        }
      });
      
      // Compute totals
      const grossProfit = salesTotal - cogsTotal;
      const netIncome = grossProfit - expenseTotal - totalAssetDepreciation;
      
      // Compute capital allowances
      const yearStart = new Date(new Date().getFullYear(), 0, 1).toISOString().slice(0,10);
      let totalCAComputed = 0, totalCAAllowed = 0, totalCACarryforward = 0;
      
      assets.forEach(asset => {
        if (!asset.disposed || new Date(asset.disposalDate) >= new Date(yearStart)) {
          const ca = computeCapitalAllowanceForPeriod(asset, yearStart, today);
          totalCAComputed += ca.allowed + ca.carryforward;
          totalCAAllowed += ca.allowed;
          totalCACarryforward += ca.carryforward;
          asset.caCarryforward = ca.carryforward;
        }
      });
      
      // Add opening CA balance
      const openingCA = biz.openingCapitalAllowanceBalance || 0;
      const totalCAApplied = totalCAAllowed + openingCA;
      
      // Get tax adjustments
      ensureTaxAdjustmentsForBusiness(selectedBusinessId);
      const adjustments = (selectedUserId && data.taxAdjustments[selectedBusinessId]) ? 
                          data.taxAdjustments[selectedBusinessId][selectedUserId] || {} : {};
      
      const pension = adjustments.pension || 0;
      const nhf = adjustments.nhf || 0;
      const mortgageInterest = adjustments.mortgageInterest || 0;
      const lifeInsurance = adjustments.lifeInsurance || 0;
      const rentPaid = adjustments.rentPaid || 0;
      const rentRelief = rentPaid * 0.2; // 20% of rent paid
      
      const totalDeductions = pension + nhf + mortgageInterest + lifeInsurance + rentRelief;
      
      // Compute taxable income
      const taxableIncomeBeforeCA = netIncome - totalDeductions;
      const taxableIncome = Math.max(0, taxableIncomeBeforeCA - totalCAApplied);
      
      // Compute PIT/PAYE
      const pit = biz.pitEnabled ? computePIT(taxableIncome, biz) : 0;
      
      // Compute CIT based on turnover (sales)
      let citRate = 0;
      if (salesTotal < 50000000) {
        citRate = 0; // 0% for turnover < 50 million
      } else {
        citRate = 25; // 25% for turnover >= 50 million (note: original spec said 25%, not 30%)
      }
      const taxableProfit = Math.max(0, taxableIncomeBeforeCA - totalCAApplied);
      const cit = (taxableProfit * citRate) / 100;
      
      // Display summaries
      vatSummaryDiv.innerHTML = `
        <strong>VAT Summary</strong><br/>
        Total VAT: ${formatNumber(totalVat)}
      `;
      
      totalsSummaryDiv.innerHTML = `
        <strong>Income Statement Summary</strong><br/>
        Sales Revenue: ${formatNumber(salesTotal)}<br/>
        COGS: ${formatNumber(cogsTotal)}<br/>
        <strong>Gross Profit: ${formatNumber(grossProfit)}</strong><br/>
        Operating Expenses: ${formatNumber(expenseTotal)}<br/>
        Depreciation (Assets): ${formatNumber(totalAssetDepreciation)}<br/>
        <strong>Net Income (Accounting): ${formatNumber(netIncome)}</strong>
      `;
      
      taxSummaryDiv.innerHTML = `
        <strong>Tax Summary</strong><br/>
        Total WHT: ${formatNumber(totalWht)}<br/>
        <br/>
        <strong>Capital Allowances (Tax)</strong><br/>
        Computed CA (Annual): ${formatNumber(totalCAComputed)}<br/>
        Allowed CA (2/3): ${formatNumber(totalCAAllowed)}<br/>
        Opening CA Balance: ${formatNumber(openingCA)}<br/>
        Total CA Applied: ${formatNumber(totalCAApplied)}<br/>
        CA Carryforward (1/3): ${formatNumber(totalCACarryforward)}<br/>
        <br/>
        <strong>Tax Adjustments (Deductions)</strong><br/>
        Pension: ${formatNumber(pension)}<br/>
        NHF: ${formatNumber(nhf)}<br/>
        Mortgage Interest: ${formatNumber(mortgageInterest)}<br/>
        Life Insurance: ${formatNumber(lifeInsurance)}<br/>
        Rent Paid: ${formatNumber(rentPaid)} → Relief: ${formatNumber(rentRelief)}<br/>
        Total Deductions: ${formatNumber(totalDeductions)}<br/>
        <br/>
        <strong>Taxable Income Calculation</strong><br/>
        Net Income: ${formatNumber(netIncome)}<br/>
        Less: Deductions: ${formatNumber(totalDeductions)}<br/>
        Less: Capital Allowance: ${formatNumber(totalCAApplied)}<br/>
        <strong>Taxable Income: ${formatNumber(taxableIncome)}</strong><br/>
        <br/>
        <strong>PIT/PAYE</strong> (if enabled): ${formatNumber(pit)}<br/>
        <br/>
        <strong>CIT (Company Income Tax)</strong><br/>
        Turnover (Sales): ${formatNumber(salesTotal)}<br/>
        CIT Rate: ${citRate}% ${salesTotal < 50000000 ? '(< ₦50M threshold)' : '(≥ ₦50M)'}<br/>
        <strong>CIT Amount: ${formatNumber(cit)}</strong>
      `;
    }

    // Inventory rendering & modal
    function renderInventory(){
      inventoryTableBody.innerHTML = '';
      if (!selectedBusinessId) return;
      ensureInventoriesForBusiness(selectedBusinessId);
      const items = data.inventories[selectedBusinessId] || [];
      items.forEach(it=>{
        const tr = document.createElement('tr');
        const value = (it.avgCost || it.unitCost || 0) * (it.qty || 0);
        tr.innerHTML = `
          <td>${escapeHtml(it.sku || '')}</td>
          <td>${escapeHtml(it.name || '')}</td>
          <td>${it.qty || 0}</td>
          <td>${formatNumber(it.avgCost || it.unitCost || 0)}</td>
          <td>${formatNumber(value)}</td>
          <td>
            <div class="actions">
              <button class="small" data-id="${it.id}" data-action="edit">Edit</button>
              <button class="small danger" data-id="${it.id}" data-action="delete">Delete</button>
            </div>
          </td>
        `;
        inventoryTableBody.appendChild(tr);
      });

      inventoryTableBody.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          if (action === 'edit') {
            openInventoryModal(id);
          } else if (action === 'delete') {
            if (!confirm('Delete inventory item?')) return;
            deleteInventoryItem(id);
          }
        });
      });
    }

    function openInventoryModal(itemId){
      inventoryEditingId = itemId || null;
      if (inventoryEditingId) {
        const it = (data.inventories[selectedBusinessId] || []).find(i=>i.id===inventoryEditingId);
        if (!it) return alert('Inventory item not found');
        invModalSku.value = it.sku || '';
        invModalName.value = it.name || '';
        invModalQty.value = it.qty || 0;
        invModalUnitCost.value = it.unitCost || 0;
      } else {
        invModalSku.value = '';
        invModalName.value = '';
        invModalQty.value = '';
        invModalUnitCost.value = '';
      }
      openModal(inventoryModal);
    }

    invModalCancel.addEventListener('click', () => closeModal(inventoryModal));
    invModalSave.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('No business selected');
      ensureInventoriesForBusiness(selectedBusinessId);
      const items = data.inventories[selectedBusinessId];
      const sku = (invModalSku.value || '').trim();
      const name = (invModalName.value || '').trim();
      const qty = parseInt(invModalQty.value || '0') || 0;
      const unitCost = parseFloat(invModalUnitCost.value || '0') || 0;
      if (inventoryEditingId) {
        const it = items.find(i=>i.id===inventoryEditingId);
        if (!it) return alert('Item not found');
        it.sku = sku;
        it.name = name;
        it.qty = qty;
        it.unitCost = unitCost;
        it.avgCost = unitCost || it.avgCost || 0;
      } else {
        items.push({ id: uid('inv'), sku, name, qty, unitCost, avgCost: unitCost || 0 });
      }
      saveData();
      closeModal(inventoryModal);
      renderInventory();
    });

    btnOpenInventoryModal.addEventListener('click', () => {
      inventoryEditingId = null;
      openInventoryModal(null);
    });

    function deleteInventoryItem(id){
      if (!selectedBusinessId) return;
      const items = data.inventories[selectedBusinessId] || [];
      const idx = items.findIndex(i=>i.id===id);
      if (idx === -1) return;
      items.splice(idx,1);
      saveData();
      renderInventory();
    }

    // Assets management functions
    function renderAssets(){
      assetsTableBody.innerHTML = '';
      if (!selectedBusinessId) return;
      ensureAssetsForBusiness(selectedBusinessId);
      const assets = data.assets[selectedBusinessId] || [];
      const today = new Date().toISOString().slice(0,10);
      
      assets.forEach(asset => {
        const tr = document.createElement('tr');
        const accDep = computeAccumulatedDepreciation(asset, today);
        asset.accumulatedDepreciation = accDep;
        const bookValue = Math.max(0, asset.cost - accDep);
        
        // Compute capital allowance for current year
        const yearStart = new Date(new Date().getFullYear(), 0, 1).toISOString().slice(0,10);
        const ca = computeCapitalAllowanceForPeriod(asset, yearStart, today);
        
        const status = asset.disposed ? `<span class="flag" style="background:#fee;">Disposed</span>` : 
                                       `<span class="flag" style="background:#efe;">Active</span>`;
        
        tr.innerHTML = `
          <td>${escapeHtml(asset.name || '')}</td>
          <td>${formatNumber(asset.cost || 0)}</td>
          <td>${escapeHtml(asset.purchaseDate || '')}</td>
          <td>${asset.usefulLifeYears || 0} years</td>
          <td>${formatNumber(accDep)}</td>
          <td>${formatNumber(bookValue)}</td>
          <td>${formatNumber(ca.allowed)}</td>
          <td>${formatNumber(asset.caCarryforward || 0)}</td>
          <td>${status}</td>
        `;
        assetsTableBody.appendChild(tr);
      });
      
      saveData(); // Save updated depreciation
    }
    
    btnPurchaseAsset.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business');
      const biz = findBiz(selectedBusinessId);
      assetName.value = '';
      assetCost.value = '';
      assetPurchaseDate.value = new Date().toISOString().slice(0,10);
      assetUsefulLife.value = biz ? biz.defaultUsefulLifeYears : DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      assetOpeningCA.value = 0;
      openModal(purchaseAssetModal);
    });
    
    assetCancelBtn.addEventListener('click', () => closeModal(purchaseAssetModal));
    
    assetSaveBtn.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('No business selected');
      const biz = findBiz(selectedBusinessId);
      if (!biz) return alert('Business not found');
      
      const name = (assetName.value || '').trim();
      const cost = parseFloat(assetCost.value) || 0;
      const purchaseDate = assetPurchaseDate.value || new Date().toISOString().slice(0,10);
      const usefulLife = parseInt(assetUsefulLife.value) || biz.defaultUsefulLifeYears;
      const openingCA = parseFloat(assetOpeningCA.value) || 0;
      
      if (!name) return alert('Asset name required');
      if (cost <= 0) return alert('Asset cost must be greater than 0');
      
      ensureAssetsForBusiness(selectedBusinessId);
      const asset = {
        id: uid('asset'),
        bizId: selectedBusinessId,
        name,
        cost,
        purchaseDate,
        usefulLifeYears: usefulLife,
        accumulatedDepreciation: 0,
        disposed: false,
        disposalDate: null,
        disposalProceeds: 0,
        openingCapitalAllowance: openingCA,
        accumulatedCapitalAllowance: 0,
        caCarryforward: 0
      };
      
      data.assets[selectedBusinessId].push(asset);
      saveData();
      closeModal(purchaseAssetModal);
      renderAssets();
      calculateSummary();
    });
    
    btnDisposeAsset.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business');
      ensureAssetsForBusiness(selectedBusinessId);
      const assets = data.assets[selectedBusinessId] || [];
      const activeAssets = assets.filter(a => !a.disposed);
      
      if (activeAssets.length === 0) return alert('No active assets to dispose');
      
      disposeAssetSelect.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '-- Select asset --';
      disposeAssetSelect.appendChild(opt);
      
      activeAssets.forEach(a => {
        const o = document.createElement('option');
        o.value = a.id;
        o.textContent = `${a.name} (${formatNumber(a.cost)})`;
        disposeAssetSelect.appendChild(o);
      });
      
      assetDisposalDate.value = new Date().toISOString().slice(0,10);
      assetDisposalProceeds.value = 0;
      openModal(disposeAssetModal);
    });
    
    disposeAssetCancelBtn.addEventListener('click', () => closeModal(disposeAssetModal));
    
    disposeAssetSaveBtn.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('No business selected');
      const assetId = disposeAssetSelect.value;
      if (!assetId) return alert('Select an asset to dispose');
      
      ensureAssetsForBusiness(selectedBusinessId);
      const assets = data.assets[selectedBusinessId] || [];
      const asset = assets.find(a => a.id === assetId);
      if (!asset) return alert('Asset not found');
      
      const disposalDate = assetDisposalDate.value || new Date().toISOString().slice(0,10);
      const disposalProceeds = parseFloat(assetDisposalProceeds.value) || 0;
      
      // Compute accumulated depreciation up to disposal date
      const accDep = computeAccumulatedDepreciation(asset, disposalDate);
      asset.accumulatedDepreciation = accDep;
      const bookValue = asset.cost - accDep;
      const gainLoss = disposalProceeds - bookValue;
      
      // Mark asset as disposed
      asset.disposed = true;
      asset.disposalDate = disposalDate;
      asset.disposalProceeds = disposalProceeds;
      
      // Create gain/loss transaction
      const biz = findBiz(selectedBusinessId);
      if (biz && selectedUserId) {
        let gainLossAcct = biz.accounts.find(a => a.name === 'Asset Disposal Gain/Loss');
        if (!gainLossAcct) {
          gainLossAcct = { id: uid('acct'), name: 'Asset Disposal Gain/Loss' };
          biz.accounts.push(gainLossAcct);
        }
        
        if (!data.transactions[selectedUserId]) data.transactions[selectedUserId] = {};
        if (!data.transactions[selectedUserId][selectedBusinessId]) data.transactions[selectedUserId][selectedBusinessId] = [];
        
        const txn = {
          id: uid('txn'),
          date: disposalDate,
          accountId: gainLossAcct.id,
          accountName: gainLossAcct.name,
          description: `Disposal of ${asset.name} - ${gainLoss >= 0 ? 'Gain' : 'Loss'}: ₦${formatNumber(Math.abs(gainLoss))}`,
          amount: Math.abs(gainLoss),
          vat: 0,
          wht: 0,
          whtApplied: false,
          assetDisposal: true,
          assetId: asset.id
        };
        data.transactions[selectedUserId][selectedBusinessId].push(txn);
      }
      
      saveData();
      closeModal(disposeAssetModal);
      renderAssets();
      renderLedger();
      calculateSummary();
    });
    
    btnTaxAdjustments.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business');
      if (!selectedUserId) return alert('Select a user');
      
      ensureTaxAdjustmentsForBusiness(selectedBusinessId);
      const adjustments = data.taxAdjustments[selectedBusinessId][selectedUserId] || {};
      
      taxPension.value = adjustments.pension || 0;
      taxNHF.value = adjustments.nhf || 0;
      taxMortgage.value = adjustments.mortgageInterest || 0;
      taxLifeInsurance.value = adjustments.lifeInsurance || 0;
      taxRentPaid.value = adjustments.rentPaid || 0;
      
      openModal(taxAdjustmentsModal);
    });
    
    taxAdjustmentsCancelBtn.addEventListener('click', () => closeModal(taxAdjustmentsModal));
    
    taxAdjustmentsSaveBtn.addEventListener('click', () => {
      if (!selectedBusinessId || !selectedUserId) return alert('Select business and user');
      
      ensureTaxAdjustmentsForBusiness(selectedBusinessId);
      
      data.taxAdjustments[selectedBusinessId][selectedUserId] = {
        pension: parseFloat(taxPension.value) || 0,
        nhf: parseFloat(taxNHF.value) || 0,
        mortgageInterest: parseFloat(taxMortgage.value) || 0,
        lifeInsurance: parseFloat(taxLifeInsurance.value) || 0,
        rentPaid: parseFloat(taxRentPaid.value) || 0,
        lastUpdated: new Date().toISOString()
      };
      
      saveData();
      closeModal(taxAdjustmentsModal);
      calculateSummary();
    });

    // Accounts modal
    btnManageAccounts.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business');
      renderAccountsList();
      openModal(accountsModal);
    });

    function renderAccountsList(){
      accountsList.innerHTML = '';
      const biz = findBiz(selectedBusinessId);
      if (!biz) { accountsList.textContent = '-- no business --'; return; }
      ensureBizDefaults(biz);
      biz.accounts.forEach(a=>{
        const div = document.createElement('div');
        div.className = 'account-row';
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.value = a.name;
        inp.style.flex = '1';
        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Rename';
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'danger';
        div.appendChild(inp);
        div.appendChild(renameBtn);
        div.appendChild(deleteBtn);
        accountsList.appendChild(div);

        renameBtn.addEventListener('click', ()=>{
          const newName = (inp.value || '').trim();
          if (!newName) return alert('Name required');
          a.name = newName;
          saveData();
          populateAccountSelect();
          renderLedger();
          renderAccountsList();
        });

        deleteBtn.addEventListener('click', ()=>{
          // prevent delete if account in use
          const txnsAll = [];
          for (const uidKey of Object.keys(data.transactions || {})){
            for (const bid of Object.keys(data.transactions[uidKey] || {})){
              const arr = data.transactions[uidKey][bid] || [];
              arr.forEach(t => txnsAll.push(t));
            }
          }
          const used = txnsAll.some(t => t.accountId === a.id);
          if (used) return alert('Cannot delete account with transactions. Rename it instead.');
          biz.accounts = biz.accounts.filter(x => x.id !== a.id);
          saveData();
          populateAccountSelect();
          renderAccountsList();
        });
      });
    }

    addAccountBtn.addEventListener('click', () => {
      const name = (newAccountName.value || '').trim();
      if (!name) return alert('Provide account name');
      const biz = findBiz(selectedBusinessId);
      if (!biz) return;
      ensureBizDefaults(biz);
      biz.accounts.push({ id: uid('acct'), name });
      newAccountName.value = '';
      saveData();
      populateAccountSelect();
      renderAccountsList();
    });

    closeAccountsBtn.addEventListener('click', () => closeModal(accountsModal));

    // Search & pagination
    btnSearch.addEventListener('click', () => {
      ledgerFilterText = (ledgerSearch.value || '').trim();
      currentPage = 1;
      renderLedger();
    });

    btnClearSearch.addEventListener('click', () => {
      ledgerFilterText = '';
      ledgerSearch.value = '';
      currentPage = 1;
      renderLedger();
    });

    btnPrevPage.addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; renderLedger(); }
    });
    btnNextPage.addEventListener('click', () => {
      currentPage++;
      renderLedger();
    });

    // Export/Import/Clear
    btnExport.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ntc_export.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const parsed = JSON.parse(ev.target.result);
          if (!confirm('Importing will overwrite current data. Continue?')) return;
          data = parsed;
          data.users = data.users || [];
          data.businesses = data.businesses || [];
          data.transactions = data.transactions || {};
          data.inventories = data.inventories || {};
          data.assets = data.assets || {};
          data.taxAdjustments = data.taxAdjustments || {};
          data.businesses.forEach(b => { 
            ensureBizDefaults(b); 
            ensureInventoriesForBusiness(b.id);
            ensureAssetsForBusiness(b.id);
            ensureTaxAdjustmentsForBusiness(b.id);
          });
          saveData();
          refreshUserBusinessSelectors();
          ensureSelection();
          populateInvItemSelect();
          populateAccountSelect();
          renderLedger();
          calculateSummary();
          renderInventory();
          renderAssets();
        } catch (err) {
          alert('Invalid JSON file');
        }
      };
      reader.readAsText(f);
      fileInput.value = '';
    });

    btnClearAll.addEventListener('click', () => {
      if (!confirm('Clear all data? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      data = { users: [], businesses: [], transactions: {}, inventories: {}, assets: {}, taxAdjustments: {} };
      loadData();
      refreshUserBusinessSelectors();
      ensureSelection();
      populateInvItemSelect();
      populateAccountSelect();
      renderLedger();
      calculateSummary();
      renderInventory();
      renderAssets();
    });

    // Initial population
    populateInvItemSelect();
    populateAccountSelect();
    renderLedger();
    calculateSummary();
    renderInventory();
  </script>
</body>
</html>
