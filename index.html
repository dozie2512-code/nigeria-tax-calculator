Below is a corrected, single-file index.html that fixes the runtime/JS issues you reported (DOM element lookups, initialization order, missing handlers, variable mismatches, and a few logical cleanups). I preserved the functional changes you asked for earlier (Individuals, Enterprise rename, Opening Asset Bal, VAT/WHT formulas, turnover threshold setting, default accounts, asset purchase/disposal basics, basic PIT/CIT calculation shells, undo stacks) while removing the runtime errors so the app runs in the browser.

Save this as index.html and open in a browser. If you want, I can next create a PR in your repo (you previously asked for a single PR).

Note: this is a single-file SPA; for readability I kept code comments and left some complex tax/asset logic intentionally simplified but correctable incrementally.

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Accounting & Tax Engine — Prototype (Corrected)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,96vw); max-height:84vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax Engine — Prototype (Corrected)</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
      </div>
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
            <option value="AssetPurchase">Asset Purchase</option>
            <option value="OpeningAssetBal">Opening Asset Bal</option>
            <option value="AssetDisposal">Asset Disposal</option>
            <option value="BankPayment">Bank Payment</option>
            <option value="BankReceipt">Bank Receipt</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label>Opening Qty: <input type="number" id="invOpeningQty" min="0" step="1" /></label>
          <label>Opening Avg Cost (₦): <input type="number" id="invOpeningAvgCost" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small primary">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetPurchaseSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Asset Purchase / Opening Balance</h3>
        <div class="form-inline">
          <label>Existing Asset:
            <select id="assetExistingSelect"><option value="">-- new / select existing --</option></select>
          </label>
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Category:
            <select id="assetCategory">
              <option value="Property Plant and Equipment">Property Plant and Equipment</option>
              <option value="Furniture & Fittings">Furniture & Fittings</option>
              <option value="Motor Vehicles">Motor Vehicles</option>
              <option value="Land & Building">Land & Building</option>
              <option value="Other Asset">Other Asset</option>
            </select>
          </label>
          <label>Qty: <input type="number" id="assetQty" min="1" step="1" class="smallInput" value="1" /></label>
          <label>Unit Price (₦): <input type="number" id="assetUnitPrice" min="0" step="0.01" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Opening Cost (₦): <input type="number" id="assetOpeningCost" min="0" step="0.01" /></label>
          <label>Opening Accumulated Depreciation (₦): <input type="number" id="assetOpeningAccDep" min="0" step="0.01" /></label>
          <label id="assetPurchaseDateLabel">Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Starting bal date: <input type="date" id="assetStartingBalDate" style="display:none;" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>

          <label>Classification:
            <select id="assetClassification">
              <option value="Fixed">Fixed</option>
              <option value="Chargeable">Chargeable</option>
            </select>
          </label>

          <label>Depreciation rate % (annual): <input type="number" id="assetDepRate" class="smallInput" min="0" step="0.01" /></label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small primary">Record Asset Purchase</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Depreciation & capital allowance computed daily (prorated); asset schedule shows quantity and unit price.</small>
      </div>

      <div id="assetDisposalSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Asset Disposal</h3>
        <div class="form-inline">
          <label>Asset to dispose:
            <select id="assetDisposeSelect"></select>
          </label>
          <label>Qty to dispose: <input type="number" id="assetDisposeQty" min="1" step="1" class="smallInput" value="1" /></label>
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds (₦): <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>
          <label>Contact: <input type="text" id="assetDisposalContact" placeholder="Contact name" /></label>
          <label>Receipt: <input type="file" id="assetDisposalReceipt" /></label>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnDisposeCancel" class="small">Cancel</button>
          <button id="btnDisposeUndo" class="small danger">Undo last asset disposal</button>
        </div>
        <small class="note">Chargeable gains and losses will be classified based on asset classification and included in tax calculations according to entity rules.</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable/Receivable</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Assets Report</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
        <button id="btnExportXlsx" class="small">Export XLSX (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <!-- User modal -->
  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <!-- Business modal -->
  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="Enterprise">Enterprise</option>
          <option value="Individual">Individual</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate % (default): <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (sole trader/individual), that will override these values for PIT.</small>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Turnover threshold (CIT)</h4>
        <div class="row">
          <label>Turnover threshold:
            <select id="bizTurnoverThreshold">
              <option value="100000000">₦100,000,000</option>
              <option value="50000000">₦50,000,000</option>
              <option value="0">₦0</option>
            </select>
          </label>
          <small class="note">Used to determine CIT treatment (0, 50,000,000 or 100,000,000).</small>
        </div>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add a contact with type "SoleTrader" (or name "Sole trader") and set statutory deductions there if you want PIT to use per-sole-trader deductions.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <!-- Accounts modal -->
  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="max-height:360px; overflow:auto;"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Income">Income</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountDisallowable" /> Disallowable</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountNonTax" /> Non-taxable</label>
      <select id="newAccountRentFreq">
        <option value="">Rent freq</option>
        <option value="monthly">Monthly rent</option>
        <option value="yearly">Yearly rent</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">Prototype stores data in localStorage (ntc_full_accounting_v2)</footer>

  <script>
  /************************************************************************
   * Corrected single-file index.html
   * - Fixed runtime issues: element lookups, initialization order, missing handlers
   * - Preserved requested features (Individuals, Enterprise, Opening Asset Bal, VAT/WHT formulas,
   *   turnover threshold, default accounts, basic asset purchase/disposal, undo stacks)
   ************************************************************************/

  const STORAGE_KEY = 'ntc_full_accounting_v2';
  const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true };
  const PAYE_BANDS = [
    { upTo: 800000, rate: 0.00 },
    { upTo: 3000000, rate: 0.15 },
    { upTo: 12000000, rate: 0.18 },
    { upTo: 25000000, rate: 0.21 },
    { upTo: 50000000, rate: 0.23 },
    { upTo: Infinity, rate: 0.25 }
  ];

  // App state
  let state = { users:[], businesses:[], transactions:{}, attachments:{}, audit:[], auth:{ currentUserId: null } };
  let inventoryHistory = [];
  let assetHistory = [];

  // DOM refs
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const txnReceipt = document.getElementById('txnReceipt');
  const btnAddTxn = document.getElementById('btnAddTxn');
  const mainTxnForm = document.getElementById('mainTxnForm');

  const inventorySubform = document.getElementById('inventorySubform');
  const invItemSelect = document.getElementById('invItemSelect');
  const invNewName = document.getElementById('invNewName');
  const invAccountSelect = document.getElementById('invAccountSelect');
  const invQty = document.getElementById('invQty');
  const invUnitPrice = document.getElementById('invUnitPrice');
  const invOpeningQty = document.getElementById('invOpeningQty');
  const invOpeningAvgCost = document.getElementById('invOpeningAvgCost');
  const invVatType = document.getElementById('invVatType');
  const invContact = document.getElementById('invContact');
  const invReceipt = document.getElementById('invReceipt');
  const btnAddInv = document.getElementById('btnAddInv');
  const btnInvCancel = document.getElementById('btnInvCancel');
  const btnInvUndo = document.getElementById('btnInvUndo');

  const assetPurchaseSubform = document.getElementById('assetPurchaseSubform');
  const assetDisposalSubform = document.getElementById('assetDisposalSubform');
  const assetExistingSelect = document.getElementById('assetExistingSelect');
  const assetName = document.getElementById('assetName');
  const assetQty = document.getElementById('assetQty');
  const assetUnitPrice = document.getElementById('assetUnitPrice');
  const assetCost = document.getElementById('assetCost');
  const assetOpeningCost = document.getElementById('assetOpeningCost');
  const assetOpeningAccDep = document.getElementById('assetOpeningAccDep');
  const assetPurchaseDate = document.getElementById('assetPurchaseDate');
  const assetStartingBalDate = document.getElementById('assetStartingBalDate');
  const assetLife = document.getElementById('assetLife');
  const assetCA = document.getElementById('assetCA');
  const assetDisposalDate = document.getElementById('assetDisposalDate');
  const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
  const btnAddAsset = document.getElementById('btnAddAsset');
  const btnAssetCancel = document.getElementById('btnAssetCancel');
  const btnAssetUndo = document.getElementById('btnAssetUndo');
  const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
  const assetDisposalAccount = document.getElementById('assetDisposalAccount');
  const assetClassification = document.getElementById('assetClassification');
  const assetDepRate = document.getElementById('assetDepRate');
  const assetContact = document.getElementById('assetContact');
  const assetReceipt = document.getElementById('assetReceipt');
  const assetDisposeSelect = document.getElementById('assetDisposeSelect');
  const assetDisposalContact = document.getElementById('assetDisposalContact');
  const assetDisposalReceipt = document.getElementById('assetDisposalReceipt');
  const assetCategory = document.getElementById('assetCategory');
  const assetDisposeQty = document.getElementById('assetDisposeQty');

  const btnDisposeAsset = document.getElementById('btnDisposeAsset');
  const btnDisposeCancel = document.getElementById('btnDisposeCancel');
  const btnDisposeUndo = document.getElementById('btnDisposeUndo');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const ledgerSection = document.getElementById('ledgerSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');
  const quickPanels = document.getElementById('quickPanels');

  const modalOverlay = document.getElementById('modalOverlay');
  const userModal = document.getElementById('userModal');
  const userModalTitle = document.getElementById('userModalTitle');
  const userName = document.getElementById('userName');
  const userDisplay = document.getElementById('userDisplay');
  const userRole = document.getElementById('userRole');
  const permView = document.getElementById('permView');
  const permEdit = document.getElementById('permEdit');
  const permDelete = document.getElementById('permDelete');
  const userSave = document.getElementById('userSave');
  const userCancel = document.getElementById('userCancel');

  const businessModal = document.getElementById('businessModal');
  const businessModalTitle = document.getElementById('businessModalTitle');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
  const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');
  const bizTurnoverThreshold = document.getElementById('bizTurnoverThreshold');

  const accountsModal = document.getElementById('accountsModal');
  const accountsList = document.getElementById('accountsList');
  const newAccountName = document.getElementById('newAccountName');
  const newAccountCategory = document.getElementById('newAccountCategory');
  const newAccountDisallowable = document.getElementById('newAccountDisallowable');
  const newAccountNonTax = document.getElementById('newAccountNonTax');
  const newAccountRentFreq = document.getElementById('newAccountRentFreq');
  const addAccountBtn = document.getElementById('addAccountBtn');
  const closeAccountsBtn = document.getElementById('closeAccountsBtn');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnReportsTab = document.getElementById('btnReportsTab');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return (n==null || isNaN(Number(n))) ? '₦0.00' : '₦' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function rawFmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }
  function round2(n){ return Math.round((Number(n)||0) * 100) / 100; }

  // load/save
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }

  function ensureDefaultAccounts(b){
    const names = [
      { name: 'Salary', category:'Revenue' },
      { name: 'Benefit in kind', category:'Revenue' },
      { name: 'Dividend', category:'Revenue' },
      { name: 'Interest', category:'Revenue' },
      { name: 'Royalty', category:'Revenue' },
      { name: 'Share of profit', category:'Revenue' },
      { name: 'Rent', category:'Revenue' },
      { name: 'Shares', category:'Asset' },
      { name: 'Options', category:'Asset' },
      { name: 'Rights', category:'Asset' },
      { name: 'Debt', category:'Liability' },
      { name: 'Digital/Virtual Asset', category:'Asset' },
      { name: 'Bank', category:'Asset' },
      { name: 'Sales', category:'Revenue' },
      { name: 'COGS', category:'Expense' },
      { name: 'Salaries', category:'Expense' }
    ];
    b.accounts = b.accounts || [];
    for(const n of names){
      if(!b.accounts.find(a=>a.name === n.name)){
        b.accounts.push({ id: uid('acct'), name: n.name, category: n.category, disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 });
      } else {
        const a = b.accounts.find(x=>x.name === n.name);
        a.startingBalance = Number(a.startingBalance || 0);
        a.closingBalance = Number(a.closingBalance || 0);
      }
    }
  }

  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || state.auth || { currentUserId: null };

    for(const b of state.businesses){
      if(b.entity === 'SoleProprietor') b.entity = 'Enterprise';
      if(typeof b.turnoverThreshold === 'undefined') b.turnoverThreshold = 100000000;
      if(!Array.isArray(b.accounts)) b.accounts = [];
      ensureDefaultAccounts(b);
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
    }

    for(const u of state.users){
      state.transactions[u.id] = state.transactions[u.id] || {};
      for(const b of state.businesses){
        state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || [];
      }
    }

    saveState();
  }

  function seedDemo(){
    const u = uid('user'), b = uid('biz');
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 };

    state = {
      users: [{ id: u, username: 'admin', display:'Admin User', role:'Admin', isAdmin:true, permissions:{ view:true, edit:true, delete:true } }],
      businesses: [{
        id: b,
        name: 'Demo Business',
        ownerId: u,
        entity: 'Company',
        vatRate: DEFAULTS.vatRate,
        whtRate: DEFAULTS.whtRate,
        citRate: DEFAULTS.citRate,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        turnoverThreshold: 100000000,
        accounts: [sales, cogs, salaries, bank],
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [],
        contacts: [],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward: 0,
        caCarryForward: 0,
        defaultExpenseDisallowable:false,
        defaultRevenueNonTax:false
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: u }
    };
    state.transactions[u] = {};
    state.transactions[u][b] = [
      { id: uid('txn'), date: today(), action: 'Income', accountId: sales.id, accountName: sales.name, accountCategory: sales.category, description: 'Demo sale', amount: 150000, vatType:'exclusive', vatAmount: (150000*0.075), wht: false, contact:'', receiptId:null },
      { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, accountCategory: salaries.category, description: 'Demo salary', amount: 50000, vatType:'none', vatAmount:0, wht: false, contact:'', receiptId:null }
    ];
    addAudit('seed','system','',`Seeded demo data`);
    saveState();
  }

  function addAudit(type, entityType, entityId, details){
    const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details };
    state.audit = state.audit || [];
    state.audit.push(entry);
    saveState();
  }

  // Modals
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
  modalOverlay.addEventListener('click', ()=> { [userModal, businessModal, accountsModal].forEach(m => { if(m && m.style.display==='block') closeModal(m); }); });

  // selection state (initialize before UI uses them)
  loadState();
  let selectedUserId = state.auth.currentUserId || (state.users[0] && state.users[0].id) || null;
  let selectedBizId = state.businesses[0] && state.businesses[0].id || null;
  let activeTab = 'ledger';

  // UI init
  function initUI(){
    btnAddUser.addEventListener('click', ()=> openUserModal());
    btnEditUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); openUserModal(selectedUserId); });
    btnDeleteUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); if(!confirm('Delete user? This cannot be undone')) return; deleteUser(selectedUserId); });
    userSave.addEventListener('click', saveUser);
    userCancel.addEventListener('click', ()=> closeModal(userModal));

    btnAddBusiness.addEventListener('click', openAddBusinessModal);
    btnEditBusiness.addEventListener('click', openEditBusinessModal);
    btnDeleteBusiness.addEventListener('click', ()=> { if(!selectedBizId) return alert('Select business'); if(!confirm('Delete business and all its transactions/attachments?')) return; deleteBusiness(selectedBizId); });
    bizSave.addEventListener('click', saveBusiness);
    bizCancel.addEventListener('click', ()=> closeModal(businessModal));
    btnAddContact.addEventListener('click', addContactToBiz);

    btnManageAccounts.addEventListener('click', ()=> { if(!selectedBizId) return alert('Select business'); renderAccounts(); openModal(accountsModal); });
    addAccountBtn.addEventListener('click', addAccount);
    closeAccountsBtn.addEventListener('click', ()=> closeModal(accountsModal));

    txnAction.addEventListener('change', txnActionChanged);
    txnWht.addEventListener('change', ()=> {
      const show = txnWht.checked;
      txnWhtRateLabel.style.display = show ? 'inline-flex' : 'none';
      txnWhtBasisLabel.style.display = show ? 'inline-flex' : 'none';
      if(show && !txnWhtRate.value){ txnWhtRate.value = findBiz(selectedBizId)?.whtRate || DEFAULTS.whtRate; }
    });
    btnAddTxn.addEventListener('click', handleAddTransaction);

    btnAddInv.addEventListener('click', handleInventoryAction);
    btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnInvUndo.addEventListener('click', handleUndoInventory);

    btnAddAsset.addEventListener('click', handleAddAsset);
    btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetPurchaseSubform.style.display='none'; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnAssetUndo.addEventListener('click', handleUndoAsset);

    btnDisposeAsset.addEventListener('click', handleDisposeAsset);
    btnDisposeCancel.addEventListener('click', ()=>{ txnAction.value=''; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnDisposeUndo.addEventListener('click', handleUndoLastDisposal);

    document.getElementById('btnSearch').addEventListener('click', renderLedger);
    document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

    document.getElementById('btnExport').addEventListener('click', exportJSON);
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', importJSON);
    document.getElementById('btnClearAll').addEventListener('click', clearAllData);

    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; renderTab(); });
    btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; renderTab(); });

    document.querySelectorAll('#reportsSection .tab').forEach(tb => {
      tb.addEventListener('click', (e) => {
        document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
        tb.classList.add('active');
        renderReport(tb.dataset.report);
      });
    });

    document.getElementById('btnExportCsv').addEventListener('click', ()=> exportCurrentReport('csv'));
    document.getElementById('btnExportPdf').addEventListener('click', ()=> exportCurrentReport('pdf'));
    document.getElementById('btnExportXlsx').addEventListener('click', ()=> exportCurrentReport('xlsx'));

    // dynamic behaviors
    assetQty.addEventListener('input', autoComputeAssetCost);
    assetUnitPrice.addEventListener('input', autoComputeAssetCost);
    assetExistingSelect.addEventListener('change', onExistingAssetSelect);
    txnDate.value = today();
  }

  // helpers & finders
  function findUser(id){ return state.users.find(u=>u.id===id); }
  function findBiz(id){ return state.businesses.find(b=>b.id===id); }
  function findAccount(biz, acctId){ return (biz.accounts||[]).find(a=>a.id===acctId); }

  function refreshSelectors(){
    // users
    userSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; if(u.id === selectedUserId) opt.selected = true; userSelect.appendChild(opt); }
    userSelect.onchange = ()=>{ selectedUserId = userSelect.value; state.auth.currentUserId = selectedUserId; ensureSelection(); populateAccountSelect(); renderAll(); saveState(); };

    // biz owner options
    bizOwnerSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; bizOwnerSelect.appendChild(opt); }

    // businesses
    businessSelect.innerHTML = '';
    for(const b of state.businesses){ const opt = document.createElement('option'); opt.value = b.id; opt.textContent = `${b.name} (${b.entity || 'Company'})`; if(b.id === selectedBizId) opt.selected = true; businessSelect.appendChild(opt); }
    businessSelect.onchange = ()=>{ selectedBizId = businessSelect.value; ensureSelection(); populateAccountSelect(); renderAll(); };
  }

  function ensureSelection(){
    if(!selectedUserId && state.users[0]) selectedUserId = state.users[0].id;
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    state.auth.currentUserId = selectedUserId;
    refreshSelectors();
    populateAccountSelect();
    renderAll();
  }

  // User modal
  function openUserModal(editId){
    userModalTitle.textContent = editId ? 'Edit User' : 'Add User';
    userName.value = ''; userDisplay.value = ''; userRole.value = 'User'; permView.checked = permEdit.checked = permDelete.checked = false;
    userSave.dataset.edit = editId || '';
    if(editId){
      const u = state.users.find(x=>x.id===editId);
      if(u){ userName.value = u.username; userDisplay.value = u.display || u.username; userRole.value = u.role; permView.checked = !!u.permissions?.view; permEdit.checked = !!u.permissions?.edit; permDelete.checked = !!u.permissions?.delete; }
    }
    openModal(userModal);
  }
  function saveUser(){
    const username = (userName.value||'').trim();
    if(!username) return alert('Username required');
    const editId = userSave.dataset.edit;
    if(editId){
      const u = state.users.find(x=>x.id===editId);
      u.username = username; u.display = userDisplay.value || username; u.role = userRole.value;
      u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked };
      addAudit('user.edit','user',u.id,'Edited user');
    } else {
      const newUser = { id: uid('user'), username, display: userDisplay.value || username, role: userRole.value, isAdmin: userRole.value==='Admin', permissions: { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked } };
      state.users.push(newUser);
      state.transactions[newUser.id] = state.transactions[newUser.id] || {};
      for(const b of state.businesses) state.transactions[newUser.id][b.id] = state.transactions[newUser.id][b.id] || [];
      addAudit('user.add','user',newUser.id,'Added user');
    }
    saveState();
    closeModal(userModal);
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    renderAll();
  }

  // Business modal
  function openAddBusinessModal(){
    businessModalTitle.textContent = 'Add Business';
    bizName.value = ''; bizOwnerSelect.value = state.users[0] ? state.users[0].id : '';
    bizEntity.value = 'Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate;
    bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
    bizSave.dataset.edit = '';
    bizContactsList.innerHTML = '';
    bizTurnoverThreshold.value = '100000000';
    openModal(businessModal);
  }
  function openEditBusinessModal(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId); if(!b) return alert('Business not found');
    businessModalTitle.textContent = 'Edit Business';
    bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (state.users[0] && state.users[0].id) || '';
    bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
    bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled;
    bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0;
    bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax;
    bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
    bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0;
    renderBizContacts(b);
    bizSave.dataset.edit = b.id;
    bizTurnoverThreshold.value = String(b.turnoverThreshold || 100000000);
    openModal(businessModal);
  }
  function saveBusiness(){
    const name = (bizName.value||'').trim();
    if(!name) return alert('Business name required');
    const editId = bizSave.dataset.edit;
    if(editId){
      const b = findBiz(editId);
      if(!b) return alert('Business not found');
      b.name = name; b.ownerId = bizOwnerSelect.value; b.entity = bizEntity.value;
      b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
      b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked;
      b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0);
      b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked;
      b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) };
      b.turnoverThreshold = Number(bizTurnoverThreshold.value || 100000000);
      addAudit('business.edit','business', b.id, 'Edited business');
    } else {
      const newBiz = {
        id: uid('biz'), name, ownerId: bizOwnerSelect.value || (state.users[0] && state.users[0].id),
        entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate),
        vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
        accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward:0, caCarryForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, turnoverThreshold: Number(bizTurnoverThreshold.value||100000000)
      };
      // add some default accounts
      newBiz.accounts.push({ id: uid('acct'), name:'Sales', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 });
      newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 });
      newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 });
      newBiz.accounts.push({ id: uid('acct'), name:'Bank', category:'Asset', disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 });
      const extraNames = ['Share of profit','Benefit in kind','Dividend','Interest','Royalty','Rent','Shares','Options','Rights','Debt','Digital/Virtual Asset'];
      for(const nm of extraNames) newBiz.accounts.push({ id: uid('acct'), name:nm, category: (['Debt'].includes(nm)?'Liability': (['Shares','Options','Rights','Digital/Virtual Asset'].includes(nm)?'Asset':'Revenue')), disallowableDefault:false, nonTaxableDefault:false, startingBalance:0, closingBalance:0 });
      state.businesses.push(newBiz);
      for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][newBiz.id] = []; }
      addAudit('business.add','business',newBiz.id,'Added business');
    }
    saveState();
    closeModal(businessModal);
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    renderAll();
  }

  function addContactToBiz(){
    if(!selectedBizId) return alert('Select business first');
    const b = findBiz(selectedBizId);
    const name = (newContactName.value||'').trim();
    if(!name) return alert('Contact name required');
    b.contacts = b.contacts || [];
    b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } });
    saveState();
    renderBizContacts(b);
  }

  function addAccount(){
    const name = (newAccountName.value||'').trim();
    const cat = newAccountCategory.value;
    const dis = !!newAccountDisallowable.checked;
    const nt = !!newAccountNonTax.checked;
    const rentFreq = newAccountRentFreq.value || '';
    if(!name) return alert('Account name required');
    const b = findBiz(selectedBizId);
    b.accounts = b.accounts || [];
    b.accounts.push({ id: uid('acct'), name, category: cat, disallowableDefault:dis, nonTaxableDefault:nt, rentFreq:rentFreq, startingBalance:0, closingBalance:0 });
    saveState();
    renderAccounts();
    populateAccountSelect();
  }

  function renderBizContacts(b){
    bizContactsList.innerHTML = '';
    for(const c of b.contacts || []){
      const div = document.createElement('div'); div.className = 'account-row';
      div.innerHTML = `<div>${c.name} (${c.type})</div><div><button class="small" data-id="${c.id}">Edit</button> <button class="small danger" data-del="${c.id}">Delete</button></div>`;
      bizContactsList.appendChild(div);
      div.querySelector('[data-del]')?.addEventListener('click', ()=>{
        if(!confirm('Delete contact?')) return;
        b.contacts = b.contacts.filter(x=>x.id!==c.id); saveState(); renderBizContacts(b);
      });
    }
  }

  function renderAccounts(){
    accountsList.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of (b.accounts||[])){
      const div = document.createElement('div'); div.className = 'account-row';
      div.innerHTML = `<div><strong>${a.name}</strong> <span class="small-muted">(${a.category})</span><div class="small-muted">Start: ${fmt(a.startingBalance)} Close: ${fmt(a.closingBalance)}</div></div>
        <div><button class="small" data-edit="${a.id}">Edit</button> <button class="small danger" data-del="${a.id}">Delete</button></div>`;
      accountsList.appendChild(div);
      div.querySelector('[data-del]').addEventListener('click', ()=>{
        if(!confirm('Delete account?')) return;
        b.accounts = b.accounts.filter(x=>x.id!==a.id); saveState(); renderAccounts(); populateAccountSelect(); renderAll();
      });
      div.querySelector('[data-edit]').addEventListener('click', ()=>{
        const name = prompt('Account name', a.name); if(!name) return;
        a.name = name; saveState(); renderAccounts(); populateAccountSelect(); renderAll();
      });
    }
  }

  // Action change handling
  function txnActionChanged(){
    const val = txnAction.value;
    if(val === 'InventoryPurchase' || val === 'InventorySale'){
      mainTxnForm.style.display = 'none';
      inventorySubform.style.display = 'block';
      assetPurchaseSubform.style.display = 'none';
      assetDisposalSubform.style.display = 'none';
      populateAccountSelect();
      renderFeatureVisibility();
    } else if(val === 'AssetPurchase' || val === 'OpeningAssetBal'){
      mainTxnForm.style.display = 'none';
      assetPurchaseSubform.style.display = 'block';
      assetDisposalSubform.style.display = 'none';
      inventorySubform.style.display = 'none';
      renderFeatureVisibility();
      populateAssetExisting();
      if(val === 'OpeningAssetBal'){
        assetStartingBalDate.style.display = 'inline-block';
        document.getElementById('assetPurchaseDateLabel').style.display = 'none';
        assetOpeningCost.style.display = 'inline-block';
        assetOpeningAccDep.style.display = 'inline-block';
      } else {
        assetStartingBalDate.style.display = 'none';
        document.getElementById('assetPurchaseDateLabel').style.display = 'inline-block';
        assetOpeningCost.style.display = 'none';
        assetOpeningAccDep.style.display = 'none';
      }
      autoComputeAssetCost();
      setDefaultBankAccountsForAssets();
    } else if(val === 'AssetDisposal'){
      mainTxnForm.style.display = 'none';
      assetDisposalSubform.style.display = 'block';
      assetPurchaseSubform.style.display = 'none';
      inventorySubform.style.display = 'none';
      populateAssetDisposeSelect();
      renderFeatureVisibility();
      setDefaultBankAccountsForAssets();
    } else {
      mainTxnForm.style.display = 'flex';
      inventorySubform.style.display = 'none';
      assetPurchaseSubform.style.display = 'none';
      assetDisposalSubform.style.display = 'none';
      renderFeatureVisibility();
    }
  }

  function renderFeatureVisibility(){
    const biz = findBiz(selectedBizId);
    if(!biz) return;
    // If Individual: show only Income action & limited accounts
    if(biz.entity === 'Individual'){
      for(const opt of txnAction.options){
        if(opt.value === '' || opt.value === 'Income') opt.style.display = 'inline';
        else opt.style.display = 'none';
      }
      txnAction.value = 'Income';
    } else {
      for(const opt of txnAction.options) opt.style.display = 'inline';
    }
  }

  function populateAccountSelect(){
    txnAccount.innerHTML = '';
    const biz = findBiz(selectedBizId);
    if(!biz) return;
    const accounts = biz.accounts || [];
    const allowedForInd = ['Salary','Benefit in kind','Dividend','Interest','Royalty','Share of profit'];
    if(biz.entity === 'Individual'){
      for(const a of accounts.filter(x=> allowedForInd.includes(x.name))){
        const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name; txnAccount.appendChild(opt);
      }
    } else {
      for(const a of accounts){
        const opt = document.createElement('option'); opt.value = a.id; opt.textContent = `${a.name} (${a.category})`; txnAccount.appendChild(opt);
      }
    }

    // asset purchase/disposal account selects
    assetPurchaseAccount.innerHTML = ''; assetDisposalAccount.innerHTML = '';
    for(const a of accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = `${a.name} (${a.category})`;
      assetPurchaseAccount.appendChild(opt.cloneNode(true));
      assetDisposalAccount.appendChild(opt.cloneNode(true));
    }
  }

  function populateAssetExisting(){
    assetExistingSelect.innerHTML = '<option value="">-- new / select existing --</option>';
    const biz = findBiz(selectedBizId);
    if(!biz) return;
    for(const a of biz.assets || []){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = `${a.name} (qty ${a.qty || 1})`;
      assetExistingSelect.appendChild(opt);
    }
  }

  function populateAssetDisposeSelect(){
    assetDisposeSelect.innerHTML = '<option value="">-- select asset --</option>';
    const biz = findBiz(selectedBizId);
    if(!biz) return;
    for(const a of biz.assets || []){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = `${a.name} (qty ${a.qty || 1})`;
      assetDisposeSelect.appendChild(opt);
    }
  }

  function onExistingAssetSelect(){
    const id = assetExistingSelect.value;
    if(!id) { assetName.value=''; return; }
    const biz = findBiz(selectedBizId);
    if(!biz) return;
    const a = biz.assets.find(x=>x.id===id);
    if(a){
      assetName.value = a.name;
      assetQty.value = a.qty || 1;
      assetUnitPrice.value = a.unitPrice || a.cost || 0;
      assetCategory.value = a.category || 'Other Asset';
      assetLife.value = a.lifeYears || a.life || '';
      assetCA.value = a.caPercent || a.caPercent || '';
      assetDepRate.value = a.depRate || a.depRate || '';
      autoComputeAssetCost();
    }
  }

  function setDefaultBankAccountsForAssets(){
    const biz = findBiz(selectedBizId);
    if(!biz) return;
    const bank = biz.accounts.find(a=>a.name.toLowerCase() === 'bank') || biz.accounts[0];
    if(bank){
      assetPurchaseAccount.value = bank.id;
      assetDisposalAccount.value = bank.id;
    }
  }

  function autoComputeAssetCost(){
    const qty = Number(assetQty.value || 0);
    const price = Number(assetUnitPrice.value || 0);
    const cost = qty * price;
    assetCost.value = cost || 0;
    if(txnAction.value === 'OpeningAssetBal'){
      assetOpeningCost.value = cost || 0;
    }
  }

  // Transaction add
  function handleAddTransaction(){
    if(!selectedUserId || !selectedBizId) return alert('Select user & business');
    const b = findBiz(selectedBizId);
    const uTxns = state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    uTxns[selectedBizId] = uTxns[selectedBizId] || [];

    const action = txnAction.value || '';
    if(b.entity === 'Individual' && action !== 'Income') return alert('Individuals may only record Income transactions here.');

    const amount = Number(txnAmount.value || 0);
    const acct = findAccount(b, txnAccount.value);

    const txn = { id: uid('txn'), date: txnDate.value || today(), action, accountId: acct ? acct.id : null, accountName: acct ? acct.name : (txnAccount.value || ''), accountCategory: acct ? acct.category : '', description: txnDesc.value || '', amount: amount, vatType: txnVatType.value || 'none', contact: txnContact.value || '' };

    const vatRate = b.vatRate || DEFAULTS.vatRate;
    if(txn.vatType === 'exclusive') {
      txn.vatAmount = round2(amount * (vatRate/100));
      txn.total = amount + txn.vatAmount;
    } else if(txn.vatType === 'inclusive') {
      txn.vatAmount = round2((vatRate / (100 + vatRate)) * amount);
      txn.total = amount;
      txn.amount = round2(amount - txn.vatAmount);
    } else {
      txn.vatAmount = 0; txn.total = amount;
    }

    if(txnWht.checked){
      const whtRateP = Number(txnWhtRate.value || b.whtRate || DEFAULTS.whtRate);
      const whtRate = whtRateP/100;
      if(txnWhtBasis.value === 'net'){
        txn.whtAmount = round2(whtRate * (txn.amount / (1 - whtRate)));
      } else {
        txn.whtAmount = round2(whtRate * txn.amount);
      }
      txn.whtRate = whtRateP;
    } else { txn.whtAmount = 0; txn.whtRate = 0; }

    txn.paye = !!txnSalary.checked;

    uTxns[selectedBizId].push(txn);
    addAudit('txn.add','transaction',txn.id,`Added txn ${txn.action} ${fmt(txn.amount)}`);
    saveState();
    renderLedger();
    resetForms();
  }

  // Inventory
  function handleInventoryAction(){
    if(!selectedBizId || !selectedUserId) return alert('Select business & user');
    const b = findBiz(selectedBizId);
    const itemName = (invNewName.value||'').trim() || invItemSelect.value;
    if(!itemName) return alert('Item name required');
    const qty = Number(invQty.value || 0);
    const unitPrice = Number(invUnitPrice.value || 0);
    const acct = findAccount(b, invAccountSelect.value);
    const txn = { id: uid('inv'), date: today(), action: 'InventoryPurchase', item: itemName, qty, unitPrice, amount: qty*unitPrice, accountId: acct?acct.id:null, accountName: acct?acct.name:'', vatType: invVatType.value };
    let item = b.inventory.find(i=>i.name === itemName);
    if(!item){
      item = { id: uid('item'), name: itemName, qty:0, avgCost:0 };
      b.inventory.push(item);
    }
    const prevQty = item.qty || 0;
    const prevVal = (item.avgCost || 0) * prevQty;
    const newQty = prevQty + qty;
    const newVal = prevVal + (qty * unitPrice);
    item.qty = newQty;
    item.avgCost = newQty === 0 ? 0 : (newVal / newQty);
    inventoryHistory.push({ bizId: b.id, txn });
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {}; state.transactions[selectedUserId][b.id] = state.transactions[selectedUserId][b.id] || [];
    state.transactions[selectedUserId][b.id].push(txn);
    addAudit('inv.add','inventory',txn.id,`Inventory purchase ${itemName} qty ${qty}`);
    saveState();
    renderAll();
    resetForms();
  }

  function handleUndoInventory(){
    if(inventoryHistory.length === 0) return alert('No inventory action to undo');
    const last = inventoryHistory.pop();
    const b = findBiz(last.bizId);
    if(!b) return;
    for(const uId of Object.keys(state.transactions)){
      const arr = state.transactions[uId][b.id] || [];
      const idx = arr.findIndex(t=>t.id === last.txn.id);
      if(idx !== -1) arr.splice(idx,1);
    }
    const item = b.inventory.find(i=>i.name === last.txn.item);
    if(item){
      // rebuild from inventory txns
      item.qty = 0; item.avgCost = 0;
      for(const uId of Object.keys(state.transactions)){
        const txns = state.transactions[uId][b.id] || [];
        for(const t of txns.filter(x=>x.action === 'InventoryPurchase' && x.item === item.name)){
          const q = Number(t.qty||0), p = Number(t.unitPrice||0);
          const prevVal = item.avgCost * item.qty;
          const newQty = item.qty + q;
          const newVal = prevVal + (q * p);
          item.qty = newQty;
          item.avgCost = newQty === 0 ? 0 : (newVal / newQty);
        }
      }
    }
    addAudit('inv.undo','inventory', last.txn.id, 'Undo inventory action');
    saveState();
    renderAll();
  }

  // Assets
  function handleAddAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const isOpening = txnAction.value === 'OpeningAssetBal';
    const name = (assetName.value||'').trim() || (assetExistingSelect.value ? (b.assets.find(x=>x.id===assetExistingSelect.value)?.name||'') : '');
    if(!name) return alert('Asset name required');
    const qty = Number(assetQty.value || 1);
    const unitPrice = Number(assetUnitPrice.value || 0);
    const cost = Number(assetCost.value || (qty*unitPrice));
    const openingCost = Number(assetOpeningCost.value || 0);
    const openingAccDep = Number(assetOpeningAccDep.value || 0);
    const purchaseDate = isOpening ? (assetStartingBalDate.value || today()) : (assetPurchaseDate.value || today());
    const lifeYears = Number(assetLife.value || 0);
    const caPercent = Number(assetCA.value || 0);
    const depRate = Number(assetDepRate.value || 0);
    const classification = assetClassification.value || 'Fixed';
    const category = assetCategory.value || 'Other Asset';
    const acctId = assetPurchaseAccount.value;

    const asset = { id: uid('asset'), name, qty, unitPrice, cost, openingCost, openingAccDep, purchaseDate, startingBalDate: isOpening ? purchaseDate : null, lifeYears, caPercent, depRate, classification, accumulatedDep: Number(openingAccDep||0), accumulatedCA:0, category };

    b.assets = b.assets || [];
    b.assets.push(asset);

    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {}; state.transactions[selectedUserId][b.id] = state.transactions[selectedUserId][b.id] || [];
    const acct = findAccount(b, acctId);
    const txn = { id: uid('txn'), date: purchaseDate, action: isOpening ? 'OpeningAssetBal' : 'AssetPurchase', accountId: acct?acct.id:null, accountName: acct?acct.name:'', accountCategory: acct?acct.category:'', description: `${isOpening ? 'Opening asset balance' : 'Asset purchase'} ${name}`, amount: cost, qty, unitPrice, assetId: asset.id, classification, category, opening: isOpening };
    state.transactions[selectedUserId][b.id].push(txn);
    assetHistory.push({ bizId: b.id, txn });
    addAudit('asset.add','asset', asset.id, `Added asset ${name} cost ${fmt(cost)}`);
    saveState();
    renderAll();
    txnAction.value=''; assetPurchaseSubform.style.display='none'; mainTxnForm.style.display='flex';
    resetForms();
  }

  function handleDisposeAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const assetId = assetDisposeSelect.value;
    if(!assetId) return alert('Select asset to dispose');
    const asset = b.assets.find(a=>a.id===assetId);
    if(!asset) return alert('Asset not found');
    const qtyToDispose = Number(assetDisposeQty.value || 1);
    if(qtyToDispose > asset.qty) return alert('Insufficient quantity to dispose');
    const proceeds = Number(assetDisposalProceeds.value || 0);
    const disposalDate = assetDisposalDate.value || today();
    const acctId = assetDisposalAccount.value;

    // Compute tax written down value (simple approximation)
    const proportion = qtyToDispose / asset.qty;
    const twdv = Math.max( (asset.cost * proportion) - (asset.accumulatedCA || 0) * proportion, 10 );

    const gainOrLoss = round2(proceeds - twdv);

    // update asset balances
    const costRemoved = asset.cost * proportion;
    const accDepRemoved = (asset.accumulatedDep || 0) * proportion;
    asset.qty = asset.qty - qtyToDispose;
    asset.cost = round2(asset.cost - costRemoved);
    asset.accumulatedDep = round2((asset.accumulatedDep || 0) - accDepRemoved);

    // ledger txn
    const acct = findAccount(b, acctId);
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {}; state.transactions[selectedUserId][b.id] = state.transactions[selectedUserId][b.id] || [];
    const txn = { id: uid('txn'), date: disposalDate, action: 'AssetDisposal', accountId: acct?acct.id:null, accountName: acct?acct.name:'', description: `Disposal ${asset.name}`, proceeds, gainOrLoss, assetId: asset.id, qty: qtyToDispose, classification: asset.classification };
    state.transactions[selectedUserId][b.id].push(txn);

    assetHistory.push({ bizId: b.id, txn });
    addAudit('asset.dispose','asset', asset.id, `Disposed ${qtyToDispose} of ${asset.name} proceeds ${fmt(proceeds)} gain/loss ${fmt(gainOrLoss)}`);

    // Accounting entries (approx): record profit as Income or loss as Expense, but mark tax adjustments
    if(gainOrLoss > 0){
      const revAcct = b.accounts.find(a=>a.category==='Revenue') || b.accounts[0];
      const revenueTxn = { id: uid('txn'), date: disposalDate, action: 'Income', accountId: revAcct.id, accountName: revAcct.name, description: `Profit on disposal ${asset.name}`, amount: gainOrLoss, taxAdjustment: -gainOrLoss };
      state.transactions[selectedUserId][b.id].push(revenueTxn);
    } else if(gainOrLoss < 0){
      const expenseAcct = b.accounts.find(a=>a.category==='Expense') || b.accounts[0];
      const expenseTxn = { id: uid('txn'), date: disposalDate, action: 'Expense', accountId: expenseAcct.id, accountName: expenseAcct.name, description: `Loss on disposal ${asset.name}`, amount: Math.abs(gainOrLoss), taxAdjustment: Math.abs(gainOrLoss) };
      state.transactions[selectedUserId][b.id].push(expenseTxn);
    }

    saveState();
    renderAll();
    txnAction.value=''; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex';
  }

  function handleUndoAsset(){
    if(assetHistory.length === 0) return alert('No asset action to undo');
    const last = assetHistory.pop();
    const b = findBiz(last.bizId);
    if(!b) return;
    for(const uId of Object.keys(state.transactions)){
      const arr = state.transactions[uId][b.id] || [];
      const idx = arr.findIndex(t=>t.id === last.txn.id);
      if(idx !== -1) arr.splice(idx,1);
    }
    // remove asset created by that txn if any
    if(last.txn && last.txn.assetId){
      b.assets = b.assets.filter(a=>a.id !== last.txn.assetId);
      // also remove txns referencing that asset
      for(const uId of Object.keys(state.transactions)){
        const arr = state.transactions[uId][b.id] || [];
        for(let i = arr.length-1;i>=0;i--){
          if(arr[i].assetId === last.txn.assetId) arr.splice(i,1);
        }
      }
    }
    addAudit('asset.undo','asset', last.txn.id, 'Undo asset action');
    saveState();
    renderAll();
  }

  function handleUndoLastDisposal(){
    for(let i = assetHistory.length-1; i>=0; i--){
      if(assetHistory[i].txn && assetHistory[i].txn.action === 'AssetDisposal'){
        const last = assetHistory.splice(i,1)[0];
        const b = findBiz(last.bizId);
        if(!b) return;
        for(const uId of Object.keys(state.transactions)){
          const arr = state.transactions[uId][b.id] || [];
          const idx = arr.findIndex(t=>t.id === last.txn.id);
          if(idx !== -1) arr.splice(idx,1);
        }
        // best-effort: do not attempt to restore asset quantities automatically (needs full audit)
        addAudit('asset.dispose.undo','asset', last.txn.id, 'Undo asset disposal (ledger entries removed; asset quantities may need manual restore)');
        saveState();
        renderAll();
        return;
      }
    }
    alert('No asset disposal action found to undo');
  }

  // Ledger rendering with view/edit/delete
  function renderLedger(){
    ledgerTableBody.innerHTML = '';
    if(!selectedUserId || !selectedBizId) return;
    const txns = (state.transactions[selectedUserId] || {})[selectedBizId] || [];
    const q = (document.getElementById('ledgerSearch').value||'').toLowerCase();
    const filtered = txns.filter(t => {
      if(!q) return true;
      return (t.date||'').includes(q) || (t.accountName||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q) || String(t.amount||'').includes(q) || (t.contact||'').toLowerCase().includes(q);
    });
    for(const t of filtered){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.date||''}</td><td>${t.action||''}</td><td>${t.accountName||''}</td><td>${t.description||''}</td><td>${fmt(t.amount)}</td><td>${fmt(t.vatAmount||0)}</td><td>${fmt(t.whtAmount||0)}</td><td>${t.paye?fmt(t.amount):''}</td><td>${t.contact||''}</td><td>${t.receiptId?'<span class="link-like">receipt</span>':''}</td>
        <td><button class="small" data-view="${t.id}">View</button> <button class="small" data-edit="${t.id}">Edit</button> <button class="small danger" data-del="${t.id}">Delete</button></td>`;
      ledgerTableBody.appendChild(tr);
      tr.querySelector('[data-del]').addEventListener('click', ()=>{
        if(!confirm('Delete transaction?')) return;
        const arr = state.transactions[selectedUserId][selectedBizId];
        const idx = arr.findIndex(x=>x.id === t.id);
        if(idx !== -1) arr.splice(idx,1);
        saveState();
        renderLedger();
      });
      tr.querySelector('[data-edit]').addEventListener('click', ()=>{
        const newAmt = prompt('Amount', t.amount);
        if(newAmt === null) return;
        t.amount = Number(newAmt);
        t.description = prompt('Description', t.description) || t.description;
        saveState(); renderLedger();
      });
      tr.querySelector('[data-view]').addEventListener('click', ()=>{
        alert(JSON.stringify(t, null, 2));
      });
    }
    renderTaxSummary();
  }

  // Tax & summary computations (simplified, extendable)
  function renderTaxSummary(){
    taxSummaryDiv.innerHTML = '';
    if(!selectedUserId || !selectedBizId) return;
    const b = findBiz(selectedBizId);
    const txns = (state.transactions[selectedUserId] || {})[selectedBizId] || [];
    let totalRevenue = 0, totalExpense = 0;
    for(const t of txns){
      if(t.action === 'Income' || t.action === 'Revenue') totalRevenue += Number(t.amount||0);
      if(t.action === 'Expense') totalExpense += Number(t.amount||0);
    }
    const accountingProfit = totalRevenue - totalExpense;
    const disallowables = computeDisallowableExpenses(b, txns);
    const nonTaxableIncome = computeNonTaxableIncome(b, txns);
    const totalCAForYear = computeCapitalAllowanceForYear(b, txns);
    const chargeable = computeChargeableGainsAndLosses(b, txns);
    const lossBf = b.lossBroughtForward || 0;

    const totalDep = 0; // placeholder
    const totalRevenueForRatio = Math.max(totalRevenue, 1);
    let capAllowanceRelief = 0;
    if(nonTaxableIncome < (0.10 * totalRevenueForRatio)){
      capAllowanceRelief = totalCAForYear;
    } else {
      capAllowanceRelief = round2((2/3) * totalCAForYear);
      b.caCarryForward = Number(b.caCarryForward || 0) + round2((1/3) * totalCAForYear);
    }

    let taxableProfit = accountingProfit + totalDep + disallowables + chargeable.gains - nonTaxableIncome - lossBf - capAllowanceRelief;
    taxableProfit = round2(taxableProfit < 0 ? 0 : taxableProfit);

    if(b.entity === 'Individual'){
      const paye = computePIT(b, taxableProfit);
      const wht = computeWHTSummary(txns);
      taxSummaryDiv.innerHTML = `<div><strong>Tax Summary (Individual)</strong></div>
        <div>Gross Income: ${fmt(totalRevenue)}</div>
        <div>Less Statutory deductions (business): ${fmt(sumObjectValues(b.statutoryDeductions))}</div>
        <div><strong>Taxable income:</strong> ${fmt(taxableProfit)}</div>
        <div>PAYE / PIT liability: ${fmt(paye.tax)}</div>
        <div>WHT receivable: ${fmt(wht.receivable)}</div>`;
    } else {
      const cit = computeCIT(b, taxableProfit, totalRevenue, chargeable);
      const paye = computePIT(b, taxableProfit);
      const wht = computeWHTSummary(txns);
      taxSummaryDiv.innerHTML = `<div><strong>Tax Summary (${b.entity})</strong></div>
        <div>Accounting profit: ${fmt(accountingProfit)}</div>
        <div>Adjustments: Depreciation ${fmt(totalDep)}, Disallowable ${fmt(disallowables)}</div>
        <div>Chargeable gains: ${fmt(chargeable.gains)}</div>
        <div>Non-taxable income: ${fmt(nonTaxableIncome)}</div>
        <div>Capital allowance relief applied: ${fmt(capAllowanceRelief)}</div>
        <div><strong>Taxable profit:</strong> ${fmt(taxableProfit)}</div>
        <div>CIT computed: ${fmt(cit.computed)} ${cit.note?(' - '+cit.note):''}</div>
        <div>PAYE / PIT (if applicable): ${fmt(paye.tax)}</div>
        <div>WHT receivable: ${fmt(wht.receivable)} | WHT payable: ${fmt(wht.payable)}</div>
        <div>CGT (chargeable gains tax) computed: ${fmt(chargeable.cgt || 0)}</div>`;
    }
  }

  function sumObjectValues(obj){
    let s = 0;
    if(!obj) return 0;
    for(const k in obj) s += Number(obj[k]||0);
    return s;
  }

  function computeDisallowableExpenses(b, txns){
    let s = 0;
    for(const t of txns){
      const acct = b.accounts.find(a=>a.id === t.accountId);
      if(acct && acct.disallowableDefault) s += Number(t.amount || 0);
    }
    return round2(s);
  }
  function computeNonTaxableIncome(b, txns){
    let s = 0;
    for(const t of txns){
      const acct = b.accounts.find(a=>a.id === t.accountId);
      if(acct && acct.nonTaxableDefault) s += Number(t.amount || 0);
    }
    return round2(s);
  }
  function computeCapitalAllowanceForYear(b, txns){
    let s = 0;
    const year = new Date().getFullYear();
    for(const a of b.assets || []){
      const pd = a.purchaseDate || a.startingBalDate;
      if(!pd) continue;
      const y = new Date(pd).getFullYear();
      if(y <= year){
        const ca = (Number(a.cost || 0) * (Number(a.caPercent||0)/100));
        s += ca;
      }
    }
    return round2(s);
  }
  function computeChargeableGainsAndLosses(b, txns){
    let gains = 0, losses = 0;
    for(const t of txns){
      if(t.action === 'AssetDisposal'){
        const gv = Number(t.gainOrLoss || t.gain || 0);
        if(gv > 0) gains += gv;
        if(gv < 0) losses += Math.abs(gv);
      }
    }
    return { gains: round2(gains), losses: round2(losses), cgt: 0 };
  }
  function computeWHTSummary(txns){
    let receivable = 0, payable = 0;
    for(const t of txns){
      if(Number(t.whtAmount || 0) > 0){
        if(t.action === 'Income' || t.action === 'Revenue') receivable += Number(t.whtAmount || 0);
        else payable += Number(t.whtAmount || 0);
      }
    }
    return { receivable: round2(receivable), payable: round2(payable) };
  }

  function computePIT(b, taxableProfit){
    const statutory = sumObjectValues(b.statutoryDeductions || {});
    const amount = Math.max(0, taxableProfit - statutory);
    let remaining = amount;
    let tax = 0;
    let lower = 0;
    for(const band of PAYE_BANDS){
      const upTo = band.upTo;
      const bandAmt = Math.max(0, Math.min(remaining, upTo - lower));
      tax += bandAmt * band.rate;
      remaining -= bandAmt;
      lower = upTo;
      if(remaining <= 0) break;
    }
    return { tax: round2(tax), taxable: amount };
  }

  function computeCIT(b, taxableProfit, turnover, chargeable){
    const threshold = Number(b.turnoverThreshold || 100000000);
    let rate = 0;
    let note = '';
    if(threshold === 0){
      rate = 0; note = 'Threshold=0 => CIT 0%';
    } else if(threshold === 50000000){
      if(turnover <= 50000000) { rate = 0; note = 'Turnover <= ₦50,000,000 => 0%'; }
      else { rate = 0.25; note = 'Turnover > ₦50,000,000 => 25%'; }
    } else if(threshold === 100000000){
      if(turnover <= 100000000) { rate = 0; note = 'Turnover <= ₦100,000,000 => 0%'; }
      else { rate = 0.30; note = 'Turnover > ₦100,000,000 => 30%'; }
    } else {
      rate = Number(b.citRate || DEFAULTS.citRate)/100;
    }
    const computed = round2(taxableProfit * rate);
    const txns = (state.transactions[selectedUserId] || {})[selectedBizId] || [];
    const wht = computeWHTSummary(txns);
    const net = computed > 0 ? Math.max(0, computed - wht.receivable) : computed;
    return { computed: round2(computed), net: round2(net), note };
  }

  // Quick panels
  function renderQuickPanels(){
    const b = findBiz(selectedBizId);
    inventoryListDiv.innerHTML = '';
    assetListDiv.innerHTML = '';
    plSnapshotQuick.innerHTML = '';
    if(!b) return;
    for(const it of b.inventory || []){
      const div = document.createElement('div');
      div.innerHTML = `<div><strong>${it.name}</strong> qty ${it.qty} avg cost ${fmt(it.avgCost)}</div>`;
      inventoryListDiv.appendChild(div);
    }
    const group = {};
    for(const a of b.assets || []){
      group[a.category || 'Other'] = group[a.category || 'Other'] || { cost:0, accDep:0 };
      group[a.category || 'Other'].cost += Number(a.cost||0);
      group[a.category || 'Other'].accDep += Number(a.accumulatedDep||0);
    }
    for(const cat in group){
      const nbv = group[cat].cost - group[cat].accDep;
      const div = document.createElement('div');
      div.innerHTML = `<div><strong>${cat}</strong> Cost: ${fmt(group[cat].cost)} AccDep: ${fmt(group[cat].accDep)} NBV: ${fmt(nbv)}</div>`;
      assetListDiv.appendChild(div);
    }
    const txns = (state.transactions[selectedUserId] || {})[selectedBizId] || [];
    let rev=0, exp=0;
    for(const t of txns){ if(t.action === 'Income' || t.action === 'Revenue') rev += Number(t.amount||0); if(t.action === 'Expense') exp += Number(t.amount||0); }
    plSnapshotQuick.innerHTML = `<div>Revenue: ${fmt(rev)} | Expense: ${fmt(exp)} | Profit: ${fmt(rev-exp)}</div>`;
  }

  // Reports
  function renderReport(name){
    reportContent.innerHTML = '';
    if(name === 'taxReconciliation'){
      reportContent.appendChild(generateTaxComputationReport());
    } else {
      reportContent.textContent = 'Report not implemented yet for: ' + name;
    }
  }

  function generateTaxComputationReport(){
    const wrapper = document.createElement('div');
    const b = findBiz(selectedBizId);
    if(!b) { wrapper.textContent = 'Select business to generate report'; return wrapper; }
    const txns = (state.transactions[selectedUserId] || {})[selectedBizId] || [];
    if(b.entity === 'Individual'){
      let grossSalary=0, benefit=0, dividend=0, royalty=0, interest=0, rent=0, shareProfit=0;
      for(const t of txns){
        if(t.accountName === 'Salary' || t.accountName === 'Salaries') grossSalary += Number(t.amount||0);
        if(t.accountName === 'Benefit in kind') benefit += Number(t.amount||0);
        if(t.accountName === 'Dividend') dividend += Number(t.amount||0);
        if(t.accountName === 'Royalty') royalty += Number(t.amount||0);
        if(t.accountName === 'Interest') interest += Number(t.amount||0);
        if(t.accountName === 'Rent') rent += Number(t.amount||0);
        if(t.accountName === 'Share of profit') shareProfit += Number(t.amount||0);
      }
      const grossIncome = grossSalary + benefit + dividend + royalty + interest + rent + shareProfit;
      const statutory = b.statutoryDeductions || {};
      const pension = statutory.pension || 0;
      const rentRelief = statutory.rent || 0;
      const life = statutory.life || 0;
      const mortgage = statutory.mortgage || 0;
      const nhf = statutory.nhf || 0;
      const taxableIncome = Math.max(0, grossIncome - (pension + rentRelief + life + mortgage + nhf));
      const pit = computePIT(b, taxableIncome);
      wrapper.innerHTML = `<pre style="font-family:inherit;">
Computations of Personal Income Tax for Year Ended ${new Date().getFullYear()}

Gross Salary                  ${fmt(grossSalary)}
Benefit in kind               ${fmt(benefit)}
Dividend (Gross)              ${fmt(dividend)}
Royalty (Gross)               ${fmt(royalty)}
Interest (Gross)              ${fmt(interest)}
Rent(Gross)                   ${fmt(rent)}
Share of Profit               ${fmt(shareProfit)}
Gross Income                  ${fmt(grossIncome)}

Less Statutory deductions
Pension                       ${fmt(pension)}
Rent relief                   ${fmt(rentRelief)}
Life assurance                ${fmt(life)}
Mortgage interest             ${fmt(mortgage)}
NHF                           ${fmt(nhf)}

Taxable Income                ${fmt(taxableIncome)}

Final tax liability:          ${fmt(pit.tax)}
Effective tax rate:           ${((pit.tax / Math.max(1, taxableIncome))*100).toFixed(2)}%

</pre>`;
      return wrapper;
    } else {
      // enterprise/company simplified report
      let totalRevenue=0, totalExpense=0;
      for(const t of txns){ if(t.action === 'Income' || t.action === 'Revenue') totalRevenue += Number(t.amount||0); if(t.action === 'Expense') totalExpense += Number(t.amount||0); }
      const accountingProfit = totalRevenue - totalExpense;
      const disallowables = computeDisallowableExpenses(b, txns);
      const nonTaxable = computeNonTaxableIncome(b, txns);
      const chargeable = computeChargeableGainsAndLosses(b, txns);
      const totalCA = computeCapitalAllowanceForYear(b, txns) + (b.caCarryForward || 0);
      let capAllowanceRelief = totalCA;
      if(nonTaxable >= (0.10 * Math.max(totalRevenue,1))) capAllowanceRelief = round2((2/3) * totalCA);
      const taxableProfit = round2(accountingProfit + disallowables + chargeable.gains - nonTaxable - (b.lossBroughtForward||0) - capAllowanceRelief);
      const pit = computePIT(b, taxableProfit);
      const cit = computeCIT(b, taxableProfit, totalRevenue, chargeable);
      wrapper.innerHTML = `<pre style="font-family:inherit;">
Enterprise Tax Computation for Year Ended ${new Date().getFullYear()}

Accounting profit:            ${fmt(accountingProfit)}

Add Disallowable expenses:
  Depreciation                ${fmt(0)}
  Loss on disposal of fixed asset  ${fmt(chargeable.losses)}
  Other Disallowable expenses  ${fmt(disallowables)}

Deduct Non Taxable Income
  Profit on Disposal of fixed asset ${fmt(0)}
  Other Non Taxable Income     ${fmt(nonTaxable)}

Adjusted Profit               ${fmt(accountingProfit + disallowables - nonTaxable)}

Less Unrelieved Loss b/f      ${fmt(b.lossBroughtForward || 0)}

Assessable Profit             ${fmt(Math.max(0, accountingProfit + disallowables - nonTaxable - (b.lossBroughtForward||0)))}

Deduct Capital Allowance      ${fmt(capAllowanceRelief)}

Taxable profit                ${fmt(taxableProfit)}

Less Statutory deductions
  Pension                     ${fmt(b.statutoryDeductions?.pension || 0)}
  Rent relief                 ${fmt(b.statutoryDeductions?.rent || 0)}
  Life assurance              ${fmt(b.statutoryDeductions?.life || 0)}
  Mortgage interest           ${fmt(b.statutoryDeductions?.mortgage || 0)}
  NHF                         ${fmt(b.statutoryDeductions?.nhf || 0)}

Adjusted Taxable profit       ${fmt(Math.max(0, taxableProfit - sumObjectValues(b.statutoryDeductions || {})))}

Add Chargeable gains          ${fmt(chargeable.gains)}

Gross Taxable profit          ${fmt(Math.max(0, taxableProfit + chargeable.gains))}

PIT liability (if applicable) ${fmt(pit.tax)}
CIT Computed                  ${fmt(cit.computed)}  Note: ${cit.note}
Final CIT after WHT offset    ${fmt(cit.net)}

</pre>`;
      return wrapper;
    }
  }

  // Export / import / clear
  function exportJSON(){
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'ntc_full_data.json'; a.click(); URL.revokeObjectURL(url);
  }
  function importJSON(e){
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const incoming = JSON.parse(r.result);
        if(!confirm('Import will replace current data. Continue?')) return;
        state = incoming;
        migrateState();
        refreshSelectors();
        ensureSelection();
        populateAccountSelect();
        resetForms();
        renderAll();
        saveState();
        alert('Import complete');
      } catch(err){ alert('Invalid JSON'); }
    };
    r.readAsText(f);
  }
  function clearAllData(){
    if(!confirm('Clear all stored data?')) return;
    localStorage.removeItem(STORAGE_KEY);
    state = { users:[], businesses:[], transactions:{}, attachments:{}, audit:[], auth:{ currentUserId:null } };
    seedDemo();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    resetForms();
    renderAll();
  }

  function resetForms(){
    txnDate.value = today(); txnAction.value = ''; txnAccount.innerHTML=''; txnDesc.value=''; txnAmount.value='0'; txnVatType.value='none'; txnWht.checked=false; txnWhtRate.value=''; txnWhtBasis.value='gross'; txnSalary.checked=false;
    invItemSelect.innerHTML=''; invNewName.value=''; invAccountSelect.innerHTML=''; invQty.value=''; invUnitPrice.value=''; invOpeningQty.value=''; invOpeningAvgCost.value='';
    assetExistingSelect.innerHTML=''; assetName.value=''; assetQty.value=1; assetUnitPrice.value=''; assetCost.value=''; assetOpeningCost.value=''; assetOpeningAccDep.value=''; assetPurchaseDate.value=''; assetLife.value=''; assetCA.value=''; assetDepRate.value='';
    assetDisposalDate.value = ''; assetDisposalProceeds.value=''; assetDisposeQty.value = 1;
  }

  // utilities
  function findBankAccountId(biz){
    const b = biz || findBiz(selectedBizId);
    if(!b) return null;
    const bank = b.accounts.find(a=>a.name.toLowerCase()==='bank') || b.accounts.find(a=>a.category==='Asset') || b.accounts[0];
    return bank ? bank.id : null;
  }

  function vatInclusiveCompute(amount, vatRate){
    return round2((vatRate/(100+vatRate)) * amount);
  }

  function exportCurrentReport(format){ alert('Export '+format+' not fully implemented in this prototype. Use Export JSON to extract data.'); }

  // delete helpers
  function deleteUser(id){
    state.users = state.users.filter(u=>u.id !== id);
    delete state.transactions[id];
    if(state.auth.currentUserId === id) state.auth.currentUserId = state.users[0] && state.users[0].id;
    saveState();
    refreshSelectors();
    ensureSelection();
    renderAll();
  }
  function deleteBusiness(id){
    state.businesses = state.businesses.filter(b=>b.id !== id);
    for(const u of Object.keys(state.transactions)) delete state.transactions[u][id];
    if(selectedBizId === id) selectedBizId = state.businesses[0] && state.businesses[0].id;
    saveState();
    refreshSelectors();
    ensureSelection();
    renderAll();
  }

  // initial wiring & render
  initUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  // expose to console for debugging
  window.__ntc = { state, saveState, loadState, computePIT, computeCIT, computeChargeableGainsAndLosses };

  </script>
</body>
</html>

If you want further fixes or to expand particular tax/asset rules (for example: fully detailed CGT rules, monthly rolling balances, precise carry-forward flows), tell me which part to focus on and whether you'd like me to open a PR on the repository (I can produce the PR with this file).
