#   <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Taxpro â€” Nigeria Tax Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:0.95rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,96vw); max-height:80vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted-pill { background:#f2f4f7; padding:4px 8px; border-radius:6px; font-size:0.9rem; color:#333; }
    .disabled { opacity:0.45; pointer-events:none; }
    .code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f3f5f7; padding:4px 6px; border-radius:4px; }
    /* Pre-login section styles - integrated full-page design */
    .prelogin-overlay { background:linear-gradient(135deg, #0b76d1 0%, #00a3b5 100%); padding:40px 20px; min-height:100vh; display:flex; align-items:center; justify-content:center; }
    .prelogin-overlay.hidden { display:none; }
    .prelogin-card { background:#fff; padding:40px 48px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.15); text-align:center; max-width:420px; width:90%; }
    .prelogin-card h2 { margin:0 0 8px 0; font-size:1.5rem; color:#222; }
    .prelogin-tagline { color:#0b76d1; font-size:1rem; font-weight:600; margin:0 0 12px 0; }
    .prelogin-offer-box { background:linear-gradient(135deg, #0b76d1 0%, #00a3b5 100%); color:#fff; padding:12px 16px; border-radius:10px; margin:0 0 18px 0; }
    .prelogin-offer-box .timer-label { font-size:0.85rem; margin-bottom:4px; }
    .prelogin-offer-box .timer-value { font-size:1.5rem; font-weight:700; letter-spacing:1px; }
    .prelogin-offer-box .buy-now-btn { display:inline-block; margin-top:10px; padding:10px 28px; background:#fff; color:#0b76d1; font-weight:700; border-radius:8px; text-decoration:none; transition:background 0.2s, color 0.2s; }
    .prelogin-offer-box .buy-now-btn:hover { background:#e6f4fa; }
    .prelogin-subtitle { color:var(--muted); margin:0 0 24px 0; font-size:0.95rem; }
    .prelogin-form { display:flex; flex-direction:column; gap:16px; }
    .prelogin-form label { display:flex; flex-direction:column; text-align:left; font-size:0.9rem; color:var(--muted); gap:6px; }
    .prelogin-form input { padding:10px 12px; border:1px solid #cfcfcf; border-radius:8px; font-size:1rem; }
    .prelogin-form input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(11,118,209,0.15); }
    .prelogin-btn { padding:12px 24px; font-size:1rem; margin-top:8px; }
    .prelogin-note { color:var(--muted); font-size:0.8rem; margin:20px 0 0 0; }
    /* Auth tabs styles (merged from auth.css) */
    .auth-tabs { display:flex; gap:8px; margin-bottom:12px; justify-content:center; }
    .auth-tabs .tab { padding:8px 12px; border-radius:8px; border:1px solid #e6e9ef; background:#fff; cursor:pointer; }
    .auth-tabs .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .auth-panel { display:block; }
    .auth-panel.hidden { display:none; }
    .auth-msg { color:var(--muted); margin-top:8px; font-size:0.9rem; }
    /* Prevent body scroll when modals are shown */
    body.modal-open { overflow:hidden; }
    html:has(.modal[style*="display:block"]), html:has(.modal[style*="display: block"]) { overflow:hidden; }
    /* Hero promo section styles */
    .hero-promo { background:linear-gradient(135deg, #0b76d1 0%, #00a3b5 100%); color:#fff; padding:32px 24px; border-radius:12px; margin-bottom:16px; text-align:center; }
    .hero-promo h2 { margin:0 0 8px 0; font-size:1.35rem; font-weight:700; }
    .hero-promo p { margin:0 0 16px 0; font-size:1rem; opacity:0.95; }
    .hero-promo .hero-timer { font-size:1.1rem; margin-bottom:12px; }
    .hero-promo .hero-timer strong { font-size:1.4rem; letter-spacing:1px; }
    .hero-promo .hero-cta { display:inline-block; padding:12px 32px; background:#fff; color:#0b76d1; font-weight:700; border-radius:8px; text-decoration:none; transition:background 0.2s, color 0.2s; }
    .hero-promo .hero-cta:hover { background:#e6f4fa; }
    /* Pricing plan cards styles */
    .plan-cards { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin:16px 0; }
    .plan-card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:14px; text-align:left; }
    .plan-card.highlight { border-color:#0b76d1; box-shadow:0 2px 8px rgba(11,118,209,0.15); }
    .plan-card h3 { margin:0 0 8px 0; font-size:1.05rem; color:#1e293b; display:flex; align-items:center; gap:6px; }
    .plan-badge { background:#0b76d1; color:#fff; font-size:0.7rem; padding:2px 6px; border-radius:4px; font-weight:600; }
    .plan-pricing { margin:8px 0; }
    .plan-full-price { color:#64748b; font-size:0.85rem; text-decoration:line-through; }
    .plan-offer-price { color:#059669; font-size:1.15rem; font-weight:700; }
    .plan-features { list-style:none; padding:0; margin:10px 0; font-size:0.8rem; color:#475569; }
    .plan-features li { padding:3px 0; padding-left:16px; position:relative; }
    .plan-features li::before { content:"âœ“"; position:absolute; left:0; color:#059669; font-weight:600; }
    .plan-checkbox-row { display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#334155; margin:6px 0; }
    .plan-checkbox-row input[type="checkbox"] { margin:0; accent-color:#0b76d1; }
    .plan-total { background:#e0f2fe; padding:8px; border-radius:6px; margin:10px 0 8px 0; text-align:center; }
    .plan-total-label { font-size:0.75rem; color:#0369a1; }
    .plan-total-value { font-size:1.1rem; font-weight:700; color:#0b76d1; }
    .plan-buttons-container { display:flex; gap:10px; width:100%; }
    .plan-buy-btn { display:block; flex:1; padding:10px; background:#0b76d1; color:#fff; border:none; border-radius:6px; font-weight:600; font-size:0.9rem; text-decoration:none; text-align:center; cursor:pointer; transition:background 0.2s; }
    .plan-buy-btn:hover { background:#0a68be; }
    .plan-buy-btn.stripe { background:#635bff; }
    .plan-buy-btn.stripe:hover { background:#5248e6; }
    .offer-countdown-box { background:linear-gradient(135deg, #0b76d1 0%, #00a3b5 100%); color:#fff; padding:12px 16px; border-radius:10px; margin-bottom:16px; text-align:center; }
    .offer-countdown-box .countdown-label { font-size:0.85rem; margin-bottom:4px; }
    .offer-countdown-box .countdown-value { font-size:1.4rem; font-weight:700; letter-spacing:1px; }
    .offer-flash { animation: offerFlash 0.6s ease-out; }
    @keyframes offerFlash { 0%,100%{background:linear-gradient(135deg,#0b76d1 0%,#00a3b5 100%);} 50%{background:linear-gradient(135deg,#10b981 0%,#059669 100%);} }
    .prelogin-card-wide { max-width:720px; width:95%; padding:24px 28px; }
    .addon-price { color:#0b76d1; font-weight:600; }
    /* Collapsible plan card styles using <details> */
    details.plan-card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:0; text-align:left; }
    details.plan-card[open] { padding:14px; padding-top:0; }
    details.plan-card.highlight { border-color:#0b76d1; box-shadow:0 2px 8px rgba(11,118,209,0.15); }
    details.plan-card summary { display:flex; align-items:center; justify-content:space-between; padding:14px; cursor:pointer; list-style:none; }
    details.plan-card summary::-webkit-details-marker { display:none; }
    details.plan-card summary::marker { display:none; }
    details.plan-card summary .plan-header-left { display:flex; align-items:center; gap:6px; }
    details.plan-card summary .plan-header-left h3 { margin:0; font-size:1.05rem; color:#1e293b; display:flex; align-items:center; gap:6px; }
    details.plan-card summary .plan-header-right { display:flex; align-items:center; gap:8px; }
    details.plan-card summary .plan-header-right .plan-offer-price { color:#059669; font-size:1.15rem; font-weight:700; }
    details.plan-card summary .plan-arrow { transition:transform 0.2s ease; font-size:0.8rem; color:#64748b; }
    details.plan-card[open] summary .plan-arrow { transform:rotate(180deg); }
    /* Dashboard styles */
    .dashboard-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:12px; margin-bottom:12px; }
    .dashboard-card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:14px; }
    .dashboard-card h3 { margin:0 0 10px 0; font-size:1rem; color:#1e293b; border-bottom:1px solid #e2e8f0; padding-bottom:6px; }
    .dashboard-metric { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f1f5f9; }
    .dashboard-metric:last-child { border-bottom:none; }
    .dashboard-metric-label { color:#64748b; font-size:0.9rem; }
    .dashboard-metric-value { font-weight:600; color:#1e293b; }
    .dashboard-nav-btn { display:inline-block; padding:6px 12px; margin:4px; background:#0b76d1; color:#fff; border-radius:6px; text-decoration:none; font-size:0.85rem; cursor:pointer; border:none; }
    .dashboard-nav-btn:hover { background:#0a68be; }
    .account-usage-badge { display:inline-block; font-size:0.75rem; padding:2px 6px; margin-left:6px; border-radius:4px; background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd; }
  </style>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase compat SDK for Authentication -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
  /**
   * Firebase Configuration
   * 
   * Firebase Authentication is the primary authentication method.
   * Email/Password authentication must be enabled in Firebase Console:
   * Authentication â†’ Sign-in method â†’ Email/Password
   * 
   * Update firebaseConfig values with your Firebase project credentials.
   */
  
  // Firebase Authentication is always enabled
  var FIREBASE_ENABLED = true;

  // Firebase web config â€” verify values in Firebase Console (storageBucket commonly ends with ".appspot.com")
  var firebaseConfig = {
    apiKey: "AIzaSyDyLT58G18M7XPNLd3J6YnAMnLcKeEPmto",
    authDomain: "aaaa-b8178.firebaseapp.com",
    projectId: "aaaa-b8178",
    storageBucket: "aaaa-b8178.firebasestorage.app",
    messagingSenderId: "313899934004",
    appId: "1:313899934004:web:cb2b729fb3b42c57e00561",
    measurementId: "G-X18YDSXSZV"
  };
  
  // Firebase initialization (only if configured)
  var firebaseApp = null;
  var firebaseAuth = null;
  
  // Check if firebaseConfig is defined and has required properties
  function isFirebaseConfigValid() {
    return typeof firebaseConfig !== 'undefined' && 
           firebaseConfig !== null &&
           typeof firebaseConfig.apiKey === 'string' &&
           typeof firebaseConfig.authDomain === 'string' &&
           typeof firebaseConfig.projectId === 'string';
  }
  
  if (FIREBASE_ENABLED && isFirebaseConfigValid()) {
    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      firebaseAuth = firebase.auth();
      console.log('Firebase Authentication initialized successfully');
    } catch (e) {
      console.error('Firebase initialization failed:', e.message);
      console.warn('Continuing in local-only mode. Firebase features will be unavailable.');
      FIREBASE_ENABLED = false;
      // Don't block the user with an alert - let them continue in local mode
    }
  } else if (FIREBASE_ENABLED) {
    console.error('Firebase configuration is invalid. Please verify your Firebase settings.');
    console.warn('Continuing in local-only mode. Firebase features will be unavailable.');
    FIREBASE_ENABLED = false;
  }
  
  /**
   * Check if Firebase Authentication is available and enabled
   * @returns {boolean}
   */
  function isFirebaseAuthEnabled() {
    return FIREBASE_ENABLED && firebaseAuth !== null;
  }
  
  /**
   * Firebase Sign Up with Email/Password
   * Creates a new Firebase user and maps to local app state
   * @param {string} email - User email
   * @param {string} password - User password
   * @returns {Promise<{success: boolean, user?: object, error?: string}>}
   */
  async function firebaseSignUp(email, password) {
    if (!isFirebaseAuthEnabled()) {
      return { success: false, error: 'Firebase not configured' };
    }
    
    try {
      var userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
      var user = userCredential.user;
      return { 
        success: true, 
        user: {
          uid: user.uid,
          email: user.email,
          emailVerified: user.emailVerified
        }
      };
    } catch (error) {
      var errorMessage = 'Sign up failed';
      switch (error.code) {
        case 'auth/email-already-in-use':
          errorMessage = 'Email already registered';
          break;
        case 'auth/invalid-email':
          errorMessage = 'Invalid email address';
          break;
        case 'auth/weak-password':
          errorMessage = 'Password is too weak (min 6 characters)';
          break;
        case 'auth/operation-not-allowed':
          errorMessage = 'Email/password sign up is not enabled';
          break;
        default:
          errorMessage = error.message || 'Sign up failed';
      }
      return { success: false, error: errorMessage };
    }
  }
  
  /**
   * Firebase Sign In with Email/Password
   * @param {string} email - User email
   * @param {string} password - User password
   * @returns {Promise<{success: boolean, user?: object, error?: string}>}
   */
  async function firebaseSignIn(email, password) {
    if (!isFirebaseAuthEnabled()) {
      return { success: false, error: 'Firebase not configured' };
    }
    
    try {
      var userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
      var user = userCredential.user;
      return { 
        success: true, 
        user: {
          uid: user.uid,
          email: user.email,
          emailVerified: user.emailVerified
        }
      };
    } catch (error) {
      var errorMessage = 'Sign in failed';
      switch (error.code) {
        case 'auth/invalid-email':
          errorMessage = 'Invalid email address';
          break;
        case 'auth/user-disabled':
          errorMessage = 'This account has been disabled';
          break;
        case 'auth/user-not-found':
          errorMessage = 'No account found with this email';
          break;
        case 'auth/wrong-password':
          errorMessage = 'Invalid credentials';
          break;
        case 'auth/invalid-credential':
          errorMessage = 'Invalid email or password';
          break;
        case 'auth/too-many-requests':
          errorMessage = 'Too many failed attempts. Please try again later';
          break;
        default:
          errorMessage = error.message || 'Sign in failed';
      }
      return { success: false, error: errorMessage };
    }
  }
  
  /**
   * Firebase Sign Out
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  async function firebaseSignOut() {
    if (!isFirebaseAuthEnabled()) {
      return { success: false, error: 'Firebase not configured' };
    }
    
    try {
      await firebaseAuth.signOut();
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message || 'Sign out failed' };
    }
  }
  
  /**
   * Firebase Send Password Reset Email
   * Uses Firebase's hosted password reset page
   * @param {string} email - User email
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  async function firebaseSendPasswordReset(email) {
    if (!isFirebaseAuthEnabled()) {
      return { success: false, error: 'Firebase not configured' };
    }
    
    try {
      await firebaseAuth.sendPasswordResetEmail(email);
      return { success: true };
    } catch (error) {
      var errorMessage = 'Password reset failed';
      switch (error.code) {
        case 'auth/invalid-email':
          errorMessage = 'Invalid email address';
          break;
        case 'auth/user-not-found':
          errorMessage = 'No account found with this email';
          break;
        case 'auth/too-many-requests':
          errorMessage = 'Too many requests. Please try again later';
          break;
        default:
          errorMessage = error.message || 'Password reset failed';
      }
      return { success: false, error: errorMessage };
    }
  }
  
  /**
   * Get current Firebase user
   * @returns {object|null} Firebase user object or null
   */
  function getFirebaseCurrentUser() {
    if (!isFirebaseAuthEnabled()) {
      return null;
    }
    return firebaseAuth.currentUser;
  }
  
  /**
   * Maps Firebase UID to local app user ID
   * Used to associate localStorage data with Firebase user
   * @param {string} firebaseUid - Firebase user UID
   * @returns {string|null} Local user ID or null
   */
  function getLocalUserIdFromFirebaseUid(firebaseUid) {
    var storageKey = (typeof STORAGE_KEY !== 'undefined') ? STORAGE_KEY : 'ntc_full_accounting_v2';
    try {
      var raw = localStorage.getItem(storageKey);
      if (!raw) return null;
      var state = JSON.parse(raw);
      var user = (state.users || []).find(function(u) { return u.firebaseUid === firebaseUid; });
      return user ? user.id : null;
    } catch (e) {
      return null;
    }
  }
  
  /**
   * Maps local user ID to Firebase UID in state
   * @param {string} localUserId - Local app user ID
   * @param {string} firebaseUid - Firebase user UID
   */
  function mapLocalUserToFirebaseUid(localUserId, firebaseUid) {
    var storageKey = (typeof STORAGE_KEY !== 'undefined') ? STORAGE_KEY : 'ntc_full_accounting_v2';
    try {
      var raw = localStorage.getItem(storageKey);
      if (!raw) return;
      var appState = JSON.parse(raw);
      var user = (appState.users || []).find(function(u) { return u.id === localUserId; });
      if (user) {
        user.firebaseUid = firebaseUid;
        localStorage.setItem(storageKey, JSON.stringify(appState));
      }
    } catch (e) {
      console.warn('Failed to map local user to Firebase UID:', e);
    }
  }
  </script>
  
  <!-- jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- Pre-login overlay - blocks access until user signs in -->
  <div id="preLoginOverlay" class="prelogin-overlay">
    <div class="prelogin-card prelogin-card-wide">
      <h2>Taxpro â€” Nigeria Tax Calculator</h2>
      <p class="prelogin-tagline">Accurate Taxes, Real Time Filing</p>

      <!-- Offer countdown timer -->
      <div id="preloginOfferBox" class="offer-countdown-box">
        <div class="countdown-label">ðŸ”¥ Limited Time Offer Ends In:</div>
        <div class="countdown-value" id="preloginCountdown">3d 00:00:00</div>
      </div>

      <!-- Pricing Plan Cards -->
      <div class="plan-cards">
        <!-- Business Plan (formerly Enterprise) -->
        <details class="plan-card highlight">
          <summary>
            <div class="plan-header-left">
              <h3>Business <span class="plan-badge">7-day trial</span></h3>
            </div>
            <div class="plan-header-right">
              <span class="plan-offer-price">â‚¦40,000/year</span>
              <span class="plan-arrow">â–¼</span>
            </div>
          </summary>
          <div class="plan-pricing">
            <div class="plan-full-price">â‚¦60,000/year</div>
            <div class="plan-offer-price">â‚¦40,000/year</div>
          </div>
          <ul class="plan-features">
            <li>2 Users + Tax Advisor</li>
            <li>Record Income &amp; Expenses &amp; Profits</li>
            <li>Track VAT, WHT, PAYE and PIT</li>
            <li>Tax Support via Chat and Email</li>
          </ul>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="businessApplyOffer" checked />
            <label for="businessApplyOffer">Apply Buy Now Offer</label>
          </div>

          <div style="margin-top:10px;padding:8px;background:#f9fafb;border-radius:6px;border:1px solid #e6e9ef;">
            <div class="plan-checkbox-row">
              <input type="checkbox" id="businessHireTaxAccountant" />
              <label for="businessHireTaxAccountant">Add Tax Accountant Service <span class="addon-price">(+â‚¦25,000/month)</span> (Monthend Adjustment &amp; Tax Filing)</label>
            </div>
            <div class="plan-checkbox-row" style="margin-top:8px;">
              <input type="checkbox" id="businessBookkeepingService" />
              <label for="businessBookkeepingService">Add Bookkeeping and Tax Service <span class="addon-price">(+â‚¦75,000/month)</span></label>
            </div>
          </div>

          <div class="plan-total">
            <div class="plan-total-label">Total</div>
            <div class="plan-total-value" id="businessTotal">â‚¦40,000</div>
          </div>
          <div class="plan-buttons-container">
            <a href="https://buy.stripe.com/business-plan" target="_blank" rel="noopener noreferrer" class="plan-buy-btn" id="businessBuyLink">Buy Now</a>
          </div>
        </details>

        <!-- Company Plan -->
        <details class="plan-card highlight">
          <summary>
            <div class="plan-header-left">
              <h3>Company <span class="plan-badge">7-day trial</span></h3>
            </div>
            <div class="plan-header-right">
              <span class="plan-offer-price">â‚¦60,000/year</span>
              <span class="plan-arrow">â–¼</span>
            </div>
          </summary>
          <div class="plan-pricing">
            <div class="plan-full-price">â‚¦80,000/year</div>
            <div class="plan-offer-price">â‚¦60,000/year</div>
          </div>
          <ul class="plan-features">
            <li>3 Users + Tax Advisor</li>
            <li>Record Income &amp; Expenses &amp; Profits</li>
            <li>Track VAT, WHT, PAYE, CGT, and CIT</li>
            <li>Tax Support via Chat and Email</li>
          </ul>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="companyApplyOffer" checked />
            <label for="companyApplyOffer">Apply Buy Now Offer</label>
          </div>

          <div style="margin-top:10px;padding:8px;background:#f9fafb;border-radius:6px;border:1px solid #e6e9ef;">
            <div class="plan-checkbox-row">
              <input type="checkbox" id="companyHireTaxAccountant" />
              <label for="companyHireTaxAccountant">Add Tax Accountant Service <span class="addon-price">(+â‚¦25,000/month)</span> (Monthend Adjustment &amp; Tax Filing)</label>
            </div>
            <div class="plan-checkbox-row" style="margin-top:8px;">
              <input type="checkbox" id="companyBookkeepingService" />
              <label for="companyBookkeepingService">Add Bookkeeping and Tax Service <span class="addon-price">(+â‚¦100,000/month)</span></label>
            </div>
          </div>

          <div class="plan-total">
            <div class="plan-total-label">Total</div>
            <div class="plan-total-value" id="companyTotal">â‚¦60,000</div>
          </div>
          <div class="plan-buttons-container">
            <a href="https://buy.stripe.com/company-plan" target="_blank" rel="noopener noreferrer" class="plan-buy-btn" id="companyBuyLink">Buy Now</a>
          </div>
        </details>

        <!-- New Enterprise Plan -->
        <details class="plan-card highlight">
          <summary>
            <div class="plan-header-left">
              <h3>Enterprise <span class="plan-badge">7-day trial</span></h3>
            </div>
            <div class="plan-header-right">
              <span class="plan-offer-price">â‚¦100,000/year</span>
              <span class="plan-arrow">â–¼</span>
            </div>
          </summary>
          <div class="plan-pricing">
            <div class="plan-full-price">â‚¦150,000/year</div>
            <div class="plan-offer-price">â‚¦100,000/year</div>
          </div>
          <ul class="plan-features">
            <li>Designed for Accountants and Multi-Business</li>
            <li>Includes 3 Subscription Plans (Enterprise/Company)</li>
            <li>Track VAT, WHT, PAYE, CGT, PIT, and CIT</li>
            <li>Tax Financial Report</li>
            <li>Earn Monthly Revenues on Tax Hire</li>
            <li>Tax Support via Chat and Email</li>
          </ul>
          <div class="plan-checkbox-row">
            <input type="checkbox" id="enterpriseApplyOffer" checked />
            <label for="enterpriseApplyOffer">Apply Buy Now Offer</label>
          </div>

          <div class="plan-total">
            <div class="plan-total-label">Total</div>
            <div class="plan-total-value" id="enterpriseTotal">â‚¦100,000</div>
          </div>
          <div class="plan-buttons-container">
            <a href="https://buy.stripe.com/enterprise-plan" target="_blank" rel="noopener noreferrer" class="plan-buy-btn" id="enterpriseBuyLink">Buy Now</a>
          </div>
        </details>

      </div>

      <p class="prelogin-subtitle">Sign in or create an account to continue</p>

      <!-- Auth tabs (merged from auth.html) -->
      <div class="auth-tabs">
        <button id="authTabLogin" class="tab active">Login</button>
        <button id="authTabSignup" class="tab">Sign up</button>
      </div>

      <!-- Login panel -->
      <div id="authLoginPanel" class="auth-panel prelogin-form">
        <label>Email:
          <input type="email" id="preLoginUsername" placeholder="Enter your email address" autocomplete="email" />
        </label>
        <label>Password:
          <input type="password" id="preLoginPassword" placeholder="Enter password" autocomplete="current-password" />
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="primary prelogin-btn" id="preLoginSubmit">Sign In</button>
          <a href="#" id="authForgotPassword" class="link-like" style="font-size:0.9rem;">Forgot Password?</a>
        </div>
        <p id="authLoginMsg" class="auth-msg"></p>
      </div>

      <!-- Signup panel (merged from auth.html) -->
      <div id="authSignupPanel" class="auth-panel prelogin-form hidden">
        <label>Full Name:
          <input type="text" id="authSignupName" placeholder="Enter your full name" autocomplete="name" required />
        </label>
        <label>Username:
          <input type="text" id="authSignupUsername" placeholder="Choose a username" autocomplete="username" required />
        </label>
        <label>Email:
          <input type="email" id="authSignupEmail" placeholder="your@email.com" autocomplete="email" required />
        </label>
        <label>Password (min 6 chars):
          <input type="password" id="authSignupPassword" placeholder="Choose a password" autocomplete="new-password" minlength="6" required />
        </label>
        <label>Confirm Password:
          <input type="password" id="authSignupPassword2" placeholder="Confirm password" minlength="6" required />
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="primary prelogin-btn" id="authSignupSubmit">Create Account</button>
          <button class="prelogin-btn" id="authSignupCancel" type="button">Cancel</button>
        </div>
        <p id="authSignupMsg" class="auth-msg"></p>
      </div>

      <p class="prelogin-note" id="authModeNote">Secure authentication powered by Firebase. Your data is stored locally in your browser.</p>
      
      <!-- Demo access button (shown when Firebase is unavailable) -->
      <div id="demoAccessContainer" style="display:none; margin-top:16px; padding-top:16px; border-top:1px solid #e6e6e6;">
        <button class="primary prelogin-btn" id="btnDemoAccess" style="width:100%;">Continue in Demo Mode</button>
        <p class="prelogin-note" style="margin-top:8px; color:#b00;">Authentication service is currently unavailable. You can continue in demo mode with local storage only.</p>
      </div>
    </div>
  </div>

  <header>
    <h1>Taxpro â€” Nigeria Tax Calculator</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnDashboardTab">Dashboard</button>
        <button class="tab" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnCashbookTab">Cashbook</button>
        <button class="tab" id="btnReportsTab">Reports</button>
        <button class="tab" id="btnBankReconciliationTab">Bank Reconciliation</button>

      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnLogin" class="small primary">Login</button>
        <button id="btnLogout" class="small" style="display:none;">Logout</button>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
      </div>
    </div>
  </header>

  <!-- Hero Promo Section removed - pricing shown only in pre-login overlay -->

  <main>
    <!-- Dashboard Section -->
    <section id="dashboardSection" class="panel section">
      <h2 style="margin:0 0 12px 0;">Dashboard</h2>
      
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Business Summary</h3>
          <div id="dashboardBusinessInfo"></div>
        </div>
        
        <div class="dashboard-card">
          <h3>Snapshot Summary</h3>
          <div id="dashboardSnapshotSummary"></div>
        </div>
        
        <div class="dashboard-card">
          <h3>Tax Summary</h3>
          <div id="dashboardTaxSummary"></div>
        </div>
      </div>
      
      <div class="dashboard-grid">
        <div class="dashboard-card" style="grid-column:1/-1;">
          <h3>Recent Transactions (Last 10)</h3>
          <div id="dashboardRecentTransactions"></div>
        </div>
      </div>
      
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h3>Quick Navigation</h3>
          <div style="padding:10px 0;">
            <button class="dashboard-nav-btn" onclick="activeTab='ledger';renderTab();">Go to Ledger</button>
            <button class="dashboard-nav-btn" onclick="activeTab='reports';renderTab();">Go to Reports</button>
          </div>
        </div>
      </div>
    </section>

    <section id="ledgerSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="Investment Income">Investment Income</option>
            <option value="AssetPurchase">Asset Purchase</option>
            <option value="AssetDisposal">Asset Disposal</option>
            <option value="OpeningAssetBal">Opening Asset Bal</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (â‚¦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label" id="txnWhtLabel">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

        <label id="txnAdjustmentLabel">Adjustment:
          <select id="txnAdjustmentType">
            <option value="">None</option>
            <option value="disallowable">Disallowable expense</option>
            <option value="nontaxable">Non-taxable income</option>
          </select>
        </label>
        <label id="txnAdjustmentAmountLabel" style="display:none;">Amt (â‚¦): <input type="number" id="txnAdjustmentAmount" class="smallInput" min="0" step="0.01" /></label>

        <label>Contact:
          <div style="display:flex;gap:4px;align-items:center;">
            <input type="text" id="txnContact" placeholder="Contact name" list="contactSuggestions" />
            <datalist id="contactSuggestions">
              <!-- Populated dynamically from business contacts -->
            </datalist>
            <div style="position:relative;">
              <button type="button" class="small" id="btnSelectContact" style="padding:6px 8px;">Add</button>
              <div id="contactDropdown" style="display:none;position:absolute;top:100%;right:0;background:#fff;border:1px solid #cfcfcf;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);min-width:180px;z-index:10;margin-top:2px;">
                <div style="padding:8px;border-bottom:1px solid #e6e6e6;font-weight:600;font-size:0.85rem;">Select Type</div>
                <button type="button" class="contact-type-option" data-type="Employee" style="display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:0.9rem;" onmouseover="this.style.background='#f8f9fb'" onmouseout="this.style.background='none'">
                  Employee
                  <select class="contact-name-select" data-type="Employee" style="display:block;width:100%;margin-top:4px;padding:4px;border:1px solid #cfcfcf;border-radius:4px;font-size:0.85rem;" onclick="event.stopPropagation()">
                    <option value="">Select employee...</option>
                  </select>
                </button>
              </div>
            </div>
          </div>
        </label>

        <label id="txnPaymentStatusLabel">Payment Status:
          <select id="txnPaymentStatus">
            <option value="Paid">Paid</option>
            <option value="Part">Part</option>
            <option value="Unpaid">Unpaid</option>
          </select>
        </label>
        <label id="txnPartAmountLabel" style="display:none;">Part Amt Paid (â‚¦): <input type="number" id="txnPartAmount" min="0" step="0.01" /></label>
        <label id="txnAmortPeriodLabel" style="display:none;">Amort. Period (months): <input type="number" id="txnAmortPeriod" min="2" max="12" step="1" class="smallInput" /></label>
        <label id="txnAmortAccountLabel" style="display:none;">Amortise to Account: <select id="txnAmortAccount"></select></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (â‚¦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label>Opening Qty: <input type="number" id="invOpeningQty" min="0" step="1" /></label>
          <label>Opening Avg Cost (â‚¦): <input type="number" id="invOpeningAvgCost" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label id="invPaymentStatusLabel">Payment Status:
            <select id="invPaymentStatus">
              <option value="Paid">Paid</option>
              <option value="Part">Part</option>
              <option value="Unpaid">Unpaid</option>
            </select>
          </label>
          <label id="invPartAmountLabel" style="display:none;">Part Amt Paid (â‚¦): <input type="number" id="invPartAmount" min="0" step="0.01" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small primary">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetPurchaseSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Asset Purchase</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" list="assetNameSuggestions" /></label>
          <datalist id="assetNameSuggestions">
            <!-- Populated dynamically based on category selection -->
          </datalist>
          <label>Category:
            <select id="assetCategory">
              <option value="Property Plant and Equipment">Property Plant and Equipment</option>
              <option value="Furniture & Fittings">Furniture & Fittings</option>
              <option value="Motor Vehicles">Motor Vehicles</option>
              <option value="Land & Building">Land & Building</option>
              <option value="Shares">Shares</option>
              <option value="Other Asset">Other Asset</option>
            </select>
          </label>
          <label>Qty: <input type="number" id="assetQty" min="1" step="1" class="smallInput" value="1" /></label>
          <label>Unit Price (â‚¦): <input type="number" id="assetUnitPrice" min="0" step="0.01" /></label>
          <label>Cost (â‚¦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Opening Cost (â‚¦): <input type="number" id="assetOpeningCost" min="0" step="0.01" /></label>
          <label>Opening Accumulated Depreciation (â‚¦): <input type="number" id="assetOpeningAccDep" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label style="display:none;">Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>
          <small class="note">Bank credited automatically on asset purchase.</small>

          <label>Classification:
            <select id="assetClassification">
              <option value="Fixed">Fixed</option>
              <option value="Chargeable">Chargeable</option>
            </select>
          </label>

          <label>Depreciation rate % (annual): <input type="number" id="assetDepRate" class="smallInput" min="0" step="0.01" /></label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>

          <label id="assetPaymentStatusLabel">Payment Status:
            <select id="assetPaymentStatus">
              <option value="Paid">Paid</option>
              <option value="Part">Part</option>
              <option value="Unpaid">Unpaid</option>
            </select>
          </label>
          <label id="assetPartAmountLabel" style="display:none;">Part Amt Paid (â‚¦): <input type="number" id="assetPartAmount" min="0" step="0.01" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small primary">Record Asset Purchase</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Depreciation & capital allowance computed daily (prorated); asset schedule shows quantity and unit price.</small>
      </div>

      <div id="assetDisposalSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Asset Disposal</h3>
        <div class="form-inline">
          <label>Asset to dispose:
            <select id="assetDisposeSelect"></select>
          </label>
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Quantity to dispose: <input type="number" id="assetDisposalQty" min="1" step="1" class="smallInput" value="1" /></label>
          <label>Disposal proceeds (â‚¦): <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label style="display:none;">Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>
          <small class="note">Bank debited automatically on asset disposal.</small>
          <label>Contact: <input type="text" id="assetDisposalContact" placeholder="Contact name" /></label>
          <label>Receipt: <input type="file" id="assetDisposalReceipt" /></label>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetDisposalCancel" class="small">Cancel</button>
          <button id="btnAssetDisposalUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Chargeable gains and losses will be classified based on asset classification and included in tax calculations according to entity rules. Profit/loss = proceeds - tax written down value (TWDV = â‚¦10 residual at end of life).</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Payment</th><th>Contact</th><th>Receipt</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <!-- Cashbook Section -->
    <section id="cashbookSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Cashbook</h2>
      <div class="tabbar" style="margin-bottom:10px;">
        <button class="tab active" id="cashbookTabAll" onclick="switchCashbookTab('all')">All</button>
        <button class="tab" id="cashbookTabReceipts" onclick="switchCashbookTab('receipts')">Receipts</button>
        <button class="tab" id="cashbookTabPayments" onclick="switchCashbookTab('payments')">Payments</button>
      </div>
      <div class="form-inline" style="margin-bottom:10px;">
        <label>Date: <input type="date" id="cashbookDate" /></label>
        <label>Description: <input type="text" id="cashbookDesc" placeholder="Description" /></label>
        <label>Bank/Cash Account: <select id="cashbookBankAccount"></select></label>
        <label>Counterparty Account: <select id="cashbookCounterparty"></select></label>
        <label>Receipts amount (â‚¦): <input type="number" id="cashbookReceiptsAmt" min="0" step="0.01" placeholder="0.00" /></label>
        <label>Payments amount (â‚¦): <input type="number" id="cashbookPaymentsAmt" min="0" step="0.01" placeholder="0.00" /></label>
        <button class="small primary" id="btnAddCashbookEntry">Add Entry</button>
      </div>
      <div class="table-scroll">
        <table class="ledger-table" id="cashbookTable">
          <thead>
            <tr>
              <th>Date</th><th>Description</th><th>Receipts (â‚¦)</th><th>Payments (â‚¦)</th><th>Balance (â‚¦)</th>
            </tr>
          </thead>
          <tbody id="cashbookTableBody"></tbody>
        </table>
      </div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Report</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtReport">WHT Report</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="pitBusiness">PIT Report</button>
        <button class="small tab" data-report="citReport">CIT Report</button>
        <button class="small tab" data-report="cgtReport">CGT Report</button>
        <button class="small tab" data-report="financialReport">Financial</button>
        <button class="small tab" data-report="inventoryReport">Inventory Schedule</button>
        <button class="small tab" data-report="assetsReport">Asset Schedule</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
        <button id="btnExportXlsx" class="small">Export XLSX (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <!-- Bank Reconciliation Section -->
    <section id="bankReconciliationSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Bank Reconciliation</h2>
      <div class="notice" style="margin-bottom:12px;">
        This feature is available for Enterprise plan users.
      </div>
      <p>Bank reconciliation functionality to match transactions with bank statements.</p>
      <p class="muted">This is a placeholder for the Bank Reconciliation module. Full implementation coming soon.</p>
    </section>

    <!-- Journal Entry Section -->
    <section id="journalEntrySection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Journal Entry</h2>
      <div class="notice" style="margin-bottom:12px;">
        This feature is available for Enterprise plan users.
      </div>
      <p>Manual journal entry functionality for accounting adjustments.</p>
      <p class="muted">This is a placeholder for the Journal Entry module. Full implementation coming soon.</p>
    </section>

    <!-- Payables Section -->
    <section id="payablesSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Payables</h2>
      <div class="notice" style="margin-bottom:12px;">
        This feature is available for Enterprise plan users.
      </div>
      <p>Manage accounts payable and vendor payments.</p>
      <p class="muted">This is a placeholder for the Payables module. Full implementation coming soon.</p>
    </section>

  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <!-- User modal -->
  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Email: <input type="email" id="userEmail" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Password: <input type="password" id="userPassword" placeholder="Required for new users" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <!-- Business modal -->
   <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="Business">Business</option>
          <option value="Enterprise">Enterprise</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label id="bizTurnoverThresholdLabel">Turnover Threshold (CIT):
        <select id="bizTurnoverThresholdSelect" class="smallInput">
          <option value="50000000">â‚¦50,000,000</option>
          <option value="100000000">â‚¦100,000,000</option>
        </select>
      </label>
      <!-- WHT/CIT fields hidden but preserved in data via hidden inputs -->
      <input type="hidden" id="bizWht" />
      <input type="hidden" id="bizCit" />
      <input type="hidden" id="bizTurnoverThreshold" />
    </div>

    <div class="row" style="margin-top:6px;">
      <label>Accounting Period Start:
        <input type="date" id="bizPeriodStart" class="smallInput" />
      </label>
      <label>Accounting Period End:
        <input type="date" id="bizPeriodEnd" class="smallInput" />
      </label>
      <small class="note" style="align-self:center;">Opening balances apply at period start.</small>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <!-- CIT enabled checkbox hidden but preserved -->
      <input type="hidden" id="bizCitEnabled" />
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (â‚¦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA broughtforward (â‚¦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Retained Profit b/f (â‚¦): <input type="number" id="bizRetainedProfitBF" class="smallInput" step="0.01" placeholder="0" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Employee Statutory Deductions</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add a contact with type "SoleTrader" (or name "Sole trader") and set statutory deductions there if you want PIT to use per-sole-trader deductions.</small>
      </div>

      <div id="annualStatutoryDeductionsSection" style="margin-top:8px; display:none;">
        <h4 style="margin:6px 0 4px 0;">Annual Statutory Deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (â‚¦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (â‚¦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (â‚¦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (â‚¦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (â‚¦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
          <label>NHIS (â‚¦): <input type="number" id="bizDedNHIS" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (SoleTrader), that will override these values for PIT.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <!-- Accounts modal -->
  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="max-height:360px; overflow:auto;"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
        <option value="Revenue">Revenue</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountDisallowable" /> Disallowable</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountNonTax" /> Non-taxable</label>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <!-- Contact Edit Modal - for editing contact statutory deductions -->
  <div id="contactEditModal" class="modal">
    <h3 id="contactEditModalTitle">Edit Contact</h3>
    <div class="row">
      <label>Name: <input type="text" id="contactEditName" /></label>
      <label>Type:
        <select id="contactEditType">
          <option value="Employee">Employee</option>
          <option value="SoleTrader">SoleTrader</option>
        </select>
      </label>
    </div>
    <div class="form-section" id="contactDeductionsSection">
      <h4 style="margin:6px 0 4px 0;">Statutory Deductions (for SoleTrader/Employee)</h4>
      <div class="row">
        <label>Pension (â‚¦): <input type="number" id="contactDedPension" class="smallInput" min="0" step="0.01" /></label>
        <label>Rent relief (â‚¦): <input type="number" id="contactDedRent" class="smallInput" min="0" step="0.01" /></label>
        <label>Life assurance (â‚¦): <input type="number" id="contactDedLife" class="smallInput" min="0" step="0.01" /></label>
      </div>
      <div class="row">
        <label>Mortgage interest (â‚¦): <input type="number" id="contactDedMortgage" class="smallInput" min="0" step="0.01" /></label>
        <label>NHF (â‚¦): <input type="number" id="contactDedNHF" class="smallInput" min="0" step="0.01" /></label>
        <label>NHIS (â‚¦): <input type="number" id="contactDedNHIS" class="smallInput" min="0" step="0.01" /></label>
      </div>
      <small class="note">These deductions override business-level statutory deductions when computing PIT/PAYE for this contact.</small>
    </div>
    <input type="hidden" id="contactEditId" />
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="contactEditCancel">Cancel</button>
      <button class="primary" id="contactEditSave">Save</button>
    </div>
  </div>

  <!-- Login modal -->
  <div id="loginModal" class="modal">
    <h3>Login</h3>
    <div class="row">
      <label>Username: <input type="text" id="loginUsername" /></label>
      <label>Password: <input type="password" id="loginPassword" placeholder="(optional)" /></label>
    </div>
    <small class="note">Secure authentication powered by Firebase.</small>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="loginCancel">Cancel</button>
      <button class="primary" id="loginSubmit">Login</button>
    </div>
  </div>

<div id="signupModal" class="modal">
  <h3>Signup â€” Nigeria Tax (7-day trial)</h3>
  <div class="row">
    <label>Name: <input type="text" id="signupName" required></label>
    <label>Username: <input type="text" id="signupUsername" required></label>
    <label>Email: <input type="email" id="signupEmail" required placeholder="your@email.com"></label>
  </div>
  <div class="row">
    <label>Phone: <input type="tel" id="signupPhone" placeholder="e.g. +234..."></label>
    <label>Password: <input type="password" id="signupPassword" minlength="6" placeholder="Min 6 characters" required></label>
    <label>Plan:
      <select id="signupPlan">
        <option value="Business">Business</option>
        <option value="Company">Company</option>
        <option value="Enterprise">Enterprise</option>
      </select>
    </label>
  </div>
  <small class="note">Account valid for 7 days from signup. A notification will be sent to salesrepng@gmail.com.</small>
  <small class="note" style="display:block;margin-top:4px;color:#555;">Secure authentication powered by Firebase. Your credentials are safely managed by Firebase Authentication.</small>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
    <button id="signupCancel">Cancel</button>
    <button class="primary" id="signupSubmit">Create account</button>
  </div>
</div>

<div id="forgotModal" class="modal">
  <h3>Forgot Password</h3>
  <div class="row">
    <label>Email: <input type="email" id="forgotEmail" placeholder="Enter your email address"></label>
  </div>
  <div id="forgotModeNote">
    <small class="note" id="forgotNoteFirebase" style="display:none;">Enter your email address and we'll send you a password reset link.</small>
    <small class="note" id="forgotNoteLocal">We will open an email request to the admin/sales team to process the reset. If you are the user, contact your admin to reset.</small>
  </div>
  <p id="forgotMsg" class="auth-msg"></p>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
    <button id="forgotCancel">Cancel</button>
    <button class="primary" id="forgotSubmit">Send Reset Link</button>
  </div>
</div>

<!-- Entity Selection Modal - shown after signup -->
<div id="entitySelectModal" class="modal">
  <h3>Select Your Entity Type</h3>
  <p class="muted">Please confirm the type of entity you'll be using this account for:</p>
  <div class="row">
    <label>Entity Type:
      <select id="entitySelectType">
        <option value="Business">Business</option>
        <option value="Company">Company</option>
        <option value="Enterprise">Enterprise</option>
      </select>
    </label>
  </div>
  <small class="note">This will create a default business for your account with the selected entity type.</small>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
    <button class="primary" id="entitySelectConfirm">Confirm & Continue</button>
  </div>
</div>

<!-- Video Tour Modal - shown first time after signup -->
<div id="videoTourModal" class="modal" style="text-align:center;">
  <h3>Welcome to Simplify Your Taxes with Taxpro!</h3>
  <p class="muted">Take a quick 5-minute tour to learn how to use the app.</p>
  <div id="videoTourContainer" style="margin:16px 0;">
    <iframe id="tourVideoIframe" width="560" height="315" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
  </div>
  <div style="display:flex;gap:8px;justify-content:center;margin-top:10px;">
    <button id="videoTourSkip">Skip Tour</button>
    <button class="primary" id="videoTourWatch">Watch Tour</button>
  </div>
  <small class="note" style="margin-top:8px;display:block;">The tour will auto-close after 5 minutes if not dismissed.</small>
</div>

  <footer class="muted" style="margin-top:16px;">Taxpro â€” Accurate Taxes, Real time filing â€” data stored in localStorage (ntc_full_accounting_v1)</footer>

  <script>
  /************************************************************************
   * Nigeria Multi-User Multi-Business Accounting & Tax Engine
   * Enhanced Version 2.0 - Comprehensive Tax & Entity Management
   * 
   * CHANGELOG:
   * - Renamed SoleProprietor â†’ Enterprise
   * - Added Individual entity type with restricted UI/tax rules
   * - Updated transaction action from Income to Revenue (backwards compatible migration included)
   * - Added turnoverThreshold configuration (0, 50M, 100M)
   * - Enhanced asset management with opening balances
   * - Improved tax calculations for PIT, CIT, CGT with thresholds
   * - Added comprehensive account types
   * - Enhanced VAT/WHT calculations (inclusive/net options)
   * - Added SHA-256 password hashing for secure credential storage
   * - Added email uniqueness validation at signup
   * - Added entity selection step after signup
   * - Added video tour modal for new users
   * - Added 3-user limit per business enforcement
   ************************************************************************/

  // Video tour YouTube hash - replace with actual video hash
  const TOUR_VIDEO_HASH = 'REPLACE_ME_YOUTUBE_HASH';
  
  // Maximum users allowed per business (including owner) - UNLIMITED
  const MAX_USERS_PER_BUSINESS = Infinity; // Changed from 3 to Infinity to allow unlimited users

  /**
   * SHA-256 hashing utility using the Web Crypto API.
   * Used for admin-created local user passwords (not Firebase-authenticated users).
   * @param {string} message - Plain-text string to hash
   * @returns {Promise<string>} Hex-encoded SHA-256 digest
   */
  async function sha256Hex(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // Constants & defaults
  const STORAGE_KEY = 'ntc_full_accounting_v2'; // Updated storage key for migration
  const DEFAULTS = { 
    vatRate:7.5, whtRate:5.0, citRate:25.0,
    vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, 
    caRateDefault:20.0, depRateDefault:20.0, turnoverThreshold:100000000 
  };
  
  // PIT/PAYE bands per Nigerian tax law (updated to match requirements)
  const PAYE_BANDS = [
    { upTo: 800000, rate: 0.00 },       // First â‚¦800,000 @ 0%
    { upTo: 3000000, rate: 0.15 },      // Next â‚¦2,200,000 @ 15%
    { upTo: 12000000, rate: 0.18 },     // Next â‚¦9,000,000 @ 18%
    { upTo: 25000000, rate: 0.21 },     // Next â‚¦13,000,000 @ 21%
    { upTo: 50000000, rate: 0.23 },     // Next â‚¦25,000,000 @ 23%
    { upTo: Infinity, rate: 0.25 }      // Above â‚¦50,000,000 @ 25%
  ];
  
  // CIT Turnover threshold options
  const CIT_THRESHOLDS = {
    NONE: 0,
    MEDIUM: 50000000,   // â‚¦50,000,000
    LARGE: 100000000    // â‚¦100,000,000
  };
  
  // Tax calculation constants
  const ASSET_RESIDUAL_VALUE = 10; // â‚¦10 residual at end of useful life
  const NON_TAXABLE_INCOME_CA_THRESHOLD = 0.10; // 10% threshold for CA relief
  const CGT_EXEMPTION_PROCEEDS = 150000000; // â‚¦150,000,000
  const CGT_EXEMPTION_GAIN = 10000000; // â‚¦10,000,000
  const CGT_RATE = 0.10; // 10% Capital Gains Tax rate
  
  // Tax payment account names - used to exclude from P&L and track tax payments
  // These match the account names created by the payTax() function
  const TAX_PAYMENT_ACCOUNTS = ['VAT Paid', 'VAT Refunded', 'WHT Remitted', 'PAYE Paid', 'PIT Paid', 'CIT Paid', 'CGT Paid'];
  
  // Common account names constants (no longer used for filtering)
  const COMMON_ACCOUNTS = ['Salary', 'Dividend', 'Interest', 'Royalty', 'Share of profit'];

  // App state
  let state = {
    users: [], businesses: [], transactions: {}, attachments: {}, audit: [], auth: { currentUserId: null },
    invoices: {}, cashbook: {}, bankReconciliations: {}
  };
  let selectedUserId = null;
  let selectedBizId = null;
  let activeTab = 'dashboard';
  let inventoryHistory = [];
  let assetHistory = [];
  let videoTourTimeout = null; // Timer for auto-closing video tour

  /**
   * Creates a default business for a user after signup.
   * @param {string} userId - The user's ID
   * @param {string} entityType - The entity type (Individual/Enterprise/Company)
   * @returns {string} - The created business ID
   */
  function createBusinessForUser(userId, entityType) {
    const user = state.users.find(u => u.id === userId);
    if (!user) return null;
    
    // Determine how many businesses to create based on entity type
    let businessesToCreate = 1;
    if (entityType === 'Enterprise Plus' || entityType === 'Enterprise') {
      businessesToCreate = 3;
    }
    
    const createdBusinessIds = [];
    
    for (let i = 0; i < businessesToCreate; i++) {
      const bizId = uid('biz');
      // Removed Sales (Revenue) default account as per requirements
      const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 };
      
      const businessName = businessesToCreate > 1 
        ? (user.display || user.username) + "'s Business " + (i + 1)
        : (user.display || user.username) + "'s Business";
      
      const newBusiness = {
        id: bizId,
        name: businessName,
        ownerId: userId,
        entity: entityType,
        vatRate: DEFAULTS.vatRate,
        whtRate: DEFAULTS.whtRate,
        citRate: DEFAULTS.citRate,
        turnoverThreshold: DEFAULTS.turnoverThreshold,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault,
        depRateDefault: DEFAULTS.depRateDefault,
        accounts: [cogs, bank], // Removed sales account
        inventory: [],
        assets: [],
        contacts: [],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward: 0, caCarryForward: 0,
        defaultExpenseDisallowable: false, defaultRevenueNonTax: false,
        userIds: [userId], // Track users associated with this business
        maxUsers: entityType === 'Business' ? 2 : 3, // 2 for Business, 3 for Company/Enterprise
        trialStart: Date.now(),
        trialDays: 7,
        chargeableLosses: {}, // CGT: { year: { assetClassName: amount } }
        shareDisposalsByYear: {} // CGT: { year: { proceedsSum: number, gainSum: number } }
      };
      
      state.businesses.push(newBusiness);
      
      // Initialize transactions for this user/business combo
      if (!state.transactions[userId]) {
        state.transactions[userId] = {};
      }
      state.transactions[userId][bizId] = [];
      
      createdBusinessIds.push(bizId);
      addAudit('business.create', 'business', bizId, 'Default business created for user: ' + user.username);
    }
    
    saveState();
    
    // Return the first business ID
    return createdBusinessIds[0];
  }

  /**
   * Checks if a business can accept more users (enforces 3-user limit).
   * @param {string} bizId - The business ID to check
   * @returns {boolean} - True if more users can be added, false if limit reached
   */
  function canAddUserToBusiness(bizId) {
    const biz = state.businesses.find(b => b.id === bizId);
    if (!biz) return false;
    
    // Count users associated with this business
    // Include owner + any users in userIds array
    let userCount = 0;
    
    // Count from userIds array if it exists
    if (biz.userIds && Array.isArray(biz.userIds)) {
      userCount = biz.userIds.length;
    } else {
      // Fallback: count owner only
      userCount = 1;
    }
    
    return userCount < MAX_USERS_PER_BUSINESS;
  }

  /**
   * Gets the count of users associated with a business.
   * @param {string} bizId - The business ID
   * @returns {number} - Number of users
   */
  function getUserCountForBusiness(bizId) {
    const biz = state.businesses.find(b => b.id === bizId);
    if (!biz) return 0;
    
    if (biz.userIds && Array.isArray(biz.userIds)) {
      return biz.userIds.length;
    }
    return 1; // At least the owner
  }

  /**
   * Shows the video tour modal for new users.
   * @param {string} userId - The user ID for tracking
   */
  function showTourModal(userId) {
    const modal = document.getElementById('videoTourModal');
    const iframe = document.getElementById('tourVideoIframe');
    
    if (!modal || !iframe) return;
    
    // Set iframe src with autoplay
    iframe.src = 'https://www.youtube.com/embed/' + TOUR_VIDEO_HASH + '?autoplay=1&rel=0';
    
    // Log audit entry for tour shown
    addAudit('tour.shown', 'user', userId, 'Video tour modal displayed');
    
    // Open modal
    openModal(modal);
    
    // Auto-close after 5 minutes (300 seconds)
    if (videoTourTimeout) clearTimeout(videoTourTimeout);
    videoTourTimeout = setTimeout(function() {
      closeTourModal(userId, 'auto');
    }, 300000);
  }

  /**
   * Closes the video tour modal and marks tour as seen.
   * @param {string} userId - The user ID
   * @param {string} reason - 'skip', 'watch', or 'auto'
   */
  function closeTourModal(userId, reason) {
    const modal = document.getElementById('videoTourModal');
    const iframe = document.getElementById('tourVideoIframe');
    
    if (videoTourTimeout) {
      clearTimeout(videoTourTimeout);
      videoTourTimeout = null;
    }
    
    // Stop video
    if (iframe) iframe.src = '';
    
    // Mark tour as seen
    const user = state.users.find(u => u.id === userId);
    if (user) {
      user.tourSeen = true;
      saveState();
    }
    
    // Log audit entry
    addAudit('tour.closed', 'user', userId, 'Video tour closed: ' + reason);
    
    if (modal) closeModal(modal);
  }

  /**
   * Validates email format.
   * @param {string} email - Email to validate
   * @returns {boolean} - True if valid email format
   */
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  // DOM refs
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const txnReceipt = document.getElementById('txnReceipt');
  const txnPaymentStatus = document.getElementById('txnPaymentStatus');
  const txnPartAmount = document.getElementById('txnPartAmount');
  const txnPartAmountLabel = document.getElementById('txnPartAmountLabel');
  const btnAddTxn = document.getElementById('btnAddTxn');
  const mainTxnForm = document.getElementById('mainTxnForm');

  const inventorySubform = document.getElementById('inventorySubform');
  const invItemSelect = document.getElementById('invItemSelect');
  const invNewName = document.getElementById('invNewName');
  const invAccountSelect = document.getElementById('invAccountSelect');
  const invQty = document.getElementById('invQty');
  const invUnitPrice = document.getElementById('invUnitPrice');
  const invOpeningQty = document.getElementById('invOpeningQty');
  const invOpeningAvgCost = document.getElementById('invOpeningAvgCost');
  const invVatType = document.getElementById('invVatType');
  const invContact = document.getElementById('invContact');
  const invReceipt = document.getElementById('invReceipt');
  const btnAddInv = document.getElementById('btnAddInv');
  const btnInvCancel = document.getElementById('btnInvCancel');
  const btnInvUndo = document.getElementById('btnInvUndo');

  const assetPurchaseSubform = document.getElementById('assetPurchaseSubform');
  const assetDisposalSubform = document.getElementById('assetDisposalSubform');
  const assetName = document.getElementById('assetName');
  const assetCategory = document.getElementById('assetCategory');
  const assetQty = document.getElementById('assetQty');
  const assetUnitPrice = document.getElementById('assetUnitPrice');
  const assetCost = document.getElementById('assetCost');
  const assetOpeningCost = document.getElementById('assetOpeningCost');
  const assetOpeningAccDep = document.getElementById('assetOpeningAccDep');
  const assetPurchaseDate = document.getElementById('assetPurchaseDate');
  const assetLife = document.getElementById('assetLife');
  const assetCA = document.getElementById('assetCA');
  const assetDisposalDate = document.getElementById('assetDisposalDate');
  const assetDisposalQty = document.getElementById('assetDisposalQty');
  const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
  const btnAddAsset = document.getElementById('btnAddAsset');
  const btnDisposeAsset = document.getElementById('btnDisposeAsset');
  const btnAssetCancel = document.getElementById('btnAssetCancel');
  const btnAssetUndo = document.getElementById('btnAssetUndo');
  const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
  const assetDisposalAccount = document.getElementById('assetDisposalAccount');
  const assetClassification = document.getElementById('assetClassification');
  const assetDepRate = document.getElementById('assetDepRate');
  const assetContact = document.getElementById('assetContact');
  const assetReceipt = document.getElementById('assetReceipt');
  const assetDisposeSelect = document.getElementById('assetDisposeSelect');
  const assetDisposalContact = document.getElementById('assetDisposalContact');
  const assetDisposalReceipt = document.getElementById('assetDisposalReceipt');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  // These elements may not exist in the DOM if quick panels were removed from the UI
  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const dashboardSection = document.getElementById('dashboardSection');
  const ledgerSection = document.getElementById('ledgerSection');
  const ledgerListSection = document.getElementById('ledgerListSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');

  const modalOverlay = document.getElementById('modalOverlay');
  const userModal = document.getElementById('userModal');
  const userModalTitle = document.getElementById('userModalTitle');
  const userEmail = document.getElementById('userEmail');
  const userDisplay = document.getElementById('userDisplay');
  const userRole = document.getElementById('userRole');
  const permView = document.getElementById('permView');
  const permEdit = document.getElementById('permEdit');
  const permDelete = document.getElementById('permDelete');
  const userSave = document.getElementById('userSave');
  const userCancel = document.getElementById('userCancel');

  const businessModal = document.getElementById('businessModal');
  const businessModalTitle = document.getElementById('businessModalTitle');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizTurnoverThreshold = document.getElementById('bizTurnoverThreshold');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
  const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizDedNHIS = document.getElementById('bizDedNHIS');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');

  const accountsModal = document.getElementById('accountsModal');
  const accountsList = document.getElementById('accountsList');
  const newAccountName = document.getElementById('newAccountName');
  const newAccountCategory = document.getElementById('newAccountCategory');
  const newAccountDisallowable = document.getElementById('newAccountDisallowable');
  const newAccountNonTax = document.getElementById('newAccountNonTax');
  const addAccountBtn = document.getElementById('addAccountBtn');
  const closeAccountsBtn = document.getElementById('closeAccountsBtn');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnDashboardTab = document.getElementById('btnDashboardTab');
  const btnReportsTab = document.getElementById('btnReportsTab');
  const btnCashbookTab = document.getElementById('btnCashbookTab');
  
  // New DOM refs for added features
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const btnClearAll = document.getElementById('btnClearAll');
  const loginModal = document.getElementById('loginModal');
  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const loginSubmit = document.getElementById('loginSubmit');
  const loginCancel = document.getElementById('loginCancel');
  const authInfo = document.getElementById('authInfo');
  
  // Pre-login overlay DOM refs
  const preLoginOverlay = document.getElementById('preLoginOverlay');
  const preLoginUsername = document.getElementById('preLoginUsername');
  const preLoginPassword = document.getElementById('preLoginPassword');
  const preLoginSubmit = document.getElementById('preLoginSubmit');
  
  // Auth tabs and panels DOM refs (merged from auth.js)
  const authTabLogin = document.getElementById('authTabLogin');
  const authTabSignup = document.getElementById('authTabSignup');
  const authLoginPanel = document.getElementById('authLoginPanel');
  const authSignupPanel = document.getElementById('authSignupPanel');
  const authLoginMsg = document.getElementById('authLoginMsg');
  const authSignupMsg = document.getElementById('authSignupMsg');
  const authSignupName = document.getElementById('authSignupName');
  const authSignupUsername = document.getElementById('authSignupUsername');
  const authSignupEmail = document.getElementById('authSignupEmail');
  const authSignupPassword = document.getElementById('authSignupPassword');
  const authSignupPassword2 = document.getElementById('authSignupPassword2');
  const authSignupSubmit = document.getElementById('authSignupSubmit');
  const authSignupCancel = document.getElementById('authSignupCancel');
  
  const txnAdjustmentType = document.getElementById('txnAdjustmentType');
  const txnAdjustmentAmount = document.getElementById('txnAdjustmentAmount');
  const txnAdjustmentAmountLabel = document.getElementById('txnAdjustmentAmountLabel');
  
  const btnAssetDisposalCancel = document.getElementById('btnAssetDisposalCancel');
  const btnAssetDisposalUndo = document.getElementById('btnAssetDisposalUndo');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return (n==null || isNaN(Number(n))) ? 'â‚¦0.00' : 'â‚¦' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function rawFmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function escapeHtml(text){ if(!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
  function today(){ return new Date().toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
  function toISO(date){ if(!date) return null; return new Date(date).toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }
  function isLeapYear(y){ return (y%4===0 && y%100!==0) || (y%400===0); }
  function daysInYear(d){ const y = new Date(d).getFullYear(); return isLeapYear(y) ? 366 : 365; }
  
  // VAT calculation utility
  function computeVAT(amount, vatType, vatRate){
    if(!vatType || vatType === 'none') return 0;
    const amt = Number(amount || 0);
    const rate = Number(vatRate || 0);
    if(vatType === 'exclusive'){
      return amt * (rate / 100);
    } else if(vatType === 'inclusive'){
      return amt * (rate / (100 + rate));
    }
    return 0;
  }
  
  // WHT calculation utility
  function computeWHT(amount, basis, rate){
    const amt = Number(amount || 0);
    const rateDecimal = Number(rate || 0) / 100;
    
    if(basis === 'net'){
      // Net basis: Gross up the net amount
      const gross = rateDecimal > 0 && rateDecimal < 1 ? amt / (1 - rateDecimal) : amt;
      const wht = gross * rateDecimal;
      return wht;
    } else {
      // Gross basis: WHT = Gross Ã— Rate
      return amt * rateDecimal;
    }
  }

  // load/save
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }
  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || { currentUserId: null };
    state.superAdmin = state.superAdmin || { isActive: false };
    state.invoices = state.invoices || {};
    state.cashbook = state.cashbook || {};
    
    state.businesses.forEach(b => {
      // MIGRATION: Rename SoleProprietor to Business
      if (b.entity === 'SoleProprietor') {
        b.entity = 'Business';
      }
      // MIGRATION: Rename Individual to Business (removing Individual entity)
      if (b.entity === 'Individual') {
        b.entity = 'Business';
      }
      
      // MIGRATION: Add turnoverThreshold if missing (default 100M)
      if (typeof b.turnoverThreshold === 'undefined') {
        b.turnoverThreshold = DEFAULTS.turnoverThreshold;
      }
      
      // MIGRATION: Add userIds array if missing (for 3-user limit enforcement)
      if (!b.userIds || !Array.isArray(b.userIds)) {
        b.userIds = b.ownerId ? [b.ownerId] : [];
      }
      
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
      b.accounts = b.accounts || [];
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
      
      // MIGRATION: Add missing default accounts
      const existingAccountNames = b.accounts.map(a => a.name);
      const accountsToAdd = [
        { name: 'Purchases', category: 'Expense' },
        { name: 'Salary', category: 'Expense' },
        { name: 'Dividend', category: 'Revenue' },
        { name: 'Interest', category: 'Revenue' },
        { name: 'Royalty', category: 'Revenue' },
        { name: 'Share of profit', category: 'Revenue' },
        { name: 'Receivable', category: 'Asset' },
        { name: 'Payable', category: 'Liability' },
        { name: 'Capital', category: 'Capital' },
        { name: 'Accruals', category: 'Liability' },
        { name: 'Prepayment', category: 'Asset' },
        { name: 'Sales Revenue', category: 'Revenue' },
        { name: 'VAT Payable', category: 'Liability' },
        { name: 'WHT Payable', category: 'Liability' },
        { name: 'PAYE Payable', category: 'Liability' },
        { name: 'PIT Payable', category: 'Liability' },
        { name: 'CGT Payable', category: 'Liability' },
        { name: 'CIT Payable', category: 'Liability' },
        { name: 'WHT Receivable', category: 'Asset' },
        { name: 'Tax Provision', category: 'Expense' },
        { name: 'VAT Recoverable', category: 'Asset' }
      ];
      
      for (const acct of accountsToAdd) {
        if (!existingAccountNames.includes(acct.name)) {
          b.accounts.push({
            id: uid('acct'),
            name: acct.name,
            category: acct.category,
            disallowableDefault: false,
            nonTaxableDefault: false,
            openingBalance: 0,
            closingBalance: 0
          });
        }
      }
      
      // Ensure ALL Asset, Liability, and Capital accounts have opening balance fields
      // Opening balances are static fields stored on accounts (not journal entries)
      b.accounts.forEach(a => {
        if (['Asset', 'Liability', 'Capital'].includes(a.category)) {
          if (typeof a.openingBalance === 'undefined') a.openingBalance = 0;
          if (typeof a.closingBalance === 'undefined') a.closingBalance = 0;
        }
      });
      
      // MIGRATION: Rename "Account Receivable" to "Receivable"
      b.accounts.forEach(a => {
        if(a.name === 'Account Receivable') a.name = 'Receivable';
      });
    });
    
    // MIGRATION: Map Income action to Revenue in transactions (for backwards compatibility)
    for (const u of state.users) {
      state.transactions[u.id] = state.transactions[u.id] || {};
      for (const b of state.businesses) {
        state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || [];
        // Convert Income â†’ Revenue
        state.transactions[u.id][b.id].forEach(txn => {
          if (txn.action === 'Income') {
            txn.action = 'Revenue';
          }
        });
      }
    }
    
    saveState();
  }

  /**
   * Pre-seeds the admin account if no users exist.
   * This is called at app initialization to ensure there's always an admin account.
   * Default admin: username "Owner" (password set per deployment requirements)
   * Uses sha256Hex helper to hash the password.
   */
  async function seedAdminIfNeeded() {
    if (!state.users || state.users.length === 0) {
      // Hash the default admin password (as specified in deployment requirements)
      // SECURITY NOTE: In production, use environment variables or secure configuration
      const DEFAULT_ADMIN_PASS = 'chukwuedozie25$'; // Specified by deployment requirements
      const hashedPassword = await sha256Hex(DEFAULT_ADMIN_PASS);
      
      const adminId = uid('user');
      const adminUser = {
        id: adminId,
        username: 'Owner',
        display: 'Owner',
        role: 'Admin',
        isAdmin: true,
        email: '',
        passwordHash: hashedPassword,
        permissions: { view: true, edit: true, delete: true },
        tourSeen: false,
        createdAt: Date.now(), // Signup timestamp for 7-day offer visibility
        createdByAdmin: false // Not created by another admin
      };
      
      state.users.push(adminUser);
      
      addAudit('admin.seed', 'user', adminId, 'Pre-seeded admin account: Owner');
      saveState();
      
      return adminUser;
    }
    return null;
  }

  function seedDemo(){
    const u = uid('user'), b = uid('biz');
    // Removed Sales (Revenue) default account as per requirements
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const purchases = { id: uid('acct'), name: 'Purchases', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const rent = { id: uid('acct'), name: 'Rent', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false, rentFreq:'monthly' };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 };

    state = {
      users: [{ id: u, username: 'admin', display:'Admin User', role:'Admin', isAdmin:true, permissions:{ view:true, edit:true, delete:true }, tourSeen: true, createdAt: Date.now() }],
      businesses: [{
        id: b,
        name: 'Demo Business',
        ownerId: u,
        entity: 'Company',
        entityLocked: false, // Demo business entity is not locked
        vatRate: DEFAULTS.vatRate,
        whtRate: DEFAULTS.whtRate,
        citRate: DEFAULTS.citRate,
        turnoverThreshold: DEFAULTS.turnoverThreshold,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault,
        depRateDefault: DEFAULTS.depRateDefault,
        accounts: [cogs, purchases, salaries, rent, bank], // Removed sales and chargeable asset accounts
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [
          { id: uid('asset'), name: 'Office PC', category: 'Furniture & Fittings', qty:1, unitPrice:150000, cost: 150000, purchaseDate: today(), lifeYears: 5, caPercent: 20, depRate: 20, classification: 'Fixed', accumulatedDep:0, accumulatedDepreciation:0, capitalAllowances: [], disposed:false, disposal:{}, openingAccDep:0 },
          { id: uid('asset'), name: 'Land Plot', category: 'Property Plant and Equipment', qty:1, unitPrice:2000000, cost: 2000000, purchaseDate: '2020-01-01', lifeYears: 20, caPercent: 5, depRate: 0, classification: 'Chargeable', accumulatedDep:0, accumulatedDepreciation:0, capitalAllowances: [], disposed:false, disposal:{}, openingAccDep:0 }
        ],
        contacts: [{ id: uid('c'), name:'John Employee', type:'Employee', statutory:{ pension: 20000, rent: 120000, life: 5000, mortgage: 100000, nhf: 5000 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } }],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward: 150000, caCarryForward: 50000,
        defaultExpenseDisallowable:false, defaultRevenueNonTax:false,
        userIds: [u], // Track users associated with this business
        chargeableLosses: {}, // CGT: { year: { assetClassName: amount } }
        shareDisposalsByYear: {} // CGT: { year: { proceedsSum: number, gainSum: number } }
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: null }  // Not logged in by default - user must sign in via pre-login overlay
    };
    state.transactions[u] = {};
    state.transactions[u][b] = [
      { id: uid('txn'), date: today(), action: 'Revenue', accountId: cogs.id, accountName: 'COGS', accountCategory: 'Expense', description: 'Demo expense', amount: 50000, vatType:'none', whtApplied:false, paye:false, contact:'', receiptId:null },
      { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, accountCategory: salaries.category, description: 'Demo salary', amount: 50000, vatType:'none', whtApplied:false, paye:true, contact:'John Employee', receiptId:null },
      { id: uid('txn'), date: today(), action: 'InventoryPurchase', accountId: cogs.id, accountName: cogs.name, accountCategory: cogs.category, description: 'Purchase widgets', qty:50, unitPrice:520, amount: 26000, vatType:'none', whtApplied:false, paye:false, contact:'', receiptId:null },
    ];
    addAudit('seed','system','',`Seeded demo data`);
    saveState();
    
    // After seeding demo, seed the admin user with password
    seedAdminIfNeeded();
  }

  // audit
  function addAudit(type, entityType, entityId, details, originalData){
    const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details };
    // Store original amounts/data if provided for audit trail
    if(originalData) {
      entry.originalData = originalData;
    }
    state.audit = state.audit || [];
    state.audit.push(entry);
    saveState();
  }

  // modal helpers
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
  modalOverlay.addEventListener('click', ()=> { 
    const signupModalEl = document.getElementById('signupModal');
    const preLoginOverlayEl = document.getElementById('preLoginOverlay');
    const wasSignupModalOpen = signupModalEl && signupModalEl.style.display === 'block';
    
    [userModal, businessModal, accountsModal, loginModal, signupModalEl, document.getElementById('forgotModal'), document.getElementById('entitySelectModal'), document.getElementById('videoTourModal')].forEach(m => { if(m && m.style.display==='block') closeModal(m); }); 
    
    // Show pre-login overlay if signup modal was closed and user is not logged in
    if (wasSignupModalOpen && preLoginOverlayEl && (!state || !state.auth || !state.auth.currentUserId)) {
      preLoginOverlayEl.classList.remove('hidden');
    }
  });

  // Login function - now redirects to pre-login overlay for Firebase authentication
  async function handleLogin(){
    // This modal is for user switching after initial login
    // For security, require re-authentication via pre-login overlay
    const username = (loginUsername.value || '').trim();
    
    if(!username) return alert('Username required');
    const user = state.users.find(u => u.username === username);
    if(!user) return alert('User not found');
    
    // For users with Firebase UID, require Firebase re-authentication
    if(user.firebaseUid) {
      alert('Please log out and sign in again with your email and password for security.');
      closeModal(loginModal);
      return;
    }
    
    // For legacy users without Firebase (backward compatibility)
    // Allow direct login - these will be migrated to Firebase on next login
    state.auth.currentUserId = user.id;
    saveState();
    addAudit('auth.login', 'user', user.id, 'User switched (legacy)');
    closeModal(loginModal);
    loginUsername.value = '';
    loginPassword.value = '';
    updateAuthUI();
    renderAll();
  }

  async function handleLogout(){
    if(!state.auth.currentUserId) return;
    
    // Firebase sign out
    if (typeof isFirebaseAuthEnabled === 'function' && isFirebaseAuthEnabled()) {
      const result = await firebaseSignOut();
      if (!result.success) {
        console.warn('Firebase sign out error:', result.error);
      }
    }
    
    addAudit('auth.logout', 'user', state.auth.currentUserId, 'User logged out');
    state.auth.currentUserId = null;
    saveState();
    updateAuthUI();
    renderAll();
  }

  // Helper function to add demo mode link to error messages
  function addDemoModeLink(messageElement) {
    if (!messageElement) return;
    messageElement.innerHTML = 'Authentication service unavailable. <a href="#" class="demo-mode-link" style="color:#0b76d1;text-decoration:underline;">Continue in Demo Mode</a>'; 
    messageElement.style.color = '#b00'; 
    // Add click handler for demo mode link
    setTimeout(function() {
      const demoLinks = messageElement.querySelectorAll('.demo-mode-link');
      demoLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const btnDemo = document.getElementById('btnDemoAccess');
          if (btnDemo) btnDemo.click();
        });
      });
    }, 100);
  }

  // Pre-login overlay handler - authenticates user using Firebase Authentication
  async function handlePreLogin(){
    const email = (preLoginUsername && preLoginUsername.value ? preLoginUsername.value : '').trim();
    const password = (preLoginPassword && preLoginPassword.value ? preLoginPassword.value : '');
    
    if(!email) {
      if(authLoginMsg) { authLoginMsg.textContent = 'Email address required'; authLoginMsg.style.color = '#b00'; }
      return;
    }
    
    if(!password) {
      if(authLoginMsg) { authLoginMsg.textContent = 'Password required'; authLoginMsg.style.color = '#b00'; }
      return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      if(authLoginMsg) { authLoginMsg.textContent = 'Please enter a valid email address'; authLoginMsg.style.color = '#b00'; }
      return;
    }
    
    // Check if Firebase is available
    if (!isFirebaseAuthEnabled()) {
      addDemoModeLink(authLoginMsg);
      return;
    }
    
    if(authLoginMsg) { authLoginMsg.textContent = 'Signing in...'; authLoginMsg.style.color = 'var(--muted)'; }
    
    const fbResult = await firebaseSignIn(email.toLowerCase(), password);
    
    if (fbResult.success) {
      const firebaseUid = fbResult.user.uid;
      const email = fbResult.user.email;
      
      // Find local user by Firebase UID or email
      let user = state.users.find(u => u.firebaseUid === firebaseUid);
      if (!user) {
        user = state.users.find(u => u.email === email);
        // Map the Firebase UID to existing user
        if (user && !user.firebaseUid) {
          user.firebaseUid = firebaseUid;
          saveState();
        }
      }
      
      if (!user) {
        // User exists in Firebase but not locally - create local user
        const userId = uid('user');
        user = {
          id: userId,
          username: email.split('@')[0], // Use email prefix as username
          display: email.split('@')[0],
          email: email,
          firebaseUid: firebaseUid,
          role: 'User',
          isAdmin: false,
          permissions: { view: true, edit: true, delete: false },
          plan: 'Individual',
          createdAt: Date.now(),
          trialStart: Date.now(),
          tourSeen: false,
          createdByAdmin: false
        };
        state.users.push(user);
      }
      
      state.auth.currentUserId = user.id;
      saveState();
      addAudit('auth.login', 'user', user.id, 'User logged in via Firebase');
      preLoginUsername.value = '';
      preLoginPassword.value = '';
      if(authLoginMsg) { authLoginMsg.textContent = ''; }
      
      setTimeout(() => {
        updateAuthUI();
        refreshSelectors();
        ensureSelection();
        renderAll();
        renderTab(); // render active tab (dashboard) after login
        
        // Check if user needs to see video tour (first time after signup)
        if(user.tourSeen !== true) {
          showTourModal(user.id);
        }
      }, 400);
    } else {
      // Firebase login failed - show error
      if(authLoginMsg) { authLoginMsg.textContent = fbResult.error || 'Sign in failed'; authLoginMsg.style.color = '#b00'; }
    }
  }

  function updateAuthUI(){
    const superAdminIndicator = document.getElementById('superAdminIndicator');
    
    // Update super admin indicator
    if(state.superAdmin && state.superAdmin.isActive){
      if(superAdminIndicator) superAdminIndicator.style.display = 'inline-block';
    } else {
      if(superAdminIndicator) superAdminIndicator.style.display = 'none';
    }
    
    if(state.auth.currentUserId){
      const user = state.users.find(u => u.id === state.auth.currentUserId);
      if(user){
        authInfo.textContent = `Logged in as: ${user.display || user.username}`;
        btnLogin.style.display = 'none';
        btnLogout.style.display = 'inline-block';
        // Hide pre-login overlay when logged in
        if(preLoginOverlay) preLoginOverlay.classList.add('hidden');
      }
    } else {
      authInfo.textContent = 'Not logged in';
      btnLogin.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      // Show pre-login overlay when not logged in
      if(preLoginOverlay) preLoginOverlay.classList.remove('hidden');
    }
    enforcePermissions();
  }

  function enforcePermissions(){
    // All buttons are now always enabled for logged in users
    btnAddBusiness.disabled = false;
    btnEditBusiness.disabled = false;
    btnDeleteBusiness.disabled = false;
    btnManageAccounts.disabled = false;
    btnDeleteUser.disabled = false;
    btnClearAll.disabled = false;
    
    btnAddBusiness.classList.remove('disabled');
    btnEditBusiness.classList.remove('disabled');
    btnDeleteBusiness.classList.remove('disabled');
    btnManageAccounts.classList.remove('disabled');
    btnDeleteUser.classList.remove('disabled');
    btnClearAll.classList.remove('disabled');
  }

  // Helper functions for asset and inventory deletion
  function deleteAssetIfCurrentYear(assetId){
    const b = findBiz(selectedBizId);
    if(!b) return false;
    
    const asset = b.assets.find(a => a.id === assetId);
    if(!asset) return false;
    
    const currentYear = new Date().getFullYear();
    const purchaseYear = new Date(asset.purchaseDate).getFullYear();
    const disposalYear = asset.disposed && asset.disposal.date ? new Date(asset.disposal.date).getFullYear() : null;
    
    // Check if purchase or disposal occurred in current year
    if(purchaseYear !== currentYear && (!disposalYear || disposalYear !== currentYear)){
      alert(`Cannot delete asset. Purchase/disposal must have occurred in ${currentYear}.`);
      return false;
    }
    
    // Delete the asset
    b.assets = b.assets.filter(a => a.id !== assetId);
    
    // Delete related transactions (depreciation, capital allowance, purchase, disposal)
    const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    state.transactions[selectedUserId][selectedBizId] = txns.filter(t => 
      !(t.assetId === assetId || (t.description && t.description.includes(asset.name)))
    );
    
    addAudit('asset.delete', 'asset', assetId, `Deleted asset: ${asset.name}`);
    saveState();
    return true;
  }

  function deleteInventoryIfCurrentYear(itemId){
    const b = findBiz(selectedBizId);
    if(!b) return false;
    
    const item = b.inventory.find(i => i.id === itemId);
    if(!item) return false;
    
    const currentYear = new Date().getFullYear();
    const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    
    // Check if any inventory transactions for this item occurred in current year
    const itemTxns = txns.filter(t => t.itemId === itemId);
    const hasCurrentYearTxn = itemTxns.some(t => new Date(t.date).getFullYear() === currentYear);
    
    if(!hasCurrentYearTxn && itemTxns.length > 0){
      const firstTxnYear = new Date(itemTxns[0].date).getFullYear();
      alert(`Cannot delete inventory item. Transactions must have occurred in ${currentYear}.`);
      return false;
    }
    
    // Delete the inventory item
    b.inventory = b.inventory.filter(i => i.id !== itemId);
    
    // Delete related transactions
    state.transactions[selectedUserId][selectedBizId] = txns.filter(t => t.itemId !== itemId);
    
    addAudit('inventory.delete', 'inventory', itemId, `Deleted inventory: ${item.name}`);
    saveState();
    return true;
  }

  /**
   * Clears all email signups from storage.
   * This is a one-time operation to reset all user accounts.
   */
  function clearAllEmailSignups() {
    // Check if already cleared by looking for a flag
    const clearFlag = localStorage.getItem('emailSignupsCleared_v1');
    if (clearFlag === 'true') {
      console.log('Email signups already cleared.');
      return;
    }
    
    console.log('Clearing all email signups...');
    
    // Clear all users
    state.users = [];
    
    // Clear all transactions
    state.transactions = {};
    
    // Clear all audit entries
    state.audit = [];
    
    // Clear auth state
    state.auth = { currentUserId: null };
    
    // Clear super admin state
    state.superAdmin = { isActive: false };
    
    // Save the cleared state
    saveState();
    
    // Set flag to prevent clearing again
    localStorage.setItem('emailSignupsCleared_v1', 'true');
    
    // Add audit entry for the clear operation
    addAudit('system.clear_signups', 'system', null, 'All email signups cleared as per requirement');
    
    console.log('Email signups cleared successfully.');
  }

  // initialization
  loadState();
  
  // Clear all email signups (one-time operation)
  clearAllEmailSignups();
  initUI();
  updateAuthUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();
  renderTab(); // ensure the active tab (dashboard) renders properly on load

  function initUI(){
    btnAddUser.addEventListener('click', ()=> openUserModal());
    btnEditUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); openUserModal(selectedUserId); });
    btnDeleteUser.addEventListener('click', ()=> { if(!selectedUserId) return alert('Select a user'); if(!confirm('Delete user? This cannot be undone')) return; deleteUser(selectedUserId); });
    userSave.addEventListener('click', saveUser);
    userCancel.addEventListener('click', ()=> closeModal(userModal));

    btnAddBusiness.addEventListener('click', openAddBusinessModal);
    btnEditBusiness.addEventListener('click', openEditBusinessModal);
    btnDeleteBusiness.addEventListener('click', ()=> { if(!selectedBizId) return alert('Select business'); if(!confirm('Delete business and all its transactions/attachments?')) return; deleteBusiness(selectedBizId); });
    bizSave.addEventListener('click', saveBusiness);
    bizCancel.addEventListener('click', ()=>closeModal(businessModal));
    btnAddContact.addEventListener('click', addContactToBiz);

    btnManageAccounts.addEventListener('click', ()=> { if(!selectedBizId) return alert('Select business'); renderAccounts(); openModal(accountsModal); });
    addAccountBtn.addEventListener('click', addAccount);
    closeAccountsBtn.addEventListener('click', ()=> closeModal(accountsModal));

    txnAction.addEventListener('change', txnActionChanged);
    txnWht.addEventListener('change', ()=> {
      const show = txnWht.checked;
      txnWhtRateLabel.style.display = show ? 'inline-flex' : 'none';
      txnWhtBasisLabel.style.display = show ? 'inline-flex' : 'none';
      if(show && !txnWhtRate.value){ txnWhtRate.value = findBiz(selectedBizId)?.whtRate || DEFAULTS.whtRate; }
    } );
    btnAddTxn.addEventListener('click', handleAddTransaction);

    btnAddInv.addEventListener('click', handleInventoryAction);
    btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnInvUndo.addEventListener('click', handleUndoInventory);
    
    // Inventory payment status toggle
    const invPaymentStatus = document.getElementById('invPaymentStatus');
    const invPartAmountLabel = document.getElementById('invPartAmountLabel');
    if(invPaymentStatus && invPartAmountLabel){
      invPaymentStatus.addEventListener('change', ()=>{
        invPartAmountLabel.style.display = invPaymentStatus.value === 'Part' ? 'inline-flex' : 'none';
      });
    }

    btnAddAsset.addEventListener('click', handleAddAsset);
    btnDisposeAsset.addEventListener('click', handleDisposeAsset);
    btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetPurchaseSubform.style.display='none'; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnAssetUndo.addEventListener('click', handleUndoAsset);
    btnAssetDisposalCancel.addEventListener('click', ()=>{ txnAction.value=''; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
    btnAssetDisposalUndo.addEventListener('click', handleUndoAsset);
    
    // Asset payment status toggle
    const assetPaymentStatus = document.getElementById('assetPaymentStatus');
    const assetPartAmountLabel = document.getElementById('assetPartAmountLabel');
    if(assetPaymentStatus && assetPartAmountLabel){
      assetPaymentStatus.addEventListener('change', ()=>{
        assetPartAmountLabel.style.display = assetPaymentStatus.value === 'Part' ? 'inline-flex' : 'none';
      });
    }
    
    // Cashbook manual entry
    const btnAddCashbookEntry = document.getElementById('btnAddCashbookEntry');
    if(btnAddCashbookEntry) btnAddCashbookEntry.addEventListener('click', handleAddCashbookEntry);

    // Login/Logout handlers
    btnLogin.addEventListener('click', ()=> openModal(loginModal));
    btnLogout.addEventListener('click', handleLogout);
    loginSubmit.addEventListener('click', handleLogin);
    loginCancel.addEventListener('click', ()=> closeModal(loginModal));

    // User and Business select change handlers
    userSelect.addEventListener('change', ()=> { selectedUserId = userSelect.value; renderAll(); if(activeTab === 'cashbook') renderCashbook(); });
    businessSelect.addEventListener('change', ()=> { selectedBizId = businessSelect.value; populateAccountSelect(); renderAll(); renderFeatureVisibility(); updateReportTabVisibility(); if (typeof updateContactDropdowns === 'function') updateContactDropdowns(); if(activeTab === 'cashbook') renderCashbook(); });

    // Pre-login overlay handler - authenticates user from overlay form
    if(preLoginSubmit){
      preLoginSubmit.addEventListener('click', handlePreLogin);
    }
    if(preLoginUsername){
      preLoginUsername.addEventListener('keypress', (e)=> { if(e.key === 'Enter') handlePreLogin(); });
    }
    if(preLoginPassword){
      preLoginPassword.addEventListener('keypress', (e)=> { if(e.key === 'Enter') handlePreLogin(); });
    }
    
    // Auth tabs switching logic (merged from auth.js)
    function switchAuthTab(panel) {
      if (panel === 'login') {
        if (authTabLogin) authTabLogin.classList.add('active');
        if (authTabSignup) authTabSignup.classList.remove('active');
        if (authLoginPanel) authLoginPanel.classList.remove('hidden');
        if (authSignupPanel) authSignupPanel.classList.add('hidden');
      } else {
        if (authTabSignup) authTabSignup.classList.add('active');
        if (authTabLogin) authTabLogin.classList.remove('active');
        if (authSignupPanel) authSignupPanel.classList.remove('hidden');
        if (authLoginPanel) authLoginPanel.classList.add('hidden');
      }
    }
    
    if (authTabLogin) authTabLogin.addEventListener('click', () => switchAuthTab('login'));
    if (authTabSignup) authTabSignup.addEventListener('click', () => switchAuthTab('signup'));
    if (authSignupCancel) authSignupCancel.addEventListener('click', () => {
      // Clear form and switch back to login
      if (authSignupName) authSignupName.value = '';
      if (authSignupUsername) authSignupUsername.value = '';
      if (authSignupEmail) authSignupEmail.value = '';
      if (authSignupPassword) authSignupPassword.value = '';
      if (authSignupPassword2) authSignupPassword2.value = '';
      if (authSignupMsg) authSignupMsg.textContent = '';
      switchAuthTab('login');
    });
    
    // Forgot password link handler - wires to firebaseSendPasswordReset helper
    const authForgotPassword = document.getElementById('authForgotPassword');
    const authLoginMsg = document.getElementById('authLoginMsg');
    if (authForgotPassword) {
      authForgotPassword.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Open the forgot password modal instead of using inline form
        const forgotModal = document.getElementById('forgotModal');
        if (forgotModal) {
          // Update modal UI based on Firebase availability
          if (typeof updateForgotModalUI === 'function') {
            updateForgotModalUI();
          }
          openModal(forgotModal);
        }
      });
    }
    
    // Auth signup form handler - uses Firebase Authentication
    if (authSignupSubmit) {
      authSignupSubmit.addEventListener('click', async function(e) {
        e.preventDefault();
        if (authSignupMsg) authSignupMsg.textContent = '';
        
        const name = authSignupName ? authSignupName.value.trim() : '';
        const username = authSignupUsername ? authSignupUsername.value.trim() : '';
        const email = authSignupEmail ? authSignupEmail.value.trim().toLowerCase() : '';
        const pass = authSignupPassword ? authSignupPassword.value : '';
        const pass2 = authSignupPassword2 ? authSignupPassword2.value : '';
        
        if (!name || !username || !email || !pass) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Please fill all fields'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        if (pass !== pass2) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Passwords do not match'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        if (pass.length < 6) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Password must be at least 6 characters'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        if (!isValidEmail(email)) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Please enter a valid email address'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        
        // Check username and email uniqueness (local check)
        const existingUsername = state.users.find(u => u.username === username);
        if (existingUsername) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Username already exists'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        const existingEmail = state.users.find(u => u.email === email);
        if (existingEmail) {
          if (authSignupMsg) { authSignupMsg.textContent = 'Email already registered'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        
        // Check if Firebase is available
        if (!isFirebaseAuthEnabled()) {
          addDemoModeLink(authSignupMsg);
          return;
        }
        
        // Firebase signup
        if (authSignupMsg) { authSignupMsg.textContent = 'Creating account...'; authSignupMsg.style.color = 'var(--muted)'; }
        
        const fbResult = await firebaseSignUp(email, pass);
        if (!fbResult.success) {
          if (authSignupMsg) { authSignupMsg.textContent = fbResult.error || 'Sign up failed'; authSignupMsg.style.color = '#b00'; }
          return;
        }
        
        const firebaseUid = fbResult.user.uid;
        
        // Create local user (linked to Firebase)
        const userId = uid('user');
        const newUser = {
          id: userId,
          username: username,
          display: name,
          email: email,
          firebaseUid: firebaseUid, // Linked to Firebase user
          role: 'User',
          isAdmin: false,
          permissions: { view: true, edit: true, delete: false },
          plan: 'Individual',
          createdAt: Date.now(),
          trialStart: Date.now(),
          tourSeen: false,
          createdByAdmin: false
        };
        
        state.users.push(newUser);
        state.auth.currentUserId = userId;
        saveState();
        addAudit('user.signup', 'user', userId, 'User signed up via Firebase: ' + username);
        
        // Clear form
        if (authSignupName) authSignupName.value = '';
        if (authSignupUsername) authSignupUsername.value = '';
        if (authSignupEmail) authSignupEmail.value = '';
        if (authSignupPassword) authSignupPassword.value = '';
        if (authSignupPassword2) authSignupPassword2.value = '';
        
        if (authSignupMsg) { authSignupMsg.textContent = ''; }
        
        // Show entity selection modal for new user
        setTimeout(() => {
          if (preLoginOverlay) preLoginOverlay.classList.add('hidden');
          showEntitySelectModal(userId, 'Business');
        }, 500);
      });
    }

    // Defensive signup handler - attaches to #signupSubmit button with fallbacks
    (function initDefensiveSignupHandler() {
      try {
        var signupSubmitBtn = document.getElementById('signupSubmit');
        if (!signupSubmitBtn) return;

        signupSubmitBtn.addEventListener('click', async function(e) {
          try {
            e.preventDefault();

            // Get storage key once for use in fallbacks
            var storageKey = (typeof STORAGE_KEY !== 'undefined') ? STORAGE_KEY : 'ntc_full_accounting_v2';

            // Get form field references defensively
            var nameEl = document.getElementById('signupName');
            var usernameEl = document.getElementById('signupUsername');
            var emailEl = document.getElementById('signupEmail');
            var phoneEl = document.getElementById('signupPhone');
            var passwordEl = document.getElementById('signupPassword');
            var planEl = document.getElementById('signupPlan');

            var name = (nameEl && nameEl.value) ? nameEl.value.trim() : '';
            var username = (usernameEl && usernameEl.value) ? usernameEl.value.trim() : '';
            var email = (emailEl && emailEl.value) ? emailEl.value.trim() : '';
            var phone = (phoneEl && phoneEl.value) ? phoneEl.value.trim() : '';
            var password = (passwordEl && passwordEl.value) ? passwordEl.value : '';
            var plan = (planEl && planEl.value) ? planEl.value : 'Business';

            // Validate required fields
            if (!name || !username || !email || !password) {
              alert('Name, Username, Email, and Password are required.');
              return;
            }

            // Validate email format
            var emailValid = false;
            if (typeof isValidEmail === 'function') {
              emailValid = isValidEmail(email);
            } else {
              // Fallback email validation
              var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              emailValid = emailRegex.test(email);
            }
            if (!emailValid) {
              alert('Please enter a valid email address.');
              return;
            }

            // Validate password minimum length
            if (password.length < 6) {
              alert('Password must be at least 6 characters long.');
              return;
            }

            // Check username uniqueness against state.users
            if (typeof state !== 'undefined' && state.users && Array.isArray(state.users)) {
              var existingUserByUsername = state.users.find(function(u) { return u.username === username; });
              if (existingUserByUsername) {
                alert('Username already exists. Please choose a different username.');
                return;
              }

              // Check email uniqueness
              var existingUserByEmail = state.users.find(function(u) { return u.email === email; });
              if (existingUserByEmail) {
                alert('This email address is already registered. Please use a different email or login with your existing account.');
                return;
              }
            }

            // Use Firebase Authentication for signup
            var firebaseUid = null;
            if (typeof isFirebaseAuthEnabled === 'function' && isFirebaseAuthEnabled() && typeof firebaseSignUp === 'function') {
              try {
                var fbResult = await firebaseSignUp(email.toLowerCase(), password);
                if (!fbResult.success) {
                  alert('Firebase signup failed: ' + (fbResult.error || 'Unknown error'));
                  return;
                }
                firebaseUid = fbResult.user.uid;
              } catch (fbErr) {
                alert('Signup failed: ' + fbErr.message);
                return;
              }
            } else {
              alert('Authentication service is unavailable. Please check your internet connection.');
              return;
            }

            // Generate user ID using uid() or fallback
            var userId;
            if (typeof uid === 'function') {
              userId = uid('user');
            } else {
              // Fallback: generate ID similar to uid() function pattern
              userId = 'user_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
            }

            // Create user object (linked to Firebase)
            var newUser = {
              id: userId,
              username: username,
              display: name,
              email: email,
              phone: phone,
              firebaseUid: firebaseUid,
              role: 'User',
              isAdmin: false,
              permissions: { view: true, edit: true, delete: false },
              plan: plan,
              createdAt: new Date().toISOString(),
              trialStart: new Date().toISOString(),
              tourSeen: false
            };

            // Add user to state
            if (typeof state !== 'undefined') {
              state.users = state.users || [];
              state.users.push(newUser);
              state.auth = state.auth || {};
              state.auth.currentUserId = userId;
            }

            // Persist state via saveState() or fallback to localStorage
            if (typeof saveState === 'function') {
              try {
                saveState();
              } catch (saveErr) {
                console.warn('saveState() failed, using localStorage fallback:', saveErr);
                try {
                  localStorage.setItem(storageKey, JSON.stringify(state));
                } catch (lsErr) {
                  console.error('localStorage fallback also failed:', lsErr);
                }
              }
            } else {
              // Fallback to localStorage directly
              try {
                localStorage.setItem(storageKey, JSON.stringify(state));
              } catch (lsErr) {
                console.error('localStorage save failed:', lsErr);
              }
            }

            // Log audit entry via addAudit() if available
            if (typeof addAudit === 'function') {
              try {
                addAudit('user.signup', 'user', userId, 'User signed up: ' + username + ' (Plan: ' + plan + ', Email: ' + email + ')');
              } catch (auditErr) {
                console.warn('addAudit() failed:', auditErr);
              }
            }

            // Clear form fields
            if (nameEl) nameEl.value = '';
            if (usernameEl) usernameEl.value = '';
            if (emailEl) emailEl.value = '';
            if (phoneEl) phoneEl.value = '';
            if (passwordEl) passwordEl.value = '';
            if (planEl) planEl.value = 'Business';

            // Close signup modal
            var signupModalEl = document.getElementById('signupModal');
            if (signupModalEl) {
              if (typeof closeModal === 'function') {
                try {
                  closeModal(signupModalEl);
                } catch (closeErr) {
                  signupModalEl.style.display = 'none';
                  var overlay = document.getElementById('modalOverlay');
                  if (overlay) overlay.style.display = 'none';
                }
              } else {
                signupModalEl.style.display = 'none';
                var overlay = document.getElementById('modalOverlay');
                if (overlay) overlay.style.display = 'none';
              }
            }

            // Create default business via createBusinessForUser() if available
            var bizId = null;
            if (typeof createBusinessForUser === 'function') {
              try {
                bizId = createBusinessForUser(userId, plan);
              } catch (bizErr) {
                console.warn('createBusinessForUser() failed:', bizErr);
              }
            }

            // Set selected user and business
            if (typeof selectedUserId !== 'undefined') {
              selectedUserId = userId;
            }
            if (bizId && typeof selectedBizId !== 'undefined') {
              selectedBizId = bizId;
            }

            // Open entity selection modal if present (and createBusinessForUser wasn't called or failed)
            var entitySelectModal = document.getElementById('entitySelectModal');
            if (entitySelectModal && !bizId) {
              if (typeof pendingSignupUserId !== 'undefined') {
                pendingSignupUserId = userId;
              }
              var entitySelectType = document.getElementById('entitySelectType');
              if (entitySelectType) entitySelectType.value = plan;
              if (typeof openModal === 'function') {
                try {
                  openModal(entitySelectModal);
                } catch (openErr) {
                  entitySelectModal.style.display = 'block';
                  var overlay = document.getElementById('modalOverlay');
                  if (overlay) overlay.style.display = 'block';
                }
              } else {
                entitySelectModal.style.display = 'block';
                var overlay = document.getElementById('modalOverlay');
                if (overlay) overlay.style.display = 'block';
              }
            }

            // Trigger video tour for new user if available
            if (typeof showTourModal === 'function' && bizId) {
              try {
                showTourModal(userId);
              } catch (tourErr) {
                console.warn('showTourModal() failed:', tourErr);
              }
            }

            // Refresh UI selects - try multiple approaches
            var uiRefreshed = false;

            // Try populateUserBusinessSelects() if available
            if (typeof populateUserBusinessSelects === 'function') {
              try {
                populateUserBusinessSelects();
                uiRefreshed = true;
              } catch (popErr) {
                console.warn('populateUserBusinessSelects() failed:', popErr);
              }
            }

            // Try populateUsers() if available
            if (typeof populateUsers === 'function') {
              try {
                populateUsers();
                uiRefreshed = true;
              } catch (popErr) {
                console.warn('populateUsers() failed:', popErr);
              }
            }

            // Try refreshSelectors() if available
            if (typeof refreshSelectors === 'function') {
              try {
                refreshSelectors();
                uiRefreshed = true;
              } catch (refErr) {
                console.warn('refreshSelectors() failed:', refErr);
              }
            }

            // Try ensureSelection() if available
            if (typeof ensureSelection === 'function') {
              try {
                ensureSelection();
              } catch (ensErr) {
                console.warn('ensureSelection() failed:', ensErr);
              }
            }

            // Try renderUI() or renderAll() if available
            if (typeof renderUI === 'function') {
              try {
                renderUI();
                uiRefreshed = true;
              } catch (renErr) {
                console.warn('renderUI() failed:', renErr);
              }
            } else if (typeof renderAll === 'function') {
              try {
                renderAll();
                uiRefreshed = true;
              } catch (renErr) {
                console.warn('renderAll() failed:', renErr);
              }
            }

            // Try updateAuthUI() if available
            if (typeof updateAuthUI === 'function') {
              try {
                updateAuthUI();
              } catch (authErr) {
                console.warn('updateAuthUI() failed:', authErr);
              }
            }

            // Last resort: reload the page if UI refresh failed and entity select modal is not open
            // The entity select modal would be handling the rest of the signup flow if open
            var entityModalIsOpen = entitySelectModal && entitySelectModal.style.display === 'block';
            if (!uiRefreshed && !entityModalIsOpen) {
              console.log('UI refresh methods unavailable, reloading page...');
              window.location.reload();
            }

          } catch (handlerErr) {
            console.error('Signup handler error:', handlerErr);
            alert('An error occurred during signup. Please try again.');
          }
        });
      } catch (initErr) {
        console.error('Failed to initialize defensive signup handler:', initErr);
      }
    })();

    // Adjustment type handler
    txnAdjustmentType.addEventListener('change', ()=> {
      const show = txnAdjustmentType.value !== '';
      txnAdjustmentAmountLabel.style.display = show ? 'inline-flex' : 'none';
    });

    // Asset qty/unitPrice auto-computation handlers
    assetQty.addEventListener('input', autoComputeAssetCost);
    assetUnitPrice.addEventListener('input', autoComputeAssetCost);
    
    // Asset category change handler
    assetCategory.addEventListener('change', updateAssetNameSuggestions);

    document.getElementById('btnSearch').addEventListener('click', renderLedger);
    document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

    document.getElementById('btnExport').addEventListener('click', exportJSON);
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', importJSON);
    document.getElementById('btnClearAll').addEventListener('click', clearAllData);
    
    // Buy Now button - opens prelogin/pricing overlay
    const buyNowBtn = document.getElementById('buyNowBtn');
    if(buyNowBtn) {
      buyNowBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const preLoginOverlay = document.getElementById('preLoginOverlay');
        if(preLoginOverlay) {
          preLoginOverlay.classList.remove('hidden');
          // Scroll to pricing section
          const planCards = preLoginOverlay.querySelector('.plan-cards');
          if(planCards) {
            planCards.scrollIntoView({ behavior: 'smooth' });
          }
        }
      });
    }

    if(btnDashboardTab) btnDashboardTab.addEventListener('click', ()=> { activeTab='dashboard'; renderTab(); });
    btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; renderTab(); });
    if(btnCashbookTab) btnCashbookTab.addEventListener('click', ()=> { activeTab='cashbook'; renderTab(); });
    btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; renderTab(); });
    
    // Enterprise feature tabs â€“ only accessible on Enterprise plan (UI + logic gate)
    const btnBankReconciliationTab = document.getElementById('btnBankReconciliationTab');
    const btnJournalEntryTab = document.getElementById('btnJournalEntryTab');
    const btnPayablesTab = document.getElementById('btnPayablesTab');
    
    if(btnBankReconciliationTab) btnBankReconciliationTab.addEventListener('click', ()=> {
      if(!isEnterprisePlus()) { alert('Bank Reconciliation is available on the Enterprise plan only.'); return; }
      activeTab='bankReconciliation'; renderTab();
    });
    if(btnJournalEntryTab) btnJournalEntryTab.addEventListener('click', ()=> {
      if(!isEnterprisePlus()) { alert('Journal Entry is available on the Enterprise plan only.'); return; }
      activeTab='journalEntry'; renderTab();
    });
    if(btnPayablesTab) btnPayablesTab.addEventListener('click', ()=> {
      if(!isEnterprisePlus()) { alert('Payables is available on the Enterprise plan only.'); return; }
      activeTab='payables'; renderTab();
    });
    
    if(txnPaymentStatus) txnPaymentStatus.addEventListener('change', ()=> {
      if(txnPartAmountLabel) txnPartAmountLabel.style.display = txnPaymentStatus.value === 'Part' ? 'inline-flex' : 'none';
    });
    txnAccount.addEventListener('change', txnAccountChanged);
    
    document.querySelectorAll('#reportsSection .tab').forEach(tb => {
      tb.addEventListener('click', (e) => {
        document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
        tb.classList.add('active');
        renderReport(tb.dataset.report);
      });
    });

    document.getElementById('btnExportCsv').addEventListener('click', ()=> exportCurrentReport('csv'));
    document.getElementById('btnExportPdf').addEventListener('click', ()=> exportCurrentReport('pdf'));
    document.getElementById('btnExportXlsx').addEventListener('click', ()=> exportCurrentReport('xlsx'));
  }

  // UI helper functions
  function openUserModal(editId){
    userModalTitle.textContent = editId ? 'Edit User' : 'Add User';
    userEmail.value = ''; userDisplay.value = ''; userRole.value = 'User';
    permView.checked = permEdit.checked = permDelete.checked = false;
    userSave.dataset.edit = editId || '';
    
    // Get password field
    const userPassword = document.getElementById('userPassword');
    if (userPassword) userPassword.value = '';
    
    // No arbitrary limit on user count; canAddUserToBusiness checks MAX_USERS_PER_BUSINESS (Infinity)
    
    if(editId){
      const u = state.users.find(x=>x.id===editId);
      if(u){ userEmail.value = u.email || u.username || ''; userDisplay.value = u.display || u.username || u.email || ''; userRole.value = u.role; permView.checked = !!u.permissions?.view; permEdit.checked = !!u.permissions?.edit; permDelete.checked = !!u.permissions?.delete; }
    }
    openModal(userModal);
  }
  async function saveUser(){
    const email = (userEmail.value||'').trim();
    if(!email) return alert('Email required');
    
    const userPassword = document.getElementById('userPassword');
    const password = userPassword ? userPassword.value.trim() : '';
    
    const editId = userSave.dataset.edit;
    if(editId){
      const u = state.users.find(x=>x.id===editId);
      u.email = email; u.username = email; u.display = userDisplay.value || email; u.role = userRole.value;
      u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked };
      
      // Update password if provided
      if(password && password.length >= 6) {
        u.passwordHash = await sha256Hex(password);
      }
      
      addAudit('user.edit','user',u.id,'Edited user');
    } else {
      // Password required for new users created by admin
      if(!password || password.length < 6) {
        return alert('Password is required for new users (minimum 6 characters)');
      }
      
      // Check 3-user limit per business before adding
      if(selectedBizId && !canAddUserToBusiness(selectedBizId)) {
        return alert('User limit reached! This business already has the maximum of ' + MAX_USERS_PER_BUSINESS + ' users. Cannot add more users.');
      }
      
      // Check email uniqueness
      const existingUser = state.users.find(u => u.email === email || u.username === email);
      if(existingUser) {
        return alert('Email already exists. Please choose a different email.');
      }
      
      // Hash the password
      const passwordHash = await sha256Hex(password);
      
      const newUser = { 
        id: uid('user'), 
        username: email, 
        email: email,
        display: userDisplay.value || email, 
        role: userRole.value, 
        isAdmin: userRole.value==='Admin', 
        passwordHash: passwordHash,
        permissions: { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked }, 
        createdAt: Date.now(), // Use timestamp for 7-day offer check
        tourSeen: true,
        createdByAdmin: true, // Mark as created by admin
        scopedToBusinessId: selectedBizId // Scope to current business
      };
      state.users.push(newUser);
      state.transactions[newUser.id] = state.transactions[newUser.id] || {};
      
      // Only initialize transactions for the scoped business
      if(selectedBizId) {
        state.transactions[newUser.id][selectedBizId] = [];
      }
      
      // Associate user with current business only (admin-created users are scoped)
      if(selectedBizId) {
        const biz = findBiz(selectedBizId);
        if(biz) {
          biz.userIds = biz.userIds || [];
          if(!biz.userIds.includes(newUser.id)) {
            biz.userIds.push(newUser.id);
          }
        }
      }
      
      addAudit('user.add','user',newUser.id,'Admin added user to business: ' + (selectedBizId || 'none'));
    }
    saveState();
    closeModal(userModal);
    refreshSelectors();
    ensureSelection();
    renderAll();
  }

  function openAddBusinessModal(){
    // Check if current user is admin-created (scoped to business)
    const currentUser = state.users.find(u => u.id === state.auth.currentUserId);
    if(currentUser && currentUser.createdByAdmin) {
      return alert('You do not have permission to add businesses. Contact your admin.');
    }
    
    businessModalTitle.textContent = 'Add Business';
    bizName.value = ''; bizOwnerSelect.value = state.users[0] ? state.users[0].id : '';
    bizEntity.value = 'Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate;
    bizTurnoverThreshold.value = DEFAULTS.turnoverThreshold;
    
    // Update turnover threshold select
    const bizTurnoverThresholdSelect = document.getElementById('bizTurnoverThresholdSelect');
    if(bizTurnoverThresholdSelect) {
      bizTurnoverThresholdSelect.value = DEFAULTS.turnoverThreshold;
    }
    
    bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
    bizSave.dataset.edit = '';
    bizContactsList.innerHTML = '';
    
    // Enable entity type selection for new businesses
    bizEntity.disabled = false;
    
    openModal(businessModal);
  }
  function openEditBusinessModal(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId); if(!b) return alert('Business not found');
    
    // Check if current user is admin-created (scoped to business)
    const currentUser = state.users.find(u => u.id === state.auth.currentUserId);
    if(currentUser && currentUser.createdByAdmin) {
      return alert('You do not have permission to edit businesses. Contact your admin.');
    }
    
    businessModalTitle.textContent = 'Edit Business';
    bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (state.users[0] && state.users[0].id) || '';
    bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
    bizTurnoverThreshold.value = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
    
    // Update turnover threshold select
    const bizTurnoverThresholdSelect = document.getElementById('bizTurnoverThresholdSelect');
    if(bizTurnoverThresholdSelect) {
      bizTurnoverThresholdSelect.value = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
    }
    
    bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled;
    bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0;
    const bizRetainedProfitBF = document.getElementById('bizRetainedProfitBF');
    if(bizRetainedProfitBF) bizRetainedProfitBF.value = b.retainedProfitBF || 0;
    bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax;
    bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
    bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0; bizDedNHIS.value = b.statutoryDeductions?.nhis || 0;

    // Accounting period dates
    const bizPeriodStartEl = document.getElementById('bizPeriodStart');
    const bizPeriodEndEl = document.getElementById('bizPeriodEnd');
    if(bizPeriodStartEl) bizPeriodStartEl.value = b.periodStart || '';
    if(bizPeriodEndEl) bizPeriodEndEl.value = b.periodEnd || '';
    
    // Hide Annual Statutory Deductions section by default (shown when editing contact)
    const annualStatutoryDeductionsSection = document.getElementById('annualStatutoryDeductionsSection');
    if(annualStatutoryDeductionsSection) {
      annualStatutoryDeductionsSection.style.display = 'none';
    }
    
    renderBizContacts(b);
    bizSave.dataset.edit = b.id;
    
    // Entity type is always editable
    bizEntity.disabled = false;
    
    openModal(businessModal);
  }
  function saveBusiness(){
    const name = (bizName.value||'').trim();
    if(!name) return alert('Business name required');
    const editId = bizSave.dataset.edit;
    
    // Get turnover threshold from select
    const bizTurnoverThresholdSelect = document.getElementById('bizTurnoverThresholdSelect');
    const turnoverThresholdValue = bizTurnoverThresholdSelect ? Number(bizTurnoverThresholdSelect.value) : Number(bizTurnoverThreshold.value || DEFAULTS.turnoverThreshold);
    
    if(editId){
      const b = findBiz(editId);
      if(!b) return alert('Business not found');
      b.name = name; b.ownerId = bizOwnerSelect.value;
      
      // Entity type is always editable
      b.entity = bizEntity.value;
      
      b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
      b.turnoverThreshold = turnoverThresholdValue;
      b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked;
      b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0);
      const bizRetainedProfitBF = document.getElementById('bizRetainedProfitBF');
      if(bizRetainedProfitBF) b.retainedProfitBF = Number(bizRetainedProfitBF.value || 0);
      b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked;
      b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0), nhis:Number(bizDedNHIS.value||0) };
      // Accounting period
      const bizPeriodStartEl = document.getElementById('bizPeriodStart');
      const bizPeriodEndEl = document.getElementById('bizPeriodEnd');
      if(bizPeriodStartEl) b.periodStart = bizPeriodStartEl.value || '';
      if(bizPeriodEndEl) b.periodEnd = bizPeriodEndEl.value || '';
      addAudit('business.edit','business', b.id, 'Edited business');
    } else {
      const newBiz = {
        id: uid('biz'), name, ownerId: bizOwnerSelect.value || (state.users[0] && state.users[0].id),
        entity: bizEntity.value, 
        vatRate: Number(bizVat.value||DEFAULTS.vatRate), 
        whtRate: Number(bizWht.value||DEFAULTS.whtRate), 
        citRate: Number(bizCit.value||DEFAULTS.citRate),
        turnoverThreshold: turnoverThresholdValue,
        vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
        accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0, nhis:0 },
        lossBroughtForward:0, caCarryForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false, caRateDefault: DEFAULTS.caRateDefault, depRateDefault: DEFAULTS.depRateDefault,
        chargeableLosses: {}, // CGT: { year: { assetClassName: amount } }
        shareDisposalsByYear: {} // CGT: { year: { proceedsSum: number, gainSum: number } }
      };
      // Removed Sales account and chargeable asset accounts as per requirements
      newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
      newBiz.accounts.push({ id: uid('acct'), name:'Purchases', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
      newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
      newBiz.accounts.push({ id: uid('acct'), name:'Bank', category:'Asset', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 });
      newBiz.accounts.push({ id: uid('acct'), name:'VAT Recoverable', category:'Asset', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 });
      newBiz.accounts.push({ id: uid('acct'), name:'VAT Payable', category:'Liability', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 });
      newBiz.accounts.push({ id: uid('acct'), name:'WHT Receivable', category:'Asset', disallowableDefault:false, nonTaxableDefault:false, openingBalance:0, closingBalance:0 });
      newBiz.accounts.push({ id: uid('acct'), name:'Sales Revenue', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
      state.businesses.push(newBiz);
      for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; state.transactions[u.id][newBiz.id] = []; }
      addAudit('business.add','business', newBiz.id, 'Added business');
    }
    saveState();
    closeModal(businessModal);
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    renderAll();
  }

  function addContactToBiz(){
    if(!selectedBizId) return alert('Select business first');
    const b = findBiz(selectedBizId);
    const name = (newContactName.value||'').trim();
    if(!name) return alert('Contact name required');
    b.contacts = b.contacts || [];
    b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 }, taxSettings: { vat:true, wht:true, paye:true, pit:true, cit:true } });
    saveState();
    renderBizContacts(b);
  }

  function addAccount(){
    const name = (newAccountName.value||'').trim();
    const cat = newAccountCategory.value;
    const dis = !!newAccountDisallowable.checked;
    const nt = !!newAccountNonTax.checked;
    if(!name) return alert('Account name required');
    const b = findBiz(selectedBizId);
    b.accounts = b.accounts || [];
    const newAcct = { id: uid('acct'), name, category: cat, disallowableDefault:dis, nonTaxableDefault:nt };
    b.accounts.push(newAcct);
    addAudit('account.add','account', newAcct.id, `Added account: ${name}`);
    saveState();
    
    // Reset input fields to blank state
    newAccountName.value = '';
    newAccountDisallowable.checked = false;
    newAccountNonTax.checked = false;
    
    renderAccounts();
    populateAccountSelect();
  }

  function renderFeatureVisibility(){
    // No entity restrictions needed - all features available for all entities
    const b = findBiz(selectedBizId);
    if (!b) return;
    
    // Show all actions and accounts for all entities
    Array.from(txnAction.options).forEach(opt => { opt.style.display = ''; });
    Array.from(txnAccount.options).forEach(opt => { opt.style.display = ''; });
  }

  function txnActionChanged(){
    const val = txnAction.value;
    if(val === 'Cashbook'){
      // Switch to cashbook tab
      activeTab = 'cashbook';
      renderTab();
      txnAction.value = ''; // Reset dropdown
    } else if(val === 'InventoryPurchase' || val === 'InventorySale'){
      mainTxnForm.style.display = 'none';
      inventorySubform.style.display = 'block';
      assetPurchaseSubform.style.display = 'none';
      assetDisposalSubform.style.display = 'none';
      populateAccountSelect();
      renderFeatureVisibility();
    } else if(val === 'AssetPurchase' || val === 'OpeningAssetBal'){
      mainTxnForm.style.display = 'none';
      assetPurchaseSubform.style.display = 'block';
      assetDisposalSubform.style.display = 'none';
      inventorySubform.style.display = 'none';
      populateAccountSelect();
      renderFeatureVisibility();
      
      // Update UI labels and field behavior for asset actions
      if(val === 'OpeningAssetBal') {
        document.querySelector('#assetPurchaseSubform h3').textContent = 'Opening Asset Balance';
        btnAddAsset.textContent = 'Record Opening Balance';
        // For Opening Asset Bal: disable Cost, auto-compute Opening Cost
        assetCost.disabled = true;
        assetOpeningCost.disabled = false;
        assetOpeningAccDep.disabled = false;
      } else {
        document.querySelector('#assetPurchaseSubform h3').textContent = 'Asset Purchase';
        btnAddAsset.textContent = 'Record Asset Purchase';
        // For Asset Purchase: disable Opening Cost/Acc Dep, auto-compute Cost
        assetCost.disabled = false;
        assetOpeningCost.disabled = true;
        assetOpeningAccDep.disabled = true;
      }
      
      // Set default account to Bank if available
      setDefaultAssetAccount();
    } else if(val === 'AssetDisposal'){
      mainTxnForm.style.display = 'none';
      assetDisposalSubform.style.display = 'block';
      assetPurchaseSubform.style.display = 'none';
      inventorySubform.style.display = 'none';
      populateAccountSelect();
      renderFeatureVisibility();
      // Set default account to Bank if available
      setDefaultAssetAccount();
    } else {
      mainTxnForm.style.display = 'flex';
      inventorySubform.style.display = 'none';
      assetPurchaseSubform.style.display = 'none';
      assetDisposalSubform.style.display = 'none';
      renderFeatureVisibility();
    }
  }

  function txnAccountChanged(){
    const b = findBiz(selectedBizId);
    if(!b) return;
    const acct = findAccount(b, txnAccount.value);
    const isPrep = acct && acct.name === 'Prepayment';
    const amortPeriodLabel = document.getElementById('txnAmortPeriodLabel');
    const amortAccountLabel = document.getElementById('txnAmortAccountLabel');
    const amortAccountSel = document.getElementById('txnAmortAccount');
    if(amortPeriodLabel) amortPeriodLabel.style.display = isPrep ? 'inline-flex' : 'none';
    if(amortAccountLabel) amortAccountLabel.style.display = isPrep ? 'inline-flex' : 'none';
    if(isPrep && amortAccountSel){
      amortAccountSel.innerHTML = '<option value="">-- Select expense account --</option>';
      (b.accounts||[]).filter(a=>a.category==='Expense').forEach(a=>{
        const opt = document.createElement('option');
        opt.value = a.id; opt.textContent = a.name;
        amortAccountSel.appendChild(opt);
      });
    }
  }

  function setDefaultAssetAccount(){
    const b = findBiz(selectedBizId);
    if(!b) return;
    const bankAccount = b.accounts.find(a => a.name === 'Bank' && a.category === 'Asset');
    if(bankAccount){
      if(assetPurchaseAccount) assetPurchaseAccount.value = bankAccount.id;
      if(assetDisposalAccount) assetDisposalAccount.value = bankAccount.id;
    }
  }

  function autoComputeAssetCost(){
    const action = txnAction.value;
    const qty = Number(assetQty.value || 0);
    const unitPrice = Number(assetUnitPrice.value || 0);
    const computed = qty * unitPrice;
    
    if(action === 'AssetPurchase'){
      // Auto-compute Cost
      assetCost.value = computed;
    } else if(action === 'OpeningAssetBal'){
      // Auto-compute Opening Cost
      assetOpeningCost.value = computed;
    }
  }

  function updateAssetNameSuggestions(){
    const category = assetCategory.value;
    const datalist = document.getElementById('assetNameSuggestions');
    datalist.innerHTML = '';
    
    // For "Other Asset" category, provide the removed asset names as suggestions
    if(category === 'Other Asset'){
      const otherAssetNames = ['Shares', 'Options', 'Rights', 'Debt', 'Digital/Virtual Asset'];
      for(const name of otherAssetNames){
        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
      }
    }
  }

  function exportJSON(){
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'ntc_full_data.json'; a.click(); URL.revokeObjectURL(url);
  }
  function importJSON(e){
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const incoming = JSON.parse(r.result);
        if(!confirm('Import will replace current data. Continue?')) return;
        state = incoming;
        migrateState();
        refreshSelectors();
        ensureSelection();
        populateAccountSelect();
        resetForms();
        renderAll();
        saveState();
        alert('Import complete');
      } catch(err){ alert('Invalid JSON'); }
    };
    r.readAsText(f);
  }
  function clearAllData(){
    if(!confirm('Clear all stored data? This action cannot be undone!')) return;
    if(!confirm('Are you absolutely sure? This will delete ALL users, businesses, and transactions!')) return;
    
    // Try to clear data
    try {
      localStorage.removeItem(STORAGE_KEY);
      state = getInitialState();
      seedDemo();
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      resetForms();
      renderAll();
      
      // Log after successful completion
      addAudit('data.clear_all', 'system', null, 'All data cleared');
    } catch(error) {
      console.error('Failed to clear data:', error);
      alert('Failed to clear data. Please check console for details.');
      addAudit('data.clear_all_failed', 'system', null, 'Failed to clear data: ' + error.message);
    }
  }

  /**
   * Get initial state structure
   * @returns {object} Initial state object
   */
  function getInitialState(){
    return {
      users: [],
      businesses: [],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: null }
    };
  }

  // Helper finders
  function findUser(id){ return state.users.find(u=>u.id===id); }
  function findBiz(id){ return state.businesses.find(b=>b.id===id); }
  function findAccount(biz, acctId){ return (biz.accounts||[]).find(a=>a.id===acctId); }

  // UI: selection and refresh
  function refreshSelectors(){
    userSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt); }
    businessSelect.innerHTML = '';
    
    // Filter businesses based on user permissions
    const currentUser = state.users.find(u => u.id === state.auth.currentUserId);
    const isAdministrator = currentUser && currentUser.email === 'salesrepng@gmail.com';
    
    for(const b of state.businesses){
      // Show all businesses to Administrator (salesrepng@gmail.com)
      // Otherwise, only show businesses user created or is scoped to
      const canSee = isAdministrator || 
                     b.ownerId === state.auth.currentUserId || 
                     (currentUser && currentUser.scopedToBusinessId === b.id) ||
                     (currentUser && !currentUser.createdByAdmin); // Users who signed up see all their businesses
      
      if(canSee) {
        const opt = document.createElement('option'); 
        opt.value = b.id; 
        opt.textContent = b.name; 
        businessSelect.appendChild(opt);
      }
    }
    
    bizOwnerSelect.innerHTML = '';
    for(const u of state.users){ const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; bizOwnerSelect.appendChild(opt); }
  }
  function ensureSelection(){
    if(!selectedUserId && state.users[0]) selectedUserId = state.users[0].id;
    if(!selectedBizId && state.businesses[0]) selectedBizId = state.businesses[0].id;
    userSelect.value = selectedUserId || (state.users[0] && state.users[0].id) || '';
    businessSelect.value = selectedBizId || (state.businesses[0] && state.businesses[0].id) || '';
    if(state.auth.currentUserId) selectedUserId = state.auth.currentUserId;
    userSelect.value = selectedUserId;
  }

  function populateAccountSelect(){
    txnAccount.innerHTML = '';
    invAccountSelect.innerHTML = '';
    assetPurchaseAccount.innerHTML = '';
    assetDisposalAccount.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of b.accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' ('+a.category+')';
      txnAccount.appendChild(opt);
      const opt2 = opt.cloneNode(true);
      invAccountSelect.appendChild(opt2);
      const opt3 = opt.cloneNode(true);
      assetPurchaseAccount.appendChild(opt3);
      const opt4 = opt.cloneNode(true);
      assetDisposalAccount.appendChild(opt4);
    }
    renderInventorySelect();
    renderAssetDisposeSelect();
    populateCashbookDropdowns(b);
  }

  function populateCashbookDropdowns(b){
    const bankSel = document.getElementById('cashbookBankAccount');
    const cpSel = document.getElementById('cashbookCounterparty');
    if(!bankSel || !cpSel || !b) return;
    bankSel.innerHTML = '';
    cpSel.innerHTML = '';
    // Add blank option for counterparty
    const blank = document.createElement('option'); blank.value = ''; blank.textContent = '-- None --';
    cpSel.appendChild(blank);
    for(const a of b.accounts){
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' ('+a.category+')';
      bankSel.appendChild(opt);
      const opt2 = opt.cloneNode(true);
      cpSel.appendChild(opt2);
    }
    // Default bank account to "Bank"
    const bankAcct = b.accounts.find(a => a.name === 'Bank');
    if(bankAcct) bankSel.value = bankAcct.id;
  }

  function renderInventorySelect(){
    invItemSelect.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const it of (b.inventory||[])){
      const opt = document.createElement('option'); opt.value = it.id; opt.textContent = it.name + ' (Qty: ' + (it.qty||0) + ')';
      invItemSelect.appendChild(opt);
    }
    const newOpt = document.createElement('option'); newOpt.value = '__new__'; newOpt.textContent = '-- Add new item --'; invItemSelect.appendChild(newOpt);
  }

  function renderAssetDisposeSelect(){
    assetDisposeSelect.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    for(const a of (b.assets||[])){
      if(!a.disposed){
        const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name + ' (Cost: ' + fmt(a.cost) + ')';
        assetDisposeSelect.appendChild(opt);
      }
    }
  }

  // Reset forms and defaults
  function resetForms(){
    txnDate.value = today();
    txnAction.value = '';
    txnAccount.selectedIndex = 0;
    txnDesc.value = '';
    txnAmount.value = '';
    txnVatType.value = 'none';
    txnWht.checked = false; txnWhtRate.value = ''; txnWhtBasis.value='gross';
    txnSalary.checked = false;
    txnContact.value = '';
    txnReceipt.value = '';
    if(txnPaymentStatus) txnPaymentStatus.value = 'Paid';
    if(txnPartAmountLabel) txnPartAmountLabel.style.display = 'none';
    if(txnPartAmount) txnPartAmount.value = '';
    const txnAmortPeriodEl = document.getElementById('txnAmortPeriod');
    const txnAmortAccountLabelEl = document.getElementById('txnAmortAccountLabel');
    const txnAmortPeriodLabelEl = document.getElementById('txnAmortPeriodLabel');
    if(txnAmortPeriodEl) txnAmortPeriodEl.value = '';
    if(txnAmortAccountLabelEl) txnAmortAccountLabelEl.style.display = 'none';
    if(txnAmortPeriodLabelEl) txnAmortPeriodLabelEl.style.display = 'none';

    invItemSelect.value=''; invNewName.value=''; invAccountSelect.selectedIndex=0; invQty.value=''; invUnitPrice.value=''; invVatType.value='none'; invContact.value=''; invReceipt.value=''; invOpeningQty.value=''; invOpeningAvgCost.value='';
    const invPayStatus = document.getElementById('invPaymentStatus');
    const invPartAmtLabel = document.getElementById('invPartAmountLabel');
    const invPartAmtEl = document.getElementById('invPartAmount');
    if(invPayStatus) invPayStatus.value = 'Paid';
    if(invPartAmtLabel) invPartAmtLabel.style.display = 'none';
    if(invPartAmtEl) invPartAmtEl.value = '';

    assetName.value=''; assetQty.value=1; assetUnitPrice.value=''; assetCost.value=''; assetOpeningCost.value=''; assetOpeningAccDep.value=''; assetPurchaseDate.value=''; assetLife.value=''; assetCA.value=''; assetPurchaseAccount.selectedIndex=0; assetClassification.value='Fixed'; assetDepRate.value=''; assetContact.value=''; assetReceipt.value='';
    assetDisposalDate.value=''; assetDisposalProceeds.value=''; assetDisposalAccount.selectedIndex=0; assetDisposalContact.value=''; assetDisposalReceipt.value='';
    const assetPayStatus = document.getElementById('assetPaymentStatus');
    const assetPartAmtLabel = document.getElementById('assetPartAmountLabel');
    const assetPartAmtEl = document.getElementById('assetPartAmount');
    if(assetPayStatus) assetPayStatus.value = 'Paid';
    if(assetPartAmtLabel) assetPartAmtLabel.style.display = 'none';
    if(assetPartAmtEl) assetPartAmtEl.value = '';

    // ensure add button text resets
    btnAddTxn.textContent = 'Add';
    btnAddTxn.dataset.edit = '';
    try { btnAddTxn.removeEventListener('click', saveEditedTxnHandler); } catch(e){}
    try { btnAddTxn.addEventListener('click', handleAddTransaction); } catch(e){}
  }

  // Add transaction (basic)
  function handleAddTransaction(){
    if(!selectedUserId || !selectedBizId) return alert('Select user & business');
    const b = findBiz(selectedBizId);
    
    // Handle adjustment transactions
    if(txnAdjustmentType.value && txnAdjustmentType.value !== ''){
      const adjustmentAmount = Number(txnAdjustmentAmount.value || 0);
      if(adjustmentAmount <= 0) return alert('Adjustment amount required');
      
      const adjTxn = {
        id: uid('txn'),
        date: txnDate.value || today(),
        action: 'Adjustment',
        accountId: txnAccount.value,
        accountName: findAccount(b, txnAccount.value)?.name || '',
        accountCategory: findAccount(b, txnAccount.value)?.category || '',
        description: `Adjustment: ${txnAdjustmentType.value === 'disallowable' ? 'Disallowable expense' : 'Non-taxable income'}`,
        amount: adjustmentAmount,
        adjustmentType: txnAdjustmentType.value,
        vatType: 'none',
        whtApplied: false,
        paye: false,
        contact: '',
        receiptId: null
      };
      pushTransaction(adjTxn);
      return;
    }
    
    const t = {
      id: uid('txn'),
      date: txnDate.value || today(),
      action: txnAction.value || 'Expense',
      accountId: txnAccount.value,
      accountName: findAccount(b, txnAccount.value)?.name || '',
      accountCategory: findAccount(b, txnAccount.value)?.category || '',
      description: txnDesc.value || '',
      amount: Number(txnAmount.value || 0),
      vatType: txnVatType.value || 'none',
      whtApplied: !!txnWht.checked,
      whtRate: Number(txnWhtRate.value || 0),
      whtBasis: txnWhtBasis.value || 'gross',
      paye: !!txnSalary.checked,
      contact: txnContact.value || '',
      paymentStatus: (txnPaymentStatus && txnPaymentStatus.value) || 'Paid',
      partAmount: (txnPaymentStatus && txnPaymentStatus.value === 'Part') ? Number(txnPartAmount && txnPartAmount.value || 0) : undefined,
      amortPeriod: (document.getElementById('txnAmortPeriod') && document.getElementById('txnAmortPeriod').value) ? Number(document.getElementById('txnAmortPeriod').value) : undefined,
      amortAccount: document.getElementById('txnAmortAccount') ? document.getElementById('txnAmortAccount').value : undefined,
      receiptId: null
    };
    
    // WHT Net Basis Gross-Up:
    // When WHT is applied on net basis the amount entered by the user is the NET amount.
    // We derive the GROSS amount (= net / (1 âˆ’ rate)) and store it as t.amount so the ledger
    // always shows the gross value on the main line, while WHT is computed on the net.
    // Works for both Revenue and Expense transaction types.
    if(t.whtApplied && t.whtBasis === 'net'){
      const rateDecimal = Number(t.whtRate || 0) / 100;
      if(rateDecimal > 0 && rateDecimal < 1) {
        const netAmount = t.amount;
        const grossAmount = netAmount / (1 - rateDecimal);
        t.amount = grossAmount;   // Gross recorded on the ledger main line
        t.netAmount = netAmount;  // Net stored for WHT computation reference
      }
    }
    if(txnReceipt.files && txnReceipt.files[0]){
      const r = txnReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        t.receiptId = id;
        pushTransaction(t);
      };
      reader.readAsDataURL(r);
    } else {
      pushTransaction(t);
    }
  }
  function pushTransaction(txn){
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(txn);
    addAudit('txn.add','txn',txn.id, `Added txn ${txn.action} ${txn.amount}`);
    
    // For Part/Unpaid transactions, record outstanding to Accounts Receivable (revenue) or Accounts Payable (expense)
    const b = findBiz(selectedBizId);
    if(b && (txn.paymentStatus === 'Part' || txn.paymentStatus === 'Unpaid')){
      const isRevenue = txn.accountCategory === 'Revenue';
      const isExpense = txn.accountCategory === 'Expense';
      const totalAmt = Number(txn.amount || 0);
      const paidAmt = txn.paymentStatus === 'Part' ? Number(txn.partAmount || 0) : 0;
      const outstanding = totalAmt - paidAmt;
      if(outstanding > 0 && (isRevenue || isExpense)){
        const acctName = isRevenue ? 'Accounts Receivable' : 'Accounts Payable';
        const acctCategory = isRevenue ? 'Asset' : 'Liability';
        let outstandingAcct = b.accounts.find(a => a.name === acctName);
        if(!outstandingAcct){
          outstandingAcct = { id: uid('acct'), name: acctName, category: acctCategory, disallowableDefault: false, nonTaxableDefault: false, openingBalance: 0 };
          b.accounts.push(outstandingAcct);
        }
        const outstandingTxn = {
          id: uid('txn'),
          date: txn.date,
          action: txn.action,
          accountId: outstandingAcct.id,
          accountName: outstandingAcct.name,
          accountCategory: acctCategory,
          description: `Outstanding: ${txn.description || ''}`,
          amount: outstanding,
          vatType: 'none',
          whtApplied: false,
          paye: false,
          contact: txn.contact || '',
          linkedTxnId: txn.id,
          isOutstanding: true
        };
        state.transactions[selectedUserId][selectedBizId].push(outstandingTxn);
      }
    }
    
    saveState();
    resetForms();
    txnAction.value=''; inventorySubform.style.display='none'; assetPurchaseSubform.style.display='none'; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex';
    renderAll();
    refreshAllReports(); // Refresh all reports when transaction is added
  }

  // Inventory handlers
  function handleInventoryAction(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const selectedItemId = invItemSelect.value;
    let inventoryItemId = null;
    let prevState = null; // Store previous inventory state for undo/delete reversal
    let isNewItem = false;
    
    if(selectedItemId === '__new__'){
      const name = (invNewName.value || '').trim();
      if(!name) return alert('New item name required');
      const item = { id: uid('item'), name, qty: Number(invQty.value||0), avgCost: Number(invUnitPrice.value || 0) };
      if(Number(invOpeningQty.value)){
        item.qty = Number(invOpeningQty.value);
        item.avgCost = Number(invOpeningAvgCost.value || item.avgCost);
      }
      b.inventory = b.inventory || [];
      b.inventory.push(item);
      inventoryItemId = item.id;
      isNewItem = true;
      // For new items, store that this was a new item creation (no previous state)
      prevState = { isNewItem: true, itemId: item.id };
      addAudit('inv.add','inventory', item.id, `Added inventory ${item.name}`, { amount: item.qty * item.avgCost, qty: item.qty, avgCost: item.avgCost });
    } else {
      const item = (b.inventory||[]).find(x=>x.id===selectedItemId);
      if(!item) return alert('Item not found');
      inventoryItemId = item.id;
      // Store previous state before modification
      prevState = { isNewItem: false, itemId: item.id, prevQty: item.qty || 0, prevAvgCost: item.avgCost || 0 };
      const qty = Number(invQty.value || 0);
      const unit = Number(invUnitPrice.value || 0);
      if(txnAction.value === 'InventoryPurchase'){
        const existingValue = (item.qty || 0) * (item.avgCost || 0);
        const incomingValue = qty * unit;
        const newQty = (item.qty || 0) + qty;
        item.avgCost = newQty ? ((existingValue + incomingValue) / newQty) : item.avgCost;
        item.qty = newQty;
      } else if(txnAction.value === 'InventorySale'){
        item.qty = (item.qty || 0) - qty;
        if(item.qty < 0) item.qty = 0;
      }
      addAudit('inv.update','inventory', item.id, `Inventory updated ${item.name}`, { amount: qty * unit, qty: qty, prevQty: prevState.prevQty, prevAvgCost: prevState.prevAvgCost });
    }
    const invPayStatus = document.getElementById('invPaymentStatus');
    const invPartAmt = document.getElementById('invPartAmount');
    const t = { 
      id: uid('txn'), 
      date: today(), 
      action: txnAction.value || 'InventoryPurchase', 
      accountId: invAccountSelect.value, 
      accountName: findAccount(b, invAccountSelect.value)?.name || '', 
      accountCategory: findAccount(b, invAccountSelect.value)?.category || '', 
      description: 'Inventory '+ (invNewName.value||findItemName(invItemSelect.value)), 
      qty: Number(invQty.value||0), 
      unitPrice: Number(invUnitPrice.value||0), 
      amount: Number((invQty.value||0)*(invUnitPrice.value||0)), 
      vatType: invVatType.value || 'none', 
      whtApplied: false, 
      paye: false, 
      contact: invContact.value || '',
      paymentStatus: invPayStatus ? invPayStatus.value : 'Paid',
      partAmount: (invPayStatus && invPayStatus.value === 'Part') ? Number(invPartAmt && invPartAmt.value || 0) : undefined,
      receiptId: null, 
      inventoryItemId: inventoryItemId, 
      inventoryPrevState: prevState 
    };
    if(invReceipt.files && invReceipt.files[0]){
      const r = invReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        t.receiptId = id;
        pushInventoryTxn(t);
      };
      reader.readAsDataURL(r);
    } else pushInventoryTxn(t);
  }
  function pushInventoryTxn(t){
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('txn.inv','txn',t.id, `Inventory txn ${t.action} ${t.amount}`, { amount: t.amount, qty: t.qty, unitPrice: t.unitPrice });

    // Auto-record COGS when an Inventory Sale is saved (weighted average cost basis).
    // COGS = qty sold Ã— weighted average cost at time of sale (stored in inventoryPrevState.prevAvgCost).
    if(t.action === 'InventorySale') {
      const b = findBiz(selectedBizId);
      const cogsAcct = (b && b.accounts || []).find(a => a.name === 'COGS' && a.category === 'Expense');
      if(cogsAcct) {
        const avgCost = (t.inventoryPrevState && !t.inventoryPrevState.isNewItem)
          ? Number(t.inventoryPrevState.prevAvgCost || 0)
          : 0;
        const cogsAmount = Number(t.qty || 0) * avgCost;
        if(cogsAmount > 0) {
          const cogsTxn = {
            id: uid('txn'),
            date: t.date,
            action: 'Expense',
            accountId: cogsAcct.id,
            accountName: cogsAcct.name,
            accountCategory: 'Expense',
            description: 'COGS â€“ auto (sale: ' + (t.description || t.id) + ')',
            amount: cogsAmount,
            vatType: 'none',
            whtApplied: false,
            paye: false,
            contact: t.contact || '',
            receiptId: null,
            linkedInventoryTxnId: t.id, // link back to the sale transaction
            isCOGS: true
          };
          state.transactions[selectedUserId][selectedBizId].push(cogsTxn);
          addAudit('txn.cogs','txn',cogsTxn.id,`Auto COGS for sale ${t.id}: ${cogsAmount}`,{ amount: cogsAmount, qty: t.qty, avgCost: avgCost });
        }
      }
    }

    // For Part/Unpaid inventory transactions, post outstanding to AR (sales) or AP (purchases)
    if(t.paymentStatus === 'Part' || t.paymentStatus === 'Unpaid'){
      const bInv = findBiz(selectedBizId);
      if(bInv){
        const isRevenue = t.action === 'InventorySale';
        const totalAmt = Number(t.amount || 0);
        const paidAmt = t.paymentStatus === 'Part' ? Number(t.partAmount || 0) : 0;
        const outstanding = totalAmt - paidAmt;
        if(outstanding > 0){
          const acctName = isRevenue ? 'Accounts Receivable' : 'Accounts Payable';
          const acctCategory = isRevenue ? 'Asset' : 'Liability';
          let outstandingAcct = bInv.accounts.find(a => a.name === acctName);
          if(!outstandingAcct){
            outstandingAcct = { id: uid('acct'), name: acctName, category: acctCategory, disallowableDefault: false, nonTaxableDefault: false, openingBalance: 0 };
            bInv.accounts.push(outstandingAcct);
          }
          state.transactions[selectedUserId][selectedBizId].push({
            id: uid('txn'), date: t.date, action: t.action,
            accountId: outstandingAcct.id, accountName: outstandingAcct.name, accountCategory: acctCategory,
            description: `Outstanding: ${t.description || ''}`, amount: outstanding,
            vatType: 'none', whtApplied: false, paye: false, contact: t.contact || '',
            linkedTxnId: t.id, isOutstanding: true
          });
        }
      }
    }

    saveState();
    txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex';
    resetForms();
    renderAll();
    refreshAllReports(); // Refresh all reports when inventory changes
  }
  
  /**
   * Reverts inventory state based on transaction data.
   * @param {Object} tx - The transaction being undone/deleted
   * @param {Object} b - The business object
   */
  function revertInventoryState(tx, b) {
    if(!tx || !b) return;
    const prevState = tx.inventoryPrevState;
    if(!prevState) return; // No previous state stored, can't revert
    
    if(prevState.isNewItem) {
      // This was a new item creation, remove the item from inventory
      b.inventory = (b.inventory || []).filter(item => item.id !== prevState.itemId);
    } else {
      // This was an update to existing item, restore previous state
      const item = (b.inventory || []).find(x => x.id === prevState.itemId);
      if(item) {
        item.qty = prevState.prevQty;
        item.avgCost = prevState.prevAvgCost;
      }
    }
  }
  
  function handleUndoInventory(){
    const arr = state.transactions[selectedUserId][selectedBizId];
    const b = findBiz(selectedBizId);
    for(let i=arr.length-1;i>=0;i--){
      if(arr[i].action && arr[i].action.startsWith('Inventory')){
        const tx = arr[i];
        // Revert inventory state before removing the transaction
        revertInventoryState(tx, b);
        arr.splice(i,1);
        addAudit('txn.undo','txn',tx.id || '','Undo inventory txn - inventory state reverted', { amount: tx.amount, qty: tx.qty, action: tx.action });
        saveState();
        renderAll();
        refreshAllReports();
        return alert('Undid last inventory transaction. Inventory state has been reverted.');
      }
    }
    alert('No inventory transaction found to undo');
  }

  // Asset handlers
  function handleAddAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    const isOpeningBalance = txnAction.value === 'OpeningAssetBal';
    
    // Auto-select Bank account for cash leg
    const bankAcct = b.accounts.find(a => a.name === 'Bank');
    if(bankAcct && assetPurchaseAccount) assetPurchaseAccount.value = bankAcct.id;
    
    // For opening balance: auto-compute opening cost from qty * unit price
    let computedCost = Number(assetQty.value || 1) * Number(assetUnitPrice.value || 0);
    let computedOpeningCost = isOpeningBalance ? computedCost : Number(assetOpeningCost.value || 0);
    
    const item = {
      id: uid('asset'),
      name: assetName.value || 'Asset',
      category: assetCategory.value || 'Other Asset',
      qty: Number(assetQty.value || 1),
      unitPrice: Number(assetUnitPrice.value || 0),
      cost: isOpeningBalance ? 0 : computedCost, // Opening balance sets cost to 0, openingCost holds value
      openingCost: computedOpeningCost,
      openingAccDep: Number(assetOpeningAccDep.value || 0),
      purchaseDate: assetPurchaseDate.value || today(),
      lifeYears: Number(assetLife.value || 0),
      caPercent: Number(assetCA.value || findBiz(selectedBizId)?.caRateDefault || DEFAULTS.caRateDefault),
      depRate: Number(assetDepRate.value || findBiz(selectedBizId)?.depRateDefault || DEFAULTS.depRateDefault),
      classification: assetClassification.value || 'Fixed',
      accumulatedDep: Number(assetOpeningAccDep.value || 0), // Deprecated: use accumulatedDepreciation
      accumulatedDepreciation: Number(assetOpeningAccDep.value || 0), // CGT: accumulated depreciation for TWDV calculation
      capitalAllowances: [], // CGT: array of {date: 'YYYY-MM-DD', amount: number}
      disposed: false,
      disposal: {}
    };
    b.assets = b.assets || [];
    b.assets.push(item);
    
    const actionType = isOpeningBalance ? 'OpeningAssetBal' : 'AssetPurchase';
    const txnAmount = isOpeningBalance ? computedOpeningCost : computedCost;
    const assetPayStatus = document.getElementById('assetPaymentStatus');
    const assetPartAmt = document.getElementById('assetPartAmount');
    const t = { 
      id: uid('txn'), 
      date: item.purchaseDate, 
      action: actionType, 
      accountId: assetPurchaseAccount.value, 
      accountName: findAccount(b, assetPurchaseAccount.value)?.name || '', 
      accountCategory: findAccount(b, assetPurchaseAccount.value)?.category || '', 
      description: isOpeningBalance ? `Opening balance: ${item.name}` : `Asset purchase ${item.name}`, 
      amount: txnAmount, 
      qty: item.qty, 
      unitPrice: item.unitPrice, 
      vatType:'none', 
      whtApplied:false, 
      paye:false, 
      contact: assetContact.value || '',
      paymentStatus: assetPayStatus ? assetPayStatus.value : 'Paid',
      partAmount: (assetPayStatus && assetPayStatus.value === 'Part') ? Number(assetPartAmt && assetPartAmt.value || 0) : undefined,
      receiptId:null,
      assetId: item.id,
      assetPrevState: { isNewAsset: true, assetId: item.id }
    };
    if(assetReceipt.files && assetReceipt.files[0]){
      const r = assetReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        t.receiptId = id;
        pushAssetTxn(t);
      };
      reader.readAsDataURL(r);
    } else pushAssetTxn(t);
  }
  function pushAssetTxn(t){
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('asset.add','asset',t.id, `Added asset txn ${t.description}`, { amount: t.amount, qty: t.qty, assetId: t.assetId });
    // For Part/Unpaid asset purchases, post outstanding to Accounts Payable
    if((t.paymentStatus === 'Part' || t.paymentStatus === 'Unpaid') && t.action !== 'AssetDisposal'){
      const bAsset = findBiz(selectedBizId);
      if(bAsset){
        const totalAmt = Number(t.amount || 0);
        const paidAmt = t.paymentStatus === 'Part' ? Number(t.partAmount || 0) : 0;
        const outstanding = totalAmt - paidAmt;
        if(outstanding > 0){
          let apAcct = bAsset.accounts.find(a => a.name === 'Accounts Payable');
          if(!apAcct){
            apAcct = { id: uid('acct'), name: 'Accounts Payable', category: 'Liability', disallowableDefault: false, nonTaxableDefault: false, openingBalance: 0 };
            bAsset.accounts.push(apAcct);
          }
          state.transactions[selectedUserId][selectedBizId].push({
            id: uid('txn'), date: t.date, action: t.action,
            accountId: apAcct.id, accountName: apAcct.name, accountCategory: 'Liability',
            description: `Outstanding: ${t.description || ''}`, amount: outstanding,
            vatType: 'none', whtApplied: false, paye: false, contact: t.contact || '',
            linkedTxnId: t.id, isOutstanding: true
          });
        }
      }
    }
    saveState();
    txnAction.value=''; assetPurchaseSubform.style.display='none'; mainTxnForm.style.display='flex';
    resetForms();
    renderAll();
    refreshAllReports(); // Refresh all reports when asset is added
  }
  function handleDisposeAsset(){
    if(!selectedBizId) return alert('Select business');
    const b = findBiz(selectedBizId);
    // Auto-select Bank account for cash leg
    const bankAcctDisp = b.accounts.find(a => a.name === 'Bank');
    if(bankAcctDisp && assetDisposalAccount) assetDisposalAccount.value = bankAcctDisp.id;
    const aid = assetDisposeSelect.value;
    const asset = (b.assets||[]).find(a=>a.id===aid);
    if(!asset) return alert('Select asset to dispose');
    
    const qtyDisposed = Number(assetDisposalQty.value || 1);
    if(qtyDisposed > (asset.qty || 1)) return alert('Cannot dispose more than available quantity');
    
    // Store previous asset state for undo/delete reversal
    // Use structuredClone if available, otherwise shallow copy the disposal object
    const prevDisposal = asset.disposal 
      ? (typeof structuredClone === 'function' 
          ? structuredClone(asset.disposal) 
          : Object.assign({}, asset.disposal))
      : {};
    const assetPrevState = {
      isNewAsset: false,
      assetId: asset.id,
      prevQty: asset.qty || 1,
      prevDisposed: asset.disposed,
      prevDisposal: prevDisposal
    };
    
    const disposalDate = assetDisposalDate.value || today();
    const disposalProceeds = Number(assetDisposalProceeds.value || 0);
    const disposalYear = new Date(disposalDate).getFullYear();
    
    asset.disposed = qtyDisposed >= (asset.qty || 1); // Fully disposed if qty matches
    asset.disposal = { 
      date: disposalDate, 
      proceeds: disposalProceeds, 
      qty: qtyDisposed,
      accountId: assetDisposalAccount.value || '', 
      accountName: findAccount(b, assetDisposalAccount.value)?.name || '' 
    };
    
    // CGT: Compute Tax Written Down Value (TWDV) using new helper
    // If no CA claimed, TWDV = cost; otherwise TWDV = cost - CA claimed
    const twdv = computeTaxWrittenDownValue(asset, disposalDate);
    
    // CGT: Compute chargeable gain/loss using new helper
    const chargeableGain = computeChargeableGain(asset, disposalProceeds, disposalDate);
    
    asset.disposal.gain = chargeableGain;
    asset.disposal.twdv = twdv;
    
    // Initialize CGT tracking variables
    let cgtCharge = 0;
    let netGainAfterOffset = chargeableGain;
    let lossCarriedForward = 0;
    let offsetUsed = 0;
    let isShareExempt = false;
    let includedInTaxableProfit = false;
    
    // CGT: Apply disposal rules for Chargeable classification
    // Applies to property assets (PPE, land, building) and share assets
    if(asset.classification === 'Chargeable' && (isPropertyAsset(asset) || isShareAsset(asset))) {
      
      if(chargeableGain < 0) {
        // Loss: record carryforward loss under business.chargeableLosses[disposalYear][asset.category]
        // Do NOT apply the loss to current-year gains (only next accounting periods)
        lossCarriedForward = Math.abs(chargeableGain);
        recordCarryforwardLoss(b, disposalYear, asset.category, lossCarriedForward);
        addAudit('cgt.carryforward_loss', 'asset', asset.id, 
          `Carryforward loss recorded: ${fmt(lossCarriedForward)} for ${asset.category} in year ${disposalYear}`, 
          { lossAmount: lossCarriedForward, year: disposalYear, assetClass: asset.category });
        netGainAfterOffset = 0;
        
      } else if(chargeableGain > 0) {
        // Gain: first offset with prior-year carryforwards for same asset class
        const offsetResult = offsetWithCarryforward(b, asset.category, chargeableGain, disposalYear);
        netGainAfterOffset = offsetResult.remainingGain;
        offsetUsed = offsetResult.used;
        
        if(offsetUsed > 0) {
          addAudit('cgt.offset_applied', 'asset', asset.id, 
            `Carryforward loss offset applied: ${fmt(offsetUsed)} reducing gain from ${fmt(chargeableGain)} to ${fmt(netGainAfterOffset)}`, 
            { originalGain: chargeableGain, offsetUsed: offsetUsed, remainingGain: netGainAfterOffset });
        }
        
        // CGT: Evaluate share-exemption
        if(isShareAsset(asset)) {
          // Update share disposals aggregation FIRST
          updateShareDisposals(b, disposalYear, disposalProceeds, netGainAfterOffset);
          
          // Check if year's share disposals qualify for exemption
          isShareExempt = isShareDisposalExempt(b, disposalYear);
          
          if(isShareExempt) {
            addAudit('cgt.share_exempt', 'asset', asset.id, 
              `Share disposal exempt - Year ${disposalYear} aggregates: proceeds ${fmt(b.shareDisposalsByYear[disposalYear]?.proceedsSum || 0)}, gain ${fmt(b.shareDisposalsByYear[disposalYear]?.gainSum || 0)}`,
              { disposalYear: disposalYear, isExempt: true });
          }
        }
        
        // CGT: Apply entity-specific rules for net (post-offset) gain
        if(netGainAfterOffset > 0 && !isShareExempt) {
          if(b.entity === 'Business' || b.entity === 'Enterprise Plus' || b.entity === 'Enterprise') {
            // Business or Enterprise: include netGain in taxable profit
            includedInTaxableProfit = true;
            addAudit('cgt.taxable_profit', 'asset', asset.id, 
              `Chargeable gain ${fmt(netGainAfterOffset)} included in taxable profit for ${b.entity}`,
              { entityType: b.entity, netGain: netGainAfterOffset, includedInTaxableProfit: true });
            
          } else if(b.entity === 'Company') {
            // Company: check turnover threshold
            const turnoverThreshold = Number(b.turnoverThreshold || 0);
            
            if(turnoverThreshold <= 100000000) {
              // Turnover threshold <= â‚¦100,000,000: do NOT include in taxable profit and do NOT charge CGT
              includedInTaxableProfit = false;
              cgtCharge = 0;
              addAudit('cgt.company_exempt', 'asset', asset.id, 
                `Company with turnover threshold ${fmt(turnoverThreshold)} <= â‚¦100,000,000: No CGT charged, gain not included in taxable profit`,
                { turnoverThreshold: turnoverThreshold, netGain: netGainAfterOffset, cgtCharge: 0 });
                
            } else {
              // Turnover threshold > â‚¦100,000,000: do NOT include in taxable profit but charge CGT at 30%
              includedInTaxableProfit = false;
              cgtCharge = Math.round(netGainAfterOffset * CGT_COMPANY_RATE * 100) / 100;
              addAudit('cgt.charge', 'asset', asset.id, 
                `CGT Charge: ${fmt(cgtCharge)} (30% of ${fmt(netGainAfterOffset)}) for Company with turnover threshold ${fmt(turnoverThreshold)}`,
                { turnoverThreshold: turnoverThreshold, netGain: netGainAfterOffset, cgtRate: CGT_COMPANY_RATE, cgtCharge: cgtCharge });
            }
          }
        }
      }
    }
    
    // Store CGT computation results on the disposal object
    asset.disposal.chargeableGain = chargeableGain;
    asset.disposal.netGainAfterOffset = netGainAfterOffset;
    asset.disposal.offsetUsed = offsetUsed;
    asset.disposal.lossCarriedForward = lossCarriedForward;
    asset.disposal.cgtCharge = cgtCharge;
    asset.disposal.includedInTaxableProfit = includedInTaxableProfit;
    asset.disposal.isShareExempt = isShareExempt;
    asset.disposal.disposalYear = disposalYear;
    
    // Update asset qty if partial disposal
    if(!asset.disposed) {
      asset.qty = (asset.qty || 1) - qtyDisposed;
    }
    
    // Build transaction description with CGT details
    let txnDesc = `Asset disposal ${asset.name} (qty: ${qtyDisposed})`;
    if(cgtCharge > 0) {
      txnDesc += ` | CGT Charge: ${fmt(cgtCharge)}`;
    }
    if(lossCarriedForward > 0) {
      txnDesc += ` | Loss c/f: ${fmt(lossCarriedForward)}`;
    }
    
    addAudit('asset.dispose','asset',asset.id, `Disposed asset ${asset.name} qty ${qtyDisposed} gain ${chargeableGain} netGain ${netGainAfterOffset}`, { amount: asset.disposal.proceeds, qty: qtyDisposed, gain: chargeableGain, netGain: netGainAfterOffset, cgtCharge: cgtCharge });
    
    const t = { 
      id: uid('txn'), 
      date: asset.disposal.date, 
      action: 'AssetDisposal', 
      accountId: assetDisposalAccount.value, 
      accountName: findAccount(b, assetDisposalAccount.value)?.name || '', 
      accountCategory: findAccount(b, assetDisposalAccount.value)?.category || '', 
      description: txnDesc, 
      amount: asset.disposal.proceeds, 
      gain: chargeableGain, 
      netGain: netGainAfterOffset,
      cgtCharge: cgtCharge,
      qty: qtyDisposed, 
      vatType:'none', 
      whtApplied:false, 
      paye:false, 
      contact: assetDisposalContact.value || '', 
      receiptId:null, 
      assetId: asset.id, 
      assetPrevState: assetPrevState 
    };
    
    if(assetDisposalReceipt.files && assetDisposalReceipt.files[0]){
      const r = assetDisposalReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        t.receiptId = id;
        pushAssetDisposeTxn(t);
      };
      reader.readAsDataURL(r);
    } else pushAssetDisposeTxn(t);
  }
  function pushAssetDisposeTxn(t){
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(t);
    addAudit('txn.asset.dispose','txn',t.id, `Asset disposal txn ${t.amount} | CGT: ${fmt(t.cgtCharge || 0)}`, { amount: t.amount, qty: t.qty, gain: t.gain, netGain: t.netGain, cgtCharge: t.cgtCharge, assetId: t.assetId });
    saveState();
    txnAction.value=''; assetDisposalSubform.style.display='none'; mainTxnForm.style.display='flex';
    resetForms();
    renderAll();
    refreshAllReports(); // Refresh all reports when asset is disposed
  }
  
  /**
   * Reverts asset state based on transaction data.
   * For transactions with assetPrevState, uses the stored state.
   * For legacy transactions without assetPrevState, applies safe fallback behavior.
   * @param {Object} tx - The transaction being undone/deleted
   * @param {Object} b - The business object
   */
  function revertAssetState(tx, b) {
    if(!tx || !b) return;
    const prevState = tx.assetPrevState;
    
    // Handle transactions with stored previous state
    if(prevState) {
      if(prevState.isNewAsset) {
        // This was a new asset creation, remove the asset
        b.assets = (b.assets || []).filter(a => a.id !== prevState.assetId);
      } else if(tx.action === 'AssetDisposal') {
        // This was a disposal, restore previous state
        const asset = (b.assets || []).find(a => a.id === tx.assetId);
        if(asset) {
          asset.qty = prevState.prevQty;
          asset.disposed = prevState.prevDisposed;
          asset.disposal = prevState.prevDisposal || {};
        }
      }
      return;
    }
    
    // Fallback for legacy transactions without assetPrevState
    // For asset purchases/opening balances: remove the asset if it exists
    if((tx.action === 'AssetPurchase' || tx.action === 'OpeningAssetBal') && tx.assetId) {
      b.assets = (b.assets || []).filter(a => a.id !== tx.assetId);
    } 
    // For asset disposals: restore the asset to not disposed state
    else if(tx.action === 'AssetDisposal' && tx.assetId) {
      const asset = (b.assets || []).find(a => a.id === tx.assetId);
      if(asset) {
        // Restore quantity from transaction if available
        if(tx.qty) {
          asset.qty = (asset.qty || 0) + tx.qty;
        }
        asset.disposed = false;
        asset.disposal = {};
      }
    }
  }
  
  function handleUndoAsset(){
    const arr = state.transactions[selectedUserId][selectedBizId] || [];
    const b = findBiz(selectedBizId);
    for(let i=arr.length-1;i>=0;i--){
      if(arr[i].action && (arr[i].action === 'AssetPurchase' || arr[i].action === 'AssetDisposal' || arr[i].action === 'OpeningAssetBal')){
        const tx = arr[i];
        // Revert asset state before removing the transaction
        revertAssetState(tx, b);
        arr.splice(i,1);
        addAudit('txn.undo','txn',tx.id || '','Undo asset txn - asset state reverted', { amount: tx.amount, action: tx.action, assetId: tx.assetId });
        saveState();
        renderAll();
        refreshAllReports();
        return alert('Undid last asset transaction. Asset state has been reverted.');
      }
    }
    alert('No asset transaction found to undo');
  }

  // Find item name helper (fixed)
  function findItemName(id){
    const b = findBiz(selectedBizId);
    if(!b) return '';
    const it = (b.inventory||[]).find(x=>x.id===id);
    return it ? it.name : '';
  }

  // Ledger rendering & edit (fixed to avoid inline onclick string issues)
  function renderLedger(){
    ledgerTableBody.innerHTML = '';
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    const search = (document.getElementById('ledgerSearch').value || '').toLowerCase();
    
    // Check if current user is view-only
    const currentUser = state.users.find(u => u.id === state.auth.currentUserId);
    const isViewOnly = currentUser && currentUser.permissions && currentUser.permissions.view && !currentUser.permissions.edit;
    
    for(const t of arr){
      if(search){
        const hay = `${t.date} ${t.action} ${t.accountName || ''} ${t.description || ''} ${t.amount || ''} ${t.contact || ''}`.toLowerCase();
        if(!hay.includes(search)) continue;
      }
      const tr = document.createElement('tr');

      const tdDate = document.createElement('td'); tdDate.textContent = t.date || '';
      const tdAction = document.createElement('td'); 
      // Show "(view)" for view-only users
      tdAction.textContent = t.action + (isViewOnly ? ' (view)' : '');
      const tdAccount = document.createElement('td'); tdAccount.textContent = t.accountName || '';
      const tdDesc = document.createElement('td'); tdDesc.textContent = t.description || '';
      const tdAmount = document.createElement('td');
      // For net-basis WHT transactions, show gross with a note so it's clear
      if(t.whtApplied && t.whtBasis === 'net' && t.netAmount != null) {
        tdAmount.innerHTML = fmt(t.amount||0) + '<br><small style="color:#64748b">Net: ' + fmt(t.netAmount) + '</small>';
      } else {
        tdAmount.textContent = fmt(t.amount||0);
      }
      const tdVat = document.createElement('td'); tdVat.textContent = t.vatType || '';
      const tdWht = document.createElement('td');
      if(t.whtApplied) {
        const rate = t.whtRate || findBiz(selectedBizId)?.whtRate || DEFAULTS.whtRate;
        const whtAmt = t.whtBasis === 'net' && t.netAmount != null
          ? t.netAmount * (rate / 100)  // WHT on net amount
          : (t.amount || 0) * (rate / 100); // WHT on gross
        const netLabel = t.whtBasis === 'net' ? ' (net)' : '';
        tdWht.innerHTML = `${rate}%<br><small style="color:#64748b">â‚¦${whtAmt.toFixed(2)}${netLabel}</small>`;
      }
      const tdPaye = document.createElement('td'); tdPaye.textContent = t.paye ? 'Yes' : '';
      const tdPayment = document.createElement('td'); tdPayment.textContent = t.paymentStatus || '';
      const tdContact = document.createElement('td'); tdContact.textContent = t.contact || '';
      const tdReceipt = document.createElement('td');
      if(t.receiptId){
        const link = document.createElement('span');
        link.className = 'link-like';
        link.textContent = 'View';
        link.addEventListener('click', ()=> viewReceipt(t.receiptId));
        tdReceipt.appendChild(link);
      } else {
        tdReceipt.textContent = '';
      }
      const tdActions = document.createElement('td');

      // Hide edit/delete buttons for view-only users
      if(!isViewOnly) {
        const editBtn = document.createElement('button'); editBtn.textContent = 'Edit'; editBtn.className='small';
        editBtn.addEventListener('click', ()=> openEditTxn(t));
        const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='small danger';
        delBtn.addEventListener('click', ()=> { if(!confirm('Delete txn?')) return; deleteTxn(t.id); });

        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);
      }

      tr.appendChild(tdDate);
      tr.appendChild(tdAction);
      tr.appendChild(tdAccount);
      tr.appendChild(tdDesc);
      tr.appendChild(tdAmount);
      tr.appendChild(tdVat);
      tr.appendChild(tdWht);
      tr.appendChild(tdPaye);
      tr.appendChild(tdPayment);
      tr.appendChild(tdContact);
      tr.appendChild(tdReceipt);
      tr.appendChild(tdActions);

      ledgerTableBody.appendChild(tr);
    }
  }

  function viewReceipt(id){
    const att = state.attachments[id];
    if(!att) return alert('Receipt not found');
    const w = window.open('', '_blank');
    w.document.write(`<h3>${att.name}</h3><img src="${att.data}" style="max-width:100%"/>`);
  }

  function openEditTxn(tx){
    if(!tx) return;
    if(tx.action === 'InventoryPurchase' || tx.action === 'InventorySale'){
      txnAction.value = tx.action;
      mainTxnForm.style.display='none';
      inventorySubform.style.display='block';
      assetPurchaseSubform.style.display='none';
      assetDisposalSubform.style.display='none';
      renderInventorySelect();
      invNewName.value = tx.description || '';
      invQty.value = tx.qty || '';
      invUnitPrice.value = tx.unitPrice || '';
      invContact.value = tx.contact || '';
      return;
    } else if(tx.action === 'AssetPurchase'){
      txnAction.value = tx.action;
      mainTxnForm.style.display='none';
      assetPurchaseSubform.style.display='block';
      inventorySubform.style.display='none';
      assetDisposalSubform.style.display='none';
      assetName.value = tx.description || '';
      assetCost.value = tx.amount || '';
      assetQty.value = tx.qty || 1;
      assetUnitPrice.value = tx.unitPrice || '';
      assetContact.value = tx.contact || '';
      return;
    } else if(tx.action === 'AssetDisposal'){
      txnAction.value = tx.action;
      mainTxnForm.style.display='none';
      assetDisposalSubform.style.display='block';
      assetPurchaseSubform.style.display='none';
      inventorySubform.style.display='none';
      assetDisposalDate.value = tx.date || '';
      assetDisposalProceeds.value = tx.amount || '';
      assetDisposalContact.value = tx.contact || '';
      return;
    }
    txnDate.value = tx.date || today();
    txnAction.value = tx.action || '';
    txnAccount.value = tx.accountId || '';
    txnDesc.value = tx.description || '';
    txnAmount.value = tx.amount || '';
    txnVatType.value = tx.vatType || 'none';
    txnWht.checked = !!tx.whtApplied; txnWhtRate.value = tx.whtRate || '';
    txnSalary.checked = !!tx.paye;
    txnContact.value = tx.contact || '';

    btnAddTxn.textContent = 'Save';
    btnAddTxn.dataset.edit = tx.id;
    btnAddTxn.removeEventListener('click', handleAddTransaction);
    btnAddTxn.addEventListener('click', saveEditedTxnHandler);
  }

  function saveEditedTxnHandler(){
    const editId = btnAddTxn.dataset.edit;
    if(!editId) return;
    const arr = state.transactions[selectedUserId][selectedBizId];
    const tx = arr.find(x=>x.id===editId);
    if(!tx) return alert('Transaction not found');
    tx.date = txnDate.value || tx.date;
    tx.action = txnAction.value || tx.action;
    tx.accountId = txnAccount.value;
    tx.accountName = findAccount(findBiz(selectedBizId), txnAccount.value)?.name || tx.accountName;
    tx.accountCategory = findAccount(findBiz(selectedBizId), txnAccount.value)?.category || tx.accountCategory;
    tx.description = txnDesc.value;
    tx.amount = Number(txnAmount.value || 0);
    tx.vatType = txnVatType.value;
    tx.whtApplied = !!txnWht.checked; tx.whtRate = Number(txnWhtRate.value || 0); tx.whtBasis = txnWhtBasis.value || 'gross';
    tx.paye = !!txnSalary.checked;
    tx.contact = txnContact.value || '';
    if(txnReceipt.files && txnReceipt.files[0]){
      const r = txnReceipt.files[0];
      const reader = new FileReader();
      reader.onload = (ev)=> {
        const id = uid('att');
        state.attachments[id] = { id, name: r.name, data: ev.target.result, timestamp: new Date().toISOString() };
        tx.receiptId = id;
        finishSaveEdit(tx);
      };
      reader.readAsDataURL(r);
    } else finishSaveEdit(tx);
  }
  function finishSaveEdit(tx){
    saveState();
    addAudit('txn.edit','txn',tx.id,'Edited txn');
    btnAddTxn.textContent = 'Add';
    btnAddTxn.dataset.edit = '';
    try { btnAddTxn.removeEventListener('click', saveEditedTxnHandler); } catch(e){}
    try { btnAddTxn.addEventListener('click', handleAddTransaction); } catch(e){}
    resetForms();
    renderAll();
  }

  function deleteTxn(id){
    const arr = state.transactions[selectedUserId][selectedBizId];
    const idx = arr.findIndex(x=>x.id===id);
    if(idx>=0){ 
      const tx = arr[idx];
      const b = findBiz(selectedBizId);
      
      // Revert inventory state if this was an inventory transaction
      if(tx.action && tx.action.startsWith('Inventory')) {
        revertInventoryState(tx, b);
      }
      
      // Revert asset state if this was an asset transaction
      if(tx.action && (tx.action === 'AssetPurchase' || tx.action === 'AssetDisposal' || tx.action === 'OpeningAssetBal')) {
        revertAssetState(tx, b);
      }
      
      arr.splice(idx,1); 
      saveState(); 
      addAudit('txn.del','txn',id,'Deleted txn - state reverted', { amount: tx.amount, action: tx.action, originalData: { qty: tx.qty, unitPrice: tx.unitPrice } }); 
      renderAll(); 
      refreshAllReports();
    }
  }

  // Render overall UI
  function renderAll(){
    populateAccountSelect();
    renderLedger();
    renderTaxSummary();
    renderReportsTabState();
    updateEnterpriseFeatureVisibility(); // Update enterprise feature tab visibility
    if(activeTab === 'dashboard') renderDashboard(); // always re-render dashboard when it's active
    
    // Check if current user is view-only and hide Add Transaction button
    const currentUser = state.users.find(u => u.id === state.auth.currentUserId);
    const isViewOnly = currentUser && currentUser.permissions && currentUser.permissions.view && !currentUser.permissions.edit;
    
    if(btnAddTxn) {
      if(isViewOnly) {
        btnAddTxn.style.display = 'none';
      } else {
        btnAddTxn.style.display = '';
      }
    }
    
    // Check if current user should see the hero promo (accounts older than 7 days hide it)
    const heroPromo = document.getElementById('heroPromo');
    if(heroPromo && currentUser) {
      const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;
      const userCreatedAt = currentUser.createdAt || 0;
      const accountAge = Date.now() - userCreatedAt;
      
      if(accountAge > SEVEN_DAYS_MS) {
        // Hide hero promo and countdown for accounts older than 7 days
        heroPromo.style.display = 'none';
      } else {
        heroPromo.style.display = '';
      }
    }
    
    // Disable business controls for admin-created users (scoped to business)
    if(currentUser && currentUser.createdByAdmin) {
      if(btnAddBusiness) btnAddBusiness.disabled = true;
      if(btnEditBusiness) btnEditBusiness.disabled = true;
      if(btnDeleteBusiness) btnDeleteBusiness.disabled = true;
      if(btnAddUser) btnAddUser.disabled = true;
      if(btnEditUser) btnEditUser.disabled = true;
      if(btnDeleteUser) btnDeleteUser.disabled = true;
      if(businessSelect) businessSelect.disabled = true;
    } else {
      if(btnAddBusiness) btnAddBusiness.disabled = false;
      if(btnDeleteBusiness) btnDeleteBusiness.disabled = false;
      if(businessSelect) businessSelect.disabled = false;
      if(btnAddUser) btnAddUser.disabled = false;
      if(btnEditUser) btnEditUser.disabled = false;
      if(btnDeleteUser) btnDeleteUser.disabled = false;
      // Edit business may still be restricted per entityLocked
    }
  }

  function renderQuickPanels(){
    if(inventoryListDiv) inventoryListDiv.innerHTML = '';
    if(assetListDiv) assetListDiv.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    if(inventoryListDiv && b.inventory && b.inventory.length){
      for(const it of b.inventory){
        const d = document.createElement('div'); d.className='account-row'; d.innerHTML = `<div><strong>${it.name}</strong><div class="small-muted">Qty: ${it.qty || 0} | Avg cost: ${fmt(it.avgCost||0)}</div></div>`;
        inventoryListDiv.appendChild(d);
      }
    }
    
    // Group assets by category and compute totals
    if(assetListDiv && b.assets && b.assets.length){
      const assetsByCategory = {};
      for(const a of b.assets){
        const cat = a.category || 'Other Asset';
        if(!assetsByCategory[cat]) {
          assetsByCategory[cat] = { assets: [], totalCost: 0, totalAccDep: 0, totalNBV: 0 };
        }
        const totalCost = (a.cost || 0) + (a.openingCost || 0);
        const totalAccDep = (a.accumulatedDep || 0) + (a.openingAccDep || 0);
        const nbv = totalCost - totalAccDep;
        
        assetsByCategory[cat].assets.push(a);
        assetsByCategory[cat].totalCost += totalCost;
        assetsByCategory[cat].totalAccDep += totalAccDep;
        assetsByCategory[cat].totalNBV += nbv;
      }
      
      // Display by category
      for(const cat in assetsByCategory){
        const catData = assetsByCategory[cat];
        const catDiv = document.createElement('div');
        catDiv.className = 'account-row';
        catDiv.innerHTML = `<div><strong>${cat}</strong> (${catData.assets.length} assets)<div class="small-muted">Cost: ${fmt(catData.totalCost)} | Acc Dep: ${fmt(catData.totalAccDep)} | NBV: ${fmt(catData.totalNBV)}</div></div>`;
        assetListDiv.appendChild(catDiv);
        
        // List individual assets in this category
        for(const a of catData.assets){
          const totalCost = (a.cost || 0) + (a.openingCost || 0);
          const totalAccDep = (a.accumulatedDep || 0) + (a.openingAccDep || 0);
          const nbv = totalCost - totalAccDep;
          const d = document.createElement('div');
          d.className = 'small-muted';
          d.style.paddingLeft = '16px';
          d.innerHTML = `${a.name} - Qty: ${a.qty||1} | Cost: ${fmt(totalCost)} | Acc Dep: ${fmt(totalAccDep)} | NBV: ${fmt(nbv)}`;
          assetListDiv.appendChild(d);
        }
      }
    }
  }

  // PL computation
  function computePLSnapshot(){
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    const b = findBiz(selectedBizId);
    let revenue=0, expenses=0, depreciation=0;
    let disallowableExpense=0, nonTaxableIncome=0;
    let whtReceivable=0;
    
    for(const t of arr){
      const acct = findAccount(b, t.accountId);
      const accountName = acct?.name || t.accountName || '';
      const isTaxPayment = TAX_PAYMENT_ACCOUNTS.includes(accountName);
      
      // Exclude tax payments from revenue/expenses
      if (!isTaxPayment) {
        if(t.accountCategory === 'Revenue') {
          revenue += Number(t.amount||0);
          // Add back WHT receivable for revenue transactions (dividends, interests, royalties posted at net)
          if(t.whtApplied) {
            if(t.whtBasis === 'net') {
              const rate = (t.whtRate || (b ? b.whtRate : 5)) / 100;
              whtReceivable += Number(t.amount||0) * (rate / (1 - rate));
            } else {
              whtReceivable += Number(t.amount||0) * ((t.whtRate || (b ? b.whtRate : 5))/100);
            }
          }
        }
        if(t.accountCategory === 'Expense') expenses += Number(t.amount||0);
      }
      
      // Handle adjustment transactions
      if(t.action === 'Adjustment' && t.adjustmentType){
        if(t.adjustmentType === 'disallowable'){
          disallowableExpense += Number(t.amount||0);
        } else if(t.adjustmentType === 'nontaxable'){
          nonTaxableIncome += Number(t.amount||0);
        }
      }
    }
    const dep = computeTotalDepreciation();
    depreciation = dep;
    expenses += depreciation;
    // Add back WHT receivable to accounting profit for revenues posted at net
    // Disposal gains from assets
    let disposalGain = 0;
    for(const biz of [findBiz(selectedBizId)].filter(Boolean)){
      for(const asset of (biz.assets||[])){
        if(asset.disposed && asset.disposal && asset.disposal.includedInTaxableProfit){
          disposalGain += Number(asset.disposal.netGainAfterOffset || 0);
        }
      }
    }
    const accountingProfit = revenue + whtReceivable - expenses + disposalGain;
    return { revenue, expenses, depreciation, accountingProfit, disallowableExpense, nonTaxableIncome, whtReceivable, disposalGain };
  }

  // compute daily depreciation for all assets
  function computeTotalDepreciation(asOfDate){
    const b = findBiz(selectedBizId);
    if(!b) return 0;
    const arr = b.assets || [];
    let totalDep = 0;
    const asOf = asOfDate || today();
    for(const a of arr){
      if(!a.purchaseDate) continue;
      const days = Math.max(0, daysBetween(a.purchaseDate, asOf));
      const dinYear = daysInYear(a.purchaseDate);
      let assetDep = 0;
      if(a.lifeYears && a.lifeYears>0){
        const annualDep = (a.cost || 0) / a.lifeYears;
        const daily = annualDep / dinYear;
        assetDep = daily * days;
      } else {
        const annual = ((a.depRate || 0)/100) * (a.cost || 0);
        const daily = annual / dinYear;
        assetDep = daily * days;
      }
      totalDep += assetDep;
      
      // CGT: Update asset.accumulatedDepreciation when depreciation is computed
      // accumulatedDepreciation stores computed depreciation from purchase to asOf date
      // accumulatedDep is the total (opening + computed) for backward compatibility
      const computedAccDep = Math.round(assetDep * 100) / 100;
      // Only update if value has changed (avoid unnecessary state changes)
      if(a.accumulatedDepreciation !== computedAccDep) {
        a.accumulatedDepreciation = computedAccDep;
      }
      // accumulatedDep = openingAccDep + computed depreciation from purchase date
      // Note: openingAccDep represents depreciation before the asset was added to this system
      const totalAccDep = (a.openingAccDep || 0) + computedAccDep;
      if(a.accumulatedDep !== totalAccDep) {
        a.accumulatedDep = totalAccDep;
      }
    }
    return totalDep;
  }

  // compute daily capital allowance (for taxable adjustments)
  function computeTotalCapitalAllowance(asOfDate){
    const b = findBiz(selectedBizId);
    if(!b) return 0;
    const arr = b.assets || [];
    let totalCA = 0;
    const asOf = asOfDate || today();
    for(const a of arr){
      if(!a.purchaseDate) continue;
      const days = Math.max(0, daysBetween(a.purchaseDate, asOf));
      const dinYear = daysInYear(a.purchaseDate);
      const caPercent = Number(a.caPercent || b.caRateDefault || DEFAULTS.caRateDefault);
      const annualCA = (caPercent/100) * (a.cost || 0);
      const daily = annualCA / dinYear;
      totalCA += daily * days;
    }
    return totalCA;
  }

  // CGT Rate constant for Companies (30%)
  const CGT_COMPANY_RATE = 0.30;
  
  /**
   * Computes sum of capital allowances claimed for an asset up to a given date.
   * @param {object} asset - The asset object
   * @param {string} uptoDate - Date string 'YYYY-MM-DD' to sum allowances up to
   * @returns {number} Sum of capital allowances
   */
  function computeCapitalAllowanceToDate(asset, uptoDate) {
    if (!asset || !asset.capitalAllowances || !Array.isArray(asset.capitalAllowances)) {
      return 0;
    }
    let sum = 0;
    const uptoTime = new Date(uptoDate).getTime();
    for (const ca of asset.capitalAllowances) {
      if (ca.date && ca.amount) {
        const caTime = new Date(ca.date).getTime();
        if (caTime <= uptoTime) {
          sum += Number(ca.amount || 0);
        }
      }
    }
    return Math.round(sum * 100) / 100;
  }

  /**
   * Gets the cost of an asset (cost + openingCost).
   * @param {object} asset - The asset object
   * @returns {number} Asset cost
   */
  function getAssetCost(asset) {
    if (!asset) return 0;
    return Number(asset.cost || 0) + Number(asset.openingCost || 0);
  }

  /**
   * Computes Tax Written Down Value (TWDV) for an asset.
   * TWDV = Cost - Capital Allowances claimed up to the date.
   * If no capital allowances have been claimed, TWDV = Cost.
   * @param {object} asset - The asset object
   * @param {string} uptoDate - Date string 'YYYY-MM-DD'
   * @returns {number} TWDV
   */
  function computeTaxWrittenDownValue(asset, uptoDate) {
    if (!asset) return 0;
    const cost = getAssetCost(asset);
    const caToDate = computeCapitalAllowanceToDate(asset, uptoDate);
    // If no CA claimed, TWDV = cost per user rule
    if (caToDate === 0) {
      return Math.round(cost * 100) / 100;
    }
    return Math.round(Math.max(0, cost - caToDate) * 100) / 100;
  }

  /**
   * Computes chargeable gain for an asset disposal.
   * Chargeable Gain = Proceeds - TWDV
   * @param {object} asset - The asset object
   * @param {number} proceeds - Disposal proceeds
   * @param {string} uptoDate - Date of disposal 'YYYY-MM-DD'
   * @returns {number} Chargeable gain (negative = loss)
   */
  function computeChargeableGain(asset, proceeds, uptoDate) {
    const twdv = computeTaxWrittenDownValue(asset, uptoDate);
    return Math.round((Number(proceeds || 0) - twdv) * 100) / 100;
  }

  /**
   * Offsets a chargeable gain with carryforward losses from prior years.
   * Only losses from years < disposalYear apply.
   * @param {object} biz - Business object
   * @param {string} assetClass - Asset class/category
   * @param {number} gain - Chargeable gain to offset
   * @param {number|string} disposalYear - Year of disposal
   * @returns {object} { remainingGain: number, used: number }
   */
  function offsetWithCarryforward(biz, assetClass, gain, disposalYear) {
    if (!biz || !biz.chargeableLosses || gain <= 0) {
      return { remainingGain: Math.max(0, gain), used: 0 };
    }
    
    const dispYear = Number(disposalYear);
    let remainingGain = gain;
    let totalUsed = 0;
    
    // Sort years in ascending order to use oldest losses first
    const years = Object.keys(biz.chargeableLosses).map(Number).sort((a, b) => a - b);
    
    for (const year of years) {
      if (year >= dispYear) continue; // Only use losses from prior years
      
      const lossesForYear = biz.chargeableLosses[year];
      if (!lossesForYear || !lossesForYear[assetClass]) continue;
      
      const availableLoss = Number(lossesForYear[assetClass] || 0);
      if (availableLoss <= 0) continue;
      
      const toUse = Math.min(availableLoss, remainingGain);
      remainingGain -= toUse;
      totalUsed += toUse;
      
      // Reduce the recorded loss
      biz.chargeableLosses[year][assetClass] -= toUse;
      if (biz.chargeableLosses[year][assetClass] <= 0) {
        delete biz.chargeableLosses[year][assetClass];
      }
      if (Object.keys(biz.chargeableLosses[year]).length === 0) {
        delete biz.chargeableLosses[year];
      }
      
      if (remainingGain <= 0) break;
    }
    
    return {
      remainingGain: Math.round(remainingGain * 100) / 100,
      used: Math.round(totalUsed * 100) / 100
    };
  }

  /**
   * Checks if an asset is a property asset (eligible for chargeable disposal).
   * Property assets: category is 'Property Plant and Equipment' (case-insensitive)
   * or category contains 'land' or 'building' (case-insensitive).
   * @param {object} asset - The asset object
   * @returns {boolean}
   */
  function isPropertyAsset(asset) {
    if (!asset || !asset.category) return false;
    const cat = asset.category.toLowerCase();
    return cat === 'property plant and equipment' ||
           cat.includes('land') ||
           cat.includes('building');
  }

  /**
   * Checks if an asset is a share asset.
   * Share assets: category === 'Shares' or type === 'Share' (case-insensitive).
   * @param {object} asset - The asset object
   * @returns {boolean}
   */
  function isShareAsset(asset) {
    if (!asset) return false;
    const cat = (asset.category || '').toLowerCase();
    const type = (asset.type || '').toLowerCase();
    return cat === 'shares' || type === 'share';
  }

  /**
   * Records a carryforward loss for a business.
   * @param {object} biz - Business object
   * @param {number|string} year - Originating year
   * @param {string} assetClass - Asset class/category
   * @param {number} lossAmount - Loss amount (positive number)
   */
  function recordCarryforwardLoss(biz, year, assetClass, lossAmount) {
    if (!biz || !year || !assetClass || lossAmount <= 0) return;
    
    biz.chargeableLosses = biz.chargeableLosses || {};
    biz.chargeableLosses[year] = biz.chargeableLosses[year] || {};
    biz.chargeableLosses[year][assetClass] = (biz.chargeableLosses[year][assetClass] || 0) + Math.round(lossAmount * 100) / 100;
  }

  /**
   * Updates share disposals aggregation for share exemption checks.
   * @param {object} biz - Business object
   * @param {number|string} year - Disposal year
   * @param {number} proceeds - Disposal proceeds
   * @param {number} gain - Disposal gain
   */
  function updateShareDisposals(biz, year, proceeds, gain) {
    if (!biz) return;
    
    biz.shareDisposalsByYear = biz.shareDisposalsByYear || {};
    if (!biz.shareDisposalsByYear[year]) {
      biz.shareDisposalsByYear[year] = { proceedsSum: 0, gainSum: 0 };
    }
    biz.shareDisposalsByYear[year].proceedsSum += Number(proceeds || 0);
    biz.shareDisposalsByYear[year].gainSum += Number(gain || 0);
  }

  /**
   * Checks if share disposals for a year qualify for exemption.
   * Exempt if aggregated proceeds <= 150,000,000 OR aggregated gain <= 10,000,000.
   * @param {object} biz - Business object
   * @param {number|string} year - Disposal year
   * @returns {boolean}
   */
  function isShareDisposalExempt(biz, year) {
    if (!biz || !biz.shareDisposalsByYear || !biz.shareDisposalsByYear[year]) {
      return true; // No disposals recorded, effectively exempt
    }
    const data = biz.shareDisposalsByYear[year];
    return (data.proceedsSum <= CGT_EXEMPTION_PROCEEDS) || (data.gainSum <= CGT_EXEMPTION_GAIN);
  }

  // PAYE computation per contact using PAYE_BANDS
  function computePAYEOnAnnualIncome(annualTaxable){
    if(!annualTaxable || annualTaxable <= 0) return 0;
    let remaining = annualTaxable;
    let tax = 0;
    let lower = 0;
    for(const band of PAYE_BANDS){
      const upper = band.upTo;
      const slice = Math.max(0, Math.min(remaining, upper - lower));
      if(slice>0){
        tax += slice * band.rate;
        remaining -= slice;
      }
      lower = upper;
      if(remaining <= 0) break;
    }
    return tax;
  }

  // Tax summary rendering
  function renderTaxSummary(){
    const b = findBiz(selectedBizId);
    taxSummaryDiv.innerHTML = '';
    if(!b) return;
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    let revenue=0, expenses=0, vatCollected=0, vatPaid=0, whtPayable=0, whtReceivable=0;
    const payeByContact = {};
    
    // Tax payment tracking - these should reduce tax liabilities, not count as expenses
    let vatPaidToAuthority = 0, vatRefunded = 0;
    let whtPaidToAuthority = 0, payePaid = 0, pitPaid = 0, citPaid = 0, cgtPaid = 0;
    
    for(const t of arr){
      const acct = findAccount(b, t.accountId);
      const accountName = acct?.name || t.accountName || '';
      
      // Check if this is a tax payment transaction
      const isTaxPayment = TAX_PAYMENT_ACCOUNTS.includes(accountName);
      
      // Track tax payments separately
      if (isTaxPayment) {
        if (accountName === 'VAT Paid') vatPaidToAuthority += Number(t.amount||0);
        else if (accountName === 'VAT Refunded') vatRefunded += Number(t.amount||0);
        else if (accountName === 'WHT Remitted' || accountName === 'WHT Paid') whtPaidToAuthority += Number(t.amount||0);
        else if (accountName === 'PAYE Paid') payePaid += Number(t.amount||0);
        else if (accountName === 'PIT Paid') pitPaid += Number(t.amount||0);
        else if (accountName === 'CIT Paid') citPaid += Number(t.amount||0);
        else if (accountName === 'CGT Paid') cgtPaid += Number(t.amount||0);
      } else {
        // Regular transactions - exclude tax payments from revenue/expenses
        if(t.accountCategory === 'Revenue') revenue += Number(t.amount||0);
        if(t.accountCategory === 'Expense') expenses += Number(t.amount||0);
      }
      
      // VAT calculation with inclusive option
      if(t.vatType === 'exclusive' && t.accountCategory === 'Revenue') {
        vatCollected += (Number(t.amount||0) * (b.vatRate/100));
      } else if(t.vatType === 'inclusive' && t.accountCategory === 'Revenue') {
        // VAT inclusive: VAT = (vatRate / (100 + vatRate)) * amount
        vatCollected += (Number(t.amount||0) * (b.vatRate / (100 + b.vatRate)));
      }
      
      if(t.vatType === 'exclusive' && t.accountCategory === 'Expense') {
        vatPaid += (Number(t.amount||0) * (b.vatRate/100));
      } else if(t.vatType === 'inclusive' && t.accountCategory === 'Expense') {
        vatPaid += (Number(t.amount||0) * (b.vatRate / (100 + b.vatRate)));
      }
      
      // WHT calculation with net basis option
      if(t.whtApplied && t.accountCategory === 'Expense') {
        if(t.whtBasis === 'net') {
          // WHT net basis: WHT = rate * (amount / (1 - rate))
          const rate = (t.whtRate || b.whtRate) / 100;
          whtPayable += Number(t.amount||0) * (rate / (1 - rate));
        } else {
          whtPayable += Number(t.amount||0) * ((t.whtRate || b.whtRate)/100);
        }
      }
      
      if(t.whtApplied && t.accountCategory === 'Revenue') {
        if(t.whtBasis === 'net') {
          const rate = (t.whtRate || b.whtRate) / 100;
          whtReceivable += Number(t.amount||0) * (rate / (1 - rate));
        } else {
          whtReceivable += Number(t.amount||0) * ((t.whtRate || b.whtRate)/100);
        }
      }
      
      if(t.paye && t.contact){
        payeByContact[t.contact] = (payeByContact[t.contact]||0) + Number(t.amount||0);
      }
    }
    
    // Calculate WHT Remitted from transactions
    let whtRemitted = 0;
    for(const t of arr){
      if(t.accountName === 'WHT Remitted' || (t.accountId && findAccount(b, t.accountId)?.name === 'WHT Remitted')){
        whtRemitted += Number(t.amount||0);
      }
    }
    
    const depreciationDaily = computeTotalDepreciation();
    expenses += depreciationDaily;
    // Add back WHT receivable to accounting profit for revenues posted at net
    const accountingProfit = revenue + whtReceivable - expenses;
    
    // Get adjustment values from P&L snapshot
    const plSnapshot = computePLSnapshot();
    const disallowableExpense = plSnapshot.disallowableExpense || 0;
    const nonTaxableIncomeAdjustment = plSnapshot.nonTaxableIncome || 0;
    
    // Calculate non-taxable income for CA relief rule
    let nonTaxableIncome = nonTaxableIncomeAdjustment;
    for(const t of arr){
      if(t.accountCategory === 'Revenue'){
        const acct = findAccount(b, t.accountId);
        if(acct && acct.nonTaxableDefault) {
          nonTaxableIncome += Number(t.amount || 0);
        }
      }
    }
    
    // Capital Allowance Relief Rule:
    // If non-taxable income < 10% of total revenue: allow 100% of CA
    // Otherwise: allow 2/3 of CA, carry forward 1/3
    const capitalAllowanceDaily = computeTotalCapitalAllowance();
    const totalCA = capitalAllowanceDaily + (b.caCarryForward || 0);
    let allowedCA = totalCA;
    let carriedForwardCA = 0;
    
    if(revenue > 0 && (nonTaxableIncome / revenue) >= NON_TAXABLE_INCOME_CA_THRESHOLD) {
      // Non-taxable >= 10% of revenue: only allow 2/3
      allowedCA = (2/3) * totalCA;
      carriedForwardCA = (1/3) * totalCA;
    }
    
    // Taxable profit calculation: Add back depreciation for tax, deduct CA
    // Also add disallowable expenses and deduct non-taxable income adjustments
    let taxableProfit = accountingProfit + depreciationDaily - allowedCA + disallowableExpense - nonTaxableIncomeAdjustment + (b.lossBroughtForward ? -b.lossBroughtForward : 0);
    const chargeableGains = computeChargeableGainsForBiz();
    const turnover = revenue;
    let cgtCharge = 0;
    let cgtExcludedFromTaxable = 0;
    
    // CGT: Sum CGT charges from asset disposals and adjust taxable profit
    for(const g of chargeableGains){
      // Add CGT charge from the disposal (computed during disposal)
      cgtCharge += g.cgtCharge || 0;
      
      // Adjust taxable profit based on entity and disposal settings
      // Use netGain (after offset) for correct taxable profit calculation
      const effectiveGain = g.netGain || g.gain || 0;
      
      if(b.entity === 'Company'){
        // For Company: gains are excluded from taxable profit (CGT charged separately)
        if(!g.isShareExempt && effectiveGain > 0) {
          cgtExcludedFromTaxable += effectiveGain;
        }
      } else {
        // For Business/Enterprise Plus: gains included in taxable profit unless exempt
        // If the gain is exempt (share exemption), exclude from taxable profit
        if(g.isShareExempt && effectiveGain > 0) {
          // Exempt gains: exclude from taxable profit
          taxableProfit -= effectiveGain;
        }
        // If includedInTaxableProfit is true, the gain is already in taxable profit via disposal
      }
    }
    
    // For Company, exclude chargeable gains from taxable profit (handled separately via CGT)
    if(b.entity === 'Company'){
      taxableProfit -= cgtExcludedFromTaxable;
    }
    
    // Calculate total carryforward losses for display
    let totalCarryforwardLosses = 0;
    if(b.chargeableLosses) {
      for(const year in b.chargeableLosses) {
        for(const assetClass in b.chargeableLosses[year]) {
          totalCarryforwardLosses += Number(b.chargeableLosses[year][assetClass] || 0);
        }
      }
    }

    let payeMonthlyTotal = 0;
    let payeAnnualTotal = 0;
    for(const cName in payeByContact){
      const annualSalary = payeByContact[cName];
      const computedTax = computePAYEOnAnnualIncome(annualSalary || 0);
      payeAnnualTotal += computedTax;
      payeMonthlyTotal += computedTax / 12;
    }

    // CIT calculation with turnover threshold
    // Compute turnover from Revenue and InventorySale transactions for the business
    let computedTurnover = 0;
    for(const t of arr){
      if(t.action === 'Revenue' || t.action === 'InventorySale') {
        computedTurnover += Number(t.amount || 0);
      }
    }
    const turnoverForCIT = computedTurnover; // Use derived Revenue+InventorySale turnover
    
    let citCharge = 0;
    let whtCarryForward = 0;
    if(b.entity === 'Company' && b.citEnabled){
      const threshold = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
      
      // CIT logic based on selected threshold:
      // If threshold = 50,000,000: CIT rate = 0% when turnover <= 50M, else 25%
      // If threshold = 100,000,000: CIT rate = 0% when turnover <= 100M, else 30%
      if(threshold === CIT_THRESHOLDS.MEDIUM) {
        // 50M threshold: 0% if â‰¤50M, 25% if >50M
        if(turnoverForCIT > CIT_THRESHOLDS.MEDIUM) {
          citCharge = 0.25 * Math.max(0, taxableProfit);
        }
      } else if(threshold === CIT_THRESHOLDS.LARGE) {
        // 100M threshold: 0% if â‰¤100M, 30% if >100M
        if(turnoverForCIT > CIT_THRESHOLDS.LARGE) {
          citCharge = 0.30 * Math.max(0, taxableProfit);
        }
      }
      // If threshold is 0 (NONE), CIT = 0
      
      // Deduct WHT remitted (already paid) only if CIT was actually computed (turnover above threshold and CIT > 0)
      if(citCharge > 0) {
        citCharge = Math.max(0, citCharge - whtPaidToAuthority);
      } else {
        // CIT is 0% (turnover below threshold): carry forward WHT receivable to next period
        whtCarryForward = whtReceivable;
      }
    }

    // PIT for Business/Enterprise Plus (renamed from SoleProprietor)
    let pitCharge = 0;
    if((b.entity === 'Business' || b.entity === 'Enterprise Plus' || b.entity === 'Enterprise') && b.pitEnabled){
      if(taxableProfit > 0){
        const pitLiability = computePAYEOnAnnualIncome(taxableProfit);
        // Deduct WHT remitted (already paid) from PIT charge
        pitCharge = Math.max(0, pitLiability - whtPaidToAuthority);
      }
    }

    // Calculate VAT net before using it
    const vatNet = vatCollected - vatPaid;
    
    // Adjust VAT net by payments
    const vatNetAfterPayments = vatNet - vatPaidToAuthority + vatRefunded;
    
    // D12: Negative VAT (more VAT paid than collected) â†’ reclassify to VAT Recoverable (asset)
    // VAT Payable should never be negative; negative balance = VAT Recoverable on balance sheet
    const vatPayable = Math.max(0, vatNetAfterPayments);
    const vatRecoverable = vatNetAfterPayments < 0 ? Math.abs(vatNetAfterPayments) : 0;
    
    // Adjust WHT by remitted amounts
    const whtPayableNet = Math.max(0, whtPayable - whtPaidToAuthority);
    const whtReceivableNet = Math.max(0, whtReceivable - whtPaidToAuthority);
    
    let html = '';
    // For Company/Business/Enterprise Plus: show full summary
    html += `<div><strong>Accounting Profit:</strong> ${fmt(accountingProfit)}</div>`;
    html += `<div><strong>Taxable Profit:</strong> ${fmt(taxableProfit)}</div>`;
    html += `<div class="small-muted">Revenue ${fmt(revenue)} | Expenses ${fmt(expenses)} (including Dep ${fmt(depreciationDaily)})</div>`;
    html += `<div class="small-muted">CA allowed: ${fmt(allowedCA)} | CA c/f: ${fmt(carriedForwardCA)} | Non-taxable income: ${fmt(nonTaxableIncome)} (${revenue > 0 ? ((nonTaxableIncome/revenue)*100).toFixed(1) : 0}% of revenue)</div>`;
    html += `<hr/>`;
    
    // Tax Payment Section with Outstanding Balances
    html += `<h4 style="margin:12px 0 8px 0;">Tax Liabilities & Payments</h4>`;
    
    // VAT Section
    html += `<div style="background:#f8f9fb; padding:10px; margin:8px 0; border-radius:6px; border-left:4px solid ${vatPayable > 0 ? '#dc2626' : '#059669'};">`;
    html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">`;
    html += `<div><strong>VAT:</strong></div>`;
    html += `<div><strong>${vatRecoverable > 0 ? 'VAT Recoverable (Asset): ' + fmt(vatRecoverable) : 'Outstanding: ' + fmt(vatPayable)}</strong></div>`;
    html += `</div>`;
    html += `<div class="small-muted">Collected: ${fmt(vatCollected)} | Paid: ${fmt(vatPaid)} | Net: ${fmt(vatNet)}</div>`;
    html += `<div class="small-muted">Remitted to Authority: ${fmt(vatPaidToAuthority)}${vatRefunded > 0 ? ` | Refunded: ${fmt(vatRefunded)}` : ''}</div>`;
    if(vatRecoverable > 0){
      html += `<div class="small-note" style="color:#059669;">VAT Recoverable: ${fmt(vatRecoverable)} has been reclassified as a current asset (VAT Recoverable) in the balance sheet.</div>`;
    }
    if(vatPayable > 0) {
      html += `<button class="small primary" style="margin-top:6px;" onclick="payTax('VAT', ${vatPayable})">Pay VAT (${fmt(vatPayable)})</button>`;
    }
    html += `</div>`;
    
    // WHT Section
    html += `<div style="background:#f8f9fb; padding:10px; margin:8px 0; border-radius:6px; border-left:4px solid ${whtPayableNet > 0 ? '#dc2626' : '#059669'};">`;
    html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">`;
    html += `<div><strong>WHT:</strong></div>`;
    html += `<div><strong>Outstanding: ${fmt(whtPayableNet)}</strong></div>`;
    html += `</div>`;
    html += `<div class="small-muted">Payable: ${fmt(whtPayable)} | Receivable: ${fmt(whtReceivable)} | Remitted: ${fmt(whtPaidToAuthority)}</div>`;
    if(whtPayableNet > 0) {
      html += `<button class="small primary" style="margin-top:6px;" onclick="payTax('WHT', ${whtPayableNet})">Pay WHT (${fmt(whtPayableNet)})</button>`;
    }
    html += `</div>`;
    
    // PAYE Section
    const payeOutstanding = Math.max(0, payeAnnualTotal - payePaid);
    html += `<div style="background:#f8f9fb; padding:10px; margin:8px 0; border-radius:6px; border-left:4px solid ${payeOutstanding > 0 ? '#dc2626' : '#059669'};">`;
    html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">`;
    html += `<div><strong>PAYE:</strong></div>`;
    html += `<div><strong>Outstanding: ${fmt(payeOutstanding)}</strong></div>`;
    html += `</div>`;
    html += `<div class="small-muted">Monthly: ${fmt(payeMonthlyTotal)} | Annual: ${fmt(payeAnnualTotal)} | Paid: ${fmt(payePaid)}</div>`;
    if(payeOutstanding > 0) {
      html += `<button class="small primary" style="margin-top:6px;" onclick="payTax('PAYE', ${payeOutstanding})">Pay PAYE (${fmt(payeOutstanding)})</button>`;
    }
    html += `</div>`;
    
    // CIT/PIT Section
    if(b.entity === 'Company'){
      const citOutstanding = Math.max(0, citCharge - citPaid);
      html += `<div style="background:#f8f9fb; padding:10px; margin:8px 0; border-radius:6px; border-left:4px solid ${citOutstanding > 0 ? '#dc2626' : '#059669'};">`;
      html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">`;
      html += `<div><strong>CIT:</strong></div>`;
      html += `<div><strong>Outstanding: ${fmt(citOutstanding)}</strong></div>`;
      html += `</div>`;
      html += `<div class="small-muted">Charge (after WHT): ${fmt(citCharge)} | Paid: ${fmt(citPaid)}</div>`;
      if(whtCarryForward > 0) {
        html += `<div class="small-note">WHT Receivable Carryforward: ${fmt(whtCarryForward)} (CIT rate = 0%, WHT carries forward to next period)</div>`;
      }
      const threshold = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
      html += `<div class="small-note">CIT threshold: ${fmt(threshold)} | Turnover: ${fmt(turnoverForCIT)}</div>`;
      if(citOutstanding > 0) {
        html += `<button class="small primary" style="margin-top:6px;" onclick="payTax('CIT', ${citOutstanding})">Pay CIT (${fmt(citOutstanding)})</button>`;
        html += `<button class="small" style="margin-top:6px;margin-left:6px;" onclick="createCITProvision(${citCharge})">Create CIT Provision</button>`;
      }
      html += `</div>`;
      
      // CGT Section
      const cgtOutstanding = Math.max(0, cgtCharge - cgtPaid);
      html += `<div style="background:#f8f9fb; padding:10px; margin:8px 0; border-radius:6px; border-left:4px solid ${cgtOutstanding > 0 ? '#dc2626' : '#059669'};">`;
      html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">`;
      html += `<div><strong>CGT:</strong></div>`;
      html += `<div><strong>Outstanding: ${fmt(cgtOutstanding)}</strong></div>`;
      html += `</div>`;
      html += `<div class="small-muted">Charge: ${fmt(cgtCharge)} | Paid: ${fmt(cgtPaid)}</div>`;
      if(cgtOutstanding > 0) {
        html += `<button class="small primary" style="margin-top:6px;" onclick="payTax('CGT', ${cgtOutstanding})">Pay CGT (${fmt(cgtOutstanding)})</button>`;
      }
      html += `</div>`;
      
      if(totalCarryforwardLosses > 0) {
        html += `<div class="small-note">Carryforward Losses Available: ${fmt(totalCarryforwardLosses)}</div>`;
      }
    } else {
      const pitOutstanding = Math.max(0, pitCharge - pitPaid);
      html += `<div style="background:#f8f9fb; padding:10px; margin:8px 0; border-radius:6px; border-left:4px solid ${pitOutstanding > 0 ? '#dc2626' : '#059669'};">`;
      html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">`;
      html += `<div><strong>PIT:</strong></div>`;
      html += `<div><strong>Outstanding: ${fmt(pitOutstanding)}</strong></div>`;
      html += `</div>`;
      html += `<div class="small-muted">Charge: ${fmt(pitCharge)} | Paid: ${fmt(pitPaid)}</div>`;
      if(pitOutstanding > 0) {
        html += `<button class="small primary" style="margin-top:6px;" onclick="payTax('PIT', ${pitOutstanding})">Pay PIT (${fmt(pitOutstanding)})</button>`;
      }
      html += `</div>`;
      
      if(totalCarryforwardLosses > 0) {
        html += `<div class="small-note">Carryforward Losses Available: ${fmt(totalCarryforwardLosses)}</div>`;
      }
    }
    
    if(b.showLines){
      if(carriedForwardCA > 0) {
        html += `<div class="notice" style="margin-top:6px;"><strong>CA Carryforward:</strong> ${fmt(carriedForwardCA)} will be carried forward to next period (non-taxable income â‰¥ 10% of revenue).</div>`;
      }
    }

    taxSummaryDiv.innerHTML = html;
  }

  function computeChargeableGainsForBiz(){
    const b = findBiz(selectedBizId);
    if(!b) return [];
    const gains = [];
    for(const a of b.assets || []){
      if(a.disposed && a.disposal){
        if(a.classification === 'Chargeable'){
          gains.push({ 
            assetId: a.id, 
            name: a.name, 
            proceeds: Number(a.disposal.proceeds || 0), 
            gain: Number(a.disposal.gain || 0),
            netGain: Number(a.disposal.netGainAfterOffset || a.disposal.gain || 0),
            cgtCharge: Number(a.disposal.cgtCharge || 0),
            offsetUsed: Number(a.disposal.offsetUsed || 0),
            lossCarriedForward: Number(a.disposal.lossCarriedForward || 0),
            includedInTaxableProfit: a.disposal.includedInTaxableProfit || false,
            isShareExempt: a.disposal.isShareExempt || false
          });
        }
      }
    }
    return gains;
  }

  /**
   * Pay Tax Function - Balance-sheet only: Dr tax liability, Cr bank/cashbook.
   * No P&L recognition. Records a tax payment transaction tracked in tax summary.
   * @param {string} taxType - Type of tax (VAT, WHT, PAYE, CIT, PIT, CGT)
   * @param {number} amount - Amount to pay
   */
  function payTax(taxType, amount) {
    if(!selectedUserId || !selectedBizId) {
      return alert('Please select a user and business');
    }
    
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    // Map tax type to payment account name (these match what renderTaxSummary expects)
    const taxPaymentAccountMap = {
      'VAT': 'VAT Paid',
      'WHT': 'WHT Remitted',
      'PAYE': 'PAYE Paid',
      'CIT': 'CIT Paid',
      'PIT': 'PIT Paid',
      'CGT': 'CGT Paid'
    };
    
    const paymentAccountName = taxPaymentAccountMap[taxType];
    if(!paymentAccountName) {
      return alert('Invalid tax type');
    }
    
    // Find or create the tax payment tracking account
    // Category 'Expense' with isTaxPayment flag ensures it is excluded from P&L
    let paymentAccount = b.accounts.find(a => a.name === paymentAccountName);
    if(!paymentAccount) {
      paymentAccount = {
        id: uid('acct'),
        name: paymentAccountName,
        category: 'Expense', // Excluded from P&L via isTaxPayment flag and TAX_PAYMENT_ACCOUNTS list
        disallowableDefault: true,
        nonTaxableDefault: true,
        openingBalance: 0
      };
      b.accounts.push(paymentAccount);
    }
    
    // Prompt for payment amount (allow partial payment)
    const paymentAmount = prompt(`Enter amount to pay for ${taxType}:\nOutstanding: ${fmt(amount)}`, amount);
    if(!paymentAmount || isNaN(paymentAmount) || Number(paymentAmount) <= 0) {
      return;
    }
    
    const finalAmount = Number(paymentAmount);
    
    // Create balance-sheet-only transaction:
    // Dr respective tax liability (reduces liability) | Cr Bank (reduces cash)
    // This does NOT affect P&L - it is a balance sheet movement only.
    const txn = {
      id: uid('txn'),
      date: new Date().toISOString().split('T')[0],
      action: 'Tax Payment',  // Kept for backward compat; excluded from P&L
      accountId: paymentAccount.id,
      accountName: paymentAccount.name,
      accountCategory: 'Expense',  // isTaxPayment flag ensures P&L exclusion
      amount: finalAmount,
      description: `${taxType} Payment to Tax Authority`,
      vatType: 'none',
      whtApplied: false,
      paye: false,
      contact: 'Tax Authority',
      timestamp: Date.now(),
      isTaxPayment: true  // Flag: balance-sheet only, excluded from P&L
    };
    
    // Add transaction
    if(!state.transactions[selectedUserId]) state.transactions[selectedUserId] = {};
    if(!state.transactions[selectedUserId][selectedBizId]) state.transactions[selectedUserId][selectedBizId] = [];
    state.transactions[selectedUserId][selectedBizId].push(txn);
    
    addAudit('tax.payment', 'transaction', txn.id, `Paid ${taxType}: ${fmt(finalAmount)}`);
    saveState();
    renderAll();
    alert(`${taxType} payment of ${fmt(finalAmount)} recorded successfully!\nThis payment reduces your ${taxType} liability (balance sheet only).`);
  }
  
  // Make payTax available globally for inline onclick handlers
  window.payTax = payTax;

  /**
   * Create CIT provision entry: Dr Income Tax Expense, Cr CIT Provision (Liability)
   * Shows under "Less tax" in P&L and as CIT Provision on balance sheet.
   */
  function createCITProvision(citAmount) {
    if(!selectedUserId || !selectedBizId) return alert('Please select a user and business');
    const b = findBiz(selectedBizId);
    if(!b) return;
    const provisionAmt = prompt(`Enter CIT provision amount:\nComputed CIT: ${fmt(citAmount)}`, citAmount);
    if(!provisionAmt || isNaN(provisionAmt) || Number(provisionAmt) <= 0) return;
    const finalAmt = Number(provisionAmt);
    // Find or create Income Tax Expense account
    let taxExpAcct = b.accounts.find(a => a.name === 'Income Tax Expense');
    if(!taxExpAcct){
      taxExpAcct = { id: uid('acct'), name: 'Income Tax Expense', category: 'Expense', disallowableDefault: true, nonTaxableDefault: false };
      b.accounts.push(taxExpAcct);
    }
    // Find or create CIT Provision (Liability)
    let citProvAcct = b.accounts.find(a => a.name === 'CIT Provision');
    if(!citProvAcct){
      citProvAcct = { id: uid('acct'), name: 'CIT Provision', category: 'Liability', disallowableDefault: false, nonTaxableDefault: false, openingBalance: 0 };
      b.accounts.push(citProvAcct);
    }
    const today = new Date().toISOString().split('T')[0];
    // Dr Income Tax Expense
    const expTxn = { id: uid('txn'), date: today, action: 'Expense', accountId: taxExpAcct.id, accountName: taxExpAcct.name, accountCategory: 'Expense', description: 'CIT Provision', amount: finalAmt, vatType: 'none', whtApplied: false, paye: false, contact: 'Tax Authority', isCITProvision: true };
    // Cr CIT Provision (Liability)
    const provTxn = { id: uid('txn'), date: today, action: 'Tax Payment', accountId: citProvAcct.id, accountName: citProvAcct.name, accountCategory: 'Liability', description: 'CIT Provision', amount: finalAmt, vatType: 'none', whtApplied: false, paye: false, contact: 'Tax Authority', isTaxPayment: true, isCITProvision: true };
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    state.transactions[selectedUserId][selectedBizId].push(expTxn, provTxn);
    addAudit('cit.provision', 'transaction', expTxn.id, `CIT Provision: ${fmt(finalAmt)}`);
    saveState();
    renderAll();
    alert(`CIT Provision of ${fmt(finalAmt)} created.\nDr Income Tax Expense | Cr CIT Provision.`);
  }
  window.createCITProvision = createCITProvision;

  function handleAddCashbookEntry() {
    if(!selectedUserId || !selectedBizId) return alert('Select user & business');
    const b = findBiz(selectedBizId);
    if(!b) return alert('Business not found');
    const dateEl = document.getElementById('cashbookDate');
    const descEl = document.getElementById('cashbookDesc');
    const receiptsEl = document.getElementById('cashbookReceiptsAmt');
    const paymentsEl = document.getElementById('cashbookPaymentsAmt');
    const bankAcctEl = document.getElementById('cashbookBankAccount');
    const counterpartyEl = document.getElementById('cashbookCounterparty');
    const receiptsAmt = Number(receiptsEl && receiptsEl.value || 0);
    const paymentsAmt = Number(paymentsEl && paymentsEl.value || 0);
    if(receiptsAmt <= 0 && paymentsAmt <= 0) return alert('Enter a receipts or payments amount');
    // Resolve bank account (default to "Bank")
    const bankAcctId = bankAcctEl && bankAcctEl.value;
    const bankAcct = (bankAcctId && b.accounts.find(a => a.id === bankAcctId)) || b.accounts.find(a => a.name === 'Bank');
    // Resolve counterparty account
    const cpAcctId = counterpartyEl && counterpartyEl.value;
    const cpAcct = (cpAcctId && b.accounts.find(a => a.id === cpAcctId)) || null;
    const txnDate = (dateEl && dateEl.value) || today();
    const txnDesc = (descEl && descEl.value) || (receiptsAmt > 0 ? 'Receipt' : 'Payment');
    const txnAmt = receiptsAmt > 0 ? receiptsAmt : paymentsAmt;
    state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
    state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
    if(receiptsAmt > 0){
      // Dr Bank (receipt), Cr counterparty account
      const bankTxn = { id: uid('txn'), date: txnDate, action: 'Revenue', accountId: bankAcct ? bankAcct.id : '', accountName: bankAcct ? bankAcct.name : 'Bank', accountCategory: 'Asset', description: txnDesc, amount: txnAmt, vatType: 'none', whtApplied: false, paye: false, contact: '', cashbookReceipts: receiptsAmt, cashbookPayments: 0, isCashbookEntry: true };
      state.transactions[selectedUserId][selectedBizId].push(bankTxn);
      if(cpAcct){
        const cpTxn = { id: uid('txn'), date: txnDate, action: cpAcct.category === 'Revenue' ? 'Revenue' : (cpAcct.category === 'Expense' ? 'Expense' : 'CashbookLeg'), accountId: cpAcct.id, accountName: cpAcct.name, accountCategory: cpAcct.category, description: txnDesc, amount: txnAmt, vatType: 'none', whtApplied: false, paye: false, contact: '', cashbookReceipts: 0, cashbookPayments: 0, isCashbookEntry: true, isCashbookCounterparty: true, linkedTxnId: bankTxn.id };
        state.transactions[selectedUserId][selectedBizId].push(cpTxn);
      }
      addAudit('cashbook.add', 'txn', bankTxn.id, `Cashbook receipt: ${txnAmt} to ${bankAcct ? bankAcct.name : 'Bank'}`);
    } else {
      // Dr counterparty account, Cr Bank (payment)
      const bankTxn = { id: uid('txn'), date: txnDate, action: 'Expense', accountId: bankAcct ? bankAcct.id : '', accountName: bankAcct ? bankAcct.name : 'Bank', accountCategory: 'Asset', description: txnDesc, amount: txnAmt, vatType: 'none', whtApplied: false, paye: false, contact: '', cashbookReceipts: 0, cashbookPayments: paymentsAmt, isCashbookEntry: true };
      state.transactions[selectedUserId][selectedBizId].push(bankTxn);
      if(cpAcct){
        const cpTxn = { id: uid('txn'), date: txnDate, action: cpAcct.category === 'Revenue' ? 'Revenue' : (cpAcct.category === 'Expense' ? 'Expense' : 'CashbookLeg'), accountId: cpAcct.id, accountName: cpAcct.name, accountCategory: cpAcct.category, description: txnDesc, amount: txnAmt, vatType: 'none', whtApplied: false, paye: false, contact: '', cashbookReceipts: 0, cashbookPayments: 0, isCashbookEntry: true, isCashbookCounterparty: true, linkedTxnId: bankTxn.id };
        state.transactions[selectedUserId][selectedBizId].push(cpTxn);
      }
      addAudit('cashbook.add', 'txn', bankTxn.id, `Cashbook payment: ${txnAmt} from ${bankAcct ? bankAcct.name : 'Bank'}`);
    }
    saveState();
    if(dateEl) dateEl.value = today();
    if(descEl) descEl.value = '';
    if(receiptsEl) receiptsEl.value = '';
    if(paymentsEl) paymentsEl.value = '';
    renderCashbook();
  }

  /**
   * Returns true when the account should be treated as an "appropriation" account for P&L.
   * Matches accounts whose name contains 'dividend' (exact Expense category) or 'general reserve'
   * (exact Expense category), while excluding Revenue-category accounts with similar names.
   * @param {string} acctName - Account name (lowercase-compared internally)
   * @param {string} acctCategory - Account category ('Expense', 'Revenue', etc.)
   */
  function isDividendAccount(acctName, acctCategory) {
    if(acctCategory !== 'Expense') return false;
    const lower = (acctName || '').toLowerCase();
    // Only match pure "dividend" accounts (not "dividend received" which is Revenue)
    return lower === 'dividend' || lower === 'dividends';
  }
  function isGeneralReserveAccount(acctName, acctCategory) {
    if(acctCategory !== 'Expense') return false;
    const lower = (acctName || '').toLowerCase();
    return lower.includes('general reserve');
  }

  /**
   * Computes P&L figures shared between the P&L Statement and Balance Sheet.
   * @param {string} bizId
   * @param {string} userId
   * @returns {{ totalRevenue, totalCOGS, totalExpense, totalTax, totalDividend, totalGeneralReserve,
   *             retainedProfitForYear, retainedProfitBF, retainedProfitCF,
   *             revenueByAcct, cogsAmt, expenseByAcct, taxByAcct, dividendByAcct, generalReserveByAcct }}
   */
  function computePLFigures(bizId, userId) {
    const b = findBiz(bizId);
    const arr = (state.transactions[userId] && state.transactions[userId][bizId]) || [];

    let totalRevenue = 0, totalCOGS = 0, totalOtherIncome = 0;
    let totalExpense = 0, totalTax = 0, totalDividend = 0, totalGeneralReserve = 0;
    const revenueByAcct = {}, cogsAmt = {}, otherIncomeByAcct = {};
    const expenseByAcct = {}, taxByAcct = {}, dividendByAcct = {}, generalReserveByAcct = {};

    for(const t of arr) {
      const acctName = t.accountName || 'Other';
      const isTaxPayment = TAX_PAYMENT_ACCOUNTS.includes(acctName);
      const isCOGS = (acctName === 'COGS' || t.isCOGS) && t.accountCategory === 'Expense';
      const isDividend = isDividendAccount(acctName, t.accountCategory);
      const isGenReserve = isGeneralReserveAccount(acctName, t.accountCategory);
      const amt = Number(t.amount || 0);

      if(t.accountCategory === 'Revenue' || t.accountCategory === 'Income') {
        revenueByAcct[acctName] = (revenueByAcct[acctName] || 0) + amt;
        totalRevenue += amt;
      } else if(isTaxPayment) {
        taxByAcct[acctName] = (taxByAcct[acctName] || 0) + amt;
        totalTax += amt;
      } else if(isCOGS) {
        cogsAmt[acctName] = (cogsAmt[acctName] || 0) + amt;
        totalCOGS += amt;
      } else if(isDividend) {
        dividendByAcct[acctName] = (dividendByAcct[acctName] || 0) + amt;
        totalDividend += amt;
      } else if(isGenReserve) {
        generalReserveByAcct[acctName] = (generalReserveByAcct[acctName] || 0) + amt;
        totalGeneralReserve += amt;
      } else if(t.accountCategory === 'Expense') {
        expenseByAcct[acctName] = (expenseByAcct[acctName] || 0) + amt;
        totalExpense += amt;
      }
    }

    // Add depreciation to Expenses
    const depreciation = computeTotalDepreciation();
    if(depreciation > 0) {
      expenseByAcct['Depreciation'] = (expenseByAcct['Depreciation'] || 0) + depreciation;
      totalExpense += depreciation;
    }

    const grossProfit = totalRevenue - totalCOGS;
    const netProfitBeforeTax = grossProfit + totalOtherIncome - totalExpense;
    const netProfitAfterTax = netProfitBeforeTax - totalTax;
    const totalAppropriation = totalDividend + totalGeneralReserve;
    const retainedProfitForYear = netProfitAfterTax - totalAppropriation;
    const retainedProfitBF = Number((b && b.retainedProfitBF) || 0);
    const retainedProfitCF = retainedProfitForYear + retainedProfitBF;

    return {
      totalRevenue, totalCOGS, totalOtherIncome, totalExpense, totalTax, totalDividend, totalGeneralReserve,
      grossProfit, netProfitBeforeTax, netProfitAfterTax, totalAppropriation,
      retainedProfitForYear, retainedProfitBF, retainedProfitCF,
      revenueByAcct, cogsAmt, otherIncomeByAcct, expenseByAcct, taxByAcct, dividendByAcct, generalReserveByAcct
    };
  }
  
  /**
   * Show Financial Sub-Report (P&L or Balance Sheet)
   * @param {string} type - 'pl' for Profit & Loss, 'bs' for Balance Sheet
   */
  function showFinancialSubReport(type) {
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    const subReportDiv = document.getElementById('financialSubReport');
    if(!subReportDiv) return;
    
    let html = '';
    
    if(type === 'pl') {
      // ------------------------------------------------------------------
      // Profit & Loss Statement
      // Format:
      //   Revenue
      //   less COGS                        => Gross Profit
      //   add Other Income
      //   less Expense (excl. COGS & tax)  => Net Profit Before Tax
      //   less Tax                         => Net Profit After Tax
      //   less Appropriations (Dividend, General Reserve)
      //   = Retained Profit for the Year
      //   + Retained Profit b/f
      //   = Retained Profit c/f
      // ------------------------------------------------------------------
      const periodSubtitle = (b.periodStart || b.periodEnd)
        ? `<small style="font-weight:normal;color:#64748b;">${b.periodStart || ''} to ${b.periodEnd || ''}</small>`
        : '';
      html += `<h4>Profit &amp; Loss Statement ${periodSubtitle}</h4>`;

      const pl = computePLFigures(selectedBizId, selectedUserId);

      html += `<table style="width:100%;border-collapse:collapse;margin-top:16px;">`;
      html += `<thead><tr><th style="text-align:left;">Description</th><th style="text-align:right;width:160px;">Amount (â‚¦)</th></tr></thead>`;
      html += `<tbody>`;

      // Revenue
      html += `<tr style="background:#f2f6fa;"><td><strong>Revenue</strong></td><td></td></tr>`;
      for(const [n,v] of Object.entries(pl.revenueByAcct)){
        html += `<tr><td style="padding-left:20px;">${n}</td><td style="text-align:right;">${fmt(v)}</td></tr>`;
      }
      html += `<tr><td style="font-weight:600;">Total Revenue</td><td style="text-align:right;font-weight:600;">${fmt(pl.totalRevenue)}</td></tr>`;

      // COGS
      html += `<tr><td colspan="2" style="padding-top:6px;"></td></tr>`;
      html += `<tr style="background:#f2f6fa;"><td><strong>less: Cost of Goods Sold (COGS)</strong></td><td></td></tr>`;
      for(const [n,v] of Object.entries(pl.cogsAmt)){
        html += `<tr><td style="padding-left:20px;">${n}</td><td style="text-align:right;">(${fmt(v)})</td></tr>`;
      }
      html += `<tr style="background:#e6f3ff;"><td><strong>= Gross Profit</strong></td><td style="text-align:right;"><strong>${fmt(pl.grossProfit)}</strong></td></tr>`;

      // Other Income
      if(pl.totalOtherIncome > 0) {
        html += `<tr><td colspan="2" style="padding-top:6px;"></td></tr>`;
        html += `<tr style="background:#f2f6fa;"><td><strong>add: Other Income</strong></td><td></td></tr>`;
        for(const [n,v] of Object.entries(pl.otherIncomeByAcct)){
          html += `<tr><td style="padding-left:20px;">${n}</td><td style="text-align:right;">${fmt(v)}</td></tr>`;
        }
      }

      // Expenses
      html += `<tr><td colspan="2" style="padding-top:6px;"></td></tr>`;
      html += `<tr style="background:#f2f6fa;"><td><strong>less: Expenses</strong></td><td></td></tr>`;
      for(const [n,v] of Object.entries(pl.expenseByAcct)){
        html += `<tr><td style="padding-left:20px;">${n}</td><td style="text-align:right;">(${fmt(v)})</td></tr>`;
      }
      html += `<tr style="background:#e6f3ff;"><td><strong>= Net Profit Before Tax</strong></td><td style="text-align:right;"><strong>${fmt(pl.netProfitBeforeTax)}</strong></td></tr>`;

      // Tax
      html += `<tr><td colspan="2" style="padding-top:6px;"></td></tr>`;
      html += `<tr style="background:#f2f6fa;"><td><strong>less: Tax</strong></td><td></td></tr>`;
      for(const [n,v] of Object.entries(pl.taxByAcct)){
        html += `<tr><td style="padding-left:20px;">${n}</td><td style="text-align:right;">(${fmt(v)})</td></tr>`;
      }
      if(pl.totalTax === 0) {
        html += `<tr><td style="padding-left:20px;color:#64748b;">None</td><td style="text-align:right;color:#64748b;">â€“</td></tr>`;
      }
      html += `<tr style="background:#e6f3ff;"><td><strong>= Net Profit After Tax</strong></td><td style="text-align:right;"><strong>${fmt(pl.netProfitAfterTax)}</strong></td></tr>`;

      // Appropriations
      html += `<tr><td colspan="2" style="padding-top:6px;"></td></tr>`;
      html += `<tr style="background:#f2f6fa;"><td><strong>less: Appropriation Items</strong></td><td></td></tr>`;
      for(const [n,v] of Object.entries(pl.dividendByAcct)){
        html += `<tr><td style="padding-left:20px;">${n}</td><td style="text-align:right;">(${fmt(v)})</td></tr>`;
      }
      for(const [n,v] of Object.entries(pl.generalReserveByAcct)){
        html += `<tr><td style="padding-left:20px;">${n}</td><td style="text-align:right;">(${fmt(v)})</td></tr>`;
      }
      if(pl.totalAppropriation === 0) {
        html += `<tr><td style="padding-left:20px;color:#64748b;">None</td><td style="text-align:right;color:#64748b;">â€“</td></tr>`;
      }

      // Retained Profit
      html += `<tr style="background:#e6f3ff;"><td><strong>Retained Profit for the Year</strong></td><td style="text-align:right;"><strong>${fmt(pl.retainedProfitForYear)}</strong></td></tr>`;

      // Roll-forward
      html += `<tr><td colspan="2" style="padding-top:6px;"></td></tr>`;
      html += `<tr><td style="padding-left:10px;">Retained Profit b/f</td><td style="text-align:right;">${fmt(pl.retainedProfitBF)}</td></tr>`;
      html += `<tr style="background:#e6f3ff;border-top:2px solid #0b76d1;"><td><strong>Retained Profit c/f</strong></td><td style="text-align:right;"><strong>${fmt(pl.retainedProfitCF)}</strong></td></tr>`;

      html += `</tbody></table>`;

    } else if(type === 'bs') {
      // ------------------------------------------------------------------
      // Balance Sheet (Accrual Basis)
      // Assets  = Account balances + Inventory (closing) + PPE at NBV + WHT Receivable
      // Liabilities = Account balances + Accrued Tax Liabilities (computed, not yet paid)
      // Equity  = Capital accounts + Retained Profit c/f
      //
      // Opening balances are stored as static fields on each account (not journal entries).
      // PPE at NBV = Cost âˆ’ Accumulated Depreciation (book).
      // Inventory closing value computed from the inventory schedule.
      // Tax liabilities computed from the tax engine (outstanding = computed âˆ’ paid).
      // ------------------------------------------------------------------
      html += `<h4>Balance Sheet <small style="font-weight:normal;color:#64748b;">(Accrual Basis)</small></h4>`;
      
      const assets = {};
      const liabilities = {};
      const capital = {};
      
      // Tax-payable account names (shown separately via computed accruals; excluded here to avoid double-count)
      const taxPayableAcctNames = ['VAT Payable', 'WHT Payable', 'PAYE Payable', 'PIT Payable', 'CIT Payable', 'CGT Payable'];

      // Calculate balances for each account, excluding tax payable accounts (handled via accruals)
      for(const acct of b.accounts || []){
        const balance = calculateAccountClosingBalance(acct, selectedBizId);
        if(acct.category === 'Asset'){
          // WHT Receivable is shown separately below; skip duplicate
          if(acct.name === 'WHT Receivable') continue;
          // VAT Recoverable is shown separately as computed value; skip account balance to avoid double-count
          if(acct.name === 'VAT Recoverable') continue;
          assets[acct.name] = balance;
        } else if(acct.category === 'Liability'){
          // Tax payable accounts handled by computed accruals section
          if(taxPayableAcctNames.includes(acct.name)) continue;
          liabilities[acct.name] = balance;
        } else if(acct.category === 'Capital'){
          capital[acct.name] = balance;
        }
      }

      // --- Inventory Schedule closing balance ---
      let inventoryTotal = 0;
      for(const item of (b.inventory || [])){
        inventoryTotal += (item.qty || 0) * (item.avgCost || 0);
      }

      // --- PPE at NBV from Fixed Asset Schedule ---
      // Compute: NBV = Cost âˆ’ Accumulated Depreciation (book value)
      // Updates asset.accumulatedDep via computeTotalDepreciation()
      computeTotalDepreciation(); // ensure accumulatedDep is up-to-date
      let totalPPECost = 0, totalAccDep = 0;
      for(const a of (b.assets || [])){
        if(a.disposed) continue; // exclude disposed assets from balance sheet
        const cost = Number(a.cost || 0);
        const accDep = Number(a.accumulatedDep || 0);
        totalPPECost += cost;
        totalAccDep += accDep;
      }
      const ppeNBV = totalPPECost - totalAccDep;

      // --- WHT Receivable (computed, not from account balance) ---
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      let whtReceivable = 0, whtPaidToAuthority = 0;
      for(const t of arr){
        const acctName = (findAccount(b, t.accountId) || {}).name || t.accountName || '';
        if(acctName === 'WHT Remitted' || acctName === 'WHT Paid') {
          whtPaidToAuthority += Number(t.amount || 0);
        } else if(t.whtApplied && t.accountCategory === 'Revenue'){
          const rate = (t.whtRate || b.whtRate) / 100;
          if(t.whtBasis === 'net'){
            whtReceivable += Number(t.amount || 0) * (rate / (1 - rate));
          } else {
            whtReceivable += Number(t.amount || 0) * rate;
          }
        }
      }
      const whtReceivableNet = Math.max(0, whtReceivable - whtPaidToAuthority);

      // --- Compute accrued tax liabilities (outstanding = computed âˆ’ paid) ---
      // VAT
      let vatCollected = 0, vatExpensePaid = 0, vatPaidToGovt = 0, vatRefunded = 0;
      // WHT payable
      let whtPayable = 0;
      // PAYE
      const payeByContact = {};
      let payePaid = 0;
      // PIT / CIT
      let pitPaid = 0, citPaid = 0, cgtPaid = 0;

      for(const t of arr){
        const acctName = (findAccount(b, t.accountId) || {}).name || t.accountName || '';
        const amt = Number(t.amount || 0);
        if(acctName === 'VAT Paid') vatPaidToGovt += amt;
        else if(acctName === 'VAT Refunded') vatRefunded += amt;
        else if(acctName === 'PAYE Paid') payePaid += amt;
        else if(acctName === 'PIT Paid') pitPaid += amt;
        else if(acctName === 'CIT Paid') citPaid += amt;
        else if(acctName === 'CGT Paid') cgtPaid += amt;
        // WHT paid already tracked above
        
        if(t.vatType === 'exclusive' && t.accountCategory === 'Revenue') vatCollected += amt * (b.vatRate/100);
        else if(t.vatType === 'inclusive' && t.accountCategory === 'Revenue') vatCollected += amt * (b.vatRate / (100 + b.vatRate));
        if(t.vatType === 'exclusive' && t.accountCategory === 'Expense') vatExpensePaid += amt * (b.vatRate/100);
        else if(t.vatType === 'inclusive' && t.accountCategory === 'Expense') vatExpensePaid += amt * (b.vatRate / (100 + b.vatRate));

        if(t.whtApplied && t.accountCategory === 'Expense'){
          const rate = (t.whtRate || b.whtRate) / 100;
          if(t.whtBasis === 'net') whtPayable += amt * (rate / (1 - rate));
          else whtPayable += amt * rate;
        }
        if(t.paye && t.contact){
          payeByContact[t.contact] = (payeByContact[t.contact] || 0) + amt;
        }
      }
      const vatRawNet = (vatCollected - vatExpensePaid) - vatPaidToGovt + vatRefunded;
      const vatNetOutstanding = Math.max(0, vatRawNet);
      const vatRecoverableBS = vatRawNet < 0 ? Math.abs(vatRawNet) : 0;
      const whtPayableOutstanding = Math.max(0, whtPayable - whtPaidToAuthority);
      let payeAnnualTotal = 0;
      for(const cName in payeByContact){
        payeAnnualTotal += computePAYEOnAnnualIncome(payeByContact[cName] || 0);
      }
      const payeOutstanding = Math.max(0, payeAnnualTotal - payePaid);

      // PIT / CIT â€” reuse tax summary computation
      const plSnap = computePLSnapshot();
      const taxableProfit = Math.max(0, plSnap.accountingProfit);
      let pitOutstanding = 0, citOutstanding = 0, cgtOutstanding = 0;
      if(b.entity !== 'Company' && b.pitEnabled){
        const pitLiability = computePAYEOnAnnualIncome(taxableProfit);
        pitOutstanding = Math.max(0, pitLiability - whtReceivable - pitPaid);
      }
      if(b.entity === 'Company' && b.citEnabled){
        // Use the CIT from chargeableGains
        const gains = computeChargeableGainsForBiz();
        let cgtCharge = 0;
        for(const g of gains) cgtCharge += g.cgtCharge || 0;
        cgtOutstanding = Math.max(0, cgtCharge - cgtPaid);

        const threshold = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
        let citCharge = 0;
        let computedTurnover = 0;
        for(const t of arr){ if(t.action === 'Revenue' || t.action === 'InventorySale') computedTurnover += Number(t.amount||0); }
        if(threshold === CIT_THRESHOLDS.MEDIUM && computedTurnover > CIT_THRESHOLDS.MEDIUM) {
          citCharge = 0.25 * taxableProfit;
        } else if(threshold === CIT_THRESHOLDS.LARGE && computedTurnover > CIT_THRESHOLDS.LARGE) {
          citCharge = 0.30 * taxableProfit;
        }
        citOutstanding = Math.max(0, citCharge - whtReceivable - citPaid);
      }

      // Build totals
      const totalAccountAssets = Object.values(assets).reduce((s,v)=>s+v,0);
      const totalAssetsAll = totalAccountAssets
        + (inventoryTotal > 0 ? inventoryTotal : 0)
        + (ppeNBV > 0 ? ppeNBV : 0)
        + (whtReceivableNet > 0 ? whtReceivableNet : 0)
        + (vatRecoverableBS > 0 ? vatRecoverableBS : 0);

      const totalAccountLiabilities = Object.values(liabilities).reduce((s,v)=>s+v,0);
      const totalTaxLiabilities = vatNetOutstanding + whtPayableOutstanding + payeOutstanding + pitOutstanding + citOutstanding + cgtOutstanding;
      const totalLiabilitiesAll = totalAccountLiabilities + totalTaxLiabilities;

      const totalCapital = Object.values(capital).reduce((s,v)=>s+v,0);

      // Use shared P&L figures for retained earnings roll-forward
      const { retainedProfitForYear, retainedProfitBF, retainedProfitCF } =
        computePLFigures(selectedBizId, selectedUserId);

      html += `<table style="width:100%;border-collapse:collapse;margin-top:16px;">`;
      html += `<thead><tr><th style="text-align:left;">Description</th><th style="text-align:right;width:160px;">Amount (â‚¦)</th></tr></thead>`;
      html += `<tbody>`;

      // ---- ASSETS ----
      html += `<tr style="background:#f2f6fa;"><td><strong>Assets</strong></td><td></td></tr>`;
      for(const [name, balance] of Object.entries(assets)){
        if(balance !== 0)
          html += `<tr><td style="padding-left:20px;">${name}</td><td style="text-align:right;">${fmt(balance)}</td></tr>`;
      }
      // Inventory closing balance from schedule
      if(inventoryTotal > 0)
        html += `<tr><td style="padding-left:20px;">Inventory (closing)</td><td style="text-align:right;">${fmt(inventoryTotal)}</td></tr>`;
      // PPE at Net Book Value from fixed asset schedule
      if(totalPPECost > 0){
        html += `<tr><td style="padding-left:20px;">Property, Plant &amp; Equipment â€” at NBV</td><td style="text-align:right;">${fmt(ppeNBV)}</td></tr>`;
        html += `<tr><td style="padding-left:36px;color:#64748b;font-size:0.9rem;">Cost: ${fmt(totalPPECost)} | Acc. Dep: (${fmt(totalAccDep)})</td><td></td></tr>`;
      }
      // WHT Receivable (credit against CIT/PIT)
      if(whtReceivableNet > 0)
        html += `<tr><td style="padding-left:20px;">WHT Receivable</td><td style="text-align:right;">${fmt(whtReceivableNet)}</td></tr>`;
      // VAT Recoverable (reclassified from negative VAT payable)
      if(vatRecoverableBS > 0)
        html += `<tr><td style="padding-left:20px;">VAT Recoverable</td><td style="text-align:right;">${fmt(vatRecoverableBS)}</td></tr>`;
      html += `<tr style="background:#f2f6fa;"><td><strong>Total Assets</strong></td><td style="text-align:right;"><strong>${fmt(totalAssetsAll)}</strong></td></tr>`;

      html += `<tr><td colspan="2" style="padding-top:10px;"></td></tr>`;

      // ---- LIABILITIES ----
      html += `<tr style="background:#f2f6fa;"><td><strong>Liabilities</strong></td><td></td></tr>`;
      for(const [name, balance] of Object.entries(liabilities)){
        if(balance !== 0)
          html += `<tr><td style="padding-left:20px;">${name}</td><td style="text-align:right;">${fmt(balance)}</td></tr>`;
      }
      // Accrued tax liabilities (computed, accrual basis)
      if(totalTaxLiabilities > 0){
        html += `<tr><td style="padding-left:20px;font-style:italic;">Tax Liabilities (accrued):</td><td></td></tr>`;
        if(vatNetOutstanding > 0) html += `<tr><td style="padding-left:36px;">VAT Payable</td><td style="text-align:right;">${fmt(vatNetOutstanding)}</td></tr>`;
        if(whtPayableOutstanding > 0) html += `<tr><td style="padding-left:36px;">WHT Payable</td><td style="text-align:right;">${fmt(whtPayableOutstanding)}</td></tr>`;
        if(payeOutstanding > 0) html += `<tr><td style="padding-left:36px;">PAYE Payable</td><td style="text-align:right;">${fmt(payeOutstanding)}</td></tr>`;
        if(pitOutstanding > 0) html += `<tr><td style="padding-left:36px;">PIT Payable</td><td style="text-align:right;">${fmt(pitOutstanding)}</td></tr>`;
        if(citOutstanding > 0) html += `<tr><td style="padding-left:36px;">CIT Payable</td><td style="text-align:right;">${fmt(citOutstanding)}</td></tr>`;
        if(cgtOutstanding > 0) html += `<tr><td style="padding-left:36px;">CGT Payable</td><td style="text-align:right;">${fmt(cgtOutstanding)}</td></tr>`;
      }
      html += `<tr style="background:#f2f6fa;"><td><strong>Total Liabilities</strong></td><td style="text-align:right;"><strong>${fmt(totalLiabilitiesAll)}</strong></td></tr>`;

      html += `<tr><td colspan="2" style="padding-top:10px;"></td></tr>`;

      // ---- EQUITY ----
      html += `<tr style="background:#f2f6fa;"><td><strong>Capital &amp; Equity</strong></td><td></td></tr>`;
      for(const [name, balance] of Object.entries(capital)){
        html += `<tr><td style="padding-left:20px;">${name}</td><td style="text-align:right;">${fmt(balance)}</td></tr>`;
      }
      html += `<tr><td style="padding-left:20px;font-style:italic;">Retained Profit for the Year</td><td style="text-align:right;">${fmt(retainedProfitForYear)}</td></tr>`;
      html += `<tr><td style="padding-left:20px;font-style:italic;">Retained Profit b/f</td><td style="text-align:right;">${fmt(retainedProfitBF)}</td></tr>`;
      html += `<tr><td style="padding-left:20px;font-weight:600;">Retained Profit c/f</td><td style="text-align:right;font-weight:600;">${fmt(retainedProfitCF)}</td></tr>`;

      const totalEquity = totalCapital + retainedProfitCF;
      html += `<tr style="background:#f2f6fa;"><td><strong>Total Capital &amp; Equity</strong></td><td style="text-align:right;"><strong>${fmt(totalEquity)}</strong></td></tr>`;

      html += `<tr><td colspan="2" style="padding-top:10px;"></td></tr>`;

      html += `<tr style="background:#e6f3ff;"><td><strong>Total Liabilities + Capital &amp; Equity</strong></td><td style="text-align:right;"><strong>${fmt(totalLiabilitiesAll + totalEquity)}</strong></td></tr>`;

      html += `</tbody></table>`;
    }
    
    subReportDiv.innerHTML = html;
  }
  
  // Make showFinancialSubReport available globally
  window.showFinancialSubReport = showFinancialSubReport;
  
  /**
   * Check if the current business is on the Enterprise Plus plan.
   * Payables, Journal Entry, and Bank Reconciliation are gated to this plan.
   * @returns {boolean}
   */
  function isEnterprisePlus() {
    const b = findBiz(selectedBizId);
    if (!b) return false;
    return b.entity === 'Enterprise Plus' || b.entity === 'Enterprise' || b.plan === 'Enterprise Plus' || b.plan === 'Enterprise';
  }

  /**
   * Check if current user can access enterprise features
   * - Enterprise Plus plan: All users can access Payables / Journal / Bank Reconciliation
   * @returns {boolean}
   */
  function canAccessEnterpriseFeatures() {
    return isEnterprisePlus();
  }
  
  /**
   * Update visibility of Enterprise Plus feature tabs.
   * Payables, Journal Entry, and Bank Reconciliation are only shown for Enterprise Plus businesses.
   */
  function updateEnterpriseFeatureVisibility() {
    const btnBankReconciliationTab = document.getElementById('btnBankReconciliationTab');
    const btnJournalEntryTab = document.getElementById('btnJournalEntryTab');
    const btnPayablesTab = document.getElementById('btnPayablesTab');
    const visible = isEnterprisePlus() ? 'inline-block' : 'none';

    if (btnBankReconciliationTab) btnBankReconciliationTab.style.display = visible;
    if (btnJournalEntryTab) btnJournalEntryTab.style.display = visible;
    if (btnPayablesTab) btnPayablesTab.style.display = visible;
  }



  /**
   * Computes accounting profit from transactions.
   * Accounting profit = Total Revenue - Total Expenses (including depreciation)
   * @returns {number} Accounting profit
   */
  function computeAccountingProfit() {
    const b = findBiz(selectedBizId);
    if(!b) return 0;
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    let revenue = 0, expenses = 0;
    
    for(const t of arr){
      if(t.accountCategory === 'Revenue') revenue += Number(t.amount || 0);
      if(t.accountCategory === 'Expense') expenses += Number(t.amount || 0);
    }
    
    // Add depreciation as expense
    const depreciationDaily = computeTotalDepreciation();
    expenses += depreciationDaily;
    
    return revenue - expenses;
  }

  /**
   * Refreshes all reports and snapshots when transactions/assets change.
   * Called after ledger postings, inventory actions, and asset actions.
   */
  function refreshAllReports() {
    renderPLSnapshot();
    renderTaxSummary();
    renderPLSnapshotQuick();
    renderInventoryList();
    renderAssetList();
    
    // If reports tab is active, refresh the current report
    if(activeTab === 'reports') {
      const activeReportTab = document.querySelector('#reportsSection .tab.active');
      if(activeReportTab && activeReportTab.dataset.report) {
        renderReport(activeReportTab.dataset.report);
      }
    }
  }

  /**
   * Updates report tab visibility based on selected business entity type.
   * - Individual: VAT, PIT (Individual), Audit Trail, Receipts Folder
   * - Enterprise: VAT, WHT Payable, WHT Receivable, PAYE, Inventory, Assets, PIT (Enterprise), Audit Trail, Receipts Folder, CGT (hide Company Accounts)
   * - Company: All except PIT reports, includes Company Accounts and CGT
   */
  function updateReportTabVisibility() {
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    const entity = b.entity || 'Company';
    const reportTabs = document.querySelectorAll('#reportsSection .tab[data-report]');
    
    // Define visibility per entity (plan gating):
    // Business: PIT summary + all other reports (no CIT)
    // Company: CIT summary + all other reports (no PIT)
    // Enterprise: full PIT + full CIT + all other reports
    const visibilityRules = {
      'Business': {
        'vatReport': true,
        'whtPayable': true,
        'whtReceivable': true,
        'payeReport': true,
        'inventoryReport': true,
        'assetsReport': true,
        'pitBusiness': true,   // Business: show PIT
        'cgtReport': true,
        'citReport': false,    // Business: hide CIT
        'companyAccounts': false,
        'financialReport': true,
        'auditTrail': true,
        'receiptsFolder': true
      },
      'Enterprise Plus': {
        'vatReport': true,
        'whtPayable': true,
        'whtReceivable': true,
        'payeReport': true,
        'inventoryReport': true,
        'assetsReport': true,
        'pitBusiness': true,   // Enterprise Plus: show PIT
        'cgtReport': true,
        'citReport': true,     // Enterprise Plus: show CIT too (full access)
        'companyAccounts': false,
        'financialReport': true,
        'auditTrail': true,
        'receiptsFolder': true
      },
      'Enterprise': {
        'vatReport': true,
        'whtPayable': true,
        'whtReceivable': true,
        'payeReport': true,
        'inventoryReport': true,
        'assetsReport': true,
        'pitBusiness': true,   // Enterprise: show full PIT
        'cgtReport': true,
        'citReport': true,     // Enterprise: show full CIT too
        'companyAccounts': false,
        'financialReport': true,
        'auditTrail': true,
        'receiptsFolder': true
      },
      'Company': {
        'vatReport': true,
        'whtPayable': true,
        'whtReceivable': true,
        'payeReport': true,
        'inventoryReport': true,
        'assetsReport': true,
        'pitBusiness': false,  // Company: hide PIT
        'cgtReport': true,
        'citReport': true,     // Company: show CIT
        'companyAccounts': true,
        'financialReport': true,
        'auditTrail': true,
        'receiptsFolder': true
      }
    };
    
    const rules = visibilityRules[entity] || visibilityRules['Company'];
    
    reportTabs.forEach(tab => {
      const reportName = tab.dataset.report;
      if(rules.hasOwnProperty(reportName)) {
        tab.style.display = rules[reportName] ? 'inline-block' : 'none';
      }
    });
    
    // If current active tab is hidden, switch to first visible report tab
    const activeReportTab = document.querySelector('#reportsSection .tab.active');
    if(activeReportTab && activeReportTab.style.display === 'none') {
      document.querySelectorAll('#reportsSection .tab').forEach(t => t.classList.remove('active'));
      // Find first visible tab
      const firstVisibleTab = Array.from(reportTabs).find(tab => tab.style.display !== 'none');
      if(firstVisibleTab) {
        firstVisibleTab.classList.add('active');
        const reportName = firstVisibleTab.dataset.report;
        if(reportName) renderReport(reportName);
      }
    }
  }

  /**
   * Gets statutory deductions for a contact, falling back to business defaults.
   * @param {object} b - Business object
   * @param {string} contactId - Contact ID (optional)
   * @returns {object} Deductions object {pension, rent, life, mortgage, nhf}
   */
  function getStatutoryDeductions(b, contactId) {
    if(!b) return { pension: 0, rent: 0, life: 0, mortgage: 0, nhf: 0 };
    
    // Default business-level deductions
    const bizDed = b.statutoryDeductions || { pension: 0, rent: 0, life: 0, mortgage: 0, nhf: 0 };
    
    if(contactId) {
      const contact = (b.contacts || []).find(c => c.id === contactId);
      if(contact && contact.deductions) {
        // Use contact deductions if the deductions object exists
        // This allows contacts to have explicit zero deductions that override business defaults
        const cd = contact.deductions;
        return {
          pension: Number(cd.pension || 0),
          rent: Number(cd.rent || 0),
          life: Number(cd.life || 0),
          mortgage: Number(cd.mortgage || 0),
          nhf: Number(cd.nhf || 0)
        };
      }
    }
    
    return {
      pension: Number(bizDed.pension || 0),
      rent: Number(bizDed.rent || 0),
      life: Number(bizDed.life || 0),
      mortgage: Number(bizDed.mortgage || 0),
      nhf: Number(bizDed.nhf || 0)
    };
  }

  /**
   * Computes total statutory deductions.
   * @param {object} ded - Deductions object
   * @returns {number} Total deductions
   */
  function totalStatutoryDeductions(ded) {
    return (ded.pension || 0) + (ded.rent || 0) + (ded.life || 0) + (ded.mortgage || 0) + (ded.nhf || 0);
  }

  /**
   * Populates employee/sole trader dropdown for PAYE report.
   * @param {string} bizId - Business ID
   */
  function populateEmployeeDropdownForPaye(bizId) {
    const b = state.businesses.find(x => x.id === bizId);
    if(!b) return [];
    
    // Get employees and sole traders from contacts
    const eligibleContacts = (b.contacts || []).filter(c => 
      c.type === 'Employee' || c.type === 'SoleTrader'
    );
    
    return eligibleContacts;
  }

  /**
   * Generates PIT Business computation report with full template.
   * @param {string} bizId - Business ID
   * @param {string} contactId - Optional contact ID for per-contact deductions
   * @returns {string} HTML content for the report
   */
  function generatePitBusinessReport(bizId, contactId) {
    const b = state.businesses.find(x => x.id === bizId);
    if(!b) return '<div>Business not found</div>';
    
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][bizId]) || [];
    const currentYear = new Date().getFullYear();
    
    // Compute accounting values
    let revenue = 0, expenses = 0;
    let disallowableExpenses = 0;
    let nonTaxableIncome = 0;
    
    for(const t of arr){
      if(t.accountCategory === 'Revenue') {
        revenue += Number(t.amount || 0);
        // Check for non-taxable
        const acct = findAccount(b, t.accountId);
        if(acct && acct.nonTaxableDefault) {
          nonTaxableIncome += Number(t.amount || 0);
        }
        if(t.adjustmentType === 'nontaxable') {
          nonTaxableIncome += Number(t.adjustmentAmount || t.amount || 0);
        }
      }
      if(t.accountCategory === 'Expense') {
        expenses += Number(t.amount || 0);
        // Check for disallowable
        const acct = findAccount(b, t.accountId);
        if(acct && acct.disallowableDefault) {
          disallowableExpenses += Number(t.amount || 0);
        }
        if(t.adjustmentType === 'disallowable') {
          disallowableExpenses += Number(t.adjustmentAmount || t.amount || 0);
        }
      }
    }
    
    // Depreciation is disallowable
    const depreciation = computeTotalDepreciation();
    expenses += depreciation;
    disallowableExpenses += depreciation;
    
    // Compute capital allowance
    const capitalAllowance = computeTotalCapitalAllowance() + (b.caCarryForward || 0);
    
    // Compute asset disposal gains/losses
    let profitOnDisposal = 0;
    let lossOnDisposal = 0;
    let chargeableGains = 0;
    
    for(const a of b.assets || []){
      if(a.disposed && a.disposal){
        const gain = Number(a.disposal.gain || 0);
        if(gain > 0) {
          if(a.classification === 'Chargeable') {
            chargeableGains += gain;
          } else {
            profitOnDisposal += gain;
          }
        } else {
          lossOnDisposal += Math.abs(gain);
        }
      }
    }
    
    // Add loss on disposal to disallowable
    disallowableExpenses += lossOnDisposal;
    
    // Get statutory deductions
    const ded = getStatutoryDeductions(b, contactId);
    const totalDed = totalStatutoryDeductions(ded);
    
    // Calculations
    const accountingProfit = revenue - expenses;
    const adjustedProfit = accountingProfit + disallowableExpenses - nonTaxableIncome - profitOnDisposal;
    const lossBF = Number(b.lossBroughtForward || 0);
    const assessableProfit = Math.max(0, adjustedProfit - lossBF);
    const taxableProfit = Math.max(0, assessableProfit - capitalAllowance);
    const adjustedTaxableProfit = Math.max(0, taxableProfit - totalDed);
    const grossTaxableProfit = adjustedTaxableProfit + chargeableGains;
    
    // Compute PIT using bands
    const pitLiability = computePAYEOnAnnualIncome(grossTaxableProfit);
    
    // WHT receivable
    let whtReceivable = 0;
    for(const t of arr){
      if(t.whtApplied && t.accountCategory === 'Revenue') {
        const rate = Number(t.whtRate || b.whtRate) / 100;
        whtReceivable += Number(t.amount || 0) * rate;
      }
    }
    
    const finalLiability = Math.max(0, pitLiability - whtReceivable);
    const effectiveRate = grossTaxableProfit > 0 ? ((finalLiability / grossTaxableProfit) * 100).toFixed(2) : '0.00';
    
    let html = `<h3>Personal Income Tax Computation (Business)</h3>`;
    html += `<p><strong>Business Name:</strong> ${b.name}</p>`;
    html += `<p><strong>Tax Year:</strong> ${currentYear}</p>`;
    html += `<table style="width:100%;border-collapse:collapse;margin-top:16px;"><thead><tr><th style="text-align:left;">Description</th><th style="text-align:right;width:150px;">Amount (â‚¦)</th></tr></thead><tbody>`;
    
    // Accounting profit
    html += `<tr><td><strong>Accounting profit</strong></td><td style="text-align:right;"><strong>${fmt(accountingProfit)}</strong></td></tr>`;
    
    // Disallowable expenses
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Add: Disallowable Expenses</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Depreciation</td><td style="text-align:right;">${fmt(depreciation)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Loss on disposal</td><td style="text-align:right;">${fmt(lossOnDisposal)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Other disallowable expenses</td><td style="text-align:right;">${fmt(disallowableExpenses - depreciation - lossOnDisposal)}</td></tr>`;
    
    // Non-taxable income
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Deduct: Non-Taxable Income</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Profit on disposal</td><td style="text-align:right;">${fmt(profitOnDisposal)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Other non-taxable income</td><td style="text-align:right;">${fmt(nonTaxableIncome)}</td></tr>`;
    
    // Adjusted profit
    html += `<tr><td><strong>Adjusted Profit</strong></td><td style="text-align:right;"><strong>${fmt(adjustedProfit)}</strong></td></tr>`;
    
    // Unrelieved loss
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Less: Unrelieved Loss b/f</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Loss brought forward</td><td style="text-align:right;">${fmt(lossBF)}</td></tr>`;
    
    // Assessable profit
    html += `<tr><td><strong>Assessable Profit</strong></td><td style="text-align:right;"><strong>${fmt(assessableProfit)}</strong></td></tr>`;
    
    // Capital allowance
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Deduct: Capital Allowance</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Capital allowance</td><td style="text-align:right;">${fmt(capitalAllowance)}</td></tr>`;
    
    // Taxable profit
    html += `<tr><td><strong>Taxable Profit</strong></td><td style="text-align:right;"><strong>${fmt(taxableProfit)}</strong></td></tr>`;
    
    // For Enterprise plans: show full breakdown; for others: show summarized from here
    const isEnterprisePlan = (b.entity === 'Enterprise' || b.entity === 'Enterprise Plus');
    if(isEnterprisePlan){
    // Statutory deductions
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Less: Statutory Deductions</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Pension</td><td style="text-align:right;">${fmt(ded.pension)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Rent relief</td><td style="text-align:right;">${fmt(ded.rent)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Life assurance</td><td style="text-align:right;">${fmt(ded.life)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Mortgage interest</td><td style="text-align:right;">${fmt(ded.mortgage)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">NHF</td><td style="text-align:right;">${fmt(ded.nhf)}</td></tr>`;
    
    // Adjusted taxable profit
    html += `<tr><td><strong>Adjusted Taxable Profit</strong></td><td style="text-align:right;"><strong>${fmt(adjustedTaxableProfit)}</strong></td></tr>`;
    
    // Chargeable gains
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Add: Chargeable Gains on Disposal of Chargeable Assets</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Chargeable gains</td><td style="text-align:right;">${fmt(chargeableGains)}</td></tr>`;
    
    // Gross taxable profit
    html += `<tr style="background:#f2f6fa;"><td><strong>Gross Taxable Profit</strong></td><td style="text-align:right;"><strong>${fmt(grossTaxableProfit)}</strong></td></tr>`;
    
    // PIT computation
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Apply PIT Band</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Tax liability</td><td style="text-align:right;">${fmt(pitLiability)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Less: WHT receivable</td><td style="text-align:right;">(${fmt(whtReceivable)})</td></tr>`;
    } else {
    // Summarized section for Business/Company plans
    html += `<tr><td style="padding-left:20px;">Tax liability</td><td style="text-align:right;">${fmt(pitLiability)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Less: WHT receivable</td><td style="text-align:right;">(${fmt(whtReceivable)})</td></tr>`;
    }
    
    // Final liability
    html += `<tr style="background:#e6f3ff;"><td><strong>Final Tax Liability</strong></td><td style="text-align:right;"><strong>${fmt(finalLiability)}</strong></td></tr>`;
    html += `<tr><td><strong>Effective Tax Rate</strong></td><td style="text-align:right;"><strong>${effectiveRate}%</strong></td></tr>`;
    
    html += `</tbody></table>`;
    
    return html;
  }

  /**
   * Generates CIT (Company Income Tax) computation report.
   * @param {string} bizId - Business ID
   * @returns {string} HTML content for the report
   */
  function generateCITReport(bizId) {
    const b = state.businesses.find(x => x.id === bizId);
    if(!b) return '<div>Business not found</div>';
    
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][bizId]) || [];
    const currentYear = new Date().getFullYear();
    
    // Compute accounting values with WHT receivable add-back
    let revenue = 0, expenses = 0;
    let disallowableExpenses = 0;
    let nonTaxableIncome = 0;
    let whtReceivable = 0;
    let whtRemitted = 0;
    
    for(const t of arr){
      const acct = findAccount(b, t.accountId);
      const accountName = acct?.name || t.accountName || '';
      const isTaxPayment = TAX_PAYMENT_ACCOUNTS.includes(accountName);
      
      // Track WHT remitted
      if (accountName === 'WHT Remitted' || accountName === 'WHT Paid') {
        whtRemitted += Number(t.amount || 0);
      }
      
      // Exclude tax payments from revenue/expenses
      if (!isTaxPayment) {
        if(t.accountCategory === 'Revenue' || t.action === 'InventorySale') {
          revenue += Number(t.amount || 0);
          const acctObj = findAccount(b, t.accountId);
          if(acctObj && acctObj.nonTaxableDefault) {
            nonTaxableIncome += Number(t.amount || 0);
          }
          if(t.adjustmentType === 'nontaxable') {
            nonTaxableIncome += Number(t.adjustmentAmount || t.amount || 0);
          }
          // Add back WHT receivable for revenue transactions
          if(t.whtApplied) {
            if(t.whtBasis === 'net') {
              const rate = (t.whtRate || b.whtRate) / 100;
              whtReceivable += Number(t.amount || 0) * (rate / (1 - rate));
            } else {
              whtReceivable += Number(t.amount || 0) * ((t.whtRate || b.whtRate)/100);
            }
          }
        }
        if(t.accountCategory === 'Expense') {
          expenses += Number(t.amount || 0);
          const acctObj = findAccount(b, t.accountId);
          if(acctObj && acctObj.disallowableDefault) {
            disallowableExpenses += Number(t.amount || 0);
          }
          if(t.adjustmentType === 'disallowable') {
            disallowableExpenses += Number(t.adjustmentAmount || t.amount || 0);
          }
        }
      }
    }
    
    // Depreciation
    const depreciation = computeTotalDepreciation();
    expenses += depreciation;
    disallowableExpenses += depreciation;
    
    // Capital allowance
    const capitalAllowance = computeTotalCapitalAllowance() + (b.caCarryForward || 0);
    
    // Disposal gains/losses
    let profitOnDisposal = 0;
    let lossOnDisposal = 0;
    
    for(const a of b.assets || []){
      if(a.disposed && a.disposal){
        const gain = Number(a.disposal.gain || 0);
        if(gain > 0) {
          profitOnDisposal += gain;
        } else {
          lossOnDisposal += Math.abs(gain);
        }
      }
    }
    
    disallowableExpenses += lossOnDisposal;
    
    // Calculations - add back WHT receivable to accounting profit
    const accountingProfit = revenue + whtReceivable - expenses;
    const adjustedProfit = accountingProfit + disallowableExpenses - nonTaxableIncome - profitOnDisposal;
    const lossBF = Number(b.lossBroughtForward || 0);
    const assessableProfit = Math.max(0, adjustedProfit - lossBF);
    const taxableProfit = Math.max(0, assessableProfit - capitalAllowance);
    
    // Determine CIT rate based on turnover (Nigerian CIT progressive rates)
    // Micro companies (turnover <= â‚¦25M): 0%
    // Small companies (turnover > â‚¦25M and <= â‚¦100M): 20%
    // Large companies (turnover > â‚¦100M): 30%
    let citRate = 0;
    if(revenue > CIT_THRESHOLDS.LARGE) {
      citRate = 0.30; // 30% for large companies
    } else if(revenue > CIT_THRESHOLDS.MEDIUM) {
      citRate = 0.20; // 20% for medium companies
    } else if(revenue > 25000000) {
      citRate = 0.20; // 20% for small companies above â‚¦25M
    }
    // Below â‚¦25M = 0% rate
    
    const citLiability = taxableProfit * citRate;
    
    // Use WHT remitted instead of WHT receivable for final liability
    const finalLiability = Math.max(0, citLiability - whtRemitted);
    const effectiveRate = taxableProfit > 0 ? ((finalLiability / taxableProfit) * 100).toFixed(2) : '0.00';
    
    let html = `<h3>Company Income Tax Computation</h3>`;
    html += `<p><strong>Company Name:</strong> ${b.name}</p>`;
    html += `<p><strong>Financial Year Ended:</strong> ${currentYear}</p>`;
    html += `<table style="width:100%;border-collapse:collapse;margin-top:16px;"><thead><tr><th style="text-align:left;">Description</th><th style="text-align:right;width:150px;">Amount (â‚¦)</th></tr></thead><tbody>`;
    
    html += `<tr><td><strong>Accounting profit</strong></td><td style="text-align:right;"><strong>${fmt(accountingProfit)}</strong></td></tr>`;
    
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Add: Disallowable Expenses</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Depreciation</td><td style="text-align:right;">${fmt(depreciation)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Loss on disposal</td><td style="text-align:right;">${fmt(lossOnDisposal)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Other disallowable</td><td style="text-align:right;">${fmt(disallowableExpenses - depreciation - lossOnDisposal)}</td></tr>`;
    
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Deduct: Non-Taxable Income</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Profit on disposal</td><td style="text-align:right;">${fmt(profitOnDisposal)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Other non-taxable</td><td style="text-align:right;">${fmt(nonTaxableIncome)}</td></tr>`;
    
    html += `<tr><td><strong>Adjusted Profit</strong></td><td style="text-align:right;"><strong>${fmt(adjustedProfit)}</strong></td></tr>`;
    
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Less: Unrelieved Loss b/f</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Loss brought forward</td><td style="text-align:right;">${fmt(lossBF)}</td></tr>`;
    
    html += `<tr><td><strong>Assessable Profit</strong></td><td style="text-align:right;"><strong>${fmt(assessableProfit)}</strong></td></tr>`;
    
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Deduct: Capital Allowance</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Capital allowance</td><td style="text-align:right;">${fmt(capitalAllowance)}</td></tr>`;
    
    html += `<tr style="background:#f2f6fa;"><td><strong>Taxable Profit</strong></td><td style="text-align:right;"><strong>${fmt(taxableProfit)}</strong></td></tr>`;
    
    // For Enterprise plans: show full breakdown; for others: show summarized from taxable profit
    const isEnterpriseCIT = (b.entity === 'Enterprise' || b.entity === 'Enterprise Plus');
    if(isEnterpriseCIT){
    html += `<tr><td colspan="2" style="padding-top:12px;"><strong>Apply CIT Rate (${(citRate * 100).toFixed(0)}%)</strong></td></tr>`;
    html += `<tr><td style="padding-left:20px;">Tax liability</td><td style="text-align:right;">${fmt(citLiability)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Less: WHT receivable</td><td style="text-align:right;">(${fmt(whtRemitted)})</td></tr>`;
    } else {
    html += `<tr><td style="padding-left:20px;">Tax liability at ${(citRate * 100).toFixed(0)}% CIT rate</td><td style="text-align:right;">${fmt(citLiability)}</td></tr>`;
    html += `<tr><td style="padding-left:20px;">Less: WHT receivable</td><td style="text-align:right;">(${fmt(whtRemitted)})</td></tr>`;
    }
    
    html += `<tr style="background:#e6f3ff;"><td><strong>Final Tax Liability</strong></td><td style="text-align:right;"><strong>${fmt(finalLiability)}</strong></td></tr>`;
    html += `<tr><td><strong>Effective Tax Rate</strong></td><td style="text-align:right;"><strong>${effectiveRate}%</strong></td></tr>`;
    
    html += `</tbody></table>`;
    const threshold = b.turnoverThreshold || DEFAULTS.turnoverThreshold;
    html += `<p class="small-note" style="margin-top:12px;">Turnover threshold: ${fmt(threshold)} | CIT Rate: ${(citRate * 100).toFixed(0)}%</p>`;
    
    return html;
  }

  /**
   * Generates CGT (Capital Gains Tax) report from asset disposals.
   * @param {string} bizId - Business ID
   * @returns {string} HTML content for the report
   */
  function generateCgtReport(bizId) {
    const b = state.businesses.find(x => x.id === bizId);
    if(!b) return '<div>Business not found</div>';
    
    const currentYear = new Date().getFullYear();
    const disposals = [];
    let totalGains = 0;
    let totalLosses = 0;
    let totalCarryforwardLosses = 0;
    let totalOffsetUsed = 0;
    let totalCgtCharge = 0;
    
    for(const a of b.assets || []){
      if(a.disposed && a.disposal){
        if(a.classification === 'Chargeable'){
          const proceeds = Number(a.disposal.proceeds || 0);
          const gain = Number(a.disposal.gain || 0);
          const netGain = Number(a.disposal.netGainAfterOffset || gain);
          const cost = getAssetCost(a);
          const twdv = Number(a.disposal.twdv || computeTaxWrittenDownValue(a, a.disposal.date || today()));
          const cgtCharge = Number(a.disposal.cgtCharge || 0);
          const offsetUsed = Number(a.disposal.offsetUsed || 0);
          const lossCarriedForward = Number(a.disposal.lossCarriedForward || 0);
          
          disposals.push({
            name: a.name,
            category: a.category,
            disposalDate: a.disposal.date || '',
            disposalYear: a.disposal.disposalYear || new Date(a.disposal.date || today()).getFullYear(),
            cost: cost,
            twdv: twdv,
            proceeds: proceeds,
            gain: gain,
            netGain: netGain,
            offsetUsed: offsetUsed,
            cgtCharge: cgtCharge,
            lossCarriedForward: lossCarriedForward,
            isShareExempt: a.disposal.isShareExempt || false,
            includedInTaxableProfit: a.disposal.includedInTaxableProfit || false
          });
          
          if(gain > 0) {
            totalGains += gain;
          } else {
            totalLosses += Math.abs(gain);
          }
          totalCarryforwardLosses += lossCarriedForward;
          totalOffsetUsed += offsetUsed;
          totalCgtCharge += cgtCharge;
        }
      }
    }
    
    // Calculate available carryforward losses
    let availableCarryforwardLosses = 0;
    if(b.chargeableLosses) {
      for(const year in b.chargeableLosses) {
        for(const assetClass in b.chargeableLosses[year]) {
          availableCarryforwardLosses += Number(b.chargeableLosses[year][assetClass] || 0);
        }
      }
    }
    
    let html = `<h3>Capital Gains Tax Report</h3>`;
    html += `<p><strong>Business Name:</strong> ${b.name}</p>`;
    html += `<p><strong>Entity Type:</strong> ${b.entity}</p>`;
    html += `<p><strong>Tax Year:</strong> ${currentYear}</p>`;
    
    if(disposals.length === 0) {
      html += `<div class="notice" style="margin-top:16px;">No chargeable asset disposals recorded.</div>`;
      if(availableCarryforwardLosses > 0) {
        html += `<div style="margin-top:8px;"><strong>Carryforward Losses Available:</strong> ${fmt(availableCarryforwardLosses)}</div>`;
      }
      return html;
    }
    
    html += `<h4 style="margin-top:16px;">Disposal Schedule</h4>`;
    html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Asset</th><th>Category</th><th>Disposal Date</th><th>Cost</th><th>TWDV</th><th>Proceeds</th><th>Gain/(Loss)</th><th>Offset</th><th>Net Gain</th><th>CGT</th></tr></thead><tbody>`;
    
    for(const d of disposals){
      const gainClass = d.gain >= 0 ? '' : 'style="color:#b00;"';
      let notes = [];
      if(d.isShareExempt) notes.push('Share exempt');
      if(d.includedInTaxableProfit) notes.push('In taxable profit');
      if(d.lossCarriedForward > 0) notes.push(`Loss c/f: ${fmt(d.lossCarriedForward)}`);
      const notesStr = notes.length > 0 ? `<div class="small-muted">${notes.join(', ')}</div>` : '';
      
      html += `<tr><td>${d.name}${notesStr}</td><td>${d.category || ''}</td><td>${d.disposalDate}</td><td>${fmt(d.cost)}</td><td>${fmt(d.twdv)}</td><td>${fmt(d.proceeds)}</td><td ${gainClass}>${fmt(d.gain)}</td><td>${fmt(d.offsetUsed)}</td><td>${fmt(d.netGain)}</td><td>${fmt(d.cgtCharge)}</td></tr>`;
    }
    
    html += `</tbody></table>`;
    
    html += `<h4 style="margin-top:16px;">CGT Summary</h4>`;
    html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th style="text-align:left;">Description</th><th style="text-align:right;width:150px;">Amount (â‚¦)</th></tr></thead><tbody>`;
    html += `<tr><td>Total Gains</td><td style="text-align:right;">${fmt(totalGains)}</td></tr>`;
    html += `<tr><td>Total Losses (recorded as carryforward)</td><td style="text-align:right;">(${fmt(totalLosses)})</td></tr>`;
    html += `<tr><td>Total Offset Used (from prior-year losses)</td><td style="text-align:right;">(${fmt(totalOffsetUsed)})</td></tr>`;
    html += `<tr style="background:#f2f6fa;"><td><strong>Net Gains After Offset</strong></td><td style="text-align:right;"><strong>${fmt(Math.max(0, totalGains - totalOffsetUsed))}</strong></td></tr>`;
    html += `<tr style="background:#e6f3ff;"><td><strong>Total CGT Charge</strong></td><td style="text-align:right;"><strong>${fmt(totalCgtCharge)}</strong></td></tr>`;
    html += `</tbody></table>`;
    
    // Carryforward losses section
    html += `<h4 style="margin-top:16px;">Carryforward Losses</h4>`;
    if(availableCarryforwardLosses > 0 || totalCarryforwardLosses > 0) {
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th style="text-align:left;">Description</th><th style="text-align:right;width:150px;">Amount (â‚¦)</th></tr></thead><tbody>`;
      html += `<tr><td>Losses Created This Period</td><td style="text-align:right;">${fmt(totalCarryforwardLosses)}</td></tr>`;
      html += `<tr><td>Available Carryforward Losses (to offset future gains)</td><td style="text-align:right;">${fmt(availableCarryforwardLosses)}</td></tr>`;
      html += `</tbody></table>`;
      
      // Show breakdown by year and asset class
      if(b.chargeableLosses && Object.keys(b.chargeableLosses).length > 0) {
        html += `<div class="small-muted" style="margin-top:8px;"><strong>Breakdown:</strong></div>`;
        html += `<ul style="margin:4px 0;font-size:0.9rem;">`;
        for(const year in b.chargeableLosses) {
          for(const assetClass in b.chargeableLosses[year]) {
            const amount = b.chargeableLosses[year][assetClass];
            if(amount > 0) {
              html += `<li>Year ${year} - ${assetClass}: ${fmt(amount)}</li>`;
            }
          }
        }
        html += `</ul>`;
      }
    } else {
      html += `<div class="small-muted">No carryforward losses recorded.</div>`;
    }
    
    // Entity-specific notes
    html += `<h4 style="margin-top:16px;">Notes</h4>`;
    if(b.entity === 'Company') {
      const threshold = b.turnoverThreshold || 0;
      html += `<div class="small-muted">For Companies with turnover threshold > â‚¦100,000,000: CGT is charged at 30% on net gains, not included in taxable profit.</div>`;
      html += `<div class="small-muted">Current turnover threshold setting: ${fmt(threshold)}</div>`;
    } else {
      html += `<div class="small-muted">For Business/Enterprise Plus: Net gains are included in taxable profit and subject to PIT rates.</div>`;
    }
    html += `<div class="small-muted" style="margin-top:6px;">Carryforward losses can only offset gains in future accounting periods (years after the loss occurred).</div>`;
    
    return html;
  }

  // ============== INVOICING FUNCTIONALITY ==============
  let editingInvoice = null;

  /**
   * Render Receivables Summary Dashboard
   * Shows aged receivables and total outstanding
   */
  function renderReceivablesSummary(){
    const summaryDiv = document.getElementById('receivablesSummary');
    if(!summaryDiv) return;
    
    if(!selectedUserId || !selectedBizId) {
      summaryDiv.innerHTML = '<div class="muted">Please select a business</div>';
      return;
    }
    
    // Ensure state.invoices is initialized
    if(!state.invoices) state.invoices = {};
    
    const key = `${selectedUserId}_${selectedBizId}`;
    const invoices = state.invoices[key] || [];
    
    // Calculate receivables by aging period
    let totalReceivables = 0;
    let current = 0;        // 0-30 days
    let aged30 = 0;         // 31-60 days
    let aged60 = 0;         // 61-90 days
    let aged90Plus = 0;     // 90+ days
    
    const today = new Date();
    
    for(const inv of invoices) {
      if(inv.status === 'paid') continue; // Skip paid invoices
      
      // Calculate remaining amount (total - payments)
      const total = Number(inv.total || 0);
      const paymentAmount = Number(inv.paymentAmount || 0);
      const remainingAmount = total - paymentAmount;
      
      // Only count unpaid/partially paid invoices
      if(remainingAmount <= 0) continue;
      
      totalReceivables += remainingAmount;
      
      const dueDate = new Date(inv.dueDate);
      const daysPastDue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
      
      if(daysPastDue <= 30) {
        current += remainingAmount;
      } else if(daysPastDue <= 60) {
        aged30 += remainingAmount;
      } else if(daysPastDue <= 90) {
        aged60 += remainingAmount;
      } else {
        aged90Plus += remainingAmount;
      }
    }
    
    let html = '<h4 style="margin:0 0 8px 0;">Receivables Summary</h4>';
    html += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">';
    
    html += `<div style="background:#f8f9fb; padding:12px; border-radius:6px; border-left:4px solid #0b76d1;">`;
    html += `<div class="small-muted">Total Receivables</div>`;
    html += `<div style="font-size:1.3rem; font-weight:700; color:#0b76d1;">${fmt(totalReceivables)}</div>`;
    html += `</div>`;
    
    html += `<div style="background:#f8f9fb; padding:12px; border-radius:6px; border-left:4px solid #059669;">`;
    html += `<div class="small-muted">Current (0-30 days)</div>`;
    html += `<div style="font-size:1.1rem; font-weight:600; color:#059669;">${fmt(current)}</div>`;
    html += `</div>`;
    
    html += `<div style="background:#f8f9fb; padding:12px; border-radius:6px; border-left:4px solid #f59e0b;">`;
    html += `<div class="small-muted">31-60 days</div>`;
    html += `<div style="font-size:1.1rem; font-weight:600; color:#f59e0b;">${fmt(aged30)}</div>`;
    html += `</div>`;
    
    html += `<div style="background:#f8f9fb; padding:12px; border-radius:6px; border-left:4px solid #dc2626;">`;
    html += `<div class="small-muted">61-90 days</div>`;
    html += `<div style="font-size:1.1rem; font-weight:600; color:#dc2626;">${fmt(aged60)}</div>`;
    html += `</div>`;
    
    html += `<div style="background:#f8f9fb; padding:12px; border-radius:6px; border-left:4px solid #7f1d1d;">`;
    html += `<div class="small-muted">90+ days</div>`;
    html += `<div style="font-size:1.1rem; font-weight:600; color:#7f1d1d;">${fmt(aged90Plus)}</div>`;
    html += `</div>`;
    
    html += '</div>';
    summaryDiv.innerHTML = html;
  }

  /** Current cashbook view tab: 'all' | 'receipts' | 'payments' */
  let cashbookView = 'all';

  /** Switches the cashbook tab view and re-renders. */
  function switchCashbookTab(view) {
    cashbookView = view;
    ['all', 'receipts', 'payments'].forEach(v => {
      const btn = document.getElementById('cashbookTab' + v.charAt(0).toUpperCase() + v.slice(1));
      if (btn) btn.classList.toggle('active', v === view);
    });
    renderCashbook();
  }
  window.switchCashbookTab = switchCashbookTab;

  function renderCashbook(){
    const tbody = document.getElementById('cashbookTableBody');
    if(!tbody) return;
    const b = findBiz(selectedBizId);
    if(!b){ tbody.innerHTML = '<tr><td colspan="5">Select a business</td></tr>'; return; }
    
    // Get opening balance from Bank account
    const bankAcct = b.accounts.find(a => a.name === 'Bank');
    let balance = Number((bankAcct && bankAcct.openingBalance) || 0);
    
    const arr = ((state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [])
      .slice().sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    
    const rows = [];
    // Opening balance row
    rows.push({ date: '', desc: 'Opening Balance', receipts: 0, payments: 0, balance: balance, isOpening: true });
    
    for(const t of arr){
      const action = t.action || '';
      const amount = Number(t.amount || 0);
      let receipts = 0, payments = 0;
      
      // Exclude COGS auto-generated transactions from cashbook (P&L only)
      if(t.isCOGS) continue;
      // Exclude cashbook counterparty leg entries (P&L/ledger only, not cash movement)
      if(t.isCashbookCounterparty) continue;
      
      // Compute gross amount including VAT for exclusive transactions
      const vatAmt = (t.vatType === 'exclusive') ? computeVAT(amount, t.vatType, b.vatRate) : 0;
      const grossAmt = amount + vatAmt;
      
      if(action === 'Revenue' || action === 'Investment Income'){
        receipts = grossAmt;
      } else if(action === 'Expense'){
        // Only record cash payments - unpaid/part transactions reduce payment by outstanding
        if(t.paymentStatus === 'Unpaid') continue;
        payments = t.paymentStatus === 'Part' ? Number(t.partAmount || 0) : grossAmt;
      } else if(action === 'InventoryPurchase'){
        if(t.paymentStatus === 'Unpaid') continue;
        payments = t.paymentStatus === 'Part' ? Number(t.partAmount || 0) : grossAmt;
      } else if(action === 'InventorySale'){
        receipts = grossAmt;
      } else if(action === 'AssetPurchase' || action === 'OpeningAssetBal'){
        if(t.paymentStatus === 'Unpaid') continue;
        payments = t.paymentStatus === 'Part' ? Number(t.partAmount || 0) : amount;
      } else if(action === 'AssetDisposal'){
        receipts = amount;
      } else if(action === 'Tax Payment' || t.isTaxPayment){
        // Tax payments: Dr tax liability, Cr bank (cash outflow)
        payments = amount;
      } else if(t.cashbookReceipts || t.cashbookPayments){
        // Manual cashbook entries
        receipts = Number(t.cashbookReceipts || 0);
        payments = Number(t.cashbookPayments || 0);
      } else {
        continue;
      }
      balance += receipts - payments;
      rows.push({ date: t.date||'', desc: t.description||t.action||'', receipts, payments, balance });
    }
    
    // Filter rows based on cashbook view
    const view = cashbookView || 'all';
    const filtered = rows.filter(row => {
      if (row.isOpening) return true; // always show opening balance
      if (view === 'receipts') return row.receipts > 0;
      if (view === 'payments') return row.payments > 0;
      return true;
    });

    // For receipts/payments views, recalculate running balance
    if (view !== 'all') {
      let runBal = Number((bankAcct && bankAcct.openingBalance) || 0);
      for (const row of filtered) {
        if (row.isOpening) { row.balance = runBal; continue; }
        runBal += row.receipts - row.payments;
        row.balance = runBal;
      }
    }
    
    tbody.innerHTML = '';
    for(const row of filtered){
      const tr = document.createElement('tr');
      if(row.isOpening) tr.style.fontWeight='bold';
      tr.innerHTML = `<td>${escapeHtml(row.date)}</td><td>${escapeHtml(row.desc)}</td>` +
        `<td style="text-align:right;">${row.receipts ? fmt(row.receipts) : ''}</td>` +
        `<td style="text-align:right;">${row.payments ? fmt(row.payments) : ''}</td>` +
        `<td style="text-align:right;">${fmt(row.balance)}</td>`;
      tbody.appendChild(tr);
    }
  }

  function renderInvoices(){
    // Invoicing has been removed - this function is a no-op
    return;

    
    if(!selectedUserId || !selectedBizId) {
      invoiceTableBody.innerHTML = '<tr><td colspan="9">Please select a business</td></tr>';
      return;
    }
    
    const key = `${selectedUserId}_${selectedBizId}`;
    const invoices = state.invoices[key] || [];
    const filterStatus = invoiceStatusFilter.value;
    
    invoiceTableBody.innerHTML = '';
    
    const filtered = invoices.filter(inv => {
      if(filterStatus === 'all') return true;
      return inv.status === filterStatus;
    });
    
    if(filtered.length === 0){
      invoiceTableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No invoices found</td></tr>';
      return;
    }
    
    for(const inv of filtered){
      const tr = document.createElement('tr');
      
      const tdNum = document.createElement('td');
      tdNum.textContent = inv.invoiceNumber;
      
      const tdDate = document.createElement('td');
      tdDate.textContent = inv.date;
      
      const tdCustomer = document.createElement('td');
      tdCustomer.textContent = inv.customerName;
      
      const tdAmount = document.createElement('td');
      tdAmount.textContent = fmt(inv.subtotal);
      
      const tdVat = document.createElement('td');
      tdVat.textContent = fmt(inv.vatAmount);
      
      const tdTotal = document.createElement('td');
      tdTotal.textContent = fmt(inv.total);
      
      const tdStatus = document.createElement('td');
      const statusSpan = document.createElement('span');
      statusSpan.textContent = inv.status.charAt(0).toUpperCase() + inv.status.slice(1);
      statusSpan.style.padding = '4px 8px';
      statusSpan.style.borderRadius = '4px';
      statusSpan.style.fontSize = '0.85rem';
      if(inv.status === 'paid'){
        statusSpan.style.background = '#e6f4ea';
        statusSpan.style.color = '#1e7e34';
      } else if(inv.status === 'overdue'){
        statusSpan.style.background = '#fee';
        statusSpan.style.color = '#c00';
      } else {
        statusSpan.style.background = '#fff3cd';
        statusSpan.style.color = '#856404';
      }
      tdStatus.appendChild(statusSpan);
      
      const tdDue = document.createElement('td');
      tdDue.textContent = inv.dueDate;
      
      const tdActions = document.createElement('td');
      const actionsDiv = document.createElement('div');
      actionsDiv.style.display = 'flex';
      actionsDiv.style.gap = '4px';
      
      const viewBtn = document.createElement('button');
      viewBtn.textContent = 'View';
      viewBtn.className = 'small';
      viewBtn.addEventListener('click', () => viewInvoice(inv));
      
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edit';
      editBtn.className = 'small';
      editBtn.addEventListener('click', () => openEditInvoice(inv));
      
      const paidBtn = document.createElement('button');
      paidBtn.textContent = inv.status === 'paid' ? 'Unpaid' : 'Paid';
      paidBtn.className = 'small primary';
      paidBtn.addEventListener('click', () => toggleInvoiceStatus(inv));
      
      const pdfBtn = document.createElement('button');
      pdfBtn.textContent = 'PDF';
      pdfBtn.className = 'small';
      pdfBtn.addEventListener('click', () => exportInvoicePDF(inv));
      
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.className = 'small danger';
      delBtn.addEventListener('click', () => deleteInvoice(inv.id));
      
      actionsDiv.appendChild(viewBtn);
      actionsDiv.appendChild(editBtn);
      actionsDiv.appendChild(paidBtn);
      actionsDiv.appendChild(pdfBtn);
      actionsDiv.appendChild(delBtn);
      tdActions.appendChild(actionsDiv);
      
      tr.appendChild(tdNum);
      tr.appendChild(tdDate);
      tr.appendChild(tdCustomer);
      tr.appendChild(tdAmount);
      tr.appendChild(tdVat);
      tr.appendChild(tdTotal);
      tr.appendChild(tdStatus);
      tr.appendChild(tdDue);
      tr.appendChild(tdActions);
      
      invoiceTableBody.appendChild(tr);
    }
  }

  function generateInvoiceNumber(){
    const key = `${selectedUserId}_${selectedBizId}`;
    const invoices = state.invoices[key] || [];
    const num = invoices.length + 1;
    return `INV-${Date.now().toString(36).toUpperCase()}-${num.toString().padStart(4, '0')}`;
  }

  function openCreateInvoice(){
    if(!selectedUserId || !selectedBizId) return alert('Please select a business first');
    editingInvoice = null;
    invoiceModalTitle.textContent = 'Create Invoice';
    invoiceNumber.value = generateInvoiceNumber();
    invoiceDate.value = today();
    
    // Calculate due date based on payment terms (default Net 30)
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    invoiceDueDate.value = dueDate.toISOString().slice(0,10);
    
    invoiceCustomerName.value = '';
    invoiceCustomerEmail.value = '';
    invoiceCustomerPhone.value = '';
    invoiceCustomerAddress.value = '';
    invoiceVatType.value = 'none';
    invoicePaymentTerms.value = 'net30';
    
    // Reset items with inventory dropdown
    invoiceItems.innerHTML = createInvoiceItemRow();
    
    updateInvoiceTotal();
    modalOverlay.style.display = 'block';
    invoiceModal.style.display = 'block';
  }

  function createInvoiceItemRow(item = null) {
    const b = findBiz(selectedBizId);
    const inventory = (b && b.inventory) ? b.inventory : [];
    
    // Build inventory options â€“ show name, available qty, and avg cost
    let inventoryOptions = '<option value="">-- Select from Inventory or Enter Custom --</option>';
    for(const invItem of inventory) {
      const selected = item && item.inventoryId === invItem.id ? 'selected' : '';
      const avgCost = Number(invItem.avgCost ?? invItem.averageCost ?? 0);
      inventoryOptions += `<option value="${invItem.id}" ${selected}>${invItem.name} (Qty: ${invItem.qty ?? 0} | â‚¦${avgCost.toFixed(2)})</option>`;
    }
    
    return `
      <div class="invoice-item" style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
        <select class="invoice-item-inventory" style="flex:1;" onchange="handleInventorySelection(this)">
          ${inventoryOptions}
        </select>
        <input type="text" placeholder="Item description" class="invoice-item-desc" style="flex:2;" value="${item?.description || ''}" />
        <input type="number" placeholder="Qty" min="1" step="1" value="${item?.qty || 1}" class="invoice-item-qty" style="width:70px;" />
        <input type="number" placeholder="Unit price" min="0" step="0.01" value="${item?.price || ''}" class="invoice-item-price" style="width:120px;" />
        <button type="button" class="small danger invoice-item-remove">Ã—</button>
      </div>
    `;
  }
  
  function handleInventorySelection(selectElement) {
    const itemRow = selectElement.closest('.invoice-item');
    const descInput = itemRow.querySelector('.invoice-item-desc');
    const priceInput = itemRow.querySelector('.invoice-item-price');
    
    const inventoryId = selectElement.value;
    if(!inventoryId) return;
    
    const b = findBiz(selectedBizId);
    const inventoryItem = b?.inventory?.find(i => i.id === inventoryId);
    
    if(inventoryItem) {
      descInput.value = inventoryItem.name;
      // Use avgCost (primary) or averageCost (legacy) â€“ whichever is populated
      priceInput.value = inventoryItem.avgCost || inventoryItem.averageCost || 0;
      // Store inventory ID on the row for reference
      itemRow.dataset.inventoryId = inventoryId;
    }
    
    updateInvoiceTotal();
  }
  
  // Make handleInventorySelection available globally
  window.handleInventorySelection = handleInventorySelection;

  function openEditInvoice(inv){
    editingInvoice = inv;
    invoiceModalTitle.textContent = 'Edit Invoice';
    invoiceNumber.value = inv.invoiceNumber;
    invoiceDate.value = inv.date;
    invoiceDueDate.value = inv.dueDate;
    invoiceCustomerName.value = inv.customerName;
    invoiceCustomerEmail.value = inv.customerEmail || '';
    invoiceCustomerPhone.value = inv.customerPhone || '';
    invoiceCustomerAddress.value = inv.customerAddress || '';
    invoiceVatType.value = inv.vatType;
    invoicePaymentTerms.value = inv.paymentTerms;
    
    // Populate items with inventory dropdown
    invoiceItems.innerHTML = '';
    for(const item of inv.items){
      invoiceItems.innerHTML += createInvoiceItemRow(item);
    }
    
    updateInvoiceTotal();
    modalOverlay.style.display = 'block';
    invoiceModal.style.display = 'block';
  }

  function updateInvoiceTotal(){
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    let subtotal = 0;
    const items = invoiceItems.querySelectorAll('.invoice-item');
    items.forEach(item => {
      const qty = Number(item.querySelector('.invoice-item-qty').value) || 0;
      const price = Number(item.querySelector('.invoice-item-price').value) || 0;
      subtotal += qty * price;
    });
    
    let vatAmount = 0;
    const vatType = invoiceVatType.value;
    if(vatType !== 'none'){
      vatAmount = computeVAT(subtotal, vatType, b.vatRate);
    }
    
    const total = subtotal + vatAmount;
    
    invoiceSubtotal.textContent = fmt(subtotal);
    invoiceVatAmount.textContent = fmt(vatAmount);
    invoiceTotal.textContent = fmt(total);
  }

  function saveInvoice(){
    if(!selectedUserId || !selectedBizId) return alert('Please select a business');
    
    const b = findBiz(selectedBizId);
    if(!b) return alert('Business not found');
    
    // Validate
    if(!invoiceDate.value) return alert('Please enter invoice date');
    if(!invoiceDueDate.value) return alert('Please enter due date');
    if(!invoiceCustomerName.value.trim()) return alert('Please enter customer name');
    
    // Collect items
    const items = [];
    const itemDivs = invoiceItems.querySelectorAll('.invoice-item');
    if(itemDivs.length === 0) return alert('Please add at least one item');
    
    for(const itemDiv of itemDivs){
      const desc = itemDiv.querySelector('.invoice-item-desc').value.trim();
      const qty = Number(itemDiv.querySelector('.invoice-item-qty').value) || 0;
      const price = Number(itemDiv.querySelector('.invoice-item-price').value) || 0;
      
      if(!desc) return alert('Please enter item description');
      if(qty <= 0) return alert('Quantity must be greater than 0');
      if(price < 0) return alert('Price cannot be negative');
      
      items.push({ description: desc, qty, price });
    }
    
    // Calculate totals
    let subtotal = 0;
    items.forEach(item => {
      subtotal += item.qty * item.price;
    });
    
    let vatAmount = 0;
    const vatType = invoiceVatType.value;
    if(vatType !== 'none'){
      vatAmount = computeVAT(subtotal, vatType, b.vatRate);
    }
    
    const total = subtotal + vatAmount;
    
    // Get payment amount if provided
    const invoicePaymentAmount = document.getElementById('invoicePaymentAmount');
    const paymentAmount = Number(invoicePaymentAmount?.value || 0);
    
    // Validate payment amount
    if(paymentAmount < 0) return alert('Please enter a positive payment amount');
    if(paymentAmount > total) return alert(`Payment amount (${fmt(paymentAmount)}) cannot exceed invoice total (${fmt(total)})`);
    
    // Determine status based on payment
    let status = 'unpaid';
    if(paymentAmount > 0){
      if(paymentAmount >= total){
        status = 'paid';
      } else {
        status = 'partial'; // Partially paid
      }
    } else {
      // No payment - check if overdue
      const dueDate = new Date(invoiceDueDate.value);
      const now = new Date();
      if(dueDate < now){
        status = 'overdue';
      }
    }
    
    const key = `${selectedUserId}_${selectedBizId}`;
    if(!state.invoices[key]) state.invoices[key] = [];
    
    if(editingInvoice){
      // Update existing invoice
      const idx = state.invoices[key].findIndex(inv => inv.id === editingInvoice.id);
      if(idx !== -1){
        state.invoices[key][idx] = {
          ...state.invoices[key][idx],
          date: invoiceDate.value,
          dueDate: invoiceDueDate.value,
          customerName: invoiceCustomerName.value.trim(),
          customerEmail: invoiceCustomerEmail.value.trim(),
          customerPhone: invoiceCustomerPhone.value.trim(),
          customerAddress: invoiceCustomerAddress.value.trim(),
          items,
          vatType,
          paymentTerms: invoicePaymentTerms.value,
          subtotal,
          vatAmount,
          total,
          paymentAmount: paymentAmount,
          paymentHistory: state.invoices[key][idx].paymentHistory || [],
          status: editingInvoice.status === 'paid' ? 'paid' : status
        };
        
        // Track payment if amount changed
        if(paymentAmount > 0 && paymentAmount !== editingInvoice.paymentAmount) {
          state.invoices[key][idx].paymentHistory.push({
            date: new Date().toISOString().split('T')[0],
            amount: paymentAmount,
            previousAmount: editingInvoice.paymentAmount || 0
          });
        }
        
        addAudit('invoice.edit', 'invoice', editingInvoice.id, 'Invoice updated');
      }
    } else {
      // Create new invoice
      const invoice = {
        id: uid('inv'),
        invoiceNumber: invoiceNumber.value,
        date: invoiceDate.value,
        dueDate: invoiceDueDate.value,
        customerName: invoiceCustomerName.value.trim(),
        customerEmail: invoiceCustomerEmail.value.trim(),
        customerPhone: invoiceCustomerPhone.value.trim(),
        customerAddress: invoiceCustomerAddress.value.trim(),
        items,
        vatType,
        paymentTerms: invoicePaymentTerms.value,
        subtotal,
        vatAmount,
        total,
        paymentAmount: paymentAmount,
        paymentHistory: paymentAmount > 0 ? [{
          date: new Date().toISOString().split('T')[0],
          amount: paymentAmount,
          previousAmount: 0
        }] : [],
        status
      };
      
      state.invoices[key].push(invoice);
      addAudit('invoice.create', 'invoice', invoice.id, 'Invoice created: ' + invoice.invoiceNumber);
      
      // Automatically create an Invoicing ledger entry
      createInvoicingLedgerEntry(invoice);
    }
    
    saveState();
    closeInvoiceModal();
    renderInvoices();
  }

  function closeInvoiceModal(){
    modalOverlay.style.display = 'none';
    invoiceModal.style.display = 'none';
    editingInvoice = null;
  }

  function createInvoicingLedgerEntry(inv){
    // Create an Invoicing transaction when invoice is created
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    // Find or create Receivable account
    let arAccount = b.accounts.find(a => a.name === 'Receivable' || a.name === 'Accounts Receivable');
    if(!arAccount){
      arAccount = { id: uid('acc'), name: 'Receivable', category: 'Asset' };
      b.accounts.push(arAccount);
    }
    
    const txn = {
      id: uid('txn'),
      date: inv.date,
      action: 'Invoicing',
      accountId: arAccount.id,
      accountName: 'Receivable',
      accountCategory: 'Asset',
      description: `Invoice ${inv.invoiceNumber} - ${inv.customerName}`,
      amount: inv.subtotal,
      vatType: inv.vatType,
      whtApplied: false,
      paye: false,
      contact: inv.customerName,
      adjustmentType: '',
      adjustmentAmount: 0,
      invoiceId: inv.id
    };
    
    const key = `${selectedUserId}_${selectedBizId}`;
    if(!state.transactions[selectedUserId]) state.transactions[selectedUserId] = {};
    if(!state.transactions[selectedUserId][selectedBizId]) state.transactions[selectedUserId][selectedBizId] = [];
    
    state.transactions[selectedUserId][selectedBizId].push(txn);
    addAudit('txn.add', 'txn', txn.id, `Invoicing transaction created for invoice ${inv.invoiceNumber}`);
  }

  function viewInvoice(inv){
    const html = `
      <div style="max-width:800px; margin:auto; padding:20px; background:#fff; border:1px solid #ddd;">
        <h2 style="text-align:center; margin-bottom:20px;">INVOICE</h2>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
          <div>
            <strong>Invoice #:</strong> ${inv.invoiceNumber}<br/>
            <strong>Date:</strong> ${inv.date}<br/>
            <strong>Due Date:</strong> ${inv.dueDate}<br/>
            <strong>Status:</strong> ${inv.status.toUpperCase()}
          </div>
          <div>
            <strong>Bill To:</strong><br/>
            ${inv.customerName}<br/>
            ${inv.customerEmail ? inv.customerEmail + '<br/>' : ''}
            ${inv.customerPhone ? inv.customerPhone + '<br/>' : ''}
            ${inv.customerAddress ? inv.customerAddress : ''}
          </div>
        </div>
        
        <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
          <thead>
            <tr style="background:#f2f6fa;">
              <th style="border:1px solid #ddd; padding:8px; text-align:left;">Item</th>
              <th style="border:1px solid #ddd; padding:8px; text-align:right;">Qty</th>
              <th style="border:1px solid #ddd; padding:8px; text-align:right;">Unit Price</th>
              <th style="border:1px solid #ddd; padding:8px; text-align:right;">Total</th>
            </tr>
          </thead>
          <tbody>
            ${inv.items.map(item => `
              <tr>
                <td style="border:1px solid #ddd; padding:8px;">${item.description}</td>
                <td style="border:1px solid #ddd; padding:8px; text-align:right;">${item.qty}</td>
                <td style="border:1px solid #ddd; padding:8px; text-align:right;">${fmt(item.price)}</td>
                <td style="border:1px solid #ddd; padding:8px; text-align:right;">${fmt(item.qty * item.price)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        
        <div style="text-align:right; margin-bottom:20px;">
          <div style="margin-bottom:4px;"><strong>Subtotal:</strong> ${fmt(inv.subtotal)}</div>
          <div style="margin-bottom:4px;"><strong>VAT:</strong> ${fmt(inv.vatAmount)}</div>
          <div style="font-size:1.2rem; font-weight:700;"><strong>Total:</strong> ${fmt(inv.total)}</div>
        </div>
        
        <div style="text-align:center; margin-top:30px; color:#666; font-size:0.9rem;">
          Payment Terms: ${inv.paymentTerms.replace('net', 'Net ')}
        </div>
      </div>
    `;
    
    const w = window.open('', '_blank');
    w.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Invoice ${inv.invoiceNumber}</title>
        <style>body { font-family: system-ui, sans-serif; padding:20px; }</style>
      </head>
      <body>${html}</body>
      </html>
    `);
  }

  function toggleInvoiceStatus(inv){
    const key = `${selectedUserId}_${selectedBizId}`;
    const idx = state.invoices[key].findIndex(i => i.id === inv.id);
    if(idx === -1) return;
    
    if(inv.status === 'paid'){
      // Determine if it's overdue or unpaid
      const dueDate = new Date(inv.dueDate);
      const now = new Date();
      state.invoices[key][idx].status = dueDate < now ? 'overdue' : 'unpaid';
    } else {
      state.invoices[key][idx].status = 'paid';
      
      // Create a revenue transaction when marked as paid
      createInvoiceTransaction(inv);
    }
    
    addAudit('invoice.status', 'invoice', inv.id, `Status changed to ${state.invoices[key][idx].status}`);
    saveState();
    renderInvoices();
  }

  function createInvoiceTransaction(inv){
    // Create a Revenue transaction when invoice is marked as paid
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    // Find or create Sales Revenue account
    let salesAccount = b.accounts.find(a => a.name === 'Sales Revenue');
    if(!salesAccount){
      salesAccount = { id: uid('acc'), name: 'Sales Revenue', category: 'Revenue' };
      b.accounts.push(salesAccount);
    }
    
    // Check if invoice has WHT applied (can be configured on invoice or business level)
    const whtApplied = inv.whtApplied || false;
    const whtRate = inv.whtRate || b.whtRate || 0;
    
    const txn = {
      id: uid('txn'),
      date: new Date().toISOString().slice(0, 10), // Payment date is today
      action: 'Revenue',
      accountId: salesAccount.id,
      accountName: 'Sales Revenue',
      accountCategory: 'Revenue',
      description: `Payment for Invoice ${inv.invoiceNumber} - ${inv.customerName}`,
      amount: inv.subtotal,
      vatType: inv.vatType || 'none',
      whtApplied: whtApplied,
      whtRate: whtRate,
      whtBasis: inv.whtBasis || 'gross',
      paye: false,
      contact: inv.customerName,
      adjustmentType: '',
      adjustmentAmount: 0,
      invoiceId: inv.id
    };
    
    const key = `${selectedUserId}_${selectedBizId}`;
    if(!state.transactions[selectedUserId]) state.transactions[selectedUserId] = {};
    if(!state.transactions[selectedUserId][selectedBizId]) state.transactions[selectedUserId][selectedBizId] = [];
    
    state.transactions[selectedUserId][selectedBizId].push(txn);
    addAudit('txn.add', 'txn', txn.id, `Revenue transaction created from invoice ${inv.invoiceNumber} payment`);
  }

  function deleteInvoice(id){
    if(!confirm('Delete this invoice?')) return;
    
    const key = `${selectedUserId}_${selectedBizId}`;
    const idx = state.invoices[key].findIndex(inv => inv.id === id);
    if(idx !== -1){
      state.invoices[key].splice(idx, 1);
      addAudit('invoice.delete', 'invoice', id, 'Invoice deleted');
      saveState();
      renderInvoices();
    }
  }

  function exportInvoicePDF(inv){
    // Check if jsPDF is loaded
    if(typeof jspdf === 'undefined' || !jspdf.jsPDF){
      alert('jsPDF library not loaded. PDF export is not available.');
      return;
    }
    
    const { jsPDF } = jspdf;
    const doc = new jsPDF();
    
    // Title
    doc.setFontSize(20);
    doc.text('INVOICE', 105, 20, { align: 'center' });
    
    // Invoice details
    doc.setFontSize(10);
    doc.text(`Invoice #: ${inv.invoiceNumber}`, 20, 40);
    doc.text(`Date: ${inv.date}`, 20, 46);
    doc.text(`Due Date: ${inv.dueDate}`, 20, 52);
    doc.text(`Status: ${inv.status.toUpperCase()}`, 20, 58);
    
    // Customer details
    doc.text('Bill To:', 120, 40);
    doc.text(inv.customerName, 120, 46);
    if(inv.customerEmail) doc.text(inv.customerEmail, 120, 52);
    if(inv.customerPhone) doc.text(inv.customerPhone, 120, 58);
    
    // Items table
    let y = 75;
    doc.setFontSize(10);
    doc.text('Item', 20, y);
    doc.text('Qty', 110, y, { align: 'right' });
    doc.text('Unit Price', 140, y, { align: 'right' });
    doc.text('Total', 180, y, { align: 'right' });
    
    y += 6;
    doc.line(20, y, 190, y);
    y += 6;
    
    doc.setFontSize(9);
    for(const item of inv.items){
      doc.text(item.description.substring(0, 40), 20, y);
      doc.text(item.qty.toString(), 110, y, { align: 'right' });
      doc.text(rawFmt(item.price), 140, y, { align: 'right' });
      doc.text(rawFmt(item.qty * item.price), 180, y, { align: 'right' });
      y += 6;
    }
    
    y += 6;
    doc.line(20, y, 190, y);
    
    // Totals
    y += 8;
    doc.setFontSize(10);
    doc.text('Subtotal:', 140, y);
    doc.text(rawFmt(inv.subtotal), 180, y, { align: 'right' });
    
    y += 6;
    doc.text('VAT:', 140, y);
    doc.text(rawFmt(inv.vatAmount), 180, y, { align: 'right' });
    
    y += 8;
    doc.setFontSize(12);
    doc.text('Total:', 140, y);
    doc.text(rawFmt(inv.total), 180, y, { align: 'right' });
    
    // Payment terms
    y += 12;
    doc.setFontSize(9);
    doc.text(`Payment Terms: ${inv.paymentTerms.replace('net', 'Net ')}`, 105, y, { align: 'center' });
    
    // Save
    doc.save(`invoice_${inv.invoiceNumber}.pdf`);
  }

  // ============== CASHBOOK FUNCTIONALITY ==============
  let editingCashEntry = null;














  
  // ============== STARTING BALANCE FUNCTIONALITY ==============
  

  

  

  


  /***********************************************************************
   * BANK RECONCILIATION FUNCTIONS
   ***********************************************************************/
  
  let currentReconciliation = null;
  let currentReconciliationId = null;
  let selectedBankItem = null;
  

  

  

  

  

  

  

  

  

  
  

  

  

  

  

  

  

  

  

  

  


  // Continue with more bank reconciliation functions in next edit...

  // Function to update tax field visibility based on active tab
  function updateTaxFieldsVisibility() {
    const showTaxFields = (activeTab === 'ledger');
    
    // Tax-related form elements
    const vatLabel = document.getElementById('txnVatLabel');
    const whtLabel = document.getElementById('txnWhtLabel');
    const whtBasisLabel = document.getElementById('txnWhtBasisLabel');
    const whtRateLabel = document.getElementById('txnWhtRateLabel');
    const payeLabel = document.getElementById('txnPayeLabel');
    const adjustmentLabel = document.getElementById('txnAdjustmentLabel');
    const adjustmentAmountLabel = document.getElementById('txnAdjustmentAmountLabel');
    
    // Set display for tax fields
    if (vatLabel) vatLabel.style.display = showTaxFields ? '' : 'none';
    if (whtLabel) whtLabel.style.display = showTaxFields ? '' : 'none';
    // WHT basis and rate are conditionally shown based on WHT checkbox, only hide if not showing tax fields
    if (whtBasisLabel) {
      if (!showTaxFields) {
        whtBasisLabel.style.display = 'none';
      }
      // When showing tax fields, leave the display as-is (controlled by WHT checkbox logic)
    }
    if (whtRateLabel) {
      if (!showTaxFields) {
        whtRateLabel.style.display = 'none';
      }
      // When showing tax fields, leave the display as-is (controlled by WHT checkbox logic)
    }
    if (payeLabel) payeLabel.style.display = showTaxFields ? '' : 'none';
    if (adjustmentLabel) adjustmentLabel.style.display = showTaxFields ? '' : 'none';
    // Adjustment amount is conditionally shown based on adjustment type, only hide if not showing tax fields
    if (adjustmentAmountLabel) {
      if (!showTaxFields) {
        adjustmentAmountLabel.style.display = 'none';
      }
      // When showing tax fields, leave the display as-is (controlled by adjustment type logic)
    }
    
    // Tax Income/Tax Payment options have been removed from the action dropdown
    // No further filtering needed here.
  }

  // Reports rendering
  function renderTab(){
    // Hide all sections first
    if(dashboardSection) dashboardSection.style.display = 'none';
    ledgerSection.style.display = 'none';
    reportsSection.style.display = 'none';
    if(ledgerListSection) ledgerListSection.style.display = 'none';
    const cashbookSection = document.getElementById('cashbookSection'); if(cashbookSection) cashbookSection.style.display = 'none';
    
    // Hide enterprise feature sections
    const bankReconciliationSection = document.getElementById('bankReconciliationSection');
    const journalEntrySection = document.getElementById('journalEntrySection');
    const payablesSection = document.getElementById('payablesSection');
    if(bankReconciliationSection) bankReconciliationSection.style.display = 'none';
    if(journalEntrySection) journalEntrySection.style.display = 'none';
    if(payablesSection) payablesSection.style.display = 'none';
    
    // Remove active class from all tabs
    if(btnDashboardTab) btnDashboardTab.classList.remove('active');
    btnLedgerTab.classList.remove('active');
    if(btnCashbookTab) btnCashbookTab.classList.remove('active');
    btnReportsTab.classList.remove('active');
    
    const btnBankReconciliationTab = document.getElementById('btnBankReconciliationTab');
    const btnJournalEntryTab = document.getElementById('btnJournalEntryTab');
    const btnPayablesTab = document.getElementById('btnPayablesTab');
    if(btnBankReconciliationTab) btnBankReconciliationTab.classList.remove('active');
    if(btnJournalEntryTab) btnJournalEntryTab.classList.remove('active');
    if(btnPayablesTab) btnPayablesTab.classList.remove('active');
    
    if(activeTab === 'dashboard'){
      if(dashboardSection){
        dashboardSection.style.display = 'block';
        if(btnDashboardTab) btnDashboardTab.classList.add('active');
        renderDashboard();
      }
    } else if(activeTab === 'ledger'){
      ledgerSection.style.display = 'block';
      if(ledgerListSection) ledgerListSection.style.display = 'block';
      btnLedgerTab.classList.add('active');
      renderAll();
    } else if(activeTab === 'cashbook'){
      if(cashbookSection) { cashbookSection.style.display = 'block'; }
      if(btnCashbookTab) btnCashbookTab.classList.add('active');
      renderCashbook();
    } else if(activeTab === 'reports'){
      reportsSection.style.display = 'block';
      btnReportsTab.classList.add('active');
      updateReportTabVisibility();
      document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
      const tb = document.querySelector('#reportsSection .tab[data-report="vatReport"]');
      if(tb) tb.classList.add('active');
      renderReport('vatReport');
    } else if(activeTab === 'bankReconciliation'){
      if(bankReconciliationSection){
        bankReconciliationSection.style.display = 'block';
        if(btnBankReconciliationTab) btnBankReconciliationTab.classList.add('active');
      }
    } else if(activeTab === 'journalEntry'){
      if(journalEntrySection){
        journalEntrySection.style.display = 'block';
        if(btnJournalEntryTab) btnJournalEntryTab.classList.add('active');
      }
    } else if(activeTab === 'payables'){
      if(payablesSection){
        payablesSection.style.display = 'block';
        if(btnPayablesTab) btnPayablesTab.classList.add('active');
      }
    }
    
    // Update tax field visibility based on active tab
    updateTaxFieldsVisibility();
  }

  function renderDashboard(){
    const b = findBiz(selectedBizId);
    if(!b){
      document.getElementById('dashboardBusinessInfo').innerHTML = '<div class="muted">Select a business to view dashboard</div>';
      return;
    }
    
    // Snapshot Summary - Revenue, Expenses, and Profit - Calculate first to get turnover
    const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
    let revenue = 0, expenses = 0;
    
    for(const t of arr){
      const acct = findAccount(b, t.accountId);
      const accountName = acct?.name || t.accountName || '';
      const isTaxPayment = TAX_PAYMENT_ACCOUNTS.includes(accountName);
      
      // Exclude tax payments from revenue/expenses
      if (!isTaxPayment) {
        if(t.accountCategory === 'Revenue') revenue += Number(t.amount || 0);
        if(t.accountCategory === 'Expense') expenses += Number(t.amount || 0);
      }
    }
    
    // Business Info
    // Calculate turnover for CIT determination
    const turnover = revenue;
    let businessInfo = `
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">Business Name:</span>
        <span class="dashboard-metric-value">${escapeHtml(b.name)}</span>
      </div>
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">VAT Rate:</span>
        <span class="dashboard-metric-value">${b.vatRate}%</span>
      </div>
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">WHT Rate:</span>
        <span class="dashboard-metric-value">${b.whtRate}%</span>
      </div>
    `;
    
    // Add CIT info based on entity type
    if (b.entity === 'Company' && turnover > 100000000) {
      businessInfo += `
        <div class="dashboard-metric">
          <span class="dashboard-metric-label">CIT:</span>
          <span class="dashboard-metric-value">30% (Turnover > â‚¦100M)</span>
        </div>
      `;
    } else if (b.entity === 'Business') {
      // Show CIT Rate as "0/30%" for Business entity
      businessInfo += `
        <div class="dashboard-metric">
          <span class="dashboard-metric-label">CIT Rate:</span>
          <span class="dashboard-metric-value">0/30%</span>
        </div>
      `;
    }
    
    // Add PIT/PAYE info for all entities
    businessInfo += `
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">PIT/PAYE:</span>
        <span class="dashboard-metric-value">0 to 25%</span>
      </div>
    `;
    
    document.getElementById('dashboardBusinessInfo').innerHTML = businessInfo;
    
    // Add depreciation to expenses
    const depreciation = computeTotalDepreciation();
    expenses += depreciation;
    
    const profit = revenue - expenses;
    
    let snapshotSummary = `
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">Revenue:</span>
        <span class="dashboard-metric-value" style="color:#059669;">${fmt(revenue)}</span>
      </div>
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">Expenses:</span>
        <span class="dashboard-metric-value" style="color:#dc2626;">${fmt(expenses)}</span>
      </div>
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">Profit:</span>
        <span class="dashboard-metric-value" style="color:${profit >= 0 ? '#0b76d1' : '#dc2626'};">${fmt(profit)}</span>
      </div>
    `;
    document.getElementById('dashboardSnapshotSummary').innerHTML = snapshotSummary;
    
    // Tax Summary - reuse arr from above
    let totalVATCollected = 0;
    let totalVATPaid = 0;
    let totalWHT = 0;
    let totalPAYE = 0;
    
    for(const t of arr){
      if(t.vatType && t.vatType !== 'none'){
        const vat = computeVAT(Number(t.amount||0), t.vatType, b.vatRate);
        if(t.accountCategory === 'Revenue'){
          totalVATCollected += vat;
        } else if(t.accountCategory === 'Expense'){
          totalVATPaid += vat;
        }
      }
      if(t.whtAmount) totalWHT += Number(t.whtAmount);
      if(t.payeAmount) totalPAYE += Number(t.payeAmount);
    }
    
    const vatNet = totalVATCollected - totalVATPaid;
    
    // Calculate PIT for Business entity and CIT for Company entity
    let totalPIT = 0;
    let totalCIT = 0;
    
    if (b.entity === 'Business' && profit > 0) {
      // PIT calculation (simplified progressive tax up to 25%)
      // This is a simplified estimate based on profit
      const pitBase = profit - (b.lossBroughtForward || 0);
      if (pitBase > 0) {
        totalPIT = pitBase * 0.15; // Average estimate, actual is progressive 0-25%
      }
    } else if (b.entity === 'Company' && profit > 0) {
      // CIT calculation at 30% for turnover > 100M, otherwise lower rate
      const citBase = profit - (b.lossBroughtForward || 0) - (b.caCarryForward || 0);
      if (citBase > 0) {
        const citRate = turnover > 100000000 ? 0.30 : (b.citRate || 30) / 100;
        totalCIT = citBase * citRate;
      }
    }
    
    let taxSummary = `
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">VAT Collected:</span>
        <span class="dashboard-metric-value" style="color:#059669;">${fmt(totalVATCollected)}</span>
      </div>
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">VAT Paid:</span>
        <span class="dashboard-metric-value" style="color:#dc2626;">${fmt(totalVATPaid)}</span>
      </div>
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">Net VAT:</span>
        <span class="dashboard-metric-value" style="color:${vatNet >= 0 ? '#0b76d1' : '#dc2626'};">${fmt(vatNet)}</span>
      </div>
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">WHT:</span>
        <span class="dashboard-metric-value">${fmt(totalWHT)}</span>
      </div>
      <div class="dashboard-metric">
        <span class="dashboard-metric-label">PAYE:</span>
        <span class="dashboard-metric-value">${fmt(totalPAYE)}</span>
      </div>
    `;
    
    // Show PIT for Business entity
    if (b.entity === 'Business') {
      taxSummary += `
        <div class="dashboard-metric">
          <span class="dashboard-metric-label">PIT (est.):</span>
          <span class="dashboard-metric-value">${fmt(totalPIT)}</span>
        </div>
      `;
    }
    
    // Show CIT for Company entity
    if (b.entity === 'Company') {
      taxSummary += `
        <div class="dashboard-metric">
          <span class="dashboard-metric-label">CIT (est.):</span>
          <span class="dashboard-metric-value">${fmt(totalCIT)}</span>
        </div>
      `;
    }
    document.getElementById('dashboardTaxSummary').innerHTML = taxSummary;
    
    // Recent Transactions
    let recentTxns = '';
    const recent = arr.slice(-10).reverse();
    if(recent.length === 0){
      recentTxns = '<div class="muted">No transactions yet</div>';
    } else {
      recentTxns = '<table class="ledger-table"><thead><tr><th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th></tr></thead><tbody>';
      recent.forEach(t => {
        recentTxns += `<tr>
          <td>${t.date}</td>
          <td>${t.action}</td>
          <td>${t.accountName||'â€”'}</td>
          <td>${t.description||'â€”'}</td>
          <td>${fmt(t.amount)}</td>
        </tr>`;
      });
      recentTxns += '</tbody></table>';
    }
    document.getElementById('dashboardRecentTransactions').innerHTML = recentTxns;
  }

  function renderReportsTabState(){
    if(activeTab === 'reports') {
      ledgerSection.style.display = 'none';
      reportsSection.style.display = 'block';
    } else {
      ledgerSection.style.display = 'block';
      reportsSection.style.display = 'none';
    }
  }

  function renderReport(name){
    const b = findBiz(selectedBizId);
    if(!b) { reportContent.innerHTML = '<div>Select a business to view reports</div>'; return; }
    
    // Add audit for report generation
    addAudit('report.view', 'report', name, `Viewed report: ${name}`);
    
    if(name === 'vatReport'){
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      let html = `<h3>VAT Report</h3>`;
      
      // Summary section at the top
      let totalVATCollected = 0;
      let totalVATPaid = 0;
      
      // Calculate totals first
      for(const t of arr){
        if(t.vatType && t.vatType !== 'none'){
          const vat = computeVAT(Number(t.amount||0), t.vatType, b.vatRate);
          if(t.accountCategory === 'Revenue'){
            totalVATCollected += vat;
          } else if(t.accountCategory === 'Expense'){
            totalVATPaid += vat;
          }
        }
      }
      
      const vatNet = totalVATCollected - totalVATPaid;
      
      // Display summary
      html += `<div style="background:#f7f9fc;padding:12px;border-radius:6px;margin-bottom:16px;">`;
      html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">`;
      html += `<div><strong>VAT Collected:</strong><br/><span style="font-size:1.2rem;color:#059669;">${fmt(totalVATCollected)}</span></div>`;
      html += `<div><strong>VAT Paid:</strong><br/><span style="font-size:1.2rem;color:#dc2626;">${fmt(totalVATPaid)}</span></div>`;
      html += `<div><strong>Net VAT Flow:</strong><br/><span style="font-size:1.2rem;font-weight:700;color:${vatNet >= 0 ? '#0b76d1' : '#dc2626'};">${fmt(vatNet)}</span></div>`;
      html += `</div>`;
      html += `<div class="small-note" style="margin-top:8px;">${vatNet >= 0 ? 'VAT payable to tax authority' : 'VAT refund due'}</div>`;
      html += `</div>`;
      
      html += `<h4>Sales (VAT Collected)</h4>`;
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Description</th><th>Contact</th><th>Amount</th><th>VAT</th></tr></thead><tbody>`;
      totalVATCollected = 0; // Reset for detailed list
      for(const t of arr){
        if(t.vatType && t.vatType !== 'none' && t.accountCategory === 'Revenue'){
          const vat = computeVAT(Number(t.amount||0), t.vatType, b.vatRate);
          totalVATCollected += vat;
          html += `<tr><td>${t.date}</td><td>${t.description||''}</td><td>${t.contact||''}</td><td>${fmt(t.amount)}</td><td>${fmt(vat)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="4">Total VAT Collected</th><th>${fmt(totalVATCollected)}</th></tr></tfoot></table>`;
      
      html += `<h4 style="margin-top:16px;">Purchases (VAT Paid)</h4>`;
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Description</th><th>Contact</th><th>Amount</th><th>VAT</th></tr></thead><tbody>`;
      totalVATPaid = 0; // Reset for detailed list
      for(const t of arr){
        if(t.vatType && t.vatType !== 'none' && t.accountCategory === 'Expense'){
          const vat = computeVAT(Number(t.amount||0), t.vatType, b.vatRate);
          totalVATPaid += vat;
          html += `<tr><td>${t.date}</td><td>${t.description||''}</td><td>${t.contact||''}</td><td>${fmt(t.amount)}</td><td>${fmt(vat)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="4">Total VAT Paid</th><th>${fmt(totalVATPaid)}</th></tr></tfoot></table>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'whtPayable'){
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      let html = `<h3>WHT Payable Report</h3>`;
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Vendor</th><th>Description</th><th>Rate %</th><th>Gross</th><th>WHT Payable</th></tr></thead><tbody>`;
      let totalWHT = 0;
      for(const t of arr){
        if(t.whtApplied && t.accountCategory === 'Expense'){
          const rate = Number(t.whtRate || b.whtRate);
          const basis = t.whtBasis || 'gross';
          const wht = computeWHT(Number(t.amount||0), basis, rate);
          totalWHT += wht;
          html += `<tr><td>${t.date}</td><td>${t.contact||''}</td><td>${t.description||''}</td><td>${rate}</td><td>${fmt(t.amount)}</td><td>${fmt(wht)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="5">Total WHT Payable</th><th>${fmt(totalWHT)}</th></tr></tfoot></table>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'whtReceivable'){
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      let html = `<h3>WHT Receivable Report</h3>`;
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Contact</th><th>Description</th><th>Rate %</th><th>Gross</th><th>WHT Receivable</th></tr></thead><tbody>`;
      let totalWHT = 0;
      for(const t of arr){
        if(t.whtApplied && t.accountCategory === 'Revenue'){
          const rate = Number(t.whtRate || b.whtRate);
          const basis = t.whtBasis || 'gross';
          const wht = computeWHT(Number(t.amount||0), basis, rate);
          totalWHT += wht;
          html += `<tr><td>${t.date}</td><td>${t.contact||''}</td><td>${t.description||''}</td><td>${rate}</td><td>${fmt(t.amount)}</td><td>${fmt(wht)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="5">Total WHT Receivable</th><th>${fmt(totalWHT)}</th></tr></tfoot></table>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'whtReport'){
      // Unified WHT Report combining payable and receivable
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      let html = `<h3>WHT Report (Withholding Tax)</h3>`;
      
      // Calculate totals first
      let totalWHTCollected = 0; // WHT deducted from customers (payable to tax authority)
      let totalWHTSuffered = 0;  // WHT paid to suppliers (recoverable/credit)
      
      const whtCollectedByRate = {};
      const whtSufferedByRate = {};
      
      for(const t of arr){
        if(t.whtApplied){
          const rate = Number(t.whtRate || b.whtRate);
          const basis = t.whtBasis || 'gross';
          const wht = computeWHT(Number(t.amount||0), basis, rate);
          
          if(t.accountCategory === 'Revenue'){
            totalWHTCollected += wht;
            whtCollectedByRate[rate] = (whtCollectedByRate[rate] || 0) + wht;
          } else if(t.accountCategory === 'Expense'){
            totalWHTSuffered += wht;
            whtSufferedByRate[rate] = (whtSufferedByRate[rate] || 0) + wht;
          }
        }
      }
      
      const whtNet = totalWHTCollected - totalWHTSuffered;
      
      // Summary section
      html += `<div style="background:#f7f9fc;padding:12px;border-radius:6px;margin-bottom:16px;">`;
      html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">`;
      html += `<div><strong>WHT Collected:</strong><br/><span style="font-size:1.2rem;color:#059669;">${fmt(totalWHTCollected)}</span><br/><span class="small-muted">Deducted by customer</span></div>`;
      html += `<div><strong>WHT Suffered:</strong><br/><span style="font-size:1.2rem;color:#dc2626;">${fmt(totalWHTSuffered)}</span><br/><span class="small-muted">Paid for supplier</span></div>`;
      html += `<div><strong>Net WHT Position:</strong><br/><span style="font-size:1.2rem;font-weight:700;color:${whtNet >= 0 ? '#0b76d1' : '#dc2626'};">${fmt(whtNet)}</span><br/><span class="small-muted">${whtNet >= 0 ? 'Payable to tax authority' : 'Credit available'}</span></div>`;
      html += `</div>`;
      html += `</div>`;
      
      // WHT Collected (from revenue) - breakdown by rate
      html += `<h4>WHT Collected (Deducted by Customer)</h4>`;
      if(Object.keys(whtCollectedByRate).length > 0){
        html += `<div style="margin-bottom:8px;">`;
        for(const rate in whtCollectedByRate){
          html += `<span style="display:inline-block;margin-right:16px;"><strong>${rate}%:</strong> ${fmt(whtCollectedByRate[rate])}</span>`;
        }
        html += `</div>`;
      }
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Contact</th><th>Description</th><th>Rate %</th><th>Gross</th><th>WHT</th></tr></thead><tbody>`;
      for(const t of arr){
        if(t.whtApplied && t.accountCategory === 'Revenue'){
          const rate = Number(t.whtRate || b.whtRate);
          const basis = t.whtBasis || 'gross';
          const wht = computeWHT(Number(t.amount||0), basis, rate);
          html += `<tr><td>${t.date}</td><td>${t.contact||''}</td><td>${t.description||''}</td><td>${rate}</td><td>${fmt(t.amount)}</td><td>${fmt(wht)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="5">Total WHT Collected</th><th>${fmt(totalWHTCollected)}</th></tr></tfoot></table>`;
      
      // WHT Suffered (from expenses) - breakdown by rate
      html += `<h4 style="margin-top:16px;">WHT Suffered (Paid for Supplier)</h4>`;
      if(Object.keys(whtSufferedByRate).length > 0){
        html += `<div style="margin-bottom:8px;">`;
        for(const rate in whtSufferedByRate){
          html += `<span style="display:inline-block;margin-right:16px;"><strong>${rate}%:</strong> ${fmt(whtSufferedByRate[rate])}</span>`;
        }
        html += `</div>`;
      }
      html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Vendor</th><th>Description</th><th>Rate %</th><th>Gross</th><th>WHT</th></tr></thead><tbody>`;
      for(const t of arr){
        if(t.whtApplied && t.accountCategory === 'Expense'){
          const rate = Number(t.whtRate || b.whtRate);
          const basis = t.whtBasis || 'gross';
          const wht = computeWHT(Number(t.amount||0), basis, rate);
          html += `<tr><td>${t.date}</td><td>${t.contact||''}</td><td>${t.description||''}</td><td>${rate}</td><td>${fmt(t.amount)}</td><td>${fmt(wht)}</td></tr>`;
        }
      }
      html += `</tbody><tfoot><tr><th colspan="5">Total WHT Suffered</th><th>${fmt(totalWHTSuffered)}</th></tr></tfoot></table>`;
      reportContent.innerHTML = html;
      
    } else if(name === 'citReport'){
      // Company Income Tax Report - standalone
      reportContent.innerHTML = generateCITReport(selectedBizId);
      
    } else if(name === 'payeReport'){
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      const payeByContact = {};
      // Exclude sole traders from PAYE report
      for(const t of arr){
        if(t.paye && t.contact){
          // Check if contact is a sole trader
          const contact = b.contacts.find(c => c.name === t.contact);
          if(!contact || contact.type !== 'SoleTrader'){
            payeByContact[t.contact] = (payeByContact[t.contact] || 0) + Number(t.amount || 0);
          }
        }
      }
      
      // Get eligible employees/sole traders for dropdown
      const eligibleContacts = populateEmployeeDropdownForPaye(selectedBizId);
      
      let html = `<h3>PAYE Report</h3>`;
      
      // Employee/SoleTrader dropdown for statutory deductions
      if(eligibleContacts.length > 0){
        html += `<div style="margin-bottom:16px;padding:12px;background:#f7f9fc;border-radius:6px;">`;
        html += `<label style="margin-right:8px;"><strong>View Statutory Deductions for:</strong></label>`;
        html += `<select id="payeContactSelect" onchange="showPayeContactDeductions(this.value)" style="padding:6px;border-radius:4px;border:1px solid #cfcfcf;">`;
        html += `<option value="">-- Select Employee/SoleTrader --</option>`;
        for(const c of eligibleContacts){
          html += `<option value="${c.id}">${c.name} (${c.type})</option>`;
        }
        html += `</select>`;
        html += `<div id="payeContactDeductions" style="margin-top:12px;"></div>`;
        html += `</div>`;
      }
      
      if(Object.keys(payeByContact).length===0) html += '<div>No PAYE records found</div>';
      else {
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Contact</th><th>Annual Salary</th><th>Stat. Deductions</th><th>Taxable Income</th><th>PAYE Annual</th><th>PAYE Monthly</th></tr></thead><tbody>`;
        for(const cName in payeByContact){
          const annual = payeByContact[cName];
          // Find contact to get their statutory deductions
          const contact = b.contacts.find(c => c.name === cName);
          const ded = contact ? getStatutoryDeductions(b, contact.id) : getStatutoryDeductions(b, null);
          const totalDed = totalStatutoryDeductions(ded);
          const taxableIncome = Math.max(0, annual - totalDed);
          const tax = computePAYEOnAnnualIncome(taxableIncome);
          html += `<tr><td>${cName}</td><td>${fmt(annual)}</td><td>${fmt(totalDed)}</td><td>${fmt(taxableIncome)}</td><td>${fmt(tax)}</td><td>${fmt(tax/12)}</td></tr>`;
        }
        html += `</tbody></table>`;
      }
      reportContent.innerHTML = html;
      
    } else if(name === 'inventoryReport'){
      let html = `<h3>Inventory Schedule</h3>`;
      if(b.inventory && b.inventory.length){
        let scheduleTotal = 0;
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Item</th><th>Quantity</th><th>Avg Cost (â‚¦)</th><th>Total Value (â‚¦)</th></tr></thead><tbody>`;
        for(const item of b.inventory){
          const value = (item.qty || 0) * (item.avgCost || 0);
          scheduleTotal += value;
          html += `<tr><td>${escapeHtml(item.name)}</td><td>${item.qty||0}</td><td style="text-align:right;">${fmt(item.avgCost||0)}</td><td style="text-align:right;">${fmt(value)}</td></tr>`;
        }
        html += `</tbody><tfoot><tr style="background:#e6f3ff;font-weight:700;"><td colspan="3">Total Closing Inventory</td><td style="text-align:right;">${fmt(scheduleTotal)}</td></tr></tfoot></table>`;
        html += `<p class="small-note">Closing inventory total feeds into the Balance Sheet under Assets.</p>`;
      } else {
        html += '<div>No inventory items</div>';
      }
      reportContent.innerHTML = html;
      
    } else if(name === 'assetsReport'){
      const gains = computeChargeableGainsForBiz();
      // Ensure depreciation is up-to-date
      computeTotalDepreciation();
      let html = `<h3>Fixed Assets Schedule</h3>`;
      if(b.assets && b.assets.length){
        let totalCost = 0, totalAccDep = 0, totalNBV = 0;
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr>` +
          `<th>Name</th><th>Qty</th><th>Cost (â‚¦)</th><th>Opening Acc Dep (â‚¦)</th><th>Dep This Period (â‚¦)</th><th>Total Acc Dep (â‚¦)</th><th>NBV (â‚¦)</th>` +
          `<th>Life (yrs)</th><th>Purchase Date</th><th>Classification</th><th>Disposed</th>` +
          `</tr></thead><tbody>`;
        for(const a of b.assets){
          const cost = Number(a.cost || 0);
          const openingAccDep = Number(a.openingAccDep || 0);
          const computedDep = Number(a.accumulatedDepreciation || 0); // from this period
          const totalAccDepAmt = Number(a.accumulatedDep || 0); // openingAccDep + computed
          const nbv = cost - totalAccDepAmt;
          if(!a.disposed) { totalCost += cost; totalAccDep += totalAccDepAmt; totalNBV += nbv; }
          html += `<tr${a.disposed ? ' style="color:#64748b;"' : ''}>` +
            `<td>${escapeHtml(a.name)}</td><td>${a.qty||1}</td>` +
            `<td style="text-align:right;">${fmt(cost)}</td>` +
            `<td style="text-align:right;">${fmt(openingAccDep)}</td>` +
            `<td style="text-align:right;">${fmt(computedDep)}</td>` +
            `<td style="text-align:right;">${fmt(totalAccDepAmt)}</td>` +
            `<td style="text-align:right;font-weight:${a.disposed?'normal':'600'};">${fmt(nbv)}</td>` +
            `<td>${a.lifeYears||0}</td><td>${a.purchaseDate||''}</td>` +
            `<td>${a.classification||''}</td><td>${a.disposed ? 'Yes' : 'No'}</td>` +
            `</tr>`;
        }
        html += `</tbody><tfoot><tr style="background:#e6f3ff;font-weight:700;">` +
          `<td colspan="2">Total (active assets)</td>` +
          `<td style="text-align:right;">${fmt(totalCost)}</td>` +
          `<td></td><td></td>` +
          `<td style="text-align:right;">${fmt(totalAccDep)}</td>` +
          `<td style="text-align:right;">${fmt(totalNBV)}</td>` +
          `<td colspan="4"></td>` +
          `</tr></tfoot></table>`;
        html += `<p class="small-note">NBV = Cost âˆ’ Accumulated Depreciation (book). PPE at NBV feeds into the Balance Sheet.</p>`;
      } else html += '<div>No assets</div>';
      if(gains.length){
        html += `<h4 style="margin-top:16px;">Disposal &amp; Chargeable Gains</h4><table style="width:100%;border-collapse:collapse;"><thead><tr><th>Asset</th><th>Proceeds</th><th>Gain/Loss</th><th>CGT</th></tr></thead><tbody>`;
        for(const g of gains){
          html += `<tr><td>${escapeHtml(g.name)}</td><td>${fmt(g.proceeds)}</td><td>${fmt(g.gain)}</td><td>${fmt(g.cgtCharge)}</td></tr>`;
        }
        html += `</tbody></table>`;
      }
      reportContent.innerHTML = html;
      
    } else if(name === 'pitBusiness'){
      // Use the new generatePitBusinessReport function
      reportContent.innerHTML = generatePitBusinessReport(selectedBizId, null);
      
    } else if(name === 'cgtReport'){
      // Use the new generateCgtReport function
      reportContent.innerHTML = generateCgtReport(selectedBizId);
      
    } else if(name === 'financialReport'){
      // Financial Report - P&L and Balance Sheet
      const periodLabel = (b.periodStart && b.periodEnd)
        ? `Period: ${b.periodStart} to ${b.periodEnd}`
        : (b.periodStart ? `From: ${b.periodStart}` : '');
      let html = `<h3>Financial Reports</h3>`;
      if(periodLabel) html += `<p class="small-note" style="margin:0 0 8px 0;">${escapeHtml(periodLabel)}</p>`;
      
      // Sub-tabs for P&L and Balance Sheet
      html += `<div style="display:flex; gap:8px; margin-bottom:16px;">`;
      html += `<button class="small tab active" onclick="showFinancialSubReport('pl')">Profit &amp; Loss Statement</button>`;
      html += `<button class="small tab" onclick="showFinancialSubReport('bs')">Balance Sheet (Accrual)</button>`;
      html += `</div>`;
      
      html += `<div id="financialSubReport"></div>`;
      reportContent.innerHTML = html;
      
      // Render P&L by default
      showFinancialSubReport('pl');
      
    } else if(name === 'auditTrail'){
      // Audit Trail report
      let html = `<h3>Audit Trail</h3>`;
      if(state.audit && state.audit.length > 0){
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Timestamp</th><th>Action</th><th>Entity Type</th><th>Entity ID</th><th>Details</th><th>Original Data</th></tr></thead><tbody>`;
        // Show most recent first
        const sortedAudit = [...state.audit].reverse().slice(0, 100);
        for(const entry of sortedAudit){
          // Format original data if present
          let originalDataStr = '';
          if(entry.originalData) {
            const od = entry.originalData;
            const parts = [];
            if(od.amount !== undefined) parts.push(`Amount: ${fmt(od.amount)}`);
            if(od.qty !== undefined) parts.push(`Qty: ${od.qty}`);
            if(od.prevQty !== undefined) parts.push(`Prev Qty: ${od.prevQty}`);
            if(od.avgCost !== undefined) parts.push(`Avg Cost: ${fmt(od.avgCost)}`);
            if(od.prevAvgCost !== undefined) parts.push(`Prev Avg Cost: ${fmt(od.prevAvgCost)}`);
            if(od.unitPrice !== undefined) parts.push(`Unit Price: ${fmt(od.unitPrice)}`);
            if(od.gain !== undefined) parts.push(`Gain: ${fmt(od.gain)}`);
            if(od.netGain !== undefined) parts.push(`Net Gain: ${fmt(od.netGain)}`);
            if(od.cgtCharge !== undefined) parts.push(`CGT: ${fmt(od.cgtCharge)}`);
            if(od.lossAmount !== undefined) parts.push(`Loss: ${fmt(od.lossAmount)}`);
            if(od.offsetUsed !== undefined) parts.push(`Offset: ${fmt(od.offsetUsed)}`);
            if(od.year !== undefined) parts.push(`Year: ${od.year}`);
            if(od.assetClass !== undefined) parts.push(`Asset Class: ${od.assetClass}`);
            if(od.action !== undefined) parts.push(`Action: ${od.action}`);
            if(od.assetId !== undefined) parts.push(`Asset ID: ${od.assetId}`);
            if(od.entityType !== undefined) parts.push(`Entity: ${od.entityType}`);
            if(od.turnoverThreshold !== undefined) parts.push(`Threshold: ${fmt(od.turnoverThreshold)}`);
            originalDataStr = parts.join(', ');
          }
          html += '<tr>';
          html += '<td>' + (entry.timestamp || '') + '</td>';
          html += '<td>' + (entry.action || entry.type || '') + '</td>';
          html += '<td>' + (entry.entityType || '') + '</td>';
          html += '<td>' + (entry.entityId || '') + '</td>';
          html += '<td>' + (entry.details || '') + '</td>';
          html += '<td class="small-muted">' + originalDataStr + '</td>';
          html += '</tr>';
        }
        html += `</tbody></table>`;
        if(state.audit.length > 100) {
          html += `<p class="small-note">Showing most recent 100 entries of ${state.audit.length} total.</p>`;
        }
      } else {
        html += `<div class="notice">No audit trail entries found.</div>`;
      }
      reportContent.innerHTML = html;
      
    } else if(name === 'receiptsFolder'){
      // Receipts Folder report
      const arr = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      const attachmentKeys = Object.keys(state.attachments || {});
      
      let html = `<h3>Receipts Folder</h3>`;
      
      // Find all transactions with receipts
      const txnsWithReceipts = arr.filter(t => t.receiptId && state.attachments && state.attachments[t.receiptId]);
      
      if(txnsWithReceipts.length > 0){
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Receipt</th></tr></thead><tbody>`;
        for(const t of txnsWithReceipts){
          const attachment = state.attachments[t.receiptId];
          let receiptDisplay = '';
          if(attachment && attachment.data){
            if(attachment.type && attachment.type.startsWith('image/')){
              receiptDisplay = `<img src="${attachment.data}" class="receipt-thumb" alt="Receipt" onclick="window.open('${attachment.data}', '_blank')" style="cursor:pointer;" />`;
            } else {
              receiptDisplay = `<a href="${attachment.data}" target="_blank">${attachment.name || 'View'}</a>`;
            }
          }
          html += `<tr><td>${t.date || ''}</td><td>${t.description || ''}</td><td>${fmt(t.amount)}</td><td>${receiptDisplay}</td></tr>`;
        }
        html += `</tbody></table>`;
      } else {
        html += `<div class="notice">No receipts found. Attach receipts when creating transactions.</div>`;
      }
      reportContent.innerHTML = html;
      
    } else {
      reportContent.innerHTML = '<div>Report not implemented</div>';
    }
  }

  function exportCurrentReport(fmtType){
    alert('Export ' + fmtType + ' not implemented in this version');
  }

  // Business helpers
  function renderBizContacts(b){
    bizContactsList.innerHTML = '';
    if(!b) return;
    for(const c of b.contacts || []){
      const div = document.createElement('div'); div.className='account-row';
      const editBtn = document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=> editContact(c.id));
      const deleteBtn = document.createElement('button'); deleteBtn.className='small danger'; deleteBtn.textContent='Delete'; deleteBtn.addEventListener('click', ()=> deleteContact(c.id));
      div.innerHTML = `<div><strong>${c.name}</strong> <span class="small-muted">(${c.type})</span></div>`;
      div.appendChild(editBtn);
      div.appendChild(deleteBtn);
      bizContactsList.appendChild(div);
    }
  }

  function editContact(id){
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    const contact = (b.contacts || []).find(c => c.id === id);
    if(!contact) {
      alert('Contact not found');
      return;
    }
    
    // Show Annual Statutory Deductions section in business modal
    const annualStatutoryDeductionsSection = document.getElementById('annualStatutoryDeductionsSection');
    if(annualStatutoryDeductionsSection) {
      annualStatutoryDeductionsSection.style.display = 'block';
    }
    
    // Populate modal fields
    const contactEditModal = document.getElementById('contactEditModal');
    const contactEditName = document.getElementById('contactEditName');
    const contactEditType = document.getElementById('contactEditType');
    const contactEditId = document.getElementById('contactEditId');
    const contactDedPension = document.getElementById('contactDedPension');
    const contactDedRent = document.getElementById('contactDedRent');
    const contactDedLife = document.getElementById('contactDedLife');
    const contactDedMortgage = document.getElementById('contactDedMortgage');
    const contactDedNHF = document.getElementById('contactDedNHF');
    const contactDedNHIS = document.getElementById('contactDedNHIS');
    const contactDeductionsSection = document.getElementById('contactDeductionsSection');
    
    if(!contactEditModal) return;
    
    contactEditId.value = contact.id;
    contactEditName.value = contact.name || '';
    contactEditType.value = contact.type || 'Customer';
    
    // Populate deductions if they exist
    const ded = contact.deductions || {};
    contactDedPension.value = ded.pension || 0;
    contactDedRent.value = ded.rent || 0;
    contactDedLife.value = ded.life || 0;
    contactDedMortgage.value = ded.mortgage || 0;
    contactDedNHF.value = ded.nhf || 0;
    contactDedNHIS.value = ded.nhis || 0;
    
    // Show/hide deductions section based on contact type
    const showDeductions = (contact.type === 'Employee' || contact.type === 'SoleTrader');
    contactDeductionsSection.style.display = showDeductions ? 'block' : 'none';
    
    openModal(contactEditModal);
  }

  function deleteContact(id){
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    const contact = (b.contacts || []).find(c => c.id === id);
    if(!contact) {
      alert('Contact not found');
      return;
    }
    
    if(!confirm(`Delete contact "${contact.name}"? This cannot be undone.`)) return;
    
    // Remove the contact from the business
    b.contacts = (b.contacts || []).filter(c => c.id !== id);
    
    saveState();
    addAudit('contact.delete', 'contact', id, 'Deleted contact: ' + contact.name);
    renderBizContacts(b);
    alert('Contact deleted successfully');
  }
  
  /**
   * Shows statutory deductions for a selected contact in the PAYE report.
   * @param {string} contactId - Contact ID
   */
  function showPayeContactDeductions(contactId) {
    const displayDiv = document.getElementById('payeContactDeductions');
    if(!displayDiv) return;
    
    if(!contactId) {
      displayDiv.innerHTML = '';
      return;
    }
    
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    const contact = (b.contacts || []).find(c => c.id === contactId);
    if(!contact) {
      displayDiv.innerHTML = '<div class="muted">Contact not found</div>';
      return;
    }
    
    const ded = getStatutoryDeductions(b, contactId);
    const totalDed = totalStatutoryDeductions(ded);
    
    let html = `<div style="background:#fff;padding:10px;border-radius:4px;border:1px solid #e6e6e6;">`;
    html += `<strong>${contact.name}</strong> (${contact.type})<br/>`;
    html += `<table style="width:100%;margin-top:8px;"><tbody>`;
    html += `<tr><td>Pension:</td><td style="text-align:right;">${fmt(ded.pension)}</td></tr>`;
    html += `<tr><td>Rent Relief:</td><td style="text-align:right;">${fmt(ded.rent)}</td></tr>`;
    html += `<tr><td>Life Assurance:</td><td style="text-align:right;">${fmt(ded.life)}</td></tr>`;
    html += `<tr><td>Mortgage Interest:</td><td style="text-align:right;">${fmt(ded.mortgage)}</td></tr>`;
    html += `<tr><td>NHF:</td><td style="text-align:right;">${fmt(ded.nhf)}</td></tr>`;
    html += `<tr style="background:#f2f6fa;"><td><strong>Total:</strong></td><td style="text-align:right;"><strong>${fmt(totalDed)}</strong></td></tr>`;
    html += `</tbody></table>`;
    
    if(contact.deductions) {
      html += `<div class="small-note" style="margin-top:8px;">Using contact-specific deductions</div>`;
    } else {
      html += `<div class="small-note" style="margin-top:8px;">Using business-level default deductions</div>`;
    }
    
    html += `</div>`;
    displayDiv.innerHTML = html;
  }
  
  // Make showPayeContactDeductions available globally for onclick handler
  window.showPayeContactDeductions = showPayeContactDeductions;

  /**
   * Calculate closing balance for an account based on transactions
   * @param {object} account - The account object
   * @param {string} bizId - The business ID
   * @returns {number} - The calculated closing balance
   */
  function calculateAccountClosingBalance(account, bizId) {
    const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][bizId]) || [];
    let balance = account.openingBalance || 0;
    
    // Calculate balance based on account category
    // Asset & Expense: Debit increases, Credit decreases
    // Liability, Capital & Revenue: Credit increases, Debit decreases
    
    for (const txn of txns) {
      if (txn.accountId !== account.id) continue;
      
      if (account.category === 'Asset' || account.category === 'Expense') {
        // For Asset and Expense accounts, amounts add to balance
        balance += (txn.amount || 0);
      } else if (account.category === 'Liability' || account.category === 'Capital' || account.category === 'Revenue') {
        // For Liability, Capital and Revenue accounts, amounts add to balance
        balance += (txn.amount || 0);
      }
    }
    
    // Special handling for Receivable account - add unpaid invoice balances
    if (account.name === 'Receivable' || account.name === 'Accounts Receivable') {
      const key = `${selectedUserId}_${bizId}`;
      const invoices = (state.invoices && state.invoices[key]) || [];
      
      for (const inv of invoices) {
        if (inv.status === 'paid') continue;
        
        const total = Number(inv.total || 0);
        const paymentAmount = Number(inv.paymentAmount || 0);
        const remainingAmount = total - paymentAmount;
        
        if (remainingAmount > 0) {
          balance += remainingAmount;
        }
      }
    }
    
    return balance;
  }

  function renderAccounts(){
    accountsList.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(!b) return;
    
    for(const a of b.accounts){
      const div = document.createElement('div'); 
      div.className='account-row';
      div.style.flexDirection = 'column';
      div.style.alignItems = 'flex-start';
      div.style.gap = '6px';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.display = 'flex';
      headerDiv.style.justifyContent = 'space-between';
      headerDiv.style.width = '100%';
      
      const delBtn = document.createElement('button'); 
      delBtn.className='small'; 
      delBtn.textContent='Delete'; 
      delBtn.addEventListener('click', ()=> deleteAccount(a.id));
      
      // Add Save button for Assets, Liabilities, and Capital
      const saveBtn = document.createElement('button');
      saveBtn.className='small primary';
      saveBtn.textContent='Save';
      saveBtn.style.marginLeft = '6px';
      saveBtn.addEventListener('click', ()=> {
        saveState();
        alert('Account saved successfully');
      });
      
      // Determine which tabs use this account - REMOVED per requirements
      // No longer showing "used in ledger" and "used in cashbook" indicators
      
      headerDiv.innerHTML = `<div><strong>${a.name}</strong> <span class="small-muted">${a.category}</span></div>`;
      
      // Add Save and Delete buttons for Asset, Liability, and Capital accounts
      if(['Asset', 'Liability', 'Capital'].includes(a.category)) {
        headerDiv.appendChild(saveBtn);
      }
      headerDiv.appendChild(delBtn);
      div.appendChild(headerDiv);
      
      // Show opening balance field for ALL Asset, Liability, and Capital accounts
      if(['Asset', 'Liability', 'Capital'].includes(a.category)){
        const balDiv = document.createElement('div');
        balDiv.style.display = 'flex';
        balDiv.style.gap = '8px';
        balDiv.innerHTML = `
          <label class="small-note">Opening Balance: 
            <input type="number" class="smallInput" value="${a.openingBalance||0}" 
              onchange="updateAccountBalance('${a.id}', 'opening', this.value)" step="0.01" />
          </label>
        `;
        div.appendChild(balDiv);
      }
      
      // Show closing balance for Asset, Liability, and Capital accounts
      if(['Asset', 'Liability', 'Capital'].includes(a.category)) {
        const closingBalance = calculateAccountClosingBalance(a, selectedBizId);
        const closingDiv = document.createElement('div');
        closingDiv.style.display = 'flex';
        closingDiv.style.gap = '8px';
        closingDiv.innerHTML = `
          <span class="small-note"><strong>Closing Starting Balance: â‚¦${closingBalance.toLocaleString('en-NG', {minimumFractionDigits:2, maximumFractionDigits:2})}</strong></span>
        `;
        div.appendChild(closingDiv);
      }
      
      accountsList.appendChild(div);
    }
  }
  
  function updateAccountBalance(accountId, type, value){
    const b = findBiz(selectedBizId);
    if(!b) return;
    const account = b.accounts.find(a => a.id === accountId);
    if(!account) return;
    
    if(type === 'opening'){
      account.openingBalance = Number(value || 0);
    } else if(type === 'closing'){
      account.closingBalance = Number(value || 0);
    }
    saveState();
  }
  
  // Make updateAccountBalance available globally for inline onchange handlers
  window.updateAccountBalance = updateAccountBalance;
  function deleteAccount(id){
    const b = findBiz(selectedBizId);
    if(!b) return;
    b.accounts = (b.accounts||[]).filter(x=>x.id!==id);
    saveState();
    renderAccounts();
    populateAccountSelect();
  }

  function deleteBusiness(id){
    state.businesses = state.businesses.filter(x=>x.id!==id);
    for(const u of state.users) if(state.transactions[u.id]) delete state.transactions[u.id][id];
    saveState();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    renderAll();
  }

  function deleteUser(id){
    if(!confirm('Delete this user and all their data? This action cannot be undone!')) return;
    
    state.users = state.users.filter(x=>x.id!==id);
    delete state.transactions[id];
    addAudit('user.delete', 'user', id, 'User deleted');
    saveState();
    refreshSelectors();
    ensureSelection();
    renderAll();
  }

  // utilities for tax computations reused earlier
  function computePLAndTaxesForReports(){
    // placeholder if needed
  }

  /**
   * Self-check / deterministic test function for core accounting logic.
   * Developers can run `ntcSelfCheck()` in the browser console to verify calculations.
   * Returns an object with { passed, failed, results }.
   */
  function ntcSelfCheck() {
    const results = [];
    let passed = 0, failed = 0;

    function assert(name, actual, expected, tolerance) {
      const tol = tolerance || 0.01;
      const ok = Math.abs(actual - expected) <= tol;
      results.push({ name, actual, expected, ok });
      if (ok) passed++; else failed++;
    }

    // ------ WHT Computations ------
    // Gross basis: WHT = amount Ã— rate
    assert('WHT gross basis 5%', computeWHT(100000, 'gross', 5), 5000);
    assert('WHT gross basis 10%', computeWHT(200000, 'gross', 10), 20000);
    // Net basis: gross = net / (1 - rate); WHT = gross - net
    // net=95000, rate=5% â†’ gross=100000, WHT=5000
    assert('WHT net basis 5%', computeWHT(95000, 'net', 5), 5000);
    // net=90000, rate=10% â†’ gross=100000, WHT=10000
    assert('WHT net basis 10%', computeWHT(90000, 'net', 10), 10000);

    // ------ VAT Computations ------
    // Exclusive: VAT = amount Ã— rate / 100
    assert('VAT exclusive 7.5%', computeVAT(100000, 'exclusive', 7.5), 7500);
    // Inclusive: VAT = amount Ã— rate / (100 + rate)
    assert('VAT inclusive 7.5%', computeVAT(107500, 'inclusive', 7.5), 7500);
    assert('VAT none', computeVAT(100000, 'none', 7.5), 0);

    // ------ PAYE / PIT Bands ------
    // â‚¦800,000 is in first band (0%) â†’ 0
    assert('PAYE 800k (0%)', computePAYEOnAnnualIncome(800000), 0);
    // â‚¦1,800,000: 0% on 800k, 15% on 1M = 150,000
    assert('PAYE 1.8M', computePAYEOnAnnualIncome(1800000), 150000);
    // â‚¦4,000,000: 0% on 800k, 15% on 2.2M = 330000, 18% on 1M = 180000 â†’ 510000
    assert('PAYE 4M', computePAYEOnAnnualIncome(4000000), 510000);

    // ------ Inventory closing value ------
    const demoItems = [
      { qty: 10, avgCost: 5000 },
      { qty: 5, avgCost: 12000 }
    ];
    const inventoryTotal = demoItems.reduce((s, i) => s + i.qty * i.avgCost, 0);
    assert('Inventory closing value', inventoryTotal, 110000);

    // Output to console
    console.group('ntcSelfCheck Results');
    for (const r of results) {
      const icon = r.ok ? 'âœ…' : 'âŒ';
      console.log(`${icon} ${r.name}: got ${r.actual}, expected ${r.expected}`);
    }
    console.groupEnd();
    console.log(`Self-check complete: ${passed} passed, ${failed} failed`);
    return { passed, failed, results };
  }

  // Expose self-check globally for browser console use
  window.ntcSelfCheck = ntcSelfCheck;

  
  (function initContactDropdown() {
    const btnSelectContact = document.getElementById('btnSelectContact');
    const contactDropdown = document.getElementById('contactDropdown');
    const txnContact = document.getElementById('txnContact');
    const contactNameSelects = document.querySelectorAll('.contact-name-select');
    
    if (!btnSelectContact || !contactDropdown) return;
    
    // Toggle dropdown on button click
    btnSelectContact.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const isVisible = contactDropdown.style.display === 'block';
      contactDropdown.style.display = isVisible ? 'none' : 'block';
      
      if (!isVisible) {
        // Populate dropdowns when opening
        populateContactDropdowns();
      }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!contactDropdown.contains(e.target) && e.target !== btnSelectContact) {
        contactDropdown.style.display = 'none';
      }
    });
    
    // Handle contact selection from sub-dropdowns
    contactNameSelects.forEach(function(select) {
      select.addEventListener('change', function(e) {
        if (this.value && txnContact) {
          txnContact.value = this.value;
          contactDropdown.style.display = 'none';
          // Reset the select
          this.value = '';
        }
      });
    });
    
    // Populate contact dropdowns with current business contacts
    function populateContactDropdowns() {
      const b = findBiz(selectedBizId);
      if (!b || !b.contacts) return;
      
      // Group contacts by type
      const contactsByType = {
        Employee: [],
        Customer: [],
        Vendor: []
      };
      
      b.contacts.forEach(function(contact) {
        const type = contact.type || 'Customer';
        if (contactsByType[type]) {
          contactsByType[type].push(contact);
        }
      });
      
      // Populate each dropdown
      contactNameSelects.forEach(function(select) {
        const type = select.getAttribute('data-type');
        const contacts = contactsByType[type] || [];
        
        // Clear existing options except first
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        // Add contacts
        contacts.forEach(function(contact) {
          const option = document.createElement('option');
          option.value = contact.name;
          option.textContent = contact.name;
          select.appendChild(option);
        });
        
        // Disable if no contacts
        select.disabled = contacts.length === 0;
      });
    }
    
    // Also populate datalist for autocomplete
    function populateContactDatalist() {
      const datalist = document.getElementById('contactSuggestions');
      if (!datalist) return;
      
      const b = findBiz(selectedBizId);
      if (!b || !b.contacts) return;
      
      // Clear existing options
      datalist.innerHTML = '';
      
      // Add all contacts
      b.contacts.forEach(function(contact) {
        const option = document.createElement('option');
        option.value = contact.name;
        datalist.appendChild(option);
      });
    }
    
    // Expose function to update on business change
    window.updateContactDropdowns = function() {
      populateContactDatalist();
    };
    
    // Initial population
    populateContactDatalist();
  })();

  // final initialization
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();
  
  // Firebase Auth UI Initialization
  (function initFirebaseAuthUI() {
    const authModeNote = document.getElementById('authModeNote');
    const demoAccessContainer = document.getElementById('demoAccessContainer');
    const btnDemoAccess = document.getElementById('btnDemoAccess');
    
    // Update auth mode note and demo button based on Firebase availability
    const firebaseEnabled = typeof isFirebaseAuthEnabled === 'function' && isFirebaseAuthEnabled();
    console.log('Firebase enabled status:', firebaseEnabled);
    
    if (authModeNote) {
      if (firebaseEnabled) {
        authModeNote.textContent = 'Secure authentication powered by Firebase. Your data is stored locally in your browser.';
        authModeNote.style.color = '';
        // Hide demo access button when Firebase is working
        if (demoAccessContainer) demoAccessContainer.style.display = 'none';
      } else {
        authModeNote.textContent = 'Note: Authentication service is currently unavailable.';
        authModeNote.style.color = '#b00';
        // Show demo access button when Firebase is unavailable
        if (demoAccessContainer) demoAccessContainer.style.display = 'block';
        console.log('Demo access button should be visible');
      }
    }
    
    // Demo access button handler
    if (btnDemoAccess) {
      btnDemoAccess.addEventListener('click', function() {
        // Create a demo user if none exists
        if (!state.auth.currentUserId && state.users.length === 0) {
          const demoUserId = uid('user');
          const demoUser = {
            id: demoUserId,
            username: 'demo',
            display: 'Demo User',
            email: 'demo@local',
            role: 'User',
            isAdmin: false,
            permissions: { view: true, edit: true, delete: true },
            plan: 'Individual',
            createdAt: Date.now(),
            trialStart: Date.now(),
            tourSeen: false,
            createdByAdmin: false
          };
          state.users.push(demoUser);
          state.auth.currentUserId = demoUserId;
          saveState();
          addAudit('auth.demo', 'user', demoUserId, 'User accessed demo mode');
        } else if (!state.auth.currentUserId && state.users.length > 0) {
          // Use existing user
          state.auth.currentUserId = state.users[0].id;
          saveState();
        }
        
        updateAuthUI();
        refreshSelectors();
        ensureSelection();
        renderAll();
        renderTab(); // render the active tab (dashboard) after demo access
        const currentUser = state.users.find(function(u) { return u.id === state.auth.currentUserId; });
        if (currentUser && currentUser.tourSeen !== true) {
          showTourModal(currentUser.id);
        }
      });
    }
    
    // Listen for Firebase auth state changes if enabled
    if (typeof isFirebaseAuthEnabled === 'function' && isFirebaseAuthEnabled() && firebaseAuth) {
      firebaseAuth.onAuthStateChanged(function(firebaseUser) {
        if (firebaseUser) {
          // User is signed in with Firebase
          const localUserId = getLocalUserIdFromFirebaseUid(firebaseUser.uid);
          if (localUserId && state.auth.currentUserId !== localUserId) {
            // Sync local auth state with Firebase
            state.auth.currentUserId = localUserId;
            saveState();
            updateAuthUI();
            renderAll();
          }
        } else {
          // User is signed out of Firebase
          if (state.auth.currentUserId) {
            const currentUser = state.users.find(function(u) { return u.id === state.auth.currentUserId; });
            // Only auto-logout if the user was authenticated via Firebase
            if (currentUser && currentUser.firebaseUid) {
              state.auth.currentUserId = null;
              saveState();
              updateAuthUI();
              renderAll();
            }
          }
        }
      });
    }
  })();

  // Offer countdown timer and pricing logic
  (function initOfferCountdownAndPricing() {
    // DOM elements for countdown
    const countdownEl = document.getElementById('offerCountdown');
    const preloginCountdownEl = document.getElementById('preloginCountdown');
    const heroCountdownEl = document.getElementById('heroCountdown');
    const preloginOfferBox = document.getElementById('preloginOfferBox');
    
    // Pricing configuration
    const PLANS = {
      business: {
        fullPrice: 60000,
        offerPrice: 40000,
        taxAccountantPrice: 25000,
        bookkeepingPrice: 75000,
        buyLink: 'https://buy.stripe.com/business-plan',
        taxAccountantLink: 'https://buy.stripe.com/hire-tax-accountant-business'
      },
      company: {
        fullPrice: 80000,
        offerPrice: 60000,
        taxAccountantPrice: 25000,
        bookkeepingPrice: 100000,
        buyLink: 'https://buy.stripe.com/company-plan',
        taxAccountantLink: 'https://buy.stripe.com/hire-tax-accountant-company'
      },
      enterprise: {
        fullPrice: 150000,
        offerPrice: 100000,
        addonBusinessPrice: 15000,
        addonCompanyPrice: 25000,
        buyLink: 'https://buy.stripe.com/enterprise-plan',
        addonBusinessLink: 'https://buy.stripe.com/hire-tax-accountant-business',
        addonCompanyLink: 'https://buy.stripe.com/hire-tax-accountant-company'
      },
      enterprisePlus: {
        fullPrice: 200000,
        offerPrice: 150000,
        buyLink: 'https://buy.stripe.com/enterprise-plus-plan'
      }
    };
    
    const OFFER_DURATION_MS = 72 * 60 * 60 * 1000; // 72 hours in milliseconds
    const STORAGE_KEY_OFFER = 'offerEndTimestamp';
    
    // Initialize or retrieve offer end timestamp
    function getOfferEndTimestamp() {
      let endTime = localStorage.getItem(STORAGE_KEY_OFFER);
      if (!endTime) {
        endTime = Date.now() + OFFER_DURATION_MS;
        localStorage.setItem(STORAGE_KEY_OFFER, endTime);
      } else {
        endTime = parseInt(endTime, 10);
      }
      return endTime;
    }
    
    let offerEndTimestamp = getOfferEndTimestamp();
    
    // Reset offer to new 72-hour window
    function resetOffer() {
      offerEndTimestamp = Date.now() + OFFER_DURATION_MS;
      localStorage.setItem(STORAGE_KEY_OFFER, offerEndTimestamp);
      
      // Flash the offer box to indicate restart
      if (preloginOfferBox) {
        preloginOfferBox.classList.add('offer-flash');
        setTimeout(function() {
          preloginOfferBox.classList.remove('offer-flash');
        }, 600);
      }
      
      // Re-enable all offer checkboxes
      ['business', 'company', 'enterprise', 'enterprisePlus'].forEach(function(plan) {
        const checkbox = document.getElementById(plan + 'ApplyOffer');
        if (checkbox) {
          checkbox.checked = true;
          checkbox.disabled = false;
        }
      });
      
      // Recalculate totals
      updateAllTotals();
    }
    
    // Format time as Days:HH:MM:SS
    function formatCountdown(remaining) {
      if (remaining <= 0) return '0d 00:00:00';
      
      const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
      const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
      
      return days + 'd ' + 
        String(hours).padStart(2, '0') + ':' +
        String(minutes).padStart(2, '0') + ':' +
        String(seconds).padStart(2, '0');
    }
    
    // Update countdown display
    function updateCountdown() {
      const now = Date.now();
      const remaining = offerEndTimestamp - now;
      
      if (remaining <= 0) {
        // Offer expired - restart it
        resetOffer();
        return;
      }
      
      const timeString = formatCountdown(remaining);
      
      // Update all countdown elements
      if (countdownEl) countdownEl.textContent = timeString;
      if (preloginCountdownEl) preloginCountdownEl.textContent = timeString;
      if (heroCountdownEl) heroCountdownEl.textContent = timeString;
    }
    
    // Format currency
    function formatNaira(amount) {
      return 'â‚¦' + amount.toLocaleString();
    }
    
    // Calculate and update total for a plan
    function updatePlanTotal(planName) {
      const plan = PLANS[planName];
      if (!plan) return;
      
      const applyOfferCheckbox = document.getElementById(planName + 'ApplyOffer');
      const totalEl = document.getElementById(planName + 'Total');
      const buyLink = document.getElementById(planName + 'BuyLink');
      
      if (!totalEl) return;
      
      const applyOffer = applyOfferCheckbox ? applyOfferCheckbox.checked : false;
      const basePrice = applyOffer ? plan.offerPrice : plan.fullPrice;
      
      let addonPrice = 0;
      let addonParams = [];
      
      // Handle Business plan tax accountant addon
      if (planName === 'business') {
        const taxAccountantCheckbox = document.getElementById('businessHireTaxAccountant');
        if (taxAccountantCheckbox && taxAccountantCheckbox.checked) {
          addonPrice += plan.taxAccountantPrice;
          addonParams.push({ type: 'tax-accountant', price: plan.taxAccountantPrice });
        }
        const bookkeepingCheckbox = document.getElementById('businessBookkeepingService');
        if (bookkeepingCheckbox && bookkeepingCheckbox.checked) {
          addonPrice += plan.bookkeepingPrice;
          addonParams.push({ type: 'bookkeeping', price: plan.bookkeepingPrice });
        }
      }
      
      // Handle Company plan tax accountant addon
      if (planName === 'company') {
        const taxAccountantCheckbox = document.getElementById('companyHireTaxAccountant');
        if (taxAccountantCheckbox && taxAccountantCheckbox.checked) {
          addonPrice += plan.taxAccountantPrice;
          addonParams.push({ type: 'tax-accountant', price: plan.taxAccountantPrice });
        }
        const bookkeepingCheckbox = document.getElementById('companyBookkeepingService');
        if (bookkeepingCheckbox && bookkeepingCheckbox.checked) {
          addonPrice += plan.bookkeepingPrice;
          addonParams.push({ type: 'bookkeeping', price: plan.bookkeepingPrice });
        }
      }
      
      // Handle Enterprise plan addons
      if (planName === 'enterprise') {
        const addonBusinessCheckbox = document.getElementById('enterpriseAddonBusiness');
        const addonCompanyCheckbox = document.getElementById('enterpriseAddonCompany');
        
        if (addonBusinessCheckbox && addonBusinessCheckbox.checked) {
          addonPrice += plan.addonBusinessPrice;
          addonParams.push({ type: 'business', price: plan.addonBusinessPrice });
        }
        if (addonCompanyCheckbox && addonCompanyCheckbox.checked) {
          addonPrice += plan.addonCompanyPrice;
          addonParams.push({ type: 'company', price: plan.addonCompanyPrice });
        }
      }
      
      const total = basePrice + addonPrice;
      
      totalEl.textContent = formatNaira(total);
      
      // Update buy link with current price
      if (buyLink) {
        try {
          const url = new URL(plan.buyLink);
          url.searchParams.set('plan', planName);
          url.searchParams.set('price', total);
          if (addonParams.length > 0) {
            url.searchParams.set('addons', JSON.stringify(addonParams));
          }
          buyLink.href = url.toString();
          buyLink.setAttribute('target', '_blank');
          buyLink.setAttribute('rel', 'noopener noreferrer');
        } catch (e) {
          // Fallback if URL parsing fails
          buyLink.href = plan.buyLink + '?plan=' + encodeURIComponent(planName) + '&price=' + total;
          buyLink.setAttribute('target', '_blank');
          buyLink.setAttribute('rel', 'noopener noreferrer');
        }
      }
    }
    
    // Update all plan totals
    function updateAllTotals() {
      ['business', 'company', 'enterprise', 'enterprisePlus'].forEach(updatePlanTotal);
    }
    
    // Wire up event listeners for checkboxes
    function initCheckboxListeners() {
      ['business', 'company', 'enterprise', 'enterprisePlus'].forEach(function(plan) {
        const applyOfferCheckbox = document.getElementById(plan + 'ApplyOffer');
        
        if (applyOfferCheckbox) {
          applyOfferCheckbox.addEventListener('change', function() {
            updatePlanTotal(plan);
          });
        }
      });
      
      // Add listener for Business plan tax accountant checkbox
      const businessTaxAccountant = document.getElementById('businessHireTaxAccountant');
      if (businessTaxAccountant) {
        businessTaxAccountant.addEventListener('change', function() {
          updatePlanTotal('business');
        });
      }
      
      // Add listener for Business plan bookkeeping checkbox
      const businessBookkeeping = document.getElementById('businessBookkeepingService');
      if (businessBookkeeping) {
        businessBookkeeping.addEventListener('change', function() {
          updatePlanTotal('business');
        });
      }
      
      // Add listener for Company plan tax accountant checkbox
      const companyTaxAccountant = document.getElementById('companyHireTaxAccountant');
      if (companyTaxAccountant) {
        companyTaxAccountant.addEventListener('change', function() {
          updatePlanTotal('company');
        });
      }
      
      // Add listener for Company plan bookkeeping checkbox
      const companyBookkeeping = document.getElementById('companyBookkeepingService');
      if (companyBookkeeping) {
        companyBookkeeping.addEventListener('change', function() {
          updatePlanTotal('company');
        });
      }
      
      // Add listeners for Enterprise plan addon checkboxes
      const enterpriseAddonBusiness = document.getElementById('enterpriseAddonBusiness');
      const enterpriseAddonCompany = document.getElementById('enterpriseAddonCompany');
      
      if (enterpriseAddonBusiness) {
        enterpriseAddonBusiness.addEventListener('change', function() {
          updatePlanTotal('enterprise');
        });
      }
      
      if (enterpriseAddonCompany) {
        enterpriseAddonCompany.addEventListener('change', function() {
          updatePlanTotal('enterprise');
        });
      }
    }
    
    // Initialize
    updateCountdown();
    setInterval(updateCountdown, 1000);
    initCheckboxListeners();
    updateAllTotals();
    
    // Hero self-filing plan dropdown handler
    const heroSelfFilingPlan = document.getElementById('heroSelfFilingPlan');
    const heroBuyNowLink = document.getElementById('heroBuyNowLink');
    
    if (heroSelfFilingPlan && heroBuyNowLink) {
      heroSelfFilingPlan.addEventListener('change', function() {
        const selectedOption = heroSelfFilingPlan.options[heroSelfFilingPlan.selectedIndex];
        const plan = selectedOption.value;
        const price = selectedOption.getAttribute('data-price') || '20000';
        
        // Update Buy Now link with selected plan
        heroBuyNowLink.href = 'https://paystack.shop/pay/selffiling?plan=' + encodeURIComponent(plan) + '&price=' + encodeURIComponent(price);
      });
    }
  })();

  // Signup modal cancel handler only - submit is handled by defensive handler above
  (function initSignupModalCancel() {
    const signupModal = document.getElementById('signupModal');
    const signupCancel = document.getElementById('signupCancel');
    const preLoginOverlay = document.getElementById('preLoginOverlay');
    
    if (!signupModal) return;
    
    if (signupCancel) {
      signupCancel.addEventListener('click', function() {
        closeModal(signupModal);
        // Show pre-login overlay again since user didn't complete signup
        if (preLoginOverlay && (!state || !state.auth || !state.auth.currentUserId)) {
          preLoginOverlay.classList.remove('hidden');
        }
      });
    }
  })();
  
  // Temporary storage for signup flow
  let pendingSignupUserId = null;
  
  /**
   * Shows entity selection modal after signup.
   * Blocks access to the app until user selects an entity type.
   * @param {string} userId - The new user's ID
   * @param {string} preselectedPlan - The plan selected during signup
   */
  function showEntitySelectModal(userId, preselectedPlan) {
    pendingSignupUserId = userId;
    
    const entitySelectModal = document.getElementById('entitySelectModal');
    const entitySelectType = document.getElementById('entitySelectType');
    const preLoginOverlay = document.getElementById('preLoginOverlay');
    
    if (!entitySelectModal || !entitySelectType) {
      // Fallback: create business directly without modal
      createBusinessForUser(userId, preselectedPlan || 'Business');
      completeSignupFlow(userId);
      return;
    }
    
    // Hide prelogin overlay to show entity select modal on plain background
    if (preLoginOverlay) {
      preLoginOverlay.classList.add('hidden');
    }
    
    // Pre-select based on signup plan
    entitySelectType.value = preselectedPlan || 'Business';
    
    // Block page leaving with beforeunload (user must confirm entity)
    window.addEventListener('beforeunload', blockPageLeaveUntilEntitySelected);
    
    openModal(entitySelectModal);
  }
  
  /**
   * Prevents leaving the page until entity is selected.
   */
  function blockPageLeaveUntilEntitySelected(e) {
    if (pendingSignupUserId) {
      e.preventDefault();
      e.returnValue = 'You must select an entity type before leaving. Your account will not be fully set up.';
      return e.returnValue;
    }
  }
  
  /**
   * Completes the signup flow after entity selection.
   * @param {string} userId - The user's ID
   */
  function completeSignupFlow(userId) {
    updateAuthUI();
    refreshSelectors();
    ensureSelection();
    renderAll();
    
    // Show video tour modal for the new user
    const user = state.users.find(u => u.id === userId);
    if (user && !user.tourSeen) {
      showTourModal(userId);
    }
  }
  
  // Entity selection modal handlers
  (function initEntitySelectModal() {
    const entitySelectModal = document.getElementById('entitySelectModal');
    const entitySelectConfirm = document.getElementById('entitySelectConfirm');
    const entitySelectType = document.getElementById('entitySelectType');
    
    if (!entitySelectModal || !entitySelectConfirm) return;
    
    entitySelectConfirm.addEventListener('click', function() {
      if (!pendingSignupUserId) {
        closeModal(entitySelectModal);
        return;
      }
      
      const entityType = entitySelectType ? entitySelectType.value : 'Business';
      
      // Create default business for the user
      const bizId = createBusinessForUser(pendingSignupUserId, entityType);
      
      // Set as selected business
      if (bizId) {
        selectedBizId = bizId;
        selectedUserId = pendingSignupUserId;
      }
      
      closeModal(entitySelectModal);
      
      // Remove the beforeunload block
      window.removeEventListener('beforeunload', blockPageLeaveUntilEntitySelected);
      
      // Complete signup flow
      completeSignupFlow(pendingSignupUserId);
      pendingSignupUserId = null;
    });
  })();
  
  // Video tour modal handlers
  (function initVideoTourModal() {
    const videoTourModal = document.getElementById('videoTourModal');
    const videoTourSkip = document.getElementById('videoTourSkip');
    const videoTourWatch = document.getElementById('videoTourWatch');
    
    if (!videoTourModal) return;
    
    if (videoTourSkip) {
      videoTourSkip.addEventListener('click', function() {
        const userId = state.auth.currentUserId;
        closeTourModal(userId, 'skip');
      });
    }
    
    if (videoTourWatch) {
      videoTourWatch.addEventListener('click', function() {
        const userId = state.auth.currentUserId;
        closeTourModal(userId, 'watch');
      });
    }
  })();

  // Forgot password modal handlers
  (function initForgotModal() {
    const forgotModal = document.getElementById('forgotModal');
    const forgotCancel = document.getElementById('forgotCancel');
    const forgotSubmit = document.getElementById('forgotSubmit');
    const forgotEmail = document.getElementById('forgotEmail');
    const forgotMsg = document.getElementById('forgotMsg');
    const forgotNoteFirebase = document.getElementById('forgotNoteFirebase');
    const forgotNoteLocal = document.getElementById('forgotNoteLocal');
    
    if (!forgotModal) return;
    
    // Update UI based on Firebase availability
    function updateForgotModalUI() {
      if (typeof isFirebaseAuthEnabled === 'function' && isFirebaseAuthEnabled()) {
        if (forgotNoteFirebase) forgotNoteFirebase.style.display = 'block';
        if (forgotNoteLocal) forgotNoteLocal.style.display = 'none';
      } else {
        if (forgotNoteFirebase) forgotNoteFirebase.style.display = 'none';
        if (forgotNoteLocal) forgotNoteLocal.style.display = 'block';
      }
    }
    
    // Update UI initially and expose function globally for modal open
    updateForgotModalUI();
    window.updateForgotModalUI = updateForgotModalUI;
    
    if (forgotCancel) {
      forgotCancel.addEventListener('click', function() {
        if (forgotEmail) forgotEmail.value = '';
        if (forgotMsg) forgotMsg.textContent = '';
        closeModal(forgotModal);
      });
    }
    
    if (forgotSubmit) {
      forgotSubmit.addEventListener('click', async function() {
        const email = (forgotEmail && forgotEmail.value) ? forgotEmail.value.trim().toLowerCase() : '';
        
        if (!email) {
          if (forgotMsg) { forgotMsg.textContent = 'Please enter your email address.'; forgotMsg.style.color = '#b00'; }
          return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          if (forgotMsg) { forgotMsg.textContent = 'Please enter a valid email address.'; forgotMsg.style.color = '#b00'; }
          return;
        }
        
        // Use Firebase password reset if available
        if (typeof isFirebaseAuthEnabled === 'function' && isFirebaseAuthEnabled()) {
          if (forgotMsg) { forgotMsg.textContent = 'Sending reset link...'; forgotMsg.style.color = 'var(--muted)'; }
          
          const result = await firebaseSendPasswordReset(email);
          
          if (result.success) {
            if (forgotMsg) { forgotMsg.textContent = 'Password reset email sent! Check your inbox.'; forgotMsg.style.color = 'green'; }
            addAudit('user.forgot_password_firebase', 'auth', null, 'Firebase password reset email sent to: ' + email);
            
            // Clear form and close modal after delay
            setTimeout(function() {
              if (forgotEmail) forgotEmail.value = '';
              if (forgotMsg) forgotMsg.textContent = '';
              closeModal(forgotModal);
            }, 2500);
          } else {
            if (forgotMsg) { forgotMsg.textContent = result.error || 'Failed to send reset email.'; forgotMsg.style.color = '#b00'; }
          }
        } else {
          // Fallback to local behavior
          // Check if user exists with this email
          const user = state.users.find(function(u) { return u.email === email; });
          if (!user) {
            if (forgotMsg) { forgotMsg.textContent = 'No account found with this email.'; forgotMsg.style.color = '#b00'; }
            return;
          }
          
          addAudit('user.forgot_password', 'user', user.id, 'Password reset requested for: ' + email);
          
          if (forgotMsg) { 
            forgotMsg.textContent = 'Reset request logged. Please contact your admin or salesrepng@gmail.com.'; 
            forgotMsg.style.color = 'green'; 
          }
          
          // Clear form and close modal after delay
          setTimeout(function() {
            if (forgotEmail) forgotEmail.value = '';
            if (forgotMsg) forgotMsg.textContent = '';
            closeModal(forgotModal);
          }, 3000);
        }
      });
    }
  })();

  // Contact Edit Modal handlers
  (function initContactEditModal() {
    const contactEditModal = document.getElementById('contactEditModal');
    const contactEditCancel = document.getElementById('contactEditCancel');
    const contactEditSave = document.getElementById('contactEditSave');
    const contactEditType = document.getElementById('contactEditType');
    const contactDeductionsSection = document.getElementById('contactDeductionsSection');
    
    if (!contactEditModal) return;
    
    // Toggle deductions section based on contact type
    if (contactEditType) {
      contactEditType.addEventListener('change', function() {
        const showDeductions = (contactEditType.value === 'Employee' || contactEditType.value === 'SoleTrader');
        if (contactDeductionsSection) {
          contactDeductionsSection.style.display = showDeductions ? 'block' : 'none';
        }
      });
    }
    
    if (contactEditCancel) {
      contactEditCancel.addEventListener('click', function() {
        // Hide Annual Statutory Deductions section when closing modal
        const annualStatutoryDeductionsSection = document.getElementById('annualStatutoryDeductionsSection');
        if(annualStatutoryDeductionsSection) {
          annualStatutoryDeductionsSection.style.display = 'none';
        }
        closeModal(contactEditModal);
      });
    }
    
    if (contactEditSave) {
      contactEditSave.addEventListener('click', function() {
        const contactId = document.getElementById('contactEditId').value;
        const contactName = document.getElementById('contactEditName').value.trim();
        const contactType = document.getElementById('contactEditType').value;
        
        if (!contactName) {
          alert('Please enter a contact name.');
          return;
        }
        
        const b = findBiz(selectedBizId);
        if (!b) {
          alert('Business not found.');
          return;
        }
        
        const contact = (b.contacts || []).find(c => c.id === contactId);
        if (!contact) {
          alert('Contact not found.');
          return;
        }
        
        // Update contact
        contact.name = contactName;
        contact.type = contactType;
        
        // Save deductions if Employee or SoleTrader
        if (contactType === 'Employee' || contactType === 'SoleTrader') {
          contact.deductions = {
            pension: Number(document.getElementById('contactDedPension').value || 0),
            rent: Number(document.getElementById('contactDedRent').value || 0),
            life: Number(document.getElementById('contactDedLife').value || 0),
            mortgage: Number(document.getElementById('contactDedMortgage').value || 0),
            nhf: Number(document.getElementById('contactDedNHF').value || 0),
            nhis: Number(document.getElementById('contactDedNHIS').value || 0)
          };
        } else {
          // Clear deductions for non-employee/non-soletrader contacts
          contact.deductions = null;
        }
        
        saveState();
        addAudit('contact.update', 'contact', contactId, 'Updated contact: ' + contactName);
        
        // Refresh contacts list and close modal
        renderBizContacts(b);
        
        // Hide Annual Statutory Deductions section when closing modal
        const annualStatutoryDeductionsSection = document.getElementById('annualStatutoryDeductionsSection');
        if(annualStatutoryDeductionsSection) {
          annualStatutoryDeductionsSection.style.display = 'none';
        }
        
        closeModal(contactEditModal);
        
        // Refresh reports if on reports tab
        if (activeTab === 'reports') {
          refreshAllReports();
        }
      });
    }
  })();

  </script>
</body>
  </html>
