<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT & WHT (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(720px,96vw);}
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    pre.small { font-size:0.85rem; white-space:pre-wrap; }
    .nowrap { white-space:nowrap; }
    table.report { border-collapse:collapse; width:100%; }
    table.report th, table.report td { border:1px solid #ddd; padding:8px; text-align:left; }
    table.report th { background:#f2f6fa; }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT & WHT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <!-- ... The rest of the HTML remains unchanged ... -->

  <!-- At the bottom, right before </body>, insert or replace your <script> section: -->
  <script>
    // --- Unchanged code (state, helpers, UI, data load, etc) ---
    // ... (all your previous code up to "calculateSummary" and report handler) ...

    // --- REPLACE calculateSummary FUNCTION with this: ---
    function calculateSummary(){
      const b = findBiz(selectedBusinessId);
      if (!b) { vatSummaryDiv.innerHTML = ''; taxSummaryDiv.innerHTML = ''; totalsSummaryDiv.innerHTML = ''; return; }
      const txns = (data.transactions[b.id] || []);
      let totalIncome = 0, totalExpense = 0, totalWht = 0, outputVAT = 0, payroll = 0;
      let vatRate = b.vatEnabled ? (b.vatRate || 7.5) : 0;
      for (const t of txns) {
        const account = findAccount(b.id, t.accountId);
        if (!account) continue;
        if (account.type === 'Revenue') {
          totalIncome += t.amount;
          if (b.vatEnabled) outputVAT += t.amount * vatRate / 100;
        }
        if (account.type === 'Expense') totalExpense += t.amount;
        if (t.whtAmount) totalWht += t.whtAmount;
        // PAYE sum
        const contact = findContact(b.id, t.contactId);
        if (contact && contact.type === "Employee") payroll += t.amount;
      }
      const netProfit = totalIncome - totalExpense;
      // PIT on net profit (business owner)
      const threshold = b.threshold || 800000;
      const pit = b.pit || {
        threshold: 800000,
        slices: [
          { upTo: 3000000, rate: 0.15 },
          { upTo: 12000000, rate: 0.18 },
          { upTo: 25000000, rate: 0.21 },
          { upTo: 50000000, rate: 0.23 },
          { upTo: Infinity, rate: 0.25 }
        ]
      };
      const profitTaxable = Math.max(0, netProfit - threshold);
      let pitOnProfit = 0;
      let profitLeft = profitTaxable;
      let prevLimit = 0;
      for (const slice of pit.slices) {
        const slab = Math.min(profitLeft, slice.upTo - prevLimit);
        if (slab > 0) pitOnProfit += slab * slice.rate;
        profitLeft -= slab;
        prevLimit = slice.upTo;
        if (profitLeft <= 0) break;
      }
      // PAYE (payroll PIT)
      let payrollPIT = 0;
      if (payroll > 0) {
        let taxable = Math.max(0, payroll - threshold);
        let left = taxable, prev = 0;
        for (const slice of pit.slices) {
          const slab = Math.min(left, slice.upTo - prev);
          if (slab > 0) payrollPIT += slab * slice.rate;
          left -= slab;
          prev = slice.upTo;
          if (left <= 0) break;
        }
      }
      vatSummaryDiv.innerHTML = `<strong>VAT (Output, Revenue):</strong> ₦${formatMoney(outputVAT)}`;
      taxSummaryDiv.innerHTML = `
        <strong>PIT on Net Profit:</strong> ₦${formatMoney(pitOnProfit)}<br/>
        <strong>PAYE (Payroll PIT):</strong> ₦${formatMoney(payrollPIT)}
      `;
      totalsSummaryDiv.innerHTML = `
        <strong>Total Income:</strong> ₦${formatMoney(totalIncome)}<br/>
        <strong>Total Expenses:</strong> ₦${formatMoney(totalExpense)}<br/>
        <strong>Net Profit:</strong> ₦${formatMoney(netProfit)}<br/>
        <strong>Total WHT:</strong> ₦${formatMoney(totalWht)}
      `;
    }

    // --- REPLACE REPORT GENERATION HANDLER with this: ---
    btnGenerateReport.addEventListener('click', ()=>{
      const b = findBiz(selectedBusinessId);
      if (!b) { reportOutput.innerHTML = '<div class="muted">No business selected.</div>'; return; }
      const type = reportType.value;
      const from = reportDateFrom.value;
      const to = reportDateTo.value;
      // Filter transactions in date range
      const txns = (data.transactions[b.id] || []).filter(txn=>{
        if (from && txn.date < from) return false;
        if (to && txn.date > to) return false;
        return true;
      });
      let html = '';
      let totalIncome = 0, totalExpense = 0, totalWht = 0, outputVAT = 0, payroll = 0;
      let vatRate = b.vatEnabled ? (b.vatRate || 7.5) : 0;
      for (const t of txns) {
        const account = findAccount(b.id, t.accountId);
        if (!account) continue;
        if (account.type === 'Revenue') {
          totalIncome += t.amount;
          if (b.vatEnabled) outputVAT += t.amount * vatRate / 100;
        }
        if (account.type === 'Expense') totalExpense += t.amount;
        if (t.whtAmount) totalWht += t.whtAmount;
        // PAYE sum
        const contact = findContact(b.id, t.contactId);
        if (contact && contact.type === "Employee") payroll += t.amount;
      }
      const netProfit = totalIncome - totalExpense;
      const threshold = b.threshold || 800000;
      const pit = b.pit || {
        threshold: 800000,
        slices: [
          { upTo: 3000000, rate: 0.15 },
          { upTo: 12000000, rate: 0.18 },
          { upTo: 25000000, rate: 0.21 },
          { upTo: 50000000, rate: 0.23 },
          { upTo: Infinity, rate: 0.25 }
        ]
      };
      // PIT on profit
      let pitOnProfit = 0, profitTaxable = Math.max(0, netProfit - threshold), profitLeft = profitTaxable, prevLimit = 0;
      for (const slice of pit.slices) {
        const slab = Math.min(profitLeft, slice.upTo - prevLimit);
        if (slab > 0) pitOnProfit += slab * slice.rate;
        profitLeft -= slab;
        prevLimit = slice.upTo;
        if (profitLeft <= 0) break;
      }
      // PAYE (payroll PIT)
      let payrollPIT = 0;
      if (payroll > 0) {
        let taxable = Math.max(0, payroll - threshold);
        let left = taxable, prev = 0;
        for (const slice of pit.slices) {
          const slab = Math.min(left, slice.upTo - prev);
          if (slab > 0) payrollPIT += slab * slice.rate;
          left -= slab;
          prev = slice.upTo;
          if (left <= 0) break;
        }
      }
      if (type === 'vat') {
        html = `<h3>VAT Report</h3>
          <table class="report">
            <tr><th>Output VAT (on Revenue)</th><td>₦${formatMoney(outputVAT)}</td></tr>
          </table>`;
      } else if (type === 'paye') {
        html = `<h3>PAYE (Payroll PIT) Report</h3>
          <table class="report">
            <tr><th>Total Payroll</th><td>₦${formatMoney(payroll)}</td></tr>
            <tr><th>PIT (PAYE) Due</th><td>₦${formatMoney(payrollPIT)}</td></tr>
          </table>`;
      } else if (type === 'profit') {
        html = `<h3>Net Profit and Taxes Report</h3>
          <table class="report">
            <tr><th>Total Income</th><td>₦${formatMoney(totalIncome)}</td></tr>
            <tr><th>Total Expenses</th><td>₦${formatMoney(totalExpense)}</td></tr>
            <tr><th>Net Profit</th><td>₦${formatMoney(netProfit)}</td></tr>
            <tr><th>PIT on Profit</th><td>₦${formatMoney(pitOnProfit)}</td></tr>
            <tr><th>Output VAT</th><td>₦${formatMoney(outputVAT)}</td></tr>
            <tr><th>PAYE (Payroll PIT)</th><td>₦${formatMoney(payrollPIT)}</td></tr>
          </table>`;
      } else if (type === 'wht') {
        html = `<h3>Withholding Tax (WHT) Report</h3>
          <table class="report">
            <tr><th>Total WHT</th><td>₦${formatMoney(totalWht)}</td></tr>
          </table>`;
      } else {
        html = `<div class="muted">Unknown report type.</div>`;
      }
      reportOutput.innerHTML = html;
      lastReport = { type, from, to, reportHtml: html };
    });

    // --- Ensure formatMoney function exists! ---
    function formatMoney(v){ return (Number(v)||0).toLocaleString('en-NG', {maximumFractionDigits:2, minimumFractionDigits:0}); }
  </script>
</body>
</html>
