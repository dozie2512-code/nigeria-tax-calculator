GitHub Copilot Chat Assistant

Below is a quick-fix patched index.html that removes the "[...]" corruption and adds small safe stubs so the page loads and basic UI works. Replace your current index.html with this content.

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Multi-User Accounting & Tax — Full Prototype</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; --panel:#fff; }
    html,body { height:100%; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:12px; color:#222; background:var(--bg); }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:var(--panel); border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(1100px,95%); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:260px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .muted-pill { background:#f2f4f7; padding:4px 8px; border-radius:6px; font-size:0.9rem; color:#333; }
    .disabled { opacity:0.45; pointer-events:none; }
    .code { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#f3f5f7; padding:4px 6px; border-radius:4px; }
  </style>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax Engine — Prototype</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnExport" class="small">Export JSON</button>
        <button id="btnImport" class="small">Import JSON</button>
        <button id="btnClearAll" class="small danger">Clear All</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;" />
      </div>
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
            <option value="BankPayment">Bank Payment</option>
            <option value="BankReceipt">Bank Receipt</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label id="txnVatLabel">VAT:
          <select id="txnVatType">
            <option value="none">None</option>
            <option value="exclusive">VAT (exclusive)</option>
            <option value="inclusive">VAT (inclusive)</option>
          </select>
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtBasisLabel" style="display:none;">Basis:
          <select id="txnWhtBasis">
            <option value="gross">Gross</option>
            <option value="net">Net</option>
          </select>
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label" id="txnPayeLabel">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>Contact: <input type="text" id="txnContact" placeholder="Contact name" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>

          <label id="invVatLabel">VAT:
            <select id="invVatType">
              <option value="none">None</option>
              <option value="exclusive">VAT (exclusive)</option>
              <option value="inclusive">VAT (inclusive)</option>
            </select>
          </label>

          <label>Contact: <input type="text" id="invContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small primary">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>

          <label>Classification:
            <select id="assetClassification">
              <option value="Fixed">Fixed</option>
              <option value="Chargeable">Chargeable</option>
            </select>
          </label>

          <label>Depreciation rate % (annual): <input type="number" id="assetDepRate" class="smallInput" min="0" step="0.01" /></label>

          <label>Contact: <input type="text" id="assetContact" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small primary">Record Asset Purchase</button>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days. Capital allowance applied monthly from purchase.</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Contact</th><th>Receipt</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="plSnapshot" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable/Receivable</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Fixed Assets Report</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
        <button id="btnExportXlsx" class="small">Export XLSX (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshotQuick" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <!-- User modal -->
  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <!-- Business modal -->
  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE / PIT)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
        <small class="note">If you set statutory deductions on a contact (SoleTrader), that will override these values for PIT.</small>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList" style="max-height:160px; overflow:auto;"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
            <option value="SoleTrader">SoleTrader</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Add a contact with type "SoleTrader" (or name "Sole trader") and set statutory deductions there if you want PIT to use per-sole-trader deductions.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <!-- Accounts modal -->
  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="max-height:360px; overflow:auto;"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountDisallowable" /> Disallowable</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="newAccountNonTax" /> Non-taxable</label>
      <select id="newAccountRentFreq">
        <option value="">Rent freq</option>
        <option value="monthly">Monthly rent</option>
        <option value="yearly">Yearly rent</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <footer class="muted" style="margin-top:16px;">GitHub Copilot Chat Assistant — prototype stores data in localStorage (ntc_full_accounting_v1)</footer>

  <script>
  /************************************************************************
   * Quick-fix: remove corrupted fragments and provide safe stubs so the
   * page is syntactically valid and minimally functional for demo.
   ************************************************************************/

  // Constants & defaults
  const STORAGE_KEY = 'ntc_full_accounting_v1';
  const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true, caRateDefault:20.0, depRateDefault:20.0 };
  const PAYE_BANDS = [
    { upTo: 800000, rate: 0.00 },
    { upTo: 3000000, rate: 0.15 },
    { upTo: 12000000, rate: 0.18 },
    { upTo: 25000000, rate: 0.21 },
    { upTo: 50000000, rate: 0.23 },
    { upTo: Infinity, rate: 0.25 }
  ];
  const CIT_TURNOVER_THRESHOLD = 50000000; // 50,000,000

  // App state
  let state = {
    users: [], businesses: [], transactions: {}, attachments: {}, audit: [], auth: { currentUserId: null },
  };
  let selectedUserId = null;
  let selectedBizId = null;
  let activeTab = 'ledger';
  let inventoryHistory = [];
  let assetHistory = [];

  // DOM refs
  const userSelect = document.getElementById('userSelect');
  const businessSelect = document.getElementById('businessSelect');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnEditUser = document.getElementById('btnEditUser');
  const btnDeleteUser = document.getElementById('btnDeleteUser');
  const btnAddBusiness = document.getElementById('btnAddBusiness');
  const btnEditBusiness = document.getElementById('btnEditBusiness');
  const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
  const btnManageAccounts = document.getElementById('btnManageAccounts');

  const txnDate = document.getElementById('txnDate');
  const txnAction = document.getElementById('txnAction');
  const txnAccount = document.getElementById('txnAccount');
  const txnDesc = document.getElementById('txnDesc');
  const txnAmount = document.getElementById('txnAmount');
  const txnVatType = document.getElementById('txnVatType');
  const txnWht = document.getElementById('txnWht');
  const txnWhtBasis = document.getElementById('txnWhtBasis');
  const txnWhtBasisLabel = document.getElementById('txnWhtBasisLabel');
  const txnWhtRate = document.getElementById('txnWhtRate');
  const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
  const txnSalary = document.getElementById('txnSalary');
  const txnPayeLabel = document.getElementById('txnPayeLabel');
  const txnContact = document.getElementById('txnContact');
  const txnReceipt = document.getElementById('txnReceipt');
  const btnAddTxn = document.getElementById('btnAddTxn');
  const mainTxnForm = document.getElementById('mainTxnForm');

  const inventorySubform = document.getElementById('inventorySubform');
  const invItemSelect = document.getElementById('invItemSelect');
  const invNewName = document.getElementById('invNewName');
  const invAccountSelect = document.getElementById('invAccountSelect');
  const invQty = document.getElementById('invQty');
  const invUnitPrice = document.getElementById('invUnitPrice');
  const invVatType = document.getElementById('invVatType');
  const invContact = document.getElementById('invContact');
  const invReceipt = document.getElementById('invReceipt');
  const btnAddInv = document.getElementById('btnAddInv');
  const btnInvCancel = document.getElementById('btnInvCancel');
  const btnInvUndo = document.getElementById('btnInvUndo');

  const assetSubform = document.getElementById('assetSubform');
  const assetName = document.getElementById('assetName');
  const assetCost = document.getElementById('assetCost');
  const assetPurchaseDate = document.getElementById('assetPurchaseDate');
  const assetLife = document.getElementById('assetLife');
  const assetCA = document.getElementById('assetCA');
  const assetDisposalDate = document.getElementById('assetDisposalDate');
  const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
  const btnAddAsset = document.getElementById('btnAddAsset');
  const btnDisposeAsset = document.getElementById('btnDisposeAsset');
  const btnAssetCancel = document.getElementById('btnAssetCancel');
  const btnAssetUndo = document.getElementById('btnAssetUndo');
  const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
  const assetDisposalAccount = document.getElementById('assetDisposalAccount');
  const assetClassification = document.getElementById('assetClassification');
  const assetDepRate = document.getElementById('assetDepRate');
  const assetContact = document.getElementById('assetContact');
  const assetReceipt = document.getElementById('assetReceipt');

  const ledgerTableBody = document.querySelector('#ledgerTable tbody');
  const taxSummaryDiv = document.getElementById('taxSummary');
  const plSnapshotDiv = document.getElementById('plSnapshot');
  const plSnapshotQuick = document.getElementById('plSnapshotQuick');

  const inventoryListDiv = document.getElementById('inventoryList');
  const assetListDiv = document.getElementById('assetList');

  const ledgerSection = document.getElementById('ledgerSection');
  const reportsSection = document.getElementById('reportsSection');
  const reportContent = document.getElementById('reportContent');

  const modalOverlay = document.getElementById('modalOverlay');
  const userModal = document.getElementById('userModal');
  const userModalTitle = document.getElementById('userModalTitle');
  const userName = document.getElementById('userName');
  const userDisplay = document.getElementById('userDisplay');
  const userRole = document.getElementById('userRole');
  const permView = document.getElementById('permView');
  const permEdit = document.getElementById('permEdit');
  const permDelete = document.getElementById('permDelete');
  const userSave = document.getElementById('userSave');
  const userCancel = document.getElementById('userCancel');

  const businessModal = document.getElementById('businessModal');
  const businessModalTitle = document.getElementById('businessModalTitle');
  const bizName = document.getElementById('bizName');
  const bizOwnerSelect = document.getElementById('bizOwner');
  const bizEntity = document.getElementById('bizEntity');
  const bizVat = document.getElementById('bizVat');
  const bizWht = document.getElementById('bizWht');
  const bizCit = document.getElementById('bizCit');
  const bizVatEnabled = document.getElementById('bizVatEnabled');
  const bizPitEnabled = document.getElementById('bizPitEnabled');
  const bizPayeEnabled = document.getElementById('bizPayeEnabled');
  const bizShowLines = document.getElementById('bizShowLines');
  const bizCitEnabled = document.getElementById('bizCitEnabled');
  const bizSave = document.getElementById('bizSave');
  const bizCancel = document.getElementById('bizCancel');
  const bizLossBF = document.getElementById('bizLossBF');
  const bizCACF = document.getElementById('bizCACF');
  const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
  const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
  const bizDedPension = document.getElementById('bizDedPension');
  const bizDedRent = document.getElementById('bizDedRent');
  const bizDedLife = document.getElementById('bizDedLife');
  const bizDedMortgage = document.getElementById('bizDedMortgage');
  const bizDedNHF = document.getElementById('bizDedNHF');
  const bizCapitalBF = document.getElementById('bizCapitalBF');
  const bizContactsList = document.getElementById('bizContactsList');
  const newContactName = document.getElementById('newContactName');
  const newContactType = document.getElementById('newContactType');
  const btnAddContact = document.getElementById('btnAddContact');

  const accountsModal = document.getElementById('accountsModal');
  const accountsList = document.getElementById('accountsList');
  const newAccountName = document.getElementById('newAccountName');
  const newAccountCategory = document.getElementById('newAccountCategory');
  const newAccountDisallowable = document.getElementById('newAccountDisallowable');
  const newAccountNonTax = document.getElementById('newAccountNonTax');
  const newAccountRentFreq = document.getElementById('newAccountRentFreq');
  const addAccountBtn = document.getElementById('addAccountBtn');
  const closeAccountsBtn = document.getElementById('closeAccountsBtn');

  const btnLedgerTab = document.getElementById('btnLedgerTab');
  const btnReportsTab = document.getElementById('btnReportsTab');

  // utilities
  function uid(prefix = 'id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
  function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function today(){ return new Date().toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
  function toISO(date){ if(!date) return null; return new Date(date).toISOString().slice(0,10); }
  function clone(o){ return JSON.parse(JSON.stringify(o)); }

  // find helpers
  function findUser(id){ return state.users.find(u => u.id === id) || null; }
  function findBiz(id){ return state.businesses.find(b => b.id === id) || null; }

  // load/save
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ seedDemo(); return; }
    try { state = JSON.parse(raw); migrateState(); }
    catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
  }
  function migrateState(){
    state.users = state.users || [];
    state.businesses = state.businesses || [];
    state.transactions = state.transactions || {};
    state.attachments = state.attachments || {};
    state.audit = state.audit || [];
    state.auth = state.auth || { currentUserId: null };
    state.businesses.forEach(b => {
      b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
      b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
      b.citRate = Number(b.citRate || DEFAULTS.citRate);
      b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
      b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
      b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
      b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
      b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
      b.accounts = b.accounts || [];
      b.inventory = b.inventory || [];
      b.assets = b.assets || [];
      b.contacts = b.contacts || [];
      b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
      b.lossBroughtForward = Number(b.lossBroughtForward || 0);
      b.caCarryForward = Number(b.caCarryForward || 0);
      b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
      b.defaultExpenseDisallowable = !!b.defaultExpenseDisallowable;
      b.defaultRevenueNonTax = !!b.defaultRevenueNonTax;
    });
    // ensure transactions map for each user and business
    for(const u of state.users){ state.transactions[u.id] = state.transactions[u.id] || {}; for(const b of state.businesses){ state.transactions[u.id][b.id] = state.transactions[u.id][b.id] || []; } }
    saveState();
  }

  function seedDemo(){
    const u = uid('user'), b = uid('biz');
    const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
    const rent = { id: uid('acct'), name: 'Rent', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false, rentFreq:'monthly' };
    const bank = { id: uid('acct'), name: 'Bank', category: 'Asset', disallowableDefault:false, nonTaxableDefault:false };
    const chargeInc = { id: uid('acct'), name: 'Chargeable asset income', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
    const chargeCost = { id: uid('acct'), name: 'Chargeable asset cost', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };

    state = {
      users: [{ id: u, username: 'admin', display:'Admin User', role:'Admin', isAdmin:true, permissions:{ view:true, edit:true, delete:true } }],
      businesses: [{
        id: b,
        name: 'Demo Business',
        ownerId: u,
        entity: 'Company',
        vatRate: DEFAULTS.vatRate,
        whtRate: DEFAULTS.whtRate,
        citRate: DEFAULTS.citRate,
        vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
        caRateDefault: DEFAULTS.caRateDefault,
        depRateDefault: DEFAULTS.depRateDefault,
        accounts: [sales, cogs, salaries, rent, bank, chargeInc, chargeCost],
        inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
        assets: [
          { id: uid('asset'), name: 'Office PC', cost: 150000, purchaseDate: today(), lifeYears: 5, caPercent: 20, depRate: 20, classification: 'Fixed', accumulatedDep:0, disposed:false },
          { id: uid('asset'), name: 'Land Plot', cost: 2000000, purchaseDate: '2020-01-01', lifeYears: 20, caPercent: 5, depRate: 0, classification: 'Chargeable', accumulatedDep:0, disposed:false }
        ],
        contacts: [{ id: uid('c'), name:'John Employee', type:'Employee', statutory:{ pension: 20000, rent: 120000, life: 5000, mortgage: 100000, nhf: 5000 } }],
        statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
        lossBroughtForward: 150000, caCarryForward: 50000, capitalBroughtForward: 0,
        defaultExpenseDisallowable:false, defaultRevenueNonTax:false,
        firsLabel: ''
      }],
      transactions: {},
      attachments: {},
      audit: [],
      auth: { currentUserId: u }
    };
    // initialize transactions map
    state.transactions[u] = {};
    state.transactions[u][b] = [
      // sample revenue (with VAT exclusive)
      { id: uid('txn'), date: today(), action: 'Revenue', accountId: sales.id, accountName: sales.name, accountCategory: sales.category, description: 'Demo sale', amount: 150000, vatType:'exclusive' },
      // sample salary (PAYE)
      { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, accountCategory: salaries.category, description: 'Demo salary', amount: 50000, vatType:'none', salary:true },
      // inventory purchase
      { id: uid('txn'), date: today(), action: 'InventoryPurchase', accountId: cogs.id, accountName: cogs.name, accountCategory: cogs.category, description: 'Purchase widgets', qty:50, unitPrice: 450.00, vatType:'exclusive' }
    ];
    addAudit('seed','system','',`Seeded demo data`);
    saveState();
  }

  // audit
  function addAudit(type, entityType, entityId, details){
    const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: state.auth.currentUserId, type, entityType, entityId, details };
    state.audit = state.audit || [];
    state.audit.push(entry);
    saveState();
  }

  // modal helpers
  function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
  function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
  modalOverlay.addEventListener('click', ()=> { [userModal, businessModal, accountsModal].forEach(m => { if(m.style.display==='block') closeModal(m); }); });

  // minimal UI & rendering stubs (quick-fix)
  function initUI(){
    // Basic tab toggles
    btnLedgerTab.addEventListener('click', ()=>{ activeTab='ledger'; btnLedgerTab.classList.add('active'); btnReportsTab.classList.remove('active'); ledgerSection.style.display='block'; reportsSection.style.display='none'; });
    btnReportsTab.addEventListener('click', ()=>{ activeTab='reports'; btnReportsTab.classList.add('active'); btnLedgerTab.classList.remove('active'); ledgerSection.style.display='none'; reportsSection.style.display='block'; });

    // selectors change
    userSelect.addEventListener('change', e => { selectedUserId = e.target.value; refreshSelectors(); renderAll(); });
    businessSelect.addEventListener('change', e => { selectedBizId = e.target.value; renderAll(); });

    // export/import/clear
    document.getElementById('btnExport').addEventListener('click', ()=> {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc_export.json'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
    document.getElementById('fileInput').addEventListener('change', function(e){ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = function(){ try{ state = JSON.parse(r.result); migrateState(); renderAll(); }catch(err){ alert('Invalid JSON'); } }; r.readAsText(f); });

    document.getElementById('btnClearAll').addEventListener('click', ()=> { if(confirm('Clear all local data?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } });

    // add txn
    btnAddTxn.addEventListener('click', e => {
      e.preventDefault();
      if(!selectedUserId || !selectedBizId){ alert('Select user and business'); return; }
      const acct = txnAccount.value || '';
      const acctName = txnAccount.options[txnAccount.selectedIndex] ? txnAccount.options[txnAccount.selectedIndex].text : '';
      const t = { id: uid('txn'), date: txnDate.value || today(), action: txnAction.value || 'Other', accountId: acct, accountName: acctName, description: txnDesc.value||'', amount: Number(txnAmount.value||0), vatType: txnVatType.value||'none', wht: txnWht.checked, salary: txnSalary.checked, contact: txnContact.value||'' };
      state.transactions[selectedUserId] = state.transactions[selectedUserId] || {};
      state.transactions[selectedUserId][selectedBizId] = state.transactions[selectedUserId][selectedBizId] || [];
      state.transactions[selectedUserId][selectedBizId].push(t);
      addAudit('txn','transaction', t.id, `Added txn ${t.description}`);
      saveState();
      resetForms();
      renderAll();
    });
  }

  function refreshSelectors(){
    // users
    userSelect.innerHTML = '';
    state.users.forEach(u => {
      const o = document.createElement('option'); o.value = u.id; o.textContent = u.display || u.username || u.id; userSelect.appendChild(o);
    });
    // businesses
    businessSelect.innerHTML = '';
    state.businesses.forEach(b => {
      const o = document.createElement('option'); o.value = b.id; o.textContent = b.name || b.id; businessSelect.appendChild(o);
    });
    // set selected values if available
    if(selectedUserId) userSelect.value = selectedUserId;
    if(selectedBizId) businessSelect.value = selectedBizId;
    // biz owner select
    if(bizOwnerSelect){
      bizOwnerSelect.innerHTML = '';
      state.users.forEach(u => { const o = document.createElement('option'); o.value = u.id; o.textContent = u.display || u.username; bizOwnerSelect.appendChild(o); });
    }
    populateAccountSelect();
    document.getElementById('authInfo').textContent = (findUser(selectedUserId) && findUser(selectedUserId).display) ? `Active: ${findUser(selectedUserId).display}` : '';
  }

  function ensureSelection(){
    if(!state.users.length || !state.businesses.length) return;
    selectedUserId = state.auth && state.auth.currentUserId ? state.auth.currentUserId : state.users[0].id;
    selectedBizId = selectedBizId || (state.businesses[0] && state.businesses[0].id);
    refreshSelectors();
  }

  function populateAccountSelect(){
    const b = findBiz(selectedBizId);
    const accounts = (b && b.accounts) ? b.accounts : [];
    function populate(el){
      if(!el) return;
      el.innerHTML = '';
      accounts.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.textContent = a.name; el.appendChild(o); });
    }
    populate(txnAccount);
    populate(invAccountSelect);
    populate(assetPurchaseAccount);
    populate(assetDisposalAccount);
  }

  function resetForms(){
    txnDate.value = today();
    txnAction.value = '';
    txnAccount.selectedIndex = 0;
    txnDesc.value = '';
    txnAmount.value = '';
    txnVatType.value = 'none';
    txnWht.checked = false;
    txnSalary.checked = false;
    txnContact.value = '';
  }

  function renderAll(){
    // ledger
    ledgerTableBody.innerHTML = '';
    if(selectedUserId && selectedBizId && state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]){
      const txns = state.transactions[selectedUserId][selectedBizId];
      txns.forEach(txn => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-txn-id', txn.id);
        tr.innerHTML = `<td>${escapeHtml(txn.date)}</td>
          <td>${escapeHtml(txn.action||'')}</td>
          <td>${escapeHtml(txn.accountName||'')}</td>
          <td>${escapeHtml(txn.description||'')}</td>
          <td style="text-align:right">₦${fmt(txn.amount||0)}</td>
          <td style="text-align:right">${escapeHtml(txn.vatType||'')}</td>
          <td style="text-align:right">${txn.wht ? 'Yes' : ''}</td>
          <td style="text-align:right">${fmt(Number(txn.payeAmount||0))}</td>
          <td>${escapeHtml(txn.contact||'')}</td>
          <td>${txn.receipt ? '<span class="link-like">View</span>' : ''}</td>
          <td><button class="small" data-id="${txn.id}">Del</button></td>`;
        ledgerTableBody.appendChild(tr);
        const delBtn = tr.querySelector('button');
        if(delBtn) delBtn.addEventListener('click', ()=> {
          if(confirm('Delete transaction?')){
            const arr = state.transactions[selectedUserId][selectedBizId];
            const idx = arr.findIndex(t => t.id === txn.id);
            if(idx >= 0) { arr.splice(idx,1); addAudit('delete','transaction', txn.id, 'Deleted txn'); saveState(); renderAll(); }
          }
        });
      });
    }

    // quick PL snapshot (very simplistic)
    let revenue = 0, expense = 0;
    try {
      const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
      txns.forEach(t => { if(t.accountCategory === 'Revenue') revenue += Number(t.amount||0); else if(t.accountCategory === 'Expense') expense += Number(t.amount||0); });
    } catch(e){}
    plSnapshotDiv.innerHTML = `<strong>Revenue:</strong> ₦${fmt(revenue)} &nbsp; <strong>Expenses:</strong> ₦${fmt(expense)} &nbsp; <strong>Profit:</strong> ₦${fmt(revenue-expense)}`;
    plSnapshotQuick.innerHTML = plSnapshotDiv.innerHTML;

    // inventory quick
    inventoryListDiv.innerHTML = '';
    const b = findBiz(selectedBizId);
    if(b && b.inventory){
      inventoryListDiv.innerHTML = b.inventory.map(i => `<div class="account-row"><div>${escapeHtml(i.name)}</div><div class="small-muted">Qty: ${i.qty} @ ₦${fmt(i.avgCost)}</div></div>`).join('');
    }

    // assets quick
    assetListDiv.innerHTML = '';
    if(b && b.assets){
      assetListDiv.innerHTML = b.assets.map(a => `<div class="account-row"><div>${escapeHtml(a.name)}</div><div class="small-muted">${escapeHtml(a.classification||'')} - Cost: ₦${fmt(a.cost)}</div></div>`).join('');
    }

    // tax summary placeholder
    taxSummaryDiv.innerHTML = '<div class="muted">Tax summary will appear here (quick-fix placeholder).</div>';
  }

  // small helpers
  function escapeHtml(s){
    if(!s && s !== 0) return '';
    return s.toString().replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  // initialization
  loadState();
  initUI();
  refreshSelectors();
  ensureSelection();
  populateAccountSelect();
  resetForms();
  renderAll();

  </script>

  <!-- Injected PAYE per-contact script (appended non-invasively) -->
  <script>
  (function(){
    // Safe-guard: only run if PAYE_BANDS exists
    try {
      if(typeof PAYE_BANDS === 'undefined') { console.warn('PAYE_BANDS not found; PAYE per-contact script disabled'); return; }
    } catch(e){ console.error(e); return; }

    function calcPAYEMarginal(annualTaxable){
      let paid = 0;
      let lower = 0;
      for(const band of PAYE_BANDS){
        const upper = band.upTo;
        const slice = Math.max(0, Math.min(upper, annualTaxable) - lower);
        if(slice > 0){
          paid += slice * (band.rate || 0);
        }
        lower = upper;
        if(annualTaxable <= upper) break;
      }
      return Number(paid || 0);
    }

    function findContactForTxn(biz, txn){
      if(!biz || !biz.contacts) return null;
      const name = (txn.contact || txn.contactName || txn.txnContact || '').trim().toLowerCase();
      if(!name) return null;
      return biz.contacts.find(c => (c.name || '').trim().toLowerCase() === name) || null;
    }

    function statutoryTotalForContactOrBiz(biz, contact){
      const st = (contact && contact.statutory) ? contact.statutory : (biz && biz.statutoryDeductions ? biz.statutoryDeductions : null);
      if(!st) return 0;
      return Number(st.pension||0) + Number(st.rent||0) + Number(st.life||0) + Number(st.mortgage||0) + Number(st.nhf||0);
    }

    function isPayrollTxn(txn){
      if(!txn) return false;
      if(txn.salary || txn.isSalary || txn.txnSalary || txn.isPayroll) return true;
      if(txn.accountName && (txn.accountName||'').toLowerCase().includes('salary')) return true;
      if(txn.description && (txn.description||'').toLowerCase().includes('salary')) return true;
      if(txn.action && (txn.action||'').toLowerCase().includes('salary')) return true;
      return false;
    }

    function computePAYEForTxn(txn, biz){
      try {
        if(!txn) return;
        if(!isPayrollTxn(txn)) return;
        const gross = Number(txn.amount || txn.gross || 0);
        const contact = findContactForTxn(biz, txn);
        const statutory = statutoryTotalForContactOrBiz(biz, contact);
        const taxable = Math.max(0, gross - statutory);
        const paye = calcPAYEMarginal(taxable);
        txn.payeGross = gross;
        txn.payeStatutory = statutory;
        txn.payeTaxable = taxable;
        txn.payeAmount = Number(paye || 0);
      } catch(e){
        console.error('PAYE compute failed for txn', txn, e);
      }
    }

    function computeAndAttachPAYE(){
      if(!selectedUserId || !selectedBizId) return;
      const userTxnsMap = state.transactions && state.transactions[selectedUserId];
      if(!userTxnsMap) return;
      const txns = userTxnsMap[selectedBizId] || [];
      const biz = findBiz(selectedBizId);
      let changed=false;
      for(const t of txns){
        const before = Number(t.payeAmount||0);
        computePAYEForTxn(t, biz);
        const after = Number(t.payeAmount||0);
        if(before !== after) changed = true;
      }
      if(changed) saveState();
    }

    function renderPAYESummary(){
      const biz = findBiz(selectedBizId);
      if(!biz) return;
      const userTxnsMap = state.transactions && state.transactions[selectedUserId];
      if(!userTxnsMap) return;
      const txns = userTxnsMap[selectedBizId] || [];

      const byContact = {};
      for(const t of txns){
        if(!isPayrollTxn(t)) continue;
        const contactName = (t.contact || t.contactName || t.txnContact || 'Unspecified').toString();
        const key = contactName || 'Unspecified';
        if(!byContact[key]) byContact[key] = { contact: key, gross:0, statutory:0, taxable:0, paye:0, pit: 0 };
        byContact[key].gross += Number(t.payeGross||0);
        byContact[key].statutory += Number(t.payeStatutory||0);
        byContact[key].taxable += Number(t.payeTaxable||0);
        byContact[key].paye += Number(t.payeAmount||0);
        byContact[key].pit += Number(t.pitAmount||0);
      }

      const rows = Object.values(byContact).map(v => {
        return `<tr>
          <td class="code">${escapeHtml(v.contact)}</td>
          <td style="text-align:right">₦${fmt(v.gross)}</td>
          <td style="text-align:right">₦${fmt(v.statutory)}</td>
          <td style="text-align:right">₦${fmt(v.taxable)}</td>
          <td style="text-align:right">₦${fmt(v.paye)}</td>
          <td style="text-align:right">₦${fmt(v.pit)}</td>
        </tr>`;
      }).join('');

      const totalGross = Object.values(byContact).reduce((s,v)=>s+v.gross,0);
      const totalStat = Object.values(byContact).reduce((s,v)=>s+v.statutory,0);
      const totalTaxable = Object.values(byContact).reduce((s,v)=>s+v.taxable,0);
      const totalPAYE = Object.values(byContact).reduce((s,v)=>s+v.paye,0);
      const totalPIT = Object.values(byContact).reduce((s,v)=>s+v.pit,0);

      const table = `<div style="margin-top:10px;">
        <h4 style="margin:6px 0 6px 0;">PAYE by Contact (separate from PIT)</h4>
        <div class="muted small-note">PAYE calculated on gross salary minus statutory deductions (per-contact if set, otherwise business defaults). Bands used: annual bands in app settings.</div>
        <table style="width:100%; border-collapse:collapse; margin-top:6px;">
          <thead>
            <tr style="background:#f2f6fa"><th>Contact</th><th style="text-align:right">Gross</th><th style="text-align:right">Statutory deductions</th><th style="text-align:right">Taxable</th><th style="text-align:right">PAYE</th><th style="text-align:right">PIT</th></tr>
          </thead>
          <tbody>
            ${rows}
            <tr style="font-weight:bold; background:#fbfcfe;">
              <td>Total</td>
              <td style="text-align:right">₦${fmt(totalGross)}</td>
              <td style="text-align:right">₦${fmt(totalStat)}</td>
              <td style="text-align:right">₦${fmt(totalTaxable)}</td>
              <td style="text-align:right">₦${fmt(totalPAYE)}</td>
              <td style="text-align:right">₦${fmt(totalPIT)}</td>
            </tr>
          </tbody>
        </table>
      </div>`;

      if(taxSummaryDiv){
        const existing = document.getElementById('__paye_summary_block');
        if(existing) existing.remove();
        const holder = document.createElement('div');
        holder.id = '__paye_summary_block';
        holder.innerHTML = table;
        taxSummaryDiv.appendChild(holder);
      }
    }

    // Wrap renderAll to compute/pay and render PAYE summary each time
    if(typeof renderAll === 'function'){
      const _origRenderAll = renderAll;
      renderAll = function(){
        _origRenderAll.apply(this, arguments);
        try {
          computeAndAttachPAYE();
          renderPAYESummary();
          try {
            const tbody = document.querySelector('#ledgerTable tbody');
            if(tbody){
              const ths = document.querySelectorAll('#ledgerTable thead th');
              let payeIndex = -1;
              ths.forEach((th,i)=>{ if((th.textContent||'').trim().toLowerCase() === 'paye') payeIndex = i; });
              if(payeIndex >= 0){
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.forEach(r=>{
                  const txnId = r.getAttribute('data-txn-id') || r.dataset.txnId;
                  let matchedTxn = null;
                  if(txnId){
                    const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
                    matchedTxn = txns.find(t=>t.id === txnId);
                  } else {
                    const descCell = r.cells[3];
                    if(descCell){
                      const desc = (descCell.textContent||'').trim();
                      const txns = (state.transactions[selectedUserId] && state.transactions[selectedUserId][selectedBizId]) || [];
                      matchedTxn = txns.find(t => (t.description||'').trim() === desc || (t.accountName||'').trim() === desc) || null;
                    }
                  }
                  if(matchedTxn){
                    const payeVal = Number(matchedTxn.payeAmount||0);
                    const cell = r.cells[payeIndex];
                    if(cell) cell.innerHTML = '₦' + fmt(payeVal);
                  }
                });
              }
            }
          } catch(e){}
        } catch(e){
          console.error('PAYE post-render failed', e);
        }
      };
    } else {
      setInterval(function(){
        if(typeof renderAll === 'function') return;
        computeAndAttachPAYE();
        renderPAYESummary();
      }, 2000);
    }

    setTimeout(function(){ try { computeAndAttachPAYE(); renderPAYESummary(); } catch(e){} }, 400);

  })();
  </script>

</body>
</html>

Notes
- This is a quick safety/syntactic fix: the large app logic was preserved where intact, but corrupted "[...]" fragments were removed and replaced by valid sample transactions and safe stubs (initUI, refreshSelectors, ensureSelection, populateAccountSelect, resetForms, renderAll).
- Behavior is intentionally conservative: the file will not implement the full original feature set but will load without syntax errors and allow adding simple transactions, viewing a ledger, exporting/importing JSON, and seeing quick inventory/assets snapshots.
- If you want, I can create a branch and open a pull request in your repository with this change. Would you like me to do that (and what branch name should I use)?
