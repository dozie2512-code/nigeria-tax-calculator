GitHub Copilot Chat Assistant — updated index.html below.

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(520px,96vw); }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>
        <label>Type:
          <select id="txnType">
            <option value="Income">Income (Sales)</option>
            <option value="Expense">Expense (Purchase)</option>
            <option value="Deduction">Deduction</option>
          </select>
        </label>
        <label>Category:
          <select id="txnCategory">
            <option>Pension</option>
            <option>NHF</option>
            <option>Insurance</option>
            <option>Salary</option>
            <option>Bonus</option>
            <option>Freelance</option>
            <option>Food</option>
            <option>Transport</option>
            <option>Rent</option>
            <option>Utilities</option>
            <option>Other</option>
          </select>
        </label>
        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved per selected user and business. VAT rate & tax rules are per business (editable in Business settings). Use the search & pagination controls below to filter and navigate transactions.</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/type/category/description/amount" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf; border-radius:4px;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Category</th>
            <th>Description</th>
            <th>Amount (₦)</th>
            <th>VAT (₦)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <!-- Reports Panel -->
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Reports</h2>
      <div class="form-inline" style="margin-bottom:12px;">
        <label>Start Date: <input type="date" id="reportStartDate" /></label>
        <label>End Date: <input type="date" id="reportEndDate" /></label>
        <label>Scope:
          <select id="reportScope">
            <option value="current">Current selection (user & business)</option>
            <option value="all">All users & businesses</option>
          </select>
        </label>
        <button class="primary" id="btnGenerateReport">Generate Report</button>
      </div>
      <small class="note">Select date range (leave empty for no limit) and scope to generate a comprehensive report showing Profit, VAT, and PAYE summaries.</small>
      
      <div id="reportOutput" style="display:none; margin-top:16px;">
        <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
          <button id="btnExportJSON" class="small">Export JSON</button>
          <button id="btnExportCSV" class="small">Export CSV</button>
          <button id="btnPrintableReport" class="small">Printable Report</button>
        </div>
        
        <div id="reportContent"></div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="userNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
    </div>
    <div class="row">
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (tax)</label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
    <small class="note">VAT & PIT toggles control whether VAT and personal income tax are computed for this business. VAT rate will be used to compute VAT per business. PIT logic defaults to Nigeria 2026 slices unless overridden programmatically.</small>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>
    <label>Type:
      <select id="editTxnType">
        <option value="Income">Income (Sales)</option>
        <option value="Expense">Expense (Purchase)</option>
        <option value="Deduction">Deduction</option>
      </select>
    </label><br/>
    <label>Category:
      <select id="editTxnCategory">
        <option>Pension</option>
        <option>NHF</option>
        <option>Insurance</option>
        <option>Salary</option>
        <option>Bonus</option>
        <option>Freelance</option>
        <option>Food</option>
        <option>Transport</option>
        <option>Rent</option>
        <option>Utilities</option>
        <option>Other</option>
      </select>
    </label><br/>
    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button onclick="closeEditModal()">Cancel</button>
      <button class="primary" onclick="saveEdit()">Save</button>
    </div>
  </div>

  <script>
    // GitHub Copilot Chat Assistant
    // Data model in localStorage key 'ntc_data_v1'
    const STORAGE_KEY = 'ntc_data_v1';

    // Default PIT slices (Nigeria 2026 used in original). Will be used by computeTax unless overridden.
    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },  // slice from threshold up to 3,000,000
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    // In-memory state
    let data = {
      users: [],
      businesses: [],
      transactions: {} // { userId: { businessId: [ txns ] } }
    };

    let selectedUserId = null;
    let selectedBusinessId = null;

    // Transaction edit state
    let editIndex = null;

    // Ledger UI state
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';
    let ledgerFiltered = []; // filtered txns used for pagination and summaries

    // Utilities
    function uid(prefix='id') { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }

    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          // basic validation
          if (parsed && typeof parsed === 'object') {
            data = parsed;
            if (!data.users) data.users = [];
            if (!data.businesses) data.businesses = [];
            if (!data.transactions) data.transactions = {};
            return;
          }
        } catch(e) {
          console.error('Invalid saved data', e);
        }
      }
      // initialize with a demo user and business if empty
      const userId = uid('user');
      const bizId = uid('biz');
      data = {
        users: [{ id: userId, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{ id: bizId, name: 'Demo Business', ownerId: userId, vatRate: 7.5, currency: '₦', threshold: 800000, notes: 'Sample business', vatEnabled: true, pitEnabled: true }],
        transactions: { [userId]: { [bizId]: [
          { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Income', category: 'Freelance', desc: 'Demo sale', amount: 1500000 },
          { id: uid('txn'), date: new Date().toISOString().slice(0,10), type: 'Expense', category: 'Rent', desc: 'Office rent', amount: 200000 }
        ] } }
      };
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }

    // UI wiring
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    // User modal elements
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userNotes = document.getElementById('userNotes');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    // Business modal elements
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwner = document.getElementById('bizOwner');
    const bizVat = document.getElementById('bizVat');
    const bizCurrency = document.getElementById('bizCurrency');
    const bizThreshold = document.getElementById('bizThreshold');
    const bizNotes = document.getElementById('bizNotes');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');

    // Edit transaction modal
    const editModal = document.getElementById('editModal');
    const editTxnDate = document.getElementById('editTxnDate');
    const editTxnType = document.getElementById('editTxnType');
    const editTxnCategory = document.getElementById('editTxnCategory');
    const editTxnDesc = document.getElementById('editTxnDesc');
    const editTxnAmount = document.getElementById('editTxnAmount');

    // Search & pagination UI
    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    // Export/Import UI
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // State for modals: editing vs adding
    let userEditingId = null;
    let bizEditingId = null;

    // Initialization
    loadData();
    refreshUserBusinessSelectors();
    ensureSelection();
    currentPage = 1;
    renderLedger();
    calculateSummary();

    // --- User & Business management functions ---
    function refreshUserBusinessSelectors() {
      // Users
      userSelect.innerHTML = '';
      data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = (u.display || u.username) + ' (' + u.username + ')';
        userSelect.appendChild(opt);
      });
      // Businesses
      businessSelect.innerHTML = '';
      data.businesses.forEach(b => {
        const owner = findUser(b.ownerId);
        const enabledParts = [];
        if (b.vatEnabled) enabledParts.push('VAT');
        if (b.pitEnabled) enabledParts.push('PIT');
        const status = enabledParts.length ? ' — ' + enabledParts.join('/') : '';
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name} ${owner ? ' — ' + (owner.display || owner.username) : ''} (${b.vatRate}% VAT)${status}`;
        businessSelect.appendChild(opt);
      });
      // populate bizOwner select for business modal
      bizOwner.innerHTML = '';
      data.users.forEach(u => {
        const o = document.createElement('option');
        o.value = u.id;
        o.textContent = (u.display || u.username);
        bizOwner.appendChild(o);
      });

      // set selected values if still available, else pick first
      if (!data.users.find(u=>u.id===selectedUserId)) selectedUserId = data.users.length ? data.users[0].id : null;
      if (!data.businesses.find(b=>b.id===selectedBusinessId)) selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;

      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function ensureSelection() {
      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length) selectedBusinessId = data.businesses[0].id;
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function openModal(modal) {
      modalOverlay.style.display = 'block';
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal) {
      modalOverlay.style.display = 'none';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      // clear editing state
      userEditingId = null;
      bizEditingId = null;
    }

    // --- Users ---
    btnAddUser.addEventListener('click', () => {
      userModalTitle.textContent = 'Add User';
      userName.value = '';
      userDisplay.value = '';
      userNotes.value = '';
      userEditingId = null;
      openModal(userModal);
    });

    btnEditUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      userModalTitle.textContent = 'Edit User';
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userNotes.value = u.notes || '';
      userEditingId = u.id;
      openModal(userModal);
    });

    btnDeleteUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      if (!confirm(`Delete user "${u.display || u.username}" and all their businesses & transactions? This action cannot be undone.`)) return;
      // Delete user's businesses and transactions
      data.businesses = data.businesses.filter(b => b.ownerId !== u.id);
      delete data.transactions[u.id];
      data.users = data.users.filter(x => x.id !== u.id);
      // if remaining businesses belonged to others but selectedBusinessId deleted, fix selection
      if (!data.users.length) {
        // clear everything
        data = { users: [], businesses: [], transactions: {} };
      }
      saveData();
      selectedUserId = data.users.length ? data.users[0].id : null;
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
    });

    userSave.addEventListener('click', () => {
      const username = (userName.value || '').trim();
      if (!username) { alert('Username required'); return; }
      if (userEditingId) {
        const u = findUser(userEditingId);
        if (!u) return;
        u.username = username;
        u.display = (userDisplay.value||'').trim();
        u.notes = (userNotes.value||'').trim();
      } else {
        // ensure unique username
        const exists = data.users.find(x => x.username === username);
        if (exists) { if (!confirm('Username already exists. Add anyway?')) return; }
        const id = uid('user');
        data.users.push({ id, username, display: (userDisplay.value||'').trim(), notes: (userNotes.value||'').trim() });
      }
      saveData();
      closeModal(userModal);
      refreshUserBusinessSelectors();
      ensureSelection();
    });

    userCancel.addEventListener('click', () => closeModal(userModal));

    userSelect.addEventListener('change', (e) => {
      selectedUserId = e.target.value;
      // auto-select first business owned by user if possible
      const owned = data.businesses.find(b => b.ownerId === selectedUserId);
      if (owned) selectedBusinessId = owned.id;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // --- Businesses ---
    btnAddBusiness.addEventListener('click', () => {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = '';
      bizVat.value = 7.5;
      bizCurrency.value = '₦';
      bizThreshold.value = 800000;
      bizNotes.value = '';
      bizOwner.value = selectedUserId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = true;
      bizPitEnabled.checked = true;
      bizEditingId = null;
      openModal(businessModal);
    });

    btnEditBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizVat.value = (typeof b.vatRate === 'number') ? b.vatRate : 7.5;
      bizCurrency.value = b.currency || '₦';
      bizThreshold.value = (typeof b.threshold === 'number') ? b.threshold : 800000;
      bizNotes.value = b.notes || '';
      bizOwner.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = !!b.vatEnabled;
      bizPitEnabled.checked = (typeof b.pitEnabled === 'undefined') ? true : !!b.pitEnabled;
      bizEditingId = b.id;
      openModal(businessModal);
    });

    btnDeleteBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm(`Delete business "${b.name}" and all its transactions for all users? This action cannot be undone.`)) return;
      // remove business from businesses
      data.businesses = data.businesses.filter(x => x.id !== b.id);
      // remove transactions for this business across all users
      for (const uid of Object.keys(data.transactions)) {
        if (data.transactions[uid] && data.transactions[uid][b.id]) delete data.transactions[uid][b.id];
      }
      saveData();
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizSave.addEventListener('click', () => {
      const name = (bizName.value || '').trim();
      const ownerIdVal = bizOwner.value;
      const vat = parseFloat(bizVat.value);
      const currency = (bizCurrency.value || '₦').trim();
      const threshold = Number(bizThreshold.value) || 800000;
      const vatEnabledVal = !!bizVatEnabled.checked;
      const pitEnabledVal = !!bizPitEnabled.checked;
      if (!name) { alert('Business name required'); return; }
      if (!ownerIdVal) { alert('Select owner'); return; }
      if (bizEditingId) {
        const b = findBiz(bizEditingId);
        if (!b) return;
        b.name = name;
        b.ownerId = ownerIdVal;
        b.vatRate = isNaN(vat) ? 7.5 : vat;
        b.currency = currency;
        b.threshold = threshold;
        b.notes = (bizNotes.value || '').trim();
        b.vatEnabled = vatEnabledVal;
        b.pitEnabled = pitEnabledVal;
      } else {
        const id = uid('biz');
        data.businesses.push({
          id, name, ownerId: ownerIdVal,
          vatRate: isNaN(vat) ? 7.5 : vat,
          currency,
          threshold,
          notes: (bizNotes.value || '').trim(),
          vatEnabled: vatEnabledVal,
          pitEnabled: pitEnabledVal
        });
      }
      saveData();
      closeModal(businessModal);
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    bizCancel.addEventListener('click', () => closeModal(businessModal));

    businessSelect.addEventListener('change', (e) => {
      selectedBusinessId = e.target.value;
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // --- Transactions ---
    btnAddTxn.addEventListener('click', () => {
      const date = document.getElementById('txnDate').value;
      const type = document.getElementById('txnType').value;
      const category = document.getElementById('txnCategory').value;
      const desc = document.getElementById('txnDesc').value.trim();
      const amount = parseFloat(document.getElementById('txnAmount').value) || 0;

      if (!selectedUserId || !selectedBusinessId) {
        alert('Select user and business before adding a transaction.');
        return;
      }
      if (!date || !desc || amount <= 0) {
        alert('Please fill all fields and enter a valid amount.');
        return;
      }
      const txn = { id: uid('txn'), date, type, category, desc, amount };
      if (!data.transactions[selectedUserId]) data.transactions[selectedUserId] = {};
      if (!data.transactions[selectedUserId][selectedBusinessId]) data.transactions[selectedUserId][selectedBusinessId] = [];
      data.transactions[selectedUserId][selectedBusinessId].push(txn);
      saveData();
      clearForm();
      currentPage = Math.ceil(((ledgerFiltered.length || 0) + 1) / PAGE_SIZE); // jump to last page after adding (approx)
      renderLedger();
      calculateSummary();
    });

    function clearForm() {
      document.getElementById('txnDate').value = "";
      document.getElementById('txnDesc').value = "";
      document.getElementById('txnAmount').value = "";
      document.getElementById('txnType').value = "Income";
      document.getElementById('txnCategory').value = "Salary";
    }

    function renderLedger() {
      ledgerTbody.innerHTML = '';
      if (!selectedUserId || !selectedBusinessId) {
        ledgerFiltered = [];
        updatePaginationControls();
        return;
      }
      const allTxns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      // apply search filter (case-insensitive)
      const q = (ledgerFilterText || '').trim().toLowerCase();
      ledgerFiltered = allTxns.filter(txn => {
        if (!q) return true;
        const parts = [
          txn.date || '',
          txn.type || '',
          txn.category || '',
          txn.desc || '',
          String(txn.amount || '')
        ];
        return parts.join(' ').toLowerCase().includes(q);
      });

      const biz = findBiz(selectedBusinessId);
      const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageSlice = ledgerFiltered.slice(start, start + PAGE_SIZE);

      pageSlice.forEach((txn, idx) => {
        let vat = 0;
        if (biz && biz.vatEnabled && (txn.type === 'Income' || txn.type === 'Expense')) vat = txn.amount * vatRate;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${txn.date}</td>
          <td>${txn.type}</td>
          <td>${txn.category}</td>
          <td>${escapeHtml(txn.desc)}</td>
          <td>${biz && biz.currency ? biz.currency : '₦'}${formatNumber(txn.amount)}</td>
          <td>${(vat && biz && biz.vatEnabled) ? (biz.currency || '₦') + formatNumber(vat) : ''}</td>
          <td>
            <div class="actions">
              <button class="small" onclick="openEditModal('${txn.id}')">Edit</button>
              <button class="small danger" onclick="removeTransaction('${txn.id}')">Delete</button>
            </div>
          </td>`;
        ledgerTbody.appendChild(tr);
      });

      updatePaginationControls();
    }

    function updatePaginationControls() {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      pageIndicator.textContent = `Page ${currentPage} / ${totalPages}`;
      btnPrevPage.disabled = currentPage <= 1;
      btnNextPage.disabled = currentPage >= totalPages;
    }

    btnPrevPage.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        renderLedger();
      }
    });
    btnNextPage.addEventListener('click', () => {
      const totalPages = Math.max(1, Math.ceil(ledgerFiltered.length / PAGE_SIZE));
      if (currentPage < totalPages) {
        currentPage++;
        renderLedger();
      }
    });

    btnSearch.addEventListener('click', () => {
      ledgerFilterText = ledgerSearch.value || '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    btnClearSearch.addEventListener('click', () => {
      ledgerSearch.value = '';
      ledgerFilterText = '';
      currentPage = 1;
      renderLedger();
      calculateSummary();
    });

    // Expose functions needed by inline onclick attributes
    window.openEditModal = function(txnId) {
      if (!selectedUserId || !selectedBusinessId) return;
      const txns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      const idx = txns.findIndex(t => t.id === txnId);
      if (idx === -1) return;
      editIndex = idx;
      const t = txns[idx];
      editTxnDate.value = t.date;
      editTxnType.value = t.type;
      editTxnCategory.value = t.category;
      editTxnDesc.value = t.desc;
      editTxnAmount.value = t.amount;
      openModal(editModal);
    };

    window.removeTransaction = function(txnId) {
      if (!selectedUserId || !selectedBusinessId) return;
      if (!confirm('Delete this transaction?')) return;
      const txns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
      const idx = txns.findIndex(t=>t.id===txnId);
      if (idx === -1) return;
      txns.splice(idx,1);
      saveData();
      // keep page sane
      const totalPages = Math.max(1, Math.ceil(((ledgerFiltered.length - 1) || 0) / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;
      renderLedger();
      calculateSummary();
    };

    function closeEditModal() {
      closeModal(editModal);
      editIndex = null;
    }
    window.closeEditModal = closeEditModal;

    function saveEdit() {
      if (editIndex === null) return;
      const date = editTxnDate.value;
      const type = editTxnType.value;
      const category = editTxnCategory.value;
      const desc = editTxnDesc.value.trim();
      const amount = parseFloat(editTxnAmount.value) || 0;
      if (!date || !desc || amount <= 0) { alert('Fill fields and enter valid amount'); return; }
      const txns = data.transactions[selectedUserId][selectedBusinessId];
      if (!txns || !txns[editIndex]) return;
      txns[editIndex] = { ...txns[editIndex], date, type, category, desc, amount };
      saveData();
      closeEditModal();
      renderLedger();
      calculateSummary();
    }
    window.saveEdit = saveEdit;

    // --- Summaries and tax calculations ---
    function calculateSummary() {
  const biz = findBiz(selectedBusinessId);
  const currency = (biz && biz.currency) ? biz.currency : '₦';
  const vatRate = (biz && typeof biz.vatRate === 'number') ? (biz.vatRate/100) : 0.075;
  const threshold = (biz && typeof biz.threshold === 'number') ? biz.threshold : DEFAULT_PIT.threshold;

  // Determine if PIT is enabled (default true if undefined)
  const pitEnabled = biz ? (typeof biz.pitEnabled === 'undefined' ? true : !!biz.pitEnabled) : false;
  const vatEnabled = biz ? !!biz.vatEnabled : false;

  // Use ledgerFiltered so summaries match the filtered view
  const txns = ledgerFiltered || [];

  let incomeTotal = 0, expenseTotal = 0, deductionTotal = 0, rentTotal = 0;
  let vatOutputTotal = 0, vatInputTotal = 0;
  txns.forEach(txn => {
    if (txn.type === 'Income') {
      incomeTotal += txn.amount;
      if (vatEnabled) vatOutputTotal += txn.amount * vatRate;
    } else if (txn.type === 'Expense') {
      expenseTotal += txn.amount;
      if (vatEnabled) vatInputTotal += txn.amount * vatRate;
      if (txn.category === 'Rent') rentTotal += txn.amount;
    } else if (txn.type === 'Deduction') {
      deductionTotal += txn.amount;
    }
  });

  let netBalance = incomeTotal - expenseTotal;
  let vatPayable = (vatOutputTotal - vatInputTotal);
  // rent relief: 20% of rent up to 500,000
  let rentRelief = rentTotal * 0.20;
  if (rentRelief > 500000) rentRelief = 500000;

  // taxable income after deductions and relief
  let adjIncome = incomeTotal - deductionTotal - rentRelief;
  if (adjIncome < 0) adjIncome = 0;

  // Tax calculation
  let tax = 0;
  if (pitEnabled) {
    tax = computeTax(adjIncome, biz);
  } else {
    tax = 0;
  }

  let effRate = incomeTotal > 0 ? (tax / incomeTotal) * 100 : 0;

  // VAT summary: show only when VAT enabled for the business
  if (vatEnabled) {
    vatSummaryDiv.style.display = '';
    vatSummaryDiv.innerHTML =
      `<strong>VAT Summary (${(vatRate*100).toFixed(2)}%):</strong><br>
       VAT Output (Sales): ${currency}${formatNumber(vatOutputTotal)}<br>
       VAT Input (Purchases): ${currency}${formatNumber(vatInputTotal)}<br>
       <strong>VAT Payable:</strong> ${currency}${formatNumber(vatPayable)}`;
  } else {
    vatSummaryDiv.style.display = 'none';
    vatSummaryDiv.innerHTML = '';
  }

  totalsSummaryDiv.style.display = ''; // totals always shown
  totalsSummaryDiv.innerHTML =
    `<strong>Income:</strong> ${currency}${formatNumber(incomeTotal)}  | 
     <strong>Expenses:</strong> ${currency}${formatNumber(expenseTotal)}  | 
     <strong>Deductions:</strong> ${currency}${formatNumber(deductionTotal)}  | 
     <strong>Net Balance:</strong> ${currency}${formatNumber(netBalance)}`;

  // PIT summary: show only when PIT enabled
  if (pitEnabled) {
    taxSummaryDiv.style.display = '';
    taxSummaryDiv.innerHTML =
      `<strong>Tax Calculation (PIT):</strong><br>
       Tax-free threshold: ${currency}${formatNumber(threshold)}<br>
       Rent relief applied: ${currency}${formatNumber(rentRelief)}<br>
       Taxable income after deductions: ${currency}${formatNumber(adjIncome)}<br>
       <strong>Tax payable:</strong> ${currency}${formatNumber(tax,0)}<br>
       Effective tax rate on gross income: ${effRate.toFixed(2)}%<br>
       ${adjIncome <= threshold ? `<strong>No tax payable (taxable income ≤ ${currency}${formatNumber(threshold)})</strong>` : ''}`;
  } else {
    taxSummaryDiv.style.display = 'none';
    taxSummaryDiv.innerHTML = '';
  }
    }   

    function computeTax(adjIncome, biz) {
      // biz may include custom PIT slices in biz.pit (not exposed in UI now).
      // If PIT disabled on business, return 0
      if (biz && typeof biz.pitEnabled !== 'undefined' && !biz.pitEnabled) return 0;
      const pit = (biz && biz.pit && Array.isArray(biz.pit.slices)) ? biz.pit : DEFAULT_PIT;
      // If adjIncome <= threshold => 0
      let tax = 0;
      if (adjIncome > (pit.threshold || DEFAULT_PIT.threshold)) {
        let taxable = adjIncome;
        let remaining = taxable - (pit.threshold || DEFAULT_PIT.threshold);
        // iterate slices
        let prevUpper = (pit.threshold || DEFAULT_PIT.threshold);
        for (let s of pit.slices) {
          const upper = s.upTo;
          let sliceLimit = (upper === Infinity) ? Infinity : (upper - prevUpper);
          if (remaining <= 0) break;
          const slice = Math.min(remaining, sliceLimit);
          tax += slice * s.rate;
          remaining -= slice;
          prevUpper = upper;
        }
      }
      return Math.max(0, Math.round(tax)); // tax in whole Naira
    }

    // --- Reports Functions ---
    
    /**
     * Compute tax with detailed slice-level breakdown for reports
     * Returns: { totalTax, slices: [{ upTo, rate, taxableAmount, taxAmount }] }
     */
    function computeTaxWithBreakdown(adjIncome, biz) {
      const result = { totalTax: 0, slices: [] };
      
      if (biz && typeof biz.pitEnabled !== 'undefined' && !biz.pitEnabled) {
        return result;
      }
      
      const pit = (biz && biz.pit && Array.isArray(biz.pit.slices)) ? biz.pit : DEFAULT_PIT;
      const threshold = pit.threshold || DEFAULT_PIT.threshold;
      
      if (adjIncome <= threshold) {
        return result;
      }
      
      let remaining = adjIncome - threshold;
      let prevUpper = threshold;
      
      for (let s of pit.slices) {
        const upper = s.upTo;
        let sliceLimit = (upper === Infinity) ? Infinity : (upper - prevUpper);
        if (remaining <= 0) break;
        
        const taxableAmount = Math.min(remaining, sliceLimit);
        const taxAmount = taxableAmount * s.rate;
        
        result.slices.push({
          upTo: upper,
          rate: s.rate,
          taxableAmount: taxableAmount,
          taxAmount: taxAmount
        });
        
        result.totalTax += taxAmount;
        remaining -= taxableAmount;
        prevUpper = upper;
      }
      
      result.totalTax = Math.max(0, Math.round(result.totalTax));
      return result;
    }

    /**
     * Build comprehensive report data based on date range and scope
     * @param {Object} params - { startDate, endDate, scope }
     * @returns {Object} Report data with meta, totals, vat, and paye sections
     */
    function buildReportData(params) {
      const { startDate, endDate, scope } = params;
      
      const report = {
        meta: {
          generatedAt: new Date().toISOString(),
          scope: scope,
          startDate: startDate || 'N/A',
          endDate: endDate || 'N/A'
        },
        totals: {
          income: 0,
          expense: 0,
          deductions: 0,
          netProfit: 0
        },
        vat: {
          output: 0,
          input: 0,
          payable: 0,
          vatRate: 0
        },
        paye: {
          threshold: 0,
          rentRelief: 0,
          taxableIncome: 0,
          slices: [],
          totalTax: 0,
          pitEnabled: false
        }
      };
      
      let allTxns = [];
      let aggregateVatRate = 0;
      let vatRateCount = 0;
      let aggregateThreshold = DEFAULT_PIT.threshold;
      let rentTotal = 0;
      let anyPitEnabled = false;
      
      // Collect transactions based on scope
      if (scope === 'current') {
        // Current selection only
        if (selectedUserId && selectedBusinessId) {
          const biz = findBiz(selectedBusinessId);
          if (biz) {
            const txns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) || [];
            allTxns = txns.map(t => ({ ...t, biz }));
            aggregateVatRate = (typeof biz.vatRate === 'number') ? biz.vatRate : 7.5;
            vatRateCount = 1;
            aggregateThreshold = (typeof biz.threshold === 'number') ? biz.threshold : DEFAULT_PIT.threshold;
            anyPitEnabled = (typeof biz.pitEnabled === 'undefined') ? true : !!biz.pitEnabled;
          }
        }
      } else {
        // All users and businesses
        for (const userId of Object.keys(data.transactions)) {
          for (const bizId of Object.keys(data.transactions[userId])) {
            const biz = findBiz(bizId);
            const txns = data.transactions[userId][bizId] || [];
            allTxns.push(...txns.map(t => ({ ...t, biz })));
            if (biz) {
              aggregateVatRate += (typeof biz.vatRate === 'number') ? biz.vatRate : 7.5;
              vatRateCount++;
              if (typeof biz.pitEnabled === 'undefined' || biz.pitEnabled) {
                anyPitEnabled = true;
              }
            }
          }
        }
        // Average VAT rate across businesses
        if (vatRateCount > 0) aggregateVatRate = aggregateVatRate / vatRateCount;
      }
      
      // Filter by date range
      const filtered = allTxns.filter(txn => {
        if (startDate && txn.date < startDate) return false;
        if (endDate && txn.date > endDate) return false;
        return true;
      });
      
      // Calculate totals
      filtered.forEach(txn => {
        const vatRate = (txn.biz && typeof txn.biz.vatRate === 'number') ? (txn.biz.vatRate / 100) : 0.075;
        const vatEnabled = txn.biz ? !!txn.biz.vatEnabled : false;
        
        if (txn.type === 'Income') {
          report.totals.income += txn.amount;
          if (vatEnabled) report.vat.output += txn.amount * vatRate;
        } else if (txn.type === 'Expense') {
          report.totals.expense += txn.amount;
          if (vatEnabled) report.vat.input += txn.amount * vatRate;
          if (txn.category === 'Rent') rentTotal += txn.amount;
        } else if (txn.type === 'Deduction') {
          report.totals.deductions += txn.amount;
        }
      });
      
      report.totals.netProfit = report.totals.income - report.totals.expense - report.totals.deductions;
      report.vat.payable = report.vat.output - report.vat.input;
      report.vat.vatRate = aggregateVatRate;
      
      // Calculate PAYE/PIT
      report.paye.threshold = aggregateThreshold;
      report.paye.rentRelief = Math.min(rentTotal * 0.20, 500000);
      report.paye.taxableIncome = Math.max(0, report.totals.income - report.totals.deductions - report.paye.rentRelief);
      report.paye.pitEnabled = anyPitEnabled;
      
      if (anyPitEnabled) {
        // Use first business for PIT calculation if current scope, otherwise use defaults
        let bizForPIT = null;
        if (scope === 'current' && selectedBusinessId) {
          bizForPIT = findBiz(selectedBusinessId);
        }
        const taxBreakdown = computeTaxWithBreakdown(report.paye.taxableIncome, bizForPIT);
        report.paye.slices = taxBreakdown.slices;
        report.paye.totalTax = taxBreakdown.totalTax;
      }
      
      return report;
    }

    /**
     * Generate and display report in the UI
     */
    function generateReport() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;
      const scope = document.getElementById('reportScope').value;
      
      const report = buildReportData({ startDate, endDate, scope });
      
      // Store report globally for export functions
      window._currentReport = report;
      
      // Render report
      const reportOutput = document.getElementById('reportOutput');
      const reportContent = document.getElementById('reportContent');
      
      const currency = '₦';
      
      let html = '<div style="margin-top:16px;">';
      
      // Meta info
      html += '<div class="totals" style="margin-bottom:12px;">';
      html += `<strong>Report Generated:</strong> ${new Date(report.meta.generatedAt).toLocaleString()}<br>`;
      html += `<strong>Scope:</strong> ${report.meta.scope === 'current' ? 'Current selection' : 'All users & businesses'}<br>`;
      html += `<strong>Date Range:</strong> ${report.meta.startDate} to ${report.meta.endDate}`;
      html += '</div>';
      
      // Profit Summary
      html += '<div class="totals" style="margin-top:12px;">';
      html += '<strong>Profit Summary:</strong><br>';
      html += `Income: ${currency}${formatNumber(report.totals.income)}<br>`;
      html += `Expenses: ${currency}${formatNumber(report.totals.expense)}<br>`;
      html += `Deductions: ${currency}${formatNumber(report.totals.deductions)}<br>`;
      html += `<strong>Net Profit:</strong> ${currency}${formatNumber(report.totals.netProfit)}`;
      html += '</div>';
      
      // VAT Summary
      html += '<div class="vat-summary" style="margin-top:12px;">';
      html += `<strong>VAT Summary (${report.vat.vatRate.toFixed(2)}%):</strong><br>`;
      html += `VAT Output (Sales): ${currency}${formatNumber(report.vat.output)}<br>`;
      html += `VAT Input (Purchases): ${currency}${formatNumber(report.vat.input)}<br>`;
      html += `<strong>VAT Payable:</strong> ${currency}${formatNumber(report.vat.payable)}`;
      html += '</div>';
      
      // PAYE/PIT Summary
      html += '<div class="tax-summary" style="margin-top:12px;">';
      if (report.paye.pitEnabled) {
        html += '<strong>PAYE/PIT Summary:</strong><br>';
        html += `Tax-free threshold: ${currency}${formatNumber(report.paye.threshold)}<br>`;
        html += `Rent relief applied: ${currency}${formatNumber(report.paye.rentRelief)}<br>`;
        html += `Taxable income after deductions: ${currency}${formatNumber(report.paye.taxableIncome)}<br>`;
        
        if (report.paye.slices.length > 0) {
          html += '<br><strong>Tax Breakdown by Slice:</strong><br>';
          html += '<table class="ledger-table" style="margin-top:8px;"><thead><tr>';
          html += '<th>Tax Band (Up To)</th><th>Rate</th><th>Taxable Amount</th><th>Tax Amount</th>';
          html += '</tr></thead><tbody>';
          
          report.paye.slices.forEach(slice => {
            const bandLabel = slice.upTo === Infinity ? 'Above' : currency + formatNumber(slice.upTo, 0);
            html += '<tr>';
            html += `<td>${bandLabel}</td>`;
            html += `<td>${(slice.rate * 100).toFixed(0)}%</td>`;
            html += `<td>${currency}${formatNumber(slice.taxableAmount)}</td>`;
            html += `<td>${currency}${formatNumber(slice.taxAmount)}</td>`;
            html += '</tr>';
          });
          
          html += '</tbody></table>';
        }
        
        html += `<br><strong>Total Tax Payable:</strong> ${currency}${formatNumber(report.paye.totalTax, 0)}`;
      } else {
        html += '<strong>PIT/PAYE:</strong> PIT is disabled for the selected business(es).';
      }
      html += '</div>';
      
      html += '</div>';
      
      reportContent.innerHTML = html;
      reportOutput.style.display = 'block';
    }

    /**
     * Export report as JSON file
     */
    function exportReportJSON(report) {
      if (!report) report = window._currentReport;
      if (!report) {
        alert('Generate a report first.');
        return;
      }
      
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const timestamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `report_${timestamp}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /**
     * Export report as CSV file
     */
    function exportReportCSV(report) {
      if (!report) report = window._currentReport;
      if (!report) {
        alert('Generate a report first.');
        return;
      }
      
      let csv = 'Nigeria Tax Calculator Report\n\n';
      csv += `Generated,${new Date(report.meta.generatedAt).toLocaleString()}\n`;
      csv += `Scope,${report.meta.scope}\n`;
      csv += `Date Range,${report.meta.startDate} to ${report.meta.endDate}\n\n`;
      
      csv += 'PROFIT SUMMARY\n';
      csv += `Income,${report.totals.income.toFixed(2)}\n`;
      csv += `Expenses,${report.totals.expense.toFixed(2)}\n`;
      csv += `Deductions,${report.totals.deductions.toFixed(2)}\n`;
      csv += `Net Profit,${report.totals.netProfit.toFixed(2)}\n\n`;
      
      csv += 'VAT SUMMARY\n';
      csv += `VAT Rate,${report.vat.vatRate.toFixed(2)}%\n`;
      csv += `VAT Output (Sales),${report.vat.output.toFixed(2)}\n`;
      csv += `VAT Input (Purchases),${report.vat.input.toFixed(2)}\n`;
      csv += `VAT Payable,${report.vat.payable.toFixed(2)}\n\n`;
      
      csv += 'PAYE/PIT SUMMARY\n';
      csv += `PIT Enabled,${report.paye.pitEnabled}\n`;
      csv += `Tax-free Threshold,${report.paye.threshold.toFixed(2)}\n`;
      csv += `Rent Relief,${report.paye.rentRelief.toFixed(2)}\n`;
      csv += `Taxable Income,${report.paye.taxableIncome.toFixed(2)}\n`;
      
      if (report.paye.slices.length > 0) {
        csv += '\nTax Band,Rate,Taxable Amount,Tax Amount\n';
        report.paye.slices.forEach(slice => {
          const band = slice.upTo === Infinity ? 'Above' : slice.upTo.toFixed(0);
          csv += `${band},${(slice.rate * 100).toFixed(0)}%,${slice.taxableAmount.toFixed(2)},${slice.taxAmount.toFixed(2)}\n`;
        });
      }
      
      csv += `\nTotal Tax Payable,${report.paye.totalTax.toFixed(2)}\n`;
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const timestamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `report_${timestamp}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /**
     * Open printable report in new window
     */
    function openPrintableReport(report) {
      if (!report) report = window._currentReport;
      if (!report) {
        alert('Generate a report first.');
        return;
      }
      
      const currency = '₦';
      let html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Report - ${new Date(report.meta.generatedAt).toLocaleDateString()}</title>
  <style>
    @media print {
      @page { margin: 1cm; size: A4; }
      body { margin: 0; }
      .no-print { display: none; }
    }
    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 11pt;
      line-height: 1.5;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #0077cc;
      border-bottom: 2px solid #0077cc;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    h2 {
      color: #0077cc;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      margin-top: 25px;
      margin-bottom: 12px;
    }
    .info-box {
      background: #f8f9fb;
      padding: 12px;
      border-radius: 5px;
      margin: 15px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f2f6fa;
      font-weight: bold;
    }
    td.amount {
      text-align: right;
      font-family: 'Courier New', monospace;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
    }
    .summary-row.total {
      font-weight: bold;
      border-top: 2px solid #333;
      padding-top: 8px;
      margin-top: 8px;
    }
    .print-btn {
      margin: 20px 0;
      padding: 10px 20px;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12pt;
    }
    .print-btn:hover {
      background: #005fa3;
    }
  </style>
</head>
<body>
  <button class="print-btn no-print" onclick="window.print()">Print Report</button>
  
  <h1>Nigeria Tax Calculator - Report</h1>
  
  <div class="info-box">
    <strong>Generated:</strong> ${new Date(report.meta.generatedAt).toLocaleString()}<br>
    <strong>Scope:</strong> ${report.meta.scope === 'current' ? 'Current selection' : 'All users & businesses'}<br>
    <strong>Date Range:</strong> ${report.meta.startDate} to ${report.meta.endDate}
  </div>
  
  <h2>Profit Summary</h2>
  <div class="info-box">
    <div class="summary-row">
      <span>Income:</span>
      <span>${currency}${formatNumber(report.totals.income)}</span>
    </div>
    <div class="summary-row">
      <span>Expenses:</span>
      <span>${currency}${formatNumber(report.totals.expense)}</span>
    </div>
    <div class="summary-row">
      <span>Deductions:</span>
      <span>${currency}${formatNumber(report.totals.deductions)}</span>
    </div>
    <div class="summary-row total">
      <span>Net Profit:</span>
      <span>${currency}${formatNumber(report.totals.netProfit)}</span>
    </div>
  </div>
  
  <h2>VAT Summary</h2>
  <div class="info-box">
    <strong>VAT Rate:</strong> ${report.vat.vatRate.toFixed(2)}%<br><br>
    <div class="summary-row">
      <span>VAT Output (Sales):</span>
      <span>${currency}${formatNumber(report.vat.output)}</span>
    </div>
    <div class="summary-row">
      <span>VAT Input (Purchases):</span>
      <span>${currency}${formatNumber(report.vat.input)}</span>
    </div>
    <div class="summary-row total">
      <span>VAT Payable:</span>
      <span>${currency}${formatNumber(report.vat.payable)}</span>
    </div>
  </div>
  
  <h2>PAYE/PIT Summary</h2>
  <div class="info-box">`;
      
      if (report.paye.pitEnabled) {
        html += `
    <div class="summary-row">
      <span>Tax-free Threshold:</span>
      <span>${currency}${formatNumber(report.paye.threshold)}</span>
    </div>
    <div class="summary-row">
      <span>Rent Relief:</span>
      <span>${currency}${formatNumber(report.paye.rentRelief)}</span>
    </div>
    <div class="summary-row">
      <span>Taxable Income:</span>
      <span>${currency}${formatNumber(report.paye.taxableIncome)}</span>
    </div>
  </div>`;
        
        if (report.paye.slices.length > 0) {
          html += `
  <h3>Tax Breakdown by Slice</h3>
  <table>
    <thead>
      <tr>
        <th>Tax Band (Up To)</th>
        <th>Rate</th>
        <th class="amount">Taxable Amount</th>
        <th class="amount">Tax Amount</th>
      </tr>
    </thead>
    <tbody>`;
          
          report.paye.slices.forEach(slice => {
            const band = slice.upTo === Infinity ? 'Above' : currency + formatNumber(slice.upTo, 0);
            html += `
      <tr>
        <td>${band}</td>
        <td>${(slice.rate * 100).toFixed(0)}%</td>
        <td class="amount">${currency}${formatNumber(slice.taxableAmount)}</td>
        <td class="amount">${currency}${formatNumber(slice.taxAmount)}</td>
      </tr>`;
          });
          
          html += `
    </tbody>
  </table>`;
        }
        
        html += `
  <div class="info-box">
    <div class="summary-row total">
      <span>Total Tax Payable:</span>
      <span>${currency}${formatNumber(report.paye.totalTax, 0)}</span>
    </div>
  </div>`;
      } else {
        html += `<p><strong>Note:</strong> PIT is disabled for the selected business(es).</p></div>`;
      }
      
      html += `
</body>
</html>`;
      
      const win = window.open('', '_blank');
      if (win) {
        win.document.write(html);
        win.document.close();
      } else {
        alert('Pop-up blocked. Please allow pop-ups for this site.');
      }
    }

    // Wire up report UI buttons
    document.getElementById('btnGenerateReport').addEventListener('click', generateReport);
    document.getElementById('btnExportJSON').addEventListener('click', () => exportReportJSON());
    document.getElementById('btnExportCSV').addEventListener('click', () => exportReportCSV());
    document.getElementById('btnPrintableReport').addEventListener('click', () => openPrintableReport());

    // --- Export / Import / Clear ---
    btnExport.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const now = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.download = `ntc_data_export_${now}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imported = JSON.parse(ev.target.result);
          if (!imported.users || !imported.businesses) throw new Error('Invalid format: missing users/businesses');
          // optional merge or replace? ask user - for simplicity replace after confirmation
          if (!confirm('Import will replace current data. Continue?')) return;
          data = imported;
          if (!data.transactions) data.transactions = {};
          saveData();
          refreshUserBusinessSelectors();
          ensureSelection();
          currentPage = 1;
          renderLedger();
          calculateSummary();
          alert('Import successful');
        } catch (err) {
          alert('Failed to import JSON: ' + err.message);
        }
      };
      reader.readAsText(f);
      // reset file input
      fileInput.value = '';
    });

    btnClearAll.addEventListener('click', () => {
      if (!confirm('Clear ALL saved data (users, businesses, transactions)? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      loadData();
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      alert('All data cleared and reset to demo.');
    });

    // --- Helpers ---
    function formatNumber(n, fractionDigits=2) {
      if (typeof n !== 'number') n = Number(n) || 0;
      return n.toLocaleString(undefined, { maximumFractionDigits: fractionDigits, minimumFractionDigits: fractionDigits });
    }

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // close modal when overlay clicked
    modalOverlay.addEventListener('click', () => {
      // close any open modal
      closeModal(userModal);
      closeModal(businessModal);
      closeModal(editModal);
    });

    // Keyboard: Esc closes modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal(userModal);
        closeModal(businessModal);
        closeModal(editModal);
      }
    });

    // Expose helper for debug (optional)
    window._ntc = { data, saveData, loadData, refreshUserBusinessSelectors, renderLedger, calculateSummary };

    // Initial focus improvements
    setTimeout(()=>{ if (userSelect.options.length) userSelect.focus(); }, 300);
  </script>

  <footer>
    <div class="muted">Notes: Data is stored locally in your browser (localStorage). For production or multi-device sharing, use a server-backed solution. This tool keeps VAT per business and calculates PIT per business when enabled.</div>
  </footer>
</body>
</html>

If you want, I can open a pull request in the repository adding this updated index.html (or push it to a new branch). Would you like me to create the PR now?
