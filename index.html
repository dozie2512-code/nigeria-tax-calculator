Below is a complete updated index.html that implements the features you requested: data model additions (assets, taxAdjustments, business whtMode and openingCapitalAllowanceBalance), inventory average-cost & COGS mapping on sale, per-business WHT base (gross/net) with per-transaction override, straight-line monthly depreciation (prorated) shown as synthetic depreciation transactions for summaries, capital allowance calculation with 2/3 allowed and 1/3 carried forward, purchase & dispose asset UI and logic, Tax Adjustments modal (pension, NHF, mortgage interest, rent paid, life insurance with 20% rent relief), and CIT calculation (0% when turnover < ₦50,000,000; otherwise 25%).

Notes:
- I kept most of the original UI and behavior and added new modals/buttons near the Inventory panel and Business modal where appropriate.
- Depreciation transactions are created in-memory (not persisted) and included in summaries and taxable income calculations.
- Capital allowance is treated as tax-only and computed as cost/usefulLifeYears prorated for the period; allowed = 2/3 of computed CA in the period; remainder is carried forward and stored at asset.caCarryforward (and pooled per-business too).
- Inventory uses weighted average cost. If a Sale has qty greater than stock, negative stock is allowed and COGS still uses current avgCost.
- WHT base: Gross = amount; Net = amount - VAT (computed as amount * biz.vatRate/100 when VAT enabled). Per-transaction override is supported.
- CIT turnover is calculated from accounts named "Sales" (case-insensitive match) for the currently selected business across all transactions (year-to-date by default).
- For simplicity the tax period used for CA and CIT is calendar year-to-date. You can change period handling later.

Paste this file into your repository as index.html (replacing existing) and reload the app. Save your data before replacing the file if you need it.

-- index.html (full updated file) --

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Simple Accounting & Tax Software with VAT (Multi-user / Multi-business)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0077cc; --bg:#f8f9fb; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#222; background: #fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0 8px 0 0; font-size:1.1rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:6px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"] { padding:6px; border:1px solid #cfcfcf; border-radius:4px; }
    button { padding:7px 10px; border-radius:5px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:5px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .vat-summary { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:12%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(760px,96vw); max-height:80vh; overflow:auto; }
    .modal h3 { margin-top:0; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    footer { margin-top:20px; font-size:0.85rem; color:var(--muted); }
    .search-bar { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .pagination { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .smallInput { width:76px; }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .inventory-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .inventory-table th, .inventory-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .inventory-table th { background:#f9fbff; }
    .account-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .assets-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .assets-table th, .assets-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .assets-table th { background:#fffaf2; }
    @media (max-width:640px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <header>
    <h1>Nigeria Accounting & Tax (VAT) — Multi-user / Multi-business</h1>
    <div class="controls panel">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="userSelect">User:</label>
        <select id="userSelect"></select>
        <button class="small" id="btnAddUser">+ User</button>
        <button class="small" id="btnEditUser">Edit</button>
        <button class="small danger" id="btnDeleteUser">Delete</button>
      </div>
      <div style="width:1px;background:#e6e6e6;height:28px;margin:0 8px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <label for="businessSelect">Business:</label>
        <select id="businessSelect"></select>
        <button class="small" id="btnAddBusiness">+ Business</button>
        <button class="small" id="btnEditBusiness">Edit</button>
        <button class="small danger" id="btnDeleteBusiness">Delete</button>
        <button class="small" id="btnManageAccounts">Manage Accounts</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All Data</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </header>

  <main>
    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction</h2>
      <div class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label id="txnTypeLabel">Type:
          <select id="txnType">
            <option value="Other">Other</option>
            <option value="Sale">Sale</option>
            <option value="Receipt">Receipt</option>
            <option value="Payment">Payment</option>
            <option value="Purchase">Purchase</option>
            <option value="Expense">Expense</option>
          </select>
        </label>

        <label>Inventory action:
          <select id="txnInventoryAction">
            <option value="None">None</option>
            <option value="Add">Add inventory</option>
            <option value="Purchase">Purchase inventory</option>
            <option value="Sale">Sale inventory</option>
          </select>
        </label>

        <label id="invItemLabel" style="display:none;">Item:
          <select id="invItemSelect"></select>
        </label>

        <label id="invNewSkuLabel" style="display:none;">SKU: <input type="text" id="invNewSku" /></label>
        <label id="invNewNameLabel" style="display:none;">Name: <input type="text" id="invNewName" /></label>

        <label id="invQtyLabel" style="display:none;">Qty: <input type="number" id="invQty" class="smallInput" min="0" step="1" /></label>
        <label id="invUnitCostLabel" style="display:none;">Unit cost (₦): <input type="number" id="invUnitCost" class="smallInput" min="0" step="0.01" /></label>
        <label id="invSalePriceLabel" style="display:none;">Sale price/unit (₦): <input type="number" id="invSalePrice" class="smallInput" min="0" step="0.01" /></label>

        <label id="acctLabel">Account:
          <select id="txnAccount"></select>
        </label>

        <label id="descLabel">Description: <input type="text" id="txnDesc" placeholder="Details" /></label>
        <label id="amountLabel">Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>
        <label id="whtLabel" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="txnWht" /> WHT applied
        </label>
        <label id="txnWhtRateLabel" style="display:none;">WHT rate override (%): <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" placeholder="Optional" /></label>
        <label id="whtModeOverrideLabel" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="txnWhtOverride" /> Use opposite WHT base (override biz default)
        </label>
        <label id="depLabel" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="txnDep" /> Depreciable
        </label>
        <label id="txnUsefulLifeLabel" style="display:none;">Useful life (yrs): <input type="number" id="txnUsefulLife" class="smallInput" min="1" step="1" /></label>
        <button class="primary" id="btnAddTxn">Add Transaction</button>
      </div>
      <small class="note">Transactions are saved per selected user and business. VAT rate & tax rules are per business (editable in Business settings). Mark 'Depreciable' for capital allowance assets when creating asset entries instead of transactions.</small>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount" style="flex:1 1 320px; padding:6px; border:1px solid #cfcfcf; border-radius:4px;" />
        <button id="btnSearch" class="small">Search</button>
        <button id="btnClearSearch" class="small">Clear</button>
      </div>

      <table class="ledger-table" id="ledgerTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Account</th>
            <th>Description</th>
            <th>Amount</th>
            <th>VAT</th>
            <th>WHT</th>
            <th>Cap. Allow (yr)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="pagination" id="paginationControls" style="display:flex;align-items:center;justify-content:flex-end;">
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <button id="btnPrevPage" class="small">Prev</button>
          <span id="pageIndicator">Page 1 / 1</span>
          <button id="btnNextPage" class="small">Next</button>
        </div>
      </div>

      <div class="vat-summary" id="vatSummary"></div>
      <div class="totals" id="totalsSummary"></div>
      <div class="tax-summary" id="taxSummary"></div>
    </section>

    <section class="panel section">
      <h2 style="margin:0 0 8px 0;">Inventory (selected business)</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <button class="small" id="btnOpenInventoryModal">Manage Inventory</button>
        <button class="small" id="btnOpenAssetsModal">Assets</button>
        <button class="small" id="btnPurchaseAsset">Purchase Asset</button>
        <button class="small danger" id="btnDisposeAsset">Dispose Asset</button>
        <button class="small" id="btnTaxAdjustments">Tax Adjustments</button>
      </div>
      <table class="inventory-table" id="inventoryTable">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Name</th>
            <th>Qty</th>
            <th>Avg cost</th>
            <th>Value</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="panel section" id="assetsPanel" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Assets (selected business)</h2>
      <table class="assets-table" id="assetsTable">
        <thead>
          <tr>
            <th>Name</th><th>Cost</th><th>Purchase Date</th><th>Useful life (yrs)</th><th>Accum. Depn</th><th>Accum. CA</th><th>CA Carryforward</th><th>Disposed</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Modals -->
  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal" aria-hidden="true">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display name: <input type="text" id="userDisplay" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="userNotes" placeholder="Optional" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal" aria-hidden="true">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Business name: <input type="text" id="bizName" /></label>
    </div>
    <div class="row">
      <label>Owner (user id): <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>VAT rate (%): <input type="number" id="bizVat" min="0" step="0.01" class="smallInput" /></label>
      <label>WHT rate (%): <input type="number" id="bizWht" min="0" step="0.01" class="smallInput" /></label>
      <label>CIT rate (%): <input type="number" id="bizCit" min="0" step="0.01" class="smallInput" /></label>
      <label>Currency: <input type="text" id="bizCurrency" value="₦" /></label>
    </div>
    <div class="row">
      <label>Tax-free threshold (₦): <input type="number" id="bizThreshold" min="0" step="1" /></label>
      <label>Default useful life (yrs): <input type="number" id="bizUsefulLife" min="1" step="1" class="smallInput" /></label>
    </div>
    <div class="row">
      <label>Accounts (comma-separated): <input type="text" id="bizAccounts" placeholder="Sales,COGS,Expense,Assets" /></label>
    </div>
    <div class="row">
      <label>Notes: <input type="text" id="bizNotes" placeholder="Optional" /></label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (tax)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE on salaries</label>
    </div>

    <div class="row">
      <label>WHT base mode:
        <select id="bizWhtMode">
          <option value="gross">Gross (before VAT)</option>
          <option value="net">Net (after VAT)</option>
        </select>
      </label>
      <label>Opening capital allowance balance (₦): <input type="number" id="bizOpeningCA" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div class="row">
      <label><input type="checkbox" id="bizHideTaxableIncomeComputation" /> Hide taxable income computations (show only final number)</label>
    </div>

    <div style="margin-top:8px;margin-bottom:8px;">
      <strong>Tax Summary Lines to Display:</strong>
      <div class="row">
        <label><input type="checkbox" id="bizShowVat" /> VAT</label>
        <label><input type="checkbox" id="bizShowWht" /> WHT</label>
        <label><input type="checkbox" id="bizShowPaye" /> PAYE</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="bizShowTaxableIncome" /> Taxable Income</label>
        <label><input type="checkbox" id="bizShowPit" /> PIT</label>
        <label><input type="checkbox" id="bizShowCit" /> CIT</label>
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
    <small class="note">Provide accounts as a comma-separated list. Each business maintains its own accounts used in transactions.</small>
  </div>

  <div id="editModal" class="modal" aria-hidden="true">
    <h3>Edit Transaction</h3>
    <label>Date: <input type="date" id="editTxnDate" /></label><br/>
    <label>Type:
      <select id="editTxnType">
        <option value="Other">Other</option>
        <option value="Sale">Sale</option>
        <option value="Receipt">Receipt</option>
        <option value="Payment">Payment</option>
        <option value="Purchase">Purchase</option>
        <option value="Expense">Expense</option>
      </select>
    </label><br/>
    <label>Account:
      <select id="editTxnAccount"></select>
    </label><br/>
    <label>Description: <input type="text" id="editTxnDesc" /></label><br/>
    <label>Amount (₦): <input type="number" id="editTxnAmount" min="0" step="0.01" /></label><br/>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="editTxnWht" /> WHT applied</label>
      <label id="editTxnWhtRateLabel" style="display:none;">WHT rate override (%): <input type="number" id="editTxnWhtRate" class="smallInput" min="0" step="0.01" placeholder="Optional" /></label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="editTxnWhtOverride" /> Use opposite WHT base</label>
      <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="editTxnDep" /> Depreciable</label>
      <label id="editTxnUsefulLabel" style="display:none;">Useful life (yrs): <input type="number" id="editTxnUseful" class="smallInput" min="1" step="1" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="editCancelBtn">Cancel</button>
      <button class="primary" id="editSaveBtn">Save</button>
    </div>
  </div>

  <div id="inventoryModal" class="modal" aria-hidden="true">
    <h3>Manage Inventory Item</h3>
    <div class="row">
      <label>SKU: <input type="text" id="invModalSku" /></label>
      <label>Name: <input type="text" id="invModalName" /></label>
    </div>
    <div class="row">
      <label>Qty: <input type="number" id="invModalQty" class="smallInput" min="0" step="1" /></label>
      <label>Unit cost (₦): <input type="number" id="invModalUnitCost" class="smallInput" min="0" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="invModalCancel">Cancel</button>
      <button class="primary" id="invModalSave">Save</button>
    </div>
  </div>

  <div id="accountsModal" class="modal" aria-hidden="true">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList" style="margin-bottom:12px;"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory">
        <option value="">-- Category --</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
      </select>
      <button id="addAccountBtn" class="small">Add Account</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
    <small class="note">You cannot delete an account that has transactions. Rename and add accounts freely. Each account should have a category.</small>
  </div>

  <div id="assetsModal" class="modal" aria-hidden="true">
    <h3>Assets</h3>
    <table class="assets-table" id="assetsModalTable">
      <thead><tr><th>Name</th><th>Cost</th><th>Purchase</th><th>Life (yrs)</th><th>Accum Depn</th><th>Accum CA</th><th>CA CF</th><th>Disposed</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="assetsCloseBtn">Close</button>
    </div>
  </div>

  <div id="purchaseAssetModal" class="modal" aria-hidden="true">
    <h3>Purchase Asset</h3>
    <div class="row">
      <label>Name: <input type="text" id="assetName" /></label>
      <label>Cost (₦): <input type="number" id="assetCost" class="smallInput" min="0" step="0.01" /></label>
    </div>
    <div class="row">
      <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
      <label>Useful life (yrs): <input type="number" id="assetUsefulLife" class="smallInput" min="1" step="1" /></label>
      <label>Opening capital allowance (₦): <input type="number" id="assetOpeningCA" class="smallInput" min="0" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="assetPurchaseCancel">Cancel</button>
      <button class="primary" id="assetPurchaseSave">Save</button>
    </div>
  </div>

  <div id="disposeAssetModal" class="modal" aria-hidden="true">
    <h3>Dispose Asset</h3>
    <div class="row">
      <label>Asset: <select id="disposeAssetSelect"></select></label>
      <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
      <label>Proceeds (₦): <input type="number" id="assetDisposalProceeds" class="smallInput" min="0" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="assetDisposeCancel">Cancel</button>
      <button class="primary" id="assetDisposeSave">Save</button>
    </div>
  </div>

  <div id="taxAdjustModal" class="modal" aria-hidden="true">
    <h3>Tax Adjustments (per user/business)</h3>
    <div class="row">
      <label>Pension contributions (₦): <input type="number" id="taxPension" class="smallInput" min="0" step="0.01" /></label>
      <label>NHF contributions (₦): <input type="number" id="taxNhf" class="smallInput" min="0" step="0.01" /></label>
      <label>Mortgage interest (₦): <input type="number" id="taxMortgage" class="smallInput" min="0" step="0.01" /></label>
    </div>
    <div class="row">
      <label>Rent paid (₦): <input type="number" id="taxRent" class="smallInput" min="0" step="0.01" /></label>
      <label>Life insurance (₦): <input type="number" id="taxLife" class="smallInput" min="0" step="0.01" /></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="taxAdjustCancel">Cancel</button>
      <button class="primary" id="taxAdjustSave">Save</button>
    </div>
  </div>

  <footer class="muted">Built with Copilot Chat Assistant modifications.</footer>

  <script>
    // GitHub Copilot Chat Assistant
    const STORAGE_KEY = 'ntc_data_v4';

    const DEFAULT_PIT = {
      threshold: 800000,
      slices: [
        { upTo: 3000000, rate: 0.15 },
        { upTo: 12000000, rate: 0.18 },
        { upTo: 25000000, rate: 0.21 },
        { upTo: 50000000, rate: 0.23 },
        { upTo: Infinity, rate: 0.25 }
      ]
    };

    const DEFAULT_BUSINESS_TAX = {
      whtRate: 5.0,
      citRate: 30.0,
      defaultUsefulLifeYears: 5,
      payeEnabled: true
    };

    // Primary data structure
    // data = {
    //   users: [],
    //   businesses: [],
    //   transactions: { userId: { bizId: [ txn, ... ] } },
    //   inventories: { bizId: [ item, ... ] },
    //   assets: { bizId: [ asset, ... ] },
    //   taxAdjustments: { bizId: { userId: { pension, nhf, mortgage, rentPaid, lifeInsurance, lastUpdated } } }
    // }
    let data = { users: [], businesses: [], transactions: {}, inventories: {}, assets: {}, taxAdjustments: {} };
    let selectedUserId = null;
    let selectedBusinessId = null;
    let editTxnRef = null;
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let ledgerFilterText = '';

    function uid(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function formatNumber(n){ return Number(n || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    function ensureBizDefaults(biz){
      if(!biz) return;
      if (typeof biz.whtRate === 'undefined') biz.whtRate = DEFAULT_BUSINESS_TAX.whtRate;
      if (typeof biz.citRate === 'undefined') biz.citRate = DEFAULT_BUSINESS_TAX.citRate;
      if (typeof biz.defaultUsefulLifeYears === 'undefined') biz.defaultUsefulLifeYears = DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      if (typeof biz.payeEnabled === 'undefined') biz.payeEnabled = DEFAULT_BUSINESS_TAX.payeEnabled;
      if (typeof biz.vatEnabled === 'undefined') biz.vatEnabled = true;
      if (typeof biz.pitEnabled === 'undefined') biz.pitEnabled = true;
      if (typeof biz.threshold === 'undefined') biz.threshold = DEFAULT_PIT.threshold;
      if (!Array.isArray(biz.accounts)) biz.accounts = [];
      if (typeof biz.whtMode === 'undefined') biz.whtMode = 'gross';
      if (typeof biz.openingCapitalAllowanceBalance === 'undefined') biz.openingCapitalAllowanceBalance = 0;
      // New tax summary visibility settings (default all to true)
      if (typeof biz.showVat === 'undefined') biz.showVat = true;
      if (typeof biz.showWht === 'undefined') biz.showWht = true;
      if (typeof biz.showPaye === 'undefined') biz.showPaye = true;
      if (typeof biz.showTaxableIncome === 'undefined') biz.showTaxableIncome = true;
      if (typeof biz.showPit === 'undefined') biz.showPit = true;
      if (typeof biz.showCit === 'undefined') biz.showCit = true;
      if (typeof biz.hideTaxableIncomeComputation === 'undefined') biz.hideTaxableIncomeComputation = false;
      // Ensure all accounts have category
      if (Array.isArray(biz.accounts)) {
        biz.accounts.forEach(acct => {
          if (!acct.category) acct.category = '';
        });
      }
    }

    function ensureInventoriesForBusiness(bizId){
      if (!data.inventories) data.inventories = {};
      if (!data.inventories[bizId]) data.inventories[bizId] = [];
    }
    function ensureAssetsForBusiness(bizId){
      if (!data.assets) data.assets = {};
      if (!data.assets[bizId]) data.assets[bizId] = [];
    }
    function ensureTaxAdjustForBusiness(bizId){
      if (!data.taxAdjustments) data.taxAdjustments = {};
      if (!data.taxAdjustments[bizId]) data.taxAdjustments[bizId] = {};
    }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw){
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object'){
            data = parsed;
            if (!data.users) data.users = [];
            if (!data.businesses) data.businesses = [];
            if (!data.transactions) data.transactions = {};
            if (!data.inventories) data.inventories = {};
            if (!data.assets) data.assets = {};
            if (!data.taxAdjustments) data.taxAdjustments = {};
            data.businesses.forEach(b => {
              ensureBizDefaults(b);
              ensureInventoriesForBusiness(b.id);
              ensureAssetsForBusiness(b.id);
              ensureTaxAdjustForBusiness(b.id);
            });
            migrateTransactionsToAccounts();
            return;
          }
        } catch(e){
          console.error('Invalid saved data', e);
        }
      }
      // seed demo
      const u = uid('user'), b = uid('biz');
      data = {
        users: [{ id: u, username: 'demo', display: 'Demo User', notes: 'Sample account' }],
        businesses: [{
          id: b, name: 'Demo Business', ownerId: u, vatRate: 7.5,
          whtRate: DEFAULT_BUSINESS_TAX.whtRate, citRate: DEFAULT_BUSINESS_TAX.citRate,
          defaultUsefulLifeYears: DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears,
          currency: '₦', threshold: DEFAULT_PIT.threshold, notes: 'Sample business',
          vatEnabled: true, pitEnabled: true, payeEnabled: true,
          accounts: [
            { id: uid('acct'), name: 'Sales' },
            { id: uid('acct'), name: 'COGS' },
            { id: uid('acct'), name: 'Purchases' },
            { id: uid('acct'), name: 'Expense' },
            { id: uid('acct'), name: 'Depreciation' },
            { id: uid('acct'), name: 'Asset Disposal Gain/Loss' }
          ],
          whtMode: 'gross',
          openingCapitalAllowanceBalance: 0
        }],
        transactions: { },
        inventories: {},
        assets: {},
        taxAdjustments: {}
      };
      data.inventories[b] = [
        { id: uid('inv'), sku: 'DEMO-001', name: 'Demo Item', qty: 10, unitCost: 5000.00, avgCost: 5000.00 }
      ];
      // demo asset seed
      data.assets[b] = [
        { id: uid('asset'), bizId: b, name: 'Demo Laptop', cost: 200000, purchaseDate: new Date(new Date().setFullYear(new Date().getFullYear()-1)).toISOString().slice(0,10), usefulLifeYears: 3, accumulatedDepreciation: 0, accumulatedCapitalAllowance: 0, caCarryforward: 0, openingCapitalAllowance: 0, disposed: false }
      ];
      ensureBizDefaults(data.businesses[0]);
      ensureInventoriesForBusiness(b);
      ensureAssetsForBusiness(b);
      saveData();
    }

    function migrateTransactionsToAccounts(){
      for (const b of data.businesses || []) ensureBizDefaults(b);
      for (const uidKey of Object.keys(data.transactions || {})){
        const perUser = data.transactions[uidKey] || {};
        for (const bid of Object.keys(perUser || {})){
          const arr = perUser[bid] || [];
          for (const txn of arr){
            // Ensure transaction has type field (default to 'Other' for older data)
            if (!txn.type) txn.type = 'Other';
            
            // Ensure whtRateOverride field exists
            if (typeof txn.whtRateOverride === 'undefined') txn.whtRateOverride = null;
            
            if (txn.accountId) continue;
            let acctName = txn.accountName || null;
            if (!acctName) {
              const t = txn.type || '', c = txn.category || '';
              if (t && c) acctName = `${t} - ${c}`;
              else if (t) acctName = t;
              else if (c) acctName = c;
              else acctName = 'Unassigned';
            }
            const biz = findBiz(bid);
            if (!biz) {
              txn.accountName = acctName;
              continue;
            }
            ensureBizDefaults(biz);
            let acct = biz.accounts.find(a => a.name === acctName);
            if (!acct){
              acct = { id: uid('acct'), name: acctName, category: '' };
              biz.accounts.push(acct);
            }
            txn.accountId = acct.id;
            txn.accountName = acct.name;
          }
        }
      }
      saveData();
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }
    function findAccount(bizId, accountId){ const b = findBiz(bizId); if (!b || !b.accounts) return null; return b.accounts.find(a=>a.id===accountId) || null; }
    function findAccountByName(biz, name){ if (!biz || !biz.accounts) return null; return biz.accounts.find(a => (a.name||'').toLowerCase() === (name||'').toLowerCase()) || null; }

    // UI refs
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');

    const btnAddTxn = document.getElementById('btnAddTxn');
    const ledgerTbody = document.querySelector('#ledgerTable tbody');

    const vatSummaryDiv = document.getElementById('vatSummary');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');

    const modalOverlay = document.getElementById('modalOverlay');

    // User modal
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userNotes = document.getElementById('userNotes');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    // Business modal
    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwner = document.getElementById('bizOwner');
    const bizVat = document.getElementById('bizVat');
    const bizWht = document.getElementById('bizWht');
    const bizCit = document.getElementById('bizCit');
    const bizCurrency = document.getElementById('bizCurrency');
    const bizThreshold = document.getElementById('bizThreshold');
    const bizNotes = document.getElementById('bizNotes');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizPayeEnabled = document.getElementById('bizPayeEnabled');
    const bizUsefulLife = document.getElementById('bizUsefulLife');
    const bizAccounts = document.getElementById('bizAccounts');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');
    const bizWhtMode = document.getElementById('bizWhtMode');
    const bizOpeningCA = document.getElementById('bizOpeningCA');
    const bizHideTaxableIncomeComputation = document.getElementById('bizHideTaxableIncomeComputation');
    const bizShowVat = document.getElementById('bizShowVat');
    const bizShowWht = document.getElementById('bizShowWht');
    const bizShowPaye = document.getElementById('bizShowPaye');
    const bizShowTaxableIncome = document.getElementById('bizShowTaxableIncome');
    const bizShowPit = document.getElementById('bizShowPit');
    const bizShowCit = document.getElementById('bizShowCit');

    // Edit modal
    const editModal = document.getElementById('editModal');
    const editTxnDate = document.getElementById('editTxnDate');
    const editTxnType = document.getElementById('editTxnType');
    const editTxnAccount = document.getElementById('editTxnAccount');
    const editTxnDesc = document.getElementById('editTxnDesc');
    const editTxnAmount = document.getElementById('editTxnAmount');
    const editTxnWht = document.getElementById('editTxnWht');
    const editTxnWhtRate = document.getElementById('editTxnWhtRate');
    const editTxnWhtRateLabel = document.getElementById('editTxnWhtRateLabel');
    const editTxnWhtOverride = document.getElementById('editTxnWhtOverride');
    const editTxnDep = document.getElementById('editTxnDep');
    const editTxnUseful = document.getElementById('editTxnUseful');
    const editTxnUsefulLabel = document.getElementById('editTxnUsefulLabel');
    const editCancelBtn = document.getElementById('editCancelBtn');
    const editSaveBtn = document.getElementById('editSaveBtn');

    // Add txn fields
    const txnType = document.getElementById('txnType');
    const txnWht = document.getElementById('txnWht');
    const txnWhtRate = document.getElementById('txnWhtRate');
    const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
    const txnWhtOverride = document.getElementById('txnWhtOverride');
    const txnDep = document.getElementById('txnDep');
    const txnUsefulLife = document.getElementById('txnUsefulLife');
    const txnUsefulLifeLabel = document.getElementById('txnUsefulLifeLabel');

    const txnInventoryAction = document.getElementById('txnInventoryAction');
    const invItemSelect = document.getElementById('invItemSelect');
    const invNewSku = document.getElementById('invNewSku');
    const invNewName = document.getElementById('invNewName');
    const invQty = document.getElementById('invQty');
    const invUnitCost = document.getElementById('invUnitCost');
    const invSalePrice = document.getElementById('invSalePrice');

    const invItemLabel = document.getElementById('invItemLabel');
    const invNewSkuLabel = document.getElementById('invNewSkuLabel');
    const invNewNameLabel = document.getElementById('invNewNameLabel');
    const invQtyLabel = document.getElementById('invQtyLabel');
    const invUnitCostLabel = document.getElementById('invUnitCostLabel');
    const invSalePriceLabel = document.getElementById('invSalePriceLabel');

    const acctLabel = document.getElementById('acctLabel');
    const txnAccount = document.getElementById('txnAccount');

    const descLabel = document.getElementById('descLabel');
    const amountLabel = document.getElementById('amountLabel');
    const whtLabel = document.getElementById('whtLabel');
    const depLabel = document.getElementById('depLabel');

    // Search & pagination UI
    const ledgerSearch = document.getElementById('ledgerSearch');
    const btnSearch = document.getElementById('btnSearch');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnPrevPage = document.getElementById('btnPrevPage');
    const btnNextPage = document.getElementById('btnNextPage');
    const pageIndicator = document.getElementById('pageIndicator');

    // Export/Import
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const btnClearAll = document.getElementById('btnClearAll');

    // Inventory UI
    const inventoryTableBody = document.querySelector('#inventoryTable tbody');
    const btnOpenInventoryModal = document.getElementById('btnOpenInventoryModal');
    const inventoryModal = document.getElementById('inventoryModal');
    const invModalSku = document.getElementById('invModalSku');
    const invModalName = document.getElementById('invModalName');
    const invModalQty = document.getElementById('invModalQty');
    const invModalUnitCost = document.getElementById('invModalUnitCost');
    const invModalCancel = document.getElementById('invModalCancel');
    const invModalSave = document.getElementById('invModalSave');

    // Accounts modal
    const btnManageAccounts = document.getElementById('btnManageAccounts');
    const accountsModal = document.getElementById('accountsModal');
    const accountsList = document.getElementById('accountsList');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const newAccountName = document.getElementById('newAccountName');
    const newAccountCategory = document.getElementById('newAccountCategory');
    const closeAccountsBtn = document.getElementById('closeAccountsBtn');

    // Assets UI
    const btnOpenAssetsModal = document.getElementById('btnOpenAssetsModal');
    const assetsModal = document.getElementById('assetsModal');
    const assetsModalTableBody = document.querySelector('#assetsModalTable tbody');
    const assetsCloseBtn = document.getElementById('assetsCloseBtn');
    const assetsPanel = document.getElementById('assetsPanel');
    const assetsTableBody = document.querySelector('#assetsTable tbody');

    // Purchase/Dispose Asset
    const btnPurchaseAsset = document.getElementById('btnPurchaseAsset');
    const btnDisposeAsset = document.getElementById('btnDisposeAsset');
    const purchaseAssetModal = document.getElementById('purchaseAssetModal');
    const assetName = document.getElementById('assetName');
    const assetCost = document.getElementById('assetCost');
    const assetPurchaseDate = document.getElementById('assetPurchaseDate');
    const assetUsefulLife = document.getElementById('assetUsefulLife');
    const assetOpeningCA = document.getElementById('assetOpeningCA');
    const assetPurchaseCancel = document.getElementById('assetPurchaseCancel');
    const assetPurchaseSave = document.getElementById('assetPurchaseSave');

    const disposeAssetModal = document.getElementById('disposeAssetModal');
    const disposeAssetSelect = document.getElementById('disposeAssetSelect');
    const assetDisposalDate = document.getElementById('assetDisposalDate');
    const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
    const assetDisposeCancel = document.getElementById('assetDisposeCancel');
    const assetDisposeSave = document.getElementById('assetDisposeSave');

    // Tax adjustments
    const btnTaxAdjustments = document.getElementById('btnTaxAdjustments');
    const taxAdjustModal = document.getElementById('taxAdjustModal');
    const taxPension = document.getElementById('taxPension');
    const taxNhf = document.getElementById('taxNhf');
    const taxMortgage = document.getElementById('taxMortgage');
    const taxRent = document.getElementById('taxRent');
    const taxLife = document.getElementById('taxLife');
    const taxAdjustCancel = document.getElementById('taxAdjustCancel');
    const taxAdjustSave = document.getElementById('taxAdjustSave');

    let userEditingId = null;
    let bizEditingId = null;
    let inventoryEditingId = null;
    let editingTxnRef = null;

    // Utility: compute days in month
    function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }

    // Depreciation calculation: straight-line monthly prorated
    function computeAccumulatedDepreciation(asset, upToDateStr){
      if (!asset || !asset.purchaseDate) return 0;
      const upTo = upToDateStr ? new Date(upToDateStr) : new Date();
      const purchase = new Date(asset.purchaseDate);
      if (upTo <= purchase) return 0;
      const lifeMonths = (asset.usefulLifeYears || 1) * 12;
      const monthly = asset.cost / Math.max(1, lifeMonths);
      // compute number of months (prorated) between purchase and upTo
      let total = 0;
      const startY = purchase.getFullYear(), startM = purchase.getMonth(), startD = purchase.getDate();
      let cur = new Date(purchase.getFullYear(), purchase.getMonth(), 1);
      while (cur <= upTo){
        const monthStart = new Date(cur.getFullYear(), cur.getMonth(), 1);
        const monthEnd = new Date(cur.getFullYear(), cur.getMonth(), daysInMonth(cur.getFullYear(), cur.getMonth()));
        // determine overlap days
        const from = (monthStart < purchase) ? purchase : monthStart;
        const to = (upTo < monthEnd) ? upTo : monthEnd;
        if (to >= from){
          const overlapDays = (to.getDate() - from.getDate() + 1);
          const monthDays = daysInMonth(cur.getFullYear(), cur.getMonth());
          total += monthly * (overlapDays / monthDays);
        }
        cur.setMonth(cur.getMonth() + 1);
        // stop once lifeMonths consumed
        const monthsSincePurchase = (cur.getFullYear() - purchase.getFullYear())*12 + (cur.getMonth() - purchase.getMonth());
        if (monthsSincePurchase >= lifeMonths) break;
      }
      // cap by cost
      if (total > asset.cost) total = asset.cost;
      return total;
    }

    // Capital allowance: tax-only straight-line (annual), prorated for part-year; allowed = 2/3 * computed CA; remainder carried forward
    function computeCapitalAllowanceForPeriod(asset, periodStartStr, periodEndStr){
      // period in ISO dates
      const start = periodStartStr ? new Date(periodStartStr) : new Date(new Date().getFullYear(),0,1);
      const end = periodEndStr ? new Date(periodEndStr) : new Date();
      const purchase = new Date(asset.purchaseDate);
      if (end < purchase) return { computed: 0, allowed: 0, carry: asset.caCarryforward || 0 };
      const lifeYears = Math.max(1, asset.usefulLifeYears || 1);
      // annual tax allowance = cost / usefulLifeYears
      const annualAllowance = asset.cost / lifeYears;
      // prorate annualAllowance for overlap with period
      const overlapStart = (start < purchase) ? purchase : start;
      const overlapEnd = end;
      // compute fraction of year overlapped
      const yearStart = new Date(overlapStart.getFullYear(),0,1);
      const yearEnd = new Date(overlapStart.getFullYear(),11,31,23,59,59);
      // for simplicity: compute days overlap within period relative to 365
      const msPerDay = 1000*60*60*24;
      const ovStart = overlapStart;
      const ovEnd = overlapEnd;
      if (ovEnd < ovStart) return { computed: 0, allowed: 0, carry: asset.caCarryforward || 0 };
      const daysOverlap = Math.ceil((ovEnd - ovStart + 1) / msPerDay);
      const computed = annualAllowance * (daysOverlap / 365);
      const allowed = (2/3) * computed;
      const carry = (asset.caCarryforward || 0) + (computed - allowed);
      return { computed, allowed, carry };
    }

    function openModal(modal){
      modalOverlay.style.display = 'block';
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(modal){
      modalOverlay.style.display = 'none';
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      userEditingId = null;
      bizEditingId = null;
      inventoryEditingId = null;
      editingTxnRef = null;
    }

    modalOverlay.addEventListener('click', () => {
      [userModal, businessModal, editModal, inventoryModal, accountsModal, assetsModal, purchaseAssetModal, disposeAssetModal, taxAdjustModal].forEach(m => { if (m.style.display === 'block') closeModal(m); });
    });

    // Initialization
    loadData();
    refreshUserBusinessSelectors();
    ensureSelection();
    populateInvItemSelect();
    populateAccountSelect();
    currentPage = 1;
    renderLedger();
    calculateSummary();
    renderInventory();
    renderAssetsPanel();
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('txnDate').value = today;
    assetPurchaseDate.value = today;
    assetDisposalDate.value = today;

    // --- User & Business management functions ---
    function refreshUserBusinessSelectors(){
      userSelect.innerHTML = '';
      data.users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = (u.display || u.username) + ' (' + u.username + ')';
        userSelect.appendChild(opt);
      });

      businessSelect.innerHTML = '';
      data.businesses.forEach(b => {
        ensureBizDefaults(b);
        const owner = findUser(b.ownerId);
        const enabledParts = [];
        if (b.vatEnabled) enabledParts.push('VAT');
        if (b.pitEnabled) enabledParts.push('PIT');
        if (b.payeEnabled) enabledParts.push('PAYE');
        const status = enabledParts.length ? ' — ' + enabledParts.join('/') : '';
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = `${b.name}${owner ? ' — ' + (owner.display || owner.username) : ''} (${(typeof b.vatRate === 'number' ? b.vatRate : 0)}% VAT, ${(typeof b.whtRate === 'number' ? b.whtRate : 0)}% WHT, ${b.whtMode ? b.whtMode.toUpperCase() : 'GROSS'})${status}`;
        businessSelect.appendChild(opt);
        ensureInventoriesForBusiness(b.id);
        ensureAssetsForBusiness(b.id);
        ensureTaxAdjustForBusiness(b.id);
      });

      bizOwner.innerHTML = '';
      data.users.forEach(u => {
        const o = document.createElement('option');
        o.value = u.id;
        o.textContent = (u.display || u.username);
        bizOwner.appendChild(o);
      });

      if (!data.users.find(u=>u.id===selectedUserId)) selectedUserId = data.users.length ? data.users[0].id : null;
      if (!data.businesses.find(b=>b.id===selectedBusinessId)) selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;

      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    function ensureSelection(){
      if (!selectedUserId && data.users.length) selectedUserId = data.users[0].id;
      if (!selectedBusinessId && data.businesses.length) selectedBusinessId = data.businesses[0].id;
      if (selectedUserId) userSelect.value = selectedUserId;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
    }

    // Users
    btnAddUser.addEventListener('click', () => {
      userModalTitle.textContent = 'Add User';
      userName.value = '';
      userDisplay.value = '';
      userNotes.value = '';
      userEditingId = null;
      openModal(userModal);
    });

    btnEditUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      userModalTitle.textContent = 'Edit User';
      userName.value = u.username || '';
      userDisplay.value = u.display || '';
      userNotes.value = u.notes || '';
      userEditingId = u.id;
      openModal(userModal);
    });

    btnDeleteUser.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user first.');
      const u = findUser(selectedUserId);
      if (!u) return;
      if (!confirm(`Delete user "${u.display || u.username}" and all their businesses & transactions? This action cannot be undone.`)) return;
      data.businesses = data.businesses.filter(b => b.ownerId !== u.id);
      delete data.transactions[u.id];
      data.users = data.users.filter(x => x.id !== u.id);
      const remainingBizIds = new Set(data.businesses.map(b => b.id));
      const newInventories = {};
      for (const bid of Object.keys(data.inventories || {})) {
        if (remainingBizIds.has(bid)) newInventories[bid] = data.inventories[bid];
      }
      data.inventories = newInventories;
      if (!data.users.length) data = { users: [], businesses: [], transactions: {}, inventories: {}, assets: {}, taxAdjustments: {} };
      saveData();
      selectedUserId = data.users.length ? data.users[0].id : null;
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      renderLedger();
      calculateSummary();
      renderInventory();
      renderAssetsPanel();
    });

    userSave.addEventListener('click', () => {
      const username = (userName.value || '').trim();
      if (!username) { alert('Username required'); return; }
      if (userEditingId) {
        const u = findUser(userEditingId);
        if (!u) return;
        u.username = username;
        u.display = (userDisplay.value||'').trim();
        u.notes = (userNotes.value||'').trim();
      } else {
        const exists = data.users.find(x => x.username === username);
        if (exists) { if (!confirm('Username already exists. Add anyway?')) return; }
        const id = uid('user');
        data.users.push({ id, username, display: (userDisplay.value||'').trim(), notes: (userNotes.value||'').trim() });
      }
      saveData();
      closeModal(userModal);
      refreshUserBusinessSelectors();
      ensureSelection();
    });

    userCancel.addEventListener('click', () => closeModal(userModal));

    userSelect.addEventListener('change', (e) => {
      selectedUserId = e.target.value;
      const owned = data.businesses.find(b => b.ownerId === selectedUserId);
      if (owned) selectedBusinessId = owned.id;
      if (selectedBusinessId) businessSelect.value = selectedBusinessId;
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderInventory();
      populateInvItemSelect();
      populateAccountSelect();
      renderAssetsPanel();
    });

    // Businesses
    btnAddBusiness.addEventListener('click', () => {
      businessModalTitle.textContent = 'Add Business';
      bizName.value = '';
      bizVat.value = 7.5;
      bizWht.value = DEFAULT_BUSINESS_TAX.whtRate;
      bizCit.value = DEFAULT_BUSINESS_TAX.citRate;
      bizCurrency.value = '₦';
      bizThreshold.value = DEFAULT_PIT.threshold;
      bizUsefulLife.value = DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      bizNotes.value = '';
      bizAccounts.value = 'Sales,COGS,Purchases,Expense,Depreciation,Asset Disposal Gain/Loss';
      bizOwner.value = selectedUserId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = true;
      bizPitEnabled.checked = true;
      bizPayeEnabled.checked = true;
      bizWhtMode.value = 'gross';
      bizOpeningCA.value = 0;
      bizHideTaxableIncomeComputation.checked = false;
      bizShowVat.checked = true;
      bizShowWht.checked = true;
      bizShowPaye.checked = true;
      bizShowTaxableIncome.checked = true;
      bizShowPit.checked = true;
      bizShowCit.checked = true;
      bizEditingId = null;
      openModal(businessModal);
    });

    btnEditBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      businessModalTitle.textContent = 'Edit Business';
      bizName.value = b.name || '';
      bizVat.value = (typeof b.vatRate === 'number') ? b.vatRate : 7.5;
      bizWht.value = (typeof b.whtRate === 'number') ? b.whtRate : DEFAULT_BUSINESS_TAX.whtRate;
      bizCit.value = (typeof b.citRate === 'number') ? b.citRate : DEFAULT_BUSINESS_TAX.citRate;
      bizCurrency.value = b.currency || '₦';
      bizThreshold.value = (typeof b.threshold === 'number') ? b.threshold : DEFAULT_PIT.threshold;
      bizUsefulLife.value = (typeof b.defaultUsefulLifeYears === 'number') ? b.defaultUsefulLifeYears : DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      bizNotes.value = b.notes || '';
      bizOwner.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
      bizVatEnabled.checked = !!b.vatEnabled;
      bizPitEnabled.checked = (typeof b.pitEnabled === 'undefined') ? true : !!b.pitEnabled;
      bizPayeEnabled.checked = (typeof b.payeEnabled === 'undefined') ? true : !!b.payeEnabled;
      bizAccounts.value = (b.accounts || []).map(a => a.name).join(',');
      bizWhtMode.value = b.whtMode || 'gross';
      bizOpeningCA.value = b.openingCapitalAllowanceBalance || 0;
      bizHideTaxableIncomeComputation.checked = !!b.hideTaxableIncomeComputation;
      bizShowVat.checked = (typeof b.showVat === 'undefined') ? true : !!b.showVat;
      bizShowWht.checked = (typeof b.showWht === 'undefined') ? true : !!b.showWht;
      bizShowPaye.checked = (typeof b.showPaye === 'undefined') ? true : !!b.showPaye;
      bizShowTaxableIncome.checked = (typeof b.showTaxableIncome === 'undefined') ? true : !!b.showTaxableIncome;
      bizShowPit.checked = (typeof b.showPit === 'undefined') ? true : !!b.showPit;
      bizShowCit.checked = (typeof b.showCit === 'undefined') ? true : !!b.showCit;
      bizEditingId = b.id;
      openModal(businessModal);
    });

    btnDeleteBusiness.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select a business first.');
      const b = findBiz(selectedBusinessId);
      if (!b) return;
      if (!confirm(`Delete business "${b.name}" and all its transactions for all users? This action cannot be undone.`)) return;
      data.businesses = data.businesses.filter(x => x.id !== b.id);
      for (const uidKey of Object.keys(data.transactions)) {
        if (data.transactions[uidKey] && data.transactions[uidKey][b.id]) delete data.transactions[uidKey][b.id];
      }
      if (data.inventories && data.inventories[b.id]) delete data.inventories[b.id];
      if (data.assets && data.assets[b.id]) delete data.assets[b.id];
      if (data.taxAdjustments && data.taxAdjustments[b.id]) delete data.taxAdjustments[b.id];
      saveData();
      selectedBusinessId = data.businesses.length ? data.businesses[0].id : null;
      refreshUserBusinessSelectors();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderInventory();
      populateInvItemSelect();
      populateAccountSelect();
      renderAssetsPanel();
    });

    bizSave.addEventListener('click', () => {
      const name = (bizName.value || '').trim();
      const ownerIdVal = bizOwner.value;
      const vat = parseFloat(bizVat.value);
      const wht = parseFloat(bizWht.value);
      const cit = parseFloat(bizCit.value);
      const currency = (bizCurrency.value || '₦').trim();
      const threshold = Number(bizThreshold.value) || DEFAULT_PIT.threshold;
      const usableLife = parseInt(bizUsefulLife.value) || DEFAULT_BUSINESS_TAX.defaultUsefulLifeYears;
      const vatEnabledVal = !!bizVatEnabled.checked;
      const pitEnabledVal = !!bizPitEnabled.checked;
      const payeEnabledVal = !!bizPayeEnabled.checked;
      const accountsStr = (bizAccounts.value || '').trim();
      const whtModeVal = bizWhtMode.value || 'gross';
      const openingCAVal = Number(bizOpeningCA.value) || 0;
      const hideTaxableIncomeComputationVal = !!bizHideTaxableIncomeComputation.checked;
      const showVatVal = !!bizShowVat.checked;
      const showWhtVal = !!bizShowWht.checked;
      const showPayeVal = !!bizShowPaye.checked;
      const showTaxableIncomeVal = !!bizShowTaxableIncome.checked;
      const showPitVal = !!bizShowPit.checked;
      const showCitVal = !!bizShowCit.checked;
      if (!name) { alert('Business name required'); return; }
      if (!ownerIdVal) { alert('Select owner'); return; }
      const parsedAccounts = accountsStr ? accountsStr.split(',').map(s=>s.trim()).filter(Boolean) : [];
      if (bizEditingId) {
        const b = findBiz(bizEditingId);
        if (!b) return;
        b.name = name;
        b.ownerId = ownerIdVal;
        b.vatRate = isNaN(vat) ? 7.5 : vat;
        b.whtRate = isNaN(wht) ? DEFAULT_BUSINESS_TAX.whtRate : wht;
        b.citRate = isNaN(cit) ? DEFAULT_BUSINESS_TAX.citRate : cit;
        b.currency = currency;
        b.threshold = threshold;
        b.defaultUsefulLifeYears = usableLife;
        b.notes = (bizNotes.value || '').trim();
        b.vatEnabled = vatEnabledVal;
        b.pitEnabled = pitEnabledVal;
        b.payeEnabled = payeEnabledVal;
        b.whtMode = whtModeVal;
        b.openingCapitalAllowanceBalance = openingCAVal;
        b.hideTaxableIncomeComputation = hideTaxableIncomeComputationVal;
        b.showVat = showVatVal;
        b.showWht = showWhtVal;
        b.showPaye = showPayeVal;
        b.showTaxableIncome = showTaxableIncomeVal;
        b.showPit = showPitVal;
        b.showCit = showCitVal;
        const newAccounts = [];
        parsedAccounts.forEach(nameVal => {
          const existing = b.accounts.find(a=>a.name===nameVal);
          if (existing) newAccounts.push(existing);
          else newAccounts.push({ id: uid('acct'), name: nameVal });
        });
        b.accounts = newAccounts;
      } else {
        const id = uid('biz');
        const accounts = parsedAccounts.map(nameVal => ({ id: uid('acct'), name: nameVal }));
        data.businesses.push({
          id, name, ownerId: ownerIdVal,
          vatRate: isNaN(vat) ? 7.5 : vat,
          whtRate: isNaN(wht) ? DEFAULT_BUSINESS_TAX.whtRate : wht,
          citRate: isNaN(cit) ? DEFAULT_BUSINESS_TAX.citRate : cit,
          currency,
          threshold,
          defaultUsefulLifeYears: usableLife,
          notes: (bizNotes.value || '').trim(),
          vatEnabled: vatEnabledVal,
          pitEnabled: pitEnabledVal,
          payeEnabled: payeEnabledVal,
          accounts,
          whtMode: whtModeVal,
          openingCapitalAllowanceBalance: openingCAVal,
          hideTaxableIncomeComputation: hideTaxableIncomeComputationVal,
          showVat: showVatVal,
          showWht: showWhtVal,
          showPaye: showPayeVal,
          showTaxableIncome: showTaxableIncomeVal,
          showPit: showPitVal,
          showCit: showCitVal
        });
        ensureInventoriesForBusiness(id);
        ensureAssetsForBusiness(id);
        ensureTaxAdjustForBusiness(id);
      }
      saveData();
      closeModal(businessModal);
      refreshUserBusinessSelectors();
      ensureSelection();
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderInventory();
      populateInvItemSelect();
      populateAccountSelect();
      renderAssetsPanel();
    });

    bizCancel.addEventListener('click', () => closeModal(businessModal));

    businessSelect.addEventListener('change', (e) => {
      selectedBusinessId = e.target.value;
      currentPage = 1;
      renderLedger();
      calculateSummary();
      renderInventory();
      populateInvItemSelect();
      populateAccountSelect();
      renderAssetsPanel();
    });

    // Transactions: UI behavior
    txnWht.addEventListener('change', () => {
      txnWhtRateLabel.style.display = txnWht.checked ? '' : 'none';
      if (!txnWht.checked) txnWhtRate.value = '';
    });

    editTxnWht.addEventListener('change', () => {
      editTxnWhtRateLabel.style.display = editTxnWht.checked ? '' : 'none';
      if (!editTxnWht.checked) editTxnWhtRate.value = '';
    });

    txnDep.addEventListener('change', () => {
      txnUsefulLifeLabel.style.display = txnDep.checked ? '' : 'none';
      if (!txnDep.checked) txnUsefulLife.value = '';
    });

    editTxnDep.addEventListener('change', () => {
      editTxnUsefulLabel.style.display = editTxnDep.checked ? '' : 'none';
      if (!editTxnDep.checked) editTxnUseful.value = '';
    });

    // Inventory action behaviour (hide/show fields)
    txnInventoryAction.addEventListener('change', () => {
      const v = txnInventoryAction.value;
      invItemLabel.style.display = 'none';
      invNewSkuLabel.style.display = 'none';
      invNewNameLabel.style.display = 'none';
      invQtyLabel.style.display = 'none';
      invUnitCostLabel.style.display = 'none';
      invSalePriceLabel.style.display = 'none';

      if (v === 'None') {
        invItemLabel.style.display = 'none';
        descLabel.style.display = '';
        amountLabel.style.display = '';
        acctLabel.style.display = '';
        whtLabel.style.display = 'inline-flex';
        whtModeOverrideLabel.style.display = 'inline-flex';
        depLabel.style.display = 'inline-flex';
        txnUsefulLifeLabel.style.display = txnDep.checked ? '' : 'none';
        populateInvItemSelect();
        populateAccountSelect();
        return;
      }

      invItemLabel.style.display = '';
      if (v === 'Add' || v === 'Purchase') {
        invNewSkuLabel.style.display = '';
        invNewNameLabel.style.display = '';
        invQtyLabel.style.display = '';
        invUnitCostLabel.style.display = '';
        invSalePriceLabel.style.display = 'none';
      } else if (v === 'Sale') {
        invNewSkuLabel.style.display = 'none';
        invNewNameLabel.style.display = 'none';
        invQtyLabel.style.display = '';
        invUnitCostLabel.style.display = 'none';
        invSalePriceLabel.style.display = '';
      }

      descLabel.style.display = 'none';
      amountLabel.style.display = 'none';
      acctLabel.style.display = 'none';
      whtLabel.style.display = 'none';
      whtModeOverrideLabel.style.display = 'none';
      depLabel.style.display = 'none';
      txnUsefulLifeLabel.style.display = 'none';

      populateInvItemSelect();
    });

    invItemSelect.addEventListener('change', () => {
      const val = invItemSelect.value;
      if (val === '__new__') {
        invNewSkuLabel.style.display = '';
        invNewNameLabel.style.display = '';
      } else {
        invNewSkuLabel.style.display = 'none';
        invNewNameLabel.style.display = 'none';
      }
    });

    function populateInvItemSelect(){
      invItemSelect.innerHTML = '';
      if (!selectedBusinessId) return;
      ensureInventoriesForBusiness(selectedBusinessId);
      const items = data.inventories[selectedBusinessId] || [];
      const optNone = document.createElement('option');
      optNone.value = '';
      optNone.textContent = '-- select --';
      invItemSelect.appendChild(optNone);
      items.forEach(it=>{
        const o = document.createElement('option');
        o.value = it.id;
        o.textContent = `${it.sku || ''} — ${it.name || ''}`;
        invItemSelect.appendChild(o);
      });
      const optNew = document.createElement('option');
      optNew.value = '__new__';
      optNew.textContent = '-- New item --';
      invItemSelect.appendChild(optNew);
    }

    function populateAccountSelect(){
      [txnAccount, editTxnAccount].forEach(sel=>{
        if (!sel) return;
        sel.innerHTML = '';
        if (!selectedBusinessId) {
          const o = document.createElement('option'); o.value=''; o.textContent='-- no business --'; sel.appendChild(o); return;
        }
        const biz = findBiz(selectedBusinessId);
        if (!biz) { const o = document.createElement('option'); o.value=''; o.textContent='-- no business --'; sel.appendChild(o); return; }
        ensureBizDefaults(biz);
        if (!biz.accounts || !biz.accounts.length) {
          const o = document.createElement('option'); o.value=''; o.textContent='-- no accounts defined --'; sel.appendChild(o);
        } else {
          const o = document.createElement('option'); o.value=''; o.textContent='-- select account --'; sel.appendChild(o);
          biz.accounts.forEach(a=>{
            const opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = a.name;
            sel.appendChild(opt);
          });
        }
      });
    }

    // Add Transaction logic
    btnAddTxn.addEventListener('click', () => {
      if (!selectedUserId) return alert('Select a user');
      if (!selectedBusinessId) return alert('Select a business');
      const biz = findBiz(selectedBusinessId);
      if (!biz) return alert('Invalid business');

      const date = document.getElementById('txnDate').value || new Date().toISOString().slice(0,10);
      const inventoryAction = txnInventoryAction.value || 'None';

      // Ensure transactions structure
      if (!data.transactions) data.transactions = {};
      if (!data.transactions[selectedUserId]) data.transactions[selectedUserId] = {};
      if (!data.transactions[selectedUserId][selectedBusinessId]) data.transactions[selectedUserId][selectedBusinessId] = [];

      // common txn fields
      const desc = (document.getElementById('txnDesc').value || '').trim();
      const amount = Number(document.getElementById('txnAmount').value) || 0;
      const acctId = txnAccount.value || '';
      const txnTypeVal = txnType.value || 'Other';
      const whtApplied = !!txnWht.checked;
      const whtRateOverride = txnWhtRate.value ? Number(txnWhtRate.value) : null;
      const whtOverride = !!txnWhtOverride.checked;
      const depFlag = !!txnDep.checked;
      const usefulLife = Number(txnUsefulLife.value) || biz.defaultUsefulLifeYears;

      // Check if transaction type is VAT-applicable (Sale, Receipt, Payment)
      const isVatApplicable = biz.vatEnabled && ['Sale', 'Receipt', 'Payment'].includes(txnTypeVal);

      // function to compute WHT amount with gross-up behavior when WHT is applied
      function computeWhtAmount(baseAmount, biz, whtRateOverride, whtApplied){
        if (!whtApplied) return { whtAmount: 0, grossAmount: baseAmount };
        
        // Use override rate if provided, otherwise use business rate
        const whtRate = whtRateOverride !== null ? whtRateOverride : (biz && typeof biz.whtRate === 'number' ? biz.whtRate : DEFAULT_BUSINESS_TAX.whtRate);
        if (!whtRate || whtRate === 0) return { whtAmount: 0, grossAmount: baseAmount };
        
        // Gross-up behavior: net amount is entered, compute gross
        // gross = net / (1 - whtRate/100)
        // whtAmount = gross * (whtRate/100)
        const netAmount = baseAmount;
        const grossAmount = netAmount / (1 - whtRate / 100);
        const whtAmount = grossAmount * (whtRate / 100);
        
        return { whtAmount: Number(whtAmount.toFixed(2)), grossAmount: Number(grossAmount.toFixed(2)) };
      }

      // handle inventory actions
      if (inventoryAction === 'None'){
        // regular transaction
        const whtCalc = computeWhtAmount(amount, biz, whtRateOverride, whtApplied);
        const txn = {
          id: uid('txn'),
          date, 
          accountId: acctId, 
          accountName: findAccount(selectedBusinessId, acctId) ? findAccount(selectedBusinessId, acctId).name : '',
          description: desc,
          amount,
          type: txnTypeVal,
          vatRate: isVatApplicable ? (biz.vatRate || 0) : 0,
          vatAmount: isVatApplicable ? Number((amount * (biz.vatRate || 0) / 100).toFixed(2)) : 0,
          whtApplied,
          whtRateOverride: whtRateOverride,
          whtOverride, // per-txn override of WHT base
          whtAmount: whtCalc.whtAmount,
          depreciable: depFlag,
          usefulLife: depFlag ? usefulLife : null
        };
        data.transactions[selectedUserId][selectedBusinessId].push(txn);
      } else {
        // Inventory-related action: Add, Purchase or Sale
        ensureInventoriesForBusiness(selectedBusinessId);
        let items = data.inventories[selectedBusinessId];
        if (inventoryAction === 'Add' || inventoryAction === 'Purchase'){
          // possibly new item
          let invId = invItemSelect.value;
          let item = null;
          if (invId === '__new__' || !invId){
            const sku = (invNewSku.value || '').trim() || uid('sku');
            const name = (invNewName.value || '').trim() || 'Item';
            item = { id: uid('inv'), sku, name, qty: 0, unitCost: Number(invUnitCost.value) || 0, avgCost: Number(invUnitCost.value) || 0 };
            items.push(item);
          } else {
            item = items.find(it => it.id === invId);
            if (!item) return alert('Invalid inventory item selected');
          }
          const qtyVal = Number(invQty.value) || 0;
          const unitCostVal = Number(invUnitCost.value) || 0;
          // update weighted average cost
          const totalExistingValue = (item.avgCost || 0) * (item.qty || 0);
          const totalNewValue = unitCostVal * qtyVal;
          const newQty = (item.qty || 0) + qtyVal;
          item.qty = newQty;
          item.avgCost = newQty > 0 ? ((totalExistingValue + totalNewValue) / newQty) : 0;
          item.unitCost = unitCostVal;
          saveData();
          // create purchase transaction (optionally)
          const purchasesAcct = findAccountByName(biz, 'Purchases') || findAccountByName(biz, 'Inventory') || (biz.accounts[0] || null);
          const purchaseAmt = unitCostVal * qtyVal;
          const isPurchaseVatApplicable = biz.vatEnabled && inventoryAction === 'Purchase';
          const whtCalcPurchase = computeWhtAmount(purchaseAmt, biz, whtRateOverride, whtApplied);
          const txn = {
            id: uid('txn'),
            date,
            accountId: purchasesAcct ? purchasesAcct.id : '',
            accountName: purchasesAcct ? purchasesAcct.name : '',
            description: `Inventory purchase: ${item.sku || ''} ${item.name || ''}`,
            amount: purchaseAmt,
            type: 'Purchase',
            vatRate: isPurchaseVatApplicable ? (biz.vatRate || 0) : 0,
            vatAmount: isPurchaseVatApplicable ? Number((purchaseAmt * (biz.vatRate || 0) / 100).toFixed(2)) : 0,
            whtApplied,
            whtRateOverride: whtRateOverride,
            whtOverride,
            whtAmount: whtCalcPurchase.whtAmount,
            depreciable: false
          };
          data.transactions[selectedUserId][selectedBusinessId].push(txn);
        } else if (inventoryAction === 'Sale'){
          const invId = invItemSelect.value;
          if (!invId) return alert('Select item to sell');
          const item = items.find(it => it.id === invId);
          if (!item) return alert('Invalid item');
          const qtyVal = Number(invQty.value) || 0;
          const salePrice = Number(invSalePrice.value) || 0;
          // reduce qty (allow negative)
          item.qty = (item.qty || 0) - qtyVal;
          // compute COGS using avgCost
          const cogsPerUnit = item.avgCost || 0;
          const totalCOGS = Number((cogsPerUnit * qtyVal).toFixed(2));
          saveData();
          // create sales transaction (revenue)
          const salesAcct = findAccountByName(biz, 'Sales') || (biz.accounts[0] || null);
          const saleAmt = Number((salePrice * qtyVal).toFixed(2));
          const isSaleVatApplicable = biz.vatEnabled; // Sale is always VAT-applicable if VAT enabled
          const whtCalcSale = computeWhtAmount(saleAmt, biz, whtRateOverride, whtApplied);
          const saleTxn = {
            id: uid('txn'),
            date,
            accountId: salesAcct ? salesAcct.id : '',
            accountName: salesAcct ? salesAcct.name : '',
            description: `Sale: ${item.sku || ''} ${item.name || ''}`,
            amount: saleAmt,
            type: 'Sale',
            vatRate: isSaleVatApplicable ? (biz.vatRate || 0) : 0,
            vatAmount: isSaleVatApplicable ? Number((saleAmt * (biz.vatRate || 0) / 100).toFixed(2)) : 0,
            whtApplied,
            whtRateOverride: whtRateOverride,
            whtOverride,
            whtAmount: whtCalcSale.whtAmount,
            depreciable: false
          };
          data.transactions[selectedUserId][selectedBusinessId].push(saleTxn);
          // create COGS expense transaction
          const cogsAcct = findAccountByName(biz, 'COGS') || findAccountByName(biz, 'Cost of Goods Sold') || null;
          let cogsAccountToUse = cogsAcct;
          if (!cogsAccountToUse){
            // create 'COGS' account if not present
            const newAcct = { id: uid('acct'), name: 'COGS', category: 'Expense' };
            biz.accounts.push(newAcct);
            cogsAccountToUse = newAcct;
          }
          const cogsTxn = {
            id: uid('txn'),
            date,
            accountId: cogsAccountToUse.id,
            accountName: cogsAccountToUse.name,
            description: `COGS for sale ${item.sku || ''} ${item.name || ''}`,
            amount: totalCOGS,
            type: 'Expense',
            vatRate: 0,
            vatAmount: 0,
            whtApplied: false,
            whtRateOverride: null,
            whtOverride: false,
            whtAmount: 0,
            depreciable: false
          };
          data.transactions[selectedUserId][selectedBusinessId].push(cogsTxn);
        }
      }

      saveData();
      
      // Reset form to sensible defaults after adding transaction
      document.getElementById('txnDate').value = new Date().toISOString().slice(0,10);
      txnType.value = 'Other';
      txnInventoryAction.value = 'None';
      document.getElementById('txnDesc').value = '';
      document.getElementById('txnAmount').value = '';
      txnWht.checked = false;
      txnWhtRate.value = '';
      txnWhtRateLabel.style.display = 'none';
      txnWhtOverride.checked = false;
      txnDep.checked = false;
      txnUsefulLife.value = '';
      txnUsefulLifeLabel.style.display = 'none';
      
      // Clear and hide inventory fields
      invNewSku.value = '';
      invNewName.value = '';
      invQty.value = '';
      invUnitCost.value = '';
      invSalePrice.value = '';
      invItemLabel.style.display = 'none';
      invNewSkuLabel.style.display = 'none';
      invNewNameLabel.style.display = 'none';
      invQtyLabel.style.display = 'none';
      invUnitCostLabel.style.display = 'none';
      invSalePriceLabel.style.display = 'none';
      
      // Show standard fields
      descLabel.style.display = '';
      amountLabel.style.display = '';
      acctLabel.style.display = '';
      whtLabel.style.display = 'inline-flex';
      whtModeOverrideLabel.style.display = 'inline-flex';
      depLabel.style.display = 'inline-flex';
      
      populateInvItemSelect();
      populateAccountSelect();
      renderLedger();
      calculateSummary();
      renderInventory();
    });

    function renderLedger(){
      ledgerTbody.innerHTML = '';
      if (!selectedUserId || !selectedBusinessId || !data.transactions || !data.transactions[selectedUserId] || !data.transactions[selectedUserId][selectedBusinessId]) {
        pageIndicator.textContent = 'Page 0 / 0';
        return;
      }
      const list = data.transactions[selectedUserId][selectedBusinessId] || [];
      const filtered = list.filter(tx => {
        if (!ledgerFilterText) return true;
        const t = ledgerFilterText.toLowerCase();
        return (tx.accountName||'').toLowerCase().includes(t) || (tx.description||'').toLowerCase().includes(t) || (tx.amount||'').toString().includes(t) || (tx.date||'').includes(t);
      });
      const pageCount = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      currentPage = Math.min(currentPage, pageCount);
      const start = (currentPage-1)*PAGE_SIZE;
      const pageItems = filtered.slice(start, start+PAGE_SIZE);
      pageIndicator.textContent = `Page ${currentPage} / ${pageCount}`;
      pageItems.forEach(tx=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(tx.date||'')}</td><td>${escapeHtml(tx.type||'Other')}</td><td>${escapeHtml(tx.accountName||'')}</td><td>${escapeHtml(tx.description||'')}</td><td>${formatNumber(tx.amount||0)}</td><td>${formatNumber(tx.vatAmount||0)}</td><td>${formatNumber(tx.whtAmount||0)}</td><td>${tx.depreciable?escapeHtml(String(tx.usefulLife||'')):''}</td><td><button class="small" data-id="${tx.id}" data-action="edit">Edit</button> <button class="small danger" data-id="${tx.id}" data-action="del">Delete</button></td>`;
        ledgerTbody.appendChild(tr);
      });
    }

    ledgerTbody.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if (!id || !action) return;
      if (action === 'del'){
        if (!confirm('Delete transaction?')) return;
        const arr = data.transactions[selectedUserId][selectedBusinessId];
        const idx = arr.findIndex(x=>x.id===id);
        if (idx>=0) arr.splice(idx,1);
        saveData();
        renderLedger();
        calculateSummary();
      } else if (action === 'edit'){
        editingTxnRef = id;
        const arr = data.transactions[selectedUserId][selectedBusinessId];
        const tx = arr.find(x=>x.id===id);
        if (!tx) return;
        editTxnDate.value = tx.date || '';
        editTxnType.value = tx.type || 'Other';
        populateAccountSelect();
        if (tx.accountId) editTxnAccount.value = tx.accountId;
        editTxnDesc.value = tx.description || '';
        editTxnAmount.value = tx.amount || 0;
        editTxnWht.checked = !!tx.whtApplied;
        editTxnWhtRate.value = tx.whtRateOverride || '';
        editTxnWhtRateLabel.style.display = editTxnWht.checked ? '' : 'none';
        editTxnWhtOverride.checked = !!tx.whtOverride;
        editTxnDep.checked = !!tx.depreciable;
        editTxnUseful.value = tx.usefulLife || '';
        editTxnUsefulLabel.style.display = editTxnDep.checked ? '' : 'none';
        openModal(editModal);
      }
    });

    editCancelBtn.addEventListener('click', () => closeModal(editModal));
    editSaveBtn.addEventListener('click', () => {
      if (!editingTxnRef) return closeModal(editModal);
      const arr = data.transactions[selectedUserId][selectedBusinessId];
      const tx = arr.find(x=>x.id===editingTxnRef);
      if (!tx) return closeModal(editModal);
      const biz = findBiz(selectedBusinessId);
      tx.date = editTxnDate.value || tx.date;
      tx.type = editTxnType.value || tx.type || 'Other';
      tx.accountId = editTxnAccount.value || tx.accountId;
      const acct = findAccount(selectedBusinessId, tx.accountId);
      tx.accountName = acct ? acct.name : tx.accountName;
      tx.description = editTxnDesc.value || tx.description;
      tx.amount = Number(editTxnAmount.value) || 0;
      tx.whtApplied = !!editTxnWht.checked;
      tx.whtRateOverride = editTxnWhtRate.value ? Number(editTxnWhtRate.value) : null;
      tx.whtOverride = !!editTxnWhtOverride.checked;
      tx.depreciable = !!editTxnDep.checked;
      tx.usefulLife = tx.depreciable ? (Number(editTxnUseful.value) || biz.defaultUsefulLifeYears) : null;
      
      // Recalculate VAT and WHT based on updated transaction
      const isVatApplicable = biz.vatEnabled && ['Sale', 'Receipt', 'Payment'].includes(tx.type);
      tx.vatRate = isVatApplicable ? (biz.vatRate || 0) : 0;
      tx.vatAmount = isVatApplicable ? Number((tx.amount * (biz.vatRate || 0) / 100).toFixed(2)) : 0;
      
      // Recalculate WHT with gross-up
      if (tx.whtApplied) {
        const whtRate = tx.whtRateOverride !== null ? tx.whtRateOverride : (biz.whtRate || 0);
        const netAmount = tx.amount;
        const grossAmount = netAmount / (1 - whtRate / 100);
        tx.whtAmount = Number((grossAmount * (whtRate / 100)).toFixed(2));
      } else {
        tx.whtAmount = 0;
      }
      
      saveData();
      closeModal(editModal);
      renderLedger();
      calculateSummary();
    });

    // Search/Pagination handlers
    btnSearch.addEventListener('click', () => { ledgerFilterText = ledgerSearch.value || ''; currentPage = 1; renderLedger(); });
    btnClearSearch.addEventListener('click', () => { ledgerFilterText = ''; ledgerSearch.value = ''; currentPage = 1; renderLedger(); });
    btnPrevPage.addEventListener('click', () => { if (currentPage>1) currentPage--; renderLedger(); });
    btnNextPage.addEventListener('click', () => { currentPage++; renderLedger(); });

    // Export/Import/Clear
    btnExport.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ntc_export.json'; a.click(); URL.revokeObjectURL(url);
    });
    btnImport.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (!parsed) return alert('Invalid JSON');
          data = parsed;
          saveData();
          loadData();
          refreshUserBusinessSelectors();
          ensureSelection();
          renderLedger();
          calculateSummary();
          renderInventory();
        } catch(err){ alert('Invalid JSON file'); }
      };
      reader.readAsText(f);
    });
    btnClearAll.addEventListener('click', () => {
      if (!confirm('Clear all stored data? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      loadData();
      refreshUserBusinessSelectors();
      ensureSelection();
      renderLedger();
      calculateSummary();
      renderInventory();
    });

    // Inventory modal
    btnOpenInventoryModal.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      invModalSku.value = '';
      invModalName.value = '';
      invModalQty.value = 0;
      invModalUnitCost.value = 0;
      openModal(inventoryModal);
    });
    invModalCancel.addEventListener('click', () => closeModal(inventoryModal));
    invModalSave.addEventListener('click', () => {
      if (!selectedBusinessId) return closeModal(inventoryModal);
      ensureInventoriesForBusiness(selectedBusinessId);
      const items = data.inventories[selectedBusinessId];
      const sku = (invModalSku.value || '').trim() || uid('sku');
      const name = (invModalName.value || '').trim() || 'Item';
      const qtyVal = Number(invModalQty.value) || 0;
      const unitCostVal = Number(invModalUnitCost.value) || 0;
      const newItem = { id: uid('inv'), sku, name, qty: qtyVal, unitCost: unitCostVal, avgCost: unitCostVal };
      items.push(newItem);
      saveData();
      closeModal(inventoryModal);
      renderInventory();
      populateInvItemSelect();
    });

    // Accounts modal
    btnManageAccounts.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      const biz = findBiz(selectedBusinessId);
      accountsList.innerHTML = '';
      (biz.accounts || []).forEach(a=>{
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '8px';
        row.style.marginBottom = '6px';
        row.style.alignItems = 'center';
        
        const inp = document.createElement('input');
        inp.value = a.name;
        inp.style.flex = '1';
        inp.addEventListener('change', () => { a.name = inp.value; saveData(); refreshUserBusinessSelectors(); populateAccountSelect(); });
        
        const catSel = document.createElement('select');
        catSel.innerHTML = `<option value="">-- Category --</option><option value="Asset">Asset</option><option value="Liability">Liability</option><option value="Capital">Capital</option><option value="Revenue">Revenue</option><option value="Expense">Expense</option>`;
        catSel.value = a.category || '';
        catSel.addEventListener('change', () => { a.category = catSel.value; saveData(); });
        
        const catLabel = document.createElement('span');
        catLabel.textContent = a.category ? `[${a.category}]` : '[No category]';
        catLabel.style.fontSize = '0.85rem';
        catLabel.style.color = 'var(--muted)';
        catLabel.style.minWidth = '100px';
        
        const del = document.createElement('button');
        del.className = 'small';
        del.textContent = 'Delete';
        del.addEventListener('click', () => {
          // prevent deleting if there are transactions with this account
          const hasTx = Object.values(data.transactions || {}).some(perUser => {
            return Object.values(perUser || {}).some(arr => arr.some(tx => tx.accountId === a.id));
          });
          if (hasTx) return alert('Cannot delete account with transactions. Rename instead.');
          biz.accounts = biz.accounts.filter(x=>x.id!==a.id);
          saveData();
          btnManageAccounts.click();
        });
        
        row.appendChild(inp);
        row.appendChild(catSel);
        row.appendChild(catLabel);
        row.appendChild(del);
        accountsList.appendChild(row);
      });
      openModal(accountsModal);
    });
    addAccountBtn.addEventListener('click', () => {
      const name = (newAccountName.value || '').trim();
      const category = newAccountCategory.value || '';
      if (!name) return;
      const biz = findBiz(selectedBusinessId);
      if (!biz) return;
      biz.accounts.push({ id: uid('acct'), name, category });
      newAccountName.value = '';
      newAccountCategory.value = '';
      saveData();
      btnManageAccounts.click();
    });
    closeAccountsBtn.addEventListener('click', () => closeModal(accountsModal));

    // Inventory rendering
    function renderInventory(){
      inventoryTableBody.innerHTML = '';
      if (!selectedBusinessId) return;
      ensureInventoriesForBusiness(selectedBusinessId);
      const items = data.inventories[selectedBusinessId] || [];
      items.forEach(it=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(it.sku||'')}</td><td>${escapeHtml(it.name||'')}</td><td>${formatNumber(it.qty||0)}</td><td>${formatNumber(it.avgCost||0)}</td><td>${formatNumber((it.avgCost||0)*(it.qty||0))}</td><td><button class="small" data-id="${it.id}" data-action="editInv">Edit</button></td>`;
        inventoryTableBody.appendChild(tr);
      });
    }

    // Assets panel & modal rendering
    btnOpenAssetsModal.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      renderAssetsModal();
      openModal(assetsModal);
    });
    assetsCloseBtn.addEventListener('click', () => closeModal(assetsModal));
    function renderAssetsModal(){
      assetsModalTableBody.innerHTML = '';
      if (!selectedBusinessId) return;
      ensureAssetsForBusiness(selectedBusinessId);
      const list = data.assets[selectedBusinessId] || [];
      list.forEach(a=>{
        const accDep = computeAccumulatedDepreciation(a);
        const caCalc = computeCapitalAllowanceForPeriod(a, new Date(new Date().getFullYear(),0,1).toISOString().slice(0,10), new Date().toISOString().slice(0,10));
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(a.name)}</td><td>${formatNumber(a.cost||0)}</td><td>${escapeHtml(a.purchaseDate||'')}</td><td>${escapeHtml(String(a.usefulLifeYears||''))}</td><td>${formatNumber(accDep)}</td><td>${formatNumber(a.accumulatedCapitalAllowance || 0)}</td><td>${formatNumber(a.caCarryforward || 0)}</td><td>${a.disposed? 'Yes' : 'No'}</td>`;
        assetsModalTableBody.appendChild(tr);
      });
    }

    function renderAssetsPanel(){
      // show/hide assets panel
      if (!selectedBusinessId) { assetsPanel.style.display = 'none'; return; }
      assetsPanel.style.display = '';
      assetsTableBody.innerHTML = '';
      ensureAssetsForBusiness(selectedBusinessId);
      const list = data.assets[selectedBusinessId] || [];
      list.forEach(a=>{
        const accDep = computeAccumulatedDepreciation(a);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(a.name)}</td><td>${formatNumber(a.cost||0)}</td><td>${escapeHtml(a.purchaseDate||'')}</td><td>${escapeHtml(String(a.usefulLifeYears||''))}</td><td>${formatNumber(accDep)}</td><td>${formatNumber(a.accumulatedCapitalAllowance || 0)}</td><td>${formatNumber(a.caCarryforward || 0)}</td><td>${a.disposed? escapeHtml(a.disposalDate||'') : 'No'}</td>`;
        assetsTableBody.appendChild(tr);
      });
    }

    // Purchase Asset modal handlers
    btnPurchaseAsset.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      assetName.value = '';
      assetCost.value = 0;
      assetPurchaseDate.value = new Date().toISOString().slice(0,10);
      assetUsefulLife.value = findBiz(selectedBusinessId).defaultUsefulLifeYears || 5;
      assetOpeningCA.value = 0;
      openModal(purchaseAssetModal);
    });
    assetPurchaseCancel.addEventListener('click', () => closeModal(purchaseAssetModal));
    assetPurchaseSave.addEventListener('click', () => {
      if (!selectedBusinessId) return closeModal(purchaseAssetModal);
      const name = (assetName.value||'').trim();
      const cost = Number(assetCost.value) || 0;
      const purchaseDateVal = assetPurchaseDate.value || new Date().toISOString().slice(0,10);
      const life = Number(assetUsefulLife.value) || findBiz(selectedBusinessId).defaultUsefulLifeYears || 5;
      const openingCAVal = Number(assetOpeningCA.value) || 0;
      if (!name) return alert('Name required');
      const asset = { id: uid('asset'), bizId: selectedBusinessId, name, cost, purchaseDate: purchaseDateVal, usefulLifeYears: life, accumulatedDepreciation: 0, accumulatedCapitalAllowance: openingCAVal || 0, caCarryforward: 0, openingCapitalAllowance: openingCAVal || 0, disposed: false };
      ensureAssetsForBusiness(selectedBusinessId);
      data.assets[selectedBusinessId].push(asset);
      saveData();
      closeModal(purchaseAssetModal);
      renderAssetsPanel();
      renderAssetsModal();
      calculateSummary();
    });

    // Dispose Asset modal handlers
    btnDisposeAsset.addEventListener('click', () => {
      if (!selectedBusinessId) return alert('Select business');
      ensureAssetsForBusiness(selectedBusinessId);
      const list = data.assets[selectedBusinessId] || [];
      disposeAssetSelect.innerHTML = '';
      list.filter(a=>!a.disposed).forEach(a=>{
        const o = document.createElement('option'); o.value = a.id; o.textContent = `${a.name} (${formatNumber(a.cost)})`; disposeAssetSelect.appendChild(o);
      });
      if (!disposeAssetSelect.options.length) return alert('No assets available to dispose');
      assetDisposalDate.value = new Date().toISOString().slice(0,10);
      assetDisposalProceeds.value = 0;
      openModal(disposeAssetModal);
    });
    assetDisposeCancel.addEventListener('click', () => closeModal(disposeAssetModal));
    assetDisposeSave.addEventListener('click', () => {
      if (!selectedBusinessId) return closeModal(disposeAssetModal);
      const aid = disposeAssetSelect.value;
      const asset = (data.assets[selectedBusinessId] || []).find(a=>a.id===aid);
      if (!asset) return alert('Select valid asset');
      const dDate = assetDisposalDate.value || new Date().toISOString().slice(0,10);
      const proceeds = Number(assetDisposalProceeds.value) || 0;
      // compute accumulated depreciation up to disposal
      const accDep = computeAccumulatedDepreciation(asset, dDate);
      asset.accumulatedDepreciation = accDep;
      asset.disposed = true;
      asset.disposalDate = dDate;
      asset.disposalProceeds = proceeds;
      // compute gain/loss (proceeds - (cost - accumulatedDep))
      const bookValue = Math.max(0, asset.cost - accDep);
      const gainLoss = Number((proceeds - bookValue).toFixed(2));
      // create disposal transaction
      if (!data.transactions[selectedUserId]) data.transactions[selectedUserId] = {};
      if (!data.transactions[selectedUserId][selectedBusinessId]) data.transactions[selectedUserId][selectedBusinessId] = [];
      const biz = findBiz(selectedBusinessId);
      let dispAcct = findAccountByName(biz, 'Asset Disposal Gain/Loss');
      if (!dispAcct){
        dispAcct = { id: uid('acct'), name: 'Asset Disposal Gain/Loss' };
        biz.accounts.push(dispAcct);
      }
      const txn = {
        id: uid('txn'),
        date: dDate,
        accountId: dispAcct.id,
        accountName: dispAcct.name,
        description: `Disposal of asset: ${asset.name}`,
        amount: Math.abs(gainLoss),
        vatRate: 0,
        vatAmount: 0,
        whtApplied: false,
        whtOverride: false,
        whtAmount: 0,
        depreciable: false,
        meta: { gainLoss: gainLoss }
      };
      data.transactions[selectedUserId][selectedBusinessId].push(txn);
      // adjust capital allowance carryforward (no complex tax treatment here: keep caCarryforward as is)
      saveData();
      closeModal(disposeAssetModal);
      renderAssetsPanel();
      calculateSummary();
      renderLedger();
    });

    // Tax Adjustments modal
    btnTaxAdjustments.addEventListener('click', () => {
      if (!selectedBusinessId || !selectedUserId) return alert('Select user and business');
      ensureTaxAdjustForBusiness(selectedBusinessId);
      const adj = data.taxAdjustments[selectedBusinessId][selectedUserId] || { pension:0, nhf:0, mortgage:0, rentPaid:0, lifeInsurance:0 };
      taxPension.value = adj.pension || 0;
      taxNhf.value = adj.nhf || 0;
      taxMortgage.value = adj.mortgage || 0;
      taxRent.value = adj.rentPaid || 0;
      taxLife.value = adj.lifeInsurance || 0;
      openModal(taxAdjustModal);
    });
    taxAdjustCancel.addEventListener('click', () => closeModal(taxAdjustModal));
    taxAdjustSave.addEventListener('click', () => {
      if (!selectedBusinessId || !selectedUserId) return closeModal(taxAdjustModal);
      ensureTaxAdjustForBusiness(selectedBusinessId);
      data.taxAdjustments[selectedBusinessId][selectedUserId] = {
        pension: Number(taxPension.value) || 0,
        nhf: Number(taxNhf.value) || 0,
        mortgage: Number(taxMortgage.value) || 0,
        rentPaid: Number(taxRent.value) || 0,
        lifeInsurance: Number(taxLife.value) || 0,
        lastUpdated: new Date().toISOString()
      };
      saveData();
      closeModal(taxAdjustModal);
      calculateSummary();
    });

    // Core summary calculations: VAT, totals, PIT, CIT, depreciation, capital allowances
    function calculateSummary(){
      vatSummaryDiv.innerHTML = '';
      totalsSummaryDiv.innerHTML = '';
      taxSummaryDiv.innerHTML = '';
      if (!selectedBusinessId) return;
      const biz = findBiz(selectedBusinessId);
      if (!biz) return;
      ensureAssetsForBusiness(selectedBusinessId);
      ensureInventoriesForBusiness(selectedBusinessId);

      // Gather transactions for selected business across the selected user only (as earlier behavior)
      const txns = (data.transactions[selectedUserId] && data.transactions[selectedUserId][selectedBusinessId]) ? data.transactions[selectedUserId][selectedBusinessId].slice() : [];

      // Add synthetic depreciation transactions (in-memory) for assets up to today
      const todayStr = new Date().toISOString().slice(0,10);
      const depAcct = findAccountByName(biz, 'Depreciation') || null;
      const depreciationSynthetic = [];
      (data.assets[selectedBusinessId] || []).forEach(asset=>{
        const monthly = asset.cost / (Math.max(1, (asset.usefulLifeYears||biz.defaultUsefulLifeYears)*12));
        // accumulate depreciation up to today
        const acc = computeAccumulatedDepreciation(asset, todayStr);
        // create one aggregated synthetic txn representing depreciation to-date for the asset (so we include it in totals)
        if (acc > 0){
          depreciationSynthetic.push({
            id: `dep_${asset.id}`,
            date: todayStr,
            accountId: depAcct ? depAcct.id : '',
            accountName: depAcct ? depAcct.name : 'Depreciation',
            description: `Depreciation - ${asset.name}`,
            amount: Number(acc.toFixed(2)),
            vatAmount: 0,
            whtAmount: 0,
            depreciable: false,
            synthetic: true,
            assetId: asset.id
          });
        }
      });

      // totals calculation
      let totalRevenue = 0, totalCOGS = 0, totalExpenses = 0, totalVAT = 0, totalWHT = 0, depreciationTotal = 0;
      txns.forEach(tx=>{
        const acctName = tx.accountName || '';
        // classify
        if (acctName.toLowerCase().includes('sale')) totalRevenue += tx.amount || 0;
        else if (acctName.toLowerCase().includes('cogs')) totalCOGS += tx.amount || 0;
        else totalExpenses += tx.amount || 0;
        totalVAT += tx.vatAmount || 0;
        totalWHT += tx.whtAmount || 0;
      });
      depreciationSynthetic.forEach(s=>{
        depreciationTotal += s.amount || 0;
        totalExpenses += s.amount || 0;
      });

      // Capital allowances: compute computed & allowed for current year (year-to-date)
      const yearStart = new Date(new Date().getFullYear(),0,1).toISOString().slice(0,10);
      const yearEnd = new Date().toISOString().slice(0,10);
      let totalComputedCA = 0, totalAllowedCA = 0, totalCarry = 0;
      (data.assets[selectedBusinessId] || []).forEach(asset=>{
        const ca = computeCapitalAllowanceForPeriod(asset, yearStart, yearEnd);
        totalComputedCA += ca.computed;
        totalAllowedCA += ca.allowed;
        totalCarry += ca.carry;
        // persist some values on asset for inspection
        asset.accumulatedCapitalAllowance = (asset.accumulatedCapitalAllowance || 0) + 0; // keep as is for now
        asset.caCarryforward = ca.carry;
      });

      // Apply opening capital allowance balance per business (consume it first)
      let openingCA = biz.openingCapitalAllowanceBalance || 0;
      let openingConsumed = Math.min(openingCA, totalAllowedCA);
      totalAllowedCA -= openingConsumed;
      openingCA -= openingConsumed;

      // Tax adjustments (deductions)
      ensureTaxAdjustForBusiness(selectedBusinessId);
      const taxAdj = (data.taxAdjustments[selectedBusinessId] && data.taxAdjustments[selectedBusinessId][selectedUserId]) ? data.taxAdjustments[selectedBusinessId][selectedUserId] : { pension:0, nhf:0, mortgage:0, rentPaid:0, lifeInsurance:0 };
      const rentRelief = 0.2 * (taxAdj.rentPaid || 0);
      const totalTaxAdjustments = (taxAdj.pension || 0) + (taxAdj.nhf || 0) + (taxAdj.mortgage || 0) + rentRelief + (taxAdj.lifeInsurance || 0);

      // Accounting profit (simple): revenue - cogs - expenses (includes depreciation)
      const accountingProfit = totalRevenue - totalCOGS - totalExpenses;

      // Taxable profit = accounting profit - allowed capital allowances - taxAdjustments
      const taxableProfitBeforeCIT = accountingProfit - totalAllowedCA - totalTaxAdjustments;
      const taxableProfit = Math.max(0, taxableProfitBeforeCIT);

      // CIT rule: turnover less than 50,000,000 => 0% else 25%
      const turnover = totalRevenue;
      const citRate = turnover < 50000000 ? 0 : 25;
      const citAmount = taxableProfit * (citRate/100);

      // PIT (for user) using existing PIT slices and threshold
      const pitTax = biz.pitEnabled ? computePIT(Math.max(0, accountingProfit - totalTaxAdjustments), biz) : 0;

      // render summaries
      vatSummaryDiv.innerHTML = `<strong>VAT summary</strong><div>Total VAT (collected/paid): ₦${formatNumber(totalVAT)}</div>`;
      
      // Conditionally show/hide taxable income computation details
      let totalsSummaryHTML = `<strong>Accounting summary</strong>
        <div>Total Revenue: ₦${formatNumber(totalRevenue)}</div>
        <div>COGS: ₦${formatNumber(totalCOGS)}</div>
        <div>Gross Profit: ₦${formatNumber(totalRevenue - totalCOGS)}</div>`;
      
      if (!biz.hideTaxableIncomeComputation) {
        totalsSummaryHTML += `
          <div>Operating & Other Expenses (incl. depreciation): ₦${formatNumber(totalExpenses)}</div>
          <div>Depreciation (accounting): ₦${formatNumber(depreciationTotal)}</div>`;
      }
      
      totalsSummaryHTML += `<div>Accounting Profit: ₦${formatNumber(accountingProfit)}</div>`;
      totalsSummaryDiv.innerHTML = totalsSummaryHTML;
      
      // Build tax summary with conditional display
      let taxSummaryHTML = '<strong>Tax summary</strong>';
      
      // Always show these computation lines if not hiding
      if (!biz.hideTaxableIncomeComputation) {
        taxSummaryHTML += `
          <div>Computed Capital Allowance (YTD): ₦${formatNumber(totalComputedCA)}</div>
          <div>Allowed Capital Allowance (2/3 rule applied): ₦${formatNumber(totalAllowedCA)}</div>
          <div>Opening CA consumed: ₦${formatNumber(openingConsumed)}</div>
          <div>Total tax adjustments (pension, NHF, mortgage, rent relief (20% of rent)): ₦${formatNumber(totalTaxAdjustments)} (rent relief ₦${formatNumber(rentRelief)})</div>
          <div>Taxable profit before CIT: ₦${formatNumber(taxableProfitBeforeCIT)}</div>`;
      }
      
      // Conditionally show tax summary lines based on business settings
      if (biz.showVat) {
        taxSummaryHTML += `<div><strong>VAT:</strong> ₦${formatNumber(totalVAT)}</div>`;
      }
      
      if (biz.showWht) {
        taxSummaryHTML += `<div><strong>WHT:</strong> ₦${formatNumber(totalWHT)}</div>`;
      }
      
      if (biz.showPaye && biz.payeEnabled) {
        // PAYE calculation (placeholder - could be enhanced)
        const payeAmount = 0; // Could compute from salary transactions if implemented
        taxSummaryHTML += `<div><strong>PAYE:</strong> ₦${formatNumber(payeAmount)}</div>`;
      }
      
      if (biz.showTaxableIncome) {
        taxSummaryHTML += `<div><strong>Taxable Income:</strong> ₦${formatNumber(taxableProfit)}</div>`;
      }
      
      if (biz.showPit && biz.pitEnabled) {
        taxSummaryHTML += `<div><strong>PIT:</strong> ₦${formatNumber(pitTax)}</div>`;
      }
      
      if (biz.showCit) {
        taxSummaryHTML += `
          <div>Turnover: ₦${formatNumber(turnover)}</div>
          <div>CIT rate applied: ${citRate}%</div>
          <div><strong>CIT due:</strong> ₦${formatNumber(citAmount)}</div>`;
      }
      
      taxSummaryDiv.innerHTML = taxSummaryHTML;

      // Save CA carryforwards to data.assets (already updated above)
      saveData();
    }

    // PIT computation (existing function retained)
    function computePIT(income, biz){
      const threshold = (biz && typeof biz.threshold === 'number') ? biz.threshold : DEFAULT_PIT.threshold;
      if (income <= threshold) return 0;
      let tax = 0;
      let prevUpper = threshold;
      for (const slice of DEFAULT_PIT.slices){
        const upper = slice.upTo;
        const sliceUpper = Math.max(prevUpper, Math.min(income, upper));
        const taxableInSlice = Math.max(0, sliceUpper - prevUpper);
        tax += taxableInSlice * slice.rate;
        prevUpper = upper;
        if (income <= upper) break;
      }
      return tax;
    }

    // initial render
    renderLedger();
    renderInventory();
    renderAssetsPanel();
    calculateSummary();

    // small helper to recalc on data changes
    function recalcAll(){
      populateInvItemSelect();
      populateAccountSelect();
      renderLedger();
      renderInventory();
      renderAssetsPanel();
      calculateSummary();
    }

    // Expose recalc on some events (already saved above within handlers)

  </script>
</body>
</html>

-- End file --

If you want I can:
- Push this file to a feature branch and open/update the PR for you (I can create the branch and PR in the repo).
- Break the changes into smaller commits (migration + UI + calculations).
- Add unit tests or step-by-step manual test scenarios.

Tell me which you'd like next: push & create PR, or adjustments to behavior (FIFO instead of average cost, different tax period, different CA rule), or smaller focused changes.
