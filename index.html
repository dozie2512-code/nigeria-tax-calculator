<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nigeria Tax & Accounting — 2026 (PIT/CIT) — Enhanced</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --gap:12px; --muted:#666; --danger:#b00; --accent:#0b76d1; --bg:#f8f9fb; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:18px; color:#222; background:#fff; }
    header { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:1.05rem; }
    .panel { border:1px solid #e1e4e8; padding:12px; background:#fff; border-radius:8px; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color:var(--muted); }
    select,input[type="text"],input[type="number"],input[type="date"],textarea,input[type="password"] { padding:6px; border:1px solid #cfcfcf; border-radius:6px; }
    button { padding:8px 10px; border-radius:6px; border:1px solid #bbb; background:#fff; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    button.small { padding:6px 8px; font-size:0.9rem; }
    .section { margin-top:14px; }
    .form-inline { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .ledger-table { border-collapse: collapse; width:100%; margin-top:10px; }
    .ledger-table th, .ledger-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.95rem; vertical-align: middle; }
    .ledger-table th { background:#f2f6fa; }
    .totals, .tax-summary, .inventory-panel, .assets-panel { background:#f7f9fc; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #eef2f6; }
    .muted { color:var(--muted); font-size:0.9rem; }
    .actions { display:flex; gap:6px; }
    .danger { color:var(--danger); border-color:var(--danger); background: #fff5f5; }
    .modalOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.25); z-index:50; }
    .modal { display:none; position:fixed; left:50%; top:8%; transform:translateX(-50%); background:white; border:1px solid #cfcfcf; padding:16px; z-index:51; border-radius:8px; width:min(960px,96vw); max-height:84vh; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .spacer { flex:1 1 auto; }
    small.note { color:var(--muted); display:block; margin-top:6px; }
    .grid { display:grid; gap:8px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
    .flag { background:#eef6ff; padding:3px 6px; border-radius:4px; color:#05507a; font-size:0.85rem; border:1px solid #dbeffb; }
    .account-category { font-size:0.85rem; color:var(--muted); padding:2px 6px; border-radius:4px; border:1px solid #eee; background:#fbfcfe; }
    .smallInput { width:110px; }
    .table-scroll { max-height:220px; overflow:auto; }
    .notice { background:#fff9e6; border:1px solid #ffe6a8; padding:8px; border-radius:6px; color:#6a4e00; }
    .mutedBlock { color:var(--muted); font-size:0.9rem; margin-top:6px; }
    .form-section { margin-top:10px; padding:8px; border-radius:6px; border:1px dashed #e6e6e6; background:#fcfcfd; }
    .inline-label { display:flex; gap:6px; align-items:center; }
    .account-row { display:flex; gap:6px; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px solid #f0f0f0; }
    .small-muted { font-size:0.85rem; color:var(--muted); }
    .tabbar { display:flex; gap:6px; }
    .tab { padding:6px 10px; border-radius:6px; border:1px solid #e6e6e6; background:#fff; cursor:pointer; }
    .tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .receipt-thumb { max-width:64px; max-height:64px; display:inline-block; border:1px solid #eee; padding:2px; border-radius:4px; margin-right:6px; }
    .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; }
    @media (max-width:760px){ .form-inline{flex-direction:column;align-items:stretch} header{flex-direction:column;align-items:flex-start} }
    .small-note { font-size:0.85rem; color:var(--muted); }
    .auth-bar { margin-left:auto; display:flex; gap:8px; align-items:center; }
  </style>
  <!-- jsPDF CDN for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Nigeria Tax & Accounting — 2026 (PIT/CIT)</h1>

    <div class="panel controls" style="align-items:center;">
      <label>Active User:</label>
      <select id="userSelect"></select>
      <button class="small" id="btnAddUser">+ User</button>
      <button class="small" id="btnEditUser">Edit</button>
      <button class="small danger" id="btnDeleteUser">Delete</button>

      <div style="width:1px;height:28px;background:#e6e6e6;margin:0 8px;"></div>

      <label>Business:</label>
      <select id="businessSelect"></select>
      <button class="small" id="btnAddBusiness">+ Business</button>
      <button class="small" id="btnEditBusiness">Edit</button>
      <button class="small danger" id="btnDeleteBusiness">Delete</button>
      <button class="small" id="btnManageAccounts">Manage Accounts</button>

      <div class="spacer"></div>

      <div class="tabbar">
        <button class="tab active" id="btnLedgerTab">Ledger</button>
        <button class="tab" id="btnReportsTab">Reports</button>
      </div>

      <div style="width:8px;"></div>

      <div class="auth-bar">
        <span id="authInfo" class="small-muted"></span>
        <button id="btnSignIn" class="small">Sign in</button>
        <button id="btnSignUp" class="small">Sign up</button>
        <button id="btnSignOut" class="small" style="display:none;">Sign out</button>
      </div>

      <div style="width:8px;"></div>

      <button id="btnExport" class="small">Export JSON</button>
      <button id="btnImport" class="small">Import JSON</button>
      <button id="btnClearAll" class="small danger">Clear All</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none;" />
    </div>
  </header>

  <main>
    <section id="ledgerSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Add Transaction / Inventory / Asset</h2>

      <div id="mainTxnForm" class="form-inline">
        <label>Date: <input type="date" id="txnDate" /></label>

        <label>Action:
          <select id="txnAction">
            <option value="">-- Select action --</option>
            <option value="InventoryPurchase">Inventory Purchase</option>
            <option value="InventorySale">Inventory Sale</option>
            <option value="Expense">Expense</option>
            <option value="Revenue">Revenue</option>
            <option value="FixedAssetPurchase">Fixed Asset Purchase</option>
            <option value="FixedAssetDisposal">Fixed Asset Disposal</option>
          </select>
        </label>

        <label>Account:
          <select id="txnAccount"></select>
        </label>

        <label>Description: <input type="text" id="txnDesc" placeholder="Details" /></label>

        <label>Amount (₦): <input type="number" id="txnAmount" min="0" step="0.01" /></label>

        <label class="inline-label">
          <input type="checkbox" id="txnVatApply" /> VAT applies
        </label>
        <label class="inline-label">
          <input type="checkbox" id="txnVatInclusive" /> VAT inclusive
        </label>

        <label class="inline-label">
          <input type="checkbox" id="txnWht" /> WHT applied (receivable)
        </label>
        <label id="txnWhtRateLabel" style="display:none;">Rate (%) <input type="number" id="txnWhtRate" class="smallInput" min="0" step="0.01" /></label>

        <label class="inline-label">
          <input type="checkbox" id="txnSalary" /> Salary (PAYE)
        </label>

        <label>
          Contact type:
          <select id="txnContactType">
            <option value="">-- none --</option>
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
          </select>
        </label>
        <label>Contact name: <input type="text" id="txnContactName" placeholder="Contact name" /></label>

        <label>Disallowable: <input type="checkbox" id="txnDisallowable" /></label>
        <label>Non-taxable: <input type="checkbox" id="txnNonTaxable" /></label>

        <label>Receipt: <input type="file" id="txnReceipt" /></label>

        <button class="primary" id="btnAddTxn">Add</button>
      </div>

      <div id="inventorySubform" style="margin-top:10px; display:none;" class="panel inventory-panel">
        <h3 style="margin:4px 0;">Inventory / Items</h3>
        <div class="form-inline">
          <label>Item:
            <select id="invItemSelect"></select>
          </label>
          <label>New Item: <input type="text" id="invNewName" placeholder="If adding new" /></label>
          <label>Account:
            <select id="invAccountSelect"></select>
          </label>
          <label>Qty: <input type="number" id="invQty" min="0" step="1" /></label>
          <label>Unit Price (₦): <input type="number" id="invUnitPrice" min="0" step="0.01" /></label>
          <label class="inline-label"><input type="checkbox" id="invVat" /> VAT applies</label>
          <label class="inline-label"><input type="checkbox" id="invVatInclusive" /> VAT inclusive</label>

          <label>Contact type:
            <select id="invContactType">
              <option value="">-- none --</option>
              <option value="Customer">Customer</option>
              <option value="Vendor">Vendor</option>
              <option value="Employee">Employee</option>
            </select>
          </label>
          <label>Contact name: <input type="text" id="invContactName" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="invReceipt" /></label>

          <button id="btnAddInv" class="small">Apply Inventory Action</button>
          <button id="btnInvCancel" class="small">Cancel</button>
          <button id="btnInvUndo" class="small danger">Undo last inventory action</button>
        </div>
        <small class="note">Inventory uses weighted average for COGS. Purchases update average; sales consume using current average cost.</small>
      </div>

      <div id="assetSubform" style="margin-top:10px; display:none;" class="panel assets-panel">
        <h3 style="margin:4px 0;">Fixed Asset</h3>
        <div class="form-inline">
          <label>Asset name: <input type="text" id="assetName" /></label>
          <label>Cost (₦): <input type="number" id="assetCost" min="0" step="0.01" /></label>
          <label>Purchase date: <input type="date" id="assetPurchaseDate" /></label>
          <label>Useful life (years): <input type="number" id="assetLife" min="1" step="1" class="smallInput" /></label>
          <label>Capital allowance % (annual): <input type="number" id="assetCA" min="0" step="0.01" class="smallInput" /></label>
        </div>
        <div class="form-inline" style="margin-top:8px;">
          <label>Disposal date: <input type="date" id="assetDisposalDate" /></label>
          <label>Disposal proceeds: <input type="number" id="assetDisposalProceeds" min="0" step="0.01" /></label>
          <label>Purchase account:
            <select id="assetPurchaseAccount"></select>
          </label>
          <label>Disposal account:
            <select id="assetDisposalAccount"></select>
          </label>

          <label>Contact type:
            <select id="assetContactType">
              <option value="">-- none --</option>
              <option value="Customer">Customer</option>
              <option value="Vendor">Vendor</option>
              <option value="Employee">Employee</option>
            </select>
          </label>
          <label>Contact name: <input type="text" id="assetContactName" placeholder="Contact name" /></label>

          <label>Receipt: <input type="file" id="assetReceipt" /></label>

          <button id="btnAddAsset" class="small">Record Asset Purchase</button>
          <button id="btnDisposeAsset" class="small danger">Record Disposal</button>
          <button id="btnAssetCancel" class="small">Cancel</button>
          <button id="btnAssetUndo" class="small danger">Undo last asset action</button>
        </div>
        <small class="note">Depreciation = straight-line. Monthly depreciation prorated by days. Capital allowance applied monthly from purchase.</small>
      </div>
    </section>

    <section id="ledgerListSection" class="panel section">
      <h2 style="margin:0 0 8px 0;">Transactions Ledger</h2>

      <div class="search-bar form-inline">
        <input type="text" id="ledgerSearch" placeholder="Search by date/account/description/amount/contact" style="flex:1; padding:6px; border:1px solid #cfcfcf; border-radius:6px;" />
        <button class="small" id="btnSearch">Search</button>
        <button class="small" id="btnClearSearch">Clear</button>
      </div>

      <div class="table-scroll">
        <table class="ledger-table" id="ledgerTable">
          <thead>
            <tr>
              <th>Date</th><th>Action</th><th>Account</th><th>Description</th><th>Amount (Net)</th><th>VAT</th><th>WHT</th><th>PAYE</th><th>Disallowable</th><th>NonTaxable</th><th>Contact</th><th>Receipt</th><th>Item/Asset</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="profitSnapshot" class="totals"></div>
      <div id="totalsSummary" class="totals"></div>
      <div id="taxSummary" class="tax-summary"></div>
    </section>

    <section id="reportsSection" class="panel section" style="display:none;">
      <h2 style="margin:0 0 8px 0;">Reports</h2>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
        <button class="small tab active" data-report="taxReconciliation">Taxable Income Reconciliation</button>
        <button class="small tab" data-report="vatReport">VAT Report</button>
        <button class="small tab" data-report="whtPayable">WHT Payable/Receivable</button>
        <button class="small tab" data-report="payeReport">PAYE Report</button>
        <button class="small tab" data-report="inventoryReport">Inventory Report</button>
        <button class="small tab" data-report="assetsReport">Fixed Assets Report</button>
        <button class="small tab" data-report="auditTrail">Audit Trail</button>
        <button class="small tab" data-report="receiptsFolder">Receipts Folder</button>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnExportCsv" class="small">Export CSV (selected)</button>
        <button id="btnExportPdf" class="small">Export PDF (selected)</button>
      </div>

      <div id="reportContent" style="min-height:160px;"></div>
    </section>

    <section class="panel section grid" id="quickPanels">
      <div>
        <h3>Inventory (Quick)</h3>
        <div id="inventoryList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Fixed Assets (Quick)</h3>
        <div id="assetList" class="table-scroll panel" style="padding:8px;"></div>
      </div>
      <div>
        <h3>Profit & Loss Snapshot (Quick)</h3>
        <div id="plSnapshot" class="panel" style="padding:8px;"></div>
      </div>
    </section>
  </main>

  <div id="modalOverlay" class="modalOverlay"></div>

  <div id="userModal" class="modal">
    <h3 id="userModalTitle">Add User</h3>
    <div class="row">
      <label>Username: <input type="text" id="userName" /></label>
      <label>Display: <input type="text" id="userDisplay" /></label>
      <label>Role:
        <select id="userRole">
          <option value="User">User</option>
          <option value="Admin">Admin</option>
        </select>
      </label>
    </div>
    <div class="form-section">
      <h4 style="margin:4px 0;">Permissions (Admin can set per user)</h4>
      <div class="row">
        <label><input type="checkbox" id="permView" /> View</label>
        <label><input type="checkbox" id="permEdit" /> Edit</label>
        <label><input type="checkbox" id="permDelete" /> Delete</label>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button id="userCancel">Cancel</button>
      <button class="primary" id="userSave">Save</button>
    </div>
  </div>

  <div id="businessModal" class="modal">
    <h3 id="businessModalTitle">Add Business</h3>
    <div class="row">
      <label>Name: <input type="text" id="bizName" /></label>
      <label>Owner: <select id="bizOwner"></select></label>
    </div>
    <div class="row">
      <label>Entity type:
        <select id="bizEntity">
          <option value="Company">Company</option>
          <option value="SoleProprietor">Sole proprietor</option>
        </select>
      </label>
      <label>VAT rate %: <input type="number" id="bizVat" class="smallInput" min="0" step="0.01" /></label>
      <label>WHT rate %: <input type="number" id="bizWht" class="smallInput" min="0" step="0.01" /></label>
      <label>CIT rate %: <input type="number" id="bizCit" class="smallInput" min="0" step="0.01" /></label>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <label><input type="checkbox" id="bizVatEnabled" /> Enable VAT</label>
      <label><input type="checkbox" id="bizPitEnabled" /> Enable PIT (sole prop)</label>
      <label><input type="checkbox" id="bizPayeEnabled" /> Enable PAYE</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizShowLines" /> Show detailed tax summary</label>
      <label style="margin-left:8px;"><input type="checkbox" id="bizCitEnabled" /> Enable CIT</label>
    </div>

    <div class="form-section">
      <div class="row">
        <label>Loss brought forward (₦): <input type="number" id="bizLossBF" class="smallInput" min="0" step="0.01" /></label>
        <label>CA carryforward (₦): <input type="number" id="bizCACF" class="smallInput" min="0" step="0.01" /></label>
        <label>Capital brought forward (₦): <input type="number" id="bizCapitalBF" class="smallInput" min="0" step="0.01" /></label>
      </div>

      <div class="row" style="margin-top:6px;">
        <label><input type="checkbox" id="bizDefaultExpenseDisallowable" /> Default expenses disallowable (business-level)</label>
        <label><input type="checkbox" id="bizDefaultRevenueNonTax" /> Default revenue non-taxable (business-level)</label>
      </div>

      <div style="margin-top:8px;">
        <h4 style="margin:6px 0 4px 0;">Annual statutory deductions (used for PAYE)</h4>
        <div class="row">
          <label>Pension (₦): <input type="number" id="bizDedPension" class="smallInput" min="0" step="0.01" /></label>
          <label>Rent relief (₦): <input type="number" id="bizDedRent" class="smallInput" min="0" step="0.01" /></label>
          <label>Life assurance (₦): <input type="number" id="bizDedLife" class="smallInput" min="0" step="0.01" /></label>
          <label>Mortgage interest (₦): <input type="number" id="bizDedMortgage" class="smallInput" min="0" step="0.01" /></label>
          <label>NHF (₦): <input type="number" id="bizDedNHF" class="smallInput" min="0" step="0.01" /></label>
        </div>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">FIRS / External</h4>
        <div class="row">
          <label>FIRS login label: <input type="text" id="bizFirsLabel" class="smallInput" /></label>
          <label>FIRS login URL: <input type="text" id="bizFirsUrl" style="min-width:320px;" /></label>
        </div>
      </div>

      <div style="margin-top:10px;">
        <h4 style="margin:6px 0 4px 0;">Contacts</h4>
        <div id="bizContactsList"></div>
        <div class="row">
          <input type="text" id="newContactName" placeholder="Contact name" />
          <select id="newContactType">
            <option value="Customer">Customer</option>
            <option value="Vendor">Vendor</option>
            <option value="Employee">Employee</option>
          </select>
          <button id="btnAddContact" class="small">Add Contact</button>
        </div>
        <small class="note">Edit Employee contacts to set per-employee statutory deductions used for PAYE calculation.</small>
      </div>

    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="bizCancel">Cancel</button>
      <button class="primary" id="bizSave">Save</button>
    </div>
  </div>

  <div id="accountsModal" class="modal">
    <h3>Manage Chart of Accounts</h3>
    <div id="accountsList"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
      <input type="text" id="newAccountName" placeholder="Account name" style="flex:1;" />
      <select id="newAccountCategory" class="smallInput">
        <option value="Revenue">Revenue</option>
        <option value="Expense">Expense</option>
        <option value="Asset">Asset</option>
        <option value="Liability">Liability</option>
        <option value="Capital">Capital</option>
      </select>
      <button id="addAccountBtn" class="small">Add</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="closeAccountsBtn">Close</button>
    </div>
  </div>

  <!-- Auth modal -->
  <div id="authModal" class="modal">
    <h3 id="authTitle">Sign in</h3>
    <div id="authForms">
      <div id="signInForm" class="row">
        <label>Username: <input type="text" id="signinUsername" /></label>
        <label>Password: <input type="password" id="signinPassword" /></label>
      </div>
      <div id="signUpForm" style="display:none;">
        <div class="row">
          <label>Username: <input type="text" id="signupUsername" /></label>
          <label>Display name: <input type="text" id="signupDisplay" /></label>
        </div>
        <div class="row">
          <label>Password: <input type="password" id="signupPassword" /></label>
          <label>Confirm: <input type="password" id="signupPassword2" /></label>
        </div>
      </div>
      <div id="forgotForm" style="display:none;">
        <div class="row">
          <label>Username: <input type="text" id="forgotUsername" /></label>
        </div>
        <div class="row">
          <label>New password: <input type="password" id="forgotNewPassword" /></label>
          <label>Confirm: <input type="password" id="forgotNewPassword2" /></label>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
      <button id="authCancel">Cancel</button>
      <button class="primary" id="authSubmit">Submit</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="switchToSignUp" class="small">Switch to Sign up</button>
      <button id="switchToSignIn" class="small" style="display:none;">Switch to Sign in</button>
      <button id="switchToForgot" class="small">Forgot password</button>
    </div>
    <small class="note">Passwords are stored hashed (demo). This auth is client-side only for demo purposes.</small>
  </div>

  <footer class="muted" style="margin-top:16px;">GitHub Copilot Chat Assistant — implemented per request (attachments and audit stored in localStorage)</footer>

  <script>
    // STORAGE KEY and constants
    const STORAGE_KEY = 'ntc_2026_v3';
    const DEFAULTS = { vatRate:7.5, whtRate:5.0, citRate:25.0, vatEnabled:true, payeEnabled:true, pitEnabled:true, showLines:true, citEnabled:true };
    // PAYE bands as provided (annual)
    const PAYE_BANDS = [
      { upTo: 800000, rate: 0.00 },
      { upTo: 3000000, rate: 0.15 },   // next 2,200,000 (i.e upTo 3,000,000)
      { upTo: 12000000, rate: 0.18 },
      { upTo: 25000000, rate: 0.21 },
      { upTo: 50000000, rate: 0.23 },
      { upTo: Infinity, rate: 0.25 }
    ];
    const CIT_TURNOVER_THRESHOLD = 50000000; // 50,000,000

    // State
    let data = { users: [], businesses: [], transactions: {}, attachments: [], audit: [], auth: { currentUser:null } };
    let selectedUser = null;
    let selectedBiz = null;
    let activeTab = 'ledger';
    let inventoryHistory = [];
    let assetHistory = [];

    // DOM refs
    const userSelect = document.getElementById('userSelect');
    const businessSelect = document.getElementById('businessSelect');
    const btnAddUser = document.getElementById('btnAddUser');
    const btnEditUser = document.getElementById('btnEditUser');
    const btnDeleteUser = document.getElementById('btnDeleteUser');
    const btnAddBusiness = document.getElementById('btnAddBusiness');
    const btnEditBusiness = document.getElementById('btnEditBusiness');
    const btnDeleteBusiness = document.getElementById('btnDeleteBusiness');
    const btnManageAccounts = document.getElementById('btnManageAccounts');

    const txnDate = document.getElementById('txnDate');
    const txnAction = document.getElementById('txnAction');
    const txnAccount = document.getElementById('txnAccount');
    const txnDesc = document.getElementById('txnDesc');
    const txnAmount = document.getElementById('txnAmount');
    const txnVatApply = document.getElementById('txnVatApply');
    const txnVatInclusive = document.getElementById('txnVatInclusive');
    const txnWht = document.getElementById('txnWht');
    const txnWhtRate = document.getElementById('txnWhtRate');
    const txnWhtRateLabel = document.getElementById('txnWhtRateLabel');
    const txnSalary = document.getElementById('txnSalary');
    const txnContactType = document.getElementById('txnContactType');
    const txnContactName = document.getElementById('txnContactName');
    const txnReceipt = document.getElementById('txnReceipt');
    const btnAddTxn = document.getElementById('btnAddTxn');
    const mainTxnForm = document.getElementById('mainTxnForm');
    const txnDisallowable = document.getElementById('txnDisallowable');
    const txnNonTaxable = document.getElementById('txnNonTaxable');

    const inventorySubform = document.getElementById('inventorySubform');
    const invItemSelect = document.getElementById('invItemSelect');
    const invNewName = document.getElementById('invNewName');
    const invAccountSelect = document.getElementById('invAccountSelect');
    const invQty = document.getElementById('invQty');
    const invUnitPrice = document.getElementById('invUnitPrice');
    const invVat = document.getElementById('invVat');
    const invVatInclusive = document.getElementById('invVatInclusive');
    const invContactType = document.getElementById('invContactType');
    const invContactName = document.getElementById('invContactName');
    const invReceipt = document.getElementById('invReceipt');
    const btnAddInv = document.getElementById('btnAddInv');
    const btnInvCancel = document.getElementById('btnInvCancel');
    const btnInvUndo = document.getElementById('btnInvUndo');

    const assetSubform = document.getElementById('assetSubform');
    const assetName = document.getElementById('assetName');
    const assetCost = document.getElementById('assetCost');
    const assetPurchaseDate = document.getElementById('assetPurchaseDate');
    const assetLife = document.getElementById('assetLife');
    const assetCA = document.getElementById('assetCA');
    const assetDisposalDate = document.getElementById('assetDisposalDate');
    const assetDisposalProceeds = document.getElementById('assetDisposalProceeds');
    const btnAddAsset = document.getElementById('btnAddAsset');
    const btnDisposeAsset = document.getElementById('btnDisposeAsset');
    const btnAssetCancel = document.getElementById('btnAssetCancel');
    const btnAssetUndo = document.getElementById('btnAssetUndo');
    const assetPurchaseAccount = document.getElementById('assetPurchaseAccount');
    const assetDisposalAccount = document.getElementById('assetDisposalAccount');
    const assetContactType = document.getElementById('assetContactType');
    const assetContactName = document.getElementById('assetContactName');
    const assetReceipt = document.getElementById('assetReceipt');

    const ledgerTableBody = document.querySelector('#ledgerTable tbody');
    const totalsSummaryDiv = document.getElementById('totalsSummary');
    const taxSummaryDiv = document.getElementById('taxSummary');
    const profitSnapshotDiv = document.getElementById('profitSnapshot');

    const inventoryListDiv = document.getElementById('inventoryList');
    const assetListDiv = document.getElementById('assetList');
    const plSnapshotDiv = document.getElementById('plSnapshot');

    const ledgerSection = document.getElementById('ledgerSection');
    const reportsSection = document.getElementById('reportsSection');
    const reportContent = document.getElementById('reportContent');

    const modalOverlay = document.getElementById('modalOverlay');
    const userModal = document.getElementById('userModal');
    const userModalTitle = document.getElementById('userModalTitle');
    const userName = document.getElementById('userName');
    const userDisplay = document.getElementById('userDisplay');
    const userRole = document.getElementById('userRole');
    const permView = document.getElementById('permView');
    const permEdit = document.getElementById('permEdit');
    const permDelete = document.getElementById('permDelete');
    const userSave = document.getElementById('userSave');
    const userCancel = document.getElementById('userCancel');

    const businessModal = document.getElementById('businessModal');
    const businessModalTitle = document.getElementById('businessModalTitle');
    const bizName = document.getElementById('bizName');
    const bizOwnerSelect = document.getElementById('bizOwner');
    const bizEntity = document.getElementById('bizEntity');
    const bizVat = document.getElementById('bizVat');
    const bizWht = document.getElementById('bizWht');
    const bizCit = document.getElementById('bizCit');
    const bizVatEnabled = document.getElementById('bizVatEnabled');
    const bizPitEnabled = document.getElementById('bizPitEnabled');
    const bizPayeEnabled = document.getElementById('bizPayeEnabled');
    const bizShowLines = document.getElementById('bizShowLines');
    const bizCitEnabled = document.getElementById('bizCitEnabled');
    const bizSave = document.getElementById('bizSave');
    const bizCancel = document.getElementById('bizCancel');
    const bizLossBF = document.getElementById('bizLossBF');
    const bizCACF = document.getElementById('bizCACF');
    const bizDefaultExpenseDisallowable = document.getElementById('bizDefaultExpenseDisallowable');
    const bizDefaultRevenueNonTax = document.getElementById('bizDefaultRevenueNonTax');
    const bizDedPension = document.getElementById('bizDedPension');
    const bizDedRent = document.getElementById('bizDedRent');
    const bizDedLife = document.getElementById('bizDedLife');
    const bizDedMortgage = document.getElementById('bizDedMortgage');
    const bizDedNHF = document.getElementById('bizDedNHF');
    const bizCapitalBF = document.getElementById('bizCapitalBF');
    const bizFirsLabel = document.getElementById('bizFirsLabel');
    const bizFirsUrl = document.getElementById('bizFirsUrl');
    const bizContactsList = document.getElementById('bizContactsList');
    const newContactName = document.getElementById('newContactName');
    const newContactType = document.getElementById('newContactType');
    const btnAddContact = document.getElementById('btnAddContact');

    const accountsModal = document.getElementById('accountsModal');
    const accountsList = document.getElementById('accountsList');
    const newAccountName = document.getElementById('newAccountName');
    const newAccountCategory = document.getElementById('newAccountCategory');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const closeAccountsBtn = document.getElementById('closeAccountsBtn');

    const btnLedgerTab = document.getElementById('btnLedgerTab');
    const btnReportsTab = document.getElementById('btnReportsTab');

    // auth elements
    const authInfo = document.getElementById('authInfo');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignUp = document.getElementById('btnSignUp');
    const btnSignOut = document.getElementById('btnSignOut');
    const authModal = document.getElementById('authModal');
    const authTitle = document.getElementById('authTitle');
    const signInForm = document.getElementById('signInForm');
    const signUpForm = document.getElementById('signUpForm');
    const forgotForm = document.getElementById('forgotForm');
    const switchToSignUp = document.getElementById('switchToSignUp');
    const switchToSignIn = document.getElementById('switchToSignIn');
    const switchToForgot = document.getElementById('switchToForgot');
    const authCancel = document.getElementById('authCancel');
    const authSubmit = document.getElementById('authSubmit');

    // auth inputs
    const signinUsername = document.getElementById('signinUsername');
    const signinPassword = document.getElementById('signinPassword');
    const signupUsername = document.getElementById('signupUsername');
    const signupDisplay = document.getElementById('signupDisplay');
    const signupPassword = document.getElementById('signupPassword');
    const signupPassword2 = document.getElementById('signupPassword2');
    const forgotUsername = document.getElementById('forgotUsername');
    const forgotNewPassword = document.getElementById('forgotNewPassword');
    const forgotNewPassword2 = document.getElementById('forgotNewPassword2');

    // report export buttons
    const btnExportCsv = document.getElementById('btnExportCsv');
    const btnExportPdf = document.getElementById('btnExportPdf');

    // utilities
    function uid(prefix = 'id') { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8); }
    function fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function today(){ return new Date().toISOString().slice(0,10); }
    function daysBetween(a,b){ return Math.round((new Date(b) - new Date(a)) / (1000*60*60*24)); }
    function toISO(date){ return new Date(date).toISOString().slice(0,10); }

    // simple SHA-256 hashing using SubtleCrypto (returns hex)
    async function sha256Hex(str){
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', data);
      const h = Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
      return h;
    }

    // load/save
    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ seedDemo(); return; }
      try { data = JSON.parse(raw); migrate(); } catch(e){ console.error('Failed parse store, seeding demo', e); seedDemo(); }
    }
    function migrate(){
      data.users = data.users || [];
      data.businesses = data.businesses || [];
      data.transactions = data.transactions || {};
      data.attachments = data.attachments || [];
      data.audit = data.audit || [];
      data.auth = data.auth || { currentUser: null };
      data.businesses.forEach(b => {
        b.vatRate = Number(b.vatRate || DEFAULTS.vatRate);
        b.whtRate = Number(b.whtRate || DEFAULTS.whtRate);
        b.citRate = Number(b.citRate || DEFAULTS.citRate);
        b.vatEnabled = (typeof b.vatEnabled === 'undefined') ? DEFAULTS.vatEnabled : !!b.vatEnabled;
        b.payeEnabled = (typeof b.payeEnabled === 'undefined') ? DEFAULTS.payeEnabled : !!b.payeEnabled;
        b.pitEnabled = (typeof b.pitEnabled === 'undefined') ? DEFAULTS.pitEnabled : !!b.pitEnabled;
        b.showLines = (typeof b.showLines === 'undefined') ? DEFAULTS.showLines : !!b.showLines;
        b.citEnabled = (typeof b.citEnabled === 'undefined') ? DEFAULTS.citEnabled : !!b.citEnabled;
        b.accounts = b.accounts || [];
        b.inventory = b.inventory || [];
        b.assets = b.assets || [];
        b.contacts = b.contacts || [];
        b.statutoryDeductions = b.statutoryDeductions || { pension:0, rent:0, life:0, mortgage:0, nhf:0 };
        b.lossBroughtForward = Number(b.lossBroughtForward || 0);
        b.caCarryForward = Number(b.caCarryForward || 0);
        b.capitalBroughtForward = Number(b.capitalBroughtForward || 0);
      });
      for(const u of data.users){ if(!data.transactions[u.id]) data.transactions[u.id] = {}; data.businesses.forEach(b => { if(!data.transactions[u.id][b.id]) data.transactions[u.id][b.id] = []; }); }
      saveData();
    }

    function seedDemo(){
      const u = uid('user'), b = uid('biz');
      const sales = { id: uid('acct'), name: 'Sales', category: 'Revenue', disallowableDefault:false, nonTaxableDefault:false };
      const cogs = { id: uid('acct'), name: 'COGS', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const salaries = { id: uid('acct'), name: 'Salaries', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };
      const rent = { id: uid('acct'), name: 'Rent', category: 'Expense', disallowableDefault:false, nonTaxableDefault:false };

      data = {
        users: [{ id: u, username: 'admin', display:'Admin User', role:'Admin', isAdmin:true, permissions:{ view:true, edit:true, delete:true }, passwordHash: null }],
        businesses: [{
          id: b,
          name: 'Demo Business',
          ownerId: u,
          entity: 'Company',
          vatRate: DEFAULTS.vatRate,
          whtRate: DEFAULTS.whtRate,
          citRate: DEFAULTS.citRate,
          vatEnabled: true, pitEnabled: true, payeEnabled: true, showLines: true, citEnabled: true,
          accounts: [sales, cogs, salaries, rent],
          inventory: [{ id: uid('item'), name: 'Widget', qty: 100, avgCost: 500.00 }],
          assets: [],
          contacts: [{ id: uid('c'), name:'John Employee', type:'Employee', statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 } }],
          statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
          lossBroughtForward: 0, caCarryForward: 0, capitalBroughtForward: 0,
          defaultExpenseDisallowable:false, defaultRevenueNonTax:false
        }],
        transactions: {},
        attachments: [],
        audit: [],
        auth: { currentUser: null }
      };
      data.transactions[u] = {};
      data.transactions[u][b] = [
        { id: uid('txn'), date: today(), action: 'Revenue', accountId: sales.id, accountName: sales.name, description: 'Demo sale', amount: 150000, netAmount:150000, vatApplied:false, vatAmount:0, whApplied:false, whAmount:0, whRate:0, salary:false, contactType:'Customer', contactName:'ACME', disallowable:false, nonTaxable:false },
        { id: uid('txn'), date: today(), action: 'Expense', accountId: salaries.id, accountName: salaries.name, description: 'Demo salary', amount: 50000, netAmount:50000, vatApplied:false, vatAmount:0, whApplied:false, whAmount:0, whRate:0, salary:true, contactType:'Employee', contactName:'John Employee', disallowable:false, nonTaxable:false }
      ];
      addAudit('seed','system','',`Seeded demo data`);
      saveData();
    }

    // Audit & attachments
    function addAudit(type, entityType, entityId, details){
      const entry = { id: uid('audit'), timestamp: new Date().toISOString(), userId: data.auth.currentUser, type, entityType, entityId, details };
      data.audit = data.audit || [];
      data.audit.push(entry);
      saveData();
    }
    function addAttachment({ bizId, txnId, fileObj, uploadedBy }){
      const att = { id: uid('att'), bizId, txnId: txnId || null, filename: fileObj.filename, mime: fileObj.mime, dataUrl: fileObj.dataUrl, uploadedBy: uploadedBy || data.auth.currentUser, timestamp: new Date().toISOString() };
      data.attachments.push(att);
      saveData();
      addAudit('attachment.add','attachment', att.id, `Uploaded ${att.filename}`);
      return att;
    }
    function getAttachmentsForTxn(txnId){ return (data.attachments||[]).filter(a=>a.txnId === txnId); }
    function getAttachmentsForBiz(bizId){ return (data.attachments||[]).filter(a=>a.bizId === bizId); }

    // UI utilities: modals
    function openModal(modal){ modalOverlay.style.display='block'; modal.style.display='block'; window.scrollTo({top:0}); }
    function closeModal(modal){ modalOverlay.style.display='none'; modal.style.display='none'; }
    modalOverlay.addEventListener('click', ()=> {
      [userModal, businessModal, accountsModal, authModal].forEach(m => { if(m.style.display==='block') closeModal(m); });
    });

    // INIT
    loadData();
    initUI();
    refreshSelectors();
    ensureSelection();
    populateAccountSelect();
    resetForms();
    renderAll();

    // init UI wiring
    function initUI(){
      // Users
      btnAddUser.addEventListener('click', ()=> openUserModal());
      btnEditUser.addEventListener('click', ()=> {
        if(!selectedUser) return alert('Select a user');
        const u = findUser(selectedUser);
        if(!u) return alert('User not found');
        openUserModal(u.id);
      });
      btnDeleteUser.addEventListener('click', ()=> {
        if(!selectedUser) return alert('Select a user');
        if(!confirm('Delete user? This cannot be undone')) return;
        deleteUser(selectedUser);
      });
      userSave.addEventListener('click', ()=> {
        const username = (userName.value||'').trim();
        if(!username) return alert('Username required');
        const editId = userSave.dataset.edit;
        if(editId){
          const u = findUser(editId);
          if(!u) return alert('User not found');
          u.username = username; u.display = userDisplay.value || username; u.role = userRole.value;
          u.permissions = { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked };
          saveData(); addAudit('user.edit','user',u.id,'Edited user');
        } else {
          const newUser = { id: uid('user'), username, display: userDisplay.value || username, role: userRole.value, isAdmin: userRole.value === 'Admin', permissions: { view: !!permView.checked, edit: !!permEdit.checked, delete: !!permDelete.checked }, passwordHash: null };
          data.users.push(newUser);
          if(!data.transactions[newUser.id]) data.transactions[newUser.id] = {};
          data.businesses.forEach(b => data.transactions[newUser.id][b.id] = data.transactions[newUser.id][b.id] || []);
          addAudit('user.add','user',newUser.id,'Added user');
          saveData();
        }
        closeModal(userModal);
        refreshSelectors();
        ensureSelection();
        renderAll();
      });
      userCancel.addEventListener('click', ()=> closeModal(userModal));

      // Business
      btnAddBusiness.addEventListener('click', ()=> {
        businessModalTitle.textContent = 'Add Business';
        bizName.value = ''; bizOwnerSelect.value = data.users[0] ? data.users[0].id : '';
        bizEntity.value = 'Company'; bizVat.value = DEFAULTS.vatRate; bizWht.value = DEFAULTS.whtRate; bizCit.value = DEFAULTS.citRate;
        bizVatEnabled.checked = true; bizPitEnabled.checked = true; bizPayeEnabled.checked = true; bizShowLines.checked = true; bizCitEnabled.checked = true;
        bizSave.dataset.edit = '';
        bizContactsList.innerHTML = '';
        openModal(businessModal);
      });
      btnEditBusiness.addEventListener('click', ()=> {
        if(!selectedBiz) return alert('Select business');
        const b = findBiz(selectedBiz); if(!b) return alert('Business not found');
        businessModalTitle.textContent = 'Edit Business';
        bizName.value = b.name || ''; bizOwnerSelect.value = b.ownerId || (data.users[0] && data.users[0].id) || '';
        bizEntity.value = b.entity || 'Company'; bizVat.value = b.vatRate || DEFAULTS.vatRate; bizWht.value = b.whtRate || DEFAULTS.whtRate; bizCit.value = b.citRate || DEFAULTS.citRate;
        bizVatEnabled.checked = !!b.vatEnabled; bizPitEnabled.checked = !!b.pitEnabled; bizPayeEnabled.checked = !!b.payeEnabled; bizShowLines.checked = !!b.showLines; bizCitEnabled.checked = !!b.citEnabled;
        bizLossBF.value = b.lossBroughtForward || 0; bizCACF.value = b.caCarryForward || 0; bizCapitalBF.value = b.capitalBroughtForward || 0;
        bizDefaultExpenseDisallowable.checked = !!b.defaultExpenseDisallowable; bizDefaultRevenueNonTax.checked = !!b.defaultRevenueNonTax;
        bizDedPension.value = b.statutoryDeductions?.pension || 0; bizDedRent.value = b.statutoryDeductions?.rent || 0; bizDedLife.value = b.statutoryDeductions?.life || 0;
        bizDedMortgage.value = b.statutoryDeductions?.mortgage || 0; bizDedNHF.value = b.statutoryDeductions?.nhf || 0;
        bizFirsLabel.value = b.firsLabel || DEFAULTS.firsLabel; bizFirsUrl.value = b.firsUrl || DEFAULTS.firsUrl;
        renderBizContacts(b);
        bizSave.dataset.edit = b.id;
        openModal(businessModal);
      });
      btnDeleteBusiness.addEventListener('click', ()=> {
        if(!selectedBiz) return alert('Select business');
        if(!confirm('Delete business and all its transactions/attachments?')) return;
        deleteBusiness(selectedBiz);
      });
      bizSave.addEventListener('click', ()=> {
        const name = (bizName.value||'').trim();
        if(!name) return alert('Business name required');
        const editId = bizSave.dataset.edit;
        if(editId){
          const b = findBiz(editId);
          if(!b) return alert('Business not found');
          b.name = name; b.ownerId = bizOwnerSelect.value; b.entity = bizEntity.value;
          b.vatRate = Number(bizVat.value || DEFAULTS.vatRate); b.whtRate = Number(bizWht.value || DEFAULTS.whtRate); b.citRate = Number(bizCit.value || DEFAULTS.citRate);
          b.vatEnabled = !!bizVatEnabled.checked; b.pitEnabled = !!bizPitEnabled.checked; b.payeEnabled = !!bizPayeEnabled.checked; b.showLines = !!bizShowLines.checked; b.citEnabled = !!bizCitEnabled.checked;
          b.lossBroughtForward = Number(bizLossBF.value || 0); b.caCarryForward = Number(bizCACF.value || 0); b.capitalBroughtForward = Number(bizCapitalBF.value || 0);
          b.defaultExpenseDisallowable = !!bizDefaultExpenseDisallowable.checked; b.defaultRevenueNonTax = !!bizDefaultRevenueNonTax.checked;
          b.statutoryDeductions = { pension:Number(bizDedPension.value||0), rent:Number(bizDedRent.value||0), life:Number(bizDedLife.value||0), mortgage:Number(bizDedMortgage.value||0), nhf:Number(bizDedNHF.value||0) };
          b.firsLabel = bizFirsLabel.value || DEFAULTS.firsLabel; b.firsUrl = bizFirsUrl.value || DEFAULTS.firsUrl;
          saveData(); addAudit('business.edit','business', b.id, 'Edited business');
        } else {
          const newBiz = {
            id: uid('biz'), name, ownerId: bizOwnerSelect.value || (data.users[0] && data.users[0].id),
            entity: bizEntity.value, vatRate: Number(bizVat.value||DEFAULTS.vatRate), whtRate: Number(bizWht.value||DEFAULTS.whtRate), citRate: Number(bizCit.value||DEFAULTS.citRate),
            vatEnabled: !!bizVatEnabled.checked, pitEnabled: !!bizPitEnabled.checked, payeEnabled: !!bizPayeEnabled.checked, showLines: !!bizShowLines.checked, citEnabled: !!bizCitEnabled.checked,
            accounts: [], inventory: [], assets: [], contacts: [], statutoryDeductions: { pension:0, rent:0, life:0, mortgage:0, nhf:0 },
            lossBroughtForward:0, caCarryForward:0, capitalBroughtForward:0, defaultExpenseDisallowable:false, defaultRevenueNonTax:false
          };
          newBiz.accounts.push({ id: uid('acct'), name:'Sales', category:'Revenue', disallowableDefault:false, nonTaxableDefault:false });
          newBiz.accounts.push({ id: uid('acct'), name:'COGS', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
          newBiz.accounts.push({ id: uid('acct'), name:'Salaries', category:'Expense', disallowableDefault:false, nonTaxableDefault:false });
          data.businesses.push(newBiz);
          for(const u of data.users){ data.transactions[u.id] = data.transactions[u.id] || {}; data.transactions[u.id][newBiz.id] = []; }
          addAudit('business.add','business', newBiz.id, 'Added business');
          saveData();
        }
        closeModal(businessModal);
        refreshSelectors();
        ensureSelection();
        populateAccountSelect();
        renderAll();
      });
      bizCancel.addEventListener('click', ()=>closeModal(businessModal));
      btnAddContact.addEventListener('click', ()=> {
        if(!selectedBiz) return alert('Select business first');
        const b = findBiz(selectedBiz);
        const name = (newContactName.value||'').trim();
        if(!name) return alert('Contact name required');
        b.contacts = b.contacts || [];
        b.contacts.push({ id: uid('c'), name, type: newContactType.value, statutory:{ pension:0, rent:0, life:0, mortgage:0, nhf:0 } });
        saveData();
        renderBizContacts(b);
      });

      // accounts modal
      btnManageAccounts.addEventListener('click', ()=> {
        if(!selectedBiz) return alert('Select business');
        renderAccounts();
        openModal(accountsModal);
      });
      addAccountBtn.addEventListener('click', ()=> {
        const name = (newAccountName.value||'').trim();
        const cat = newAccountCategory.value;
        if(!name) return alert('Account name required');
        const b = findBiz(selectedBiz);
        b.accounts = b.accounts || [];
        b.accounts.push({ id: uid('acct'), name, category: cat, disallowableDefault:false, nonTaxableDefault:false });
        saveData();
        renderAccounts();
        populateAccountSelect();
      });
      closeAccountsBtn.addEventListener('click', ()=> closeModal(accountsModal));

      // transaction form behavior
      txnAction.addEventListener('change', ()=> {
        const val = txnAction.value;
        if(val === 'InventoryPurchase' || val === 'InventorySale'){
          mainTxnForm.style.display = 'none';
          inventorySubform.style.display = 'block';
          assetSubform.style.display = 'none';
          populateAccountSelect();
        } else if(val === 'FixedAssetPurchase' || val === 'FixedAssetDisposal'){
          mainTxnForm.style.display = 'none';
          assetSubform.style.display = 'block';
          inventorySubform.style.display = 'none';
          populateAccountSelect();
        } else {
          mainTxnForm.style.display = 'flex';
          inventorySubform.style.display = 'none';
          assetSubform.style.display = 'none';
        }
      });
      txnWht.addEventListener('change', ()=> { txnWhtRateLabel.style.display = txnWht.checked ? 'inline-flex' : 'none'; } );
      btnAddTxn.addEventListener('click', handleAddTransaction);

      // inventory
      btnAddInv.addEventListener('click', handleInventoryAction);
      btnInvCancel.addEventListener('click', ()=>{ txnAction.value=''; inventorySubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
      btnInvUndo.addEventListener('click', handleUndoInventory);

      // assets
      btnAddAsset.addEventListener('click', handleAddAsset);
      btnDisposeAsset.addEventListener('click', handleDisposeAsset);
      btnAssetCancel.addEventListener('click', ()=>{ txnAction.value=''; assetSubform.style.display='none'; mainTxnForm.style.display='flex'; resetForms(); });
      btnAssetUndo.addEventListener('click', handleUndoAsset);

      // ledger search
      document.getElementById('btnSearch').addEventListener('click', renderLedger);
      document.getElementById('btnClearSearch').addEventListener('click', ()=>{ document.getElementById('ledgerSearch').value=''; renderLedger(); });

      // export/import/clear
      document.getElementById('btnExport').addEventListener('click', ()=> {
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'ntc_data.json'; a.click(); URL.revokeObjectURL(url);
      });
      document.getElementById('btnImport').addEventListener('click', ()=> document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change', (e)=> {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const incoming = JSON.parse(r.result);
            if(!confirm('Import will replace current data. Continue?')) return;
            data = incoming;
            migrate();
            refreshSelectors();
            ensureSelection();
            populateAccountSelect();
            resetForms();
            renderAll();
            saveData();
            alert('Import complete');
          } catch(err){ alert('Invalid JSON'); }
        };
        r.readAsText(f);
      });
      document.getElementById('btnClearAll').addEventListener('click', ()=> {
        if(!confirm('Clear all stored data?')) return;
        localStorage.removeItem(STORAGE_KEY);
        data = { users:[], businesses:[], transactions:{}, attachments:[], audit:[], auth:{ currentUser:null } };
        seedDemo();
        refreshSelectors();
        ensureSelection();
        populateAccountSelect();
        resetForms();
        renderAll();
      });

      // tabs
      btnLedgerTab.addEventListener('click', ()=> { activeTab='ledger'; renderTab(); });
      btnReportsTab.addEventListener('click', ()=> { activeTab='reports'; renderTab(); });

      document.querySelectorAll('#reportsSection .tab').forEach(tb => {
        tb.addEventListener('click', (e) => {
          document.querySelectorAll('#reportsSection .tab').forEach(t=>t.classList.remove('active'));
          e.target.classList.add('active');
          renderReport(e.target.dataset.report);
        });
      });

      // auth wiring
      btnSignIn.addEventListener('click', ()=> openAuthModal('signin'));
      btnSignUp.addEventListener('click', ()=> openAuthModal('signup'));
      btnSignOut.addEventListener('click', ()=> {
        data.auth.currentUser = null; saveData(); refreshAuthUI(); renderAll();
      });
      switchToSignUp.addEventListener('click', ()=> switchAuthMode('signup'));
      switchToSignIn.addEventListener('click', ()=> switchAuthMode('signin'));
      switchToForgot.addEventListener('click', ()=> switchAuthMode('forgot'));
      authCancel.addEventListener('click', ()=> closeModal(authModal));
      authSubmit.addEventListener('click', handleAuthSubmit);

      // report exports
      btnExportCsv.addEventListener('click', ()=> exportCsvForActiveReport());
      btnExportPdf.addEventListener('click', ()=> exportPdfForActiveReport());
    }

    // permission helpers (simple)
    function canEdit(){ const u = findUser(selectedUser); return !!(u && (u.permissions?.edit || u.isAdmin)); }
    function canView(){ const u = findUser(selectedUser); return !!(u && (u.permissions?.view || u.isAdmin)); }
    function canDelete(){ const u = findUser(selectedUser); return !!(u && (u.permissions?.delete || u.isAdmin)); }

    // selectors & lists
    function refreshSelectors(){
      userSelect.innerHTML=''; businessSelect.innerHTML=''; bizOwnerSelect.innerHTML='';
      data.users.forEach(u => {
        const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.display || u.username; userSelect.appendChild(opt);
        const opt2 = opt.cloneNode(true); bizOwnerSelect.appendChild(opt2);
      });
      data.businesses.forEach(b => {
        const opt = document.createElement('option'); opt.value = b.id; const owner = data.users.find(u=>u.id===b.ownerId); opt.textContent = b.name + (owner ? ' — ' + (owner.display || owner.username) : '');
        businessSelect.appendChild(opt);
      });
      userSelect.removeEventListener('change', onUserChange);
      businessSelect.removeEventListener('change', onBizChange);
      userSelect.addEventListener('change', onUserChange);
      businessSelect.addEventListener('change', onBizChange);
      refreshAuthUI();
    }

    function onUserChange(e){ selectedUser = e.target.value; ensureSelection(); renderAll(); }
    function onBizChange(e){ selectedBiz = e.target.value; populateAccountSelect(); renderAll(); }

    function ensureSelection(){
      if(!selectedUser) selectedUser = data.users[0] ? data.users[0].id : null;
      if(!selectedBiz) selectedBiz = data.businesses[0] ? data.businesses[0].id : null;
      if(selectedUser) userSelect.value = selectedUser;
      if(selectedBiz) businessSelect.value = selectedBiz;
    }

    function findUser(id){ return data.users.find(u=>u.id===id); }
    function findBiz(id){ return data.businesses.find(b=>b.id===id); }

    function populateAccountSelect(){
      txnAccount.innerHTML=''; invAccountSelect.innerHTML=''; assetPurchaseAccount.innerHTML=''; assetDisposalAccount.innerHTML=''; invItemSelect.innerHTML='';
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      (biz.accounts||[]).forEach(a => {
        const opt = document.createElement('option'); opt.value=a.id; opt.textContent = a.name + ' (' + a.category + ')'; txnAccount.appendChild(opt);
        invAccountSelect.appendChild(opt.cloneNode(true));
        assetPurchaseAccount.appendChild(opt.cloneNode(true));
        assetDisposalAccount.appendChild(opt.cloneNode(true));
      });
      if((biz.accounts||[]).length===0){
        biz.accounts = [{id:uid('acct'),name:'Sales',category:'Revenue',disallowableDefault:false,nonTaxableDefault:false},{id:uid('acct'),name:'COGS',category:'Expense',disallowableDefault:false,nonTaxableDefault:false}];
        saveData();
        populateAccountSelect();
      }
      (biz.inventory||[]).forEach(it => {
        const opt = document.createElement('option'); opt.value = it.id; opt.textContent = it.name + ' — qty:' + it.qty + ' @ ' + fmt(it.avgCost); invItemSelect.appendChild(opt);
      });
      const newOpt = document.createElement('option'); newOpt.value='__new__'; newOpt.textContent='-- Add new item --'; invItemSelect.appendChild(newOpt);
      invItemSelect.value = (biz.inventory && biz.inventory.length) ? biz.inventory[0].id : '__new__';
    }

    function resetForms(){
      txnDate.value = today();
      txnAction.value = '';
      txnDesc.value = ''; txnAmount.value = ''; txnWht.checked = false; txnWhtRate.value = ''; txnWhtRateLabel.style.display = 'none'; txnSalary.checked = false; txnVatApply.checked = false; txnVatInclusive.checked = false;
      txnContactType.value = ''; txnContactName.value = ''; txnReceipt.value = '';
      txnDisallowable.checked = false; txnNonTaxable.checked = false;
      inventorySubform.style.display = 'none'; assetSubform.style.display = 'none';
    }

    // render helpers
    function renderAll(){
      refreshSelectors();
      ensureSelection();
      populateAccountSelect();
      renderLedger();
      renderQuickPanels();
      renderReportsDefault();
      refreshAuthUI();
    }

    function renderLedger(){
      ledgerTableBody.innerHTML = '';
      const search = (document.getElementById('ledgerSearch').value||'').toLowerCase();
      if(!selectedUser || !selectedBiz){ ledgerTableBody.innerHTML='<tr><td colspan="14">Select user and business</td></tr>'; return; }
      const txns = (data.transactions[selectedUser] && data.transactions[selectedUser][selectedBiz]) || [];
      for(const t of txns){
        if(search){
          const s = `${t.date} ${t.action} ${t.accountName || ''} ${t.description || ''} ${t.amount || ''} ${t.contactName || ''}`.toLowerCase();
          if(!s.includes(search)) continue;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.date}</td><td>${t.action}</td><td>${t.accountName||''}</td><td>${t.description||''}</td><td style="text-align:right">${fmt(t.netAmount||t.amount||0)}</td><td style="text-align:right">${fmt(t.vatAmount||0)}</td><td style="text-align:right">${fmt(t.whAmount||0)}</td><td style="text-align:right">${fmt(t.payeAmount||0)}</td><td>${t.disallowable? 'Yes' : 'No'}</td><td>${t.nonTaxable? 'Yes' : 'No'}</td><td>${(t.contactType? t.contactType + ': ' : '') + (t.contactName||'')}</td><td>${(getAttachmentsForTxn(t.id)||[]).map(a=>a.filename).join(', ')}</td><td>${t.itemId||t.assetId||''}</td><td><button class="small" data-id="${t.id}">Del</button></td>`;
        ledgerTableBody.appendChild(tr);
        tr.querySelector('button')?.addEventListener('click', (e)=> {
          if(!confirm('Delete transaction?')) return;
          deleteTransaction(t.id);
        });
      }
      renderTotalsAndTaxSummary();
    }

    function renderQuickPanels(){
      const biz = findBiz(selectedBiz);
      inventoryListDiv.innerHTML = '';
      assetListDiv.innerHTML = '';
      plSnapshotDiv.innerHTML = '';
      if(!biz) return;
      (biz.inventory||[]).forEach(it => {
        const div = document.createElement('div'); div.className='account-row'; div.innerHTML = `<div>${it.name}</div><div class="small-muted">qty:${it.qty} avg:${fmt(it.avgCost)}</div>`; inventoryListDiv.appendChild(div);
      });
      (biz.assets||[]).forEach(a => {
        const div = document.createElement('div'); div.className='account-row'; div.innerHTML = `<div>${a.name}</div><div class="small-muted">cost:${fmt(a.cost)} ca%:${fmt(a.caPercent)}</div>`; assetListDiv.appendChild(div);
      });
      const pl = computePLSnapshot();
      plSnapshotDiv.innerHTML = `<div><strong>Revenue:</strong> ₦${fmt(pl.revenue)}<br><strong>COGS:</strong> ₦${fmt(pl.cogs)}<br><strong>Gross Profit:</strong> ₦${fmt(pl.gross)}<br><strong>Expenses:</strong> ₦${fmt(pl.expenses)}<br><strong>Net Profit (pre-tax):</strong> ₦${fmt(pl.net)}</div>`;
    }

    function renderTotalsAndTaxSummary(){
      const taxSummary = computeTaxSummary();
      totalsSummaryDiv.innerHTML = `<div><strong>Totals:</strong><br>
        Total Revenue: ₦${fmt(taxSummary.totals.revenue)}<br>
        Total Expenses: ₦${fmt(taxSummary.totals.expenses)}<br>
        Net Profit (pre-tax): ₦${fmt(taxSummary.profitBeforeTax)}<br>
        VAT Collected: ₦${fmt(taxSummary.vat.collected)} | VAT Paid: ₦${fmt(taxSummary.vat.paid)} | VAT Net: ₦${fmt(taxSummary.vat.net)}</div>`;
      let taxHtml = `<div><strong>Tax Summary (${new Date().getFullYear()}):</strong><br>
        PAYE total (estimate): ₦${fmt(taxSummary.paye.total)}<br>
        WHT receivable: ₦${fmt(taxSummary.wht.receivable)} | WHT payable: ₦${fmt(taxSummary.wht.payable)}<br>
        Taxable profit: ₦${fmt(taxSummary.cit.taxableProfit)}<br>
        CIT applicable rate: ${taxSummary.cit.rate}% => CIT payable: ₦${fmt(taxSummary.cit.payable)}`;
      if(findBiz(selectedBiz)?.showLines) taxHtml += `<div class="small-muted">Details: CA total: ₦${fmt(taxSummary.capitalAllowances.totalCA)} | 2/3 CA deduction: ₦${fmt(taxSummary.capitalAllowances.twoThirds)}</div>`;
      taxHtml += `</div>`;
      taxSummaryDiv.innerHTML = taxHtml;
      profitSnapshotDiv.innerHTML = `<strong>Profit Snapshot:</strong><div>Gross profit: ₦${fmt(taxSummary.profitBreakdown.gross)} | Operating profit: ₦${fmt(taxSummary.profitBreakdown.operating)} | Profit before tax: ₦${fmt(taxSummary.profitBeforeTax)}</div>`;
    }

    // Transaction helpers
    function handleAddTransaction(){
      if(!selectedBiz || !selectedUser) return alert('Select user and business');
      const biz = findBiz(selectedBiz);
      const amount = Number(txnAmount.value || 0);
      if(!txnDate.value) return alert('Date required');
      if(!txnAccount.value && txnAction.value !== 'InventorySale' && txnAction.value !== 'InventoryPurchase') return alert('Account required');
      const acct = biz.accounts.find(a=>a.id === txnAccount.value);
      const netAmount = (() => {
        if(txnVatApply.checked){
          const vr = biz.vatRate || DEFAULTS.vatRate;
          if(txnVatInclusive.checked){
            // gross includes VAT: net = amount / (1 + rate)
            return Number((amount / (1 + vr/100)).toFixed(2));
          } else {
            return amount;
          }
        }
        return amount;
      })();
      const vatAmount = txnVatApply.checked ? Number(((txnVatInclusive.checked ? (amount - netAmount) : (netAmount * (biz.vatRate/100))).toFixed(2))) : 0;
      const whRateUsed = txnWht.checked ? (Number(txnWhtRate.value || biz.whtRate || DEFAULTS.whtRate)) : 0;
      const whAmount = txnWht.checked ? Number(((netAmount * whRateUsed)/100).toFixed(2)) : 0;
      const payeAmount = txnSalary.checked ? 0 : 0; // PAYE computed on annualization later
      const txn = {
        id: uid('txn'),
        date: txnDate.value,
        action: txnAction.value || (netAmount >= 0 ? 'Revenue' : 'Expense'),
        accountId: acct ? acct.id : null,
        accountName: acct ? acct.name : '',
        description: txnDesc.value || '',
        amount: amount,
        netAmount: netAmount,
        vatApplied: !!txnVatApply.checked,
        vatAmount: vatAmount,
        whApplied: !!txnWht.checked,
        whAmount: whAmount,
        whRate: whRateUsed,
        salary: !!txnSalary.checked,
        payeAmount: payeAmount,
        contactType: txnContactType.value || '',
        contactName: txnContactName.value || '',
        disallowable: !!txnDisallowable.checked || (acct && acct.disallowableDefault) || findBiz(selectedBiz).defaultExpenseDisallowable,
        nonTaxable: !!txnNonTaxable.checked || (acct && acct.nonTaxableDefault) || findBiz(selectedBiz).defaultRevenueNonTax,
        itemId: null,
        assetId: null
      };
      data.transactions[selectedUser] = data.transactions[selectedUser] || {}; data.transactions[selectedUser][selectedBiz] = data.transactions[selectedUser][selectedBiz] || [];
      data.transactions[selectedUser][selectedBiz].push(txn);
      // attachments
      if(txnReceipt.files && txnReceipt.files[0]){
        const f = txnReceipt.files[0];
        const r = new FileReader();
        r.onload = () => addAttachment({ bizId:selectedBiz, txnId: txn.id, fileObj:{ filename:f.name, mime:f.type, dataUrl:r.result }});
        r.readAsDataURL(f);
      }
      saveData();
      addAudit('txn.add','txn', txn.id, `Added txn ${txn.description}`);
      resetForms();
      renderAll();
    }

    function deleteTransaction(id){
      const arr = data.transactions[selectedUser] && data.transactions[selectedUser][selectedBiz];
      if(!arr) return;
      const idx = arr.findIndex(t=>t.id===id);
      if(idx>=0){ arr.splice(idx,1); saveData(); addAudit('txn.del','txn',id,'Deleted txn'); renderAll(); }
    }

    // Inventory handling (weighted avg)
    function handleInventoryAction(){
      if(!selectedBiz) return alert('Select business');
      const biz = findBiz(selectedBiz);
      let itemId = invItemSelect.value;
      const addingNew = itemId === '__new__';
      if(addingNew && !invNewName.value) return alert('Provide new item name');
      if(!invQty.value || Number(invQty.value) <= 0) return alert('Qty required');
      const qty = Number(invQty.value);
      const unitPrice = Number(invUnitPrice.value || 0);
      const acct = findBiz(selectedBiz).accounts.find(a=>a.id === invAccountSelect.value);
      // purchase or sale depending on txnAction selection used to open form
      const action = txnAction.value || 'InventoryPurchase';
      if(action === 'InventoryPurchase'){
        // add to inventory and create transaction
        const name = addingNew ? invNewName.value : (biz.inventory.find(i=>i.id===itemId)?.name || '');
        if(addingNew){
          const newItem = { id: uid('item'), name, qty: qty, avgCost: unitPrice || 0 };
          biz.inventory.push(newItem);
          itemId = newItem.id;
        } else {
          // update weighted avg
          const it = biz.inventory.find(i=>i.id===itemId);
          const totalCostExisting = it.avgCost * it.qty;
          const totalCostNew = (unitPrice || it.avgCost) * qty;
          const newQty = it.qty + qty;
          const newAvg = newQty ? ((totalCostExisting + totalCostNew) / newQty) : 0;
          it.qty = newQty;
          it.avgCost = Number(newAvg.toFixed(2));
        }
        // create txn
        const tx = { id: uid('txn'), date: txnDate.value || today(), action: 'InventoryPurchase', accountId: acct?.id || null, accountName: acct?.name || 'Inventory', description: `Inventory purchase ${invNewName.value||''}`, amount: (unitPrice*qty), netAmount: (unitPrice*qty), vatApplied: invVat.checked, vatAmount: invVat.checked ? ((invVatInclusive.checked ? 0 : (unitPrice*qty)*(findBiz(selectedBiz).vatRate/100))):0, whApplied:false, whAmount:0, salary:false, contactType: invContactType.value, contactName: invContactName.value, disallowable:false, nonTaxable:false, itemId };
        data.transactions[selectedUser][selectedBiz].push(tx);
        inventoryHistory.push({ type:'purchase', itemId, qty, unitPrice });
        addAudit('inventory.add','inventory', itemId, `Purchased ${qty} of ${itemId}`);
      } else if(action === 'InventorySale'){
        // sale uses current avg cost for COGS
        const it = biz.inventory.find(i=>i.id===itemId);
        if(!it) return alert('Select item');
        if(it.qty < qty) return alert('Insufficient qty');
        const saleAmount = unitPrice * qty;
        it.qty -= qty;
        const cogs = Number((it.avgCost * qty).toFixed(2));
        const txSale = { id: uid('txn'), date: txnDate.value || today(), action: 'InventorySale', accountId: acct?.id || null, accountName: acct?.name || 'Sales', description: `Sale ${it.name}`, amount: saleAmount, netAmount: saleAmount, vatApplied: invVat.checked, vatAmount: invVat.checked ? ((invVatInclusive.checked ? 0 : saleAmount*(findBiz(selectedBiz).vatRate/100))):0, whApplied:false, whAmount:0, salary:false, contactType: invContactType.value, contactName: invContactName.value, disallowable:false, nonTaxable:false, itemId };
        data.transactions[selectedUser][selectedBiz].push(txSale);
        // create COGS txn (expense)
        const cogsAcct = findBiz(selectedBiz).accounts.find(a=>a.category==='Expense') || { id: uid('acct'), name:'COGS', category:'Expense' };
        const txCogs = { id: uid('txn'), date: txnDate.value || today(), action: 'COGS', accountId: cogsAcct.id, accountName: cogsAcct.name, description: `COGS for ${it.name}`, amount: cogs, netAmount: cogs, vatApplied:false, vatAmount:0, whApplied:false, whAmount:0, salary:false, contactType:'', contactName:'', disallowable:false, nonTaxable:false, itemId };
        data.transactions[selectedUser][selectedBiz].push(txCogs);
        inventoryHistory.push({ type:'sale', itemId, qty, saleAmount, cogs });
        addAudit('inventory.sale','inventory', itemId, `Sold ${qty} of ${itemId}`);
      }
      saveData();
      resetForms();
      renderAll();
    }

    function handleUndoInventory(){
      const last = inventoryHistory.pop();
      if(!last) return alert('No inventory history');
      const biz = findBiz(selectedBiz);
      if(last.type==='purchase'){
        const it = biz.inventory.find(i=>i.id===last.itemId);
        if(it){
          it.qty -= last.qty;
          if(it.qty <=0) biz.inventory = biz.inventory.filter(x=>x.id!==it.id);
        }
      } else if(last.type==='sale'){
        const it = biz.inventory.find(i=>i.id===last.itemId);
        if(it) it.qty += last.qty;
      }
      saveData(); renderAll();
    }

    // Asset handlers
    function handleAddAsset(){
      if(!selectedBiz) return alert('Select business');
      const biz = findBiz(selectedBiz);
      if(!assetName.value) return alert('Asset name required');
      const a = { id: uid('asset'), name: assetName.value, cost: Number(assetCost.value||0), purchaseDate: assetPurchaseDate.value || today(), usefulLifeYears: Number(assetLife.value||5), caPercent: Number(assetCA.value || 20), disposalDate: null, disposalProceeds:0 };
      biz.assets.push(a);
      data.transactions[selectedUser][selectedBiz].push({ id: uid('txn'), date: a.purchaseDate, action:'FixedAssetPurchase', accountId: assetPurchaseAccount.value, accountName: findBiz(selectedBiz).accounts.find(x=>x.id===assetPurchaseAccount.value)?.name||'', description: `Asset purchase ${a.name}`, amount: a.cost, netAmount: a.cost, vatApplied:false, vatAmount:0, whApplied:false, whAmount:0, salary:false, contactType: assetContactType.value, contactName: assetContactName.value, disallowable:false, nonTaxable:false, assetId: a.id });
      assetHistory.push({ type:'add', assetId: a.id });
      saveData(); addAudit('asset.add','asset', a.id, `Added asset ${a.name}`); renderAll();
    }

    function handleDisposeAsset(){
      const biz = findBiz(selectedBiz);
      const ad = assetDisposalDate.value;
      const proceeds = Number(assetDisposalProceeds.value||0);
      // find matching asset by name (simple)
      const asset = biz.assets.find(a=>a.name === assetName.value) || biz.assets[biz.assets.length-1];
      if(!asset) return alert('Asset not found (select an asset name matching existing asset)');
      asset.disposalDate = ad || today();
      asset.disposalProceeds = proceeds;
      data.transactions[selectedUser][selectedBiz].push({ id: uid('txn'), date: asset.disposalDate, action:'FixedAssetDisposal', accountId: assetDisposalAccount.value, accountName: findBiz(selectedBiz).accounts.find(x=>x.id===assetDisposalAccount.value)?.name||'', description: `Disposal ${asset.name}`, amount: proceeds, netAmount: proceeds, vatApplied:false, vatAmount:0, whApplied:false, whAmount:0, salary:false, contactType: assetContactType.value, contactName: assetContactName.value, disallowable:false, nonTaxable:false, assetId: asset.id });
      assetHistory.push({ type:'dispose', assetId: asset.id });
      saveData(); addAudit('asset.dispose','asset', asset.id, `Disposed asset ${asset.name}`); renderAll();
    }

    function handleUndoAsset(){
      const last = assetHistory.pop();
      if(!last) return alert('No asset history');
      const biz = findBiz(selectedBiz);
      if(last.type==='add'){
        biz.assets = biz.assets.filter(a=>a.id !== last.assetId);
      } else if(last.type==='dispose'){
        const a = biz.assets.find(x=>x.id===last.assetId);
        if(a){ a.disposalDate = null; a.disposalProceeds = 0; }
      }
      saveData(); renderAll();
    }

    // Accounts & contacts rendering
    function renderAccounts(){
      accountsList.innerHTML = '';
      const biz = findBiz(selectedBiz);
      if(!biz) return;
      biz.accounts.forEach(a => {
        const div = document.createElement('div'); div.className='account-row';
        div.innerHTML = `<div>${a.name} <span class="small-muted">(${a.category})</span></div><div><label>Disallowable <input type="checkbox" data-id="${a.id}" class="acctDis" ${a.disallowableDefault? 'checked':''}></label> <label>Non-taxable <input type="checkbox" data-id="${a.id}" class="acctNon" ${a.nonTaxableDefault? 'checked':''}></label> <button class="small danger acctDel" data-id="${a.id}">Del</button></div>`;
        accountsList.appendChild(div);
      });
      accountsList.querySelectorAll('.acctDis').forEach(ch => ch.addEventListener('change', (e)=> {
        const id = e.target.dataset.id; const a = findBiz(selectedBiz).accounts.find(x=>x.id===id); a.disallowableDefault = e.target.checked; saveData();
      }));
      accountsList.querySelectorAll('.acctNon').forEach(ch => ch.addEventListener('change', (e)=> {
        const id = e.target.dataset.id; const a = findBiz(selectedBiz).accounts.find(x=>x.id===id); a.nonTaxableDefault = e.target.checked; saveData();
      }));
      accountsList.querySelectorAll('.acctDel').forEach(b => b.addEventListener('click', (e)=> {
        if(!confirm('Delete account?')) return;
        const id = e.target.dataset.id; const biz = findBiz(selectedBiz); biz.accounts = biz.accounts.filter(x=>x.id!==id); saveData(); renderAccounts(); populateAccountSelect(); renderAll();
      }));
    }

    function renderBizContacts(b){
      bizContactsList.innerHTML = '';
      b.contacts = b.contacts || [];
      b.contacts.forEach(c => {
        const div = document.createElement('div'); div.className='account-row';
        div.innerHTML = `<div><strong>${c.name}</strong> <span class="small-muted">(${c.type})</span></div><div><button class="small" data-id="${c.id}">Edit</button> <button class="small danger" data-del="${c.id}">Del</button></div>`;
        bizContactsList.appendChild(div);
      });
      bizContactsList.querySelectorAll('button[data-id]').forEach(btn => btn.addEventListener('click', (e)=> {
        const id = e.target.dataset.id; const c = b.contacts.find(x=>x.id===id); openContactEditor(b.id, c.id);
      }));
      bizContactsList.querySelectorAll('button[data-del]').forEach(btn => btn.addEventListener('click', (e)=> {
        if(!confirm('Delete contact?')) return;
        const id = e.target.dataset.del; b.contacts = b.contacts.filter(x=>x.id!==id); saveData(); renderBizContacts(b); renderAll();
      }));
    }

    function openContactEditor(bizId, contactId){
      const b = findBiz(bizId);
      const c = b.contacts.find(x=>x.id===contactId);
      if(!c) return;
      // simple prompt-based edit for demo
      const name = prompt('Contact name', c.name);
      if(name === null) return;
      c.name = name;
      if(c.type === 'Employee'){
        const p = Number(prompt('Annual pension deduction (₦)', c.statutory?.pension || 0) || 0);
        const rent = Number(prompt('Annual rent relief (₦)', c.statutory?.rent || 0) || 0);
        const life = Number(prompt('Annual life assurance (₦)', c.statutory?.life || 0) || 0);
        const mortgage = Number(prompt('Annual mortgage interest (₦)', c.statutory?.mortgage || 0) || 0);
        const nhf = Number(prompt('Annual NHF (₦)', c.statutory?.nhf || 0) || 0);
        c.statutory = { pension:p, rent:rent, life:life, mortgage:mortgage, nhf:nhf };
      }
      saveData();
      renderBizContacts(b);
    }

    // CRUD helpers
    function openUserModal(editId){
      userModalTitle.textContent = editId ? 'Edit User' : 'Add User';
      if(editId){
        const u = findUser(editId);
        userName.value = u.username; userDisplay.value = u.display; userRole.value = u.role;
        permView.checked = !!u.permissions?.view; permEdit.checked = !!u.permissions?.edit; permDelete.checked = !!u.permissions?.delete;
        userSave.dataset.edit = u.id;
      } else {
        userName.value=''; userDisplay.value=''; userRole.value='User';
        permView.checked=true; permEdit.checked=false; permDelete.checked=false;
        userSave.dataset.edit = '';
      }
      openModal(userModal);
    }

    function deleteUser(id){
      data.users = data.users.filter(u=>u.id!==id);
      delete data.transactions[id];
      if(data.auth.currentUser === id) data.auth.currentUser = null;
      saveData();
      refreshSelectors();
      ensureSelection();
      renderAll();
    }

    function deleteBusiness(id){
      data.businesses = data.businesses.filter(b=>b.id!==id);
      for(const u of data.users) if(data.transactions[u.id]) delete data.transactions[u.id][id];
      saveData(); refreshSelectors(); ensureSelection(); renderAll();
    }

    // compute profit & tax flows
    function computePLSnapshot(){
      const biz = findBiz(selectedBiz);
      const txns = allTxnsForBiz();
      let revenue=0, cogs=0, expenses=0;
      for(const t of txns){
        const acct = biz.accounts.find(a => a.id===t.accountId);
        const cat = acct ? acct.category : null;
        if(cat === 'Revenue') revenue += t.netAmount || 0;
        else if(t.action === 'COGS' || t.action === 'InventorySale' || cat === 'COGS') cogs += t.netAmount || 0;
        else if(cat === 'Expense') expenses += t.netAmount || 0;
        else expenses += t.netAmount || 0;
      }
      const gross = revenue - cogs;
      const net = gross - expenses;
      return { revenue, cogs, expenses, gross, net };
    }

    function allTxnsForBiz(){
      const aggregated = [];
      for(const uid in data.transactions){
        const byBiz = data.transactions[uid] || {};
        if(byBiz[selectedBiz]) aggregated.push(...byBiz[selectedBiz]);
      }
      return aggregated;
    }

    // Capital allowance calculations: prorated monthly/days for tax year
    function computeCapitalAllowancesForYear(year){
      const biz = findBiz(selectedBiz);
      const assets = biz.assets || [];
      const totalCA = assets.reduce((acc,a)=>{
        // for each asset compute CA for the year based on caPercent and prorated days between purchase and disposal within the year
        const start = new Date(Math.max(new Date(a.purchaseDate), new Date(year+'-01-01')));
        const end = a.disposalDate ? new Date(Math.min(new Date(a.disposalDate), new Date(year+'-12-31'))): new Date(year+'-12-31');
        if(start > end) return acc;
        const days = (end - start) / (1000*60*60*24) + 1;
        const yearDays = new Date(year,11,31) - new Date(year+'-01-01') + 1000*60*60*24; // not used precisely
        const fraction = days / 365;
        const ca = a.cost * (a.caPercent/100) * fraction;
        return acc + ca;
      }, 0);
      const twoThirds = totalCA * (2/3);
      return { totalCA: Number(totalCA.toFixed(2)), twoThirds: Number(twoThirds.toFixed(2)) };
    }

    function computeTaxSummary(){
      const biz = findBiz(selectedBiz);
      const year = new Date().getFullYear();
      const txns = allTxnsForBiz();
      const totals = { revenue:0, expenses:0 };
      let vatCollected = 0, vatPaid = 0;
      let whtReceivable = 0, whtPayable = 0;
      // accumulate revenue/expenses and VAT/WHT
      for(const t of txns){
        const acct = biz.accounts.find(a=>a.id===t.accountId);
        const cat = acct ? acct.category : null;
        // revenue/expense classification using action and acct
        if(cat === 'Revenue' || t.action === 'Revenue' || t.action === 'InventorySale') totals.revenue += t.netAmount || 0;
        else totals.expenses += t.netAmount || 0;
        // VAT
        if(t.vatApplied){
          // treat revenue transactions as VAT collected, expense purchases as VAT paid (heuristic)
          if(cat === 'Revenue' || t.action === 'Revenue' || t.action === 'InventorySale') vatCollected += t.vatAmount || 0;
          else vatPaid += t.vatAmount || 0;
        }
        // WHT: interpret checkbox as receivable (i.e., tax withheld by payer and claimant can claim credit)
        if(t.whApplied){
          // simple: if revenue-like -> WHT receivable (someone withheld on revenue to us), else if expense-like -> WHT payable (we withheld)
          if(cat === 'Revenue' || t.action === 'Revenue') whtReceivable += t.whAmount || 0;
          else whtPayable += t.whAmount || 0;
        }
      }
      // PAYE: process salary transactions per employee, annualize and use statutory deductions
      const paye = computePAYE(txns, biz);
      // Profit before tax = revenue - expenses
      const profitBeforeTax = totals.revenue - totals.expenses;
      // Capital allowances
      const capAlloc = computeCapitalAllowancesForYear(year);
      // Taxable profit adjustments: add disallowable expenses, subtract non-taxable income, deduct losses brought forward, subtract 2/3 CA
      let disallowableSum = 0, nonTaxableSum = 0;
      for(const t of txns){
        if(t.disallowable) disallowableSum += (t.netAmount||0);
        if(t.nonTaxable) nonTaxableSum += (t.netAmount||0);
      }
      let taxableProfit = profitBeforeTax + disallowableSum - nonTaxableSum - (biz.lossBroughtForward || 0) - capAlloc.twoThirds;
      taxableProfit = Number(taxableProfit.toFixed(2));
      // CIT rate: 0% if turnover < threshold, else 25%
      const turnover = totals.revenue;
      const citRate = (turnover < CIT_TURNOVER_THRESHOLD) ? 0 : (biz.citRate || DEFAULTS.citRate);
      const citPayable = taxableProfit > 0 ? Number((taxableProfit * citRate/100).toFixed(2)) : 0;
      return {
        totals,
        vat: { collected: Number(vatCollected.toFixed(2)), paid: Number(vatPaid.toFixed(2)), net: Number((vatCollected - vatPaid).toFixed(2)) },
        wht: { receivable: Number(whtReceivable.toFixed(2)), payable: Number(whtPayable.toFixed(2)) },
        paye,
        profitBeforeTax: Number(profitBeforeTax.toFixed(2)),
        capitalAllowances: capAlloc,
        disallowableSum: Number(disallowableSum.toFixed(2)),
        nonTaxableSum: Number(nonTaxableSum.toFixed(2)),
        cit: { rate: citRate, taxableProfit: taxableProfit, payable: citPayable },
        profitBreakdown: { gross: Number((totals.revenue - (totals.expenses*0)).toFixed(2)), operating: Number((profitBeforeTax).toFixed(2)) }
      };
    }

    function computePAYE(txns, biz){
      // group salary txns by employee contact name; annualize by summing salary receipts in current year; subtract statutory deductions (employee-specific then business defaults)
      const year = new Date().getFullYear();
      const salaryByEmployee = {};
      for(const t of txns){
        if(!t.salary) continue;
        const dt = new Date(t.date);
        if(dt.getFullYear() !== year) continue;
        const key = (t.contactName || 'Unknown');
        salaryByEmployee[key] = salaryByEmployee[key] || { totalPay:0, txns:[] };
        salaryByEmployee[key].totalPay += (t.netAmount || t.amount || 0);
        salaryByEmployee[key].txns.push(t);
      }
      const results = { employees: [], total:0 };
      for(const name in salaryByEmployee){
        const item = salaryByEmployee[name];
        // find contact to get statutory
        const bizObj = biz;
        const contact = (bizObj.contacts||[]).find(c => c.name === name && c.type === 'Employee');
        const stat = contact ? (contact.statutory || {}) : bizObj.statutoryDeductions || {};
        const totalDeductions = Number(((stat.pension||0) + (stat.rent||0) + (stat.life||0) + (stat.mortgage||0) + (stat.nhf||0)).toFixed(2));
        const taxable = Math.max(0, item.totalPay - totalDeductions);
        // apply PAYE bands progressively
        let remaining = taxable;
        let tax = 0;
        let lower = 0;
        for(const band of PAYE_BANDS){
          const up = band.upTo;
          const slice = Math.max(0, Math.min(remaining, up - lower));
          if(slice > 0){
            tax += slice * band.rate;
            remaining -= slice;
          }
          lower = up;
          if(remaining <= 0) break;
        }
        tax = Math.round(tax);
        results.employees.push({ name, gross: item.totalPay, deductions: totalDeductions, taxable, tax });
        results.total += tax;
      }
      results.total = Number(results.total.toFixed(2));
      return results;
    }

    // Reports
    function renderReportsDefault(){
      renderReport('taxReconciliation');
    }
    function renderReport(name){
      reportContent.innerHTML = '';
      const biz = findBiz(selectedBiz);
      if(!biz) { reportContent.innerHTML = '<div>Select a business</div>'; return; }
      const summary = computeTaxSummary();
      if(name === 'taxReconciliation'){
        let html = `<h3>Taxable Income Reconciliation — ${new Date().getFullYear()}</h3>`;
        html += `<div>Accounting profit (pre-tax): ₦${fmt(summary.profitBeforeTax)}</div>`;
        html += `<div>+ Disallowable expenses: ₦${fmt(summary.disallowableSum)}</div>`;
        html += `<div>- Non-taxable income: ₦${fmt(summary.nonTaxableSum)}</div>`;
        html += `<div>- Loss brought forward: ₦${fmt(biz.lossBroughtForward||0)}</div>`;
        html += `<div>- 2/3 Total Capital Allowance: ₦${fmt(summary.capitalAllowances.twoThirds)}</div>`;
        html += `<hr><div><strong>Taxable Profit:</strong> ₦${fmt(summary.cit.taxableProfit)}</div>`;
        html += `<div><strong>CIT Payable (@${summary.cit.rate}%):</strong> ₦${fmt(summary.cit.payable)}</div>`;
        reportContent.innerHTML = html;
      } else if(name === 'vatReport'){
        let html = `<h3>VAT Report</h3>`;
        html += `<div>VAT Collected (sales): ₦${fmt(summary.vat.collected)}</div>`;
        html += `<div>VAT Paid (purchases): ₦${fmt(summary.vat.paid)}</div>`;
        html += `<div><strong>Net VAT payable/(credit): ₦${fmt(summary.vat.net)}</strong></div>`;
        reportContent.innerHTML = html;
      } else if(name === 'whtPayable'){
        let html = `<h3>WHT Summary</h3>`;
        html += `<div>WHT Receivable (credit): ₦${fmt(summary.wht.receivable)}</div>`;
        html += `<div>WHT Payable (liability): ₦${fmt(summary.wht.payable)}</div>`;
        reportContent.innerHTML = html;
      } else if(name === 'payeReport'){
        let html = `<h3>PAYE Report</h3>`;
        html += `<div>Total PAYE (estimate): ₦${fmt(summary.paye.total)}</div>`;
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Name</th><th>Gross</th><th>Deductions</th><th>Taxable</th><th>PAYE</th></tr></thead><tbody>`;
        for(const e of summary.paye.employees) html += `<tr><td>${e.name}</td><td style="text-align:right">${fmt(e.gross)}</td><td style="text-align:right">${fmt(e.deductions)}</td><td style="text-align:right">${fmt(e.taxable)}</td><td style="text-align:right">${fmt(e.tax)}</td></tr>`;
        html += `</tbody></table>`;
        reportContent.innerHTML = html;
      } else if(name === 'inventoryReport'){
        let html = `<h3>Inventory Report</h3>`;
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Item</th><th>Qty</th><th>Avg cost</th><th>Value</th></tr></thead><tbody>`;
        (biz.inventory||[]).forEach(i => html += `<tr><td>${i.name}</td><td style="text-align:right">${i.qty}</td><td style="text-align:right">${fmt(i.avgCost)}</td><td style="text-align:right">${fmt(i.avgCost * i.qty)}</td></tr>`);
        html += `</tbody></table>`;
        reportContent.innerHTML = html;
      } else if(name === 'assetsReport'){
        let html = `<h3>Fixed Assets Report</h3>`;
        const ca = computeCapitalAllowancesForYear(new Date().getFullYear());
        html += `<div>Total CA this year: ₦${fmt(ca.totalCA)} | 2/3 deduction: ₦${fmt(ca.twoThirds)}</div>`;
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Asset</th><th>Cost</th><th>Purchase</th><th>Disposed</th><th>Proceeds</th></tr></thead><tbody>`;
        (biz.assets||[]).forEach(a => html += `<tr><td>${a.name}</td><td style="text-align:right">${fmt(a.cost)}</td><td>${a.purchaseDate}</td><td>${a.disposalDate||''}</td><td style="text-align:right">${fmt(a.disposalProceeds||0)}</td></tr>`);
        html += `</tbody></table>`;
        reportContent.innerHTML = html;
      } else if(name === 'auditTrail'){
        let html = `<h3>Audit Trail</h3>`;
        html += `<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Time</th><th>User</th><th>Type</th><th>Details</th></tr></thead><tbody>`;
        (data.audit||[]).slice(-200).reverse().forEach(a => {
          const u = findUser(a.userId);
          html += `<tr><td>${a.timestamp}</td><td>${u?u.display||u.username:'-'}</td><td>${a.type}</td><td>${a.details}</td></tr>`;
        });
        html += `</tbody></table>`;
        reportContent.innerHTML = html;
      } else if(name === 'receiptsFolder'){
        let html = `<h3>Receipts</h3>`;
        const ats = getAttachmentsForBiz(selectedBiz) || [];
        html += `<div>${ats.length} attachments</div><ul>`;
        ats.forEach(a => html += `<li>${a.filename} — ${a.timestamp}</li>`);
        html += `</ul>`;
        reportContent.innerHTML = html;
      } else reportContent.innerHTML = `<div>Report not found</div>`;
    }

    // Export CSV / PDF
    function exportCsvForActiveReport(){
      const active = document.querySelector('#reportsSection .tab.active');
      const report = active?.dataset.report || 'taxReconciliation';
      const csv = generateCsvForReport(report);
      if(!csv) return alert('Nothing to export');
      const blob = new Blob([csv], { type:'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${report}_${selectedBiz || 'biz'}.csv`;
      a.click();
    }

    function generateCsvForReport(report){
      const biz = findBiz(selectedBiz);
      if(!biz) return null;
      const summary = computeTaxSummary();
      if(report === 'vatReport'){
        const rows = [['Type','Amount']];
        rows.push(['VAT Collected', summary.vat.collected]);
        rows.push(['VAT Paid', summary.vat.paid]);
        rows.push(['VAT Net', summary.vat.net]);
        return rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
      } else if(report === 'whtPayable'){
        const rows = [['Type','Amount']]; rows.push(['WHT Receivable', summary.wht.receivable]); rows.push(['WHT Payable', summary.wht.payable]); return rows.map(r => r.map(c=>`"${c}"`).join(',')).join('\n');
      } else if(report === 'payeReport'){
        const rows = [['Employee','Gross','Deductions','Taxable','PAYE']];
        for(const e of summary.paye.employees) rows.push([e.name, e.gross, e.deductions, e.taxable, e.tax]);
        return rows.map(r => r.map(c=>`"${c}"`).join(',')).join('\n');
      } else if(report === 'inventoryReport'){
        const rows = [['Item','Qty','AvgCost','Value']];
        (biz.inventory||[]).forEach(i => rows.push([i.name, i.qty, i.avgCost, i.qty * i.avgCost]));
        return rows.map(r => r.map(c=>`"${c}"`).join(',')).join('\n');
      } else if(report === 'assetsReport'){
        const rows = [['Asset','Cost','Purchase','Disposal','Proceeds']];
        (biz.assets||[]).forEach(a => rows.push([a.name, a.cost, a.purchaseDate, a.disposalDate||'', a.disposalProceeds||0]));
        return rows.map(r => r.map(c=>`"${c}"`).join(',')).join('\n');
      } else if(report === 'taxReconciliation'){
        const rows = [['Line','Amount']];
        rows.push(['Accounting profit', summary.profitBeforeTax]);
        rows.push(['Disallowable expenses', summary.disallowableSum]);
        rows.push(['Non-taxable income', summary.nonTaxableSum]);
        rows.push(['Loss B/F', biz.lossBroughtForward||0]);
        rows.push(['2/3 CA', summary.capitalAllowances.twoThirds]);
        rows.push(['Taxable profit', summary.cit.taxableProfit]);
        rows.push(['CIT rate', summary.cit.rate]);
        rows.push(['CIT payable', summary.cit.payable]);
        return rows.map(r => r.map(c=>`"${c}"`).join(',')).join('\n');
      }
      return null;
    }

    async function exportPdfForActiveReport(){
      const active = document.querySelector('#reportsSection .tab.active');
      const report = active?.dataset.report || 'taxReconciliation';
      // simple PDF of the reportContent text
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const text = reportContent.innerText || reportContent.textContent || '';
      const lines = doc.splitTextToSize(text, 180);
      doc.text(lines, 10, 10);
      doc.save(`${report}_${selectedBiz || 'biz'}.pdf`);
    }

    // Auth functions
    function refreshAuthUI(){
      if(data.auth.currentUser){
        const u = findUser(data.auth.currentUser);
        if(u) { authInfo.textContent = `Signed in as ${u.display||u.username}`; btnSignIn.style.display='none'; btnSignUp.style.display='none'; btnSignOut.style.display='inline-block'; }
        else { authInfo.textContent = ''; btnSignIn.style.display='inline-block'; btnSignUp.style.display='inline-block'; btnSignOut.style.display='none'; }
      } else {
        authInfo.textContent = '';
        btnSignIn.style.display='inline-block'; btnSignUp.style.display='inline-block'; btnSignOut.style.display='none';
      }
    }

    function openAuthModal(mode='signin'){
      switchAuthMode(mode);
      openModal(authModal);
    }

    function switchAuthMode(mode){
      if(mode === 'signin'){
        authTitle.textContent = 'Sign in';
        signInForm.style.display = 'flex';
        signUpForm.style.display = 'none';
        forgotForm.style.display = 'none';
        switchToSignUp.style.display = '';
        switchToSignIn.style.display = 'none';
        switchToForgot.style.display = '';
        authSubmit.dataset.mode = 'signin';
      } else if(mode === 'signup'){
        authTitle.textContent = 'Sign up';
        signInForm.style.display = 'none';
        signUpForm.style.display = 'block';
        forgotForm.style.display = 'none';
        switchToSignUp.style.display = 'none';
        switchToSignIn.style.display = '';
        switchToForgot.style.display = '';
        authSubmit.dataset.mode = 'signup';
      } else if(mode === 'forgot'){
        authTitle.textContent = 'Reset password';
        signInForm.style.display = 'none';
        signUpForm.style.display = 'none';
        forgotForm.style.display = 'block';
        switchToSignUp.style.display = '';
        switchToSignIn.style.display = 'none';
        switchToForgot.style.display = 'none';
        authSubmit.dataset.mode = 'forgot';
      }
    }

    async function handleAuthSubmit(){
      const mode = authSubmit.dataset.mode || 'signin';
      if(mode === 'signin'){
        const u = (signinUsername.value||'').trim();
        const p = signinPassword.value || '';
        if(!u||!p) return alert('Enter credentials');
        const user = data.users.find(x=>x.username === u);
        if(!user) return alert('User not found');
        if(!user.passwordHash) return alert('This user has no password set. Reset password or set a password by signing up again.');
        const h = await sha256Hex(p);
        if(h === user.passwordHash){ data.auth.currentUser = user.id; saveData(); closeModal(authModal); refreshAuthUI(); renderAll(); addAudit('auth.signin','user', user.id, 'User signed in'); }
        else alert('Invalid password');
      } else if(mode === 'signup'){
        const u = (signupUsername.value||'').trim();
        const d = (signupDisplay.value||u).trim();
        const p = signupPassword.value || '';
        const p2 = signupPassword2.value || '';
        if(!u||!p) return alert('Username and password required');
        if(p !== p2) return alert('Passwords do not match');
        if(data.users.find(x=>x.username === u)) return alert('Username already exists');
        const h = await sha256Hex(p);
        const newUser = { id: uid('user'), username: u, display: d, role:'User', isAdmin:false, permissions:{view:true,edit:false,delete:false}, passwordHash: h };
        data.users.push(newUser);
        data.transactions[newUser.id] = {};
        data.businesses.forEach(b => data.transactions[newUser.id][b.id] = []);
        data.auth.currentUser = newUser.id;
        saveData(); closeModal(authModal); refreshSelectors(); refreshAuthUI(); renderAll(); addAudit('auth.signup','user', newUser.id, 'User signed up');
      } else if(mode === 'forgot'){
        const u = (forgotUsername.value||'').trim();
        const p = forgotNewPassword.value || '';
        const p2 = forgotNewPassword2.value || '';
        if(!u||!p) return alert('Enter username and new password');
        if(p !== p2) return alert('Passwords do not match');
        const user = data.users.find(x=>x.username === u);
        if(!user) return alert('User not found');
        user.passwordHash = await sha256Hex(p);
        saveData(); closeModal(authModal); alert('Password reset (demo)'); addAudit('auth.reset','user', user.id, 'Password reset');
      }
    }

    // Defer initial owner passwordless sign-in note
    (function ensureAdminPassword(){
      const admin = data.users[0];
      if(admin && !admin.passwordHash){
        // set default password 'admin' hashed for demo to allow signin
        sha256Hex('admin').then(h=>{ if(!admin.passwordHash){ admin.passwordHash = h; saveData(); } });
      }
    })();

    // render ledger at start
    renderAll();

  </script>
</body>
                                   </html>
